<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="KbCOz5IFs80bU-psVUCv9C7SOLzVWto8d7_5ZSsX7I0"><meta name="baidu-site-verification" content="codeva-KcLqIZYGXd"><link rel="alternate" type="application/rss+xml" title="藏器于身" href="https://gality.cn/rss.xml"><link rel="alternate" type="application/atom+xml" title="藏器于身" href="https://gality.cn/atom.xml"><link rel="alternate" type="application/json" title="藏器于身" href="https://gality.cn/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/css/app.css?v=0.2.5"><meta name="keywords" content="区块链,模仿攻击"><link rel="canonical" href="https://gality.cn/scientific-research/thesis-reading/%20Blockchain%20Imitation%20Game/"><title>论文阅读｜ The Blockchain Imitation Game - 论文阅读 - 科研 | Samadhi = 藏器于身 = 待时而动</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">论文阅读｜ The Blockchain Imitation Game</h1><div class="meta"><span class="item" title="创建时间：2024-01-08 14:21:22"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-01-08T14:21:22+08:00">2024-01-08</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>26k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>47 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Samadhi</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="http://imgcdn.gality.cn/blog/14wa89.png"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/2023-08-19-wallhaven-yxe85x_2560x1440.png"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/u2vn85.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/8u50u7.png"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/d3xp8n.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/piwwii.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/scientific-research/" itemprop="item" rel="index" title="分类于 科研"><span itemprop="name">科研</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/scientific-research/thesis-reading/" itemprop="item" rel="index" title="分类于 论文阅读"><span itemprop="name">论文阅读</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://gality.cn/scientific-research/thesis-reading/%20Blockchain%20Imitation%20Game/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/avatar.png"><meta itemprop="name" content="Gality"><meta itemprop="description" content="待时而动, 安全杂记 & 日常随感"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="藏器于身"></span><div class="body md" itemprop="articleBody"><div class="note info"><p>Qin K, Chaliasos S, Zhou L, et al. The blockchain imitation game[J]. arXiv preprint arXiv:2303.17877, 2023.</p><p>链接：<span class="exturl" data-url="aHR0cHM6Ly93d3cudXNlbml4Lm9yZy9zeXN0ZW0vZmlsZXMvc2VjMjNmYWxsLXByZXB1Yi0zMzEtcWluLnBkZg==">https://www.usenix.org/system/files/sec23fall-prepub-331-qin.pdf</span></p></div><details class="primary"><summary>思考🤔</summary><div><p>回顾整篇论文，安全问题产生于 “抢先” 运行，这种抢先运行是基于某些私密 “情报” 的，这种事情非常常见，影响也非常广泛，就像罗斯柴尔德借助拿破仑滑铁卢掌控了整个英国的经济一样，掌握 “情报” 的用户可以几乎 “确定的” 盈利。这一情况在区块链中的影响会更加的严重，因为在区块链中，矿工本身就可以进行交易，相当于可以不直接经过 “交易所” 就可以完成金钱的流动，这无疑更有利于那些能更快拥有 “情报” 的矿工。</p><p>我认为，论文中提出的方法有几个关键点：</p><ol><li>根据动态控制流图的构建快速分析程序的流程</li><li>通过污点分析程序自动化找到污点位置并生成对抗性智能合约</li><li>本地快速验证以确保攻击收益</li></ol><p>从实验的结果来看，APE 在以太坊中成功攻击的交易占 0.0061%；在 BSC 中成功攻击的交易占 0.0022%，这个比例相比于 &quot;Naive Transaction Imitation Attack&quot; 来说虽然更小，但是产生的收益却翻了 3 倍左右。这意味着部分大额交易采用了的保密的智能合约来对抗 &quot;Naive Transaction Imitation Attack&quot;，这是合理的，但同时也暴露了交易所其实缺乏对于安全问题的深刻认知，总是尝试通过尽可能小的改变来对已知安全威胁进行防护，这可能会导致更大的安全隐患；另外一个暴露出来的问题是即使在安全威胁已知的前提下，大量的用户并没有关心可能存在的安全风险，在区块链这样的一个有海量节点及用户的应用中，攻击者更容易通过已知威胁来获取利益，从这点上来说，如果金融类区块链算法本身可以及时提供对安全威胁的更新并强制进行版本验证，可以最大程度上避免金融损失。</p><p>从 APE 的实现角度来说，APE 中的程序流分析、污点分析、对抗性智能合约生成的底层实现都是基于对区块链程序的二进制分析，这种攻击手法需要对于二进制程序有极强的了解，同时，近年来由 Go 语言实现的区块链程序不断增多，Go 语言本身的代码设计又增加了逆向分析的难度，一定程度上提高了安全性。因此，虽然 APE 中的程序流分析无法对抗对程序流的混淆防护，但是却提供了一种更轻量化的安全攻击的思路，这种思路对于相对来说还未高度复杂化的区块链程序可能会更加好用。</p><p>整体来看，APE 虽然实现了一种通用的模拟攻击的方法，但是本身其实仍然相对简单，能成功运行模拟攻击的交易数量仍然占比很小，我认为存在一些可以改进的点。</p><ol><li>在污点分析中，APE 仅仅是结合了部分确定的 EVN 操作码，这可能会导致部分事实上可处理的污点程序未被发现，这里可以结合 “fuzzing” 技术提前对所有的 EVN 操作码进行筛选，尽可能将所有可能造成污点的操作码找出，有利于扩大攻击面。</li><li>在智能合约生成中，论文并没有详细的描述这里生成智能合约的具体方法，但是从论文来看主要 patch 的点在于对 <code>JUMPI</code> 的替换，这其实是一种简单的针对程序流的控制手段，对应的防护方法也非常多，很容易的导致模仿攻击失效。可以通过增加更多的 patch 模版，针对更多操作码进行改变来扩大攻击面。</li></ol></div></details><h1 id="abstract"><a class="anchor" href="#abstract">#</a> Abstract</h1><p>使用区块链进行自动交易和对抗性交易已经司空见惯。然而，由于区块链的透明性，对手能够观察到任何<span class="red">悬而未决、尚未挖掘的交易及其执行逻辑</span>。这种透明性进一步助长了新型对手的出现，他们会实时<span class="red">复制并预先运行有利可图的待处理交易</span>，从而获得可观的经济收益。</p><p>为了揭示这种 &quot;复制粘贴&quot; 的不良行为，本文介绍了区块链模仿游戏，并提出了一种名为 APE 的通用模仿攻击方法。APE 利用动态程序分析技术，支持对抗性智能合约的自动合成。在一年的时间内（2021 年 8 月 1 日至 2022 年 7 月 31 日），APE 可以在以太坊上产生 1.4896 亿美元的利润，在 BNB 智能链（BSC）上产生 4270 万美元的利润。</p><p>不仅是恶意攻击，我们还进一步展示了<span class="red">交易和合约模仿作为防御策略的潜力</span>。我们发现，APE 在一年内分别成功模仿了以太坊和 BSC 上 13 次和 22 次已知的去中心化金融（DeFi）攻击。我们的发现表明，区块链验证器可以实时模仿攻击，以防止 DeFi 中的入侵。</p><h1 id="introduction"><a class="anchor" href="#introduction">#</a> Introduction</h1><p>建立在区块链基础上的去中心化金融（DeFi）已发展成为一个价值数十亿美元的产业。然而，区块链点对点（P2P）网络被描述为黑暗森林，交易者在其中进行竞争性交易，沉溺于对抗性的<strong>前置运行 (front-running)</strong>。</p><blockquote><p>Front-running：经纪人或投资者因为预先知道会影响资产价格的大型机密交易而加入交易，从而获得利益。</p></blockquote><p>由于交易创建和在区块链上提交之间存在固有的时间延迟，因此这种前置运行是可能发生的。这种时间延迟通常只持续几秒钟，这给前置运行者带来了计算上的挑战。为了获得经济收益，DeFi 交易者需要监控错综复杂的市场动态，并及时进行有利可图的交易，这通常需要专业的领域知识。相反，对抗性交易者也可能寻求 &quot;复制粘贴&quot; 和模仿攻击。我们将这种策略称为模仿攻击。一种极其简单的<strong>字符串替换模仿方法</strong>被证明可以在过去的区块链状态下每月产生数千美元的收益。</p><blockquote><p>KaihuaQin,LiyiZhou,andArthurGervais.Quantifyingblockchain extractable value: How dark is the forest? In <em>2022 IEEE Symposium on Security and Privacy (SP)</em>, pages 198–214. IEEE, 2022.</p></blockquote><p>开源社区迅速提出了防御措施，以应对这种简单的模仿方法。在撰写本文时，交易者通常会部署个性化的闭源智能合约，从而增加了利用的难度。已知的模仿算法不再适用，因为这些合约通常通过验证等方式加以保护。</p><p>然而，人们还没有探索出一种通用的模仿攻击能使现有的保护机制失效。这项工作的目标是<span class="red">研究、识别、实施和评估一种通用的模仿方法</span>。我们发现，要成功模仿交易，攻击者需要克服以下三个技术难题。</p><ol><li>前端运行时间窗口较短，可能无法应用强大的程序分析技术，如符号执行，因为符号执行不是为实时任务设计的。</li><li>攻击者需要递归地识别阻碍模仿执行的受害合约，并用新合成的对抗合约替换它们。因此，有必要使用区块链虚拟机工具来确保这一识别过程的效率。</li><li>攻击者必须保证合成的合约被正确调用和执行，而产生的财务收入则在模仿执行后被发送到恶意账户。据我们所知，现有的工作或现成的工具都无法自动复制和合成注入自定义逻辑的智能合约。</li></ol><p>在这项工作中，我们提出了一种自动且通用的模仿方法 APE（参见图 1）。抽象来说，APE 的目的是构建一个模仿交易，复制受害者交易的逻辑。必要时，APE 会合成并部署对抗性智能合约，以绕过验证机制等复制保护。为此，APE 利用动态污点分析、程序合成和高级工具来实现模仿生成。这种通用性源于这样一个事实，即对手不需要事先了解受害者，也不需要了解受害者的交易逻辑，更不需要事先了解交互的去中心化应用程序（DApp）。APE 适用于可替代、不可替代代币的交易活动以及利用交易等。</p><p><img data-src="http://imgcdn.gality.cn/blog/apo7w0.png" alt="图1 高级 APE 攻击机制是一种通用的模仿方法，可在事先不了解受害者的交易和合同的情况下合成对抗性合同。APE 会侵占由此产生的任何收入"></p><p>尽管基于区块链的 DeFi 领域蓬勃发展，但它也受到数百万美元黑客攻击的困扰。如本作品所述，模仿攻击可为恶意攻击者带来巨大的经济利益。不过，根据深度防御方法，区块链模仿攻击本身也可以通过模仿攻击、挪用易受攻击的资金并将其返还给受害者来充当入侵防御系统。开源社区将这种善意活动称为 &quot;白帽黑客&quot;。</p><p>我们将我们的贡献总结如下：</p><ul><li>我们引入了广义区块链模仿游戏，其中有一类新的对手试图在事先不了解受害者意图或应用逻辑的情况下，模仿受害者的交易和相关合约。我们为基于 EVM 的区块链设计了通用模仿工具 APE。我们首次展示了动态程序分析技术可以实现模仿攻击，从而对区块链用户构成实质性威胁。</li><li>我们在以太坊和 BNB 智能链 (BSC) 上对 APE 进行了为期一年的评估。我们发现，APE 可以在以太坊上产生 1.4896 亿美元的利润，在 BSC 上产生 4270 万美元的利润。我们发现，7374 万美元源于 35 次已知的 DeFi 攻击，而 APE 可以将其消除。通过发现 5 个新漏洞，APE 的影响进一步显现，我们披露了这些新漏洞，因为如果被利用，它们可能会造成 3153 万美元的总损失。</li><li>我们发现，APE 可在以太坊（13.3 秒的区块间时间）和 BSC（3 秒的区块间时间）上实时执行。模仿一次 APE 平均需要 0.07 ± 0.10 秒。由于 APE 的效率很高，在评估时间内，它在 35 次 DeFi 攻击中实现了实时的前置运行。执行 APE 的矿工最终可以选择实施攻击，也可以作为白帽黑客进行防御。</li></ul><h1 id="background"><a class="anchor" href="#background">#</a> Background</h1><p>在本节中，我们将概述所需的背景，并举例说明。</p><h2 id="blockchain-and-smart-contract"><a class="anchor" href="#blockchain-and-smart-contract">#</a> Blockchain and Smart Contract</h2><p>区块链是分布在点对点网络上的区块链条。用户通过账户的公钥签名批准交易，矿工收集交易，并按照区块内的特定顺序进行挖掘。支持智能合约的区块链扩展了账户持有资产和代码的能力，可以执行任意计算。智能合约通过交易进行初始化和执行，一旦部署就不可更改。它们通常用高级语言（如 So-lidity）编写，编译成低级字节码，由区块链虚拟机（如以太坊虚拟机（EVM））执行。EVM 是基于堆栈的虚拟机，支持算术、控制流、加密和其他区块链特定指令（如访问当前区块编号）。每执行一条字节码指令都需要消耗 &quot;gas&quot;，由本地加密货币支付。请注意，所有代码和账户余额通常都是透明可见的。智能合约的应用二进制接口（ABI）定义了智能合约函数的调用方式（包括函数类型、名称、输入参数等）。如果智能合约不是开源的，ABI 很可能不可用。</p><p>DeFi 是一个建立在智能合约区块链之上的新兴金融生态系统，在撰写本文时，其锁定的总价值已达到 3000 亿美元的峰值。DeFi 的核心是一个智能合约编码的金融生态系统，实现了 <strong>自动做市商 (automated market maker)</strong>、借贷平台和 <strong>稳定币 (Stablecoin)</strong> 等功能。用户可以通过向相应的合约发布交易来访问 DeFi 应用程序（DApp）。</p><blockquote><p>market maker：指在证券市场上，由具备一定实力和信誉的独立证券经营法人作为特许交易商，不断向公众投资者报出某些特定证券的买卖价格，并在该价位上接受公众投资者的买卖要求，以其自有资金和证券与投资者进行证券交易。买卖双方不需等待交易对方出现，只要有做市商出面承担交易对手方即可达成交易，做市商从双方赚取买卖价差而从中获利。</p><p>Stablecoin：是加密货币 (Cryptocurrency) 的其中一种类型。稳定币的核心想法是要打造一种底层分散式账本，但维持货币稳定价值的机制。稳定币被有些人认为是中心化资产抵押发行的代币，稳定币价值是与被抵押资产价值直接连动。</p></blockquote><h2 id="blockchain-extractable-value"><a class="anchor" href="#blockchain-extractable-value">#</a> Blockchain Extractable Value</h2><p>众所周知，华尔街的交易员通过前置运行其他投资者的订单（即高频交易）来获利。同样，DeFi 中的交易顺序也对收益提取活动产生了致命影响。默认情况下，矿工按交易费从高到低的顺序排列交易。因此，DeFi 交易商可以通过提供有竞争力的交易费，对待处理（即尚未开采）的交易进行前置和后置操作。然而，矿工对下单交易拥有一手遮天般的特权，这使他们垄断了区块链价值的提取。这种特权引出了 ** 矿工可提取价值 (MEV)** 的概念。</p><blockquote><p>MEV：指 “在给定时间内，矿工可以从操纵交易中提取的 ETH 总量”。以以太坊为例，以太坊网络的运行是依靠矿工对交易进行打包，生成区块来运行的。矿工在打包交易的时候可以做到将某些交易进行排序干预等。通过这些操作，矿工可能获取除了交易费用和区块奖励之外的额外利润，这些多出来的价值就被称为 MEV。</p></blockquote><p>Qin 等人将 MEV 概括为区块链可提取价值（Blockchain Extractable Value，BEV），并表明在 32 个月内，以太坊上提取的 BEV 达 5.4054 亿美元，主要有三个来源：<strong>三明治攻击 [1]</strong>、<strong>清算 [2,3]<strong> 和</strong>套利 [4]</strong>。</p><blockquote><ol><li>LiyiZhou,KaihuaQin,ChristofFerreiraTorres,DucVLe,andArthur Gervais. High-frequency trading on decentralized on-chain exchanges. In <em>2021 IEEE Symposium on Security and Privacy (SP)</em>, pages 428–445. IEEE, 2021.</li><li>KaihuaQin,JensErnstberger,LiyiZhou,PhilippJovanovic,andArthur Gervais. Mitigating decentralized finance liquidations with reversible call options. In <em>International Conference on Financial Cryptography and Data Security</em>. Springer, 2023.</li><li>KaihuaQin,LiyiZhou,PabloGamito,PhilippJovanovic,andArthur Gervais. An empirical study of defi liquidations: Incentives, risks, and instabilities. In <em>Proceedings of the 21st ACM Internet Measurement Conference</em>, page 336–350. ACM, 2021.</li><li>LiyiZhou,KaihuaQin,AntoineCully,BenjaminLivshits,andArthur Gervais. On the just-in-time discovery of profit-generating transactions in defi protocols. In <em>2021 IEEE Symposium on Security and Privacy (SP)</em>, pages 919–936, 2021.</li></ol></blockquote><p>需要注意的是，前台运行即服务（FaaS）（如 flashbots）通过在私有网络中与矿工勾结，降低了提取 BEV 的风险。与贿赂类似，BEV 被证明会威胁到区块链共识的安全性，因为矿工会被激励分叉区块链。关于 DeFi 攻击的 SoK 系统分析了四年来的攻击，确定了各种攻击的原因和影响。在本文中，我们对白帽攻击者和黑帽攻击者进行了区分，其中黑帽攻击者保留了攻击的经济收益，而白帽攻击者则将攻击收入退还给确定的受害者。</p><h2 id="naive-transaction-imitation-attack"><a class="anchor" href="#naive-transaction-imitation-attack">#</a> Naive Transaction Imitation Attack</h2><p>提取实体的 BEV 可采用两种策略：一种是对 DeFi 应用程序进行细致分析（即针对特定应用程序的提取），另一种是采用天真的通用事务模仿攻击（即与应用程序无关的提取）。</p><p>Qin 等人提出了一种天真但有效的事务模仿攻击。<strong>该算法将受害者交易作为输入，并在交易发送者和数据字段中简单地将交易的发送者地址替换为恶意地址</strong>。因此，这种模仿算法相当于字符串替换方法，并不试图合成对抗性智能合约。在对过去的区块链数据进行模拟时，结果表明这种天真的算法可以在 32 个月的时间内产生 3537 万美元。我们在附录 A 中提供了一个天真的模仿示例。但是，当交易者通过认证机制等方式保护自己的交易时，这种算法就会失效，我们将在下文概述。</p><h2 id="motivating-examples"><a class="anchor" href="#motivating-examples">#</a> Motivating Examples</h2><p>DeFi 中的交易者通常使用定制的智能合约来执行金融行为，例如套利和清算。这些交易者尝试保护其交易免受仿冒攻击，例如只允许预定义账户调用其智能合约（参见图 2）。这种保护措施与认证机制相对应，是开源社区采用的一种常见做法。我们以现实世界中的身份验证为例进行说明。</p><p><img data-src="http://imgcdn.gality.cn/blog/hxes5m.png" alt="图 2：清算人通过向其定制合约发送交易触发清算。自定义合约包含一个验证（第 3 行）"></p><p><em>身份验证保护示例</em>。在图 2 中，我们展示了「清算合约」如何尝试防止交易模仿攻击。图 2 中「清算合约」的实体代码没有开源，因此我们使用最先进的 EVM 合约去编译器对合约字节码进行反编译。要触发清算，清算人需要向增强合约发送交易以及「参数」（如闪贷规模和清算金额）。如果没有保护机制，对手可能通过调用带有相同参数的相同合约来运行清算器。然而，所提交的合约要求交易发送方匹配特定地址（第 3 行）。具体来说，清算函数 <code>printMoney()</code> 只能由硬编码地址调用。如果不满足这一条件，第 2.3 节中的天真模仿攻击就会失败。要规避身份验证保护，一种方法是合成一份恶意合约，复制清算者的定制合约。通过重构字节码，合成的合约既保留了清算逻辑，又绕过了身份验证。要执行攻击，攻击者无需了解清算交易的业务逻辑。对手不调用清算人的定制合约，而是调用合成合约，然后触发清算。</p><p>在这项工作中，我们提出了一种自动化和通用化的模仿方法 APE，可以挫败此类保护。APE 不仅仅局限于身份验证，它还提供了一种全面的方法来克服天真模仿策略无法处理的各种形式的保护机制。再举个例子，我们考虑这样一个场景：交易者发布了一笔盈利交易，并将赚取的收入存入交易者控制的智能合约中。虽然对手可能会通过天真的策略成功执行模仿交易这个过程，但收入仍会留在 &quot;受害者&quot; 交易者的合约中，攻击者不会因此获得任何经济收益。与此相反，APE 通过合成一个作为收益接收者的对抗性合约来解决这一困境。我们将在第 5.3 节中进一步介绍这种情况的细节，并展示真实世界中的一笔交易。</p><h1 id="ape-overview"><a class="anchor" href="#ape-overview">#</a> APE Overview</h1><p><img data-src="http://imgcdn.gality.cn/blog/cdietk.png" alt="论文中涉及的符号及含义"></p><p>接下来，我们将概述系统和威胁模型。然后，我们将概述 APE 的关键组成部分。</p><h2 id="preliminary-models"><a class="anchor" href="#preliminary-models">#</a> Preliminary Models</h2><ul><li><p><strong>系统模型</strong></p><p>我们考虑采用智能合约的分布式账本和现有的 DeFi 生态系统。交易者通过其区块链账户执行金融操作，签署矿工挖掘的交易。同样，智能合约也由其各自的账户引用。区块链交易 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><annotation encoding="application/x-tex">\mathrm{tx}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.61508em;vertical-align:0"></span><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span></span></span></span> 代表状态转换函数，将账本状态从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">S</span></span></span></span> 转换为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>S</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">S&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.751892em;vertical-align:0"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.751892em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>S</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">S&#x27; = \mathrm{tx}(S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.751892em;vertical-align:0"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.751892em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mclose">)</span></span></span></span> 。</p><p>我们假设，在 DeFi 系统中，除了原生区块链加密货币 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span></span></span></span> 之外，还存在各种资产表示形式（如可替代代币）。在区块链状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">S</span></span></span></span> 下，账户 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">a</span></span></span></span> 持有的资产 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">m</span></span></span></span> 余额用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>a</mi><msubsup><mi>l</mi><mi>a</mi><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Bal^{m}_{a} (S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.05017em">B</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.664392em"><span style="top:-2.4530000000000003em;margin-left:-.01968em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.247em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mclose">)</span></span></span></span> Z 表示，而 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="normal">Δ</mi><mi>a</mi><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>S</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Delta^{m}_{a}(S,\mathrm{tx})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord"><span class="mord">Δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.664392em"><span style="top:-2.4530000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.247em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="mclose">)</span></span></span></span> 表示在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">S</span></span></span></span> 上执行交易 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><annotation encoding="application/x-tex">\mathrm{tx}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.61508em;vertical-align:0"></span><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span></span></span></span> 后的余额变化（参见公式 1）。</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msubsup><mi mathvariant="normal">Δ</mi><mi>a</mi><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>S</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">)</mo><mo>=</mo><mi>B</mi><mi>a</mi><msubsup><mi>l</mi><mi>a</mi><mi>m</mi></msubsup><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>−</mo><mi>B</mi><mi>a</mi><msubsup><mi>l</mi><mi>a</mi><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(1)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\Delta^{m}_{a} (S, \mathrm{tx}) = Bal^{m}_{a} (\mathrm{tx}(S)) - Bal^{m}_{a}(S) \tag{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord"><span class="mord">Δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.7143919999999999em"><span style="top:-2.4530000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.247em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.05017em">B</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.7143919999999999em"><span style="top:-2.4530000000000003em;margin-left:-.01968em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.247em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.05017em">B</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.7143919999999999em"><span style="top:-2.4530000000000003em;margin-left:-.01968em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.247em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">1</span></span><span class="mord">)</span></span></span></span></span></span></p><p>我们进一步假设存在链上交易所，这些交易所允许从任何资产 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">m</span></span></span></span> 到原生加密货币 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span></span></span></span> 的交易。</p></li><li><p><strong>威胁模型</strong></p><p>我们的考虑的最强的对抗模型为：一个矿工，它可以单枪匹马地在其开采的区块中进行交易。作为矿工， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以访问每个待处理的交易和当前的区块链状态。 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 通过多个分布式节点和点对点连接，在 P2P 网络上主动列出数据。此外， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 还可以充当或与 FaaS 提供商合作，私下接收待处理交易。由于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 是矿工，因此 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以在任何待处理交易之前进行交易。我们假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 在财务上是理性的，并试图最大化其资产价值。此外，我们假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以获得足够的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span></span></span></span> 来执行 APE。</p><p>APE 与应用无关，这意味着 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 无需预先知道受害者交易 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的逻辑，也无需知道其目标智能合约。不过，我们假设即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 了解如何与资产代币互动，并且 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以通过上链交换将代币 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">m</span></span></span></span> 交换给 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span></span></span></span>。</p><p>我们将旨在复制和替换 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 行为的交易称为模仿交易 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 与一组合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{\mathrm{sc}_{vi}\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">{</span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span> 交互，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可能需要替换这些合约的子集才能成功执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 。我们认为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以处理任何受害合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，以合成各自的对抗合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。</p><p><strong>澄清</strong> APE 无法形成新的攻击，因为 APE 事先不知道以前的区块链攻击，也不知道应用层逻辑。因此，APE 依赖于模板交易和编码攻击逻辑的相关合约。</p></li></ul><h2 id="attack-overview"><a class="anchor" href="#attack-overview">#</a> Attack Overview</h2><p>给定一个有利可图的受害者交易 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，对手 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以尝试用简单的模仿交易来模仿其逻辑（参见第 3.3 节）。然而，由于现有的各种防御机制（如身份验证），这种天真的方法可能会失败（参见第 3.4 节）。由于缺乏关于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的先验知识，理解一个失败对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 来说具有挑战性。此外，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的执行可能与多个被调用的合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{\mathrm{sc}_{vi}\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">{</span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span> 交织在一起，从而使分析变得更加复杂。最后，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 必须实时攻击，因为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 被挖掘出来前的攻击窗口通常只持续几秒钟。</p><p>APE 的目标是生成一个模仿交易 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，以及一组模仿 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 逻辑的合成合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{\mathrm{sc}_{ai}\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">{</span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span>（和相关的受害者合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{\mathrm{sc}_{vi}\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">{</span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span>），并具有以下属性：</p><ul><li><strong>事先不了解受害者情况</strong>：任何盈利交易都应被视为潜在受害者，与发行者无关。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 不需要事先了解受害者的交易、意图或过去的区块链历史。</li><li><strong>不推理受害者逻辑</strong>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 不知道 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的应用逻辑，也不涉及 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。</li><li><strong>额外复杂性带来更高回报</strong>：APE 引入了比天真的模仿方法更多的复杂性，因此应该能获得超过原模拟方法的收益。为了进行客观比较，我们在相同的区块链交易历史上对两种模仿方法进行了评估。</li><li><strong>实时性</strong>：我们假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 只攻击待处理的临时交易。因此，APE 必须快于区块间时间（例如，以太坊上约为 13.3 秒，BSC 上为 3 秒）。因此，必须优先考虑执行速度而不是攻击最优性。请注意，作为矿工的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以选择在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 上分叉区块链，从而获得更长的攻击时间窗口，这超出了本工作的范围。</li></ul><p>APE 的高层逻辑运算如下。给定一个潜在的受害者交易 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> ，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 首先尝试通过创建并执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 来作为一个天真模仿事务以模仿 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 。如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的执行出现回退，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 就会找出引发失败的执行轨迹。然后，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 合成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，替换导致 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 回退的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。为此，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 复制受害者的合约字节码，并修改阻止成功模仿执行的指令。最后，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 在本地验证 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 部署和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的可盈利性。根据 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以领先任何竞争对手的假设（参见第 4.1 节），APE 是无风险的。请注意，利用事务的可组合性，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以在单个事务中原子式地操作 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 部署和模仿执行（即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">\mathrm{tx}{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.61508em;vertical-align:0"></span><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="mord"><span class="mord mathnormal">c</span></span></span></span></span>）。</p><p>APE （参见图 3）由六个关键部分组成：</p><p><img data-src="http://imgcdn.gality.cn/blog/8sfecv.png" alt="图 3：基于 EVM 的区块链交易实时模仿攻击 APE 概述"></p><ol><li><p><strong>动态控制流图</strong>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 在当前区块链状态下循环执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，并构建动态控制流图（DCFG）。DCFG 捕获<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 执行时 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的合约间调用，以及 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(ii)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 调用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的合约字节码执行流。</p></li><li><p><strong>盈利分析器</strong>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 提取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 触发的资产转移，观察受益账户。然后，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 尝试替换这些账户成为受益人。如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 没有成功成为受益人，则中止攻击。</p></li><li><p><strong>动态污点分析</strong>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 执行动态污点分析，并将分析结果与步骤 1 中构建的 DCFG 进行比较。如果比较结果显示没有差异，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 就继续进行天真交易仿真（参见第 2.3 节）。否则，根据动态污点分析和与 DCFG 的比较，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 识别出妨碍成功执行天真模仿的污点基本块。</p></li><li><p><strong>补丁识别器</strong>：基于检测到的受益人账户和污点智能合约，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 开始识别所有需要替换的智能合约。</p></li><li><p><strong>智能合约合成</strong>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 通过复制 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的字节码合成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可能需要修改 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的字节码，以确保 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 可以执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的逻辑并收取产生的财务收入。</p></li><li><p><strong>验证</strong>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 在本地部署 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 并执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，以验证攻击是否有利可图。如果有利可图，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 就在链上部署 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 并发布 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，前置运行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。</p></li></ol><h1 id="ape-details"><a class="anchor" href="#ape-details">#</a> APE Details</h1><p>在本节中，我们将介绍 APE 的设计细节，并讨论其技术局限性。</p><h2 id="step-1-dynamic-control-flow-graph"><a class="anchor" href="#step-1-dynamic-control-flow-graph">#</a> Step 1 : Dynamic Control-Flow Graph</h2><p>智能合约控制流图（CFG）是合约字节码的图形表示法。在 CFG 中，每个节点表示一个基本块，即指令的线性序列。节点由有向边连接，代表控制流中的代码跳转。对于 EVM 字节码， <code>JUMP</code> 和 <code>JUMPI</code> 这两个操作码控制着代码块的执行路径。 <code>JUMP</code> 是无条件跳转到堆栈中的目标，而 <code>JUMPI</code> 则是有条件跳转。CFG 只包含有关合约的静态信息，而 DCFG 是一种专门的 CFG，包含从给定执行中提取的动态信息。</p><p><em>APE 中的动态控制流图构建</em>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 在本地执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，构建 DCFG，表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的执行细节。为了推理 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的控制流，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 记录了每个 <code>JUMPI</code> 的条件值，这是动态分析所必需的（第 3 步，参见第 5.3 节）。通过捕捉合约调用的操作码（即 <code>CALL</code> 、 <code>DELEGATECALL</code> 、 <code>STATICCALL</code> 和 <code>CALLCODE</code> ），<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以识别跨合约的调用。因此，构建的 DCFG 可以跟踪调用的所有智能合约。构建的 DCFG 反映了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的具体执行，而不是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的完整表示。这对本工作很有帮助，因为未执行的基本区块与模仿受害者交易无关。因此，得到的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>（参见步骤 5，第 5.5 节）可能比 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 包含更少的操作码，从而降低攻击成本。</p><h2 id="step-2-profitability-analyzer"><a class="anchor" href="#step-2-profitability-analyzer">#</a> Step 2 : Profitability Analyzer</h2><p>盈利能力分析器旨在过滤掉不可能盈利的受害者交易。直观地说，如果对抗收入（以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span></span></span></span> 度量）大于所需的交易费用，则 APE 尝试是有利可图的（参见定义 5.1）。</p><p><mark><strong>定义 5.1</strong></mark>（盈利条件）。给定一个区块链状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">S</span></span></span></span>，对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 来说，如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>a</mi><msubsup><mi>l</mi><mi mathvariant="script">A</mi><mi>E</mi></msubsup><mo stretchy="false">(</mo><msup><mi>S</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo>−</mo><mi>B</mi><mi>a</mi><msubsup><mi>l</mi><mi mathvariant="script">A</mi><mi>E</mi></msubsup><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">Bal^{E}_{\mathcal{A}}(S&#x27;) - Bal^{E}_{\mathcal{A}}(S) &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1166619999999998em;vertical-align:-.275331em"></span><span class="mord mathnormal" style="margin-right:.05017em">B</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8413309999999999em"><span style="top:-2.424669em;margin-left:-.01968em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight">A</span></span></span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.275331em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.751892em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.1166619999999998em;vertical-align:-.275331em"></span><span class="mord mathnormal" style="margin-right:.05017em">B</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8413309999999999em"><span style="top:-2.424669em;margin-left:-.01968em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight">A</span></span></span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.275331em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">0</span></span></span></span>（其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>S</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">S&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.751892em;vertical-align:0"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.751892em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> 是攻击交易后的区块链状态），则 APE 攻击对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 来说是有利可图的。</p><p>在最简单的情况下，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以通过检查交易发送方的余额变化来推断模仿 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的盈利能力。然而，受害者可能会将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的收入转移到其控制的另一个智能合约，而不是转移到发送者账户。因此，只有当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 确定受益收款人时，模仿 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 才有利可图。因此，为了确定盈利能力，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 有必要确定参与执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的每个账户的利润。为此，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 可以从步骤 1 中构建的 DCFG 中提取资产转移。通过分析资产执行标准（如 <strong>ERC20</strong>）中定义的 EVM 日志，可以直接提取资产转移。我们继续定义 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 执行中的受益人账户（参见定义 5.2）。</p><p><mark><strong>定义 5.2</strong></mark>（受益账户）。如果在执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的过程中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">a</span></span></span></span> 收到的金额大于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">a</span></span></span></span> 支付的金额，则账户 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">a</span></span></span></span> 被视为受益人。</p><p>我们仅以本地货币 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span></span></span></span> 来衡量盈利能力，以使金融价值比较正常化。这意味着 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 必须在模仿 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 之后将所有收到的资产原封不动地交换到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span></span></span></span>。</p><p>如果在执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的过程中存在受益人账户，那么模仿 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 可能会产生利润。具体来说，有两种情况 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 不会放弃攻击：</p><ol><li>如果发件人是受益账户，则其他账户与盈利能力分析器无关。</li><li>否则，如果发送人不是受益人账户，其他受益人账户的总利润减去发送人账户的潜在损失后必须保持正数。</li></ol><p>然后，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 将受益人账户导出到补丁识别器（步骤 4），以便进一步分析（参见第 5.4 节）。请注意，这种方法可能会带来误报，因为盈利能力分析器不考虑交易是否具有可操作性。例如，从钱包合约中向交易发送方提取资产的交易被归类为可盈利交易，因为发送方是受益人账户。但是，提取交易是无法模仿的。这种误报将在验证阶段（第 6 步）被清除。</p><h2 id="step-3-dynamic-taint-analysis"><a class="anchor" href="#step-3-dynamic-taint-analysis">#</a> Step 3 : Dynamic Taint Analysis</h2><p>动态污点分析是一种程序分析方法，可在程序执行过程中跟踪来自污点源（如不受信任的输入）的信息流。动态污点分析通过污点策略明确确定：</p><ol><li>哪些指令会引入新的污点；</li><li>如何对污点进行预处理；</li><li>如何检查污点值。</li></ol><p><strong>APE 中的动态污点分析</strong>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 开始执行从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 复制的模仿事务 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的执行相比，如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 包含不一致（例如不同的事务发送者），则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的执行可能会失败（参见第 3.4 节）。因此，在执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 会应用动态污点分析来跟踪 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 执行失败的位置和方式。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 将可能触发不一致执行值的操作码视为污点源，并跟踪其污点传播。下面我们将概述 APE 的污点分析策略：</p><p><img data-src="http://imgcdn.gality.cn/blog/iyhih8.jpg" alt="表 2：污点引入规则。在执行 txc 时，ORIGIN 肯定会引入一个不一致的值，而其余操作码（灰色部分）可能会、也可能不会影响 txc 的执行"></p><ul><li><strong>污点介绍</strong>：我们检查了所有 EVM 操作码，并找出了那些可能带来不一致的操作码（参见表 2）。例如，`ORIGIN・（交易发送方操作码）肯定会产生不一致值，因为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 是由恶意地址而不是受害者地址发出的。其余操作码在执行过程中可能会、也可能不会产生不一致值。</li><li><strong>污点传播</strong>：当至少有一个输入是污点时，污点会传播到算术 / 逻辑运算的输出。值得注意的是，如果一个存储变量是从一个污点槽中读取的，那么它就是污点。</li><li><strong>污点检查</strong>：回顾一下，我们在建立 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的 DCFG 时，在步骤 1 中（参见第 5.1 节）记录了每个 <code>JUMPI</code> 条件的具体值。给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的污点执行轨迹后，我们比较每个污点 <code>JUMPI</code> 是否与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的记录值相同。通过这种具体的比较，我们可以确定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 之间的不一致是如何中断 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的执行的。</li></ul><p>接下来，我们将定义污点基本区块（参见定义 5.3）和污点合约（参见定义 5.4）。</p><p><mark><strong>定义 5.3</strong></mark>（污点基本区块）。如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 基本程序块包含一个条件值为污点的 <code>JUMPI</code> 操作码，且 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(ii)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 在执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 时条件值不同，则该基本程序块为污点程序块。</p><p><mark><strong>定义 5.4</strong></mark>（污点合约）。如果智能合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 包含至少一个污点基本区块，则该合约为污点合约。</p><p>如果没有污点基本区块，则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的执行过程完全相同。因此，APE 等同于天真模仿攻击（即 A 只需发出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 并省略步骤 4 , 5 即可模仿 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>）。但是，如果存在一个有污点的基本区块，则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的执行与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 不同。为了复制 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的执行，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 将污点合约替换为对抗合约，保留与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 相同的执行逻辑。</p><p><img data-src="http://imgcdn.gality.cn/blog/focthg.png" alt="图 4：示例中模仿事务的污点传播（参见图 2，第 3.4 节）。CALLER 引入一个污点值，并传播到 JUMPI 条件"></p><p><strong>污点传播示例</strong>：在图 4 中，我们展示了动态污点分析如何在给定恶意地址 0xab...cd 的情况下，跟踪激励示例（参见图 2，第 3.4 节）中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的执行情况。执行后，污点从 <code>CALLER</code> 传播到 <code>JUMPI</code> 的条件值（参见 PC 0xb27，图 4）。此外，条件值为 <code>False</code> ，与执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 时不同。因此，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 知道定制的清算合约已被玷污，需要替换。</p><h2 id="step-4-patch-identifier"><a class="anchor" href="#step-4-patch-identifier">#</a> Step 4 : Patch Identifier</h2><p>回想一下，污点基本区块可以避免 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 成功退出。因此，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 试图用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{ai}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 替换有污点的合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 。此外，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 还需要替换步骤 2 中识别出的受益人账户，以便收取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 中产生的财务收入。修补标识符的目的是检测 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{\mathrm{sc}_{vi}\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">{</span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span> 中所有需要修补和替换的合同，以便成功模仿 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。根据对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 的调用是来自交易还是来自合约，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 需要区分以下两种情况。我们用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.78056em;vertical-align:-.15em"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.63056em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span style="top:-3.55056em"><span class="pstrut" style="height:3em"></span><span class="overline-line" style="border-bottom-width:.04em"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 表示必须修补和替换的合同。</p><p><strong>从事务中调用</strong>：当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 调用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 应将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的 <code>to</code> 地址从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 修改为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 。</p><p><strong>从合约调用</strong>：如果对受污染合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 的调用是硬编码（字节码或存储）在调用者合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>j</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vj}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.9566680000000001em;vertical-align:-.286108em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.67056em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight" style="margin-right:.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span> 中的（参见图 5），则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 应同时替换 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vj}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight" style="margin-right:.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span> ，以修补硬编码语句。即使 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vj}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight" style="margin-right:.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span> 没有被污染，这也是必要的。上述修补程序可反复应用于随后的硬编码合约调用。</p><p><img data-src="http://imgcdn.gality.cn/blog/d3p0xv.png" alt="图 5：对污点合约 scvi 的调用被硬编码到合约 scv j 中。要执行 APE，A 需要同时替换 scvi 和 scvj"></p><h2 id="step-5-smart-contract-synthesis"><a class="anchor" href="#step-5-smart-contract-synthesis">#</a> Step 5 : Smart Contract Synthesis</h2><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 开始合成对抗性合约，以替换补丁标识符检测到的每个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.78056em;vertical-align:-.15em"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.63056em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span style="top:-3.55056em"><span class="pstrut" style="height:3em"></span><span class="overline-line" style="border-bottom-width:.04em"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span>（参见第 5.4 节）。从顶层设计来说，为了合成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 复制了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.78056em;vertical-align:-.15em"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.63056em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span style="top:-3.55056em"><span class="pstrut" style="height:3em"></span><span class="overline-line" style="border-bottom-width:.04em"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 的字节码，并做了如下修改。</p><p>对于有污点的合约 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 会修改每个有污点的基本代码块，以确保 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 遵循与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 相同的代码路径，尽管 <code>JUMPI</code> 条件可能不一致。具体来说，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{A}(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord"><span class="mord mathcal">A</span></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 将 <code>JUMPI</code> 替换为 <code>JUMP</code> ，导致无条件跳转，或 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(ii)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 删除 <code>JUMPI</code> ，导致不跳转。如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\widehat{\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.82056em;vertical-align:-.15em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.6705599999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.43056em"><span class="pstrut" style="height:3em"></span><span style="height:.24em"><svg width="100%" height="0.24em" viewBox="0 0 1062 239" preserveAspectRatio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span> 的调用被硬编码在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vj}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight" style="margin-right:.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span> 中（参见图 5），则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 需要修改 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{a j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span>，将合约调用从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{aj}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span> 重定向到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。此外，由于每个新部署的对抗性合约都有一个空存储空间，因此在执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 可能会从其存储空间中加载一个不一致的值。因此，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 会进一步修改 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 以恢复加载。</p><p>上述修改可确保 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 具有相同的执行路径（代码块和合约），但不能保证 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 获得所产生的收益。例如，在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 中产生的收入可能会被发送到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 中硬编码的账户<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">a_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。合成的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 复制了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{vi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 中的字节码，并可能按照相同的方式传输（即发送到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">a_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，而不是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 控制的账户）。因此，为了获取所产生的收入，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 需要通过临时修改 EVM 内存和向 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 注入收入收集逻辑来重定向相关的资产转移。最终，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 会根据打补丁后的字节码大小变化更新跳转目的地。</p><h2 id="step-6-validation"><a class="anchor" href="#step-6-validation">#</a> Step 6 : Validation</h2><p>最后，APE 会在交易挖矿前本地验证 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。APE 失败的原因有两个：</p><ol><li>执行可能失败</li><li>财务收入无法弥补部署对抗性合约和执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的成本。</li></ol><p>为了对攻击进行具体验证，恶意矿工会部署每个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{sc}_{ai}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，并在本地的最新区块链状态上执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 将收到的所有代币转换为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span></span></span></span>，以检查 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 是否产生利润。只有当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span></span></span></span> 中的收入涵盖所有交易费用（包括智能合约部署费用）时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 才能产生利润。回想一下，对抗性合约的部署、模仿执行和资产交换可以在一次攻击交易中完成。如果验证成功，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 就会在下一个区块中包含攻击交易（前置运行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>）。否则，攻击中止，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 无需承担任何费用，即 APE 无风险。</p><h2 id="limitations"><a class="anchor" href="#limitations">#</a> Limitations</h2><p>APE 的设计和实施有许多限制条件。例如，我们假设对手拥有成功执行 APE 所需的足够数量的前期资产。鉴于闪存贷款的广泛使用，前期资本要求已迎刃而解。</p><p><img data-src="http://imgcdn.gality.cn/blog/0df427.png" alt="清单 1：任何提供由其私人密钥签名的 ECDSA 签名的账户都可以从 Vault 提取资产"></p><p>当需要进行复杂的语义重组时，APE 就不适用了。我们在清单 1 中举例说明，合约 Vault 允许任何提供由其私钥签署的有效 ECDSA 签名 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>v</mi><mo separator="true">,</mo><mi>r</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(v, r, s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span> 的账户提取资产。由于这种 &quot;任何人都可以提取&quot; 的逻辑，Vault 的设计使得提取交易容易受到模仿攻击。然而，要让对手自动执行攻击，就需要自动进行语义理解和签名生成，而 APE 并不支持这一点。</p><p>此外，APE 无法模仿非原子策略，即跨越多个独立区块链交易的策略。例如，给定一个资产交换受害者交易，三明治攻击者可能会创建两个对抗性交易，从受害者身上榨取利润。APE 的目标不是产生这种攻击。但是，如果三明治攻击的攻击者创建了一个包裹受害者交易所的原子夹心交易，APE 就能成功挑战该交易。</p><p>在我们的工作中，我们假设受害者不知道 APE 对手，特别是 APE 攻击策略。如果受害者意识到了 APE，那么受害者可以重新设计其智能合约，使其交易更坚固，以抵御 APE 对手的攻击。正如我们在第 6 节中所展示的，本文介绍的攻击方法在实践中非常有效。我们将在第 8 节概述可能的反击策略。</p><h1 id="ape-historical-evaluation"><a class="anchor" href="#ape-historical-evaluation">#</a> APE Historical Evaluation</h1><p><strong>实现</strong>：我们用 6582 行 Golang 代码实现了 APE。更多详情可参见附录 B。</p><p>我们开始评估 APE 仿真攻击在以太坊和 BSC 上一年时间内（从 2021 年 8 月 1 日到 2022 年 7 月 31 日） 的表现，以太坊和 BSC 是本文撰写时市值最高的两个支持智能合约的区块链。我们分别对以太坊和 BSC 上的 431,416,565 笔和 2,366,970,381 笔过往交易进行了评估。</p><h2 id="methodology-and-setup"><a class="anchor" href="#methodology-and-setup">#</a> Methodology and Setup</h2><p>我们将过去的每笔交易都视为潜在的受害交易，并对其应用 APE 管道。如果攻击成功，我们会保存相关的合成智能合约，以及产生的收益和执行成本（如合约部署和模仿交易的 'gas' 成本）。如果不需要替换合约，APE 会退回到天真的模仿攻击，我们将其作为基线单独列出。</p><p>虽然完整存档节点可以提供任何过去区块的区块链状态，但它并不直接允许在任意过去区块链状态上执行任意交易。因此，我们通过对 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVt">go-ethereum</span> 和 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JuYi1jaGFpbi9ic2M=">bsc</span> EVM 进行相应的定制，为以太坊和 BSC 实现了一个仿真器。模拟器从存档节点获取历史状态，并返回任何给定交易的执行结果。我们在 Ubuntu 20.04.3 LTS 上进行实验，该系统配备 AMD 3990X（64 核）、256GB 内存和 8TB NVMe SSD。</p><h2 id="evaluation-results"><a class="anchor" href="#evaluation-results">#</a> Evaluation Results</h2><p>在以太坊上，从总计 431,416,565 个潜在的链上挖掘的受害交易中，我们发现了 43,979 个（0.0102%）容易受到天真模仿攻击的交易（参见表 3）。APE 成功攻击了 26,127 个（0.0061%）受害者交易，其中涉及替换 665 个独特的智能合约。</p><p>从 2,366,970,381 个 BSC 交易中，我们发现天真模仿适用于 516,128 个（0.0218%）受害者交易，而 APE 则捕获了 52,799 个（0.0022%）额外的交易，涉及 1,193 个独特的合约。</p><p><img data-src="http://imgcdn.gality.cn/blog/xkstkq.png" alt="表 3：代表成功攻击交易和唯一受害者合同的总体攻击统计数据"></p><p><strong>攻击收益</strong>：为了合理衡量攻击利润，我们需要考虑导线部署和模仿交易所需的交易费成本。因为区块空间是有限的（例如，受以太坊区块‘gas’限制），因此在执行 APE 攻击时，我们需要捕捉矿工在不包含受害者交易时放弃交易费的机会成本。因此，我们用 APE 受害交易的交易费来量化这种机会成本。利润以每笔受害者交易时的 ETH (BNB) 价格换算成美元。请注意，ETH (BNB) 是以太坊 (BSC) 上的原生加密货币。</p><p>我们在图 6 中展示了 APE 的累积利润。在以太坊上，与天真模仿相比，APE 可以将模仿攻击的利润提高 973.6%。具体来说，我们发现 APE（包括天真模仿攻击）总共产生了 1.4896 亿美元的利润，而天真模仿攻击在相同时间段内的累计利润仅为 1387 万美元。通过量化模仿攻击所需的前期资金，我们发现 99.31% 的成功攻击所需的资金少于 5 ETH（包括交易费）。</p><p><img data-src="http://imgcdn.gality.cn/blog/btxg6m.png" alt="图 6：从 2021 年 8 月 1 日到 2022 年 7 月 31 日，以太坊上的模仿攻击总利润（包括 APE 和天真模仿）达到 1.4896 亿美元，而 APE 的累计利润为 1.3508 亿美元。在 BSC 上，APE 和天真模仿分别产生 2945 万美元和 1325 万美元"></p><p>在 BSC 上，天真模仿攻击的利润累计为 1325 万美元，而 APE 则带来了 2 945 万美元的额外利润（+222.3%）。99.48% 的 BSC 模仿攻击所需的预付资金低于 5 BNB。</p><p>我们注意到，与天真模仿相比，APE 获取的平均利润高出一个数量级（参见表 3）。为进一步了解易受 APE 影响的交易，我们将在第 6.3 节中进行分析。</p><p><strong>Gas 消耗</strong>：APE 带来了额外的 'gas' 成本，因为对手可能需要部署对抗性合约。我们确定了两个与 'gas' 相关的约束条件，攻击受此约束。攻击的收入必须能够支付 'gas' 支出，而且用于部署和执行攻击交易的 'gas' 应保持在区块 'gas' 限额以下。</p><p>在以太坊上，我们发现 APE 平均耗费 0.98M±0.74M 'gas'，而天真模仿耗费 0.45M±0.50M 'gas'（参见图 7）。作为参考，在撰写本文时，以太坊采用了动态区块耗气量限制，平均耗气量为 29.77M。在已识别的历史交易中，APE 的最大气体消耗量为 23.11M，低于以太坊的平均块 'gas' 限制。平均而言，对抗性合约部署占攻击气体消耗的 48.42%。</p><p><img data-src="http://imgcdn.gality.cn/blog/0zsz8m.jpg" alt="图 7：以太坊上的 APE 每次攻击平均消耗 0.98M±0.74M 瓦斯，而天真模仿攻击消耗 0.45M±0.50M 瓦斯。然而，对 BSC 的天真模仿攻击的平均耗气量（1.74M±4.44B）高于 APE 攻击（1.64M±0.64B）"></p><p>平均而言，BSC 的区块 'gas' 限额高于（8 266 万）以太坊，这就为模拟提供了更大的空间。我们发现，APE（1.64M±0.64B）和天真模仿（1.74M±4.44B）在 BSC 上的平均耗气量都较高。对抗性合约部署在 BSC 上的平均耗气量是 APE 耗气量的 53.04%。与以太坊相反，BSC 上的天真模仿平均耗气量高于 APE。因此，我们分析了耗气量超过 3M 的 82192 笔天真的模仿交易。去除 80291 个异常值后，BSC 上天真的模仿交易的平均耗气量为 0.48M±0.55M 。</p><p><strong>对抗性合约</strong>：平均而言，一次 APE 攻击需要在以太坊上替换 1.02 ± 0.15 个合约，在 BSC 上替换 1.05 ± 0.23 个合约。我们发现，与被替换的受害者合约相比，每个合成的对手合约平均小 60.95 ± 19.19%（以字节为单位）（参见表 4）。由于 APE 可能会用合成代码扩展受害方合约，我们还观察到了 - 295.56% 的负缩减，即最坏情况下增加了 295.56%。在 BSC 上，合约大小的平均缩减率为 57.59 ± 18.69%，最大缩减率为 613.33%。</p><p><img data-src="http://imgcdn.gality.cn/blog/ctmgft.png" alt="表 4：对抗性合约统计。APE 在以太坊和 BSC 上最多创建 3 个对抗性合约，平均值分别为 1.02 和 1.05"></p><h2 id="historical-analysis"><a class="anchor" href="#historical-analysis">#</a> Historical Analysis</h2><p>为了从 APE 的成功中获得启示，我们对以太坊和 BSC 上收益最高的前 100 名 APE 受害者进行了人工投资，分别获得了 1.1343 亿美元（83.97%）和 2727 万美元（92.60%）的利润。表 5 列示了整体的跨行动和利润分配情况。接下来，我们将概述研究结果的细节</p><p><img data-src="http://imgcdn.gality.cn/blog/66ipl1.png" alt="表 5：以太坊和 BSC 上收益最高的前 100 名 APE 受害者的交易和利润分布。我们未能对 31 个 BSC 受害者交易进行分类"></p><p><strong>已知的 DeFi 攻击和漏洞</strong>：在以太坊上，APE 发现了与 13 个已知 DeFi 攻击相对应的 17 个黑帽交易和 12 个宣称的白帽交易，总共获利 7374 万美元。最易被 APE 攻击的交易 <span class="exturl" data-url="aHR0cHM6Ly9ldGhlcnNjYW4uaW8vdHgvMHhjZDdkYWUxNDNhNGMwMjIzMzQ5YzE2MjM3Y2U0Y2Q3Njk2YjE2MzhkMTE2YTcyNzU1MjMxZWRlODcyYWI3MGZj">0xcd7d...70fc</span> 是对 Popsicle Finance 智能合约的 DeFi 攻击，产生了 2,025 万美元的 APE 利润。请注意，该 APE 利润低于报告的攻击利润，因为我们将 APE 的收益转换为 ETH。交易所可能会产生过多的滑点，尤其是对于较高的金额。</p><p>我们检测到两笔交易可能与已披露的两个合约漏洞有关。交易 <span class="exturl" data-url="aHR0cHM6Ly9ldGhlcnNjYW4uaW8vdHgvMHgyZTdkN2U3YTZlYjE1N2I5ODk3NGM4Njg3ZmJkODQ4ZDAxNThkMzdlZGMxMzAyZWEwOGVlNWRkYjM3NmJlZmVh">0x2e7d..efea</span> 和 <span class="exturl" data-url="aHR0cHM6Ly9ldGhlcnNjYW4uaW8vdHgvMHhlMTJhZTAxNWM4MDIzYmJlNjQwNTY2MmEzZGRmNWU4ZTEwNmU3ZjYyNTVlOTA1YjczMTJkY2Y2NWIyN2Q3NTVj">0xe12a..755c</span> 分别涉及 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmF1Y3R1cy5vcmcvYWN0aW9uLXJlcXVpcmVkLWNyaXRpY2FsLXZ1bG5lcmFiaWxpdHktM2Q0NDhkNGQwZGNi">Auctus ACOWriter</span> 漏洞和 <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9wZWNrc2hpZWxkL3N0YXR1cy8xNTA5MDA5NzQ2NzQ0OTgzNTU2">BMIZapper</span> 漏洞中报告的受害者合约。但是，我们无法找到披露这些交易公开信息的合同执行者。</p><p>在 BSC 上，APE 共捕获了 22 次 DeFi 攻击，涉及 40 笔交易，共产生了 2239 万美元的仿冒利润。</p><p>表 8 和表 9（附录 C）概述了已识别的 DeFi 攻击和漏洞的详情。请注意，对于每笔攻击交易，我们都会检查 <span class="exturl" data-url="aHR0cHM6Ly9ldGhlcnNjYW4uaW8v">etherscan.io</span> 是否观察到 P2P 网络上的攻击。如果 etherscan 无法监测到 P2P 网络上的攻击，那么攻击很可能是私下传播给矿工（如 FaaS）的。我们发现，在 12 次白帽攻击交易中，有 10 次（对应 6 次攻击）是私下传播给矿工的。白帽黑客可能出于两个目的而选择私人通信渠道：</p><ol><li>加快链上白帽交易的包含速度；</li><li>减少模仿攻击的可能性。</li></ol><p><strong>新发现的漏洞</strong>：APE 发现了五个未关闭的漏洞。在这些漏洞中，最有利可图的漏洞名为 <code>massDeposit</code> ，在以太坊和 BSC 上分别产生了 2858 万美元和 759.54 万美元的总利润。下文将介绍 <code>massDeposit</code> 漏洞的案例研究，其他新发现漏洞的详情见附录 C。</p><p><em>责任披露</em>：在撰写本报告时，所有已发现的漏洞都已没有可用资金。然而，尽管存在危险，新用户可能会在不知情的情况下与这些合同进行交互。因此，我们选择通过专门的区块链消息服务（<span class="exturl" data-url="aHR0cHM6Ly9jaGF0LmJsb2Nrc2Nhbi5jb20vc3RhcnQ=">Blockscan Chat</span> by Etherscan）来联系有漏洞的智能合约。不幸的是，我们发现的所有易受攻击的合约都是匿名部署的，没有明显的方法可以识别这些合约背后的实体或个人。</p><p><img data-src="http://imgcdn.gality.cn/blog/9arfvr.png" alt="清单 2：APE 易受攻击的存款人合约，任何人都可以调用 massDeposit() 函数并提出一份金库合约。我们的评估结果表明，APE 可能会给该合约造成 2,858 万美元的潜在损失"></p><p><em><code>massDeposit</code> 案例研究</em>： <code>massDeposit</code> 漏洞的前身是以太坊上的一个 <code>Depositer</code> 合约（<span class="exturl" data-url="aHR0cHM6Ly9ldGhlcnNjYW4uaW8vYWRkcmVzcy8weGUyYzA3MWUxRTE5NTdBNjJmRERmMDE5OTAxOGUwNjFlYkZEM2FjMkM=">0xe2c071e1E1957A62fDDf0199018e061ebFD3ac2C</span>）（参见清单 2）。我们发现，由于以下漏洞细节，存入的资金可能是通过 APE 攻击盗取的。存款人合约的 <code>massDeposit()</code> 函数以金库为参数，金库是接收存款人合约全部资金的合约（参见图 8a）。任何人都可以调用 <code>massDeposit()</code> 函数，并且提供一个任意的金库合约地址。然后，允许保险库从存款人账户中收取资产。最后，存款人调用金库的 <code>setOwner()</code> 函数，试图配置金库的所有权。当观察到这样的大量存款交易时，APE 的处理员 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">A</mi></mrow><annotation encoding="application/x-tex">\mathcal{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal">A</span></span></span></span></span> 会将 vault 识别为受益人账户。然后，APE 会自动合成一份对抗合约，重新放置 vault 合约（参见图 8b）。回顾一下，在合成受益人合约时，APE 注入了在模仿交易结束前将所有收集的资产转移到对抗账户的逻辑。值得注意的是，即使没有 APE，攻击者也可以手动制作一份敌对金库合约，恶意提取存款人的资产。因此，我们将这一通道设计归类为漏洞。</p><p><img data-src="http://imgcdn.gality.cn/blog/hb2t0v.png" alt="图 8：MassDeposit 漏洞"></p><h1 id="ape-real-time-evaluation"><a class="anchor" href="#ape-real-time-evaluation">#</a> APE Real-time Evaluation</h1><p>理想情况下，支持 APE 的矿工会尝试实时确定其开采区块的最佳交易顺序。因此，在给定一个未确认交易列表的情况下，矿工可以应用每一种交易组合来确定 APE 的最佳收益。然而，探索这些组合很快就会导致组合爆炸。</p><p>因此，我们将为矿工的交易排序提出一个更现实、但也更尽力的解决方案。我们可以借鉴被广泛采用的假设，即在一个区块链区块中，交易通常按其费用金额排序。因此，在按费用排序的列表中，我们知道对于受害者交易 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，APE 交易也应该被放在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.65952em;vertical-align:0"></span><span class="mord mathnormal">i</span></span></span></span> 的位置。虽然 EVM 目前只支持交易的顺序执行，但投机并行执行的前景可观，可以加快区块验证以及 APE 中的受害者交易识别。不过，这种并行执行框架超出了本文的研究范围。</p><h2 id="methodology-and-setup-2"><a class="anchor" href="#methodology-and-setup-2">#</a> Methodology and Setup</h2><p>为了评估实时性能，我们将 APE 逻辑注入一个以太坊（BSC）完整节点，称为 APE 节点。APE 节点监听以太坊（BSC）P2P 网络，并对每笔潜在的受害者交易进行 APE 操作，同时不公布生成的攻击交易。重复评估过程将当前区块链高度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord mathnormal">h</span></span></span></span> 和内存池 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">P</mi></mrow><annotation encoding="application/x-tex">\mathcal{P}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal" style="margin-right:.08222em">P</span></span></span></span></span> 作为输入（参见算法 1）。我们首先排除 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">P</mi></mrow><annotation encoding="application/x-tex">\mathcal{P}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathcal" style="margin-right:.08222em">P</span></span></span></span></span> 中的非法交易（例如，nonce 编号错误的交易），并按 'gas' 价格降序对产生的交易进行排序。然后，我们在当前区块链状态上依次应用排序后的交易。给定每一对中间状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">S_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:-.05764em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>（应用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 后）和后续交易 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8234109999999999em;vertical-align:-.208331em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.208331em"><span></span></span></span></span></span></span></span></span></span>，APE 节点异步执行攻击函数 Ape (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">S_i,\mathrm{tx}_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.891661em;vertical-align:-.208331em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:-.05764em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.208331em"><span></span></span></span></span></span></span></span></span></span>)，并以非阻塞方式继续执行下一对 (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mrow><mi>i</mi><mo>+</mo><mn>2</mn></mrow></msub></mrow><annotation encoding="application/x-tex">S_{i+1},\mathrm{tx}_{i+2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.891661em;vertical-align:-.208331em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-left:-.05764em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.208331em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.208331em"><span></span></span></span></span></span></span></span></span></span>)。如果事务 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 是可攻击的，我们就用生成的攻击事务替换（即 &quot;前置运行&quot;）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>。该流水线对应于对抗式矿工：</p><ol><li>从内存池中选择并排序交易；</li><li>按顺序应用每个交易以构建下一个区块</li><li>在适用时执行 APE 攻击。APE 节点重复这一过程，并记录以下指标的性能。</li></ol><p><img data-src="http://imgcdn.gality.cn/blog/6ma8ol.png" alt="算法 1"></p><p><mark>指标 1</mark>（单次交易性能）。在给定一个受害者交易和相应区块链状态的情况下，APE 生成攻击所需的时间（参见算法 1）。</p><p><mark>指标 2</mark>（内存池性能）。考虑到实时交易的动态内存池，从 APE 攻击生成到下一个区块（即应包含 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{tx}_{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76508em;vertical-align:-.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">t</span><span class="mord mathrm">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的目标区块）到达的时间（参见算法 1）。</p><p>我们使用与第 6 节相同的硬件设置和 10 Gbps 的互联网连接进行实时评估。为了迅速捕获待处理交易，我们将 APE 节点的最大网络对等节点从默认的 50 个增加到 500 个，用于以太坊和 BSC。APE 节点会生成 150 个线程，异步执行 Ape 函数（参见算法 1）。</p><p><strong>较弱的威胁模型</strong>：请注意，与第 4.1 节中的威胁模型相反，在本节中，我们不是矿工。此外，我们与 FaaS 没有私人对等协议，因此可能无法观察到只有启用了 FaaS 的矿工才会收到的受害者交易。与之前的威胁模型相比，我们的 APE 节点观察受害者交易的对抗能力较弱。因此，在实时评估中，我们选择关注 APE 在实际应用中的计算实时性能，而忽略 APE 节点在较弱的威胁模型下可能产生的潜在经济利润。我们预计较弱的威胁模型会获得较低的利润，因此将此类分析留待今后的工作中进行。</p><h2 id="computational-real-time-performance"><a class="anchor" href="#computational-real-time-performance">#</a> Computational Real-time Performance</h2><p>我们的以太坊实时实验捕获了 26 天的数据。在实验期间，以太坊 APE 节点平均每秒重新接收 17.86 次独特交易。我们总共检测到 4,045 次模仿机会，其中包括 3,699 次容易受到 APE 攻击的交易。BSC 实时评估的时间跨度为 14 天。我们的 BSC APE 节点平均每秒接收 57.31 次独特交易。我们在 BSC 上识别出 489 个模仿机会和 784 个 APE 机会。</p><p>表 6 列出了单笔交易性能（参见指标 1）和执行时间明细。平均而言，生成一次天真模仿攻击需要 0.01 ± 0.01 秒，而生成一次 APE 攻击需要 0.07 ± 0.10 秒。</p><p><img data-src="http://imgcdn.gality.cn/blog/awztx8.png" alt="表 6：原始攻击和 APE 模仿攻击的单笔交易性能（以太坊）。步骤 1、3 和 6 平均占 APE 执行时间的 96.35%。APE 在 BSC 上的单次交易性能相当"></p><p>APE 最耗时的步骤是 DCFG（第 1 步）、动态污点分析（第 3 步）和验证（第 6 步），占整个执行时间的 96.35%。</p><p>我们在图 9 中展示了 mempool 性能（参见指标 2）。在以太坊（BSC）上，99.68%（99.49%）的 APE 攻击是在我们的 APE 节点收到目标块之前生成的。从攻击产生到接收到目标块的时间平均为 12.56 ± 12.55 (2.24 ± 0.81) 秒。我们的评估结果表明，以太坊上的 APE（区块间隔为 13.3 秒）和 BSC（区块间隔为 3 秒）具有实时性。</p><h1 id="ape-countermeasures"><a class="anchor" href="#ape-countermeasures">#</a> APE Countermeasures</h1><p>模仿攻击对 DeFi 生态系统及其用户构成了迫在眉睫的威胁。与 EVM 兼容的区块链依赖矿工来执行和验证每笔交易。因此，很难完全防止矿工检查和模仿受害者交易。我们认为以下对策有可能减轻 APE。</p><p><strong>将模仿作为一种防御工具</strong>：一种可能直观但有效的替代方法是将模仿作为一种防御机制。例如，矿工可以通过简单地模仿攻击并将收益退还给受害者的方式，对 DeFi 攻击进行自动白帽黑客攻击。虽然矿工目前被信任来确保区块链共识的安全，但他们可以扩展这种能力到应用层。漏洞悬赏可以激励矿工的利他主义。不过，我们将精确的激励结构留待今后的工作中去探索。</p><p><strong>打破原子性</strong>：打破有利可图的事务的原子性会阻碍 APE，也就是说，用户可以将其事务的逻辑分割成多个独立的事务。这样，APE 就无法捕捉到任何独立交易的全部逻辑，也就无法对其进行模仿。此外，这种防御可以通过一种工具来实现，它可以将单个事务作为输入，并自动将其拆分成具有相同程序逻辑的多个事务。这种方法的主要缺点是不适用于所有情况（如闪存贷款）。打破原子性还可能给用户带来额外风险（例如，部分套利执行导致财务损失）。</p><p><strong>前置运行缓解</strong>：APE 要求攻击者必须能够前置运行受害者交易，因此缓解前置运行可以防止 APE 攻击。文献探讨了各种基于时间的交易排序公平性的前置运行缓解方案。虽然这些公平排序解决方案原则上可以将 APE 的威胁最小化，但它们需要对共识层或应用层进行根本性修改。特别是，[1] 需要对底层区块链进行修改，而 [2, 3] 则引入了一个负责交易排序的额外许可委员会，并需要重新设计 DeFi 应用程序。</p><blockquote><p>[1] Mahimna Kelkar, Fan Zhang, Steven Goldfeder, and Ari Juels. Order- fairness for byzantine consensus. In <em>Annual International Cryptology Conference</em>, pages 451–480. Springer, 2020.</p><p>[2] MahimnaKelkar,SoubhikDeb,SishanLong,AriJuels,andSreeram Kannan. Themis: Fast, strong order-fairness in byzantine consensus. <em>Cryptology ePrint Archive</em>, 2021.</p><p>[3] Yunhao Zhang, Srinath Setty, Qi Chen, Lidong Zhou, and Lorenzo Alvisi. Byzantine ordered consensus without byzantine oligarchy. In <em>14th USENIX Symposium on Operating Systems Design and Implemen- tation (OSDI 20)</em>, pages 633–649, 2020.</p></blockquote><p><strong>代码混淆</strong>：成熟的区块链和 DeFi 应用程序并不容易打补丁和重新设计。在以更系统的方式减少前置运行之前，需要轻量级的变通方法。因此，解决这一问题的一个可行办法是开发字节码级混淆技术。虽然代码混淆作为一种防御机制已经使用了几十年，但还没有人把它作为智能合约攻击和漏洞的对策来研究。可以采用控制流混淆方法，其目的是模糊程序流程，使动态分析难以推理代码。回想一下，为了复制执行路径，APE 会修改受污染的基本模块，并对代码跳转进行硬编码（参见第 5.5 节）。如果在一个受害者事务中同时访问了污点基本块的真分支和假分支，合成对抗性合约就会变得很困难，因为硬编码跳转只能访问一个分支。因此，可以设计一种针对 APE 的混淆方案，使硬编码的代码跳转导致无限循环。尽管混淆技术易于采用，并能提供针对 APE 的可靠保护，但它们仍有局限性。主要问题是，可以开发出复杂的去混淆技术来绕过这些防御。混淆防御也会导致合同更加复杂，增加执行和部署 'gas' 的成本。我们将完整的设计和评估工作留待今后进行。</p><h1 id="related-work"><a class="anchor" href="#related-work">#</a> Related Work</h1><p><strong>漏洞利用工具系统化</strong>：我们在表 7 中对最接近的相关工作进行了系统化，重点关注自动漏洞利用生成工具。我们将它们区分为：</p><ol><li>旨在获取金融价值并捕捉该过程中漏洞的工具；</li><li>检测智能合约中预定义漏洞模式的工具。</li></ol><p><img data-src="http://imgcdn.gality.cn/blog/fpuznu.png" alt="表 7：自动智能合约开发相关工作的系统化"></p><p>对于基于奖励的漏洞利用工具，我们发现，由于字符串替换方法简单，天真模仿法在实时性能方面优于 APE。不过，在相同的评估时间范围内（参见第 6 节），APE 比天真的方法捕获了更高的经济收益和更多的 DeFi 攻击。 <code>DEFIPOSER</code> 利用 SMT 解算器来识别有利可图的策略，这些策略有可能揭示新的漏洞模式。然而， <code>DEFIPOSER</code> 的有效性依赖于区块链应用的精确建模，这需要大量的人工努力。值得注意的是， <code>DEFIPOSER</code> 的实时性能取决于底层 SMT 解算器以及数学模型的复杂性。</p><p>在智能合约中检测预定义漏洞模式的工具将这些模式作为进行安全分析的输入。因此，这类工具可能不会发现不同的或新的漏洞模式。然而， <code>MAIAN</code> 和 <code>SOLAR</code> 的设计具有实时性。在 APE 之前， <code>SOLAR</code> 是我们所知的唯一能合成合约的工具。不过， <code>SOLAR</code> 需要访问智能合约的 ABI。回顾一下，闭源智能合约可能无法访问 ABI。据我们了解，SOLAR 专注于单个合约中的漏洞，因此不太可能捕捉到可组合（即跨合约）的 DeFi 攻击。</p><p><strong>智能合约攻击与安全</strong>：Atzei 等人对智能合约攻击进行了调查。许多人都专注于通过检测漏洞和生成恶意输入来自动寻找针对脆弱智能合约的漏洞利用。Qin 等人探索了通过闪贷进行 DeFi 攻击。Wu 等人提出了一种独立于平台的方法来恢复高级 DeFi 语义，以检测价格操纵攻击。</p><p><em>静态分析</em>：工具如 <code>Securify</code> 、 <code>Slither</code> 和 <code>Ethainter</code> ，可检测智能合约中的特定漏洞。这类工具通常能实现完整性，但也会报告误报。另一种检测智能合约漏洞的常见方法是采用符号执行。Mythril 和 Oyente 使用基于 SMT 的符号执行来检查 EVM 字节代码，并模拟虚拟机来探索执行路径。其他工具采用模糊技术检测各种漏洞。APE 不采用模糊技术，而是利用 EVM 来一次性动态分析智能合约。最近， <code>SMARTSHIELD</code> 和 <code>sGuard</code> 对用于修补智能合约的字节码重写进行了探索。 <code>EVMPATCH</code> 可以集成多种静态分析工具来检测漏洞，并自动完成部署和管理可升级合约的整个生命周期。</p><h1 id="conclusion"><a class="anchor" href="#conclusion">#</a> Conclusion</h1><p>广义区块链模仿游戏是对智能合约区块链的一类新攻击。采用这种模仿既可能是为了自私的结果，例如，采用 APE 的矿工可以从 DeFi 攻击中获得价值数百万美元的收益；也可能是为了更好的结果，矿工可以作为白帽黑客帮助捍卫 DeFi 生态系统，方法是预先运行攻击，并可能将由此获得的收益退还给受害者。在这项工作中，我们证明了这种模仿游戏是切实可行的，并能在以太坊和 BSC 上产生巨大价值。</p><div class="note warning no-icon"><p>附录部分请参考原论文🙏</p></div><br><div class="tags"><a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"><i class="ic i-tag"></i> 区块链</a> <a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" rel="tag"><i class="ic i-tag"></i> 论文阅读</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-01-09 13:29:43" itemprop="dateModified" datetime="2024-01-09T13:29:43+08:00">2024-01-09</time> </span><span id="scientific-research/thesis-reading/ Blockchain Imitation Game/" class="item leancloud_visitors" data-flag-title="论文阅读｜ The Blockchain Imitation Game" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/wechatpay.png" alt="Gality 微信支付"><p>微信支付</p></div><div><img data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/alipay.png" alt="Gality 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Gality <i class="ic i-at"><em>@</em></i>藏器于身</li><li class="link"><strong>本文链接：</strong> <a href="https://gality.cn/scientific-research/thesis-reading/%20Blockchain%20Imitation%20Game/" title="论文阅读｜ The Blockchain Imitation Game">https://gality.cn/scientific-research/thesis-reading/ Blockchain Imitation Game/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/misc/trail-and-error/RTX4080-tensorflow2/" itemprop="url" rel="prev" data-background-image="http:&#x2F;&#x2F;imgcdn.gality.cn&#x2F;blog&#x2F;6fuudw.jpg" title="在 RTX 4080 上运行 tensorflow 2"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 踩坑</span><h3>在 RTX 4080 上运行 tensorflow 2</h3></a></div><div class="item right"><a href="/ml/CNN/" itemprop="url" rel="next" data-background-image="http:&#x2F;&#x2F;imgcdn.gality.cn&#x2F;blog&#x2F;8ji8mr.jpg" title="CNN ｜ Network Architecture Designed for Image"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 机器学习</span><h3>CNN ｜ Network Architecture Designed for Image</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#abstract"><span class="toc-number">1.</span> <span class="toc-text">Abstract</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#introduction"><span class="toc-number">2.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#background"><span class="toc-number">3.</span> <span class="toc-text">Background</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#blockchain-and-smart-contract"><span class="toc-number">3.1.</span> <span class="toc-text">Blockchain and Smart Contract</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#blockchain-extractable-value"><span class="toc-number">3.2.</span> <span class="toc-text">Blockchain Extractable Value</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#naive-transaction-imitation-attack"><span class="toc-number">3.3.</span> <span class="toc-text">Naive Transaction Imitation Attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#motivating-examples"><span class="toc-number">3.4.</span> <span class="toc-text">Motivating Examples</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ape-overview"><span class="toc-number">4.</span> <span class="toc-text">APE Overview</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#preliminary-models"><span class="toc-number">4.1.</span> <span class="toc-text">Preliminary Models</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#attack-overview"><span class="toc-number">4.2.</span> <span class="toc-text">Attack Overview</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ape-details"><span class="toc-number">5.</span> <span class="toc-text">APE Details</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#step-1-dynamic-control-flow-graph"><span class="toc-number">5.1.</span> <span class="toc-text">Step 1 : Dynamic Control-Flow Graph</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-2-profitability-analyzer"><span class="toc-number">5.2.</span> <span class="toc-text">Step 2 : Profitability Analyzer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-3-dynamic-taint-analysis"><span class="toc-number">5.3.</span> <span class="toc-text">Step 3 : Dynamic Taint Analysis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-4-patch-identifier"><span class="toc-number">5.4.</span> <span class="toc-text">Step 4 : Patch Identifier</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-5-smart-contract-synthesis"><span class="toc-number">5.5.</span> <span class="toc-text">Step 5 : Smart Contract Synthesis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-6-validation"><span class="toc-number">5.6.</span> <span class="toc-text">Step 6 : Validation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#limitations"><span class="toc-number">5.7.</span> <span class="toc-text">Limitations</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ape-historical-evaluation"><span class="toc-number">6.</span> <span class="toc-text">APE Historical Evaluation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#methodology-and-setup"><span class="toc-number">6.1.</span> <span class="toc-text">Methodology and Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#evaluation-results"><span class="toc-number">6.2.</span> <span class="toc-text">Evaluation Results</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#historical-analysis"><span class="toc-number">6.3.</span> <span class="toc-text">Historical Analysis</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ape-real-time-evaluation"><span class="toc-number">7.</span> <span class="toc-text">APE Real-time Evaluation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#methodology-and-setup-2"><span class="toc-number">7.1.</span> <span class="toc-text">Methodology and Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#computational-real-time-performance"><span class="toc-number">7.2.</span> <span class="toc-text">Computational Real-time Performance</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ape-countermeasures"><span class="toc-number">8.</span> <span class="toc-text">APE Countermeasures</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#related-work"><span class="toc-number">9.</span> <span class="toc-text">Related Work</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#conclusion"><span class="toc-number">10.</span> <span class="toc-text">Conclusion</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/scientific-research/thesis-reading/%20Blockchain%20Imitation%20Game/" rel="bookmark" title="论文阅读｜ The Blockchain Imitation Game">论文阅读｜ The Blockchain Imitation Game</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Gality" data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/avatar.png"><p class="name" itemprop="name">Gality</p><div class="description" itemprop="description">安全杂记 & 日常随感</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">32</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">19</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">50</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dhbGl0eTM2OQ==" title="https:&#x2F;&#x2F;github.com&#x2F;Gality369"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <a href="https://gality.cn/about/" title="https:&#x2F;&#x2F;gality.cn&#x2F;about&#x2F;" class="item about"><i class="ic i-address-card"></i></a> <span class="exturl item email" data-url="bWFpbHRvOjQzNDQwMDcyNkBxcS5jb20=" title="mailto:434400726@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>资源</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/misc/trail-and-error/RTX4080-tensorflow2/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/ml/CNN/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/ponder/" title="分类于 思考与沉淀">思考与沉淀</a></div><span><a href="/ponder/%E9%9D%A2%E8%AF%95%E5%A4%8D%E7%9B%98/" title="科技协会面试反思与总结">科技协会面试反思与总结</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/os/" title="分类于 操作系统">操作系统</a> <i class="ic i-angle-right"></i> <a href="/categories/os/0-1/" title="分类于 从 0 到 1">从 0 到 1</a></div><span><a href="/os/02-mbr/" title="02-从BIOS启动到MBR编写">02-从BIOS启动到MBR编写</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ponder/" title="分类于 思考与沉淀">思考与沉淀</a></div><span><a href="/ponder/Gresham-law/" title="劣币驱逐良币 ｜ 一次网购经历的反思">劣币驱逐良币 ｜ 一次网购经历的反思</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/os/" title="分类于 操作系统">操作系统</a> <i class="ic i-angle-right"></i> <a href="/categories/os/kernel/" title="分类于 内核">内核</a></div><span><a href="/os/kernel/build-kernel/" title="从0开始构建Linux内核">从0开始构建Linux内核</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ml/" title="分类于 机器学习">机器学习</a></div><span><a href="/ml/regularization/" title="ML Regularization">ML Regularization</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/trail-and-error/" title="分类于 踩坑">踩坑</a></div><span><a href="/misc/trail-and-error/CLion-CMake/" title="CLion构建远程CMake开发环境">CLion构建远程CMake开发环境</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/scientific-research/" title="分类于 科研">科研</a> <i class="ic i-angle-right"></i> <a href="/categories/scientific-research/thesis-reading/" title="分类于 论文阅读">论文阅读</a></div><span><a href="/scientific-research/thesis-reading/%20Blockchain%20Imitation%20Game/" title="论文阅读｜ The Blockchain Imitation Game">论文阅读｜ The Blockchain Imitation Game</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/PNT/" title="分类于 PNT">PNT</a></div><span><a href="/misc/PNT/fiber-optic-and-WDM/" title="光纤通信原理与技术">光纤通信原理与技术</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/daily/" title="分类于 日常">日常</a></div><span><a href="/daily/DailyRecord/" title="九天揽月">九天揽月</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/llvm/" title="分类于 LLVM">LLVM</a></div><span><a href="/llvm/llvm-tutorial/" title="LLVM 简明教程">LLVM 简明教程</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Gality @ Samadhi</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">205k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">6:13</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span> | <span class="exturl" data-url="aHR0cHM6Ly9iZWlhbi5taWl0Lmdvdi5jbi8=">津ICP备19010031号-1</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"scientific-research/thesis-reading/ Blockchain Imitation Game/",favicon:{show:"（●´3｀●）哎呀呀～",hide:"(´Д｀)吓死你"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,copy_tex:!0,katex:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/js/app.js?v=0.2.5"></script></body></html>