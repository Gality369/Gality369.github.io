<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="KbCOz5IFs80bU-psVUCv9C7SOLzVWto8d7_5ZSsX7I0"><meta name="baidu-site-verification" content="codeva-KcLqIZYGXd"><link rel="alternate" type="application/rss+xml" title="藏器于身" href="https://gality.cn/rss.xml"><link rel="alternate" type="application/atom+xml" title="藏器于身" href="https://gality.cn/atom.xml"><link rel="alternate" type="application/json" title="藏器于身" href="https://gality.cn/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/css/app.css?v=0.2.5"><meta name="keywords" content="LLVM,教程"><link rel="canonical" href="https://gality.cn/llvm/llvm-tutorial/"><title>LLVM 简明教程 - LLVM | Samadhi = 藏器于身 = 待时而动</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">LLVM 简明教程</h1><div class="meta"><span class="item" title="创建时间：2024-03-11 10:35:28"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-03-11T10:35:28+08:00">2024-03-11</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>16k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>29 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Samadhi</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="http://imgcdn.gality.cn/blog/fmiswr.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/nikzkc.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/2023-08-19-wallhaven-welokx_1920x1080.png"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/2023-08-19-wallhaven-yxe85x_2560x1440.png"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/2023-08-19-wallhaven-9mjoy1_2560x1440.png"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/oubx8d.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/llvm/" itemprop="item" rel="index" title="分类于 LLVM"><span itemprop="name">LLVM</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://gality.cn/llvm/llvm-tutorial/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/avatar.png"><meta itemprop="name" content="Gality"><meta itemprop="description" content="待时而动, 安全杂记 & 日常随感"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="藏器于身"></span><div class="body md" itemprop="articleBody"><div class="note warning no-icon"><p>⚠️ 笔者本人也是 LLVM 新手，所以本篇内容只是笔者在自己的理解上写出的笔记性质的 “教程”，如有错误，还请大佬们指正。写这篇文章的目的在于，笔者自己在入门 LLVM IR 及 API 时基本都是英文教程，国内的教程非常杂乱，LLVM IR 相关的内容还比较丰富，但对于 LLVM API 相关的资料就比较少了，笔者在学习过程中的很多问题都是在 Stack Overflow 上得到解答的，所以这里将各种踩坑记录下来，帮助其他同学。</p></div><h1 id="llvm-安装与环境配置"><a class="anchor" href="#llvm-安装与环境配置">#</a> LLVM 安装与环境配置</h1><div class="note primary no-icon"><p>笔者的环境为：</p><ul><li>MacBook Pro 2019 Intel 芯片 macOS 14.2.1 Sonoma</li><li>Homebrew 4.2.11</li><li>CLion 233.14475.31, built on February 13, 2024</li></ul></div><h2 id="安装"><a class="anchor" href="#安装">#</a> 安装</h2><p>由于 xcode 自带的 LLVM 是经过阉割的版本，很多 llvm 的命令都没有，所以需要单独下载 llvm，推荐使用 <code>Homebrew</code> 来安装。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 搜索所有可用的 llvm 版本</span></pre></td></tr><tr><td data-num="2"></td><td><pre>brew search llvm</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 下载指定版本</span></pre></td></tr><tr><td data-num="4"></td><td><pre>brew <span class="token function">install</span> llvm@11</pre></td></tr></table></figure><p>由于<strong> llvm 不同版本之间的 API 有些微不同</strong>，所以最好是根据需求安装指定版本的 LLVM，防止出现 <code>undefined symbol</code> 的问题。</p><details class="info"><summary>无法安装/安装出错</summary><div><p>如果安装时出现报错： <code>Error: llvm@11 has been disabled because it is a versioned formula!</code> ，可以通过如下方式解决：</p><ol><li><code>brew tap --force homebrew/core</code></li><li><code>brew edit llvm@11</code></li><li>把 <code>disable! date: &quot;2024-02-22&quot;, because: :versioned_formula</code> 中的过期时间改为当前或以后，然后保存</li><li><code>HOMEBREW_NO_INSTALL_FROM_API=1 brew install llvm@11</code></li></ol></div></details><p>安装完成后需要将如下配置写入环境变量中，由于笔者使用的 <code>zsh</code> ，所以就是把如下内容写入到 <code>~/.zshrc</code> 中：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">LDFLAGS</span><span class="token operator">=</span><span class="token string">"-L/usr/local/opt/llvm@11/lib -Wl,-rpath,/usr/local/opt/llvm@11/lib"</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"/usr/local/opt/llvm@11/bin:<span class="token environment constant">$PATH</span>"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">LDFLAGS</span><span class="token operator">=</span><span class="token string">"-L/usr/local/opt/llvm@11/lib"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">CPPFLAGS</span><span class="token operator">=</span><span class="token string">"-I/usr/local/opt/llvm@11/include"</span></pre></td></tr></table></figure><p>这是在当前版本下 <code>Homebrew</code> 的默认 LLVM 安装路径，如果你的路径不是这个，请改成自己的路径。</p><h2 id="测试"><a class="anchor" href="#测试">#</a> 测试</h2><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 重新加载一下环境变量</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">source</span> ~/.zshrc</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 测试 llvm 是否成功安装</span></pre></td></tr><tr><td data-num="4"></td><td><pre>llvm-config <span class="token parameter variable">--version</span></pre></td></tr><tr><td data-num="5"></td><td><pre>╰▸ <span class="token number">11.1</span>.0</pre></td></tr></table></figure><h2 id="环境配置"><a class="anchor" href="#环境配置">#</a> 环境配置</h2><div class="note info"><p>笔者尝试了多种不同的 IDE，包括 VSCode、Xcode 和 CLion，最终成功在 CLion 上成功搭建了可调试的 LLVM 开发环境，所以推荐使用 CLion 作为 IDE。</p></div><ol><li><p>随便创建一个 <code>C++ Executable</code> 项目，语言标准任选。</p></li><li><p>点击<span class="kbd"> CLion</span> =&gt; <span class="kbd">settings</span> =&gt; <span class="kbd blue">Build, Execution, Deployment</span> =&gt; <span class="kbd red">CMake options</span>，写入：<br><code>-DLLVM_DIR:PATH=/usr/local/Cellar/llvm@11/11.1.0_4/lib/cmake/llvm</code></p></li><li><p>CLion 应该会自动为当前项目创建一个 <code>CMakeLists.txt</code> 。如果没有，则在 CLion 左边的项目根目录中<span class="kbd">右键</span> =&gt; <span class="kbd">new</span> =&gt; <span class="kbd red">CMakeLists.txt</span>。</p></li><li><p>将如下内容写入 <code>CMakeLists.txt</code> 中（假设你的项目名为 llvm_test）：</p><figure class="highlight cmake"><figcaption data-lang="CMake"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">3.27</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">project</span><span class="token punctuation">(</span>llvm_test<span class="token punctuation">)</span> <span class="token comment"># 需改为你的项目名</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">find_package</span><span class="token punctuation">(</span>LLVM REQUIRED CONFIG<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">message</span><span class="token punctuation">(</span>STATUS <span class="token string">"Found LLVM <span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token variable">LLVM_PACKAGE_VERSION</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">message</span><span class="token punctuation">(</span>STATUS <span class="token string">"Using LLVMConfig.cmake in: <span class="token interpolation"><span class="token punctuation">$&#123;</span><span class="token variable">LLVM_DIR</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># Set your project compile flags.</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># E.g. if using the C++ header files</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># you will need to enable C++11 support</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># for your compiler.</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">include_directories</span><span class="token punctuation">(</span><span class="token punctuation">$&#123;</span>LLVM_INCLUDE_DIRS<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">add_definitions</span><span class="token punctuation">(</span><span class="token punctuation">$&#123;</span>LLVM_DEFINITIONS<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_STANDARD</span> <span class="token number">17</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">add_executable</span><span class="token punctuation">(</span>llvm_test main.cpp<span class="token punctuation">)</span> <span class="token comment"># 需改为你的项目名 需要编译的 cpp 文件名</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token function">llvm_map_components_to_libnames</span><span class="token punctuation">(</span>llvm_libs irreader<span class="token punctuation">)</span> <span class="token comment">#根据需要填入 LLVM 组件</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># Link against LLVM libraries</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>llvm_test <span class="token punctuation">$&#123;</span>llvm_libs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>保存后即可使用 CLion 愉快的开发 / Debug LLVM C++ API 代码了。</p></li></ol><details class="info"><summary>⚠️常见问题</summary><div><ol><li>如果在第 4 步出现错误：找不到 <code>LLVMConfig.cmake</code> 文件，代表你的 <code>Homebrew</code> 和笔者不同，请全局搜索 <code>LLVMConfig.cmake</code> 文件并在 <code>-DLLVM_DIR:PATH=</code> 后写入正确的位置）</li><li>上述代码中 <code>llvm_map_components_to_libnames(llvm_libs irreader)</code> 是一种按需使用 LLVM 组件的方式， <code>irreader</code> 就是一个组件，对应着头文件 <code>&quot;llvm/IR/IRBuilder.h&quot;</code> ，如果你在引用头文件是出现 <code>&quot;xxx.h&quot; not found</code> 的错误，请检查是否在 <code>CMakeLists.txt</code> 中引入了对应的组件。</li><li>可以通过 <code>llvm-config --components all</code> 列出 LLVM 的所有组件。</li></ol></div></details><h1 id="llvm-基本知识"><a class="anchor" href="#llvm-基本知识">#</a> LLVM 基本知识</h1><h2 id="基本概念"><a class="anchor" href="#基本概念">#</a> 基本概念</h2><h3 id="引入"><a class="anchor" href="#引入">#</a> 引入</h3><p>随着计算机技术的不断发展以及各种领域需求的增多，近几年来，许多编程语言如雨后春笋般出现，他们大多为了解决某一些特定领域的需求，比如说为 JavaScript 增加静态类型检查的 TypeScript，为解决服务器端高并发的 Golang，为解决内存安全和线程安全的 Rust。</p><p>让我们设身处地地想象一下，如果我们想开发一门新的编译型的编程语言，有什么需要解决的问题呢？</p><ol><li><p>怎样让我的编程语言能在尽可能多的平台上运行</p><p>​	我想让我的编程语言能够在 Windows、macOS 和 Linux 上都可以运行；我想让我的编程语言能够在 Intel 芯片、ARM 芯片，乃至龙芯上都可以运行。</p></li><li><p>怎样让我的编程语言可以使用前人先进的技术</p><p>​	在编程语言发展的过程中，有许许多多成熟的技术。从汇编指令层面来看，简单地想给一个变量值置 0，AMD64 架构下可以用 <code>xor %eax, %eax</code> 异或自身，AArch64 架构下可以用 <code>mov w0, wzr</code> 使用零寄存器；从算法层面来看，可以使用尾调用优化、CFI 等。如果我不想重复造轮子，该如何复用这些技术呢？</p></li><li><p>怎样让我的编程语言在汇编层面实现「定制」</p><p>​	高级语言中的函数名，在汇编层面，我想让他换个名字；我想让 C 语言库能用它的调用约定来调用我的高级语言中的函数。</p></li></ol><p>我们可以选择使用 C 语言来作为 “中间层”，当我们开发新编译语言时，提供该语言到 C 语言的转换，这样做是因为：</p><ol><li>绝大部分的操作系统都是由 C 和汇编语言写成，因此平台大多会提供一个 C 编译器可以使用，这样就解决了第一个问题</li><li>C 语言历史久远，有非常多的优化器，程序翻译成 C 语言后就可以直接使用那些为 C 语言定制的优化器，从而方便的使用前人的成熟技术，这就解决了第二个问题。</li><li>C 语言本身并没有笨重的运行时，代码很贴近底层，可以使用一定程度的定制，一定程度上解决了第三个问题。</li></ol><p>然而，C 语言毕竟是 “老古董” 了，相对于现在的各种编程语言来说还是太过僵硬死板。如果有这么一种语言，他<strong>可以在各个平台运行</strong>，且<strong>自带极高的代码优化能力</strong>，同时<strong>提供灵活操作系统底层的能力</strong>，那么当我们想开发一个新的编程语言时，岂不是只需要提供一个从新语言到这种语言的转换器就可以了。没错，这就是 LLVM！</p><p>简单来说，当我们想开发一种新的编程语言时，只需提供将自己语言的源代码编译成 LLVM 的中间代码（LLVM IR）的能力，然后就可以交由 LLVM 对中间代码进行优化，并编译成所需运行平台的二进制程序。LLVM 的优点也正对应我们之前讲的三个问题：</p><ul><li><p>LLVM 后端支持的平台很多，我们不需要担心 CPU、操作系统的问题</p><p>有一点需要指出的是，操作系统 API 的调用还是得由编程语言开发者自己实现，LLVM 不负责这个。例如，编程语言的标准库中，打开一个文件，其底层实现在 Linux 中是否是 <code>open</code> 系统调用，在 Windows 中是否是 <code>CreateFile</code> 函数，这都得编程语言开发者自己实现。</p></li><li><p>LLVM 后端的优化水平较高，我们只需要将代码编译成 LLVM IR，就可以由 LLVM 后端作相应的优化</p><p>但我们需要知道一点，LLVM IR 毕竟是更为底层的语言，在高级语言中的许多细节，都会在 LLVM IR 中丢失。因此，高级语言中能做的优化，还是得趁早做，把一大堆未经优化的 LLVM IR 丢给 LLVM 后端去优化，会严重拖慢编译时间，降低生成的二进制程序的性能。</p></li><li><p>LLVM IR 本身比较贴近汇编语言，同时也提供了许多 ABI 层面的定制化功能</p></li></ul><h3 id="架构"><a class="anchor" href="#架构">#</a> 架构</h3><p><img data-src="http://imgcdn.gality.cn/blog/lhykol.jpg" alt="LLVM 架构"></p><p>LLVM 整体架构如上图所示。在整个编译过程中，LLVM 的前端是为各种编程语言定制的，负责将对应编程语言的源代码转换成 LLVM 中间表示（IR，Intermediate Representation）；LLVM 的后端为各种不同的平台做了适配，负责将 LLVM IR 转换成在特定平台上可执行的二进制文件。如果在编译过程中涉及到优化的话，则由 LLVM 优化器来对 IR 文件进行优化，并将优化后的 IR 文件输出给 LLVM 后端去编译，因此 IR 的设计是 LLVM 的灵魂所在。</p><h3 id="llvm-ir"><a class="anchor" href="#llvm-ir">#</a> LLVM IR</h3><div class="note info no-icon"><p>🔔 有关 IR 的更多知识，将在「基本 IR 指令」章节中讲解</p></div><p>LLVM IR 的设计体现了<strong>权衡</strong>的计算思维。低级的 IR（即更接近目标代码的 IR）允许编译器更容易地生成针对特定硬件的优化代码，但不利于支持多目标代码的生成。高级的 IR 允许优化器更容易地提取源代码的意图，但不利于编译器根据不同的硬件特性进行代码优化。</p><p>LLVM IR 的设计采用 <code>common IR</code> 和 <code>specific IR</code> 相结合的方式。 <code>common IR</code> 旨在不同的后端共享对源程序的相同理解，以将其转换为不同的目标代码。除此之外，也为多个后端之间共享一组与目标无关的优化提供了可能性。 <code>specific IR</code> 允许不同的后端在不同的较低级别优化目标代码。这样做，既可以支持多目标代码的生成，也兼顾了目标代码的执行效率。</p><p>LLVM IR 有如下 3 种<strong>等价</strong>形式：</p><ul><li>内存表示<ul><li>类 <code>llvm::Function</code> 、 <code>llvm::Instruction</code> 等用于表示 <code>common IR</code> 。</li><li>类 <code>llvm::MachineFunction</code> 、 <code>llvm::MachineInstr</code> 等用于表示 <code>specific IR</code> 。</li></ul></li><li><code>.bc</code> 格式（Bitcode Files，存储在磁盘中）</li><li><code>.ll</code> 格式（存储在磁盘中，便于人类阅读）</li></ul><p>LLVM IR 的特点如下：</p><ul><li>采用静态单一赋值（Static Single Assignment，SSA），即每个值只有一个定义它的赋值操作</li><li>代码被组织为三地址指令（Three-address Instructions）</li><li>有无限多个寄存器</li></ul><h2 id="基本命令"><a class="anchor" href="#基本命令">#</a> 基本命令</h2><h3 id="c-to-irbitcode"><a class="anchor" href="#c-to-irbitcode">#</a> C to IR/Bitcode</h3><p>由 <code>test.c</code> 生成 <code>IR</code> 文件</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>clang -emit-llvm <span class="token parameter variable">-S</span> test.c <span class="token parameter variable">-o</span> test.ll</pre></td></tr><tr><td data-num="2"></td><td><pre>clang -emit-llvm <span class="token parameter variable">-c</span> test.c <span class="token parameter variable">-o</span> test.bc</pre></td></tr></table></figure><p>如果需要其他编译参数可以直接附加，只要保证有 <code>-emit-llvm -S</code> 参数即可生成 <code>IR/Bicode</code> 文件，例如：</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>clang -emit-llvm <span class="token parameter variable">-S</span> <span class="token parameter variable">-g</span> <span class="token parameter variable">-O3</span> -funroll-loops test.c <span class="token parameter variable">-o</span> test.ll</pre></td></tr><tr><td data-num="2"></td><td><pre>clang -emit-llvm <span class="token parameter variable">-c</span> <span class="token parameter variable">-g</span> <span class="token parameter variable">-O3</span> -funroll-loops test.c <span class="token parameter variable">-o</span> test.bc</pre></td></tr></table></figure><h3 id="cpp-to-irbitcode"><a class="anchor" href="#cpp-to-irbitcode">#</a> CPP to IR/Bitcode</h3><p>由 <code>test.cpp</code> 生成 <code>IR</code> 文件</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>clang++ -emit-llvm <span class="token parameter variable">-S</span> test.cpp <span class="token parameter variable">-o</span> test.ll</pre></td></tr><tr><td data-num="2"></td><td><pre>clang++ -emit-llvm <span class="token parameter variable">-c</span> test.cpp <span class="token parameter variable">-o</span> test.bc</pre></td></tr></table></figure><h3 id="ccpp-to-execute"><a class="anchor" href="#ccpp-to-execute">#</a> C/CPP to execute</h3><p>使用方法与 <code>gcc</code> 类似</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>clang test.c <span class="token parameter variable">-o</span> <span class="token builtin class-name">test</span></pre></td></tr><tr><td data-num="2"></td><td><pre>clang++ test.cpp <span class="token parameter variable">-o</span> <span class="token builtin class-name">test</span></pre></td></tr></table></figure><h3 id="ir-to-bitcode"><a class="anchor" href="#ir-to-bitcode">#</a> IR to Bitcode</h3><p>对于 LLVM 来说， <code>.ll</code> 格式是给 “人” 看的格式， <code>.bc</code> 是给 “机器” 看的格式，将 “人” 看的代码转成 “机器码”，就类似于汇编的过程，所以用 <code>llvm-as</code> 命令。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>llvm-as test.ll <span class="token parameter variable">-o</span> test.bc</pre></td></tr></table></figure><h3 id="bitcode-to-ir"><a class="anchor" href="#bitcode-to-ir">#</a> Bitcode to IR</h3><p>同理，将 <code>.bc</code> 格式转换为 <code>.ll</code> 格式的过程就类似于反汇编的过程，所以用 <code>llvm-dis</code> 命令。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>llvm-dis test.bc <span class="token parameter variable">-o</span> test.bc.ll</pre></td></tr></table></figure><h3 id="irbicode-to-asm"><a class="anchor" href="#irbicode-to-asm">#</a> IR/Bicode to asm</h3><p>生成目标平台的汇编代码，输入文件可以是 <code>.bc</code> 类型的，也可以是 <code>.ll</code> 类型的。</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>llc test.bc <span class="token parameter variable">-o</span> test.bc.s</pre></td></tr><tr><td data-num="2"></td><td><pre>llc test.ll <span class="token parameter variable">-o</span> test.ll.s</pre></td></tr></table></figure><h3 id="irbicode-to-execute"><a class="anchor" href="#irbicode-to-execute">#</a> IR/Bicode to execute</h3><p>IR 和 Bitcode 格式都能直接运行</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>lli test.ll</pre></td></tr><tr><td data-num="2"></td><td><pre>lli test.bc</pre></td></tr></table></figure><h2 id="基本ir语法"><a class="anchor" href="#基本ir语法">#</a> 基本 IR 语法</h2><h3 id="ir结构"><a class="anchor" href="#ir结构">#</a> IR 结构</h3><details class="primary"><summary>LLVM IR的结构（可先往下看，自己总结）</summary><div><ol><li>模块（Module）：LLVM IR 的最顶层结构是模块，表示整个程序或库。一个模块由一组全局变量和函数组成。</li><li>全局变量（Global Variables）：LLVM IR 允许声明全局变量，它们是在整个程序中可见的。全局变量由其类型、名称和可选的初始值组成。全局变量的声明以 <code>@</code> 符号开头，后面跟着变量名称和类型信息。例如， <code>@myGlobal = global i32 0</code> 表示一个名为 <code>myGlobal</code> 的 32 位整数全局变量，初始值为 0。</li><li>函数（Functions）：LLVM IR 中的函数由函数类型、名称、参数列表和函数体组成。函数类型包括返回类型和参数类型。函数的声明以 <code>define</code> 关键字开头，后面是返回类型、函数名称、参数列表和函数体。函数体由基本块（Basic Block）组成，每个基本块由一组指令组成。函数体的最后一条指令通常是返回指令。</li><li>基本块（Basic Blocks）：基本块是 LLVM IR 中的基本执行单元。它由一系列按顺序执行的指令组成，没有分支或跳转指令。基本块以标签（Label）开头，后面是一组指令。基本块可以包含控制流指令，如条件分支和无条件跳转，以便实现程序的控制流程。</li><li>指令（Instructions）：LLVM IR 包括各种指令来表示程序的操作。指令由操作码和操作数组成，用于执行特定的操作。LLVM IR 支持常见的指令类型，如赋值指令、算术运算指令、逻辑运算指令、条件分支指令、内存访问指令等。指令可以使用变量、常量和表达式作为操作数。</li></ol></div></details><p>首先来看看 IR 长什么样子</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello World!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用 <code>clang -emit-llvm -S main.c -o main.ll</code> 将上述代码编译成 IR 的 <code>.ll</code> 格式：</p><figure class="highlight llvm"><figcaption data-lang="LLVM IR"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">; ModuleID = 'main.c'</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">source_filename</span> <span class="token punctuation">=</span> <span class="token string">"main.c"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">target</span> <span class="token keyword">datalayout</span> <span class="token punctuation">=</span> <span class="token string">"e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">target</span> <span class="token keyword">triple</span> <span class="token punctuation">=</span> <span class="token string">"x86_64-apple-macosx14.0.0"</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token variable">@.str</span> <span class="token punctuation">=</span> <span class="token keyword">private</span> <span class="token keyword">unnamed_addr</span> <span class="token keyword">constant</span> <span class="token punctuation">[</span><span class="token number">14</span> <span class="token keyword">x</span> <span class="token type class-name">i8</span><span class="token punctuation">]</span> <span class="token keyword">c</span><span class="token string">"Hello World!\0A\00"</span><span class="token punctuation">,</span> <span class="token keyword">align</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">; Function Attrs: noinline nounwind optnone ssp uwtable</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">define</span> <span class="token keyword">dso_local</span> <span class="token type class-name">i32</span> <span class="token variable">@main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token variable">#0</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token variable">%1</span> <span class="token punctuation">=</span> <span class="token keyword">alloca</span> <span class="token type class-name">i32</span><span class="token punctuation">,</span> <span class="token keyword">align</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">store</span> <span class="token type class-name">i32</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token type class-name">i32</span><span class="token punctuation">*</span> <span class="token variable">%1</span><span class="token punctuation">,</span> <span class="token keyword">align</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token variable">%2</span> <span class="token punctuation">=</span> <span class="token keyword">call</span> <span class="token type class-name">i32</span> <span class="token punctuation">(</span><span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token variable">@printf</span><span class="token punctuation">(</span><span class="token type class-name">i8</span><span class="token punctuation">*</span> <span class="token keyword">getelementptr</span> <span class="token keyword">inbounds</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">14</span> <span class="token keyword">x</span> <span class="token type class-name">i8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">14</span> <span class="token keyword">x</span> <span class="token type class-name">i8</span><span class="token punctuation">]</span><span class="token punctuation">*</span> <span class="token variable">@.str</span><span class="token punctuation">,</span> <span class="token type class-name">i64</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token type class-name">i64</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">ret</span> <span class="token type class-name">i32</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">declare</span> <span class="token type class-name">i32</span> <span class="token variable">@printf</span><span class="token punctuation">(</span><span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token variable">#1</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">attributes</span> <span class="token variable">#0</span> <span class="token punctuation">=</span> <span class="token punctuation">&#123;</span> <span class="token keyword">noinline</span> <span class="token keyword">nounwind</span> <span class="token keyword">optnone</span> <span class="token keyword">ssp</span> <span class="token keyword">uwtable</span> <span class="token string">"disable-tail-calls"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"frame-pointer"</span><span class="token punctuation">=</span><span class="token string">"all"</span> <span class="token string">"less-precise-fpmad"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"min-legal-vector-width"</span><span class="token punctuation">=</span><span class="token string">"0"</span> <span class="token string">"no-infs-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-jump-tables"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-nans-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-signed-zeros-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-trapping-math"</span><span class="token punctuation">=</span><span class="token string">"true"</span> <span class="token string">"stack-protector-buffer-size"</span><span class="token punctuation">=</span><span class="token string">"8"</span> <span class="token string">"target-cpu"</span><span class="token punctuation">=</span><span class="token string">"penryn"</span> <span class="token string">"target-features"</span><span class="token punctuation">=</span><span class="token string">"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87"</span> <span class="token string">"tune-cpu"</span><span class="token punctuation">=</span><span class="token string">"generic"</span> <span class="token string">"unsafe-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"use-soft-float"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">attributes</span> <span class="token variable">#1</span> <span class="token punctuation">=</span> <span class="token punctuation">&#123;</span> <span class="token string">"disable-tail-calls"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"frame-pointer"</span><span class="token punctuation">=</span><span class="token string">"all"</span> <span class="token string">"less-precise-fpmad"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-infs-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-nans-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-signed-zeros-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-trapping-math"</span><span class="token punctuation">=</span><span class="token string">"true"</span> <span class="token string">"stack-protector-buffer-size"</span><span class="token punctuation">=</span><span class="token string">"8"</span> <span class="token string">"target-cpu"</span><span class="token punctuation">=</span><span class="token string">"penryn"</span> <span class="token string">"target-features"</span><span class="token punctuation">=</span><span class="token string">"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87"</span> <span class="token string">"tune-cpu"</span><span class="token punctuation">=</span><span class="token string">"generic"</span> <span class="token string">"unsafe-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"use-soft-float"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token variable">!llvm.module.flags</span> <span class="token punctuation">=</span> <span class="token punctuation">!</span><span class="token punctuation">&#123;</span><span class="token variable">!0</span><span class="token punctuation">,</span> <span class="token variable">!1</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token variable">!llvm.ident</span> <span class="token punctuation">=</span> <span class="token punctuation">!</span><span class="token punctuation">&#123;</span><span class="token variable">!2</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token variable">!0</span> <span class="token punctuation">=</span> <span class="token punctuation">!</span><span class="token punctuation">&#123;</span><span class="token type class-name">i32</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">!</span><span class="token string">"wchar_size"</span><span class="token punctuation">,</span> <span class="token type class-name">i32</span> <span class="token number">4</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token variable">!1</span> <span class="token punctuation">=</span> <span class="token punctuation">!</span><span class="token punctuation">&#123;</span><span class="token type class-name">i32</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">!</span><span class="token string">"PIC Level"</span><span class="token punctuation">,</span> <span class="token type class-name">i32</span> <span class="token number">2</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token variable">!2</span> <span class="token punctuation">=</span> <span class="token punctuation">!</span><span class="token punctuation">&#123;</span><span class="token punctuation">!</span><span class="token string">"Homebrew clang version 12.0.1"</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>虽然只是一个简单的 <code>Hello world</code> 程序，但是也基本包含了 IR 文件的各个部分。“麻雀虽小，五脏俱全”，让我们从上往下依次来看：</p><p><strong>第一部分（1～4 行）</strong></p><ul><li><p><code>source_filename</code> ：描述了源文件的名称及其所在路径。</p></li><li><p><code>target datalayout</code> ：描述了目标机器中数据的内存布局方式，包括：字节序、类型大小以及对齐方式「<span class="exturl" data-url="aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xhbmdSZWYuaHRtbCNkYXRhLWxheW91dA==">具体说明</span>」。</p></li><li><p><code>target triple</code> ：描述了目标机器是什么，从而指示后端生成相应的目标代码。</p></li></ul><p><strong>第二部分（6～19 行）</strong></p><ul><li><p>标识符</p><p>LLVM IR 中的标识符分为：全局标识符和局部标识符。全局标识符以 <code>@</code> 开头，比如：全局函数、全局变量。局部标识符以 <code>%</code> 开头，类似于汇编语言中的寄存器。</p><p>标识符有如下 3 种形式：</p><ul><li>有名称的值（Named Value），表示为带有前缀（ <code>@</code> 或 <code>%</code> ）的字符串。比如：% val、@name。</li><li>无名称的值（Unnamed Value），表示为带前缀（ <code>@</code> 或 <code>%</code> ）的无符号数值。比如：%0、%1、@2。</li><li>常量。</li></ul></li><li><p><code>define</code> ：用于定义一个函数</p><ul><li><p><code>define dso_local i32 @main() #0 &#123; ... &#125;</code> ，表示定义一个函数。其函数名称为 <code>main</code> ，返回值的数据类型为 <code>i32</code> （占用 4 字节的整型），没有参数。</p></li><li><p><code>#0</code> ，用于修饰函数时表示一组函数属性「<span class="exturl" data-url="aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xhbmdSZWYuaHRtbCNmdW5jdGlvbi1hdHRyaWJ1dGVz">具体说明</span>」。这些属性定义在文件末尾。如下：</p><figure class="highlight llvm"><figcaption data-lang="LLVM IR"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">attributes</span> <span class="token variable">#0</span> <span class="token punctuation">=</span> <span class="token punctuation">&#123;</span> <span class="token keyword">noinline</span> <span class="token keyword">nounwind</span> <span class="token keyword">optnone</span> <span class="token keyword">ssp</span> <span class="token keyword">uwtable</span> <span class="token string">"disable-tail-calls"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"frame-pointer"</span><span class="token punctuation">=</span><span class="token string">"all"</span> <span class="token string">"less-precise-fpmad"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"min-legal-vector-width"</span><span class="token punctuation">=</span><span class="token string">"0"</span> <span class="token string">"no-infs-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-jump-tables"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-nans-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-signed-zeros-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"no-trapping-math"</span><span class="token punctuation">=</span><span class="token string">"true"</span> <span class="token string">"stack-protector-buffer-size"</span><span class="token punctuation">=</span><span class="token string">"8"</span> <span class="token string">"target-cpu"</span><span class="token punctuation">=</span><span class="token string">"penryn"</span> <span class="token string">"target-features"</span><span class="token punctuation">=</span><span class="token string">"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87"</span> <span class="token string">"tune-cpu"</span><span class="token punctuation">=</span><span class="token string">"generic"</span> <span class="token string">"unsafe-fp-math"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token string">"use-soft-float"</span><span class="token punctuation">=</span><span class="token string">"false"</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>LLVM IR 中，函数体是由<strong>基本块</strong>（Basic Blocks）构成的。基本块是由一系列顺序执行的语句构成的，并（可选地）以标签作为起始。不同的标签代表不同的基本块。</p><p>基本块的特点如下：</p><ul><li>仅有一个入口，即基本块中的第一条指令。</li><li>仅有一个出口，即基本块中的最后一条指令（被称为 <code>terminator instruction</code> ）。该指令要么跳转到其他基本块（不包括入口基本块），要么从函数返回。</li><li>函数体中第一个出现的基本块，称为入口基本块（Entry Basic Block）。它是一个特殊的基本块，在进入函数时立即执行该基本块，并且不允许作为其他基本块的跳转目标（即不允许该基本块有前继节点）。</li></ul></li></ul></li></ul><p><strong>第三部分（21～26 行）</strong></p><ul><li><p><code>llvm.module.flags</code> ：命名元数据（Named Metadata）之一，用于描述模块级别的信息。</p><p><code>llvm.module.flags</code> 是一个包含一系列元数据节点的集合。集合中的每个元数据节点都是一个形如 <code>&#123;&lt;behavior&gt;, &lt;key&gt;, &lt;value&gt;&#125;</code> 的三元组。其中， <code>&lt;behavior&gt;</code> 用于指定来自不同模块的 <code>&lt;key&gt;</code> 和 <code>&lt;value&gt;</code> 都相同的元数据合并时如何处理， <code>&lt;key&gt;</code> 表示元数据在本模块中的唯一标识符（仅在本模块内唯一，来自不同模块的元数据可能有相同的标识符）， <code>&lt;value&gt;</code> 表示元数据所携带信息的值。</p><p>常见的 <code>&lt;behavior&gt;</code> 值为「1」，表示「如果两个值不一致，则发出错误，否则生成的值就是操作数的值」。</p><figure class="highlight llvm"><figcaption data-lang="LLVM IR"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token variable">!llvm.module.flags</span> <span class="token punctuation">=</span> <span class="token punctuation">!</span><span class="token punctuation">&#123;</span><span class="token variable">!0</span><span class="token punctuation">,</span> <span class="token variable">!1</span><span class="token punctuation">&#125;</span> <span class="token comment">; 指定了两个元数据！0 和！1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token variable">!0</span> <span class="token punctuation">=</span> <span class="token punctuation">!</span><span class="token punctuation">&#123;</span><span class="token type class-name">i32</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">!</span><span class="token string">"wchar_size"</span><span class="token punctuation">,</span> <span class="token type class-name">i32</span> <span class="token number">4</span><span class="token punctuation">&#125;</span> <span class="token comment">; 表示标识符为 "wchar_size" 的元数据所携带信息的值在所有模块中都应该是 4，否则会报错</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token variable">!1</span> <span class="token punctuation">=</span> <span class="token punctuation">!</span><span class="token punctuation">&#123;</span><span class="token type class-name">i32</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">!</span><span class="token string">"PIC Level"</span><span class="token punctuation">,</span> <span class="token type class-name">i32</span> <span class="token number">2</span><span class="token punctuation">&#125;</span> <span class="token comment">; 同理</span></pre></td></tr></table></figure></li><li><p><code>llvm.ident</code> ：用于表示 Clang 的版本信息。</p></li></ul><h3 id="ir-指令"><a class="anchor" href="#ir-指令">#</a> IR 指令</h3><p>在 LLVM 的 IR 中，所有的数据类型都是基于 LLVM 类型系统定义的，这些数据类型包括整数、浮点数、指针、数组、结构体等等，每个数据类型都具有自己的属性，例如位宽、对齐方式等等。在 IR 中，每个值都有一个类型，这个类型可以被显式地指定，或者通过指令的操作数推导出来。</p><p>LLVM 的 IR 指令非常丰富，包括算术、逻辑、比较、转换、控制流等等，它们可以被用来表达复杂的程序结构，同时 IR 指令还可以通过 LLVM 的优化器进行优化，以生成高效的目标代码。</p><p>IR 指令类型比较多，以下是一些常见的指令类型：</p><ol><li>加减乘除指令：add, sub, mul, sdiv, udiv, fadd, fsub, fmul, fdiv 等</li><li>位运算指令：and, or, xor, shl, lshr, ashr 等</li><li>转换指令：trunc, zext, sext, fptrunc, fpext, fptoui, fptosi, uitofp, sitofp, ptrtoint, inttoptr, bitcast 等</li><li>内存指令：alloca, load, store, getelementptr 等</li><li>控制流指令：br, switch, ret, indirectbr, invoke, resume, unreachable 等</li><li>其他指令：phi, select, call, va_arg, landingpad 等</li></ol><p>指令相关内容资料丰富，不再具体赘述了，可以参考：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC83MjAyOTc2MTY3NTE1MDQ1OTQ2">LLVM 的 IR 指令详解</span></li><li><span class="exturl" data-url="aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xhbmdSZWYuaHRtbA==">LLVM 官方手册</span></li></ul><h1 id="llvm-c-api相关操作"><a class="anchor" href="#llvm-c-api相关操作">#</a> LLVM C++ API 相关操作</h1><div class="note primary no-icon"><ul><li><p>本章使用的 C++ API 对应 <code>LLVM 17.0.6_1</code> ，同大版本下 API 基本不会发生太大变化，而如果是不同大版本，部分 API 的定义可能不同，需要自行查看 API 手册。</p></li><li><p>查看 LLVM 版本： <code>llvm-config --version</code></p></li><li><p>API 手册：<span class="exturl" data-url="aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xhbmdSZWYuaHRtbA==">https://llvm.org/docs/LangRef.html</span></p></li><li><p>⚠️ 为了方便书写，给出的代码大多是片段的形式。在默认情况下，本章节代码具有连续性，即若代码片段中某个变量未定义但直接使用，可以往前找找看。</p></li></ul></div><h2 id="读写ir文件"><a class="anchor" href="#读写ir文件">#</a> 读 / 写 IR 文件</h2><p>读写 IR 文件是分析的基础，通过读入 IR 文件并进行解析，可以向源程序中插入我们自定义的操作，然后将更改后的 IR 写回文件，将结果保存下来。假设需要读入一个 <code>main.ll</code> 的 IR 文件并对其进行操作，操作完成后将 IR 保存成 <code>.bc</code> 的格式。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/LLVMContext.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/Module.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/IRBuilder.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/Instructions.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/Support/SourceMgr.h></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IRReader/IRReader.h></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/BasicBlock.h></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/Transforms/Utils/BasicBlockUtils.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Support/raw_ostream.h"</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Bitcode/BitcodeWriter.h"</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> llvm<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    LLVMContext ctx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    SMDiagnostic err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  	<span class="token comment">// 读入指定 IR 文件并解析，获取 LLVMContext</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Module<span class="token operator">></span> mod_ptr <span class="token operator">=</span> <span class="token function">parseIRFile</span><span class="token punctuation">(</span><span class="token string">"main.ll"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod_ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to read IR File\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    Module <span class="token operator">*</span>mod <span class="token operator">=</span> mod_ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 分析操作</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  	<span class="token comment">// 保存成文件</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    std<span class="token double-colon punctuation">::</span>error_code EC<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    llvm<span class="token double-colon punctuation">::</span>raw_fd_ostream <span class="token function">OS</span><span class="token punctuation">(</span><span class="token string">"main.bc"</span><span class="token punctuation">,</span> EC<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>EC<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"failed to open output file\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    llvm<span class="token double-colon punctuation">::</span><span class="token function">WriteBitcodeToFile</span><span class="token punctuation">(</span><span class="token operator">*</span>mod_ptr<span class="token punctuation">,</span> OS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li><p>保存成 <code>.ll</code> 格式：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>std<span class="token double-colon punctuation">::</span>error_code EC<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>llvm<span class="token double-colon punctuation">::</span>raw_fd_ostream <span class="token function">OS</span><span class="token punctuation">(</span>source_ll<span class="token punctuation">,</span> EC<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>EC<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"failed to open output file\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>mod<span class="token operator">-></span><span class="token function">print</span><span class="token punctuation">(</span>OS<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p>在终端直接输出 <code>.ll</code> 格式</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>mod<span class="token operator">-></span><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul><h2 id="遍历ir文件"><a class="anchor" href="#遍历ir文件">#</a> 遍历 IR 文件</h2><p>这里给出遍历所有指令的代码</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/LLVMContext.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/Module.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/IRBuilder.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/Instructions.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/Support/SourceMgr.h></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IRReader/IRReader.h></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/BasicBlock.h></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/Transforms/Utils/BasicBlockUtils.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Support/raw_ostream.h"</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Bitcode/BitcodeWriter.h"</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> llvm<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    LLVMContext ctx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    SMDiagnostic err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Module<span class="token operator">></span> mod_ptr <span class="token operator">=</span> <span class="token function">parseIRFile</span><span class="token punctuation">(</span><span class="token string">"main.ll"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod_ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to read IR File\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    Module <span class="token operator">*</span>mod <span class="token operator">=</span> mod_ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  	<span class="token comment">// 依次遍历 * 函数 *</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>F <span class="token operator">:</span> <span class="token operator">*</span>mod<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      	<span class="token comment">// 依次遍历 * 基本块 *</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span>BasicBlock <span class="token operator">&amp;</span>BB <span class="token operator">:</span> F<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          	<span class="token comment">// 依次遍历 * 指令 *</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span>Instruction <span class="token operator">&amp;</span>I <span class="token operator">:</span> BB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token comment">// 对指令进行操作</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>		mod<span class="token operator">-></span><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><details class="info"><summary>范围for「C++ 11引入」</summary><div><p>C++ 11 中引入了<span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL3poLWNuL2NwcC9zdGFuZGFyZC1saWJyYXJ5L2l0ZXJhdG9yP3ZpZXc9bXN2Yy0xNzA=">迭代器对象</span>，可通过使用成员和全局函数（如 <code>begin()</code> 和 <code>end()</code> ）以及运算符（如 <code>++</code> 和 <code>--</code> ）向前或向后移动，来显式使用迭代器。也可以通过范围 for 循环来隐式使用迭代器。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* 显示使用迭代器 */</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 定义一个迭代器</span></pre></td></tr><tr><td data-num="4"></td><td><pre>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> vec<span class="token punctuation">&#123;</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> <span class="token function">begin</span><span class="token punctuation">(</span>vec<span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> <span class="token function">end</span><span class="token punctuation">(</span>vec<span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// Access element using dereference operator</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>it <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>上述代码等价于</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 推荐使用 auto 来自动获取类型</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> num <span class="token operator">:</span> vec<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// no dereference operator</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    cout <span class="token operator">&lt;&lt;</span> num <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><h2 id="创建函数基本块指令"><a class="anchor" href="#创建函数基本块指令">#</a> 创建函数 / 基本块 / 指令</h2><p>在创建函数 / 基本块 / 指令时需要先获取当前的上下文，并设置好 “插入点”，创建的基本块 / 指令会插入到 “插入点” 指定的位置。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/LLVMContext.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/Module.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/IRBuilder.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/Instructions.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/Support/SourceMgr.h></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IRReader/IRReader.h></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/IR/BasicBlock.h></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;llvm/Transforms/Utils/BasicBlockUtils.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Support/raw_ostream.h"</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Bitcode/BitcodeWriter.h"</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> llvm<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    LLVMContext ctx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    SMDiagnostic err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Module<span class="token operator">></span> mod_ptr <span class="token operator">=</span> <span class="token function">parseIRFile</span><span class="token punctuation">(</span><span class="token string">"main.ll"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod_ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to read IR File\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    Module <span class="token operator">*</span>mod <span class="token operator">=</span> mod_ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    IRBuilder<span class="token operator">&lt;</span><span class="token operator">></span> <span class="token function">builder</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>		</pre></td></tr><tr><td data-num="28"></td><td><pre>  	<span class="token comment">// 先声明函数结构：这里声明了一个返回值为 double，参数为一个 double 类型的函数；false 表明该函数参数个数不可变</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    FunctionType <span class="token operator">*</span>funcType <span class="token operator">=</span> <span class="token class-name">FunctionType</span><span class="token double-colon punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token double-colon punctuation">::</span><span class="token function">getDoubleTy</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token class-name">Type</span><span class="token double-colon punctuation">::</span><span class="token function">getDoubleTy</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 创建一个函数，将函数命名为 check</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    Function <span class="token operator">*</span>checkFunc <span class="token operator">=</span> <span class="token class-name">Function</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span>funcType<span class="token punctuation">,</span> Function<span class="token double-colon punctuation">::</span>ExternalLinkage<span class="token punctuation">,</span> <span class="token string">"check"</span><span class="token punctuation">,</span> mod<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 存储参数（获取参数的引用）</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    Function<span class="token double-colon punctuation">::</span>arg_iterator argsIT <span class="token operator">=</span> checkFunc<span class="token operator">-></span><span class="token function">arg_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Function 中的一个方法，获取参数的迭代器</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    Value <span class="token operator">*</span>arg_n <span class="token operator">=</span> argsIT<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 获取第一个参数</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  	<span class="token comment">// 在 "check" 函数中创建一个基本块</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    BasicBlock <span class="token operator">*</span>entryBlock <span class="token operator">=</span> <span class="token class-name">BasicBlock</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> checkFunc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    builder<span class="token punctuation">.</span><span class="token function">SetInsertPoint</span><span class="token punctuation">(</span>entryBlock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置插入点为上一行创建的基本块</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    Value <span class="token operator">*</span>fRemResult <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">CreateFRem</span><span class="token punctuation">(</span>arg_n<span class="token punctuation">,</span> <span class="token class-name">ConstantFP</span><span class="token double-colon punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">APFloat</span><span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建 "FRem" 指令</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    builder<span class="token punctuation">.</span><span class="token function">CreateRet</span><span class="token punctuation">(</span>fRemResult<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建 "ret" 指令， 返回值为 "FRem" 的结果</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>F <span class="token operator">:</span> <span class="token operator">*</span>mod<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span>BasicBlock <span class="token operator">&amp;</span>BB <span class="token operator">:</span> F<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span>Instruction <span class="token operator">&amp;</span>I <span class="token operator">:</span> BB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    mod<span class="token operator">-></span><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="创建跳转"><a class="anchor" href="#创建跳转">#</a> 创建跳转</h2><ol><li><p>通过函数调用进行跳转</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// BO 是 FAdd 指令指针，同时也是该指令的返回值</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">auto</span> <span class="token operator">*</span>BO <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dyn_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>BinaryOperator<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>I<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>BO<span class="token operator">-></span><span class="token function">getOpcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Instruction<span class="token double-colon punctuation">::</span>FAdd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// 设置插入点为 BO 指令的下一条</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   builder<span class="token punctuation">.</span><span class="token function">SetInsertPoint</span><span class="token punctuation">(</span>BO<span class="token operator">-></span><span class="token function">getNextNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// 创建 call 指令，call checkFunc 函数，参数为 BO</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   Value <span class="token operator">*</span>checkResult <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">CreateCall</span><span class="token punctuation">(</span>checkFunc<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>BO<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>通过函数返回进行跳转</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 函数原型：ReturnInst *CreateRet (Value *RetVal, Instruction *InsertBefore = nullptr);</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 接受一个返回值 RetVal，将其作为函数的返回值返回。可选的 InsertBefore 参数允许指定插入该指令的位置，默认为 nullptr，表示在当前插入点处插入。</span></pre></td></tr><tr><td data-num="3"></td><td><pre>builder<span class="token punctuation">.</span><span class="token function">CreateRet</span><span class="token punctuation">(</span>fRemResult<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p>无条件跳转</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 在当前基本块的末尾创建一个无条件跳转指令，使控制流转移到 DestBB 指定的基本块</span></pre></td></tr><tr><td data-num="2"></td><td><pre>builder<span class="token punctuation">.</span><span class="token function">CreateBr</span><span class="token punctuation">(</span>DestBB<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p>条件跳转</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 创建比较指令，比较 sum 和 100.0 的大小</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Value <span class="token operator">*</span>cmp <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">CreateFCmpUGT</span><span class="token punctuation">(</span>sum<span class="token punctuation">,</span> <span class="token class-name">ConstantFP</span><span class="token double-colon punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">APFloat</span><span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 创建条件跳转，完整定义如下：</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// BranchInst *CreateCondBr(Value *Cond, BasicBlock *TrueBB, BasicBlock *FalseBB, Instruction *InsertBefore = nullptr);</span></pre></td></tr><tr><td data-num="5"></td><td><pre>builder<span class="token punctuation">.</span><span class="token function">CreateCondBr</span><span class="token punctuation">(</span>cmp<span class="token punctuation">,</span> TrueBB<span class="token punctuation">,</span> FalseBB<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ol><h2 id="获取更改参数"><a class="anchor" href="#获取更改参数">#</a> 获取 / 更改参数</h2><p>加入我想通过 LLVM C++ API 获取一个 IR 指令的参数以便后续分析、或将其修改为指定值</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 创建一个加法指令</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Instruction <span class="token operator">*</span>AddInst <span class="token operator">=</span> <span class="token class-name">BinaryOperator</span><span class="token double-colon punctuation">::</span><span class="token function">CreateAdd</span><span class="token punctuation">(</span>Operand1<span class="token punctuation">,</span> Operand2<span class="token punctuation">,</span> <span class="token string">"sum"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>Value <span class="token operator">*</span>NewValue <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// 定义一个新的操作数值 NewValue</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 函数原型：void Instruction::setOperand (unsigned index, Value *val);</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//index 表示要设置的操作数的索引，从 0 开始，表示指令的第一个操作数；</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//val 表示要设置的新的操作数值，类型为 Value，可以是常量、变量或其他指令的结果</span></pre></td></tr><tr><td data-num="8"></td><td><pre>AddInst<span class="token operator">-></span><span class="token function">setOperand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> NewValue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将 Add 指令的第一个参数修改为 NewValue</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// 获取第一个操作数 Operand1</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 注意：AddInst 同时也是一个 Value * 类型，表示 add 的计算结果</span></pre></td></tr><tr><td data-num="13"></td><td><pre>AddInst<span class="token operator">-></span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="参考"><a class="anchor" href="#参考">#</a> 参考</h1><ul><li><span class="exturl" data-url="aHR0cHM6Ly9ldmlhbi16aGFuZy5naXRodWIuaW8vbGx2bS1pci10dXRvcmlhbC9pbmRleC5odG1s">https://evian-zhang.github.io/llvm-ir-tutorial/index.html</span></li><li><span class="exturl" data-url="aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xhbmdSZWYuaHRtbA==">https://llvm.org/docs/LangRef.html</span></li><li><span class="exturl" data-url="aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0NvZGluZ1N0YW5kYXJkcy5odG1s">https://llvm.org/docs/CodingStandards.html</span></li></ul><br><div class="tags"><a href="/tags/LLVM/" rel="tag"><i class="ic i-tag"></i> LLVM</a> <a href="/tags/%E6%95%99%E7%A8%8B/" rel="tag"><i class="ic i-tag"></i> 教程</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-03-22 15:43:54" itemprop="dateModified" datetime="2024-03-22T15:43:54+08:00">2024-03-22</time> </span><span id="llvm/llvm-tutorial/" class="item leancloud_visitors" data-flag-title="LLVM 简明教程" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/wechatpay.png" alt="Gality 微信支付"><p>微信支付</p></div><div><img data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/alipay.png" alt="Gality 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Gality <i class="ic i-at"><em>@</em></i>藏器于身</li><li class="link"><strong>本文链接：</strong> <a href="https://gality.cn/llvm/llvm-tutorial/" title="LLVM 简明教程">https://gality.cn/llvm/llvm-tutorial/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/ml/transformer/" itemprop="url" rel="prev" data-background-image="http:&#x2F;&#x2F;imgcdn.gality.cn&#x2F;blog&#x2F;9m7q8s.png" title="Transformer 详解"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 机器学习</span><h3>Transformer 详解</h3></a></div><div class="item right"><a href="/os/kernel/build-kernel/" itemprop="url" rel="next" data-background-image="http:&#x2F;&#x2F;imgcdn.gality.cn&#x2F;blog&#x2F;2023-08-19-wallhaven-yxe85x_2560x1440.png" title="从0开始构建Linux内核"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 内核</span><h3>从0开始构建Linux内核</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#llvm-%E5%AE%89%E8%A3%85%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">LLVM 安装与环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">环境配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#llvm-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">LLVM 基本知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">2.1.</span> <span class="toc-text">基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5"><span class="toc-number">2.1.1.</span> <span class="toc-text">引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.2.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#llvm-ir"><span class="toc-number">2.1.3.</span> <span class="toc-text">LLVM IR</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.</span> <span class="toc-text">基本命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#c-to-irbitcode"><span class="toc-number">2.2.1.</span> <span class="toc-text">C to IR&#x2F;Bitcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cpp-to-irbitcode"><span class="toc-number">2.2.2.</span> <span class="toc-text">CPP to IR&#x2F;Bitcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ccpp-to-execute"><span class="toc-number">2.2.3.</span> <span class="toc-text">C&#x2F;CPP to execute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ir-to-bitcode"><span class="toc-number">2.2.4.</span> <span class="toc-text">IR to Bitcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bitcode-to-ir"><span class="toc-number">2.2.5.</span> <span class="toc-text">Bitcode to IR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#irbicode-to-asm"><span class="toc-number">2.2.6.</span> <span class="toc-text">IR&#x2F;Bicode to asm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#irbicode-to-execute"><span class="toc-number">2.2.7.</span> <span class="toc-text">IR&#x2F;Bicode to execute</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%ACir%E8%AF%AD%E6%B3%95"><span class="toc-number">2.3.</span> <span class="toc-text">基本 IR 语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ir%E7%BB%93%E6%9E%84"><span class="toc-number">2.3.1.</span> <span class="toc-text">IR 结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ir-%E6%8C%87%E4%BB%A4"><span class="toc-number">2.3.2.</span> <span class="toc-text">IR 指令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#llvm-c-api%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="toc-number">3.</span> <span class="toc-text">LLVM C++ API 相关操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%86%99ir%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.</span> <span class="toc-text">读 &#x2F; 写 IR 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%8D%E5%8E%86ir%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.</span> <span class="toc-text">遍历 IR 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%87%BD%E6%95%B0%E5%9F%BA%E6%9C%AC%E5%9D%97%E6%8C%87%E4%BB%A4"><span class="toc-number">3.3.</span> <span class="toc-text">创建函数 &#x2F; 基本块 &#x2F; 指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%B7%B3%E8%BD%AC"><span class="toc-number">3.4.</span> <span class="toc-text">创建跳转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9B%B4%E6%94%B9%E5%8F%82%E6%95%B0"><span class="toc-number">3.5.</span> <span class="toc-text">获取 &#x2F; 更改参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/llvm/llvm-tutorial/" rel="bookmark" title="LLVM 简明教程">LLVM 简明教程</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Gality" data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/avatar.png"><p class="name" itemprop="name">Gality</p><div class="description" itemprop="description">安全杂记 & 日常随感</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">29</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">17</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">43</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dhbGl0eTM2OQ==" title="https:&#x2F;&#x2F;github.com&#x2F;Gality369"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <a href="https://gality.cn/about/" title="https:&#x2F;&#x2F;gality.cn&#x2F;about&#x2F;" class="item about"><i class="ic i-address-card"></i></a> <span class="exturl item email" data-url="bWFpbHRvOjQzNDQwMDcyNkBxcS5jb20=" title="mailto:434400726@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>资源</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/ml/transformer/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/os/kernel/build-kernel/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/note/" title="分类于 学习笔记">学习笔记</a></div><span><a href="/note/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%8D%E4%B9%A0%E8%A6%81%E7%82%B9/" title="网络安全复习要点">网络安全复习要点</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ml/" title="分类于 机器学习">机器学习</a></div><span><a href="/ml/transformer/" title="Transformer 详解">Transformer 详解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/scientific-research/" title="分类于 科研">科研</a> <i class="ic i-angle-right"></i> <a href="/categories/scientific-research/thesis-reading/" title="分类于 论文阅读">论文阅读</a></div><span><a href="/scientific-research/thesis-reading/%20Blockchain%20Imitation%20Game/" title="论文阅读｜ The Blockchain Imitation Game">论文阅读｜ The Blockchain Imitation Game</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/tool-usage/" title="分类于 工具使用">工具使用</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/tool-usage/GDB/" title="分类于 GDB">GDB</a></div><span><a href="/misc/tool-usage/GDB-with-QEMU/" title="GDB+QEMU调试mbr&#x2F;loader">GDB+QEMU调试mbr/loader</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/os/" title="分类于 操作系统">操作系统</a> <i class="ic i-angle-right"></i> <a href="/categories/os/0-1/" title="分类于 从 0 到 1">从 0 到 1</a></div><span><a href="/os/02-mbr/" title="02-从BIOS启动到MBR编写">02-从BIOS启动到MBR编写</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ml/" title="分类于 机器学习">机器学习</a> <i class="ic i-angle-right"></i> <a href="/categories/ml/homework/" title="分类于 作业">作业</a></div><span><a href="/ml/homework/HW-1/" title="李宏毅ML2022-Spring大作业01｜COVID-19 Cases Prediction (Regression)">李宏毅ML2022-Spring大作业01｜COVID-19 Cases Prediction (Regression)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ml/" title="分类于 机器学习">机器学习</a></div><span><a href="/ml/CNN/" title="CNN | Network Architecture Designed for Image">CNN | Network Architecture Designed for Image</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a></div><span><a href="/misc/Polar-code-&-channel-polarization%20copy/" title="Polar code &amp; channel polarization">Polar code & channel polarization</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a></div><span><a href="/misc/Monte-Carlo-method/" title="数理统计大作业 ｜ Monte Carlo方法">数理统计大作业 ｜ Monte Carlo方法</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ponder/" title="分类于 思考与沉淀">思考与沉淀</a></div><span><a href="/ponder/Gresham-law/" title="劣币驱逐良币 ｜ 一次网购经历的反思">劣币驱逐良币 ｜ 一次网购经历的反思</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Gality @ Samadhi</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">182k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">5:32</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"llvm/llvm-tutorial/",favicon:{show:"（●´3｀●）哎呀呀～",hide:"(´Д｀)吓死你"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/js/app.js?v=0.2.5"></script></body></html>