<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="KbCOz5IFs80bU-psVUCv9C7SOLzVWto8d7_5ZSsX7I0"><meta name="baidu-site-verification" content="codeva-KcLqIZYGXd"><link rel="alternate" type="application/rss+xml" title="藏器于身" href="https://gality.cn/rss.xml"><link rel="alternate" type="application/atom+xml" title="藏器于身" href="https://gality.cn/atom.xml"><link rel="alternate" type="application/json" title="藏器于身" href="https://gality.cn/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/css/app.css?v=0.2.5"><meta name="keywords" content="Btrfs,ioctl,文档,解释,说明"><link rel="canonical" href="https://gality.cn/os/fs/Btrfs_ioctl/"><title>Btrfs ioctl 手册 - 文件系统 - 操作系统 | Samadhi = 藏器于身 = 待时而动</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Btrfs ioctl 手册</h1><div class="meta"><span class="item" title="创建时间：2025-04-11 10:25:11"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2025-04-11T10:25:11+08:00">2025-04-11</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>45k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>1:22</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Samadhi</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="http://imgcdn.gality.cn/blog/u2vn85.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/7zx56a.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/hlzx1w.png"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/3ywxuv.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/2nb6y8.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/unmgmb.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/os/" itemprop="item" rel="index" title="分类于 操作系统"><span itemprop="name">操作系统</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/os/fs/" itemprop="item" rel="index" title="分类于 文件系统"><span itemprop="name">文件系统</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://gality.cn/os/fs/Btrfs_ioctl/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/avatar.png"><meta itemprop="name" content="Gality"><meta itemprop="description" content="待时而动, 安全杂记 & 日常随感"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="藏器于身"></span><div class="body md" itemprop="articleBody"><div class="note info"><p>本篇文章主要内容来自 btrfs 文件系统的 ioctl 的<span class="exturl" data-url="aHR0cHM6Ly9idHJmcy5yZWFkdGhlZG9jcy5pby9lbi9sYXRlc3QvYnRyZnMtaW9jdGwuaHRtbA==">官方接口文档</span>，并在原文档的基础上，结合 Btrfs 内核代码的实现，补充了很多原文档缺失的内容，我愿称之为<mark> btrfs-ioctl (2) plus</mark>。</p></div><div class="note warning"><p>⚠️请注意， <code>ioctl</code> 的数量、含义和定义会随着时间改变，本文内容参考了 Linux v6.13.7 版本的代码，完稿时间为 2025 年 4 月 11 日，如果时间相差很远的话请自行验证文章内容的正确性。同时，由于笔者水平有限，如果有任何错误，恳请指正 Orz。</p></div><h1 id="速览"><a class="anchor" href="#速览">#</a> 速览</h1><table><thead><tr><th>名字</th><th>描述</th><th>数据结构（参数）</th></tr></thead><tbody><tr><td><span class="exturl" data-url="aHR0cHM6Ly9idHJmcy5yZWFkdGhlZG9jcy5pby9lbi9sYXRlc3QvYnRyZnMtaW9jdGwuaHRtbCNidHJmcy1pb2Mtc25hcC1jcmVhdGU=">BTRFS_IOC_SNAP_CREATE</span></td><td><s>创建子卷快照</s>（已过时，被<a href="#btrfs_ioc_snap_create_v2"> BTRFS_IOC_SNAP_CREATE_V2</a> 代替）</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td><a href="#btrfs_ioc_defrag">BTRFS_IOC_DEFRAG</a></td><td>对文件或目录执行碎片整理</td><td>NULL</td></tr><tr><td><a href="#btrfs_ioc_defrag_range">BTRFS_IOC_DEFRAG_RANGE</a></td><td>对文件或目录执行碎片整理</td><td><a href="#btrfs_ioctl_defrag_range_args">struct btrfs_ioctl_defrag_range_args</a></td></tr><tr><td><a href="#btrfs_ioc_resize">BTRFS_IOC_RESIZE</a></td><td>调整 Btrfs 设备的容量大小</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td><a href="#btrfs_ioc_scan_dev">BTRFS_IOC_SCAN_DEV</a></td><td>扫描指定设备路径并将其注册到文件系统模块中</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td><a href="#btrfs_ioc_sync">BTRFS_IOC_SYNC</a></td><td>同步文件系统，可能处理排队等待的工作</td><td>NULL</td></tr><tr><td><a href="#btrfs_ioc_clone">BTRFS_IOC_CLONE</a></td><td><s>克隆</s>（已废弃，被 VFS 的 FICLONE 代替）</td><td>int</td></tr><tr><td><a href="#btrfs_ioc_clone_range">BTRFS_IOC_CLONE_RANGE</a></td><td><s>指定范围克隆</s>（已废弃，被 VFS 的 FICLONERANGE 代替）</td><td><a href="#btrfs_ioctl_clone_range_args">struct btrfs_ioctl_clone_range_args</a></td></tr><tr><td><a href="#btrfs_ioc_file_extent_same">BTRFS_IOC_FILE_EXTENT_SAME</a></td><td><s>在多个文件中共享数据，即清除重复数据</s>（已废弃，被 VFS 的 FIDEDUPERANGE 代替）</td><td><a href="#btrfs_ioctl_same_args">struct btrfs_ioctl_same_args</a></td></tr><tr><td><a href="#btrfs_ioc_add_dev">BTRFS_IOC_ADD_DEV</a></td><td>按路径将设备添加到文件系统中</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td><a href="#btrfs_ioc_rm_dev">BTRFS_IOC_RM_DEV</a></td><td><s>按路径从文件系统中删除一个设备</s>（已过时， 被 <a href="#btrfs_ioc_rm_dev_v2">BTRFS_IOC_RM_DEV_V2</a> 代替）</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td>BTRFS_IOC_BALANCE</td><td><s>平衡操作</s>（已废弃，被 <a href="#btrfs_ioc_balance_v2">BTRFS_IOC_BALANCE_V2</a> 和 <a href="#btrfs_ioc_balance_ctl">BTRFS_IOC_BALANCE_CTL</a> 代替）</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td><span class="exturl" data-url="aHR0cHM6Ly9idHJmcy5yZWFkdGhlZG9jcy5pby9lbi9sYXRlc3QvYnRyZnMtaW9jdGwuaHRtbCNidHJmcy1pb2Mtc3Vidm9sLWNyZWF0ZQ==">BTRFS_IOC_SUBVOL_CREATE</span></td><td><s>创建一个子卷</s>（已过时，被 <a href="#btrfs_ioc_subvol_create_v2">BTRFS_IOC_SUBVOL_CREATE_V2</a> 代替）</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td><span class="exturl" data-url="aHR0cHM6Ly9idHJmcy5yZWFkdGhlZG9jcy5pby9lbi9sYXRlc3QvYnRyZnMtaW9jdGwuaHRtbCNidHJmcy1pb2Mtc25hcC1kZXN0cm95">BTRFS_IOC_SNAP_DESTROY</span></td><td><s>删除一个子卷</s>（已过时，被 <a href="#btrfs_ioc_snap_destroy_v2">BTRFS_IOC_SNAP_DESTROY_V2 </a>代替）</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td><a href="#btrfs_ioc_tree_search">BTRFS_IOC_TREE_SEARCH</a></td><td><s>查询 Btrfs 树中的结构信息</s>（已过时，被 <a href="#btrfs_ioc_tree_search_v2">BTRFS_IOC_TREE_SEARCH_V2</a> 代替）</td><td><a href="#btrfs_ioctl_search_args">struct btrfs_ioctl_search_args</a></td></tr><tr><td><a href="#btrfs_ioc_ino_lookup">BTRFS_IOC_INO_LOOKUP</a></td><td>将 inode 编号解析为路径，或查找其所在的子卷 ID</td><td><a href="#btrfs_ioctl_ino_lookup_args">struct btrfs_ioctl_ino_lookup_args</a></td></tr><tr><td><a href="#btrfs_ioc_default_subvol">BTRFS_IOC_DEFAULT_SUBVOL</a></td><td>设置默认子卷 ID</td><td>uint64_t</td></tr><tr><td><a href="#btrfs_ioc_space_info">BTRFS_IOC_SPACE_INFO</a></td><td>查询磁盘空间使用情况</td><td><a href="#btrfs_ioctl_space_args">struct btrfs_ioctl_space_args</a></td></tr><tr><td><a href="#btrfs_ioc_start_sync">BTRFS_IOC_START_SYNC</a></td><td>强制触发一次子卷的事务提交</td><td>uint64_t</td></tr><tr><td><a href="#btrfs_ioc_wait_sync">BTRFS_IOC_WAIT_SYNC</a></td><td>等待指定的事务提交完成</td><td>uint64_t</td></tr><tr><td><a href="#btrfs_ioc_snap_create_v2">BTRFS_IOC_SNAP_CREATE_V2</a></td><td>创建一个子卷快照</td><td><a href="#btrfs_ioctl_vol_args_v2">struct btrfs_ioctl_vol_args_v2</a></td></tr><tr><td><a href="#btrfs_ioc_subvol_create_v2">BTRFS_IOC_SUBVOL_CREATE_V2</a></td><td>创建一个子卷</td><td><a href="#btrfs_ioctl_vol_args_v2">struct btrfs_ioctl_vol_args_v2</a></td></tr><tr><td><a href="#btrfs_ioc_tree_search_v2">BTRFS_IOC_TREE_SEARCH_V2</a></td><td>查询 Btrfs 树中的结构信息</td><td><a href="#btrfs_ioctl_search_args_v2">struct btrfs_ioctl_search_args_v2</a></td></tr><tr><td><a href="#btrfs_ioc_subvol_getflags">BTRFS_IOC_SUBVOL_GETFLAGS</a></td><td>获取子卷的 flags</td><td>uint64_t</td></tr><tr><td><a href="#btrfs_ioc_subvol_setflags">BTRFS_IOC_SUBVOL_SETFLAGS</a></td><td>设置子卷的 flags</td><td>uint64_t</td></tr><tr><td><a href="#btrfs_ioc_scrub">BTRFS_IOC_SCRUB</a></td><td>对一个 Btrfs 设备进行校验和修复操作</td><td><a href="#btrfs_ioctl_scrub_args">struct btrfs_ioctl_scrub_args</a></td></tr><tr><td><a href="#btrfs_ioc_scrub_cancel">BTRFS_IOC_SCRUB_CANCEL</a></td><td>取消正在运行的 scrub 操作</td><td>NULL</td></tr><tr><td><a href="#btrfs_ioc_scrub_progress">BTRFS_IOC_SCRUB_PROGRESS</a></td><td>获取 scrub 进度信息</td><td><a href="#btrfs_ioctl_scrub_args">struct btrfs_ioctl_scrub_args</a></td></tr><tr><td><a href="#btrfs_ioc_dev_info">BTRFS_IOC_DEV_INFO</a></td><td>获取指定 Btrfs 设备的基本信息</td><td><a href="#btrfs_ioctl_dev_info_args">struct btrfs_ioctl_dev_info_args</a></td></tr><tr><td><a href="#btrfs_ioc_fs_info">BTRFS_IOC_FS_INFO</a></td><td>获取文件系统信息（设备数、fsid、...）</td><td><a href="#btrfs_ioctl_fs_info_args">struct btrfs_ioctl_fs_info_args</a></td></tr><tr><td><a href="#btrfs_ioc_balance_v2">BTRFS_IOC_BALANCE_V2</a></td><td>触发或恢复一次平衡（balance）操作</td><td><a href="#btrfs_ioctl_balance_args">struct btrfs_ioctl_balance_args</a></td></tr><tr><td><a href="#btrfs_ioc_balance_ctl">BTRFS_IOC_BALANCE_CTL</a></td><td>控制当前平衡（balance）操作</td><td>int</td></tr><tr><td><a href="#btrfs_ioc_balance_progress">BTRFS_IOC_BALANCE_PROGRESS</a></td><td>获取当前 balance 操作的进度</td><td><a href="#btrfs_ioctl_balance_args">struct btrfs_ioctl_balance_args</a></td></tr><tr><td><a href="#btrfs_ioc_ino_paths">BTRFS_IOC_INO_PATHS</a></td><td>查找 inode 在文件系统中的所有路径</td><td><a href="#btrfs_ioctl_ino_path_args">struct btrfs_ioctl_ino_path_args</a></td></tr><tr><td><a href="#btrfs_ioc_logical_ino">BTRFS_IOC_LOGICAL_INO</a></td><td>根据逻辑地址查询用到该地址的 inode</td><td><a href="#btrfs_ioctl_logical_ino_args">struct btrfs_ioctl_logical_ino_args</a></td></tr><tr><td><a href="#btrfs_ioc_set_received_subvol">BTRFS_IOC_SET_RECEIVED_SUBVOL</a></td><td>设置子卷的 “接收元信息”</td><td><a href="#btrfs_ioctl_received_subvol_args">struct btrfs_ioctl_received_subvol_args</a></td></tr><tr><td><a href="#btrfs_ioc_send">BTRFS_IOC_SEND</a></td><td>发送子卷快照</td><td><a href="#btrfs_ioctl_send_args">struct btrfs_ioctl_send_args</a></td></tr><tr><td><a href="#btrfs_ioc_devices_ready">BTRFS_IOC_DEVICES_READY</a></td><td>检查设备是否准备就绪</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td><a href="#btrfs_ioc_quota_ctl">BTRFS_IOC_QUOTA_CTL</a></td><td>控制配额（quota）开启或关闭</td><td><a href="#btrfs_ioctl_quota_ctl_args">struct btrfs_ioctl_quota_ctl_args</a></td></tr><tr><td><a href="#btrfs_ioc_qgroup_assign">BTRFS_IOC_QGROUP_ASSIGN</a></td><td>管理配额组间关系</td><td><a href="#btrfs_ioctl_qgroup_assign_args">struct btrfs_ioctl_qgroup_assign_args</a></td></tr><tr><td><a href="#btrfs_ioc_qgroup_create">BTRFS_IOC_QGROUP_CREATE</a></td><td>创建或删除一个配额组</td><td><a href="#btrfs_ioctl_qgroup_create_args">struct btrfs_ioctl_qgroup_create_args</a></td></tr><tr><td><a href="#btrfs_ioc_qgroup_limit">BTRFS_IOC_QGROUP_LIMIT</a></td><td>为某个 qgroup（配额组 设置配额限制</td><td><a href="#btrfs_ioctl_qgroup_limit_args">struct btrfs_ioctl_qgroup_limit_args</a></td></tr><tr><td><a href="#btrfs_ioc_quota_rescan">BTRFS_IOC_QUOTA_RESCAN</a></td><td>对整个文件系统重新扫描以更新 qgroup（配额组）信息</td><td><a href="#btrfs_ioctl_quota_rescan_args">struct btrfs_ioctl_quota_rescan_args</a></td></tr><tr><td><a href="#btrfs_ioc_quota_rescan_status">BTRFS_IOC_QUOTA_RESCAN_STATUS</a></td><td>返回当前的 qgroup rescan（重新扫描）状态</td><td><a href="#btrfs_ioctl_quota_rescan_args">struct btrfs_ioctl_quota_rescan_args</a></td></tr><tr><td><a href="#btrfs_ioc_quota_rescan_wait">BTRFS_IOC_QUOTA_RESCAN_WAIT</a></td><td>等待当前 qgroup rescan（重新扫描）完成</td><td>NULL</td></tr><tr><td><a href="#btrfs_ioc_get_fslabel">BTRFS_IOC_GET_FSLABEL</a></td><td>读取文件系统标签（BTRFS_LABEL_SIZE=256）</td><td>char buffer[BTRFS_LABEL_SIZE]</td></tr><tr><td><a href="#btrfs_ioc_set_fslabel">BTRFS_IOC_SET_FSLABEL</a></td><td>设置文件系统标签（BTRFS_LABEL_SIZE=256）</td><td>char buffer[BTRFS_LABEL_SIZE]</td></tr><tr><td><a href="#btrfs_ioc_get_dev_stats">BTRFS_IOC_GET_DEV_STATS</a></td><td>获取块设备（device）的各项信息</td><td><a href="#btrfs_ioctl_get_dev_stats">struct btrfs_ioctl_get_dev_stats</a></td></tr><tr><td><a href="#btrfs_ioc_dev_replace_">BTRFS_IOC_DEV_REPLACE</a></td><td>进行设备替换（device replace）</td><td><a href="#btrfs_ioctl_dev_replace_args">struct btrfs_ioctl_dev_replace_args</a></td></tr><tr><td><a href="#btrfs_ioc_get_features">BTRFS_IOC_GET_FEATURES</a></td><td>获取当前挂载文件系统支持的特性（feature) 标志</td><td><a href="#btrfs_ioctl_feature_flags">struct btrfs_ioctl_feature_flags</a></td></tr><tr><td><a href="#btrfs_ioc_set_features">BTRFS_IOC_SET_FEATURES</a></td><td>设置文件系统特性（features）标志</td><td><a href="#btrfs_ioctl_feature_flags">struct btrfs_ioctl_feature_flags</a>[2]</td></tr><tr><td><a href="#btrfs_ioc_get_supported_features">BTRFS_IOC_GET_SUPPORTED_FEATURES</a></td><td>获取当前内核支持的文件系统特性（features）标志</td><td><a href="#btrfs_ioctl_feature_flags">struct btrfs_ioctl_feature_flags</a>[3]</td></tr><tr><td><a href="#btrfs_ioc_rm_dev_v2">BTRFS_IOC_RM_DEV_V2</a></td><td>从文件系统中删除一个设备</td><td><a href="#btrfs_ioctl_vol_args_v2">struct btrfs_ioctl_vol_args_v2</a></td></tr><tr><td><a href="#btrfs_ioc_logical_ino_v2">BTRFS_IOC_LOGICAL_INO_V2</a></td><td>根据逻辑地址查询用到该地址的 inode</td><td><a href="#btrfs_ioctl_logical_ino_args">struct btrfs_ioctl_logical_ino_args</a></td></tr><tr><td><a href="#btrfs_ioc_get_subvol_info">BTRFS_IOC_GET_SUBVOL_INFO</a></td><td>获取一个子卷的信息</td><td><a href="#btrfs_ioctl_get_subvol_info_args">struct btrfs_ioctl_get_subvol_info_args</a></td></tr><tr><td><a href="#btrfs_ioc_get_subvol_rootref">BTRFS_IOC_GET_SUBVOL_ROOTREF</a></td><td>查询子卷的 <code>ROOTREF</code> 信息</td><td><a href="#btrfs_ioctl_get_subvol_rootref_args">struct btrfs_ioctl_get_subvol_rootref_args</a></td></tr><tr><td><a href="#btrfs_ioc_ino_lookup_user">BTRFS_IOC_INO_LOOKUP_USER</a></td><td>获取 inode 的路径信息</td><td><a href="#btrfs_ioctl_ino_lookup_user_args">struct btrfs_ioctl_ino_lookup_user_args</a></td></tr><tr><td><a href="#btrfs_ioc_snap_destroy_v2">BTRFS_IOC_SNAP_DESTROY_V2</a></td><td>删除一个子卷的快照或普通子卷</td><td><a href="#btrfs_ioctl_vol_args_v2">struct btrfs_ioctl_vol_args_v2</a></td></tr><tr><td><a href="#btrfs_ioc_encoded_read">BTRFS_IOC_ENCODED_READ</a></td><td>读取文件的原始内容，绕过文件系统的编码</td><td><a href="#btrfs_ioctl_encoded_io_args">struct btrfs_ioctl_encoded_io_args</a></td></tr><tr><td><a href="#btrfs_ioc_encoded_write">BTRFS_IOC_ENCODED_WRITE</a></td><td>向文件直接写入原始内容，绕过文件系统编码</td><td><a href="#btrfs_ioctl_encoded_io_args">struct btrfs_ioctl_encoded_io_args</a></td></tr><tr><td><a href="#btrfs_ioc_subvol_sync_wait">BTRFS_IOC_SUBVOL_SYNC_WAIT</a></td><td>用于等待某个已删除子卷被系统彻底清理，或者用于查询其当前清理状态</td><td><a href="#btrfs_ioctl_subvol_wait">struct btrfs_ioctl_subvol_wait</a></td></tr></tbody></table><h1 id="数据结构与定义"><a class="anchor" href="#数据结构与定义">#</a> 数据结构与定义</h1><h2 id="btrfs_ioctl_vol_args"><a class="anchor" href="#btrfs_ioctl_vol_args">#</a> btrfs_ioctl_vol_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* this should be 4k */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_PATH_NAME_MAX</span> <span class="token expression"><span class="token number">4087</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_vol_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__s64 fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">char</span> name<span class="token punctuation">[</span>BTRFS_PATH_NAME_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_vol_args_v2"><a class="anchor" href="#btrfs_ioctl_vol_args_v2">#</a> btrfs_ioctl_vol_args_v2</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SUBVOL_RDONLY</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SUBVOL_QGROUP_INHERIT</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_DEVICE_SPEC_BY_ID</span>              <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SUBVOL_SPEC_BY_ID</span>              <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SUBVOL_NAME_MAX</span> 		         <span class="token expression"><span class="token number">4039</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_vol_args_v2</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	__s64 fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	__u64 transid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	__u64 flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">union</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			__u64 size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token keyword">struct</span> <span class="token class-name">btrfs_qgroup_inherit</span> __user <span class="token operator">*</span>qgroup_inherit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		__u64 unused<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">union</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token keyword">char</span> name<span class="token punctuation">[</span>BTRFS_SUBVOL_NAME_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		__u64 devid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		__u64 subvolid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QGROUP_INHERIT_SET_LIMITS</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_qgroup_inherit</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u64	flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u64	num_qgroups<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u64	num_ref_copies<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__u64	num_excl_copies<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_qgroup_limit</span> lim<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	__u64	qgroups<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QGROUP_LIMIT_MAX_RFER</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QGROUP_LIMIT_MAX_EXCL</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QGROUP_LIMIT_RSV_RFER</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QGROUP_LIMIT_RSV_EXCL</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QGROUP_LIMIT_RFER_CMPR</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QGROUP_LIMIT_EXCL_CMPR</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_qgroup_limit</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	__u64	flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	__u64	max_rfer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	__u64	max_excl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	__u64	rsv_rfer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	__u64	rsv_excl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_get_subvol_info_args"><a class="anchor" href="#btrfs_ioctl_get_subvol_info_args">#</a> btrfs_ioctl_get_subvol_info_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_VOL_NAME_MAX</span> <span class="token expression"><span class="token number">255</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_UUID_SIZE</span> <span class="token expression"><span class="token number">16</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_get_subvol_info_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    __u64 treeid<span class="token punctuation">;</span>          <span class="token comment">/* 此子卷的 ID */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">char</span> name<span class="token punctuation">[</span>BTRFS_VOL_NAME_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* 子卷名称，用于获取挂载点的真实名称 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    __u64 parent_id<span class="token punctuation">;</span>       <span class="token comment">/* 包含此子卷的父卷 ID，顶层子卷或已删除子卷为 0 */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    __u64 dirid<span class="token punctuation">;</span>           <span class="token comment">/* 包含此子卷的目录的 inode 号，顶层子卷或已删除子卷为 0 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    __u64 generation<span class="token punctuation">;</span>      <span class="token comment">/* 子卷的最新事务 ID */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    __u64 flags<span class="token punctuation">;</span>           <span class="token comment">/* 子卷标志 */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    __u8 uuid<span class="token punctuation">[</span>BTRFS_UUID_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">/* 子卷 UUID */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    __u8 parent_uuid<span class="token punctuation">[</span>BTRFS_UUID_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* 如果当前子卷是某个子卷的快照，就保存那个原始子卷的 UUID。否则为全 0。 */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    __u8 received_uuid<span class="token punctuation">[</span>BTRFS_UUID_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* 如果这个子卷是通过 btrfs receive 创建的，这里记录 “发送方的源子卷 UUID”。否则全为 0 */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    </pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/* 创建 / 修改 / 发送 / 接收操作的事务 ID */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    __u64 ctransid<span class="token punctuation">;</span>        </pre></td></tr><tr><td data-num="17"></td><td><pre>    __u64 otransid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    __u64 stransid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    __u64 rtransid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/* 对应 c/o/s/rtransid 的时间 */</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_timespec</span> ctime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_timespec</span> otime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_timespec</span> stime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_timespec</span> rtime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    __u64 reserved<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">/* 必须为 0 */</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_timespec</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	__u64 sec<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u32 nsec<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_received_subvol_args"><a class="anchor" href="#btrfs_ioctl_received_subvol_args">#</a> btrfs_ioctl_received_subvol_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_UUID_SIZE</span> <span class="token expression"><span class="token number">16</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_received_subvol_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">char</span>	uuid<span class="token punctuation">[</span>BTRFS_UUID_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u64	stransid<span class="token punctuation">;</span>		<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__u64	rtransid<span class="token punctuation">;</span>		<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_timespec</span> stime<span class="token punctuation">;</span> <span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_timespec</span> rtime<span class="token punctuation">;</span> <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	__u64	flags<span class="token punctuation">;</span>			<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	__u64	reserved<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参见<a href="#btrfs_ioctl_get_subvol_info_args"> struct btrfs_ioctl_timespec</a></p><h2 id="btrfs_ioctl_fs_info_args"><a class="anchor" href="#btrfs_ioctl_fs_info_args">#</a> btrfs_ioctl_fs_info_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* 请求校验和类型和大小信息 */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FS_INFO_FLAG_CSUM_INFO</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token number">1U</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> </span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/* 请求文件系统代际（generation）信息 */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FS_INFO_FLAG_GENERATION</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token number">1U</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> </span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/* 请求文件系统元数据 UUID */</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FS_INFO_FLAG_METADATA_UUID</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token number">1U</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> </span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FSID_SIZE</span> <span class="token expression"><span class="token number">16</span></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_fs_info_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    __u64 max_id<span class="token punctuation">;</span>           <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    __u64 num_devices<span class="token punctuation">;</span>      <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    __u8 fsid<span class="token punctuation">[</span>BTRFS_FSID_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    __u32 nodesize<span class="token punctuation">;</span>         <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    __u32 sectorsize<span class="token punctuation">;</span>       <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    __u32 clone_alignment<span class="token punctuation">;</span>  <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    __u16 csum_type<span class="token punctuation">;</span>        <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    __u16 csum_size<span class="token punctuation">;</span>        <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    __u64 flags<span class="token punctuation">;</span>            <span class="token comment">/* 输入 / 输出 */</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    __u64 generation<span class="token punctuation">;</span>       <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    __u8 metadata_uuid<span class="token punctuation">[</span>BTRFS_FSID_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    __u8 reserved<span class="token punctuation">[</span><span class="token number">944</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">/* 填充至 1KB */</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_ino_lookup_args"><a class="anchor" href="#btrfs_ioctl_ino_lookup_args">#</a> btrfs_ioctl_ino_lookup_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_INO_LOOKUP_PATH_MAX</span>               <span class="token expression"><span class="token number">4080</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_ino_lookup_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        __u64 treeid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        __u64 objectid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">char</span> name<span class="token punctuation">[</span>BTRFS_INO_LOOKUP_PATH_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_subvol_wait"><a class="anchor" href="#btrfs_ioctl_subvol_wait">#</a> btrfs_ioctl_subvol_wait</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* 等待指定的 subvolid 删除完成（清理结束） */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SUBVOL_SYNC_WAIT_FOR_ONE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> </span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/* 等待所有队列中的子卷清除完成 */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SUBVOL_SYNC_WAIT_FOR_QUEUED</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> </span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/* 统计队列中的子卷数 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SUBVOL_SYNC_COUNT</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> </span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/* 读取清理队列中第一个子卷 ID（即 " 正在清理” 或 “马上要清理” 的那个）（若为空则为 0） */</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SUBVOL_SYNC_PEEK_FIRST</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> </span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/* 查看队列中的最后一个子卷 ID（若为空则为 0） */</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SUBVOL_SYNC_PEEK_LAST</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> </span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_subvol_wait</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    __u64 subvolid<span class="token punctuation">;</span> <span class="token comment">/* 子卷（包括快照）的唯一 ID */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    __u32 mode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    __u32 count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_clone_range_args"><a class="anchor" href="#btrfs_ioctl_clone_range_args">#</a> btrfs_ioctl_clone_range_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* 如果把 src_length 设置为 0，那就表示 “从 src_offset 开始，一直到源文件结尾 (EOF) 的内容都会被克隆”。 */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_clone_range_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__s64 src_fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u64 src_offset<span class="token punctuation">,</span> src_length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u64 dest_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_defrag_range_args"><a class="anchor" href="#btrfs_ioctl_defrag_range_args">#</a> btrfs_ioctl_defrag_range_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"> * 用于碎片整理区间 ioctl 的标志定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"> * 使用于：</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"> * struct btrfs_ioctl_defrag_range_args.flags</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_DEFRAG_RANGE_COMPRESS</span> <span class="token expression"><span class="token number">1</span>       </span><span class="token comment">// 开启压缩功能</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_DEFRAG_RANGE_START_IO</span> <span class="token expression"><span class="token number">2</span>       </span><span class="token comment">// 启动 I/O 操作</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_DEFRAG_RANGE_FLAGS_SUPP</span>	<span class="token expression"><span class="token punctuation">(</span>BTRFS_DEFRAG_RANGE_COMPRESS <span class="token operator">|</span>		</span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>					 <span class="token expression">BTRFS_DEFRAG_RANGE_START_IO<span class="token punctuation">)</span>  </span><span class="token comment">// 支持的标志位（压缩 + 启动 IO）</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_defrag_range_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token comment">/* 碎片整理操作的起始位置 */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	__u64 start<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token comment">/* 要整理的字节数，使用 (u64)-1 表示 “整理全部” */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	__u64 len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token comment">/* 操作标志，可以用来开启本次整理中的压缩功能 */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	__u64 flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token comment">/* 任何大于该值的 extent（连续块）会被认为已经整理过。*/</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token comment">/* 使用 0 表示使用内核默认值；*/</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token comment">/* 使用 1 表示每一个 extent 都必须被重写。*/</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	__u32 extent_thresh<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token comment">/* 如果开启压缩，本字段用于指定使用哪种压缩方法。*/</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token comment">/* 如果未指定，默认使用 zlib。*/</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	__u32 compress_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token comment">/* 保留字段，供将来使用 */</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	__u32 unused<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_search_args"><a class="anchor" href="#btrfs_ioctl_search_args">#</a> btrfs_ioctl_search_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SEARCH_ARGS_BUFSIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">4096</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_search_key</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/* buf 是一个由多个搜索头（search header）组成的数组，*/</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">/* 每个头部后面紧跟着实际的 item（项目）。*/</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/* 为了对齐（alignment），type 字段被扩展为 32 位。*/</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_search_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_search_key</span> key<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BTRFS_SEARCH_ARGS_BUFSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Btrfs SEARCH ioctl 系列命令的搜索条件 */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_search_key</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">	 * 要搜索的树 ID。1 表示 “树根树”，2 表示 “extent 树”，等等……</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">	 * 如果 tree_id 设置为特殊值 0，则会在传递给 ioctl 的 inode 所在的子卷树中进行搜索。</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	__u64 tree_id<span class="token punctuation">;</span>		<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">	 * 执行树搜索时，实际上是从一个 136 位线性搜索空间中取出一个区间。</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">	 * 一个完整的 136 位树键（tree key）格式如下：</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">	 *   (objectid &lt;&lt; 72) + (type &lt;&lt; 64) + offset</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">	 * 对 objectid、type 和 offset 的最小值和最大值定义了搜索区间的</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">	 * min_key 到 max_key 范围。所有落在该范围 [min_key, max_key]</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">	 * 内的元数据项（metadata item）将会被返回。</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">	 * 另外，也可以通过指定事务 ID 范围（transid）来过滤返回的项，这些 ID</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">	 * 表示这些元数据块最后一次被写入时所属的事务（COW 操作后的写入）。</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">	 * 需要注意的是，这个事务 ID 只是说明该元数据页最近一次被写入的事务，</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">	 * 并不代表某个具体 item 是在哪个事务中创建或修改的。</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	__u64 min_objectid<span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	__u64 max_objectid<span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	__u64 min_offset<span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	__u64 max_offset<span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	__u64 min_transid<span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	__u64 max_transid<span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	__u32 min_type<span class="token punctuation">;</span>		<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	__u32 max_type<span class="token punctuation">;</span>		<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">	 * 输入：期望返回的最大 item 数量；</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">	 * 输出：实际返回的 item 数量，受以下限制之一：</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">	 *  - 达到搜索范围的上限；</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">	 *  - 达到输入指定的 nr_items 数量；</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">	 *  - 填满了提供的内存缓冲区。</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	__u32 nr_items<span class="token punctuation">;</span>		<span class="token comment">/* 输入 / 输出 */</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>	<span class="token comment">/* 为对齐到 64 位而保留 */</span></pre></td></tr><tr><td data-num="44"></td><td><pre>	__u32 unused<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>	<span class="token comment">/* 保留字段，用于将来扩展 */</span></pre></td></tr><tr><td data-num="47"></td><td><pre>	__u64 unused1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	__u64 unused2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>	__u64 unused3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>	__u64 unused4<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_search_args_v2"><a class="anchor" href="#btrfs_ioctl_search_args_v2">#</a> btrfs_ioctl_search_args_v2</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"> * TREE_SEARCH ioctl 的扩展版本，允许返回超过 4KB 的数据。</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"> * 通过 buf_size 指定缓冲区的分配大小。</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_search_args_v2</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_search_key</span> key<span class="token punctuation">;</span> <span class="token comment">/* 输入 / 输出 - 搜索参数 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	__u64 buf_size<span class="token punctuation">;</span>           <span class="token comment">/* 输入 - 缓冲区大小</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">	                           * 输出 - 若返回 EOVERFLOW: 表示存储所有 item 所需的大小 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	__u64 buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">/* 输出 - 搜索到的条目 */</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>见 <a href="#btrfs_ioctl_search_args">btrfs_ioctl_search_key</a></p><h2 id="btrfs_ioctl_space_args"><a class="anchor" href="#btrfs_ioctl_space_args">#</a> btrfs_ioctl_space_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_space_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	__u64 space_slots<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u64 total_spaces<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_space_info</span> spaces<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_space_info</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	__u64 flags<span class="token punctuation">;</span> <span class="token comment">//flags 代表不同空间类型，参考下面的代码块</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u64 total_bytes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u64 used_bytes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* different types of block groups (and chunks) */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_DATA</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_SYSTEM</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_METADATA</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_RAID0</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_RAID1</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_DUP</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_RAID10</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_RAID5</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_RAID6</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_RAID1C3</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_RAID1C4</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_RESERVED</span>	<span class="token expression"><span class="token punctuation">(</span>BTRFS_AVAIL_ALLOC_BIT_SINGLE <span class="token operator">|</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>					 <span class="token expression">BTRFS_SPACE_INFO_GLOBAL_RSV<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_TYPE_MASK</span>	<span class="token expression"><span class="token punctuation">(</span>BTRFS_BLOCK_GROUP_DATA <span class="token operator">|</span>    </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_SYSTEM <span class="token operator">|</span>  </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="18"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_METADATA<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_PROFILE_MASK</span>	<span class="token expression"><span class="token punctuation">(</span>BTRFS_BLOCK_GROUP_RAID0 <span class="token operator">|</span>   </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_RAID1 <span class="token operator">|</span>   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="22"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_RAID1C3 <span class="token operator">|</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="23"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_RAID1C4 <span class="token operator">|</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="24"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_RAID5 <span class="token operator">|</span>   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="25"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_RAID6 <span class="token operator">|</span>   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="26"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_DUP <span class="token operator">|</span>     </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="27"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_RAID10<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_RAID56_MASK</span>	<span class="token expression"><span class="token punctuation">(</span>BTRFS_BLOCK_GROUP_RAID5 <span class="token operator">|</span>   </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_RAID6<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BLOCK_GROUP_RAID1_MASK</span>	<span class="token expression"><span class="token punctuation">(</span>BTRFS_BLOCK_GROUP_RAID1 <span class="token operator">|</span>   </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_RAID1C3 <span class="token operator">|</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="33"></td><td><pre>					 <span class="token expression">BTRFS_BLOCK_GROUP_RAID1C4<span class="token punctuation">)</span></span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_scrub_args"><a class="anchor" href="#btrfs_ioctl_scrub_args">#</a> btrfs_ioctl_scrub_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SCRUB_READONLY</span>	<span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SCRUB_SUPPORTED_FLAGS</span>	<span class="token expression"><span class="token punctuation">(</span>BTRFS_SCRUB_READONLY<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_scrub_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u64 devid<span class="token punctuation">;</span>				<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u64 start<span class="token punctuation">;</span>				<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__u64 end<span class="token punctuation">;</span>				<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	__u64 flags<span class="token punctuation">;</span>				<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_scrub_progress</span> progress<span class="token punctuation">;</span>	<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token comment">/* 填充到 1K */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	__u64 unused<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">btrfs_scrub_progress</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"> * 向用户空间报告错误和进度的结构体，用于以下几种情况：</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"> * - scrub（校验 / 清理）操作完成后</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"> * - scrub 操作被取消时</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"> * - 用户主动查询 scrub 进度时</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_scrub_progress</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	__u64 data_extents_scrubbed<span class="token punctuation">;</span>   <span class="token comment">/* 已校验的数据 extent 数量 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	__u64 tree_extents_scrubbed<span class="token punctuation">;</span>   <span class="token comment">/* 已校验的元数据（树） extent 数量 */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	__u64 data_bytes_scrubbed<span class="token punctuation">;</span>     <span class="token comment">/* 已校验的数据字节数 */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	__u64 tree_bytes_scrubbed<span class="token punctuation">;</span>     <span class="token comment">/* 已校验的元数据字节数 */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	__u64 read_errors<span class="token punctuation">;</span>             <span class="token comment">/* 读取错误次数（例如 EIO 错误） */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	__u64 csum_errors<span class="token punctuation">;</span>             <span class="token comment">/* 校验和（checksum）检查失败次数 */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	__u64 verify_errors<span class="token punctuation">;</span>           <span class="token comment">/* 元数据校验失败次数，例如树块中的</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">	                                * generation（版本号）或逻辑地址不一致 */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	__u64 no_csum<span class="token punctuation">;</span>                 <span class="token comment">/* 缺失校验和的 4K 数据块数量，可能由于写入时</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">	                                * 使用了 nodatasum 挂载选项 */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	__u64 csum_discards<span class="token punctuation">;</span>           <span class="token comment">/* 检测到校验和项但未能在 extent 树中</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">	                                * 找到对应数据的次数 */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	__u64 super_errors<span class="token punctuation">;</span>            <span class="token comment">/* 检测到损坏的超级块数量 */</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	__u64 malloc_errors<span class="token punctuation">;</span>           <span class="token comment">/* 内部 kmalloc 分配失败次数，这通常意味着</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">	                                * scrub 操作未能完整执行 */</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	__u64 uncorrectable_errors<span class="token punctuation">;</span>    <span class="token comment">/* 无法修复的错误次数：</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">	                                * 要么无法找到完好的副本，要么回写失败 */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	__u64 corrected_errors<span class="token punctuation">;</span>        <span class="token comment">/* 已成功修复的错误数量 */</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	__u64 last_physical<span class="token punctuation">;</span>           <span class="token comment">/* 最后一次成功 scrub 的物理地址；</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">	                                * 如果 scrub 中断，可以用此值重启 */</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	__u64 unverified_errors<span class="token punctuation">;</span>       <span class="token comment">/* 未确认错误次数：</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">	                                * 指整块（64KB bio）读取失败，但逐个 4K</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">	                                * 分片重新校验后都通过，属于间歇性错误 */</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_dev_info_args"><a class="anchor" href="#btrfs_ioctl_dev_info_args">#</a> btrfs_ioctl_dev_info_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_UUID_SIZE</span> <span class="token expression"><span class="token number">16</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_DEVICE_PATH_NAME_MAX</span>	<span class="token expression"><span class="token number">1024</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_dev_info_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u64 devid<span class="token punctuation">;</span>				<span class="token comment">/* 输入 / 输出 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__u8 uuid<span class="token punctuation">[</span>BTRFS_UUID_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">/* 输入 / 输出 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	__u64 bytes_used<span class="token punctuation">;</span>			<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	__u64 total_bytes<span class="token punctuation">;</span>			<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"> 	 * 可选输出项（out）。</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"> 	 *</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"> 	 * 用于显示该设备的 fsid，允许用户空间检查该设备是否是一个 seeding 设备。</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"> 	 *</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"> 	 * 此字段在内核 v6.3 中引入，因此用户空间仍需检查内核是否修改了此值。</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"> 	 * 较旧的内核版本不会修改这里的值。</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"> 	 */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	__u8 fsid<span class="token punctuation">[</span>BTRFS_UUID_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	__u64 unused<span class="token punctuation">[</span><span class="token number">377</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">/* 填充到 4K */</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	__u8 path<span class="token punctuation">[</span>BTRFS_DEVICE_PATH_NAME_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>seeding device：只读的「种子设备」，用于创建新文件系统的初始快照，不参与后续写操作。</p></blockquote><h2 id="btrfs_ioctl_balance_args"><a class="anchor" href="#btrfs_ioctl_balance_args">#</a> btrfs_ioctl_balance_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"> * balance 的 flags 定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"> * Restriper's general type filter</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"> * 用于：</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"> * btrfs_ioctl_balance_args.flags</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"> * btrfs_balance_control.flags (internal)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_DATA</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_SYSTEM</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_METADATA</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_TYPE_MASK</span>		<span class="token expression"><span class="token punctuation">(</span>BTRFS_BALANCE_DATA <span class="token operator">|</span>	    </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>					 <span class="token expression">BTRFS_BALANCE_SYSTEM <span class="token operator">|</span>	    </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="16"></td><td><pre>					 <span class="token expression">BTRFS_BALANCE_METADATA<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_FORCE</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_RESUME</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"> * balance state 的 flags 定义</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"> * 用于：</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"> * struct btrfs_ioctl_balance_args.state</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_STATE_RUNNING</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_STATE_PAUSE_REQ</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_STATE_CANCEL_REQ</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_balance_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	__u64 flags<span class="token punctuation">;</span>				<span class="token comment">/* 输入 / 输出 */</span></pre></td></tr><tr><td data-num="33"></td><td><pre>	__u64 state<span class="token punctuation">;</span>				<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_balance_args</span> data<span class="token punctuation">;</span>		<span class="token comment">/* 输入 / 输出 */</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_balance_args</span> meta<span class="token punctuation">;</span>		<span class="token comment">/* 输入 / 输出 */</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_balance_args</span> sys<span class="token punctuation">;</span>		<span class="token comment">/* 输入 / 输出 */</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_balance_progress</span> stat<span class="token punctuation">;</span>	<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>	__u64 unused<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">/* 填充至 1k */</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"> * per-type balance args 的 flags 定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"> * Balance filters</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"> * 用于:</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"> * struct btrfs_balance_args</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_ARGS_PROFILES</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_ARGS_USAGE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_ARGS_DEVID</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_ARGS_DRANGE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_ARGS_VRANGE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_ARGS_LIMIT</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_ARGS_LIMIT_RANGE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_ARGS_STRIPES_RANGE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_ARGS_USAGE_RANGE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_ARGS_MASK</span>			<span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token expression"><span class="token punctuation">(</span>BTRFS_BALANCE_ARGS_PROFILES <span class="token operator">|</span>		</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	 <span class="token expression">BTRFS_BALANCE_ARGS_USAGE <span class="token operator">|</span>		</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	 <span class="token expression">BTRFS_BALANCE_ARGS_DEVID <span class="token operator">|</span> 		</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	 <span class="token expression">BTRFS_BALANCE_ARGS_DRANGE <span class="token operator">|</span>		</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	 <span class="token expression">BTRFS_BALANCE_ARGS_VRANGE <span class="token operator">|</span>		</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	 <span class="token expression">BTRFS_BALANCE_ARGS_LIMIT <span class="token operator">|</span>		</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	 <span class="token expression">BTRFS_BALANCE_ARGS_LIMIT_RANGE <span class="token operator">|</span>	</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	 <span class="token expression">BTRFS_BALANCE_ARGS_STRIPES_RANGE <span class="token operator">|</span>	</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	 <span class="token expression">BTRFS_BALANCE_ARGS_USAGE_RANGE<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"> * 此结构体使用了 packed（紧凑）属性，</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment"> * 因为它必须与磁盘上的字节序对应结构体（struct btrfs_disk_balance_args）完全一致。</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_balance_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	__u64 profiles<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">	 * 使用率过滤器</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">	 * 使用 BTRFS_BALANCE_ARGS_USAGE 且赋单个值表示使用率在 0 到 N 之间</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">	 * 使用 BTRFS_BALANCE_ARGS_USAGE_RANGE 表示范围语法，即 min 到 max</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token keyword">union</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>		__u64 usage<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>		<span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>			__u32 usage_min<span class="token punctuation">;</span> <span class="token comment">// 使用率下限（单位是百分比 * 100）</span></pre></td></tr><tr><td data-num="46"></td><td><pre>			__u32 usage_max<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>		<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>	__u64 devid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>	__u64 pstart<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>	__u64 pend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>	__u64 vstart<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>	__u64 vend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>	__u64 target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>	__u64 flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment">	 * 使用 BTRFS_BALANCE_ARGS_LIMIT 且赋值 'limit'</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment">	 * 或使用 BTRFS_BALANCE_ARGS_LIMIT_RANGE，支持最小值与最大值</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="63"></td><td><pre>	<span class="token keyword">union</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>		__u64 limit<span class="token punctuation">;</span>		<span class="token comment">// 限制处理的数据块（chunk）数量</span></pre></td></tr><tr><td data-num="65"></td><td><pre>		<span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>			__u32 limit_min<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>			__u32 limit_max<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>		<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment">	 * 处理跨越 stripes_min 到 stripes_max 个设备的数据块</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token comment">	 * 使用 BTRFS_BALANCE_ARGS_STRIPES_RANGE</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="75"></td><td><pre>	__u32 stripes_min<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>	__u32 stripes_max<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>	__u64 unused<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* 向用户空间报告 balance 进度 */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_balance_progress</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u64 expected<span class="token punctuation">;</span>		<span class="token comment">/* 预估为满足本次 balance 请求而需要迁移的数据块（chunk）数量 */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u64 considered<span class="token punctuation">;</span>	<span class="token comment">/* 到目前为止已经被考虑处理的数据块数量 */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u64 completed<span class="token punctuation">;</span>	<span class="token comment">/* 到目前为止已成功迁移的数据块数量 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_ino_path_args"><a class="anchor" href="#btrfs_ioctl_ino_path_args">#</a> btrfs_ioctl_ino_path_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_ino_path_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	__u64				inum<span class="token punctuation">;</span>		<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u64				size<span class="token punctuation">;</span>		<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u64				reserved<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token comment">/* struct btrfs_data_container	*fspath;*/</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__u64				fspath<span class="token punctuation">;</span>		<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_data_container</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	__u32 bytes_left<span class="token punctuation">;</span>     <span class="token comment">/* 输出：未使用的字节数 —— 指输出结果所需空间少于提供的空间时，剩余的字节数 */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u32 bytes_missing<span class="token punctuation">;</span>  <span class="token comment">/* 输出：结果还需要的额外字节数 —— 当提供的缓冲区不够用时，表示还缺多少字节 */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u32 elem_cnt<span class="token punctuation">;</span>       <span class="token comment">/* 输出：实际返回的元素数量 */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u32 elem_missed<span class="token punctuation">;</span>    <span class="token comment">/* 输出：因为空间不足而未返回的元素数量 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__u64 val<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token comment">/* 输出：可变长度数组，用于存放返回的数据值（通常是 u64 类型的 ID 或其他值） */</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_logical_ino_args"><a class="anchor" href="#btrfs_ioctl_logical_ino_args">#</a> btrfs_ioctl_logical_ino_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"> * Return every ref to the extent, not just those containing logical block.</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"> * Requires logical == extent bytenr.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_LOGICAL_INO_ARGS_IGNORE_OFFSET</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_logical_ino_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	__u64				logical<span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	__u64				size<span class="token punctuation">;</span>		<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	__u64				reserved<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* 目前必须为 0 */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	__u64				flags<span class="token punctuation">;</span>		<span class="token comment">/* 输入，v2 only */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token comment">/* struct btrfs_data_container	*inodes;	输出   */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	__u64				inodes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参见<a href="#btrfs_ioctl_ino_path_args"> struct btrfs_data_container</a></p><h2 id="btrfs_ioctl_send_args"><a class="anchor" href="#btrfs_ioctl_send_args">#</a> btrfs_ioctl_send_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"> * 调用者不希望在发送流（send stream）中包含文件数据，即使在克隆源查找时找不到相应的数据块。</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"> * 此时将发送 UPDATE_EXTENT 指令，而不是 WRITE 指令。</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SEND_FLAG_NO_FILE_DATA</span>        <span class="token expression"><span class="token number">0x1</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"> * 不添加流头部（stream header）。该选项用于连续发送多个快照时。</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SEND_FLAG_OMIT_STREAM_HEADER</span>  <span class="token expression"><span class="token number">0x2</span></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"> * 省略发送流末尾用于标识结束的指令。</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"> * 该选项用于连续发送多个快照的场景。</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SEND_FLAG_OMIT_END_CMD</span>        <span class="token expression"><span class="token number">0x4</span></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"> * 从结构体中读取协议版本。</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SEND_FLAG_VERSION</span>             <span class="token expression"><span class="token number">0x8</span></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"> * 使用 ENCODED_WRITE 指令发送压缩数据，而不是先解压再用 WRITE 指令发送。</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"> * 需要协议版本 >= 2。</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SEND_FLAG_COMPRESSED</span>          <span class="token expression"><span class="token number">0x10</span></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SEND_FLAG_MASK</span> <span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token expression"><span class="token punctuation">(</span>BTRFS_SEND_FLAG_NO_FILE_DATA <span class="token operator">|</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	 <span class="token expression">BTRFS_SEND_FLAG_OMIT_STREAM_HEADER <span class="token operator">|</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	 <span class="token expression">BTRFS_SEND_FLAG_OMIT_END_CMD <span class="token operator">|</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="33"></td><td><pre>	 <span class="token expression">BTRFS_SEND_FLAG_VERSION <span class="token operator">|</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	 <span class="token expression">BTRFS_SEND_FLAG_COMPRESSED<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_send_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	__s64 send_fd<span class="token punctuation">;</span>			<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	__u64 clone_sources_count<span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="39"></td><td><pre>	__u64 __user <span class="token operator">*</span>clone_sources<span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="40"></td><td><pre>	__u64 parent_root<span class="token punctuation">;</span>		<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	__u64 flags<span class="token punctuation">;</span>			<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	__u32 version<span class="token punctuation">;</span>			<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="43"></td><td><pre>	__u8  reserved<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_quota_ctl_args"><a class="anchor" href="#btrfs_ioctl_quota_ctl_args">#</a> btrfs_ioctl_quota_ctl_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QUOTA_CTL_ENABLE</span>	<span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QUOTA_CTL_DISABLE</span>	<span class="token expression"><span class="token number">2</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QUOTA_CTL_RESCAN__NOTUSED</span>	<span class="token expression"><span class="token number">3</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_QUOTA_CTL_ENABLE_SIMPLE_QUOTA</span> <span class="token expression"><span class="token number">4</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_quota_ctl_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__u64 cmd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	__u64 status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_qgroup_assign_args"><a class="anchor" href="#btrfs_ioctl_qgroup_assign_args">#</a> btrfs_ioctl_qgroup_assign_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_qgroup_assign_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	__u64 assign<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u64 src<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u64 dst<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_qgroup_create_args"><a class="anchor" href="#btrfs_ioctl_qgroup_create_args">#</a> btrfs_ioctl_qgroup_create_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_qgroup_create_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	__u64 create<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u64 qgroupid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_qgroup_limit_args"><a class="anchor" href="#btrfs_ioctl_qgroup_limit_args">#</a> btrfs_ioctl_qgroup_limit_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_qgroup_limit_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	__u64	qgroupid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_qgroup_limit</span> lim<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>参见<a href="#btrfs_ioctl_vol_args_v2"> struct btrfs_qgroup_limit</a></p><h2 id="btrfs_ioctl_quota_rescan_args"><a class="anchor" href="#btrfs_ioctl_quota_rescan_args">#</a> btrfs_ioctl_quota_rescan_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_quota_rescan_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	__u64	flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u64   progress<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u64   reserved<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_get_dev_stats"><a class="anchor" href="#btrfs_ioctl_get_dev_stats">#</a> btrfs_ioctl_get_dev_stats</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">enum</span> <span class="token class-name">btrfs_dev_stat_values</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token comment">/* 磁盘 I/O 故障统计 */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	BTRFS_DEV_STAT_WRITE_ERRS<span class="token punctuation">,</span>  <span class="token comment">/* 来自底层的写入错误（EIO 或 EREMOTEIO） */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	BTRFS_DEV_STAT_READ_ERRS<span class="token punctuation">,</span>   <span class="token comment">/* 来自底层的读取错误（EIO 或 EREMOTEIO） */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	BTRFS_DEV_STAT_FLUSH_ERRS<span class="token punctuation">,</span>  <span class="token comment">/* 来自底层的刷新错误（EIO 或 EREMOTEIO） */</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">/* 间接反映 I/O 错误的统计数据 */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	BTRFS_DEV_STAT_CORRUPTION_ERRS<span class="token punctuation">,</span> <span class="token comment">/* 校验和错误、bytenr 错误或内容非法：</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">	                                 * 表明数据块在读写过程中遭到破坏，</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">	                                 * 或写入 / 读取了错误的位置 */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	BTRFS_DEV_STAT_GENERATION_ERRS<span class="token punctuation">,</span> <span class="token comment">/* 表示某些块可能尚未被写入 */</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>	BTRFS_DEV_STAT_VALUES_MAX       <span class="token comment">/* 统计值的最大数目（用于数组边界） */</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">/* 读取后重置统计数据；需要 SYS_ADMIN 权限 */</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_DEV_STATS_RESET</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">/* 获取设备统计信息的结构体 */</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_get_dev_stats</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	__u64 devid<span class="token punctuation">;</span>      <span class="token comment">/* 输入 - 要查询的设备 ID */</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	__u64 nr_items<span class="token punctuation">;</span>   <span class="token comment">/* 输入 / 输出 - 请求的统计项数量，返回实际填充的数量 */</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	__u64 flags<span class="token punctuation">;</span>      <span class="token comment">/* 输入 / 输出 - 控制标志，比如是否重置统计数据 */</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token comment">/* 输出值：各类错误计数 */</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	__u64 values<span class="token punctuation">[</span>BTRFS_DEV_STAT_VALUES_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">	 * 此结构体被填充为 1032 字节。</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">	 * 原本意图是填充到 1024 字节，但在添加 flags 字段时未调整填充计算。</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	__u64 unused<span class="token punctuation">[</span><span class="token number">128</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">-</span> BTRFS_DEV_STAT_VALUES_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_dev_replace_args"><a class="anchor" href="#btrfs_ioctl_dev_replace_args">#</a> btrfs_ioctl_dev_replace_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_CMD_START</span>			<span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_CMD_STATUS</span>			<span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_CMD_CANCEL</span>			<span class="token expression"><span class="token number">2</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR</span>			<span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_RESULT_NOT_STARTED</span>		<span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_RESULT_ALREADY_STARTED</span>		<span class="token expression"><span class="token number">2</span></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_RESULT_SCRUB_INPROGRESS</span>		<span class="token expression"><span class="token number">3</span></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_dev_replace_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	__u64 cmd<span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	__u64 result<span class="token punctuation">;</span>	<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">union</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_dev_replace_start_params</span> start<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_dev_replace_status_params</span> status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>	<span class="token comment">/* 输入 / 输出 */</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>	__u64 spare<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_ALWAYS</span>	<span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_AVOID</span>	    <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_dev_replace_start_params</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u64 srcdevid<span class="token punctuation">;</span>	<span class="token comment">/* 输入，如果是 0, 使用 srcdev_name 来代替 */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u64 cont_reading_from_srcdev_mode<span class="token punctuation">;</span>	<span class="token comment">/* 输入，使用上面定义的 #define */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__u8 srcdev_name<span class="token punctuation">[</span>BTRFS_DEVICE_PATH_NAME_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	__u8 tgtdev_name<span class="token punctuation">[</span>BTRFS_DEVICE_PATH_NAME_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED</span>	<span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED</span>		<span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED</span>		<span class="token expression"><span class="token number">2</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED</span>		<span class="token expression"><span class="token number">3</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED</span>		<span class="token expression"><span class="token number">4</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_dev_replace_status_params</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	__u64 replace_state<span class="token punctuation">;</span>	<span class="token comment">/* 输出，使用上面定义的 #define */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	__u64 progress_1000<span class="token punctuation">;</span>	<span class="token comment">/* 输出，0 &lt;= x &lt;= 1000 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	__u64 time_started<span class="token punctuation">;</span>	<span class="token comment">/* 输出，是从 1-Jan-1970 开始的秒数 */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	__u64 time_stopped<span class="token punctuation">;</span>	<span class="token comment">/* 输出，是从 1-Jan-1970 开始的秒数 */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	__u64 num_write_errors<span class="token punctuation">;</span>	<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	__u64 num_uncorrectable_read_errors<span class="token punctuation">;</span>	<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_same_args"><a class="anchor" href="#btrfs_ioctl_same_args">#</a> btrfs_ioctl_same_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_same_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	__u64 logical_offset<span class="token punctuation">;</span>   <span class="token comment">/* 输入 - 源文件中 extent 的起始偏移 */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u64 length<span class="token punctuation">;</span>           <span class="token comment">/* 输入 - extent 的长度 */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u16 dest_count<span class="token punctuation">;</span>       <span class="token comment">/* 输入 - info 数组中的目标文件数量 */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u16 reserved1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__u32 reserved2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_same_extent_info</span> info<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* 每个目标文件的去重信息 */</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_SAME_DATA_DIFFERS</span>	<span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/* 用于 extent-same ioctl */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_same_extent_info</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__s64 fd<span class="token punctuation">;</span>               <span class="token comment">/* 输入 - 目标文件的文件描述符 */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u64 logical_offset<span class="token punctuation">;</span>   <span class="token comment">/* 输入 - 目标文件中 extent 的起始偏移 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__u64 bytes_deduped<span class="token punctuation">;</span>    <span class="token comment">/* 输出 - 实际成功去重的字节数 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token comment">/* 本次去重操作的状态：</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">	 * 0 表示成功去重</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">	 * 小于 0 表示发生错误</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">	 * 等于 BTRFS_SAME_DATA_DIFFERS 表示数据不一致，不能去重</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	__s32 status<span class="token punctuation">;</span>           <span class="token comment">/* 输出 - 状态值，含义如上 */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	__u32 reserved<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_feature_flags"><a class="anchor" href="#btrfs_ioctl_feature_flags">#</a> btrfs_ioctl_feature_flags</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"> * feature flags</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"> * 用于:</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"> * struct btrfs_ioctl_feature_flags</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"> * 在大端系统上，旧版内核（&lt; 4.9）会生成损坏的空闲空间树位图，</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"> * 而 btrfs-progs 工具（版本 &lt; 4.7.3）也可能破坏空闲空间树。</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"> * 如果该位被清除（为 0），则表示空闲空间树不可信。</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"> * btrfs-progs 也可以有意清除此位，以请求内核重建空闲空间树，</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"> * 但对于不了解该位的旧内核，此操作可能无效。</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"> * 如果不确定，建议在首次挂载时手动清除缓存，</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"> * 尤其是在启动旧版本内核时。</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE_VALID</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_COMPAT_RO_VERITY</span>			<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"> * 将所有块组项放入专用的块组树中，</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"> * 由于更好的局部性，这可以大大减少大文件系统的挂载时间。</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_COMPAT_RO_BLOCK_GROUP_TREE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_MIXED_BACKREF</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_DEFAULT_SUBVOL</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_COMPRESS_LZO</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_COMPRESS_ZSTD</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"> * 较早的内核曾尝试使用更大的元数据块，</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"> * 但相关代码存在很多问题。我们不再允许它们继续尝试。</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_BIG_METADATA</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_RAID56</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_SKINNY_METADATA</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_NO_HOLES</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_METADATA_UUID</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_RAID1C34</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_ZONED</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_EXTENT_TREE_V2</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_RAID_STRIPE_TREE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_FEATURE_INCOMPAT_SIMPLE_QUOTA</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_feature_flags</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>	__u64 compat_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>	__u64 compat_ro_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>	__u64 incompat_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_get_subvol_rootref_args"><a class="anchor" href="#btrfs_ioctl_get_subvol_rootref_args">#</a> btrfs_ioctl_get_subvol_rootref_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_MAX_ROOTREF_BUFFER_NUM</span> <span class="token expression"><span class="token number">255</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_get_subvol_rootref_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>		<span class="token comment">/* 输入 / 输出，用于指定要搜索的 rootref 的最小 treeid */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		__u64 min_treeid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token comment">/* 输出 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			__u64 treeid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>			__u64 dirid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token punctuation">&#125;</span> rootref<span class="token punctuation">[</span>BTRFS_MAX_ROOTREF_BUFFER_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token comment">/* 输出，找到的项的数量 */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		__u8 num_items<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		__u8 align<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_ino_lookup_user_args"><a class="anchor" href="#btrfs_ioctl_ino_lookup_user_args">#</a> btrfs_ioctl_ino_lookup_user_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_VOL_NAME_MAX</span> <span class="token expression"><span class="token number">255</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_INO_LOOKUP_USER_PATH_MAX</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">4080</span> <span class="token operator">-</span> BTRFS_VOL_NAME_MAX <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_ino_lookup_user_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">/* 输入，包含'subvolid' 所对应子卷的 inode 编号 */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u64 dirid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token comment">/* 输入 */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	__u64 treeid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token comment">/* 输出，指定 'treeid' 的子卷名称 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">char</span> name<span class="token punctuation">[</span>BTRFS_VOL_NAME_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token comment">/* 输出，从调用该 ioctl 的目录到指定 dirid 所构建的路径 */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">char</span> path<span class="token punctuation">[</span>BTRFS_INO_LOOKUP_USER_PATH_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioctl_encoded_io_args"><a class="anchor" href="#btrfs_ioctl_encoded_io_args">#</a> btrfs_ioctl_encoded_io_args</h2><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"> * 用于编码读写的数据和元数据。</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"> * 编码 I/O (Encoded I/O) 会绕过文件系统自动执行的任何编码操作（例如压缩）。</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"> * 这可以用于读取文件的压缩内容，或直接将预压缩数据写入文件。</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"> * BTRFS_IOC_ENCODED_READ 和 BTRFS_IOC_ENCODED_WRITE 本质上类似于</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"> * preadv/pwritev，但额外携带了有关数据编码方式和未编码数据大小的元信息。</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"> * BTRFS_IOC_ENCODED_READ 会将编码数据填入提供的 iovec 中，填充元数据字段，</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"> * 并返回编码数据的大小。每次调用读取一个 extent。它也可以读取未编码数据。</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"> * BTRFS_IOC_ENCODED_WRITE 使用元数据字段，从 iovec 中写入编码数据，并返回编码数据的大小。</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"> * 注意：写入时不会验证编码数据是否有效；如果数据无效（例如无法解压），则后续读取可能会返回错误。</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"> * 由于文件系统的页缓存中保存的是解码后的数据，因此编码 I/O 会绕过页缓存。</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"> * 编码 I/O 需要 CAP_SYS_ADMIN 权限。</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_encoded_io_args</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token comment">/* 读写操作的输入参数 */</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">	 * 包含编码数据的 iovec 数组。</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">	 * 对于读取操作，如果编码数据大小大于所有 iov [n].iov_len (0 &lt;= n &lt; iovcnt) 的总和，</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">	 * 则 ioctl 调用失败并返回 ENOBUFS。</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">	 * 对于写入操作，编码数据的大小为所有 iov [n].iov_len 的总和（0 &lt;= n &lt; iovcnt）。</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">	 * 必须小于 128 KiB（未来可能放宽限制），也必须小于等于 unencoded_len。</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> __user <span class="token operator">*</span>iov<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>	<span class="token comment">/* iovec 数组中的元素数量 */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> iovcnt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">	 * 文件偏移量</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">	 * 对于写操作，必须对齐到文件系统的扇区大小。</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	__s64 offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>	<span class="token comment">/* 当前必须为零 */</span></pre></td></tr><tr><td data-num="44"></td><td><pre>	__u64 flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">	 * 以下字段为读取操作的输出参数，包含返回的编码数据元信息；</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">	 * 对于写入操作，这些字段必须由用户设置为编码数据的元信息。</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">	 * 文件中数据的长度</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">	 * 必须小于等于 unencoded_len - unencoded_offset。</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment">	 * 对于写操作，除非数据末尾位于或超出文件当前末尾，否则必须对齐到扇区大小。</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="57"></td><td><pre>	__u64 len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment">	 * 未编码（即解密解压后）的数据长度。</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment">	 * 对于写操作，不能超过 128 KiB（未来可能放宽限制）。</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment">	 * 如果实际未编码数据长于 unencoded_len，则会被截断；</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment">	 * 若短于该值，则使用 0 填充。</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="66"></td><td><pre>	__u64 unencoded_len<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment">	 * 从未编码数据首字节到文件中逻辑数据首字节的偏移。</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment">	 * 必须小于 unencoded_len。</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="73"></td><td><pre>	__u64 unencoded_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token comment">	 * BTRFS_ENCODED_IO_COMPRESSION_* 类型。</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token comment">	 * 对于写操作，不能为 BTRFS_ENCODED_IO_COMPRESSION_NONE。</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="80"></td><td><pre>	__u32 compression<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>	<span class="token comment">/* 当前总是 BTRFS_ENCODED_IO_ENCRYPTION_NONE */</span></pre></td></tr><tr><td data-num="83"></td><td><pre>	__u32 encryption<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment">	 * 为将来扩展预留</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment">	 * 对于读取操作，总是返回为零。用户应检查是否有非零字节，</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment">	 * 如果有，说明内核使用了结构体的新版本，包含用户定义中缺失的附加信息。</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment">	 *</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token comment">	 * 对于写操作，必须将其清零。</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment">	 */</span></pre></td></tr><tr><td data-num="93"></td><td><pre>	__u8 reserved<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* 数据未压缩 */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_COMPRESSION_NONE</span> <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/* 数据作为单个 zlib 流进行压缩。 */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_COMPRESSION_ZLIB</span> <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"> * 数据作为单个 zstd 帧进行压缩，并且 windowLog 压缩参数设置为不超过 17。</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_COMPRESSION_ZSTD</span> <span class="token expression"><span class="token number">2</span></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"> * 数据按扇区逐个压缩（使用常量名称中指示的扇区大小），</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"> * 使用 LZO1X 压缩，并以 fs/btrfs/lzo.c 中文档化的格式进行包装。</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"> * 对于写操作，压缩扇区大小必须与文件系统的扇区大小匹配。</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_COMPRESSION_LZO_4K</span> <span class="token expression"><span class="token number">3</span></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_COMPRESSION_LZO_8K</span> <span class="token expression"><span class="token number">4</span></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_COMPRESSION_LZO_16K</span> <span class="token expression"><span class="token number">5</span></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_COMPRESSION_LZO_32K</span> <span class="token expression"><span class="token number">6</span></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_COMPRESSION_LZO_64K</span> <span class="token expression"><span class="token number">7</span></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_COMPRESSION_TYPES</span> <span class="token expression"><span class="token number">8</span></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">/* 数据未加密 */</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_ENCRYPTION_NONE</span> <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_ENCODED_IO_ENCRYPTION_TYPES</span> <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr></table></figure><h1 id="详细描述"><a class="anchor" href="#详细描述">#</a> 详细描述</h1><h2 id="btrfs_ioc_snap_create_v2"><a class="anchor" href="#btrfs_ioc_snap_create_v2">#</a> BTRFS_IOC_SNAP_CREATE_V2</h2><p>为一个子卷创建一个快照。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>创建新快照的目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_vol_args_v2">struct btrfs_ioctl_vol_args_v2</a></td></tr><tr><td>args.fd</td><td>表示要快照的子卷中任意目录的文件描述符，必须位于同一个文件系统上</td></tr><tr><td>args.transid</td><td>该字段会被忽略</td></tr><tr><td>args.flags</td><td>可以设置为 <code>BTRFS_SUBVOL_RDONLY</code> 的任意子集来使新快照只读，或设置为 <code>BTRFS_SUBVOL_QGROUP_INHERIT</code> 来应用 <code>qgroup_inherit</code> 字段</td></tr><tr><td><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></td><td>新子卷在 <code>ioctl fd</code> 指定的目录下的名称</td></tr></tbody></table><h2 id="btrfs_ioc_scan_dev"><a class="anchor" href="#btrfs_ioc_scan_dev">#</a> BTRFS_IOC_SCAN_DEV</h2><p>扫描指定设备并将其注册到文件系统模块中，以便在挂载时自动关联设备和文件系统。此操作针对的是控制设备，而不是已挂载文件系统中的文件。可以安全地重复调用同一设备路径。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>控制设备的文件描述符 <code>/dev/btrfs-control</code></td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td>args.fd</td><td>该字段会被忽略</td></tr><tr><td><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></td><td>设备的绝对路径</td></tr></tbody></table><h2 id="btrfs_ioc_sync"><a class="anchor" href="#btrfs_ioc_sync">#</a> BTRFS_IOC_SYNC</h2><p>与 <code>sync()</code> 系统调用一样同步文件系统数据，另外会唤醒内部事务线程，从而触发子卷清理或队列碎片整理等操作。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td>NULL</td></tr></tbody></table><h2 id="btrfs_ioc_add_dev"><a class="anchor" href="#btrfs_ioc_add_dev">#</a> BTRFS_IOC_ADD_DEV</h2><p>将指定的块设备添加到文件系统。与命令 <code>btrfs device add</code> 不同的是，这个操作<strong>不会执行任何安全检查</strong>（例如：该设备上是否已有其他文件系统）、<strong>也不会进行设备预处理</strong>（比如 TRIM 操作或重置分区区域），因此<strong>请谨慎使用</strong>。</p><p>这是一个<strong>文件系统独占操作</strong>，如果当前文件系统已有其他实例正在运行，这个操作将会失败。但有一个例外：当系统处于 “<strong>平衡操作（balance）已暂停</strong>” 的状态时，仍然可以执行该操作。</p><p>所需权限： CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td>args.fd</td><td>该字段会被忽略</td></tr><tr><td><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></td><td>要被添加的块设备的绝对路径</td></tr></tbody></table><h2 id="btrfs_ioc_rm_dev"><a class="anchor" href="#btrfs_ioc_rm_dev">#</a> BTRFS_IOC_RM_DEV</h2><p>*（Linux v3.0 引入，v4.7 过时）* 从文件系统中移除指定路径的设备，或者通过特殊路径 <code>&quot;cancel&quot;</code> 取消正在进行的设备删除操作。</p><p>这是一个文件系统独占操作，如果已有其他操作在运行，则该操作会失败。</p><p>执行此操作需要权限：CAP_SYS_ADMIN。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td>args.fd</td><td>该字段会被忽略</td></tr><tr><td><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></td><td>要被删除的块设备的绝对路径 或 字符串 *“cancel”*</td></tr></tbody></table><h2 id="btrfs_ioc_ino_lookup"><a class="anchor" href="#btrfs_ioc_ino_lookup">#</a> BTRFS_IOC_INO_LOOKUP</h2><p>解析 inode 号为路径（需要 <code>CAP_SYS_ADMIN</code> 权限），或读取给定文件所属的子卷 ID（此为特殊情况，不受权限限制）。由于路径名缓冲区的大小小于 <em>PATH_MAX</em>（4096 字节），因此路径有可能会被截断。该功能也可以通过 <span class="exturl" data-url="aHR0cHM6Ly9idHJmcy5yZWFkdGhlZG9jcy5pby9lbi9sYXRlc3QvYnRyZnMtaW5zcGVjdC1pbnRlcm5hbC5odG1sI21hbi1pbnNwZWN0LXJvb3RpZA==">btrfs inspect-internal rootid</span> 实现。</p><p>一般情况下，此操作需要 <code>CAP_SYS_ADMIN</code> 权限，并且可以将任意文件解析为其路径。而用于读取所属子卷的特殊情况则不受权限限制：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_ino_lookup_args</span> args<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>args<span class="token punctuation">.</span>treeid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>args<span class="token punctuation">.</span>objectid <span class="token operator">=</span> BTRFS_FIRST_FREE_OBJECTID<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> BTRFS_IOC_INO_LOOKUP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/* args.treeid now contains the subvolume id */</span></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>待寻找子卷 id 的文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_ino_lookup_args">struct btrfs_ioctl_ino_lookup_args</a></td></tr><tr><td>args.treeid</td><td>用于路径解析的子卷 ID（需要 <code>CAP_SYS_ADMIN</code> 权限）；如果设置为 0，则使用包含该 <em>fd</em> 的子卷。</td></tr><tr><td>args.objectid</td><td>要查询的 inode 号，对应于 <em>INODE_REF_KEY</em> 的 <code>key.objectid</code> 。或者，作为特殊情况，设置为 <span class="exturl" data-url="aHR0cHM6Ly9idHJmcy5yZWFkdGhlZG9jcy5pby9lbi9sYXRlc3QvYnRyZnMtaW9jdGwuaHRtbCNjb25zdGFudHMtdGFibGU=">BTRFS_FIRST_FREE_OBJECTID</span> 以仅读取树 ID 并清空 <em><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></em> 缓冲区。</td></tr><tr><td><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></td><td>相对于顶层子卷的路径，或留空字符串。</td></tr></tbody></table><h2 id="btrfs_ioc_default_subvol"><a class="anchor" href="#btrfs_ioc_default_subvol">#</a> BTRFS_IOC_DEFAULT_SUBVOL</h2><p>将指定的子卷 ID 设置为默认子卷，当挂载该文件系统时如果未指定 <code>subvol=路径</code> 或 <code>subvolid=ID</code> 选项，则挂载此默认子卷。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>用于在其内部创建新快照的目录的文件描述符</td></tr><tr><td>ioctl args</td><td>要设置为默认子卷的子卷数字值 (uint64_t)</td></tr></tbody></table><h2 id="btrfs_ioc_subvol_create_v2"><a class="anchor" href="#btrfs_ioc_subvol_create_v2">#</a> BTRFS_IOC_SUBVOL_CREATE_V2</h2><p><em>(3.6 版本引入)</em> 创建一个新的子卷， <code>qgroup inheritance</code> 和 <code>limits</code> 可以被指定。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>新子卷的父目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_vol_args_v2">struct btrfs_ioctl_vol_args_v2</a></td></tr><tr><td>args.fd</td><td>该字段会被忽略</td></tr><tr><td>args.transid</td><td>该字段会被忽略</td></tr><tr><td>args.flags</td><td>要在子卷上设置的 flags， <code>BTRFS_SUBVOL_RDONLY</code> 表示只读， <code>BTRFS_SUBVOL_QGROUP_INHERIT</code> 表示要处理 <code>qgroup</code> 相关的字段</td></tr><tr><td>args.size</td><td><code>args.qgroup_inherit</code> 中的条目数</td></tr><tr><td>args.qgroup_inherit</td><td>继承给定的配额组（qgroups (<a href="#btrfs_ioctl_vol_args_v2">struct btrfs_qgroup_inherit</a>) ）和 limits (<a href="#btrfs_ioctl_vol_args_v2">struct btrfs_qgroup_limit</a>)</td></tr><tr><td>name</td><td>子卷的名字，尽管缓冲区已经几乎能到达 4KB，但是 Linux VFS 限制了文件名长度最大为 255 个字符且不能包含斜杠（ <code>/</code> ）</td></tr></tbody></table><h2 id="btrfs_ioc_subvol_getflags"><a class="anchor" href="#btrfs_ioc_subvol_getflags">#</a> BTRFS_IOC_SUBVOL_GETFLAGS</h2><p>读取一个子卷的 flags。返回的 flags 要么是 0，要么是 <code>BTRFS_SUBVOL_RDONLY</code> 。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>要检查的子卷的文件描述符</td></tr><tr><td>ioctl args</td><td>uint64_t</td></tr></tbody></table><h2 id="btrfs_ioc_subvol_setflags"><a class="anchor" href="#btrfs_ioc_subvol_setflags">#</a> BTRFS_IOC_SUBVOL_SETFLAGS</h2><p>设置一个子卷的 flags。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>要改变的子卷的文件描述符</td></tr><tr><td>ioctl args</td><td>uint64_t，要么是 0，要么是 <code>BTRFS_SUBVOL_RDONLY</code></td></tr></tbody></table><h2 id="btrfs_ioc_get_fslabel"><a class="anchor" href="#btrfs_ioc_get_fslabel">#</a> BTRFS_IOC_GET_FSLABEL</h2><p>将文件系统的标签读取到给定的缓冲区中，也可以从 <code>/sys/fs/btrfs/FSID/label</code> 中读取，但这需要知道该文件系统的 <code>FSID</code> 。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td>char buffer[<span class="exturl" data-url="aHR0cHM6Ly9idHJmcy5yZWFkdGhlZG9jcy5pby9lbi9sYXRlc3QvYnRyZnMtaW9jdGwuaHRtbCNjb25zdGFudHMtdGFibGU=">BTRFS_LABEL_SIZE</span>]</td></tr></tbody></table><h2 id="btrfs_ioc_set_fslabel"><a class="anchor" href="#btrfs_ioc_set_fslabel">#</a> BTRFS_IOC_SET_FSLABEL</h2><p>将文件系统的标签设置为给定的缓冲区内容。最大长度包括终止的 NUL 字符。或者，也可以通过写入 <code>/sys/fs/btrfs/FSID/label</code> 来设置标签，但这需要知道文件系统的 FSID（并且在更改永久生效之前需要显式提交）。</p><p>所需权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td>char buffer[<span class="exturl" data-url="aHR0cHM6Ly9idHJmcy5yZWFkdGhlZG9jcy5pby9lbi9sYXRlc3QvYnRyZnMtaW9jdGwuaHRtbCNjb25zdGFudHMtdGFibGU=">BTRFS_LABEL_SIZE</span>]</td></tr></tbody></table><h2 id="btrfs_ioc_fs_info"><a class="anchor" href="#btrfs_ioc_fs_info">#</a> BTRFS_IOC_FS_INFO</h2><p>读取文件系统的内部信息。数据可以双向交换，部分结构可以选择性填充。保留的字节可用于获取新的信息，但始终取决于设置的标志。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_fs_info_args">struct btrfs_ioctl_fs_info_args</a></td></tr></tbody></table><h2 id="btrfs_ioc_get_subvol_info"><a class="anchor" href="#btrfs_ioc_get_subvol_info">#</a> BTRFS_IOC_GET_SUBVOL_INFO</h2><p>获取一个子卷的信息。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>要检查的子卷的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_get_subvol_info_args">struct btrfs_ioctl_get_subvol_info_args</a></td></tr></tbody></table><h2 id="btrfs_ioc_snap_destroy_v2"><a class="anchor" href="#btrfs_ioc_snap_destroy_v2">#</a> BTRFS_IOC_SNAP_DESTROY_V2</h2><p>销毁一个子卷，该子卷可能是也可能不是快照。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>如果 flags 不包括 <code>BTRFS_SUBVOL_SPEC_BY_ID</code> ，或者在非 <code>root</code> 用户命名空间中执行，参数 <code>fd</code> 为包含要删除的子卷的父目录的文件描述符；否则， <code>fd</code> 为要删除的子卷在同一文件系统中的任何目录的文件描述符，但不在同一子卷中</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_vol_args_v2">struct btrfs_ioctl_vol_args_v2</a></td></tr><tr><td>args.fd</td><td>该字段会被忽略</td></tr><tr><td>args.transid</td><td>该字段会被忽略</td></tr><tr><td>args.flags</td><td>如果通过 <code>name</code> 字段用指定目录中的名称标识子卷，则为 0；如果用 <code>subvolid</code> 字段指定子卷的 ID，则为 <code>BTRFS_SUBVOL_SPEC_BY_ID</code></td></tr><tr><td><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></td><td>仅当 flags 不包含 <code>BTRFS_SUBVOL_SPEC_BY_ID</code> 时有用，指定要删除的子卷的名称（在参数 <code>fd</code> 所标识的目录中）</td></tr><tr><td>args.subvolid</td><td>只有在 flags 包含 <code>BTRFS_SUBVOL_SPEC_BY_ID</code> 时有用，指定要删除的子卷的子卷 ID</td></tr></tbody></table><h2 id="btrfs_ioc_subvol_sync_wait"><a class="anchor" href="#btrfs_ioc_subvol_sync_wait">#</a> BTRFS_IOC_SUBVOL_SYNC_WAIT</h2><p><strong>（自内核 6.13 起）</strong> 等待一个已删除的子卷被清理完成，或查询其当前状态。</p><p>该 ioctl 提供多种操作模式，其中最常见的是：等待特定子卷的清理完成，或等待所有当前排队待清理的子卷。例如，备份程序在删除子卷后会使用该功能，等待其真正被清理，以确认磁盘空间是否已释放。</p><p>其他模式则提供更高的灵活性，比如用于监控或在子卷删除队列中设置 “检查点”，而无需使用 <code>SEARCH_TREE</code> 操作。</p><p><strong>注意事项：</strong></p><ul><li>等待操作是可中断的，超时时间为 1 秒，且该值不可配置。</li><li>多次调用该 ioctl 会看到不同的状态，因此在使用 “计数” 或 “查看下一个 / 最后一个” 等模式时存在竞争条件（racy）。</li></ul><p><strong>使用场景（<a href="#btrfs_ioctl_subvol_wait">常量定义详见此处</a>）：</strong></p><ul><li>某个子卷 A 被删除后，等待其清理完成（ <code>WAIT_FOR_ONE</code> ）</li><li>一批子卷被删除后，等待所有清理完成（ <code>WAIT_FOR_QUEUED</code> 或 <code>PEEK_LAST</code> + <code>WAIT_FOR_ONE</code> ）</li><li>统计当前待清理子卷的数量（非阻塞），用于监控目的</li><li>报告清理进度（使用 <code>PEEK_NEXT</code> ），若清理太快可能会遗漏部分子卷</li><li>在用户空间自行实现等待逻辑（持续使用 <code>PEEK_LAST</code> ，直到其返回 0）</li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中的任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_subvol_wait">struct btrfs_ioctl_subvol_wait</a></td></tr><tr><td>args.subvolid</td><td>依赖于具体的模式，指定是要等待的子卷的数字 id，还是 <em>PEEK</em> 模式查询的子卷的数字 id</td></tr><tr><td>args.mode</td><td>上述描述的操作模式</td></tr><tr><td>args.count</td><td>如果 <em>mode</em> 设置为 <code>COUNT</code> ，则为排队等待清理的子卷数量</td></tr></tbody></table><h2 id="btrfs_ioc_defrag"><a class="anchor" href="#btrfs_ioc_defrag">#</a> BTRFS_IOC_DEFRAG</h2><p>对文件或目录执行碎片整理（defragmentation）。</p><p>对目录操作所需权限： CAP_SYS_ADMIN</p><p>对文件操作所需权限：对该 inode 具有 “写权限”。</p><blockquote><p><code>BTRFS_IOC_DEFRAG</code> 在 <code>include/uapi/linux/btrfs.h</code> 中的参数定义为：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_IOC_DEFRAG</span> <span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span>BTRFS_IOCTL_MAGIC<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>				   <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">btrfs_ioctl_vol_args</span><span class="token punctuation">)</span></span></pre></td></tr></table></figure><p>然而实际上在 <code>fs/btrfs/ioctl.c</code> 的具体实现为：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">case</span> BTRFS_IOC_DEFRAG<span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">return</span> <span class="token function">btrfs_ioctl_defrag</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">case</span> BTRFS_IOC_DEFRAG_RANGE<span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">return</span> <span class="token function">btrfs_ioctl_defrag</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> argp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>可见 <code>BTRFS_IOC_DEFRAG</code> 和 <code>BTRFS_IOC_DEFRAG_RANGE</code> 最终都调用了 btrfs_ioctl_defrag，且 <code>btrfs_ioctl_defrag</code> 实际的调用参数是 <code>NULL</code> ，与声明不符，这是一个 “历史遗留” 问题，在早期 <code>BTRFS_IOC_DEFRAG</code> 确实使用 <code>btrfs_ioctl_vol_args</code> 参数，但是后来，这个 ioctl 的处理方式发生了变化，<strong>用户空间传参变得 “可选”</strong>，允许传一个更详细的结构体 <code>struct btrfs_ioctl_defrag_range_args</code> ，这里不变只是为保持 ioctl 编号一致性的一个声明。</p></blockquote><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td>该字段会被忽略</td></tr></tbody></table><h2 id="btrfs_ioc_defrag_range"><a class="anchor" href="#btrfs_ioc_defrag_range">#</a> BTRFS_IOC_DEFRAG_RANGE</h2><p>对文件或目录执行碎片整理（新接口，可以提供更细颗粒度的管理）</p><p>对目录操作所需权限： CAP_SYS_ADMIN</p><p>对文件操作所需权限：对该 inode 具有 “写权限”。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_defrag_range_args">struct btrfs_ioctl_defrag_range_args</a></td></tr><tr><td>args.start</td><td>碎片整理操作的起始位置</td></tr><tr><td>args.len</td><td>要进行碎片整理的字节数，使用 (u64)-1 表示所有</td></tr><tr><td>args.flags</td><td>操作的标记，包括开启压缩功能等</td></tr><tr><td>args.extent_thresh</td><td>任何大于该值的 extent（连续块）会被认为已经整理过；0 表示使用内核默认值，1 表示必须重写所有范围</td></tr><tr><td>args.compress_type</td><td>如果为该磁盘碎片操作开启压缩功能，应使用哪种压缩方法。如果未指定，将使用 zlib</td></tr><tr><td>args.unused</td><td>备用</td></tr></tbody></table><h2 id="btrfs_ioc_resize"><a class="anchor" href="#btrfs_ioc_resize">#</a> BTRFS_IOC_RESIZE</h2><p>调整（resize）某个 Btrfs 设备的容量大小。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td>args.fd</td><td>该字段会被忽略</td></tr><tr><td><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></td><td>见下表</td></tr></tbody></table><p><code>args.name</code> 的含义见下表</p><table><thead><tr><th><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></th><th>含义</th></tr></thead><tbody><tr><td><code>&quot;max&quot;</code></td><td>将设备扩容到其最大容量</td></tr><tr><td><code>&quot;+10G&quot;</code></td><td>当前设备扩容 10 GB</td></tr><tr><td><code>&quot;1:+5G&quot;</code></td><td>devid=1 的设备扩容 5 GB</td></tr><tr><td><code>&quot;2:-1T&quot;</code></td><td>devid=2 的设备缩小 1 TB</td></tr><tr><td>&quot;cancel&quot;</td><td>取消当前 resize 操作</td></tr></tbody></table><h2 id="btrfs_ioc_clone"><a class="anchor" href="#btrfs_ioc_clone">#</a> BTRFS_IOC_CLONE</h2><p>用于提供 CoW 文件系统的 <code>clone</code> 支持。</p><blockquote><p>这里的 <strong>“clone”</strong>，指的是 <strong>文件数据块级的 “写时复制”（Copy-on-Write, COW）克隆操作</strong>，它让你在两个文件之间共享物理存储数据而不进行真正的数据复制。简单来说就是：“把一个文件的一段内容，映射到另一个文件中相同长度的位置 —— 如果没人改动，两个文件用的是同一块磁盘空间；只有修改时，才会触发真正的复制。”</p></blockquote><p>早期用于兼容的通用接口，该接口等价于内核中的 <code>FICLONE</code> 命令。 <code>FICLONE</code> 命令是 Linux 4.5 之后内核中引入的用于支持所有 CoW（Copy-on-Write）文件系统的命令，所以在这之后，该接口就被 <code>FICLONE</code> 代替了。Btrfs 在 <code>btrfs_ioctl()</code> 里<strong>没有专门实现 <code>BTRFS_IOC_CLONE</code> ，而是统一走 VFS 层的 <code>FICLONE</code> 分发逻辑</strong>，VFS 会调用 Btrfs 的 <code>btrfs_remap_file_range()</code> ，最终执行 <code>clone</code> 逻辑。调用路径为： <code>ioctl_file_clone</code> → <code>vfs_clone_file_range</code> → <code>btrfs_remap_file_range</code> 。</p><h2 id="btrfs_ioc_clone_range"><a class="anchor" href="#btrfs_ioc_clone_range">#</a> BTRFS_IOC_CLONE_RANGE</h2><p>对 <code>FICLONE</code> 的扩展，用于将一个文件中的指定范围的数据 <code>clone</code> 到另一个文件的指定位置，提供了比 <code>FICLONE</code> 更灵活的 <strong>克隆部分范围的能力</strong>。</p><p>同<a href="#btrfs_ioc_clone"> BTRFS_IOC_CLONE</a> 一样， <code>BTRFS_IOC_CLONE_RANGE</code> 也是 btrfs 早期实现的，后被又被 VFS 统一的实现的 <code>FICLONERANGE</code> 所替代，现在在 Btrfs 代码中已经没有专门的实现了，而是走 VFS 层的 <code>FICLONERANGE</code> 分发逻辑，调用路径为： <code>ioctl_file_clone_range</code> → <code>ioctl_file_clone</code> → <code>vfs_clone_file_range</code> → <code>btrfs_remap_file_range</code></p><h2 id="btrfs_ioc_file_extent_same"><a class="anchor" href="#btrfs_ioc_file_extent_same">#</a> BTRFS_IOC_FILE_EXTENT_SAME</h2><p>在支持 CoW 的文件系统上，可以使用此 <code>ioctl</code> 来让两个数据相同的文件使用同一份物理存储（相当于删除重复数据）。早期仅在 Btrfs 内实现，在 Linux 4.5 后由 VFS 统一实现并分发，调用路径为： <code>ioctl_file_dedupe_range</code> → <code>vfs_dedupe_file_range</code> → <code>vfs_dedupe_file_range_one</code> → <code>btrfs_remap_file_range</code> 。</p><h2 id="btrfs_ioc_tree_search"><a class="anchor" href="#btrfs_ioc_tree_search">#</a> BTRFS_IOC_TREE_SEARCH</h2><div class="note info"><p>被 <a href="#btrfs_ioc_tree_search_v2">BTRFS_IOC_TREE_SEARCH_V2</a> 代替</p></div><p>（<strong>Linux v3.0 引入，v3.16 过时</strong>）搜索 Btrfs 的元数据树。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_search_args">struct btrfs_ioctl_search_args</a></td></tr><tr><td>args.key</td><td>搜索配置，字段请参考<a href="#btrfs_ioctl_search_args"> struct btrfs_ioctl_search_key</a></td></tr><tr><td>args.buf</td><td>搜索到的条目</td></tr></tbody></table><h2 id="btrfs_ioc_tree_search_v2"><a class="anchor" href="#btrfs_ioc_tree_search_v2">#</a> BTRFS_IOC_TREE_SEARCH_V2</h2><p>（<strong>自内核 3.16 起</strong>）搜索 Btrfs 的元数据树。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_search_args_V2">struct btrfs_ioctl_search_args_V2</a></td></tr><tr><td>args.key</td><td>搜索配置，字段请参考<a href="#btrfs_ioctl_search_args"> struct btrfs_ioctl_search_key</a></td></tr><tr><td>args.buf_size</td><td>buffer 缓冲区大小；若返回 EOVERFLOW，表示 buffer 空间不足，则该项存储所有 item 所需的大小</td></tr><tr><td>args.buf</td><td>搜索到的条目</td></tr></tbody></table><h2 id="btrfs_ioc_space_info"><a class="anchor" href="#btrfs_ioc_space_info">#</a> BTRFS_IOC_SPACE_INFO</h2><p>查询磁盘空间使用情况（包括数据区、元数据区、系统区、RAID 分布情况等）。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_space_args">struct btrfs_ioctl_space_args</a></td></tr><tr><td>args.space_slots</td><td>用户请求的条目数量（0 表示只想获取总数）</td></tr><tr><td>args.total_spaces</td><td>实际返回的空间条目数量</td></tr><tr><td>args.spaces</td><td>空间条目的内存区，参考<a href="#btrfs_ioctl_space_args"> struct btrfs_ioctl_space_info</a></td></tr></tbody></table><p>可返回的空间类型包括：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">const</span> u64 types<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>		BTRFS_BLOCK_GROUP_DATA<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>		BTRFS_BLOCK_GROUP_SYSTEM<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		BTRFS_BLOCK_GROUP_METADATA<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		BTRFS_BLOCK_GROUP_DATA <span class="token operator">|</span> BTRFS_BLOCK_GROUP_METADATA</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="btrfs_ioc_start_sync"><a class="anchor" href="#btrfs_ioc_start_sync">#</a> BTRFS_IOC_START_SYNC</h2><p>强制触发一次子卷事务（transaction）提交，并返回该次提交（或最近一次提交）的 transaction ID 给用户。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>待同步的子卷的文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td>uint64_t，事务 ID；如果当前没有进行中的事务，则返回的是上一次的 transaction ID</td></tr></tbody></table><h2 id="btrfs_ioc_wait_sync"><a class="anchor" href="#btrfs_ioc_wait_sync">#</a> BTRFS_IOC_WAIT_SYNC</h2><p>等待指定的事务 ID（transaction ID）提交完成，如果没有指定，则等待当前正在提交的事务完成。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>等待的子卷的文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td>uint64_t，事务 ID；如果为 NULL，表示等待当前活跃的事务完成</td></tr></tbody></table><h2 id="btrfs_ioc_scrub"><a class="anchor" href="#btrfs_ioc_scrub">#</a> BTRFS_IOC_SCRUB</h2><p>对一个 Btrfs 设备进行 scrub（校验和修复）操作，主要用于数据完整性检查。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_scrub_args">struct btrfs_ioctl_scrub_args</a></td></tr><tr><td>args.device</td><td>目标设备 ID，0 表示默认设备，也可用<a href="#btrfs_ioc_dev_info"> BTRFS_IOC_DEV_INFO</a> 获取设备列表</td></tr><tr><td>args.start</td><td>开始偏移，0 表示从设备起始位置</td></tr><tr><td>args.end</td><td>结束偏移</td></tr><tr><td>args.flags</td><td>控制行为，目前只有两个：0 表示读写（校验 + 修复），1 表示只读（只校验不修复）</td></tr><tr><td>args.progress</td><td>记录 scrub 的错误或进度信息，具体请参考<a href="#btrfs_ioctl_scrub_args"> struct btrfs_scrub_progress</a></td></tr></tbody></table><h2 id="btrfs_ioc_scrub_cancel"><a class="anchor" href="#btrfs_ioc_scrub_cancel">#</a> BTRFS_IOC_SCRUB_CANCEL</h2><p>取消正在运行的 scrub 操作。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td>NULL</td></tr></tbody></table><h2 id="btrfs_ioc_scrub_progress"><a class="anchor" href="#btrfs_ioc_scrub_progress">#</a> BTRFS_IOC_SCRUB_PROGRESS</h2><p>获取 scrub 进度信息。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_scrub_args">struct btrfs_ioctl_scrub_args</a></td></tr><tr><td>args.device</td><td>目标设备 ID，0 表示默认设备，也可用<a href="#btrfs_ioc_dev_info"> BTRFS_IOC_DEV_INFO</a> 获取设备列表</td></tr><tr><td>args.start</td><td>无需填充，由内核填写，表示 scrub 的开始偏移</td></tr><tr><td>args.end</td><td>无需填充，由内核填写，表示 scrub 的结束偏移</td></tr><tr><td>args.flags</td><td>无需填充，由内核填写，表示行为标志</td></tr><tr><td>args.progress</td><td>无需填充，由内核填写，记录 scrub 的错误或进度信息，具体请参考<a href="#btrfs_ioctl_scrub_args"> struct btrfs_scrub_progress</a></td></tr></tbody></table><h2 id="btrfs_ioc_dev_info"><a class="anchor" href="#btrfs_ioc_dev_info">#</a> BTRFS_IOC_DEV_INFO</h2><p>获取指定 Btrfs 设备的基本信息（设备 ID、使用空间、总空间、UUID、挂载路径等）。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_dev_info_args">struct btrfs_ioctl_dev_info_args</a></td></tr><tr><td>args.devid</td><td>指定设备 ID</td></tr><tr><td>args.uuid</td><td>指定设备的 UUID，若 uuid 不为全零，就使用 uuid 查找；否则就使用 devid 查找</td></tr><tr><td>args.bytes_used</td><td>无需填充，由内核填写，表示设备已使用了多少字节</td></tr><tr><td>args.total_bytes</td><td>无需填充，由内核填写，表示设备总可用字节数</td></tr><tr><td>args.fsid</td><td>无需填充，由内核填写，表示文件系统的唯一标识符（此字段在内核 v6.3 中引入）</td></tr><tr><td>args.path</td><td>无需填充，由内核填写，表示设备的挂载路径（或设备名称）</td></tr></tbody></table><h2 id="btrfs_ioc_encoded_read"><a class="anchor" href="#btrfs_ioc_encoded_read">#</a> BTRFS_IOC_ENCODED_READ</h2><p>以用户指定的格式（可能包括压缩）从 Btrfs 文件系统中读取一个数据范围，并将其写入用户空间的 iovec 缓冲区中，这个读取是按块读取原始数据的。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>要读取的文件的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_encoded_io_args">struct btrfs_ioctl_encoded_io_args</a></td></tr><tr><td>args.iov</td><td>用户空间 iovec 数组地址，用于接收数据</td></tr><tr><td>args.iovcnt</td><td>iovec 数组的数量</td></tr><tr><td>args.offset</td><td>文件偏移</td></tr><tr><td>args.flags</td><td>目前必须为 0</td></tr><tr><td>args.len</td><td>要读取的长度</td></tr><tr><td>args.unencoded_len</td><td>未编码（例如解密、解压后）的数据长度</td></tr><tr><td>args.unencoded_offset</td><td>从未编码数据首字节到文件中逻辑数据首字节的偏移</td></tr><tr><td>args.compression</td><td>返回压缩算法类型，类型参考<a href="#btrfs_ioctl_encoded_io_args"> BTRFS_ENCODED_IO_COMPRESSION_*</a></td></tr><tr><td>args.encryption</td><td>目前必须是 <code>BTRFS_ENCODED_IO_ENCRYPTION_NONE</code></td></tr><tr><td>args.reserved</td><td>保留项</td></tr></tbody></table><h2 id="btrfs_ioc_encoded_write"><a class="anchor" href="#btrfs_ioc_encoded_write">#</a> BTRFS_IOC_ENCODED_WRITE</h2><p>向文件中写入已编码（通常压缩过）的原始数据块，常用于备份恢复、数据迁移等低层次的操作。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>要写入的文件的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_encoded_io_args">struct btrfs_ioctl_encoded_io_args</a></td></tr><tr><td>args.iov</td><td>用户空间 iovec 数组地址，用于写入数据</td></tr><tr><td>args.iovcnt</td><td>iovec 数组的数量</td></tr><tr><td>args.offset</td><td>文件偏移，指定从何处开始写，必须扇区对齐</td></tr><tr><td>args.flags</td><td>目前必须为 0</td></tr><tr><td>args.len</td><td>要写入的逻辑数据长度（解压后的大小），必须扇区对齐</td></tr><tr><td>args.unencoded_len</td><td>未编码（例如解密、解压后）的数据长度，必须小于 128KB（未来可能扩展）</td></tr><tr><td>args.unencoded_offset</td><td>从未编码数据首字节到文件中逻辑数据首字节的偏移</td></tr><tr><td>args.compression</td><td>目前必须为 <code>BTRFS_ENCODED_IO_COMPRESSION_NONE</code></td></tr><tr><td>args.encryption</td><td>目前必须是 <code>BTRFS_ENCODED_IO_ENCRYPTION_NONE</code></td></tr><tr><td>args.reserved</td><td>保留项，必须为 0</td></tr></tbody></table><h2 id="btrfs_ioc_get_subvol_rootref"><a class="anchor" href="#btrfs_ioc_get_subvol_rootref">#</a> BTRFS_IOC_GET_SUBVOL_ROOTREF</h2><p>查询包含当前 inode 的子卷（subvolume）所对应的 <code>ROOTREF</code> 信息，但不返回子卷名称。</p><blockquote><p>Btrfs 通过 “引用（root ref）” 来记录和管理子卷之间的关系，其定义为一组键值对（key-value）：</p><ul><li><p>key 的类型为 struct btrfs_key；</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//btrfs_key 是 btrfs 的一个通用核心结构，当其作为 root ref 项的 key 时，其 type 取值只能为注释中的两种。</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_key</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	__u64 objectid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	__u8 type<span class="token punctuation">;</span> <span class="token comment">// BTRFS_ROOT_REF_KEY 或 BTRFS_ROOT_BACKREF_KEY</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__u64 offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p>value 的类型为 struct btrfs_root_ref；</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"> * this is used for both forward and backward root refs</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">btrfs_root_ref</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	__le64 dirid<span class="token punctuation">;</span>    <span class="token comment">// 父目录 Inode</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	__le64 sequence<span class="token punctuation">;</span> <span class="token comment">// 在父目录中的目录索引</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	__le16 name_len<span class="token punctuation">;</span> <span class="token comment">// 引用该子卷的目录项的名称长度</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/* 实际的名称字符串紧随其后（变长数据） */</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul><p>当新创建一个子卷 / 快照时，会创建两个 <code>ROOT REF</code> 项，他们的作用是便于快速识别某个子卷或快照的父目录。每当创建一个子卷时，系统会创建两个 <code>ROOT REF</code> 项（一个用于<strong>前向引用（parent → child）</strong>，一个用于<strong>反向引用（child → parent）</strong>）。<strong>前向引用</strong>可以让我们快速定位子卷在目录中的挂载位置（即该子卷是在哪个目录下创建的），这在执行递归快照等操作时非常有用。<strong>反向引用</strong>则用于帮助恢复丢失的快照。</p><p>这两个 <code>ROOT REF</code> 项的 <code>key</code> 的字段含义是不同的，当代表前向引用时，key 字段的含义如下：</p><ul><li>key.objectid = 父子卷的 id</li><li>key.type = BTRFS_ROOT_REF_KEY</li><li>key.offset = 新创建的子卷 / 快照的 id</li></ul><p>当代表反向引用时，key 字段的含义如下：</p><ul><li>key.objectid = 新创建的子卷 / 快照的 id</li><li>key.type = BTRFS_ROOT_REF_KEY</li><li>key.offset = 父子卷的 id</li></ul></blockquote><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>指定子卷（或快照）内的任意文件或目录 的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_get_subvol_rootref_args">struct btrfs_ioctl_get_subvol_rootref_args</a></td></tr><tr><td>args.min_treeid</td><td>指定要搜索的 rootref 的最小 treeid，可用于分页搜索，执行后该项将替换为搜索的最后一个子树 ID， 这样就可以用该项执行继续搜索。</td></tr><tr><td>args.rootref.treeid</td><td>无需填充，由内核填写，表示当前子卷引用的子卷 id</td></tr><tr><td>args.rootref.dirid</td><td>无需填充，由内核填写，表示当前子卷引用的子卷的父目录 Inode</td></tr><tr><td>args.num_items</td><td>无需填充，由内核填写，表示找到的项的数量</td></tr></tbody></table><h2 id="btrfs_ioc_ino_lookup_user"><a class="anchor" href="#btrfs_ioc_ino_lookup_user">#</a> BTRFS_IOC_INO_LOOKUP_USER</h2><p>在用户态安全地获取某个 inode 的路径信息，专为 <strong>非特权用户</strong>（unprivileged user）设计，主要用于让用户程序安全地查询某个 inode 在文件系统中的路径。相比于 <code>ino_lookup ioctl</code> 的区别如下：</p><ol><li><p>会调用 <code>inode_permission()</code> 检查路径构建过程中的执行权限（ <code>EXEC</code> ）和读取权限（ <code>READ</code> ），没有权限就返回 <code>-EACCES</code> 。</p></li><li><p>路径的起点必须是打开的 fd 所指的 inode，构造路径只能在此子树中进行。如果路径跳出了这个范围（不是此目录下的某项），也返回 <code>-EACCES</code> 。</p></li><li><p>不仅查 inode 的路径，也会查到它所属的子卷的名字。</p></li></ol><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>包含待搜索 inode 的目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_ino_lookup_user_args">struct btrfs_ioctl_ino_lookup_user_args</a></td></tr><tr><td>args.dirid</td><td>要查询的 inode 编号</td></tr><tr><td>args.treeid</td><td>待查询的 inode 所在子卷的 tree ID</td></tr><tr><td><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></td><td>无需填充，由内核填写，inode 所在的子卷名称</td></tr><tr><td>args.path</td><td>无需填充，由内核填写，从调用该 ioctl 的目录到指定 dirid 所构建的路径</td></tr></tbody></table><h2 id="btrfs_ioc_balance_v2"><a class="anchor" href="#btrfs_ioc_balance_v2">#</a> BTRFS_IOC_BALANCE_V2</h2><p>触发或恢复一次平衡（balance）操作，同一时间只能有一个 balance 操作正在执行。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中的任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_balance_args">struct btrfs_ioctl_balance_args</a></td></tr><tr><td>args.flags</td><td>控制标志，控制 balance 的具体行为，具体请参考<a href="#btrfs_ioctl_balance_args"> BTRFS_BALANCE_*</a></td></tr><tr><td>args.state</td><td>无需填充，由内核填写，有三种状态，具体请参考<a href="#btrfs_ioctl_balance_args"> BTRFS_BALANCE_STATE_*</a></td></tr><tr><td>args.data</td><td>控制针对用户数据块（data）的 balance 行为，具体请参考<a href="#btrfs_ioctl_balance_args"> struct btrfs_balance_args</a></td></tr><tr><td>args.meta</td><td>控制针对元数据块（metadata）的 balance 行为，具体请参考<a href="#btrfs_ioctl_balance_args"> struct btrfs_balance_args</a></td></tr><tr><td>args.sys</td><td>控制针对系统块（system）的 balance 行为，具体请参考<a href="#btrfs_ioctl_balance_args"> struct btrfs_balance_args</a></td></tr><tr><td>args.stat</td><td>无需填充，由内核填写，表示 balance 的进度信息</td></tr></tbody></table><h2 id="btrfs_ioc_balance_ctl"><a class="anchor" href="#btrfs_ioc_balance_ctl">#</a> BTRFS_IOC_BALANCE_CTL</h2><p>暂停或取消当前正在运行的 balance 操作的状态</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中的任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td>int，只能是两种值 <code>BTRFS_BALANCE_CTL_PAUSE</code> 或 <code>BTRFS_BALANCE_CTL_CANCEL</code></td></tr></tbody></table><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* balance control ioctl modes */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_CTL_PAUSE</span>   <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTRFS_BALANCE_CTL_CANCEL</span>  <span class="token expression"><span class="token number">2</span></span></span></pre></td></tr></table></figure><h2 id="btrfs_ioc_balance_progress"><a class="anchor" href="#btrfs_ioc_balance_progress">#</a> BTRFS_IOC_BALANCE_PROGRESS</h2><p>获取当前 balance 操作的进度</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中的任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_balance_args">struct btrfs_ioctl_balance_args</a></td></tr><tr><td>args.flags</td><td>无需填充，由内核填写，控制标志，具体请参考<a href="#btrfs_ioctl_balance_args"> BTRFS_BALANCE_*</a></td></tr><tr><td>args.state</td><td>无需填充，由内核填写，返回当前 balance 状态，具体请参考<a href="#btrfs_ioctl_balance_args"> BTRFS_BALANCE_STATE_*</a></td></tr><tr><td>args.data</td><td>无需填充，由内核填写，返回用户数据块（data）的 balance 状态，具体请参考<a href="#btrfs_ioctl_balance_args"> struct btrfs_balance_args</a></td></tr><tr><td>args.meta</td><td>无需填充，由内核填写，返回元数据块（metadata）的 balance 状态，具体请参考<a href="#btrfs_ioctl_balance_args"> struct btrfs_balance_args</a></td></tr><tr><td>args.sys</td><td>无需填充，由内核填写，返回系统块（system）的 balance 状态，具体请参考<a href="#btrfs_ioctl_balance_args"> struct btrfs_balance_args</a></td></tr><tr><td>args.stat</td><td>无需填充，由内核填写，表示 balance 的进度信息</td></tr></tbody></table><h2 id="btrfs_ioc_ino_paths"><a class="anchor" href="#btrfs_ioc_ino_paths">#</a> BTRFS_IOC_INO_PATHS</h2><p>给定一个 inode 编号，查找它在文件系统中所有对应的路径（从根到该 inode 的路径名），由于多个目录项可能指向同一个 inode（如硬链接），所以该函数可能会返回多个路径。</p><p>需要权限：CAP_DAC_READ_SEARCH</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_ino_path_args">struct btrfs_ioctl_ino_path_args</a></td></tr><tr><td>args.inum</td><td>要查找路径的 inode 编号</td></tr><tr><td>args.size</td><td>用户分配的输出缓冲区大小</td></tr><tr><td>args.reserved</td><td>保留</td></tr><tr><td>args.fspath</td><td>传入一个 buffer 用于接收数据，其实是一个 <a href="#btrfs_ioctl_ino_path_args">struct btrfs_data_container</a> 指针，存储了路径信息（一系列偏移值，可以在偏移值处找到对应路径字符串）</td></tr></tbody></table><h2 id="btrfs_ioc_logical_ino"><a class="anchor" href="#btrfs_ioc_logical_ino">#</a> BTRFS_IOC_LOGICAL_INO</h2><p>根据物理地址（logical block address）反查出使用这个地址的文件 inode。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_logical_ino_args">struct btrfs_ioctl_logical_ino_args</a></td></tr><tr><td>args.logical</td><td>要查询的逻辑地址</td></tr><tr><td>args.size</td><td>传入 buffer 的大小</td></tr><tr><td>args.reserved</td><td>保留，目前必须为 0</td></tr><tr><td>args.flags</td><td>该字段会被忽略，仅 <a href="#btrfs_ioc_logical_ino_v2">BTRFS_IOC_LOGICAL_INO_V2</a> 支持该参数</td></tr><tr><td>args.inodes</td><td>传入一个 buffer 用于接收数据，其实是一个 <a href="#btrfs_ioctl_ino_path_args">struct btrfs_data_container</a> 指针，存储查询结果</td></tr></tbody></table><h2 id="btrfs_ioc_set_received_subvol"><a class="anchor" href="#btrfs_ioc_set_received_subvol">#</a> BTRFS_IOC_SET_RECEIVED_SUBVOL</h2><p>设置子卷的 “接收元信息”，例如该子卷是哪个父子卷衍生的、什么时候发送 / 接收的等等信息。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>指向接收子卷目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_received_subvol_args">struct btrfs_ioctl_received_subvol_args</a></td></tr><tr><td>args.uuid</td><td>发送方子卷的 uuid</td></tr><tr><td>args.stransid</td><td>发送方子卷创建时的 transid</td></tr><tr><td>args.rtransid</td><td>无需填充，由内核填写，表示接收方的 transid（本地记录）</td></tr><tr><td>args.stime</td><td>发送方的快照创建时间</td></tr><tr><td>args.rtime</td><td>无需填充，由内核填写，表示接收方的接收时间</td></tr><tr><td>args.flags</td><td>该字段目前会被忽略，建议置 0</td></tr><tr><td>args.reserved</td><td>保留</td></tr></tbody></table><h2 id="btrfs_ioc_send"><a class="anchor" href="#btrfs_ioc_send">#</a> BTRFS_IOC_SEND</h2><p>将一个子卷快照的数据（相对于父子卷快照的增量或全量数据）发送到用户空间，以便可以传输到远程或另一个 Btrfs 文件系统上进行 <code>receive</code> 操作。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>待发送子卷根目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_send_args">struct btrfs_ioctl_send_args</a></td></tr><tr><td>args.send_fd</td><td>发送目标（用户空间进程会从这个 fd 读取快照内容）</td></tr><tr><td>args.clone_sources_count</td><td>克隆源快照的数量</td></tr><tr><td>args.clone_sources</td><td>指向多个 clone 源 subvol 的 ID 列表（用于增量复制）</td></tr><tr><td>args.parent_root</td><td>父快照的 root id；0 表示是全量快照导出</td></tr><tr><td>args.flags</td><td>控制选项，参考<a href="#btrfs_ioctl_send_args"> BTRFS_SEND_FLAG_*</a></td></tr><tr><td>args.version</td><td>接口版本号</td></tr><tr><td>args.reserved</td><td>保留</td></tr></tbody></table><h2 id="btrfs_ioc_devices_ready"><a class="anchor" href="#btrfs_ioc_devices_ready">#</a> BTRFS_IOC_DEVICES_READY</h2><p>检查设备是否准备就绪。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td><code>/dev/btrfs-control</code> 的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_vol_args">struct btrfs_ioctl_vol_args</a></td></tr><tr><td>args.fd</td><td>该字段会被忽略</td></tr><tr><td><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span></td><td>待检查的设备名称，例如： <code>/dev/sdb</code></td></tr></tbody></table><h2 id="btrfs_ioc_quota_ctl"><a class="anchor" href="#btrfs_ioc_quota_ctl">#</a> BTRFS_IOC_QUOTA_CTL</h2><p>提供对配额（quota）系统的启用和禁用控制。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_quota_ctl_args">struct btrfs_ioctl_quota_ctl_args</a></td></tr><tr><td>args.cmd</td><td>实际执行的指令，包括启用、禁止等，具体请参考<a href="#btrfs_ioctl_quota_ctl_args"> BTRFS_QUOTA_CTL_ENABLE*</a></td></tr><tr><td>args.status</td><td>该字段会被忽略</td></tr></tbody></table><h2 id="btrfs_ioc_qgroup_assign"><a class="anchor" href="#btrfs_ioc_qgroup_assign">#</a> BTRFS_IOC_QGROUP_ASSIGN</h2><p>在两个 quota group（配额组）之间建立或删除父子关系，以便子 qgroup 的空间使用能正确累加到父 qgroup 中，实现 “层次配额” 的管理。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_qgroup_assign_args">struct btrfs_ioctl_qgroup_assign_args</a></td></tr><tr><td>args.assign</td><td>非零：添加关系，零：删除关系</td></tr><tr><td>args.src</td><td>子配额组 ID</td></tr><tr><td>args.dst</td><td>父配额组 ID</td></tr></tbody></table><h2 id="btrfs_ioc_qgroup_create"><a class="anchor" href="#btrfs_ioc_qgroup_create">#</a> BTRFS_IOC_QGROUP_CREATE</h2><p>创建或删除一个配额组（quota group）。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_qgroup_create_args">struct btrfs_ioctl_qgroup_create_args</a></td></tr><tr><td>args.create</td><td>非零：创建，零：删除</td></tr><tr><td>args.qgroupid</td><td>配额组 ID</td></tr></tbody></table><h2 id="btrfs_ioc_qgroup_limit"><a class="anchor" href="#btrfs_ioc_qgroup_limit">#</a> BTRFS_IOC_QGROUP_LIMIT</h2><p>为某个 qgroup 设置配额限制，需要先开启配额功能。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>要设置配额的子卷目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_qgroup_limit_args">struct btrfs_ioctl_qgroup_limit_args</a></td></tr><tr><td>args.qgroupid</td><td>0，表示 “当前子卷”，也就是用户打开的这个 <code>file</code> 所在的子卷；否则就使用用户提供的 <code>qgroupid</code></td></tr><tr><td>args.lim</td><td>配额限制参数，具体请参考<a href="#btrfs_ioctl_vol_args_v2"> struct btrfs_qgroup_limit</a></td></tr></tbody></table><h2 id="btrfs_ioc_quota_rescan"><a class="anchor" href="#btrfs_ioc_quota_rescan">#</a> BTRFS_IOC_QUOTA_RESCAN</h2><p>对整个文件系统重新扫描以更新 qgroup（配额组）信息，确保它们是最新和一致的，需要先开启配额功能。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_quota_rescan_args">struct btrfs_ioctl_quota_rescan_args</a></td></tr><tr><td>args.flags</td><td>必须为 0</td></tr><tr><td>args.progress</td><td>该字段会被忽略</td></tr></tbody></table><h2 id="btrfs_ioc_quota_rescan_status"><a class="anchor" href="#btrfs_ioc_quota_rescan_status">#</a> BTRFS_IOC_QUOTA_RESCAN_STATUS</h2><p>获取当前的 qgroup rescan（重新扫描）状态。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_quota_rescan_args">struct btrfs_ioctl_quota_rescan_args</a></td></tr><tr><td>args.flags</td><td>无需填充，由内核填写，1 表示 “正在扫描”，0 表示 “没有扫描正在进行”</td></tr><tr><td>args.progress</td><td>无需填充，由内核填写，表示当前扫描状态，对应 objectid</td></tr></tbody></table><h2 id="btrfs_ioc_quota_rescan_wait"><a class="anchor" href="#btrfs_ioc_quota_rescan_wait">#</a> BTRFS_IOC_QUOTA_RESCAN_WAIT</h2><p>等待 quota rescan （配额重新扫描）完成。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td>NULL</td></tr></tbody></table><h2 id="btrfs_ioc_get_dev_stats"><a class="anchor" href="#btrfs_ioc_get_dev_stats">#</a> BTRFS_IOC_GET_DEV_STATS</h2><p><strong>获取块设备（device）的统计信息</strong>，比如 I/O 错误次数，同时也可以重置这些统计数据。</p><p>重置操作需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_get_dev_stats">struct btrfs_ioctl_get_dev_stats</a></td></tr><tr><td>args.devid</td><td>要查询的设备 ID</td></tr><tr><td>args.nr_items</td><td>输入：请求的统计项数量，输出：返回实际填充的数量</td></tr><tr><td>args.flags</td><td>控制标志，例如是否重置统计数据</td></tr><tr><td>args.values</td><td>无需填充，由内核填写，输出各项信息，具体请参考<a href="#btrfs_ioctl_get_dev_stats"> BTRFS_DEV_STAT_*_ERRS</a></td></tr></tbody></table><h2 id="btrfs_ioc_dev_replace"><a class="anchor" href="#btrfs_ioc_dev_replace">#</a> BTRFS_IOC_DEV_REPLACE</h2><p>在 Btrfs 文件系统中进行设备替换（device replace）操作，包括启动、查询状态、取消设备替换。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_dev_replace_args">struct btrfs_ioctl_dev_replace_args</a></td></tr><tr><td>args.cmd</td><td>要执行的设备替换操作：start、status、cancel 等</td></tr><tr><td>args.result</td><td>无需填充，由内核填写，表示执行结果，具体请参考<a href="#btrfs_ioctl_dev_replace_args"> BTRFS_IOCTL_DEV_REPLACE_RESULT_*</a></td></tr><tr><td>args.start (union)</td><td>若执行的是开始（start）操作，则需要填充替换设备的信息，结构为<a href="#btrfs_ioctl_dev_replace_args"> btrfs_ioctl_dev_replace_start_params</a></td></tr><tr><td>args.status (union)</td><td>若执行的是查询（status）操作，则该项由内核填充为状态信息，结构为<a href="#btrfs_ioctl_dev_replace_args"> btrfs_ioctl_dev_replace_status_params</a></td></tr></tbody></table><h2 id="btrfs_ioc_get_features"><a class="anchor" href="#btrfs_ioc_get_features">#</a> BTRFS_IOC_GET_FEATURES</h2><p>获取当前挂载文件系统支持的 feature 标志。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_feature_flags">struct btrfs_ioctl_feature_flags</a></td></tr><tr><td>args.compat_flags</td><td>无需填写，由内核填充，表示兼容特性，不支持这些特性的内核可以安全忽略这些特性</td></tr><tr><td>args.compat_ro_flags</td><td>无需填写，由内核填充，表示只读兼容特性，不支持这些特性的内核只能挂载为只读</td></tr><tr><td>args.incompat_flags</td><td>无需填写，由内核填充，表示不兼容特性，不支持这些特性的内核无法挂载</td></tr></tbody></table><p>上述三个 flag 的可选值请参考 <a href="#btrfs_ioctl_feature_flags">struct btrfs_ioctl_feature_flags</a> 。</p><h2 id="btrfs_ioc_set_features"><a class="anchor" href="#btrfs_ioc_set_features">#</a> BTRFS_IOC_SET_FEATURES</h2><p>开启或关闭某些文件系统特性标志（features flags）。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_feature_flags">struct btrfs_ioctl_feature_flags</a>[2]</td></tr><tr><td>args[0]</td><td>要修改的标志位</td></tr><tr><td>args[1]</td><td>掩码，表示用户想保留的位（其他位会被清空）</td></tr></tbody></table><p>其中每个参数都是 <a href="#btrfs_ioctl_feature_flags">struct btrfs_ioctl_feature_flags</a> 类型，flags 含义可以参考 <a href="#btrfs_ioc_get_features">BTRFS_IOC_GET_FEATURES</a>。</p><h2 id="btrfs_ioc_get_supported_features"><a class="anchor" href="#btrfs_ioc_get_supported_features">#</a> BTRFS_IOC_GET_SUPPORTED_FEATURES</h2><p>获取内核支持的特性（features）。</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_feature_flags">struct btrfs_ioctl_feature_flags</a>[2]</td></tr><tr><td>args[0]</td><td>无需填写，由内核填充，表示哪些特性是当前内核支持的</td></tr><tr><td>args[1]</td><td>无需填写，由内核填充，表示哪些特性可以安全启用（set）</td></tr><tr><td>args[1]</td><td>无需填写，由内核填充，表示哪些特性可以安全关闭（clear）</td></tr></tbody></table><h2 id="btrfs_ioc_rm_dev_v2"><a class="anchor" href="#btrfs_ioc_rm_dev_v2">#</a> BTRFS_IOC_RM_DEV_V2</h2><p>（<strong>4.7 版本引入</strong>） 删除一个设备（比如一个 <code>btrfs</code> 多设备卷中的某个设备），或取消当前的设备删除操作。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件或目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_vol_args_V2">struct btrfs_ioctl_vol_args_V2</a></td></tr><tr><td>args.fd</td><td>该字段目前会被忽略</td></tr><tr><td>args.transid</td><td>该字段目前会被忽略</td></tr><tr><td>args.flags</td><td>控制标志，只能是空或 <code>BTRFS_DEVICE_SPEC_BY_ID</code></td></tr><tr><td>args.size</td><td>该字段目前会被忽略</td></tr><tr><td>args.qgroup_inherit</td><td>该字段目前会被忽略</td></tr><tr><td><span class="exturl" data-url="aHR0cDovL2FyZ3MubmFtZQ==">args.name</span> (union)</td><td><code>&quot;cancel&quot;</code> ：取消当前设备删除操作；或是要删除设备的路径</td></tr><tr><td>args.devid (union)</td><td>要删除的设备 id，使能该项需要 flag 为 <code>BTRFS_DEVICE_SPEC_BY_ID</code></td></tr><tr><td>args.subvolid (union)</td><td>该项目前会被忽略</td></tr></tbody></table><h2 id="btrfs_ioc_logical_ino_v2"><a class="anchor" href="#btrfs_ioc_logical_ino_v2">#</a> BTRFS_IOC_LOGICAL_INO_V2</h2><p>将某个逻辑地址（logical address）反查出它所属于的 inode（也就是哪个文件使用了这个物理块）。</p><p>需要权限：CAP_SYS_ADMIN</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>ioctl fd</td><td>Btrfs 文件系统中任意文件 / 目录的文件描述符</td></tr><tr><td>ioctl args</td><td><a href="#btrfs_ioctl_logical_ino_args">struct btrfs_ioctl_logical_ino_args</a></td></tr><tr><td>args.logical</td><td>要查询的逻辑地址</td></tr><tr><td>args.size</td><td>传入 buffer 的大小</td></tr><tr><td>args.reserved</td><td>保留，目前必须为 0</td></tr><tr><td>args.flags</td><td>控制标志，目前只能是 <code>BTRFS_LOGICAL_INO_ARGS_IGNORE_OFFSET</code> ，用于控制是否忽略 page offset。</td></tr><tr><td>args.inodes</td><td>传入一个 buffer 用于接收数据，其实是一个 <a href="#btrfs_ioctl_ino_path_args">struct btrfs_data_container</a> 指针，存储查询结果</td></tr></tbody></table><p>V2 版本允许根据 logical address 查找整个 block（或 extents），而不仅仅是精确 offset 对应的那一块。这在某些情况很有用，比如你只知道大致逻辑地址，但不是 page-aligned 或不是精确的起始偏移。</p><br><div class="tags"><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag"><i class="ic i-tag"></i> 操作系统</a> <a href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" rel="tag"><i class="ic i-tag"></i> 文件系统</a> <a href="/tags/Btrfs/" rel="tag"><i class="ic i-tag"></i> Btrfs</a> <a href="/tags/ioctl/" rel="tag"><i class="ic i-tag"></i> ioctl</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2025-04-17 09:30:09" itemprop="dateModified" datetime="2025-04-17T09:30:09+08:00">2025-04-17</time> </span><span id="os/fs/Btrfs_ioctl/" class="item leancloud_visitors" data-flag-title="Btrfs ioctl 手册" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/wechatpay.png" alt="Gality 微信支付"><p>微信支付</p></div><div><img data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/alipay.png" alt="Gality 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Gality <i class="ic i-at"><em>@</em></i>藏器于身</li><li class="link"><strong>本文链接：</strong> <a href="https://gality.cn/os/fs/Btrfs_ioctl/" title="Btrfs ioctl 手册">https://gality.cn/os/fs/Btrfs_ioctl/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/misc/trail-and-error/flex-bison-print-error/" itemprop="url" rel="prev" data-background-image="http:&#x2F;&#x2F;imgcdn.gality.cn&#x2F;blog&#x2F;brqjlt.jpg" title="C++ Flex&#x2F;Bison 更好的错误处理"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 踩坑</span><h3>C++ Flex/Bison 更好的错误处理</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%9F%E8%A7%88"><span class="toc-number">1.</span> <span class="toc-text">速览</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AE%9A%E4%B9%89"><span class="toc-number">2.</span> <span class="toc-text">数据结构与定义</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_vol_args"><span class="toc-number">2.1.</span> <span class="toc-text">btrfs_ioctl_vol_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_vol_args_v2"><span class="toc-number">2.2.</span> <span class="toc-text">btrfs_ioctl_vol_args_v2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_get_subvol_info_args"><span class="toc-number">2.3.</span> <span class="toc-text">btrfs_ioctl_get_subvol_info_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_received_subvol_args"><span class="toc-number">2.4.</span> <span class="toc-text">btrfs_ioctl_received_subvol_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_fs_info_args"><span class="toc-number">2.5.</span> <span class="toc-text">btrfs_ioctl_fs_info_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_ino_lookup_args"><span class="toc-number">2.6.</span> <span class="toc-text">btrfs_ioctl_ino_lookup_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_subvol_wait"><span class="toc-number">2.7.</span> <span class="toc-text">btrfs_ioctl_subvol_wait</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_clone_range_args"><span class="toc-number">2.8.</span> <span class="toc-text">btrfs_ioctl_clone_range_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_defrag_range_args"><span class="toc-number">2.9.</span> <span class="toc-text">btrfs_ioctl_defrag_range_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_search_args"><span class="toc-number">2.10.</span> <span class="toc-text">btrfs_ioctl_search_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_search_args_v2"><span class="toc-number">2.11.</span> <span class="toc-text">btrfs_ioctl_search_args_v2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_space_args"><span class="toc-number">2.12.</span> <span class="toc-text">btrfs_ioctl_space_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_scrub_args"><span class="toc-number">2.13.</span> <span class="toc-text">btrfs_ioctl_scrub_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_dev_info_args"><span class="toc-number">2.14.</span> <span class="toc-text">btrfs_ioctl_dev_info_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_balance_args"><span class="toc-number">2.15.</span> <span class="toc-text">btrfs_ioctl_balance_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_ino_path_args"><span class="toc-number">2.16.</span> <span class="toc-text">btrfs_ioctl_ino_path_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_logical_ino_args"><span class="toc-number">2.17.</span> <span class="toc-text">btrfs_ioctl_logical_ino_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_send_args"><span class="toc-number">2.18.</span> <span class="toc-text">btrfs_ioctl_send_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_quota_ctl_args"><span class="toc-number">2.19.</span> <span class="toc-text">btrfs_ioctl_quota_ctl_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_qgroup_assign_args"><span class="toc-number">2.20.</span> <span class="toc-text">btrfs_ioctl_qgroup_assign_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_qgroup_create_args"><span class="toc-number">2.21.</span> <span class="toc-text">btrfs_ioctl_qgroup_create_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_qgroup_limit_args"><span class="toc-number">2.22.</span> <span class="toc-text">btrfs_ioctl_qgroup_limit_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_quota_rescan_args"><span class="toc-number">2.23.</span> <span class="toc-text">btrfs_ioctl_quota_rescan_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_get_dev_stats"><span class="toc-number">2.24.</span> <span class="toc-text">btrfs_ioctl_get_dev_stats</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_dev_replace_args"><span class="toc-number">2.25.</span> <span class="toc-text">btrfs_ioctl_dev_replace_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_same_args"><span class="toc-number">2.26.</span> <span class="toc-text">btrfs_ioctl_same_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_feature_flags"><span class="toc-number">2.27.</span> <span class="toc-text">btrfs_ioctl_feature_flags</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_get_subvol_rootref_args"><span class="toc-number">2.28.</span> <span class="toc-text">btrfs_ioctl_get_subvol_rootref_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_ino_lookup_user_args"><span class="toc-number">2.29.</span> <span class="toc-text">btrfs_ioctl_ino_lookup_user_args</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioctl_encoded_io_args"><span class="toc-number">2.30.</span> <span class="toc-text">btrfs_ioctl_encoded_io_args</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E6%8F%8F%E8%BF%B0"><span class="toc-number">3.</span> <span class="toc-text">详细描述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_snap_create_v2"><span class="toc-number">3.1.</span> <span class="toc-text">BTRFS_IOC_SNAP_CREATE_V2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_scan_dev"><span class="toc-number">3.2.</span> <span class="toc-text">BTRFS_IOC_SCAN_DEV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_sync"><span class="toc-number">3.3.</span> <span class="toc-text">BTRFS_IOC_SYNC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_add_dev"><span class="toc-number">3.4.</span> <span class="toc-text">BTRFS_IOC_ADD_DEV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_rm_dev"><span class="toc-number">3.5.</span> <span class="toc-text">BTRFS_IOC_RM_DEV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_ino_lookup"><span class="toc-number">3.6.</span> <span class="toc-text">BTRFS_IOC_INO_LOOKUP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_default_subvol"><span class="toc-number">3.7.</span> <span class="toc-text">BTRFS_IOC_DEFAULT_SUBVOL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_subvol_create_v2"><span class="toc-number">3.8.</span> <span class="toc-text">BTRFS_IOC_SUBVOL_CREATE_V2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_subvol_getflags"><span class="toc-number">3.9.</span> <span class="toc-text">BTRFS_IOC_SUBVOL_GETFLAGS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_subvol_setflags"><span class="toc-number">3.10.</span> <span class="toc-text">BTRFS_IOC_SUBVOL_SETFLAGS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_get_fslabel"><span class="toc-number">3.11.</span> <span class="toc-text">BTRFS_IOC_GET_FSLABEL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_set_fslabel"><span class="toc-number">3.12.</span> <span class="toc-text">BTRFS_IOC_SET_FSLABEL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_fs_info"><span class="toc-number">3.13.</span> <span class="toc-text">BTRFS_IOC_FS_INFO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_get_subvol_info"><span class="toc-number">3.14.</span> <span class="toc-text">BTRFS_IOC_GET_SUBVOL_INFO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_snap_destroy_v2"><span class="toc-number">3.15.</span> <span class="toc-text">BTRFS_IOC_SNAP_DESTROY_V2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_subvol_sync_wait"><span class="toc-number">3.16.</span> <span class="toc-text">BTRFS_IOC_SUBVOL_SYNC_WAIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_defrag"><span class="toc-number">3.17.</span> <span class="toc-text">BTRFS_IOC_DEFRAG</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_defrag_range"><span class="toc-number">3.18.</span> <span class="toc-text">BTRFS_IOC_DEFRAG_RANGE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_resize"><span class="toc-number">3.19.</span> <span class="toc-text">BTRFS_IOC_RESIZE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_clone"><span class="toc-number">3.20.</span> <span class="toc-text">BTRFS_IOC_CLONE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_clone_range"><span class="toc-number">3.21.</span> <span class="toc-text">BTRFS_IOC_CLONE_RANGE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_file_extent_same"><span class="toc-number">3.22.</span> <span class="toc-text">BTRFS_IOC_FILE_EXTENT_SAME</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_tree_search"><span class="toc-number">3.23.</span> <span class="toc-text">BTRFS_IOC_TREE_SEARCH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_tree_search_v2"><span class="toc-number">3.24.</span> <span class="toc-text">BTRFS_IOC_TREE_SEARCH_V2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_space_info"><span class="toc-number">3.25.</span> <span class="toc-text">BTRFS_IOC_SPACE_INFO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_start_sync"><span class="toc-number">3.26.</span> <span class="toc-text">BTRFS_IOC_START_SYNC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_wait_sync"><span class="toc-number">3.27.</span> <span class="toc-text">BTRFS_IOC_WAIT_SYNC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_scrub"><span class="toc-number">3.28.</span> <span class="toc-text">BTRFS_IOC_SCRUB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_scrub_cancel"><span class="toc-number">3.29.</span> <span class="toc-text">BTRFS_IOC_SCRUB_CANCEL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_scrub_progress"><span class="toc-number">3.30.</span> <span class="toc-text">BTRFS_IOC_SCRUB_PROGRESS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_dev_info"><span class="toc-number">3.31.</span> <span class="toc-text">BTRFS_IOC_DEV_INFO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_encoded_read"><span class="toc-number">3.32.</span> <span class="toc-text">BTRFS_IOC_ENCODED_READ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_encoded_write"><span class="toc-number">3.33.</span> <span class="toc-text">BTRFS_IOC_ENCODED_WRITE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_get_subvol_rootref"><span class="toc-number">3.34.</span> <span class="toc-text">BTRFS_IOC_GET_SUBVOL_ROOTREF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_ino_lookup_user"><span class="toc-number">3.35.</span> <span class="toc-text">BTRFS_IOC_INO_LOOKUP_USER</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_balance_v2"><span class="toc-number">3.36.</span> <span class="toc-text">BTRFS_IOC_BALANCE_V2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_balance_ctl"><span class="toc-number">3.37.</span> <span class="toc-text">BTRFS_IOC_BALANCE_CTL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_balance_progress"><span class="toc-number">3.38.</span> <span class="toc-text">BTRFS_IOC_BALANCE_PROGRESS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_ino_paths"><span class="toc-number">3.39.</span> <span class="toc-text">BTRFS_IOC_INO_PATHS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_logical_ino"><span class="toc-number">3.40.</span> <span class="toc-text">BTRFS_IOC_LOGICAL_INO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_set_received_subvol"><span class="toc-number">3.41.</span> <span class="toc-text">BTRFS_IOC_SET_RECEIVED_SUBVOL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_send"><span class="toc-number">3.42.</span> <span class="toc-text">BTRFS_IOC_SEND</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_devices_ready"><span class="toc-number">3.43.</span> <span class="toc-text">BTRFS_IOC_DEVICES_READY</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_quota_ctl"><span class="toc-number">3.44.</span> <span class="toc-text">BTRFS_IOC_QUOTA_CTL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_qgroup_assign"><span class="toc-number">3.45.</span> <span class="toc-text">BTRFS_IOC_QGROUP_ASSIGN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_qgroup_create"><span class="toc-number">3.46.</span> <span class="toc-text">BTRFS_IOC_QGROUP_CREATE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_qgroup_limit"><span class="toc-number">3.47.</span> <span class="toc-text">BTRFS_IOC_QGROUP_LIMIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_quota_rescan"><span class="toc-number">3.48.</span> <span class="toc-text">BTRFS_IOC_QUOTA_RESCAN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_quota_rescan_status"><span class="toc-number">3.49.</span> <span class="toc-text">BTRFS_IOC_QUOTA_RESCAN_STATUS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_quota_rescan_wait"><span class="toc-number">3.50.</span> <span class="toc-text">BTRFS_IOC_QUOTA_RESCAN_WAIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_get_dev_stats"><span class="toc-number">3.51.</span> <span class="toc-text">BTRFS_IOC_GET_DEV_STATS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_dev_replace"><span class="toc-number">3.52.</span> <span class="toc-text">BTRFS_IOC_DEV_REPLACE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_get_features"><span class="toc-number">3.53.</span> <span class="toc-text">BTRFS_IOC_GET_FEATURES</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_set_features"><span class="toc-number">3.54.</span> <span class="toc-text">BTRFS_IOC_SET_FEATURES</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_get_supported_features"><span class="toc-number">3.55.</span> <span class="toc-text">BTRFS_IOC_GET_SUPPORTED_FEATURES</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_rm_dev_v2"><span class="toc-number">3.56.</span> <span class="toc-text">BTRFS_IOC_RM_DEV_V2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#btrfs_ioc_logical_ino_v2"><span class="toc-number">3.57.</span> <span class="toc-text">BTRFS_IOC_LOGICAL_INO_V2</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/os/fs/FAT32/" rel="bookmark" title="文件系统详解 ｜ FAT32">文件系统详解 ｜ FAT32</a></li><li><a href="/os/fs/VFS/" rel="bookmark" title="Linux 文件系统模型与VFS入门">Linux 文件系统模型与VFS入门</a></li><li class="active"><a href="/os/fs/Btrfs_ioctl/" rel="bookmark" title="Btrfs ioctl手册">Btrfs ioctl手册</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Gality" data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/avatar.png"><p class="name" itemprop="name">Gality</p><div class="description" itemprop="description">安全杂记 & 日常随感</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">42</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">20</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">59</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dhbGl0eTM2OQ==" title="https:&#x2F;&#x2F;github.com&#x2F;Gality369"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <a href="https://gality.cn/about/" title="https:&#x2F;&#x2F;gality.cn&#x2F;about&#x2F;" class="item about"><i class="ic i-address-card"></i></a> <span class="exturl item email" data-url="bWFpbHRvOjQzNDQwMDcyNkBxcS5jb20=" title="mailto:434400726@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>资源</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/trail-and-error/" title="分类于 踩坑">踩坑</a></div><span><a href="/misc/trail-and-error/include-error/" title="“C&#x2F;C++找不到头文件”解决方案大全">“C/C++找不到头文件”解决方案大全</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/C/" title="分类于 C++">C++</a></div><span><a href="/misc/c++/tips1/" title="C++ ｜ 利用虚基类实现运行时多态">C++ ｜ 利用虚基类实现运行时多态</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/scientific-research/" title="分类于 科研">科研</a> <i class="ic i-angle-right"></i> <a href="/categories/scientific-research/thesis-reading/" title="分类于 论文阅读">论文阅读</a></div><span><a href="/scientific-research/thesis-reading/JANUS/" title="论文阅读｜ Fuzzing File Systems via Two-Dimensional Input Space Exploration">论文阅读｜ Fuzzing File Systems via Two-Dimensional Input Space Exploration</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/os/" title="分类于 操作系统">操作系统</a> <i class="ic i-angle-right"></i> <a href="/categories/os/fs/" title="分类于 文件系统">文件系统</a></div><span><a href="/os/fs/FAT32/" title="文件系统详解 ｜ FAT32">文件系统详解 ｜ FAT32</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/PNT/" title="分类于 PNT">PNT</a></div><span><a href="/misc/PNT/fiber-optic-and-WDM/" title="光纤通信原理与技术">光纤通信原理与技术</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ml/" title="分类于 机器学习">机器学习</a></div><span><a href="/ml/CNN/" title="CNN ｜ Network Architecture Designed for Image">CNN ｜ Network Architecture Designed for Image</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/trail-and-error/" title="分类于 踩坑">踩坑</a></div><span><a href="/misc/trail-and-error/Mac-Latex/" title="Mac下Latex论文一条龙">Mac下Latex论文一条龙</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/PNT/" title="分类于 PNT">PNT</a></div><span><a href="/misc/PNT/IRIG-B/" title="IRIG-B编码">IRIG-B编码</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ponder/" title="分类于 思考与沉淀">思考与沉淀</a></div><span><a href="/ponder/Gresham-law/" title="劣币驱逐良币 ｜ 一次网购经历的反思">劣币驱逐良币 ｜ 一次网购经历的反思</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/daily/" title="分类于 日常">日常</a></div><span><a href="/daily/DailyRecord/" title="九天揽月">九天揽月</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Gality @ Samadhi</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">338k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">10:14</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"os/fs/Btrfs_ioctl/",favicon:{show:"（●´3｀●）哎呀呀～",hide:"(´Д｀)吓死你"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/js/app.js?v=0.2.5"></script></body></html>