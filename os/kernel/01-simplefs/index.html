<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="KbCOz5IFs80bU-psVUCv9C7SOLzVWto8d7_5ZSsX7I0"><meta name="baidu-site-verification" content="codeva-KcLqIZYGXd"><link rel="alternate" type="application/rss+xml" title="藏器于身" href="https://gality.cn/rss.xml"><link rel="alternate" type="application/atom+xml" title="藏器于身" href="https://gality.cn/atom.xml"><link rel="alternate" type="application/json" title="藏器于身" href="https://gality.cn/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/css/app.css?v=0.2.5"><meta name="keywords" content="linux,kernel,filesystem,文件系统,从零开始,VFS"><link rel="canonical" href="https://gality.cn/os/kernel/01-simplefs/"><title>从零实现 FS | 最简单的文件系统 - 从 0 到 1 - 内核 - 操作系统 | Samadhi = 藏器于身 = 待时而动</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">从零实现 FS | 最简单的文件系统</h1><div class="meta"><span class="item" title="创建时间：2025-01-25 11:55:33"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2025-01-25T11:55:33+08:00">2025-01-25</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>11k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>20 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Samadhi</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="http://imgcdn.gality.cn/blog/e2h6c4.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/568rss.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/10s606.png"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/14wa89.png"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/7zx56a.jpg"></li><li class="item" data-background-image="http://imgcdn.gality.cn/blog/nikzkc.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/os/" itemprop="item" rel="index" title="分类于 操作系统"><span itemprop="name">操作系统</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/os/kernel/" itemprop="item" rel="index" title="分类于 内核"><span itemprop="name">内核</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/os/kernel/0-1/" itemprop="item" rel="index" title="分类于 从 0 到 1"><span itemprop="name">从 0 到 1</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://gality.cn/os/kernel/01-simplefs/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/avatar.png"><meta itemprop="name" content="Gality"><meta itemprop="description" content="待时而动, 安全杂记 & 日常随感"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="藏器于身"></span><div class="body md" itemprop="articleBody"><div class="note primary no-icon"><p>本篇文章是从零实现文件系统的第二篇文章，主要内容为利用 VFS 提供的 API 实现一个最简单的文件系统并可以正确挂载 / 卸载，其中会开始涉及一些 linux 文件系统的相关知识和实现原理。</p><p>⚙️ 以下是本篇文章所使用的环境：</p><ul><li>Ubuntu Server 24.04</li><li>Linux kernel 6.8.0-51-generic</li><li>VSCode + GCC</li></ul><p>⚓️对应代码版本： <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dhbGl0eTM2OS9zaW1wbGVmcy9yZWxlYXNlcy90YWcvVjAuMQ==">V0.1</span></p></div><div class="note warning"><p>本篇文章需要对 Linux 文件系统模型和 VFS 的 4 大基本对象有所了解，如果还不了解上述内容的话请参考之前的这篇博客：<a href="https://gality.cn/os/fs/VFS/">Linux 文件系统模型与 VFS 入门</a>。</p></div><h1 id="简单文件系统"><a class="anchor" href="#简单文件系统">#</a> 简单文件系统</h1><p>当向 VFS 注册一个文件系统时，至少需要构建 <code>superblock</code> ，并在 <code>superblock</code> 中初始化根目录的 <code>inode</code> 和 <code>dentry</code> ，同时提供挂载（mount）和卸载（unmount）方法。在最简化的实现中，我们仅创建了 <code>superblock</code> 和根 <code>inode</code> ，未实现文件和目录的创建逻辑，因此此时文件系统仅包含根目录，无法添加新的文件或目录，也无法执行文件操作。这样的简化还有一个好处，我们可以暂时不涉及具体的存储介质，而是优先实现 VFS 相关逻辑，确保文件系统可以正确挂载，并逐步完善其功能。这些基本功能可以拆解为 5 个主要任务：</p><ol><li>创建 <code>inode</code></li><li>填充 <code>superblock</code></li><li>实现 <code>mount</code> 方法</li><li>实现 <code>unmount</code> 方法</li><li>注册文件系统</li></ol><h2 id="创建inode"><a class="anchor" href="#创建inode">#</a> 创建 inode</h2><p>在创建 <code>superblock</code> 时需要同时创建根目录（填充 <code>s_root</code> 为 <code>根dentry</code> ），而目录上是由 <code>inode</code> 结构来表示的，所以我们需要先实现一个 <code>inode</code> 的创建函数：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * @sb: 创建的 inode 所属的 superblock，所有 inodes 都属于某个 superblock。</pre></td></tr><tr><td data-num="3"></td><td><pre> * @dir: 如果新建的是目录或文件，则 dir 是其父目录的 inode，用于继承权限等属性。</pre></td></tr><tr><td data-num="4"></td><td><pre> * @mode: 用于指示 inode 的类型和权限，例如是否是目录 (S_IFDIR) 还是普通文件 (S_IFREG)。</pre></td></tr><tr><td data-num="5"></td><td><pre> * @dev: 用于设备文件（如字符设备或块设备），现在的实现中并没有用到它。</pre></td></tr><tr><td data-num="6"></td><td><pre> * @return: 返回初始化好的 inode</pre></td></tr><tr><td data-num="7"></td><td><pre> * </pre></td></tr><tr><td data-num="8"></td><td><pre> * 这个函数创建并初始化 inode，但目前他只支持创建目录类型的 inode。</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token function">simplefs_get_inode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>sb<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>				 <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>dir<span class="token punctuation">,</span> <span class="token class-name">umode_t</span> mode<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>				 <span class="token class-name">dev_t</span> dev<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode <span class="token operator">=</span> <span class="token function">new_inode</span><span class="token punctuation">(</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>inode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		inode<span class="token operator">-></span>i_ino <span class="token operator">=</span> <span class="token function">get_next_ino</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token function">inode_init_owner</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nop_mnt_idmap<span class="token punctuation">,</span> inode<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>		inode<span class="token operator">-></span>__i_atime <span class="token operator">=</span> inode<span class="token operator">-></span>__i_mtime <span class="token operator">=</span> inode<span class="token operator">-></span>__i_ctime <span class="token operator">=</span> <span class="token function">inode_set_ctime_current</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>		<span class="token keyword">switch</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> S_IFMT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token keyword">case</span> S_IFDIR<span class="token operator">:</span>  <span class="token comment">/* 目录 */</span></pre></td></tr><tr><td data-num="24"></td><td><pre>			<span class="token comment">/* i_nlink will be initialized to 1 in the inode_init_always function</span></pre></td></tr><tr><td data-num="25"></td><td><pre>			 * (that gets called inside the new_inode function),</pre></td></tr><tr><td data-num="26"></td><td><pre>			 * We change it to 2 for directories, for covering the "." entry */</pre></td></tr><tr><td data-num="27"></td><td><pre>			<span class="token function">inc_nlink</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>		<span class="token keyword">case</span> S_IFREG<span class="token operator">:</span> <span class="token comment">/* 普通文件 */</span></pre></td></tr><tr><td data-num="30"></td><td><pre>		<span class="token keyword">case</span> S_IFLNK<span class="token operator">:</span> <span class="token comment">/* 符号链接 */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>		<span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR</pre></td></tr><tr><td data-num="33"></td><td><pre>			       <span class="token string">"simplefs can create meaningful inode for only root directory at the moment\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	<span class="token keyword">return</span> inode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li><code>new_inode(sb)</code> 是 VFS 层的 API，负责在 <code>super_block</code> 中申请一个新的 inode 结构，并初始化它的基础字段（如 <code>i_nlink = 1</code> ）。</li><li><code>get_next_ino()</code> 是一个 VFS 提供的辅助函数，它会返回一个唯一的 inode 号。</li><li><code>inode_init_owner()</code> 主要用于设置 inode 的所有者和权限：<ul><li><code>&amp;nop_mnt_idmap</code> 是一个 挂载 ID 映射，用于处理用户和组 ID 的转换， <code>nop_mnt_idmap</code> 代表不进行任何映射的 ID 映射，即该 inode 直接继承父目录的 uid/gid。</li><li><code>inode</code> 是新创建的 inode。</li><li><code>dir</code> 是父目录的 inode。</li><li><code>mode</code> 指定文件的类型（如目录、普通文件）。</li></ul></li><li><code>mode &amp; S_IFMT</code> 用于提取 inode 的<strong>文件类型</strong>，它可以是：<ul><li><code>S_IFDIR</code> （目录）</li><li><code>S_IFREG</code> （普通文件）</li><li><code>S_IFLNK</code> （符号链接）</li></ul></li><li><code>inc_nlink(inode)</code> ：当使用 <code>new_inode()</code> 创建 <code>inode</code> 时， <code>i_nlink</code> 默认是 <code>1</code> ，这里手动调用 <code>inc_nlink()</code> 使其变为 <code>2</code> 。这样做的原因是目录的 <code>.</code> （自身引用）会增加 <code>i_nlink</code> 计数，由于 <code>.</code> 指向自身，因此<strong>目录的链接数最少为 2</strong>。</li><li>对于普通文件和符号链接直接返回 <code>NULL</code> ，并在内核日志中打印一条错误信息，表示 simplefs 目前不支持普通文件或符号链接。</li></ul><h2 id="填充superblock"><a class="anchor" href="#填充superblock">#</a> 填充 superblock</h2><p>在 Linux VFS 框架中，每个挂载的文件系统都需要一个 <code>super_block</code> 结构来存储全局的文件系统信息。所以我们需要实现一个「初始化 <code>super_block</code> ，并创建文件系统的根目录」的函数。在写完创建 <code>inode</code> 的方法后，就可以在构建 superblock 时调用该方法来完成根目录的创建。该函数需要在文件系统被 <code>mount</code> 时被调用，我们只需要实现一个函数原型为 <code>int (*fill_super)(struct super_block *, void *, int)</code> 的方法，就可以方便的使用内核写好的函数来调用该函数（下一个部分中会用到）。具体的实现代码如下：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * @sb:  指向 super_block，VFS 在挂载时会传递进来，文件系统需要初始化它。</pre></td></tr><tr><td data-num="3"></td><td><pre> * @data: 挂载选项，一些文件系统可以通过这个参数接收挂载参数。</pre></td></tr><tr><td data-num="4"></td><td><pre> * @silent: 指示是否 静默挂载，如果为 1，则在错误时不打印日志。</pre></td></tr><tr><td data-num="5"></td><td><pre> * </pre></td></tr><tr><td data-num="6"></td><td><pre> * 这个函数的作用是初始化 super_block，并创建文件系统的根目录。</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">int</span> <span class="token function">simplefs_fill_super</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>sb<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> silent<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token comment">/* A magic number that uniquely identifies our filesystem type */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	sb<span class="token operator">-></span>s_magic <span class="token operator">=</span> <span class="token number">0x20250130</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>	inode <span class="token operator">=</span> <span class="token function">simplefs_get_inode</span><span class="token punctuation">(</span>sb<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> S_IFDIR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	sb<span class="token operator">-></span>s_root <span class="token operator">=</span> <span class="token function">d_make_root</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sb<span class="token operator">-></span>s_root<span class="token punctuation">)</span> <span class="token comment">/* 若返回 NULL，说明分配失败，则返回 -ENOMEM： */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li><code>s_magic</code> 是一个 <strong>文件系统唯一标识符</strong>（Magic Number），用于识别文件系统类型。 <code>0x20250130</code> 只是 <code>simplefs</code> 自定义的一个 Magic Number，通常不同文件系统都有自己的 Magic Number</li><li><code>simplefs_get_inode</code> 创建一个新的 inode，表示根目录，其参数含义如下：<ul><li><code>sb</code> 是超级块，表示这个 inode 属于当前文件系统。</li><li><code>NULL</code> 表示<strong>没有父目录</strong>（根目录没有上级目录）。</li><li><code>S_IFDIR</code> 表示<strong>目录类型</strong>。</li><li><code>0</code> 代表设备号（对于普通文件系统可以忽略）。</li></ul></li><li><code>d_make_root(inode)</code> 创建根目录的 dentry，并将 <code>inode</code> 关联到 <code>dentry</code> ，最终赋值给 <code>sb-&gt;s_root</code> 。该函数会调用 <code>d_alloc_anon()</code> 创建一个匿名 dentry，并与 <code>inode</code> 绑定。这意味着根目录 <code>dentry</code> <strong>不需要通过路径查找，而是直接创建并绑定</strong>。</li></ul><h2 id="实现mount方法"><a class="anchor" href="#实现mount方法">#</a> 实现 mount 方法</h2><p>文件系统的 <code>mount</code> 方法会在文件系统 <code>mount</code> 时自动被 VFS 调用，所以需要向 VFS 注册，VFS 定义的接口原型为 <code>struct dentry *(*mount) (struct file_system_type *, int, const char *, void *);</code> ，我们只需要调用内核提供的一个通用函数 <code>mount_bdev</code> 并将我们实现的 <code>simplefs_fill_super</code> 函数提供给他即可，代码如下：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * @fs_type: 指向 struct file_system_type，代表 simplefs 这个文件系统。</pre></td></tr><tr><td data-num="3"></td><td><pre> * @flags: 挂载标志，例如 MS_RDONLY（只读挂载）。</pre></td></tr><tr><td data-num="4"></td><td><pre> * @dev_name: 要挂载的 设备名称（如 /dev/sdb1）。</pre></td></tr><tr><td data-num="5"></td><td><pre> * @data: 额外的挂载参数（此处未使用）。</pre></td></tr><tr><td data-num="6"></td><td><pre> * @return: 若成功，返回指向根目录的 dentry。</pre></td></tr><tr><td data-num="7"></td><td><pre> * </pre></td></tr><tr><td data-num="8"></td><td><pre> * 这个函数在文件系统挂载时被 VFS 调用，返回指向文件系统的根 dentry 的指针。</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span><span class="token function">simplefs_mount</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file_system_type</span> <span class="token operator">*</span>fs_type<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span>ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>	ret <span class="token operator">=</span> <span class="token function">mount_bdev</span><span class="token punctuation">(</span>fs_type<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> dev_name<span class="token punctuation">,</span> data<span class="token punctuation">,</span> simplefs_fill_super<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">/* IS_ERR () 检查 ret 是否是一个错误指针 */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Error mounting simplefs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"simplefs is successfully mounted on [%s]\n"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		       dev_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>mount_bdev()</code> 的函数签名如下：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span><span class="token function">mount_bdev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file_system_type</span> <span class="token operator">*</span>fs_type<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>			  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>			  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fill_super<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>该函数的前 4 个参数的含义与 <code>simplefs_mount</code> 对应参数含义一致，第五个参数 <code>fill_super</code> 是一个回调函数，用于填充 <code>super_block</code> 结构，我们使用了自己定义的 <code>simplefs_fill_super</code> 方法。</p><h2 id="实现umount方法"><a class="anchor" href="#实现umount方法">#</a> 实现 umount 方法</h2><p>由于文件系统现在还非常简单，甚至简单到无法正常使用，所以我们卸载文件系统系统时也非常的简单，只是输出了一条信息。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">simplefs_kill_superblock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO</pre></td></tr><tr><td data-num="4"></td><td><pre>	       <span class="token string">"simplefs superblock is destroyed. Unmount successful.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token comment">/* 目前这只是一个示例函数。随着我们的文件系统逐渐成熟，我们将在这里进行更有意义的操作 */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="注册文件系统"><a class="anchor" href="#注册文件系统">#</a> 注册文件系统</h2><p>注册文件系统其实就是创建并填充一个 <code>struct file_system_type</code> 结构并在 <code>init</code> 时调用 <code>register_filesystem</code> ，这样 <code>mount -t simplefs</code> 命令才能能够识别它。同理，注销文件系统就是调用 <code>unregister_filesystem</code> 即可，比较简单，这里直接给出代码：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">file_system_type</span> simplefs_fs_type <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"simplefs"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token punctuation">.</span>mount <span class="token operator">=</span> simplefs_mount<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">.</span>kill_sb <span class="token operator">=</span> simplefs_kill_superblock<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">simplefs_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>	ret <span class="token operator">=</span> <span class="token function">register_filesystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>simplefs_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Successfully registered simplefs\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register simplefs. Error:[%d]"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">simplefs_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>	ret <span class="token operator">=</span> <span class="token function">unregister_filesystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>simplefs_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Successfully unregistered simplefs\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="30"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to unregister simplefs. Error:[%d]"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>		       ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token function">module_init</span><span class="token punctuation">(</span>simplefs_init<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token function">module_exit</span><span class="token punctuation">(</span>simplefs_exit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul><li><code>simplefs_fs_type</code> 是一个 文件系统类型 ( <code>file_system_type</code> ) 结构体，用于向 Linux 内核注册 simplefs 文件系统。<ul><li><code>.owner = THIS_MODULE</code> 用于指定拥有该文件系统的内核模块。</li><li><code>.name = &quot;simplefs&quot;</code> 定义文件系统的名称，用于 <code>mount</code> 命令。</li><li><code>.mount</code> 和 <code>.kill_sb</code> 用于指定挂载（ <code>mount</code> ）函数和卸载（ <code>umount</code> ）函数</li></ul></li></ul><h1 id="simplefs的生命周期"><a class="anchor" href="#simplefs的生命周期">#</a> simplefs 的生命周期</h1><p><code>simplefs</code> 的代码执行示意图如下：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>User: <span class="token function">mount</span> <span class="token parameter variable">-t</span> simplefs /dev/sdb1 /mnt/simplefs</pre></td></tr><tr><td data-num="2"></td><td><pre>       │</pre></td></tr><tr><td data-num="3"></td><td><pre>       ▼</pre></td></tr><tr><td data-num="4"></td><td><pre>simplefs_mount<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>       │</pre></td></tr><tr><td data-num="6"></td><td><pre>       ▼</pre></td></tr><tr><td data-num="7"></td><td><pre>mount_bdev<span class="token punctuation">(</span><span class="token punctuation">)</span> ───► 打开 /dev/sdb1</pre></td></tr><tr><td data-num="8"></td><td><pre>       │</pre></td></tr><tr><td data-num="9"></td><td><pre>       ▼</pre></td></tr><tr><td data-num="10"></td><td><pre>simplefs_fill_super<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>       │</pre></td></tr><tr><td data-num="12"></td><td><pre>       ├──► 设置 Magic Number</pre></td></tr><tr><td data-num="13"></td><td><pre>       ├──► simplefs_get_inode<span class="token punctuation">(</span><span class="token punctuation">)</span> ───► 创建 inode（根目录）</pre></td></tr><tr><td data-num="14"></td><td><pre>       ├──► d_make_root<span class="token punctuation">(</span><span class="token punctuation">)</span> ───► 创建 dentry（根目录）</pre></td></tr><tr><td data-num="15"></td><td><pre>       ▼</pre></td></tr><tr><td data-num="16"></td><td><pre>返回 dentry（根目录）</pre></td></tr><tr><td data-num="17"></td><td><pre>       │</pre></td></tr><tr><td data-num="18"></td><td><pre>       ▼</pre></td></tr><tr><td data-num="19"></td><td><pre>挂载成功（VFS 记录 sb-<span class="token operator">></span>s_root）</pre></td></tr></table></figure><p>进一步的来说，其生命周期如下：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span> <span class="token variable"><span class="token variable">`</span>insmod simplefs.ko<span class="token variable">`</span></span> ➝ <span class="token variable"><span class="token variable">`</span>simplefs_init<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>     ├── <span class="token variable"><span class="token variable">`</span>register_filesystem<span class="token punctuation">(</span><span class="token operator">&amp;</span>simplefs_fs_type<span class="token punctuation">)</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>     ↓</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2</span> 用户挂载 <span class="token variable"><span class="token variable">`</span><span class="token function">mount</span> <span class="token parameter variable">-t</span> simplefs /dev/sdb1 /mnt/simplefs<span class="token variable">`</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>     ├── <span class="token variable"><span class="token variable">`</span>simplefs_mount<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>     ├── <span class="token variable"><span class="token variable">`</span>mount_bdev<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span> ➝ <span class="token variable"><span class="token variable">`</span>simplefs_fill_super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>     ├── <span class="token variable"><span class="token variable">`</span>simplefs_get_inode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span> ➝ <span class="token variable"><span class="token variable">`</span>d_make_root<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>     ├── <span class="token variable"><span class="token variable">`</span>dentry<span class="token variable">`</span></span> 被创建，挂载成功</pre></td></tr><tr><td data-num="9"></td><td><pre>     ↓</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">3</span> 用户访问 <span class="token variable"><span class="token variable">`</span>/mnt/simplefs<span class="token variable">`</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>     ├── 读/写操作由 VFS 调度</pre></td></tr><tr><td data-num="12"></td><td><pre>     ↓</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">4</span> <span class="token variable"><span class="token variable">`</span><span class="token function">umount</span> /mnt/simplefs<span class="token variable">`</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>     ├── <span class="token variable"><span class="token variable">`</span>simplefs_kill_superblock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>     ├── <span class="token variable"><span class="token variable">`</span>kill_block_super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>     ↓</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token number">5</span> <span class="token variable"><span class="token variable">`</span>rmmod simplefs<span class="token variable">`</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>     ├── <span class="token variable"><span class="token variable">`</span>unregister_filesystem<span class="token punctuation">(</span><span class="token operator">&amp;</span>simplefs_fs_type<span class="token punctuation">)</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>     ├── <span class="token variable"><span class="token variable">`</span>simplefs_exit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>     └── 模块成功卸载</pre></td></tr></table></figure><h2 id="测试"><a class="anchor" href="#测试">#</a> 测试</h2><p>由于我们现在还不涉及到实际硬盘中的数据存储，所以我们可以随便创建一个虚拟的块设备，然后强行指定使用 <code>simplefs</code> 格式即可。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建一个 512MB 的文件作为虚拟磁盘</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>simplefs.img <span class="token assign-left variable">bs</span><span class="token operator">=</span>1M <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">512</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 将 simplefs.img 关联到一个 loop 设备，即虚拟出一个块设备 loop0</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">sudo</span> losetup /dev/loop0 simplefs.img</pre></td></tr></table></figure><p>然后就可以依次执行如下命令：</p><ol><li><code>sudo insmod simplefs.ko</code></li><li><code>sudo mount -t simplefs /dev/loop0 /mnt</code></li><li><code>sudo umount /mnt</code></li><li><code>sudo rmmod simplefs</code></li></ol><p>然后执行 <code>sudo dmesg</code> 可以看到内核日志中正确输出了相关信息：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span><span class="token number">2080877.150746</span><span class="token punctuation">]</span> loop0: detected capacity change from <span class="token number">0</span> to <span class="token number">1048576</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span><span class="token number">2080892.914067</span><span class="token punctuation">]</span> Successfully registered simplefs</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span><span class="token number">2080898.528370</span><span class="token punctuation">]</span> simplefs is successfully mounted on <span class="token punctuation">[</span>/dev/loop0<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span><span class="token number">2080903.367777</span><span class="token punctuation">]</span> simplefs superblock is destroyed. Unmount successful.</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span><span class="token number">2080907.374764</span><span class="token punctuation">]</span> Successfully unregistered simplefs</pre></td></tr></table></figure><p>在本章中，我们实现了一个最简单的文件系统，虽然还不能创建文件和目录，但是已经可以被内核正确的挂载和卸载了，是一个很好的开端，后面我们将在当前文件系统的基础上继续扩展功能，以此来不断地深入理解 Linux 文件系统。</p><h1 id="代码"><a class="anchor" href="#代码">#</a> 代码</h1><p>整体代码如下</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * A simple Filesystem for Linux Kernel 6.8.0.</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * Initial Author:  Gality &lt;gality369@gmail.com></pre></td></tr><tr><td data-num="5"></td><td><pre> * License: GNU General Public License v3 - https://www.gnu.org/licenses/gpl-3.0.html</pre></td></tr><tr><td data-num="6"></td><td><pre> * Date: 2025-01-30</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token function">simplefs_get_inode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>sb<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>				 <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>dir<span class="token punctuation">,</span> <span class="token class-name">umode_t</span> mode<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>				 <span class="token class-name">dev_t</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">int</span> <span class="token function">simplefs_fill_super</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>sb<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> silent<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre> * @sb: The super block of the filesystem (inodes, blocks, etc).</pre></td></tr><tr><td data-num="20"></td><td><pre> * @dir: The parent directory's inode.</pre></td></tr><tr><td data-num="21"></td><td><pre> * @mode: The mode of the inode to be created (S_IFDIR, S_IFREG, etc).</pre></td></tr><tr><td data-num="22"></td><td><pre> * @dev: The device id of the inode to be created.</pre></td></tr><tr><td data-num="23"></td><td><pre> * @return: The inode created.</pre></td></tr><tr><td data-num="24"></td><td><pre> * This function creates an inode for the filesystem, initializes it </pre></td></tr><tr><td data-num="25"></td><td><pre> * and returns it. For now, it only creates inodes for root directories.</pre></td></tr><tr><td data-num="26"></td><td><pre> */</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token function">simplefs_get_inode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>sb<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>				 <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>dir<span class="token punctuation">,</span> <span class="token class-name">umode_t</span> mode<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>				 <span class="token class-name">dev_t</span> dev<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode <span class="token operator">=</span> <span class="token function">new_inode</span><span class="token punctuation">(</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>inode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>		inode<span class="token operator">-></span>i_ino <span class="token operator">=</span> <span class="token function">get_next_ino</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>		<span class="token function">inode_init_owner</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nop_mnt_idmap<span class="token punctuation">,</span> inode<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>		inode<span class="token operator">-></span>__i_atime <span class="token operator">=</span> inode<span class="token operator">-></span>__i_mtime <span class="token operator">=</span> inode<span class="token operator">-></span>__i_ctime <span class="token operator">=</span> <span class="token function">inode_set_ctime_current</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>		<span class="token keyword">switch</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> S_IFMT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>		<span class="token keyword">case</span> S_IFDIR<span class="token operator">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>			<span class="token comment">/* i_nlink will be initialized to 1 in the inode_init_always function</span></pre></td></tr><tr><td data-num="42"></td><td><pre>			 * (that gets called inside the new_inode function),</pre></td></tr><tr><td data-num="43"></td><td><pre>			 * We change it to 2 for directories, for covering the "." entry */</pre></td></tr><tr><td data-num="44"></td><td><pre>			<span class="token function">inc_nlink</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>		<span class="token keyword">case</span> S_IFREG<span class="token operator">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>		<span class="token keyword">case</span> S_IFLNK<span class="token operator">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>		<span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="49"></td><td><pre>			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR</pre></td></tr><tr><td data-num="50"></td><td><pre>			       <span class="token string">"simplefs can create meaningful inode for only root directory at the moment\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>	<span class="token keyword">return</span> inode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="59"></td><td><pre> * @sb: The superblock which is passed from the VFS to the filesystem.</pre></td></tr><tr><td data-num="60"></td><td><pre> * @data: The mount arguments data that might be passed to the filesystem while mounting.</pre></td></tr><tr><td data-num="61"></td><td><pre> * @silent: A flag to indicate whether the filesystem should print logs or not.</pre></td></tr><tr><td data-num="62"></td><td><pre> * @return: 0 on success, and error code on failure.</pre></td></tr><tr><td data-num="63"></td><td><pre> * This function fills the super block of the filesystem with necessary information.</pre></td></tr><tr><td data-num="64"></td><td><pre> */</pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token keyword">int</span> <span class="token function">simplefs_fill_super</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>sb<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> silent<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>	<span class="token comment">/* A magic number that uniquely identifies our filesystem type */</span></pre></td></tr><tr><td data-num="70"></td><td><pre>	sb<span class="token operator">-></span>s_magic <span class="token operator">=</span> <span class="token number">0x20250130</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>	inode <span class="token operator">=</span> <span class="token function">simplefs_get_inode</span><span class="token punctuation">(</span>sb<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> S_IFDIR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>	sb<span class="token operator">-></span>s_root <span class="token operator">=</span> <span class="token function">d_make_root</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sb<span class="token operator">-></span>s_root<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="75"></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="81"></td><td><pre> * @fs_type: The filesystem type structure that is registered with the kernel.</pre></td></tr><tr><td data-num="82"></td><td><pre> * @flags: Mount flags (e.g. MS_RDONLY for read-only mounts).</pre></td></tr><tr><td data-num="83"></td><td><pre> * @dev_name: The name of the device to be mounted (/dev/sda1, /dev/sdb1, etc).</pre></td></tr><tr><td data-num="84"></td><td><pre> * @data: Extra data that might be passed to the filesystem while mounting.</pre></td></tr><tr><td data-num="85"></td><td><pre> * @return: The root dentry of the filesystem that is mounted.</pre></td></tr><tr><td data-num="86"></td><td><pre> * This function is called when the VFS is asked to mount this filesystem </pre></td></tr><tr><td data-num="87"></td><td><pre> * and returns the root dentry of the filesystem.</pre></td></tr><tr><td data-num="88"></td><td><pre> */</pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span><span class="token function">simplefs_mount</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file_system_type</span> <span class="token operator">*</span>fs_type<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="90"></td><td><pre>				     <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="91"></td><td><pre>				     <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span>ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>	ret <span class="token operator">=</span> <span class="token function">mount_bdev</span><span class="token punctuation">(</span>fs_type<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> dev_name<span class="token punctuation">,</span> data<span class="token punctuation">,</span> simplefs_fill_super<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Error mounting simplefs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="100"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"simplefs is successfully mounted on [%s]\n"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="101"></td><td><pre>		       dev_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>	<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="105"></td><td><pre></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">simplefs_kill_superblock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO</pre></td></tr><tr><td data-num="109"></td><td><pre>	       <span class="token string">"simplefs superblock is destroyed. Unmount successful.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>	<span class="token comment">/* This is just a dummy function as of now. As our filesystem gets matured,</span></pre></td></tr><tr><td data-num="111"></td><td><pre>	 * we will do more meaningful operations here */</pre></td></tr><tr><td data-num="112"></td><td><pre>	<span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">file_system_type</span> simplefs_fs_type <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="117"></td><td><pre>	<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"simplefs"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="118"></td><td><pre>	<span class="token punctuation">.</span>mount <span class="token operator">=</span> simplefs_mount<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="119"></td><td><pre>	<span class="token punctuation">.</span>kill_sb <span class="token operator">=</span> simplefs_kill_superblock<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">simplefs_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>	<span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre></pre></td></tr><tr><td data-num="126"></td><td><pre>	ret <span class="token operator">=</span> <span class="token function">register_filesystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>simplefs_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="128"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Successfully registered simplefs\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="130"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register simplefs. Error:[%d]"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre></pre></td></tr><tr><td data-num="132"></td><td><pre>	<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="134"></td><td><pre></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">simplefs_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>	<span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre></pre></td></tr><tr><td data-num="139"></td><td><pre>	ret <span class="token operator">=</span> <span class="token function">unregister_filesystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>simplefs_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre></pre></td></tr><tr><td data-num="141"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="142"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Successfully unregistered simplefs\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="144"></td><td><pre>		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to unregister simplefs. Error:[%d]"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="145"></td><td><pre>		       ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="147"></td><td><pre></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token function">module_init</span><span class="token punctuation">(</span>simplefs_init<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token function">module_exit</span><span class="token punctuation">(</span>simplefs_exit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 改变了许可证以符合 Linux 内核的要求 */</span></pre></td></tr><tr><td data-num="152"></td><td><pre><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"Gality"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><br><div class="tags"><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag"><i class="ic i-tag"></i> 操作系统</a> <a href="/tags/%E7%B3%BB%E5%88%97%E9%95%BF%E7%AF%87/" rel="tag"><i class="ic i-tag"></i> 系列长篇</a> <a href="/tags/kernel/" rel="tag"><i class="ic i-tag"></i> kernel</a> <a href="/tags/linux/" rel="tag"><i class="ic i-tag"></i> linux</a> <a href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" rel="tag"><i class="ic i-tag"></i> 文件系统</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2025-02-03 22:55:36" itemprop="dateModified" datetime="2025-02-03T22:55:36+08:00">2025-02-03</time> </span><span id="os/kernel/01-simplefs/" class="item leancloud_visitors" data-flag-title="从零实现 FS | 最简单的文件系统" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/wechatpay.png" alt="Gality 微信支付"><p>微信支付</p></div><div><img data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/alipay.png" alt="Gality 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Gality <i class="ic i-at"><em>@</em></i>藏器于身</li><li class="link"><strong>本文链接：</strong> <a href="https://gality.cn/os/kernel/01-simplefs/" title="从零实现 FS | 最简单的文件系统">https://gality.cn/os/kernel/01-simplefs/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/os/kernel/simplefs/" itemprop="url" rel="prev" data-background-image="http:&#x2F;&#x2F;imgcdn.gality.cn&#x2F;blog&#x2F;px3os4.jpg" title="从零实现FS | 最简单的内核模块"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 从 0 到 1</span><h3>从零实现FS | 最简单的内核模块</h3></a></div><div class="item right"><a href="/misc/trail-and-error/include-error/" itemprop="url" rel="next" data-background-image="http:&#x2F;&#x2F;imgcdn.gality.cn&#x2F;blog&#x2F;5rc429.png" title="“C&#x2F;C++找不到头文件”解决方案大全"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 踩坑</span><h3>“C/C++找不到头文件”解决方案大全</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.</span> <span class="toc-text">简单文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAinode"><span class="toc-number">1.1.</span> <span class="toc-text">创建 inode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A1%AB%E5%85%85superblock"><span class="toc-number">1.2.</span> <span class="toc-text">填充 superblock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0mount%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">实现 mount 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0umount%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">实现 umount 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.5.</span> <span class="toc-text">注册文件系统</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#simplefs%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.</span> <span class="toc-text">simplefs 的生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">2.1.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">代码</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/os/kernel/01-simplefs/" rel="bookmark" title="从零实现FS | 最简单的文件系统">从零实现FS | 最简单的文件系统</a></li><li><a href="/os/kernel/simplefs/" rel="bookmark" title="从零实现FS | 最简单的内核模块">从零实现FS | 最简单的内核模块</a></li><li><a href="/os/kernel/02-simplefs/" rel="bookmark" title="从零实现FS | 最简单的存储结构与格式化工具">从零实现FS | 最简单的存储结构与格式化工具</a></li><li><a href="/os/kernel/03-simplefs/" rel="bookmark" title="从零实现FS | 实现列出目录功能">从零实现FS | 实现列出目录功能</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Gality" data-src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/images/avatar.png"><p class="name" itemprop="name">Gality</p><div class="description" itemprop="description">安全杂记 & 日常随感</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">39</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">20</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">54</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dhbGl0eTM2OQ==" title="https:&#x2F;&#x2F;github.com&#x2F;Gality369"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <a href="https://gality.cn/about/" title="https:&#x2F;&#x2F;gality.cn&#x2F;about&#x2F;" class="item about"><i class="ic i-address-card"></i></a> <span class="exturl item email" data-url="bWFpbHRvOjQzNDQwMDcyNkBxcS5jb20=" title="mailto:434400726@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>资源</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/os/kernel/simplefs/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/misc/trail-and-error/include-error/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/trail-and-error/" title="分类于 踩坑">踩坑</a></div><span><a href="/misc/trail-and-error/Mac-Latex/" title="Mac下Latex论文一条龙">Mac下Latex论文一条龙</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于 杂项">杂项</a> <i class="ic i-angle-right"></i> <a href="/categories/misc/trail-and-error/" title="分类于 踩坑">踩坑</a></div><span><a href="/misc/trail-and-error/blog%E6%90%AD%E5%BB%BA/" title="blog搭建&amp;Hello world">blog搭建&Hello world</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/scientific-research/" title="分类于 科研">科研</a> <i class="ic i-angle-right"></i> <a href="/categories/scientific-research/thesis-reading/" title="分类于 论文阅读">论文阅读</a></div><span><a href="/scientific-research/thesis-reading/JANUS/" title="论文阅读｜ Fuzzing File Systems via Two-Dimensional Input Space Exploration">论文阅读｜ Fuzzing File Systems via Two-Dimensional Input Space Exploration</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/os/" title="分类于 操作系统">操作系统</a> <i class="ic i-angle-right"></i> <a href="/categories/os/kernel/" title="分类于 内核">内核</a> <i class="ic i-angle-right"></i> <a href="/categories/os/kernel/0-1/" title="分类于 从 0 到 1">从 0 到 1</a></div><span><a href="/os/kernel/03-simplefs/" title="从零实现FS | 实现列出目录功能">从零实现FS | 实现列出目录功能</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/os/" title="分类于 操作系统">操作系统</a> <i class="ic i-angle-right"></i> <a href="/categories/os/fs/" title="分类于 文件系统">文件系统</a></div><span><a href="/os/fs/FAT32/" title="文件系统详解 ｜ FAT32">文件系统详解 ｜ FAT32</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ml/" title="分类于 机器学习">机器学习</a> <i class="ic i-angle-right"></i> <a href="/categories/ml/nndl/" title="分类于 神经网络与深度学习">神经网络与深度学习</a></div><span><a href="/ml/nndl/nndl-1/" title="《神经网络与深度学习》笔记（1）">《神经网络与深度学习》笔记（1）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ml/" title="分类于 机器学习">机器学习</a></div><span><a href="/ml/CNN/" title="CNN ｜ Network Architecture Designed for Image">CNN ｜ Network Architecture Designed for Image</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ml/" title="分类于 机器学习">机器学习</a></div><span><a href="/ml/regularization/" title="ML Regularization">ML Regularization</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/scientific-research/" title="分类于 科研">科研</a> <i class="ic i-angle-right"></i> <a href="/categories/scientific-research/thesis-reading/" title="分类于 论文阅读">论文阅读</a></div><span><a href="/scientific-research/thesis-reading/%20Blockchain%20Imitation%20Game/" title="论文阅读｜ The Blockchain Imitation Game">论文阅读｜ The Blockchain Imitation Game</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ponder/" title="分类于 思考与沉淀">思考与沉淀</a></div><span><a href="/ponder/Gresham-law/" title="劣币驱逐良币 ｜ 一次网购经历的反思">劣币驱逐良币 ｜ 一次网购经历的反思</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Gality @ Samadhi</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">278k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">8:26</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"os/kernel/01-simplefs/",favicon:{show:"（●´3｀●）哎呀呀～",hide:"(´Д｀)吓死你"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="//cdn.jsdelivr.net/gh/gality369/gality369.github.io@latest/js/app.js?v=0.2.5"></script></body></html>