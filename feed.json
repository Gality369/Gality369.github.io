{
    "version": "https://jsonfeed.org/version/1",
    "title": "藏器于身",
    "subtitle": "待时而动",
    "icon": "https://gality.cn/images/favicon.ico",
    "description": "安全杂记 & 日常随感",
    "home_page_url": "https://gality.cn",
    "items": [
        {
            "id": "https://gality.cn/scientific-research/thesis-reading/JANUS/",
            "url": "https://gality.cn/scientific-research/thesis-reading/JANUS/",
            "title": "论文阅读｜ Fuzzing File Systems via Two-Dimensional Input Space Exploration",
            "date_published": "2025-01-22T14:27:11.000Z",
            "content_html": "<div class=\"note info no-icon\">\n<p><font size=5><strong>Remark</strong></font></p>\n<hr />\n<ul>\n<li>✍️ Xu W, Moon H, Kashyap S, et al. Fuzzing file systems via two-dimensional input space exploration[C]//2019 IEEE Symposium on Security and Privacy (SP). IEEE, 2019: 818-834.</li>\n<li>🥇 Rank: <mark>CCF <strong>A</strong></mark></li>\n<li>📖 Paper：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ndHMzLm9yZy9hc3NldHMvcGFwZXJzLzIwMTkveHU6amFudXMucGRm\">https://gts3.org/assets/papers/2019/xu:janus.pdf</span></li>\n<li>💻 Code: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NzbGFiLWdhdGVjaC9qYW51cw==\">https://github.com/sslab-gatech/janus</span></li>\n<li>🐞 Bugs: 90 found, 62 acknowledged, 43 fixed, 32 CVEs.</li>\n</ul>\n</div>\n<details class=\"primary\"><summary>思考🤔</summary><div>\n<p>很扎实的一篇工作，作者提出要在 image 和 syscall 两个维度来测试文件系统，在变异 image 时只变异对系统影响较大的 metadata，提升 fuzz 效果的同时还减少了需要变异的数据大小；在变异 syscall 时采用了和 syzkaller 类似的策略，区别是作者利用了文件系统的状态信息（例如文件、路径、权限等）并且追踪了每个 syscall 对系统的影响，遗憾的是，由于未能在执行 syscall 时与系统进行交互，部分会导致文件系统状态变化的 syscall 不会进行变异（例如 <code>unlink()</code>  这类可能会删除文件的 syscall），理论来说还是会有部分状态空间是探索不到的。</p>\n<p>同时作者还在 LKL 上实现了较新版本的 Linux 内核，从而可以以毫秒级的速度重置系统状态，这一点确实是其他模拟执行方式无法企及的，LKL 带来的加速对整体 fuzzing 速度和可复现性的提升非常明显，然而，LKL 自身已经不在支持新版本的 Linux 内核了，如果想用 LKL 测试 v6.0 以上版本的话，适配的工作量可能会非常巨大。</p>\n<p>有关于文件系统 fuzz 的工作并不是很多，这篇论文及其后续的两篇论文（Finding Semantic Bugs in File Systems with an Extensible Fuzzing Framework）的成果都非常好，值得认真分析研究，同时<a href=\"#related-work\"> Related Work</a> 中的一些工作也非常有意思，可以多看看。</p>\n</div></details>\n<h1 id=\"abstract\"><a class=\"anchor\" href=\"#abstract\">#</a> Abstract</h1>\n<p>文件系统是操作系统的基本构建模块，通常体积庞大且极为复杂，因此难以做到完全无错误。目前，文件系统主要依赖常规的压力测试工具和形式化检查工具来发现漏洞，但随着文件系统和操作系统复杂性的不断增加，这些工具的能力逐渐显得有限。因此，模糊测试作为一种不需要深入了解目标系统却行之有效的实用方法，逐渐成为首选。然而，文件系统模糊测试面临以下三个主要挑战：</p>\n<ol>\n<li>对大型镜像文件进行变异操作会显著降低整体性能（可能需要变异几百 M 甚至数十 GB 数据）。</li>\n<li>需要生成与镜像相关联的文件操作（syscall 及特定的参数）。</li>\n<li>现有的操作系统模糊测试工具难以重现发现的漏洞。</li>\n</ol>\n<p>为此，我们提出了 <strong>JANUS</strong>，这是首个反馈驱动的模糊测试工具，能够探索文件系统的二维输入空间。<span class=\"red\">JANUS 通过变异大型镜像中的元数据，同时生成与镜像相关的文件操作来测试文件系统</span>。此外，JANUS 使用<span class=\"read\">库操作系统（Library OS）替代传统虚拟机进行模糊测试</span>，使其可以加载操作系统的新副本，从而大幅提高漏洞重现的能力。</p>\n<p>我们在八种文件系统上评估了 JANUS 的性能，发现了 Linux 内核中的 90 个漏洞，其中 62 个已被官方确认。共有 43 个漏洞已修复，并分配了 32 个 CVE（公共漏洞披露编号）。与目前最先进的文件系统模糊测试工具 Syzkaller 相比，JANUS 在运行 12 小时后，对所有文件系统都实现了更高的代码覆盖率。具体而言，在 Btrfs 和 ext4 文件系统中，JANUS 分别访问了 4.19 倍和 2.01 倍于 Syzkaller 的代码路径。此外，JANUS 能够成功重现 88% 至 100% 的崩溃，而 Syzkaller 对这些崩溃均无法重现。</p>\n<p>通过以上改进，JANUS 不仅显著提升了文件系统模糊测试的效率，还为发现和修复文件系统漏洞提供了一种更可靠的工具。</p>\n<h1 id=\"introduction\"><a class=\"anchor\" href=\"#introduction\">#</a> Introduction</h1>\n<p>文件系统是操作系统最基本的系统服务之一，在管理用户文件和在系统崩溃时保持数据一致性方面发挥着重要作用。目前，大多数传统文件系统（例如 ext4、XFS、Btrfs 和 F2FS）运行在操作系统内核中。因此，文件系统中的漏洞可能会导致严重的错误，例如系统重启、操作系统死锁以及整个文件系统镜像的不可恢复错误。此外，这些漏洞还可能带来严重的安全威胁。例如，攻击者可以通过挂载精心构造的磁盘镜像或调用存在漏洞的文件系统特定操作来在目标机器上实现代码执行或权限提升。然而，手动消除文件系统中所有的漏洞是一项挑战，即使对于专家也是如此。例如，Linux v4.18 中最新的 ext4 实现包含 50K 行代码，而 Btrfs 的实现接近 130K 行代码。同时，许多广泛使用的文件系统仍处于活跃开发中。文件系统开发人员不断优化性能并添加新功能，但这些更新也可能引入新的漏洞。</p>\n<p>为了自动发现这些潜在的漏洞，大多数正在开发的文件系统依赖已知的压力测试框架（例如 xfstests、fsck、Linux Test Project 等），这些框架主要关注文件系统的回归测试和最低限度的完整性检查。例如，我们在 ext4 中发现的一个漏洞（即 CVE-2018-10880）可以通过移动关键扩展属性出 inode 结构来导致内核崩溃。我们通过挂载一个启用 inline_data 的正常 ext4 镜像触发了此漏洞，而该镜像能够绕过 xfstests 和 fsck 的完整性检查。此外，一些先前的研究工作应用了模型检查来发现文件系统漏洞，但这需要对文件系统和操作系统状态有深入的了解。由于现代操作系统日益复杂，这在实践中已经变得不切实际。另一方面，大多数经过验证的文件系统由于不够成熟，尚难以在实际中采用。</p>\n<p>另一种方法 —— 模糊测试（fuzzing）—— 正受到越来越多的关注。模糊测试不仅需要对目标软件的最低了解，而且是一种高效、实用的方法，已经发现了数千个漏洞。因此，模糊测试成为自动发现各种文件系统漏洞（例如 Linux 内核中的 54 个漏洞）的可行方法。然而，与其他常见目标不同，模糊测试文件系统依赖两个输入：挂载的磁盘镜像和在挂载镜像上执行的一系列文件操作（即系统调用）。现有的模糊测试工具要么专注于将镜像作为普通二进制输入进行变异，要么生成一组随机的文件操作特定系统调用。遗憾的是，它们都未能高效且全面地测试文件系统，主要因为以下三个挑战：</p>\n<p>首先，磁盘镜像是一个结构化但复杂的大型二进制块，其最小大小几乎是普通模糊测试工具首选最大大小的 100 倍。由于变异镜像涉及大量 I/O 操作，这大大降低了模糊测试的吞吐量。与二进制块变异相关的另一个问题是，现有的模糊测试工具仅变异镜像中非零的块。这种方法并不可靠，因为这些工具未能利用结构化数据的特性，例如文件系统布局，而变异元数据块比变异数据块更有效。此外，由于缺乏文件系统布局的知识，现有模糊测试工具在破坏元数据块后也无法修复任何元数据校验和。第二个挑战是文件操作是上下文相关的工作负载（workload），即文件系统镜像的实时状态决定了一组系统调用可以操作哪些文件对象，而特定系统调用的调用会改变正在操作的对象。不幸的是，现有的系统调用模糊测试工具独立生成随机系统调用，使用硬编码文件路径，未能生成有意义的文件操作序列，也未能覆盖文件系统的深层代码路径。第三个问题是现有模糊测试工具难以重现发现的漏洞。大多数针对操作系统或文件系统的模糊测试工具在测试生成的输入时未重新加载操作系统实例或文件系统镜像的干净副本，即它们 {未使用非老化的操作系统和文件系统 ++{.dot}。由于依赖 VM、QEMU 或用户模式 Linux (UML) 实例，这些工具无法快速重置系统状态，只能复用这些实例，导致操作系统状态污染，最终造成不稳定的执行和不可重现的漏洞。</p>\n<blockquote>\n<p>“老化” 的操作系统或文件系统系统：以 syzkaller 为例，syzkaller 会在同一个操作系统（文件系统）中执行多个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">workload</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">d</span></span></span></span>，例如<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><msub><mi>d</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><msub><mi>d</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><msub><mi>d</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">workload_1, workload_2, ..., workload_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，假设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><msub><mi>d</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">workload_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 触发了一个 bug，syzkaller 会尝试用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><msub><mi>d</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">workload_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 来复现 bug，然而该 bug 的触发路径可能是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><msub><mi>d</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><msub><mi>d</mi><mn>3</mn></msub><mo separator=\"true\">,</mo><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><msub><mi>d</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">workload_1, workload_3,workload_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，由于忽略了前面的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">workload</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">d</span></span></span></span> 的影响，导致无法复现 bug。这就是文中的 “老化” 的操作系统的含义，即在执行某个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">workload</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">d</span></span></span></span> 时系统不是一个纯净的状态，而是叠加了多个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">workload</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">d</span></span></span></span> 的影响的状态。</p>\n</blockquote>\n<p>我们通过 JANUS 解决了上述挑战。JANUS 是一种进化型的反馈驱动模糊测试工具，可以高效地探索磁盘文件系统的二维输入空间。JANUS 通过利用元数据的结构化特性，仅对种子镜像的元数据块进行变异，从而显著减少输入搜索空间。其次，我们提出了基于镜像的系统调用模糊测试技术，以模糊测试文件操作。JANUS 不仅存储生成的系统调用，还推测这些调用完成后每个文件对象的运行时状态。JANUS 使用推测状态作为反馈生成新的一组系统调用，从而发出上下文感知的工作负载。在每次模糊测试迭代中，JANUS 优先进行镜像模糊测试，然后调用基于镜像的系统调用模糊测试，以全面探索目标文件系统。最后，JANUS 解决了重现性问题，通过使用库操作系统（例如 Linux Kernel Library）运行在用户空间中，而不是 VM，每次测试文件系统相关功能时都加载操作系统的干净副本，从而保证了结果的可重现性。</p>\n<p>借助 JANUS，我们对 Linux 内核（v4.16–v4.18）中八个主流文件系统进行了四个月的模糊测试。我们的评估显示，与最先进的模糊测试工具 Syzkaller 相比，JANUS 在所有选定文件系统上最多实现 4.19 倍的代码覆盖率。此外，我们选择使用库操作系统，使得 JANUS 能够重现 88%-100% 的崩溃，而 Syzkaller 无法重现任何崩溃。迄今为止，我们已成功发现 90 个漏洞，其中 62 个已被开发者确认，43 个已修复并分配了 32 个 CVE。</p>\n<p>本文的贡献包括以下几个方面：</p>\n<ul>\n<li><strong>问题</strong>：我们识别出现有文件系统模糊测试工具的三大主要问题：\n<ol>\n<li>对大体积的二进制镜像进行模糊测试效率低下；</li>\n<li>模糊测试工具未能利用文件系统镜像与文件操作之间的依赖关系；</li>\n<li>模糊测试工具使用老化的操作系统和文件系统，导致发现的漏洞难以复现。</li>\n</ol>\n</li>\n<li><strong>方法</strong>：我们设计并实现了一种进化式文件系统模糊测试工具，名为 <strong>JANUS</strong>。它通过高效地变异种子镜像中的元数据块，并生成基于镜像的工作负载，深入探索目标文件系统。此外，JANUS 使用了一种库操作系统（Library OS，例如 LKL）来代替虚拟机，用以测试操作系统功能，从而能够在毫秒内提供全新状态的操作系统镜像。</li>\n<li><strong>影响</strong>：我们在 Linux 内核中的八种文件系统上对 JANUS 进行了评估，共发现了 90 个漏洞，其中 62 个已被开发者确认，43 个已修复并分配了 32 个 CVE 编号。此外，在代码覆盖率方面，JANUS 在所有选定文件系统上均优于 Syzkaller。例如，在对 Btrfs 和 ext4 进行 12 小时的模糊测试时，JANUS 分别覆盖了 4.19 倍和 2.01 倍于 Syzkaller 的代码路径。同时，JANUS 能复现 88%-100% 的崩溃，而 Syzkaller 无法复现任何一个。</li>\n</ul>\n<h2 id=\"threat-model\"><a class=\"anchor\" href=\"#threat-model\">#</a> Threat Model</h2>\n<p>在本研究中，我们假设攻击者可以挂载一个经过精心构造的磁盘镜像到目标机器上，并操作镜像中存储的文件以利用内核文件系统中的安全漏洞。攻击者无需具备 root 权限即可实现这一点，常见的方式包括：</p>\n<ol>\n<li><strong>自动挂载</strong>：现代操作系统会自动挂载插入的未经信任的驱动器（如果其支持对应的文件系统）。这种机制已被一些臭名昭著的攻击利用，如 Stuxnet 和 “恶意女仆攻击”（Evil Maid Attack）等；</li>\n<li><strong>非特权挂载</strong>：macOS 允许非 root 用户挂载 Apple 磁盘镜像，并支持多种文件系统（如 HFS、HFS+ 和 APFS）。在这些文件系统中发现了多个漏洞，可能导致绕过内核的内存读取限制以及代码执行。Linux 也允许非特权用户通过  <code>FS_USERNS_MOUNT</code>  在用户命名空间中挂载任意文件系统。</li>\n</ol>\n<p>此外，攻击者还可以通过云存储服务或可移动驱动器共享精心构造的磁盘镜像，从而诱导受害者挂载。一旦镜像被挂载，攻击者即可对镜像执行文件操作（如读取、写入、删除和重命名文件），以触发文件系统中的漏洞。</p>\n<h1 id=\"background-and-motivation\"><a class=\"anchor\" href=\"#background-and-motivation\">#</a> Background and Motivation</h1>\n<p>商品操作系统通常将磁盘文件系统实现为内核模块。用户负责挂载大体积、已格式化的镜像，并通过文件操作来管理数据。本节内容如下：</p>\n<ol>\n<li><strong>一般模糊测试方法</strong>（<a href=\"#a-primer-on-fuzzing\">§3.1</a>）：描述模糊测试的通用方法。</li>\n<li><strong>现有文件系统模糊测试工具</strong>（<a href=\"#file-system-fuzzing\">§3.2</a>）：总结当前文件系统模糊测试工具的现状。</li>\n<li><strong>现有工具的不足</strong>：解释为何现有方法无法高效地测试文件系统。</li>\n<li><strong>挑战与机遇</strong>（<a href=\"#challenges-of-fuzzing-a-file-system\">§3.3</a>）：总结文件系统模糊测试中的主要挑战，并探讨潜在的解决方案和机会。</li>\n</ol>\n<h2 id=\"a-primer-on-fuzzing\"><a class=\"anchor\" href=\"#a-primer-on-fuzzing\">#</a> A Primer on Fuzzing</h2>\n<p>模糊测试是一种广泛应用的软件测试方法，通过反复生成新输入并将其注入目标程序以触发漏洞。它被认为是实际中发现现代软件安全漏洞最有效的方法之一。例如，先进模糊测试工具 AFL 及其变体已在开源软件中发现了无数漏洞。</p>\n<p>为了高效地探索目标程序，近期的模糊测试工具利用过去的代码覆盖信息来指导后续输入的生成。此外，操作系统（OS）等软件属于最关键的程序，因为发现的漏洞可能允许在目标机器上实现权限升级。为了模糊测试操作系统，一些框架扩展了基于反馈的模糊测试方法，通过调用随机生成的系统调用来触发内核漏洞。</p>\n<h2 id=\"file-system-fuzzing\"><a class=\"anchor\" href=\"#file-system-fuzzing\">#</a> File System Fuzzing</h2>\n<p>磁盘文件系统有两种输入空间：(1) 结构化的文件系统镜像格式；(2) 用户为访问挂载镜像上存储的文件而调用的文件操作。现有的一些文件系统模糊测试工具通常使用通用的模糊测试框架来分别针对镜像或文件操作。</p>\n<h3 id=\"disk-image-fuzzer\"><a class=\"anchor\" href=\"#disk-image-fuzzer\">#</a> Disk Image Fuzzer</h3>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/7wx2gc.png\" alt=\"图1\" /></p>\n<blockquote>\n<p>图 1：ext4 映像的磁盘布局。灰色块表示正在使用的元数据，仅占映像大小的 1%。其中一些元数据（包括范围树节点、目录条目和日志块）分散在映像中，而其他元数据（如超级块、组描述符等）则位于开头。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>File system</th>\n<th>ext4</th>\n<th>XFS</th>\n<th>Btrfs</th>\n<th>F2FS</th>\n<th>GFS2</th>\n<th>ReiserFS</th>\n<th>NTFS</th>\n<th>AFL</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Min. size(MB)</td>\n<td>2</td>\n<td>16</td>\n<td>100</td>\n<td>38</td>\n<td>16</td>\n<td>33</td>\n<td>1</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>表 1：不同文件系统在默认选项下（启用日志或记录功能）允许格式化的块设备的最小大小。大多数镜像大小超过了 AFL 建议的模糊输入大小 (1MB)</p>\n</blockquote>\n<p>磁盘镜像是一个大型的结构化二进制块，包含 (1) 用户数据和 (2) 元数据，即文件系统为访问、加载、恢复和搜索数据或满足其他特定需求所需的管理结构。典型的 ext4 镜像的磁盘布局如图 1 所示。然而，元数据的大小仅占镜像大小的 1% ，而有效镜像的最小大小可达 100 MB（见表 1），并且启用某些功能后会进一步增大。将磁盘镜像作为模糊测试输入存在以下问题：</p>\n<ol>\n<li>镜像的大尺寸导致输入空间呈指数增长，同时元数据的变异频率低。</li>\n<li>模糊测试需要频繁对输入文件进行读写操作。例如，在模糊测试磁盘镜像时，需要反复在变异前后读取和写入镜像，必要时还需要保存镜像。这导致大镜像尺寸带来的文件操作性能开销。</li>\n<li>为检测元数据损坏，某些文件系统（如 XFS v5、GFS2、F2FS 等）引入校验和保护磁盘上的元数据。在初始化期间，内核会拒绝带有无效校验和的变异元数据块的镜像。</li>\n</ol>\n<p>磁盘镜像模糊测试器通过强制文件系统挂载变异的磁盘镜像并执行一系列文件操作来触发文件系统特定的漏洞。早期模糊测试器采用低效的方法，在有效镜像的随机偏移处变异字节生成新镜像，或仅变异元数据块中的字节。这些方法由于需要加载和保存整个镜像而导致巨大的磁盘 I/O 开销。此外，这些盲目模糊测试技术生成的镜像质量较差，未利用过往的代码覆盖信息。</p>\n<p>为了解决上述问题，近期的模糊测试器开始采用代码覆盖驱动的方法，并从种子镜像中提取所有非零块进行变异。这种方法触及了大多数元数据块，并通过减少输入大小提高了模糊测试性能。然而，这种方法仍存在以下缺陷：</p>\n<ul>\n<li>非零块不仅包含非零数据块，还丢弃了零初始化的元数据块，从而导致文件系统模糊测试效果不佳。</li>\n<li>元数据块未被精确定位，因此校验和无法正确修复。</li>\n</ul>\n<h3 id=\"file-operation-fuzzer\"><a class=\"anchor\" href=\"#file-operation-fuzzer\">#</a> File Operation Fuzzer</h3>\n<p>由于文件系统是操作系统（OS）的一部分，模糊测试的一种通用方法是调用一组系统调用。尽管将这些模糊测试器移植到文件系统操作的目标上较为简单，但它们在有效性上存在两大问题：</p>\n<ol>\n<li><strong>未考虑镜像与文件操作的动态依赖</strong><br />\n文件操作仅修改镜像上存在的文件对象（如目录、符号链接等），每个完成的操作只影响特定对象。然而，现有的操作系统模糊测试器未考虑镜像与文件操作之间的动态依赖，盲目生成系统调用，导致文件系统探索不充分。例如，先进的 OS 模糊测试工具 Syzkaller 根据描述每个目标系统调用的参数和返回值数据类型的静态语法规则生成系统调用。尽管它能够生成单一语义正确的系统调用，但无法探索一组系统调用的集体行为及其对文件系统镜像的修改。例如，Syzkaller 可能对已被重命名（ <code>rename()</code> ）或删除（ <code>unlink()</code> ）的路径重复发出多个  <code>open()</code>  调用。</li>\n<li><strong>使用老化的 OS 和文件系统</strong><br />\n为了性能考虑，现有的操作系统模糊测试器大多使用虚拟化实例（如 KVM、QEMU 等）运行目标操作系统，而不是为每个测试输入重新加载一份全新的操作系统或文件系统。然而，这种方式有以下问题：\n<ul>\n<li>老化的操作系统在处理大量系统调用后执行变得非确定性。例如，依赖于先前分配的  <code>kmalloc()</code>  跨运行行为不同。有时，内核组件（如日志系统）会在长时间模糊测试中静默失效并从操作系统中分离，而不会触发文件系统崩溃。</li>\n<li>这些模糊测试器发现的漏洞往往累积了成千上万次系统调用的影响，这会阻碍开发人员生成稳定的漏洞复现用例并进行调试。</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"file-system-fuzzer\"><a class=\"anchor\" href=\"#file-system-fuzzer\">#</a> File System Fuzzer</h3>\n<p>如前所述，大多数模糊测试器要么模糊测试二进制输入，要么使用一系列系统调用模糊测试操作系统。然而，要模糊测试文件系统，我们需要同时变异两种输入：(1) 二进制镜像（即文件系统镜像）；(2) 相应的工作负载（即一组特定于文件系统的系统调用）。</p>\n<p>遗憾的是，将这两种现有的模糊测试技术结合起来并非易事。近期，Syzkaller 尝试通过变异镜像中的非零块，同时独立生成与上下文无关的工作负载来测试变异后的镜像。然而，这种方法仍然不够健全且效率低下。</p>\n<h2 id=\"challenges-of-fuzzing-a-file-system\"><a class=\"anchor\" href=\"#challenges-of-fuzzing-a-file-system\">#</a> Challenges of Fuzzing a File System</h2>\n<p>我们总结了在 Linux 内核中对文件系统进行模糊测试的一系列挑战，并提出了设计 JANUS 来克服这些挑战的见解。值得注意的是，这些见解同样适用于其他操作系统。</p>\n<p><strong>处理大型磁盘镜像作为输入</strong>。一个优秀的镜像模糊测试工具需要通过以下方法有效处理复杂且巨大的磁盘镜像：</p>\n<ol>\n<li>变异散布在镜像中的元数据，同时处理校验和问题；</li>\n<li>减少因输入操作引发的频繁磁盘 I/O。</li>\n</ol>\n<p>遗憾的是，当前的模糊测试工具无法同时解决这两个问题。理想的镜像模糊测试工具应专注于元数据部分，而非整个磁盘镜像，并且在变异任何元数据结构后必须修复对应的校验和。</p>\n<p><strong>缺乏上下文感知的工作负载</strong>。文件系统相关的工作负载会直接影响镜像内容。例如，某些有效的文件操作会在运行时修改镜像上的文件对象（例如  <code>open()</code>  创建新文件， <code>unlink()</code>  删除现有文件的链接）。然而，现有的模糊测试工具依赖预定义的镜像信息（如种子镜像中的有效文件和目录路径）来生成系统调用，因此无法在运行时全面测试目标文件系统中的所有可访问文件对象。因此，更好的方法是在执行文件操作后维护镜像上每个文件对象的运行时状态，以便生成新的操作。</p>\n<p><strong>探索二维输入空间</strong>。文件系统处理两种类型的输入：</p>\n<ol>\n<li>磁盘镜像（二进制数据块）</li>\n<li>文件操作（按顺序组织的操作）</li>\n</ol>\n<p>这两种输入的格式完全不同，但存在隐式关联。为了充分探索文件系统，模糊测试工具需要同时对这两类输入进行变异。然而，现有工具并不支持这一点。因此，我们希望提出一种混合方法，通过同时模糊测试镜像字节和文件操作来探索这两个维度。</p>\n<p><strong>复现发现的崩溃</strong>。传统的操作系统模糊测试工具通常使用虚拟化实例来测试操作系统功能。然而，为了避免重启虚拟机或恢复快照的高昂开销，它们会在多次运行中重复使用相同的操作系统或文件系统实例，这导致内核执行不稳定以及无法复现的错误。这个问题可以通过利用库操作系统（library OS）解决。库操作系统能够提供精确的操作系统行为，并在毫秒级时间内重新初始化操作系统状态，从而实现高效且可复现的崩溃检测。</p>\n<h1 id=\"design\"><a class=\"anchor\" href=\"#design\">#</a> Design</h1>\n<h2 id=\"overview\"><a class=\"anchor\" href=\"#overview\">#</a> Overview</h2>\n<p>JANUS 是一种反馈驱动的模糊测试工具，旨在通过变异种子镜像的元数据，并生成上下文感知的文件操作（即系统调用），来全面探索文件系统。为了应对文件系统模糊测试中的挑战，JANUS 采用了以下设计策略：</p>\n<ol>\n<li><strong>专注于元数据变异</strong><br />\n JANUS 仅存储从种子镜像中提取的元数据作为变异目标。元数据对于文件系统管理用户数据至关重要。JANUS 在变异后会重新计算每个元数据结构的校验和。由于元数据仅占镜像空间的 1%，测试用例的大小远小于完整磁盘镜像，从而显著提高了模糊测试的吞吐量。</li>\n<li><strong>动态生成文件操作</strong><br />\n JANUS 不依赖于手动指定种子镜像中存储的文件信息，因为这些信息会随着时间失效，导致测试用例生成效果不佳。相反，JANUS 根据完成旧工作负载后推测出的镜像状态动态生成新的文件操作。</li>\n<li><strong>探索二维输入空间</strong><br />\n文件系统的输入包括磁盘镜像和文件操作。JANUS 通过合理调度镜像模糊测试和文件操作模糊测试，探索这两种输入的可能性。考虑到原始镜像决定了文件系统的初始状态，并影响初始文件操作的执行，JANUS 首先对镜像字节进行变异。</li>\n<li><strong>使用库操作系统复现崩溃</strong><br />\n JANUS 使用库操作系统（library OS）在用户空间测试内核功能。库操作系统实例以用户应用程序的形式运行，可以快速重新启动，开销极低，从而提高了发现崩溃后复现错误的机会。</li>\n</ol>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/q78czu.png\" alt=\"图2\" /></p>\n<blockquote>\n<p>图 2: JANUS 的概览：在每次模糊测试迭代中，JANUS 从其工作集加载一个测试用例，该测试用例由以下三部分组成：种子镜像的元数据、包含文件操作列表的程序，以及程序在运行时执行后推测出的镜像状态（❶）。接着，JANUS 的模糊引擎以两种方式对测试用例进行变异：</p>\n<ol>\n<li><strong>镜像变异</strong>：镜像变异器随机变异元数据，模糊引擎输出变异后的元数据，同时保持程序不变，用于测试（➋）。</li>\n<li><strong>系统调用模糊</strong>：系统调用模糊器对程序中的现有系统调用进行变异或附加新的系统调用，并根据工作负载的变化更新镜像状态（②）。在这种情况下，模糊引擎输出不变的元数据和新生成的程序。</li>\n</ol>\n<p>然后，JANUS 将输出的元数据释放到一个完整镜像中（❸），并将完整镜像与输出程序一起交给基于库操作系统的执行器（③）。执行器挂载镜像并执行程序，其执行轨迹被记录到一个共享给 JANUS 模糊引擎的位图中（➍）。</p>\n<p>如果发现新的代码路径，输出的元数据、程序以及更新后的镜像状态将被打包成新的测试用例，并保存到工作集中，以供后续变异使用（➎）。</p>\n</blockquote>\n<p>图 2 展示了 JANUS 的详细设计。JANUS 的二进制输入包含以下三部分：</p>\n<ol>\n<li><strong>元数据块</strong>：从种子镜像中提取的二进制数据。</li>\n<li><strong>序列化程序</strong>：描述一系列系统调用的文件系统工作负载。</li>\n<li><strong>推测的镜像状态</strong>：程序运行后镜像的状态。</li>\n</ol>\n<p>在初始化阶段，JANUS 使用文件系统特定的解析器从种子镜像中提取元数据，同时检查镜像状态并生成初始程序。这些元数据、镜像状态和程序被打包成测试用例，存入 JANUS 的工作集。JANUS 通过从工作集中选择测试用例（❶），在无限循环中使用镜像变异器和系统调用模糊器探索二维输入空间：</p>\n<ol>\n<li><strong>镜像变异器</strong>：对元数据块进行多种方式的字节翻转，生成变异后的元数据（➋）。程序部分保持不变。</li>\n<li><strong>系统调用模糊器</strong>：变异现有程序中的系统调用参数，或向程序中添加新的系统调用，同时根据新生成的程序推测新的镜像状态（②）。此时，元数据部分保持不变。</li>\n</ol>\n<p>生成的变异元数据与用户数据合并后，JANUS 重新计算校验和，生成完整镜像（❸）。序列化后的程序也被保存到磁盘中（③）。JANUS 依赖库操作系统的用户空间执行器，加载完整镜像并执行磁盘中存储的程序（➍）。执行器的运行时路径覆盖被记录到一个共享的位图中。模糊引擎检查位图，当发现新的路径时，JANUS 将精简后的镜像、序列化程序和推测的镜像状态存储为新的二进制输入，用于后续运行中的进一步变异（➎）。请注意，对于每个测试用例，JANUS 总是先运行镜像变异器进行若干轮变异，如果没有发现有趣的测试用例，再调用系统调用模糊器。</p>\n<p>我们将在<a href=\"#building-corpus\"> §4.2</a> 中首先描述 JANUS 如何通过解析种子镜像生成初始测试用例。接着，在 <a href=\"#fuzzing-images\">§4.3</a> 和 <a href=\"#fuzzing-file-operations\">§4.4</a> 中分别介绍它如何对镜像字节进行模糊测试以及生成文件操作。更重要的是，我们将在 <a href=\"#exploring-two-dimensional-input-space\">§4.5</a> 中说明 JANUS 如何集成两个核心模糊器。最后，在 <a href=\"#library-os-based-kernel-execution-environment\">§4.6</a> 中展示我们为文件系统模糊测试设计的全新基于库操作系统的环境。</p>\n<h2 id=\"building-corpus\"><a class=\"anchor\" href=\"#building-corpus\">#</a> Building Corpus</h2>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/wld0kd.jpg\" alt=\"图3\" /></p>\n<blockquote>\n<p>图 3：JANUS 如何在给定种子图像的情况下生成初始语料库的伪代码。</p>\n</blockquote>\n<p>JANUS 通过其镜像解析器和系统调用模糊器，基于种子镜像构建初始语料库（见图 3）。语料库中测试用例的第一部分是种子镜像的关键元数据块，这些块仅占镜像总大小的约 1%，从而克服了上一章中提到的模糊测试磁盘镜像的挑战。具体来说，JANUS 首先将整个镜像映射到内存缓冲区中，然后使用文件系统特定的镜像解析器扫描镜像，并根据所使用文件系统的规范定位所有的磁盘元数据。接着，JANUS 将这些元数据重新组装为一个紧缩的数据块，供后续变异使用，并记录其大小和在镜像中的偏移量。对于受校验和保护的元数据结构，JANUS 还记录了由镜像解析器识别的校验和字段在元数据中的偏移位置。</p>\n<p>其次，初始测试用例还包括镜像上每个文件和目录的信息，使得 JANUS 可以利用这些信息生成上下文感知的工作负载。具体而言，系统调用模糊器会探测种子镜像，并提取每个文件对象的路径、类型（如普通文件、目录、符号链接、FIFO 文件等）以及扩展属性，这些信息被打包进每个初始测试用例中。此外，每个初始测试用例还包含一个由系统调用模糊器生成的、带有独特系统调用的起始程序，供后续变异使用。为了扩大语料库的总体覆盖范围，每个随机生成的系统调用都会操作一个独特的文件对象（有关程序格式和系统调用生成的详细信息，请参见  <a href=\"#fuzzing-file-operations\">§4.4</a> ）。种子镜像的元数据、文件状态，以及起始程序共同组成了一个输入测试用例，这些测试用例由 JANUS 打包并存储到磁盘上的语料库中，供未来的模糊测试使用。</p>\n<h2 id=\"fuzzing-images\"><a class=\"anchor\" href=\"#fuzzing-images\">#</a> Fuzzing Images</h2>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/a25hnt.png\" alt=\"图4\" /></p>\n<blockquote>\n<p>图 4：JANUS 如何随机变异元数据块的伪代码</p>\n</blockquote>\n<p>JANUS 依赖于其镜像变异器对镜像进行模糊测试。具体来说，镜像变异器会加载测试用例的元数据块，并应用多种常见的模糊测试策略（如提到的位翻转、随机字节上的算术操作等）来随机变异元数据的字节，如图 4 所示。与现有的模糊测试工具类似，JANUS 优先使用一组特定的整数（即图 4 中的 &quot;有趣值&quot;，例如  <code>-1</code> 、 <code>0</code> 、 <code>INT_MAX</code>  等）而非纯随机值来变异元数据。在我们的评估中，这些特殊值使镜像变异器能够生成更多边界情况，这些情况往往无法被文件系统正确处理（例如 表 2 中由 JANUS 发现的 Bug #1、#6、#14、#28、#33 等），同时还能生成更多极端情况，从而通过在运行时触发特定 Bug 增加内核崩溃的可能性（例如，大部分由 JANUS 发现的越界访问 Bug）。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/b1q3om.png\" alt=\"表2\" /></p>\n<blockquote>\n<p>表 2 列出了由 JANUS 在广泛使用的文件系统中发现的先前未知的漏洞，这些漏洞已在 Linux 内核版本 v4.16**、**v4.17 和 v4.18 中修复。我们仍在等待为部分已确认的漏洞分配 CVE 编号。出于安全考虑，我们未列出开发者尚未修复的另外 19 个漏洞。表格最右列 <strong>Conditions</strong> 指示了 JANUS 的哪些组件对发现这些漏洞起到了贡献。<strong>I</strong> 表示仅需挂载变异的镜像即可触发该漏洞；<strong>I+S</strong> 表示需要挂载变异的镜像并调用特定系统调用才能触发漏洞。</p>\n</blockquote>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/kffo94.png\" alt=\"图5\" /></p>\n<blockquote>\n<p>图 5：JANUS 如何将变异元数据块释放回全尺寸图像进行测试的伪代码。</p>\n</blockquote>\n<p>在变异完整个元数据块后，JANUS 将变异后的每个元数据块拷贝回其对应位置的内存缓冲区中（如图 5 所示），该缓冲区存储着原始的全尺寸镜像。为了保持镜像的完整性，镜像解析器会根据目标文件系统采用的特定算法重新计算每个元数据块的校验和值，并将该值填充到校验和字段的记录偏移位置中。</p>\n<h2 id=\"fuzzing-file-operations\"><a class=\"anchor\" href=\"#fuzzing-file-operations\">#</a> Fuzzing File Operations</h2>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/ih85zt.png\" alt=\"图6\" /></p>\n<blockquote>\n<p>图 6：Janus 如何随机变异现有系统调用并生成新的程序的伪代码。</p>\n</blockquote>\n<p>系统调用模糊测试工具使 JANUS 能够生成与镜像相关的工作负载，从而有效地探索文件系统如何处理用户请求的各种文件操作。首先，我们介绍由系统调用模糊测试工具操作的程序（Program）结构。一个程序包含一组有序的系统调用（system call）列表，这些系统调用用于修改被变异的镜像，同时维护一个变量库，用于存储系统调用中使用的变量。JANUS 将每个系统调用描述为一个包含系统调用号、参数值和返回值的元组。如果参数值或返回值不是简单的常量，而是一个变量，JANUS 会将其表示为指向变量库中相应变量的索引。此外，程序还包括一个活动文件描述符列表，其中记录了已打开但尚未被程序关闭的文件描述符。</p>\n<p>类似于现有的模糊测试工具（如 Syzkaller），系统调用模糊测试工具通过两种方式从输入程序生成新程序：(1) <strong>系统调用变异</strong>。系统调用模糊测试工具随机选择程序中的一个系统调用，并生成一个新值列表，以替换随机选择的参数的旧值；(2) <strong>系统调用生成</strong>。系统调用模糊测试工具向程序追加一个新的系统调用，该系统调用的参数值是随机生成的。特别地，JANUS 采用了与 Syzkaller 相同的策略来为系统调用的简单参数生成值。这些参数的候选值与推测的运行时状态无关。对于具有明确可用值集合的参数，JANUS 从集合中随机选择值（例如， <code>lseek()</code>  的  <code>int whence</code>  参数）。此外，对于整数类型的参数（例如， <code>write()</code>  的  <code>size_t count</code>  参数），JANUS 在某个范围内生成随机数。</p>\n<p>进一步来说，许多文件操作需要一个指针类型的参数。此类指针通常指向一个缓冲区，用于存储用户数据（例如， <code>write()</code>  的  <code>void *buf</code>  参数）或内核输出（例如， <code>read()</code>  的  <code>void *buf</code>  参数）。对于前者，系统调用模糊测试工具声明一个填充了随机值的数组作为参数。对于后者，由于 JANUS 不受运行时内核输出（除了代码覆盖率）驱动，因此始终使用一个固定数组。</p>\n<p>然而，对于那些合理值依赖于文件系统运行上下文的复杂参数，JANUS 不仅基于参数的预期类型生成值，更重要的是基于维护的状态，并主要遵循以下三条规则：</p>\n<ol>\n<li>如果需要文件描述符，系统调用模糊测试工具会随机选择一个打开的、且类型合适的文件描述符。例如， <code>write()</code>  需要一个普通文件的描述符，而  <code>getdents()</code>  需要一个目录的文件描述符；</li>\n<li>如果需要路径，系统调用模糊测试工具会随机选择一个现有文件或目录的路径，或者最近操作中已删除的文件或目录的路径。例如，对于  <code>rename()</code> ，JANUS 提供普通文件或目录的路径，但对于  <code>rmdir()</code> ，则只提供有效目录的路径。如果路径用于创建新文件或目录，JANUS 还可能随机生成一个位于现有目录下的新路径；</li>\n<li>如果系统调用操作某文件的现有扩展属性（例如， <code>getxattr()</code>  和  <code>setxattr()</code> ），系统调用模糊测试工具会随机选择该文件的记录扩展属性名称。</li>\n</ol>\n<p>这些生成策略使得 JANUS 能够生成面向上下文的工作负载，对新鲜文件对象进行操作，从而避免运行时错误并实现高代码覆盖率。</p>\n<p>对于新生成的系统调用，JANUS 会将其追加到程序中，并特别总结该系统调用可能对文件系统造成的变化，并相应地更新镜像的推测状态。例如， <code>open()</code> 、 <code>mkdir()</code> 、 <code>link()</code>  或  <code>symlink()</code>  可能会创建一个新文件或目录，而  <code>open()</code>  还会引入一个活动文件描述符； <code>rmdir()</code>  或  <code>unlink()</code>  会从镜像中移除一个文件或目录； <code>rename()</code>  会更新文件路径， <code>setxattr()</code>  或  <code>removexattr()</code>  会更新特定的扩展属性。</p>\n<p>需要注意的是，在当前设计中，JANUS 仅在完成程序执行后维护推测的镜像状态。因此，JANUS 避免对可能导致镜像状态变化的现有参数进行变异。例如，JANUS 可能对程序中  <code>write()</code>  的文件描述符 ( <code>fd</code> ) 进行变异，但绝不会修改  <code>unlink()</code>  的路径参数 ( <code>path</code> )，因为这样的变异可能会使变异后系统调用的后续调用无效（例如，将  <code>unlink(&quot;A&quot;)</code>  修改为  <code>unlink(&quot;B&quot;)</code>  会影响测试用例中所有后续针对文件 B 的文件操作）。</p>\n<h2 id=\"exploring-two-dimensional-input-space\"><a class=\"anchor\" href=\"#exploring-two-dimensional-input-space\">#</a> Exploring Two-Dimensional Input Space</h2>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/tzcajl.png\" alt=\"图7\" /></p>\n<blockquote>\n<p>图 7：JANUS 一次 fuzz 迭代的伪代码</p>\n</blockquote>\n<p>为了同时对元数据和系统调用进行模糊测试，JANUS 按顺序调度其两个核心模糊测试工具。图 7 描述了 JANUS 的一次模糊测试迭代。具体来说，对于一个包含缩减镜像和程序的输入测试用例，JANUS 首先启动镜像变异器，在缩减镜像上变异随机字节。如果在未改变程序的情况下没有发现新的代码路径，JANUS 会调用系统调用模糊测试工具，在程序中变异现有系统调用的参数值，并进行若干轮的变异。如果仍然没有探索到新的代码路径，JANUS 最终会尝试向程序中追加新的系统调用。需要注意的是，每个模糊测试阶段的轮数是由用户定义的。</p>\n<p>按照这种顺序调度镜像模糊测试和文件操作模糊测试的方式是有效的，原因如下：</p>\n<ol>\n<li>提取的元数据表示镜像的初始状态，元数据对文件操作执行的影响会随着镜像经过若干次系统调用操作而逐渐减小。因此，JANUS 总是首先尝试变异元数据。</li>\n<li>引入新的文件操作会指数级地增加程序的变异空间，并且可能会抹去过去操作对镜像的更改。因此，JANUS 更倾向于变异现有的系统调用，而不是生成新的系统调用。</li>\n</ol>\n<h2 id=\"library-os-based-kernel-execution-environment\"><a class=\"anchor\" href=\"#library-os-based-kernel-execution-environment\">#</a> Library OS based Kernel Execution Environment</h2>\n<p>为了避免使用老化的操作系统或文件系统导致不稳定的执行和不可复现的错误，JANUS 依赖于基于库操作系统的应用程序（即执行器）来进行操作系统功能的模糊测试。具体来说，JANUS 会为每个从模糊测试引擎生成的新镜像和工作负载分叉一个新的执行器实例（➍）。需要注意的是，与重置虚拟机实例相比，分叉用户应用程序所需的时间几乎可以忽略不计。因此，JANUS 能够以低开销保证每个测试用例都有一个干净的内核环境。此外，由于模糊测试引擎和执行器都在同一台机器的用户空间中运行，它们之间共享输入文件和覆盖位图非常简单，而这对于在虚拟机外部运行模糊测试引擎的基于虚拟机的模糊测试工具来说是一个挑战。此外，基于库操作系统的实例相比任何类型的虚拟机所需的计算资源要少得多。因此，我们可以在大规模部署 JANUS 实例，而不会引起严重的资源竞争。</p>\n<h1 id=\"implementation\"><a class=\"anchor\" href=\"#implementation\">#</a> Implementation</h1>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/52vqno.png\" alt=\"表3\" /></p>\n<blockquote>\n<p>表 3：JANUS 的实现复杂性，包括对文件系统模糊测试的 AFL 和 LKL 的更改。由于我们直接重用 AFL 中现有的二进制变异算法作为图像变异器，因此我们省略了它的代码大小。</p>\n</blockquote>\n<p>我们将 JANUS 实现为 AFL（版本 2.52b）的一个变种。JANUS 采用了 AFL 的基础架构，包括分叉服务器（forkserver）、覆盖位图以及测试用例调度算法。在此基础上，我们扩展了 AFL，加入了镜像变异器和系统调用模糊测试工具。此外，我们实现了一个镜像检查器，用于从种子镜像构建初始语料库，以及一个程序序列化器，用于在内存和工作语料库之间传递生成的程序。此外，我们基于 Linux 内核库（LKL）实现了一个执行器，用于测试新生成的镜像和工作负载。值得注意的是，我们还修改了 LKL 以支持内核地址消毒器（KASAN）[17]，这是一种被操作系统模糊测试工具广泛采用的技术，用于检测内存错误。为了便于在真实环境中复现错误，我们还实现了一个概念验证（Proof-of-Concept, PoC）生成器，该生成器能够从序列化的测试用例生成一个完整镜像以及一个可编译的 C 程序。表 3 显示了 JANUS 各组件的代码行数（LoC）。本节将详细描述几个主要组件的实现细节。</p>\n<ul>\n<li>\n<p><strong>镜像解析器和镜像变异器</strong>：我们将镜像解析器实现为一个动态库，用于定位元数据并识别种子镜像上的校验和。目前，该解析器支持解析 Linux 上八种广泛使用的文件系统的磁盘镜像，包括 ext4、XFS、Btrfs、F2FS、GFS2、HFS+、ReiserFS 和 VFAT。我们的镜像解析器实现参考了这些文件系统的用户态工具（如  <code>mkfs</code>  和  <code>fsck</code> ）。我们还实现了镜像变异器，它通过八种策略随机变异缩减镜像上的字节（见图 4）。这些变异策略直接从 AFL 中移植到 JANUS 中。</p>\n</li>\n<li>\n<p><strong>镜像检查器</strong>：我们为 JANUS 实现了一个镜像检查器，用于遍历种子镜像上的文件和目录，并记录它们在镜像中的路径、类型以及扩展属性，以便构建初始测试用例（详见 <a href=\"#building-corpus\">§4.2</a>）。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/xolsjt.png\" alt=\"图8\" /></p>\n<blockquote>\n<p>图 8：用协议缓冲语言 (protocol buffer language) 描述的序列化程序格式和推测的图像状态。</p>\n</blockquote>\n</li>\n<li>\n<p><strong>程序序列化器</strong>：我们将新生成的程序及其更新的状态描述为一种可序列化的格式（见图 8），并实现了相应的程序序列化器。序列化器可以从磁盘加载这些数据到内存中进行模糊测试和验证，同时也可以将它们从内存保存到磁盘以便记录管理。</p>\n</li>\n<li>\n<p><strong>系统调用模糊测试工具</strong>：系统调用模糊测试工具被实现为 AFL 的一个新扩展，当镜像变异无法取得进展时由 JANUS 调用。系统调用模糊测试工具接收反序列化的程序及其对应的状态，并通过系统调用变异或系统调用生成输出新的程序和更新的状态（详见 <a href=\"#fuzzing-file-operations\">§4.4</a>）。目前，JANUS 支持生成和变异 <ins class=\"dot\">34 个用于基础文件操作的系统调用</ins>。一些与文件操作相关但主要在虚拟文件系统（VFS）层实现的系统调用（如  <code>dup()</code> 、 <code>splice()</code>  和  <code>tee()</code>  等）由于测试价值不大被 JANUS 排除在外。</p>\n<blockquote>\n<p>在我们的实现中，JANUS 支持生成和变异以下 34 个系统调用： <code>read()</code> 、 <code>write()</code> 、 <code>open()</code> 、 <code>seek()</code> 、 <code>mmap()</code> 、 <code>getdents64()</code> 、 <code>pread64()</code> 、 <code>pwrite64()</code> 、 <code>stat()</code> 、 <code>lstat()</code> 、 <code>rename()</code> 、 <code>fsync()</code> 、 <code>fdatasync()</code> 、 <code>syncfs()</code> 、 <code>sendfile()</code> 、 <code>access()</code> 、 <code>ftruncate()</code> 、 <code>truncate()</code> 、 <code>fstat()</code> 、 <code>statfs()</code> 、 <code>fstatfs()</code> 、 <code>utimes()</code> 、 <code>mkdir()</code> 、 <code>rmdir()</code> 、 <code>link()</code> 、 <code>unlink()</code> 、 <code>symlink()</code> 、 <code>readlink()</code> 、 <code>chmod()</code> 、 <code>fchmod()</code> 、 <code>setxattr()</code> 、 <code>fallocate()</code> 、 <code>listxattr()</code> 、 <code>removexattr()</code> 。</p>\n</blockquote>\n<p>在我们的实现中，JANUS 基本上会对测试用例中的元数据进行 256 轮变异，这与 AFL 的混乱阶段（havoc stage, 即非确定性变异）的默认设置一致。如果代码覆盖未能增加，JANUS 会尝试对现有系统调用进行 128 轮变异，并追加新的系统调用进行 64 轮测试。由于镜像变异在探索二维输入空间时的优先级更高（详见 <a href=\"#exploring-two-dimensional-input-space\">§4.5</a>），JANUS 在镜像变异上投入了更多的精力。</p>\n</li>\n<li>\n<p><strong>基于 LKL 的执行器</strong>：我们为 JANUS 构建的执行器基于 <strong>Linux Kernel Library (LKL)</strong>，LKL 是一种典型的库操作系统（Library OS），用于将内核接口暴露给用户态程序。图 11 展示了一个使用 LKL 系统调用操作 ext4 镜像的代码示例。官方的 LKL 目前支持 Linux 内核 v4.16，我们将其移植以兼容更新版本，包括 v4.17 和 v4.18。为了在运行时实现 AFL 风格的路径覆盖，我们实现了一个 <strong>GCC 包装器</strong>，在构建 LKL 时选择性地对目标文件系统的源代码文件进行插装。此外，我们实现了一个链接到 LKL 的用户应用程序（即执行器），作为 JANUS 的模糊测试目标。对于生成的测试用例，执行器通过 forkserver 创建一个新实例，并调用 LKL 系统调用来挂载由镜像变异器修改的镜像，同时执行由系统调用模糊测试工具生成的一系列文件操作。</p>\n</li>\n</ul>\n<p>由于每次将完整镜像写入磁盘会消耗大量时间，我们引入了一个持久内存缓冲区（persistent memory buffer），由 JANUS 的模糊测试引擎与基于 LKL 的执行器共享，用于存储镜像（即图 3 中的  <code>ctx.image_buffer</code> ）。随后，我们修改了 LKL 文件系统下层的块设备驱动程序，使其在获取镜像数据时访问内存缓冲区，而不是磁盘上的镜像文件。</p>\n<p>我们在运行时应用了写时复制（CoW，Copy-on-Write）技术，以确保在生成的工作负载操作镜像缓冲区时，除了变异的块之外，镜像缓冲区中的其他部分永远不会发生变化。具体来说，当设备驱动程序试图在运行时将任意字节刷新回镜像上的某个块时，该块会被复制以供修改，后续的访问将针对复制后的块。</p>\n<p>我们还将 <strong>KASAN</strong> 移植到 LKL，以在运行时有效检测内存错误。KASAN 在运行时分配影子内存（shadow memory），用于记录原始内存中的每个字节是否可以安全访问。需要注意的是，KASAN 依赖 MMU（内存管理单元）将地址翻译为对应的影子地址，但 LKL 不支持这一功能。为了解决这一问题，我们在 LKL 启动时保留了影子内存空间，并建立了从 LKL 的内存空间到影子内存的映射。</p>\n<h1 id=\"evaluation\"><a class=\"anchor\" href=\"#evaluation\">#</a> Evaluation</h1>\n<p>详见论文 EVALUATION 章节。</p>\n<h1 id=\"discussion\"><a class=\"anchor\" href=\"#discussion\">#</a> Discussion</h1>\n<p>我们已经证明，JANUS 能够有效地探索代码路径，并在 Linux 内核中的磁盘文件系统中发现未知漏洞。接下来，我们将讨论 JANUS 的局限性以及未来的发展方向。</p>\n<ul>\n<li>\n<p><strong>基于库操作系统的执行器</strong>：JANUS 依赖于 LKL（Linux Kernel Library）来测试内核文件系统。事实上，其他操作系统模糊测试工具也可以利用 LKL 测试内核的其他子系统，除了依赖 MMU 的组件。例如，在不修改 LKL 的情况下，JANUS 无法对文件系统的 DAX 模式进行模糊测试。我们也可以使用用户模式 Linux（UML），如 Oracle 的内核模糊测试工具所采用的方式。然而，UML 的多进程设计存在限制，这会使得在每次迭代中定位内核崩溃并终止其所有进程变得复杂。因此，UML 并不适合将内核作为用户应用程序进行模糊测试。</p>\n</li>\n<li>\n<p><strong>最小化的 PoC 生成器</strong>：一个理想的 PoC（概念验证）应该包含一个仅包含关键错误字节的镜像文件，以及一个最少文件操作的程序。为此，JANUS 当前通过暴力方式尝试恢复每个被修改的字节，并逐一删除每个被调用的文件操作，以检查内核是否仍然会在预期位置崩溃。尽管这种方法并非最优，但我们可以利用某些文件系统工具（如  <code>fsck</code>  和  <code>debugfs</code> ）以及系统调用跟踪提炼技术来定位导致问题的字节和系统调用。另一种可能性是对内核应用污点跟踪。</p>\n</li>\n<li>\n<p><strong>模糊测试 FUSE 驱动程序</strong>：目前，JANUS 不支持依赖 FUSE（Filesystem in Userspace，用户态文件系统）的文件系统（例如 NTFS、GVfs、SSHFS 等）。只要这些文件系统将用户数据存储在磁盘镜像中，并支持用户与数据交互的某些文件操作，就可以轻松扩展 JANUS 的模糊测试引擎以测试这些文件系统。</p>\n</li>\n<li>\n<p><strong>模糊测试文件系统工具</strong>：开发者在很大程度上依赖系统工具（例如  <code>mkfs</code> 、 <code>fsck</code>  等）来管理文件系统。例如，Linux 会自动启动  <code>fsck</code>  以从系统突然崩溃中恢复磁盘数据。此外，用户会使用  <code>fsck</code>  来检查未受信任磁盘镜像的一致性，然后再挂载该磁盘。因此，开发者希望这些工具没有漏洞。我们认为，开发者可以轻松扩展 JANUS 的镜像变异器来生成损坏的镜像，从而对这些工具进行模糊测试并提高其健壮性。实际上，我们使用 JANUS 找到了  <code>fsck.ext4</code>  中的两个未知漏洞，其中一个已经被修复。</p>\n</li>\n<li>\n<p><strong>扩展以测试其他操作系统上的文件系统</strong>：如果存在对应的库操作系统解决方案，扩展 JANUS 以测试其他操作系统上的内核文件系统将非常简单。例如，Drawbridge 使得 Windows 可以高效地以进程方式运行。此外，我们还可以将 JANUS 的核心模糊测试引擎与其他通用内核模糊测试框架（例如基于 QEMU 和 KVM 构建的 kAFL）集成，用于测试 Windows 和 macOS 等主流操作系统使用的文件系统。</p>\n</li>\n<li>\n<p><strong>改进其他文件系统测试工具</strong>：JANUS 的目标是发现文件系统中的通用安全漏洞，这与其他工具（如崩溃一致性检查器和语义正确性检查器）的目标不同。然而，这些工具也需要文件操作序列。因此，JANUS 可以成为一个综合解决方案，为其他工具提供支持。</p>\n</li>\n</ul>\n<h1 id=\"related-work\"><a class=\"anchor\" href=\"#related-work\">#</a> Related Work</h1>\n<p><strong>结构化输入模糊测试</strong><br />\n许多方法已被提出，用于模糊测试高度结构化的输入，例如文件系统镜像。与 JANUS 不同，一些生成式模糊测试工具（[1, 2, 3, 4, 5]）基于手动描述的输入规范，从零构建语法正确的输入。此外，EXE [6] 依赖符号执行生成满足深层路径约束的有效输入。一些更先进的方法（例如 [7, 8, 9]）通过一组样本学习输入结构。另一方面，基于变异的模糊测试工具（[10, 11, 12, 13, 14, 15, 16]）通过变异有效样本生成新的输入。生成的输入具有正确的结构但包含轻微错误，从而有可能触发漏洞。</p>\n<blockquote>\n<ol>\n<li>I. Fratric. DOM fuzzer. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZXByb2plY3R6ZXJvL2RvbWF0bw==\">https://github.com/googleprojectzero/domato</span>, 2018.</li>\n<li>R. Hodován, Á. Kiss, and T. Gyimóthy. Grammarinator: a grammar-based open source fuzzer. In Proceedings of the 9th ACM SIGSOFT International Workshop on Automating TEST Case Design, Selection, and Evaluation, pages 45–48. ACM, 2018.</li>\n<li>Mozilla Corporation. MozPeach. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL01vemlsbGFTZWN1cml0eS9wZWFjaA==\">https://github.com/MozillaSecurity/peach</span>, 2017.</li>\n<li>Mozilla Corporation. JavaScript engine fuzzers. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL01vemlsbGFTZWN1cml0eS9mdW5mdXp6\">https://github.com/MozillaSecurity/funfuzz</span>, 2018.</li>\n<li>Peach Tech. Peach Fuzzer. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2Vmb3JnZS5uZXQvcHJvamVjdHMvcGVhY2hmdXp6\">https://sourceforge.net/projects/peachfuzz</span>, 2016.</li>\n<li>C. Cadar, V. Ganesh, P. M. Pawlowski, D. L. Dill, and D. R. Engler. EXE: automatically generating inputs of death. ACM Transactions on Information and System Security (TISSEC), 12(2):10, 2008.</li>\n<li>O. Bastani, R. Sharma, A. Aiken, and P. Liang. Synthesizing program input grammars. In ACM SIGPLAN Notices, pages 95–110. ACM, 2017.</li>\n<li>P. Godefroid, H. Peleg, and R. Singh. Learn&amp;fuzz: Machine learning for input fuzzing. In Proceedings of the 32nd IEEE/ACM International Conference on Automated Software Engineering (ASE), Champaign, IL, Oct. 2017.</li>\n<li>M. Höschele and A. Zeller. Mining input grammars from dynamic taints. In Proceedings of the 32nd IEEE/ACM International Conference on Automated Software Engineering (ASE), Champaign, IL, Oct. 2017.</li>\n<li>M. Böhme, V.-T. Pham, and A. Roychoudhury. Coverage-based greybox fuzzing as markov chain. In Proceedings of the 23rd ACM Conference on Computer and Communications Security (CCS), Vienna, Austria, Oct. 2016.</li>\n<li>M. Böhme, V.-T. Pham, M.-D. Nguyen, and A. Roychoudhury. Directed greybox fuzzing. In Proceedings of the 24th ACM Conference on Computer and Communications Security (CCS), Dallas, TX, Oct.–Nov. 2017.</li>\n<li>P. Chen and H. Chen. Angora: Efficient Fuzzing by Principled Search. In Proceedings of the 39th IEEE Symposium on Security and Privacy (Oakland), San Francisco, CA, May 2018.</li>\n<li>S. Gan, C. Zhang, X. Qin, X. Tu, K. Li, Z. Pei, and Z. Chen. CollAFL: Path Sensitive Fuzzing. In Proceedings of the 39th IEEE Symposium on Security and Privacy (Oakland), San Francisco, CA, May 2018.</li>\n<li>Google. OSS-Fuzz - Continuous Fuzzing for Open Source Software. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9vc3MtZnV6eg==\">https://github.com/google/oss-fuzz</span>, 2018.</li>\n<li>LLVM Project. libFuzzer - a library for coverage-guided fuzz testing. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xpYkZ1enplci5odG1s\">https://llvm.org/docs/LibFuzzer.html</span>, 2018.</li>\n<li>M. Zalewski. american fuzzy lop (2.52b). <span class=\"exturl\" data-url=\"aHR0cDovL2xjYW10dWYuY29yZWR1bXAuY3gvYWZs\">http://lcamtuf.coredump.cx/afl</span>, 2018.</li>\n</ol>\n</blockquote>\n<p>考虑到文件系统镜像的复杂性以及不同文件系统间镜像格式的多样性，JANUS 采用基于变异的策略对镜像进行模糊测试。类似文件系统镜像，许多文件格式通过校验和进行完整性检查。JANUS 利用专业知识修复元数据校验和。然而，一些支持校验和的模糊测试工具（[17, 18]）通过动态污点分析识别校验和字段，并在运行时绕过校验和检查。</p>\n<blockquote>\n<ol start=\"17\">\n<li>\n<p>X. Liu, Q. Wei, Q. Wang, Z. Zhao, and Z. Yin. CAFA: A Checksum-Aware Fuzzing Assistant Tool for Coverage Improvement. Security and Communication Networks, 2018, 2018.</p>\n</li>\n<li>\n<p>T. Wang, T. Wei, G. Gu, and W. Zou. TaintScope: A checksum-aware directed fuzzing tool for automatic software vulnerability detection. In Proceedings of the 31th IEEE Symposium on Security and Privacy (Oakland), Oakland, CA, May 2010.</p>\n</li>\n</ol>\n</blockquote>\n<p><strong>操作系统内核模糊测试工具</strong><br />\n为发现操作系统中的安全漏洞，已有许多通用的内核模糊测试框架（[19, 20, 21, 22]）以及特定操作系统的内核模糊测试工具（[23, 24, 25, 26, 27]）。与 JANUS 不同，这些工具基于预定义的语法规则生成随机系统调用，但这种方法在文件系统模糊测试中效率较低。一些最新的操作系统模糊测试工具，如 IMF [23] 和 MoonShine [28]，关注种子精简，这与本工作无直接冲突。然而，JANUS 可以利用这些方法生成高质量的种子程序作为起点。</p>\n<blockquote>\n<ol start=\"19\">\n<li>Google. syzkaller is an unsupervised, coverage-guided kernel fuzzer. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9zeXprYWxsZXI=\">https://github.com/google/syzkaller</span>, 2018.</li>\n<li>MWR Labs. Cross Platform Kernel Fuzzer Framework. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL213cmxhYnMvS2VybmVsRnV6emVy\">https://github.com/mwrlabs/KernelFuzzer</span>, 2016.</li>\n<li>NCC Group. AFL/QEMU fuzzing with full-system emulation. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL25jY2dyb3VwL1RyaWZvcmNlQUZM\">https://github.com/nccgroup/TriforceAFL</span>, 2017.</li>\n<li>S. Schumilo, C. Aschermann, R. Gawlik, S. Schinzel, and T. Holz. kafl: Hardware-assisted feedback fuzzing for OS kernels. In Proceedings of the 26th USENIX Security Symposium (Security), Vancouver, BC, Canada, Aug. 2017.</li>\n<li>H. Han and S. K. Cha. IMF: Inferred Model-based Fuzzer. In Proceedings of the 24th ACM Conference on Computer and Communications Security (CCS), Dallas, TX, Oct.–Nov. 2017.</li>\n<li>D. Jones. Linux system call fuzzer. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2tlcm5lbHNsYWNrZXIvdHJpbml0eQ==\">https://github.com/kernelslacker/trinity</span>, 2018.</li>\n<li>MWR Labs. macOS Kernel Fuzzer. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL213cmxhYnMvT1NYRnV6eg==\">https://github.com/mwrlabs/OSXFuzz</span>, 2017.</li>\n<li>NCC Group. System call fuzzing of OpenBSD amd64 using TriforceAFL. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL25jY2dyb3VwL1RyaWZvcmNlT3BlbkJTREZ1enplcg==\">https://github.com/nccgroup/TriforceOpenBSDFuzzer</span>, 2016.</li>\n<li>NCC Group. A linux system call fuzzer using TriforceAFL. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL25jY2dyb3VwL1RyaWZvcmNlTGludXhTeXNjYWxsRnV6emVy\">https://github.com/nccgroup/TriforceLinuxSyscallFuzzer</span>, 2017.</li>\n<li>S. Pailoor, A. Aday, and S. Jana. MoonShine: Optimizing OS Fuzzer Seed Selection with Trace Distillation. In Proceedings of the 27th USENIX Security Symposium (Security), Baltimore, MD, Aug. 2018.</li>\n</ol>\n</blockquote>\n<p><strong>文件系统语义正确性检查工具</strong><br />\n JUXTA [29] 和 SibylFS [30] 是另一类文件系统检查工具，旨在通过静态分析和高层次建模文件系统行为，验证文件系统的实现是否完全符合标准（例如 POSIX 标准、手册页等）。它们的目标和方法与 JANUS 不同。然而，JANUS 可以生成有意义的系统调用来发现崩溃一致性问题 [31, 32]。</p>\n<blockquote>\n<ol start=\"29\">\n<li>C. Min, S. Kashyap, B. Lee, C. Song, and T. Kim. Cross-checking semantic correctness: The case of finding file system bugs. In Proceedings of the 25th ACM Symposium on Operating Systems Principles (SOSP), Monterey, CA, Oct. 2015.</li>\n<li>T. Ridge, D. Sheets, T. Tuerk, A. Giugliano, A. Madhavapeddy, and P. Sewell. SibylFS: formal specification and oracle-based testing for POSIX and real-world file systems. In Proceedings of the 25th ACM Symposium on Operating Systems Principles (SOSP), Monterey, CA, Oct. 2015.</li>\n<li>J. Bornholt, A. Kaufmann, J. Li, A. Krishnamurthy, E. Torlak, and X. Wang. Specifying and checking file system crash-consistency models. In Proceedings of the 21st ACM International Conference on Architectural Support for Programming Languages and Operating Systems (ASPLOS), Atlanta, GA, Apr. 2016.</li>\n<li>J. Yang, C. Sar, and D. Engler. Explode: a lightweight, general system for finding serious storage system errors. In Proceedings of the 7th USENIX Symposium on Operating Systems Design and Implementation (OSDI), Seattle, WA, Nov. 2006.</li>\n</ol>\n</blockquote>\n<p><strong>文件系统抽象</strong><br />\n一些研究（[33, 34]）提出了通用接口，使文件系统工具能够通过高级抽象访问和操作各种文件系统的磁盘元数据。通过利用这些接口，JANUS 可以以更通用的方式压缩磁盘镜像，而无需为每个目标文件系统实现特定的镜像解析器。</p>\n<blockquote>\n<ol start=\"33\">\n<li>K. Sun, D. Fryer, J. Chu, M. Lakier, A. D. Brown, and A. Goel. Spiffy: enabling file-system aware storage applications. In Proceedings of the 16th USENIX Conference on File and Storage Technologies (FAST), Oakland, CA, Feb. 2018.</li>\n<li>K. Sun, M. Lakier, A. D. Brown, and A. Goel. Breaking Apart the VFS for Managing File Systems. In Proceedings of the 10th USENIX Workshop on Hot Topics in Storage and File Systems, Boston, MA, July<br />\n2018.</li>\n</ol>\n</blockquote>\n<h1 id=\"conclusion\"><a class=\"anchor\" href=\"#conclusion\">#</a> Conclusion</h1>\n<p>在这项工作中，我们提出了 JANUS，一种进化式文件系统模糊测试工具，它通过探索二维输入空间（即镜像和文件操作）来测试内核文件系统。与现有的文件系统模糊测试工具不同，JANUS 能高效变异输入镜像的元数据块，同时在镜像上生成上下文感知的工作负载。不同于传统的虚拟机，JANUS 依赖支持快速重加载的库操作系统来测试操作系统功能，从而避免了不稳定的执行和无法重现的漏洞。</p>\n<p>我们向上游内核报告了 JANUS 发现的 <strong>90 个漏洞</strong>，其中 <strong>43 个</strong>已被修复，并分配了 <strong>32 个 CVE</strong>。在对流行文件系统进行 12 小时模糊测试时，JANUS 最多比 Syzkaller 探索了 **4.19 倍 ** 的代码路径，并成功复现了已发现崩溃的 <strong>88%-100%</strong>。我们计划开源 JANUS 的实现，由于我们的显著成果，已有多个文件系统开发社区提出了开源需求。我们相信，JANUS 将成为文件系统测试的 “一站式解决方案”，因为它可以作为基础设施，用于设计新的文件系统语义检查器和崩溃一致性检查工具。</p>\n",
            "tags": [
                "科研",
                "论文阅读",
                "文件系统",
                "论文阅读",
                "Fuzz"
            ]
        },
        {
            "id": "https://gality.cn/os/fs/FAT32/",
            "url": "https://gality.cn/os/fs/FAT32/",
            "title": "文件系统详解 ｜ FAT32",
            "date_published": "2024-12-19T08:51:11.000Z",
            "content_html": "<div class=\"note info no-icon\">\n<p>FAT 文件系统起源于 1980 年左右，是 MS-DOS 首次支持的文件系统。它最初是一个简单的文件系统，适用于容量小于 500k 字节的软盘。随着时间的推移，它的规格不断扩大，支持的介质也越来越多，容量也越来越大。FAT 是 File Allocation Table（文件分配表）的缩写，是管理数据区分配的阵列，也是文件系统本身的名称。目前有三种 FAT 子类型： <code>FAT12</code> 、 <code>FAT16</code>  和  <code>FAT32</code> 。这些子类型按编号顺序开发，完全向后兼容旧版本。( <code>FAT16</code>  总是包括  <code>FAT12</code> ， <code>FAT32</code>  包括所有 FAT 类型）。由于 <code>FAT12</code>  和 <code>FAT16</code>  最大卷大小只能支持到 <code>256MB</code>  和 <code>4GB</code> ，所以现代更多使用的是 <code>FAT32</code>  文件系统（最大卷大小 <code>2T</code> ），所以本文着重介绍 <code>FAT32</code>  的结构。</p>\n<p>⚠️ 笔者水平有限，如有错误跪请留言指正 Orz</p>\n</div>\n<h1 id=\"文件系统基本概念\"><a class=\"anchor\" href=\"#文件系统基本概念\">#</a> 文件系统基本概念</h1>\n<ul>\n<li>\n<p><ins>扇区（Sector）</ins>：扇区是存储设备上用于读写的<strong>最小数据块单位</strong>。传统上一个硬盘扇区的大小是<strong> 512</strong> 字节。但在高级格式化硬盘中，物理扇区大小是 4096 字节，不过依然向下支持 512 字节。存储设备上的每个扇区都由一个扇区号寻址，该扇区号从存储设备顶部依次排列。</p>\n</li>\n<li>\n<p><ins>块（Block）/ 簇（Cluster）</ins>：块（簇）是 操作系统与磁盘（硬盘）交互的最小数据单元（在 Linux 中称为块，在 windows 中称为簇）， 块的大小在硬盘格式化时被指定，一般有 1K，2K，4K（最常用）。如果块的大小设置为 4K，那么磁盘要读取 8 个扇区之后，才将数据块传给操作系统。另外，块也是 DOS 下数据存储的最小单元。例如，如果一个文件的大小为 1K，而块的大小为 4K，那么该文件还是会占用一个块，块中剩下的 3K 被空闲出来，不能用于存储其他数据。</p>\n<details class=\"primary\"><summary>扇区 vs. 簇</summary><div>\n<p>扇区是对硬盘而言的，在物理层；块和簇是对文件系统而言的，是逻辑层。</p>\n<p>簇和块是操作系统操作的最小单位，扇区是磁头从磁盘中读取数据的最小单位。</p>\n<p>一般来说操作系统会将物理磁盘中的多个连续扇区合并成簇来管理，每个簇一般包括 2 的整数幂（2、4、8 等）个扇区。</p>\n</div></details>\n</li>\n<li>\n<p><ins>分区（partition）</ins>：故名思意就是将一块儿磁盘上的一些连续扇区划分成独立的逻辑区域，一般情况下可以将一个磁盘分为多个分区。每个分区可以格式化为一个 “卷”。分区被限制在一块磁盘中，不能跨磁盘建立分区。分区的记录存储在磁盘的第一个扇区中，它是一种较低层次的概念。</p>\n</li>\n<li>\n<p><ins>卷（volume）</ins>：一种更高级、更抽象的分区，可以包含多个分区或多个物理硬盘，可以跨硬盘使用，是操作系统眼中的 “硬盘的样子”，每个卷有自己的文件系统并支持许多高级功能（如快照、压缩等）。这样我们可以认为，“卷” 是 “分区” 的扩展，“分区” 是 “卷” 的一种特殊情况。</p>\n</li>\n</ul>\n<h1 id=\"fat32-详解\"><a class=\"anchor\" href=\"#fat32-详解\">#</a> FAT32 详解</h1>\n<p>FAT 文件系统用 “簇” 作为数据单元。一个 “簇” 由一组连续的扇区组成，簇所含的扇区数必须是 2 的整数次幂。簇的最大值为 64 个扇区，即 32KB。在 FAT 文件系统中，同时使用 “扇区地址” 和 “簇地址” 两种地址管理方式。这是因为只有存储用户数据的数据区使用簇进行管理，其他文件系统管理数据区域是不以簇进行管理的，这部分区域使用扇区地址进行管理。文件系统的起始扇区为 0 号扇区（逻辑 0 号扇区，因为卷可以不在物理磁盘的第一个分区）。</p>\n<div class=\"note info\">\n<p>请仔细区分 <code>FAT卷</code> 和 <code>FAT表</code> 的不同， <code>FAT卷</code> 指的是<ins class=\"wavy\"> FAT 文件系统</ins>，而 <code>FAT表</code> 指的是<ins class=\"wavy\"> FAT 文件系统中 FAT 区域</ins>。</p>\n</div>\n<h2 id=\"fat32-整体布局\"><a class=\"anchor\" href=\"#fat32-整体布局\">#</a> FAT32 整体布局</h2>\n<p>FAT32 文件系统由保留扇区，FAT1，FAT2 和 DATA 四个部分组成，其结构如下图：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/c1410.png\" alt=\"FAT32 filesystem structure\" /></p>\n<p>这些结构是在分区被格式化时创建出来的，含义解释如下：</p>\n<ul>\n<li>\n<p>保留区域：包括引导扇区和保留扇区，是文件系统的隐藏区域，记录着文件系统相关的信息。</p>\n</li>\n<li>\n<p>FAT1：FAT 的含义是文件分配表，FAT32 一般有两份 FAT，FAT1 是第一份，也是主 FAT。</p>\n</li>\n<li>\n<p>FAT2：FAT2 是 FAT32 的第二份文件分配表，也是 FAT1 的备份。</p>\n</li>\n<li>\n<p>DATA：数据区，是 FAT32 文件系统的主要区域，其中包含目录区域。</p>\n</li>\n</ul>\n<h2 id=\"fat32-保留区\"><a class=\"anchor\" href=\"#fat32-保留区\">#</a> FAT32 保留区</h2>\n<p>保留区包括 “引导扇区”（主引导扇区），” 备份引导扇区 “和 “保留扇区”。</p>\n<h3 id=\"引导扇区boot-sector\"><a class=\"anchor\" href=\"#引导扇区boot-sector\">#</a> 引导扇区（Boot Sector）</h3>\n<p>在 FAT 文件系统中，文件系统的数据记录在 “引导扇区” 中。引导扇区从整个文件系统的 0 号扇区开始，长度为 3 个扇区，也称其为 DBR（DOS Boot Recorder——DOS 引导记录）扇区，DBR 中记录着文件系统的起始位置、大小、FAT 表个数及大小等相关信息，这些对于 FAT 至关重要的配置参数所在区域也被称为 BPB（BIOS Parameter Block），由于历史原因，BPB 的定义一直在变化。下表列出了引导扇区的数据字段，任何以  <code>BPB_</code> 命名的字段都是 BPB 的一部分。任何以  <code>BS_</code>  为标题的字段都不是 BPB 的一部分，而只是引导扇区的一部分：</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>偏移</th>\n<th>大小</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>BS_JmpBoot</code></td>\n<td>0</td>\n<td>3</td>\n<td>跳转到操作系统启动过程使用的引导代码（x86 指令）的指令。该字段有两种格式，首选前一种格式。<br/>-  <code>0xEB, 0x??, 0x90 (Short jump + NOP)</code>  <br />-  <code>0xE9, 0x??, 0x?? (Near jump)</code> <br/> <code>??</code>  是任意值，取决于跳转的位置。如果使用这些格式以外的任何格式，Windows 将无法识别卷。</td>\n</tr>\n<tr>\n<td><code>BS_OEMName</code></td>\n<td>3</td>\n<td>8</td>\n<td>推荐使用  <code>MSWIN 4.1</code> ，而  <code>MSDOS 5.0</code>  也经常被使用。关于该字段存在许多误解。这仅仅是一个名字，微软的操作系统并不会关注这个字段，但一些 FAT 驱动程序会参考它。推荐使用上述字符串是因为它被认为可以最大程度地减少兼容性问题。你也可以设置其他值，但某些 FAT 驱动程序可能无法识别该卷。此字段通常表示创建该卷的系统名称。</td>\n</tr>\n<tr>\n<td><code>BPB_BytsPerSec</code></td>\n<td>11</td>\n<td>2</td>\n<td>字节为单位的扇区大小。此字段的有效值为  <code>512</code> 、 <code>1024</code> 、 <code>2048</code>  或  <code>4096</code> 。微软操作系统能够正确支持这些扇区大小。一些 FAT 驱动程序假设扇区大小为  <code>512</code> ，并且不会检查此字段。因此，为了最大兼容性，应使用  <code>512</code> 。不过，不要误解为此字段仅与兼容性有关。此值必须与包含 FAT 卷的存储设备的扇区大小一致。</td>\n</tr>\n<tr>\n<td><code>BPB_SecPerClus</code></td>\n<td>13</td>\n<td>1</td>\n<td>每个分配单元的扇区数。在 FAT 文件系统中，分配单元被称为簇 (Cluster)。簇是由一个或多个连续扇区组成的数据块，数据区以此单元进行管理。每个簇的扇区数必须是 2 的幂，因此有效值为 1、2、4、... 以及 128。不过，簇大小 ( <code>BPB_BytsPerSec</code>  *  <code>BPB_SecPerClus</code> ) 超过  <code>32 KB</code>  的值不应使用。尽管现代系统（如 Windows）支持超过  <code>32 KB</code>  的簇大小（如  <code>64 KB</code> 、 <code>128 KB</code>  和  <code>256</code>  KB），但 MS-DOS 或旧版磁盘工具无法正确识别此类卷。</td>\n</tr>\n<tr>\n<td><code>BPB_ResvdSecCnt</code></td>\n<td>14</td>\n<td>2</td>\n<td>保留区中的扇区数。此字段不能为  <code>0</code> ，因为包含此 BPB 的引导扇区本身就在保留区域中。为避免兼容性问题，在  <code>FAT12/16</code>  卷上此字段应为  <code>1</code> ，这是因为一些旧版 FAT 驱动程序忽略此字段，并假设保留区域的大小为  <code>1</code> 。在  <code>FAT32</code>  卷上，通常设置为  <code>32</code> 。微软的操作系统能正确支持值为 1 或更大的任何值。</td>\n</tr>\n<tr>\n<td><code>BPB_NumFATs</code></td>\n<td>16</td>\n<td>1</td>\n<td>FAT 表的数量。此字段的值应始终为  <code>2</code> 。任何值大于或等于  <code>1</code>  都是有效的，但强烈建议不要使用除  <code>2</code>  以外的值以避免兼容性问题。微软的 FAT 驱动程序能正确支持非 2 的值，但一些工具和 FAT 驱动程序会忽略此字段，并假设 FAT 表的数量为  <code>2</code> 。设置为  <code>2</code>  是标准值，用于为 FAT 数据提供冗余。通常从第一个 FAT 表读取条目，并将更改同步到所有 FAT 副本。如果 FAT 区域的某个扇区损坏，数据不会丢失，因为另一份 FAT 中有备份，从而最大程度降低数据丢失风险。在非磁盘存储（如存储卡）中，此冗余功能无意义，因此可将 FAT 表数量设置为  <code>1</code>  来节省空间。但某些 FAT 驱动程序可能无法正确识别此类卷。</td>\n</tr>\n<tr>\n<td><code>BPB_RootEntCnt</code></td>\n<td>17</td>\n<td>2</td>\n<td>在  <code>FAT12/16</code>  卷上，此字段表示根目录中  <code>32</code>  字节目录项的数量。该值应设置为使根目录的大小对齐到扇区的边界，即  <code>BPB_RootEntCnt * 32</code>  是  <code>BPB_BytsPerSec</code>  的整倍数。为最大兼容性， <code>FAT16</code>  卷上此字段应设置为  <code>512</code> 。在  <code>FAT32</code>  卷上，此字段必须为  <code>0</code> 。</td>\n</tr>\n<tr>\n<td><code>BPB_TotSec16</code></td>\n<td>19</td>\n<td>2</td>\n<td>旧的  <code>16</code>  位字段中卷的总扇区数。该值包括卷的所有四个区域的扇区数。当  <code>FAT12/16</code>  卷的扇区数为  <code>0x10000</code>  或更大时，此字段将设置为无效值  <code>0</code> ，而实际值存储在  <code>BPB_TotSec32</code>  中。在  <code>FAT32</code>  卷中，此字段必须始终为  <code>0</code> 。</td>\n</tr>\n<tr>\n<td><code>BPB_Media</code></td>\n<td>21</td>\n<td>1</td>\n<td>此字段的有效值为  <code>0xF0</code> 、 <code>0xF8</code> 、 <code>0xF9</code> 、 <code>0xFA</code> 、 <code>0xFB</code> 、 <code>0xFC</code> 、 <code>0xFD</code> 、 <code>0xFE</code>  和  <code>0xFF</code> 。 <code>0xF8</code>  是非可移动磁盘的标准值， <code>0xF0</code>  常用于未分区的可移动磁盘。另一个重要点是，同样的值必须设置在  <code>FAT[0]</code>  的低  <code>8</code>  位。这源于 MS-DOS 1.0 的媒体确定方法，但现在不再有任何实际用途。</td>\n</tr>\n<tr>\n<td><code>BPB_FATSz16</code></td>\n<td>22</td>\n<td>2</td>\n<td>FAT 表占用的扇区数。此字段仅适用于  <code>FAT12/16</code>  卷。在  <code>FAT32</code>  卷上，该字段必须是无效值  <code>0</code> ，改用  <code>BPB_FATSz32</code> 。 <code>FAT</code>  区域的大小为  <code>BPB_FATSz?? * BPB_NumFATs</code>  扇区。</td>\n</tr>\n<tr>\n<td><code>BPB_SecPerTrk</code></td>\n<td>24</td>\n<td>2</td>\n<td>每磁道的扇区数。此字段仅与具有几何结构的介质相关，并且仅用于 IBM PC 的磁盘 BIOS。</td>\n</tr>\n<tr>\n<td><code>BPB_NumHeads</code></td>\n<td>26</td>\n<td>2</td>\n<td>磁头数量。此字段仅与具有几何结构的介质相关，并且仅用于 IBM PC 的磁盘 BIOS。</td>\n</tr>\n<tr>\n<td><code>BPB_HiddSec</code></td>\n<td>28</td>\n<td>4</td>\n<td>FAT 卷前的隐藏物理扇区数。通常与 IBM PC 磁盘 BIOS 访问的存储相关，此字段的值取决于平台。如果卷从存储的起始处开始（如未分区磁盘，例如软盘），此字段应始终为  <code>0</code> 。</td>\n</tr>\n<tr>\n<td><code>BPB_TotSec32</code></td>\n<td>32</td>\n<td>4</td>\n<td>新的  <code>32</code>  位字段中 FAT 卷的总扇区数。该值包括卷的所有四个区域的扇区数。当  <code>FAT12/16</code>  卷的扇区数小于  <code>0x10000</code>  时，此字段必须为无效值  <code>0</code> ，而实际值存储在  <code>BPB_TotSec16</code>  中。在 FAT32 卷中，此字段始终有效，而旧字段不再使用。</td>\n</tr>\n<tr>\n<td><code>BPB_FATSz32</code></td>\n<td>36</td>\n<td>4</td>\n<td>FAT 表的大小（以扇区为单位）。 <code>FAT</code>  区域的总大小为  <code>BPB_FATSz32 * BPB_NumFATs</code>  扇区。 此字段是唯一一个需要在确定 FAT 类型前被引用的字段，但该字段仅存在于  <code>FAT32</code>  卷中。</td>\n</tr>\n<tr>\n<td><code>BPB_ExtFlags</code></td>\n<td>40</td>\n<td>2</td>\n<td>扩展标志位，用于管理 FAT 表的活动状态和镜像。 <br />Bit3-0: 活动 FAT，从 0 开始计数。当 Bit7 为 1 时有效。<br />Bit6-4: 保留位（应设置为 0）。 <br />Bit7:   <code>0</code> : 所有 FAT 表都处于活动状态并被镜像。  <code>1</code> : 仅由 Bit3-0 指定的 FAT 表处于活动状态。<br /> Bit15-8-4: 保留位（应设置为 0）。</td>\n</tr>\n<tr>\n<td><code>BPB_FSVer</code></td>\n<td>42</td>\n<td>2</td>\n<td><code>FAT32</code>  版本号。高字节为主版本号，低字节为次版本号。此字段为  <code>FAT32</code>  文件系统未来扩展预留，实际  <code>FAT32</code>  卷的更新已停止，所以这里一直是默认值 <code>0.0</code> 。</td>\n</tr>\n<tr>\n<td><code>BPB_RootClus</code></td>\n<td>44</td>\n<td>4</td>\n<td>根目录的第一个簇号。通常设置为  <code>2</code> （即卷的第一个簇），但不一定总是  <code>2</code> 。</td>\n</tr>\n<tr>\n<td><code>BPB_FSInfo</code></td>\n<td>48</td>\n<td>2</td>\n<td><code>FSInfo</code>  结构的扇区偏移量（相对于  <code>FAT32</code>  卷的起始位置）。通常设置为  <code>1</code> ，即位于引导扇区的下一个扇区。</td>\n</tr>\n<tr>\n<td><code>BPB_BkBootSec</code></td>\n<td>50</td>\n<td>2</td>\n<td>备份引导扇区的扇区偏移量（相对于  <code>FAT32</code>  卷的起始位置）。通常设置为  <code>6</code> ，即紧邻引导扇区的位置。不推荐设置其他值。</td>\n</tr>\n<tr>\n<td><code>BPB_Reserved</code></td>\n<td>52</td>\n<td>12</td>\n<td>保留字段，必须填充为 0。</td>\n</tr>\n<tr>\n<td><code>BS_DrvNum</code></td>\n<td>64</td>\n<td>1</td>\n<td>磁盘 BIOS 使用的驱动器编号，适用于 IBM PC。此字段在 MS-DOS 启动加载程序中使用：<br /> <code>0x00</code> : 软盘驱动器<br /> <code>0x80</code> : 固定磁盘（硬盘）<br />实际上此值取决于操作系统。</td>\n</tr>\n<tr>\n<td><code>BS_Reserved</code></td>\n<td>65</td>\n<td>1</td>\n<td>保留字段，Windows NT 使用。创建卷时，此字段应设置为  <code>0</code> 。</td>\n</tr>\n<tr>\n<td><code>BS_BootSig</code></td>\n<td>66</td>\n<td>1</td>\n<td>扩展引导签名（值为  <code>0x29</code> ）。此签名字节表示接下来的三个字段（ <code>BS_VolID</code> 、 <code>BS_VolLab</code>  和  <code>BS_FilSysType</code> ）存在。</td>\n</tr>\n<tr>\n<td><code>BS_VolID</code></td>\n<td>67</td>\n<td>4</td>\n<td>卷序列号，与  <code>BS_VolLab</code>  配合使用，用于在可移动存储介质上跟踪卷。<br/>FAT 驱动程序通过此字段检测错误的媒体更换。通常在格式化时，根据当前时间和日期自动生成。</td>\n</tr>\n<tr>\n<td><code>BS_VolLab</code></td>\n<td>71</td>\n<td>11</td>\n<td>卷的 11 字节标签，需与根目录中记录的卷标签匹配。<br />当根目录中的卷标签发生更改时，FAT 驱动程序应更新此字段。 MS-DOS 会自动更新此字段，但 Windows 不会更新。 如果卷标签不存在，应设置为  <code>&quot;NO NAME &quot;</code> （共 11 字节，右侧填充空格）。</td>\n</tr>\n<tr>\n<td><code>BS_FilSysType</code></td>\n<td>82</td>\n<td>8</td>\n<td>文件系统类型字符串，通常为  <code>&quot;FAT12&quot;</code> ,  <code>&quot;FAT16&quot;</code> ， <code>&quot;FAT32&quot;</code>  或  <code>&quot;FAT &quot;</code> 。<br />许多人误认为此字符串影响 FAT 类型的确定，实际上这是一个误解。 从字段名称可知，它并不属于  <code>BPB</code> （BIOS 参数块）。 此字符串经常被设置不正确或未设置，因此 Microsoft 的 FAT 驱动程序不会使用此字段来确定 FAT 类型。 然而，一些旧的 FAT 驱动程序依赖此字段来确定 FAT 类型，因此，为避免兼容性问题，应该根据卷的 FAT 类型正确设置此字段。</td>\n</tr>\n<tr>\n<td><code>BS_BootCode32</code></td>\n<td>90</td>\n<td>420</td>\n<td>引导程序。它与平台有关，不使用时填充  <code>0</code> 。</td>\n</tr>\n<tr>\n<td><code>BS_Sign</code></td>\n<td>510</td>\n<td>2</td>\n<td>应为固定值 <code>0xAA55</code>  ，表示这是一个有效引导扇区的引导签名。</td>\n</tr>\n<tr>\n<td></td>\n<td>512</td>\n<td></td>\n<td>当扇区大小大于  <code>512</code>  字节时，扇区中的其余部分应为零。</td>\n</tr>\n</tbody>\n</table>\n<p>我们来看一个实例并解释一些重点自动</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/eadc7.png\" alt=\"Boot Loader Sector\" /></p>\n<ol>\n<li><code>0xEB 0x58 0x90</code> ：汇编指令跳转到 <code>0x58</code>  偏移处，这个偏移是相对于当前指令的，所以加上本身 <code>0xEB 0x58</code>  这两个字节指令，正好跳转到 <code>0x5A</code>  处找到引导程序的开头，也就是标号 10 的位置。</li>\n<li>扇区大小为 <code>0x200</code>  也就是 <code>512</code>  字节。14983*2+2802=</li>\n<li>一个簇内含有 <code>0x10</code>  个扇区，也就是一个簇中有 <code>16</code>  个扇区.</li>\n<li>保留区域中的扇区数为 <code>0xAF2=2802</code>  个，由于扇区是从 0 开始编号的，也就是说 <code>FAT1</code>  从第 2802 号扇区开始。</li>\n<li>有 <code>2</code>  个 FAT 表。</li>\n<li>FAT 卷前的隐藏物理扇区数为 <code>0x800=2048</code> ，也就是说在 FAT 卷前还有 <code>2048</code>  个物理扇区，即逻辑上的 0 号扇区其实对应着物理磁盘中的第 <code>2048</code>  号扇区。</li>\n<li>FAT 卷的总扇区数为 <code>0x1D4B7D0=30717904</code>  个，总扇区包括 <code>保留区</code> 、 <code>FAT1</code> 、 <code>FAT2</code>  和 <code>DATA</code>  四个分区的所有扇区，是 FAT 卷能管理的所有扇区的数量。</li>\n<li>FAT 表的大小为 <code>0x3A87=14983</code>  个扇区。 <code>FAT表大小 * FAT表个数 + 保留区大小 = DATA区开始地址</code> 。</li>\n<li>卷序列号为 <code>0x2AEB8680</code> ，用于在可移动存储介质上跟踪卷。</li>\n</ol>\n<h4 id=\"一些计算\"><a class=\"anchor\" href=\"#一些计算\">#</a> 一些计算</h4>\n<p>每一个区域的偏移和大小都是由 BPB 参数计算出来的：</p>\n<ul>\n<li>\n<p><strong>FAT 区</strong>在保留区的后面，其位置和大小（扇区数）的计算为：</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Fat1StartSector = BPB_ResvdSecCnt;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FatSectors = BPB_FATSz32 * BPB_NumFATs;</pre></td></tr></table></figure></li>\n<li>\n<p><strong>FAT2 区</strong>在 <code>FAT1</code>  区的后面，其位置和大小（扇区数）的计算为：</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Fat2StartSector = BPB_ResvdSecCnt + FatSectors;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Fat2Sectors = FatSectors = BPB_FATSz32 * BPB_NumFATs;</pre></td></tr></table></figure></li>\n<li>\n<p><strong>DATA 区</strong>在所有 FAT 区的后面，其位置和大小（扇区数）的计算为：</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>DataStartSectors = BPB_FATSz32 * BPB_NumFATs + BPB_ResvdSecCnt;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>DataSectors = BPB_TotSec32 - DataStartSectors;</pre></td></tr></table></figure></li>\n<li>\n<p>如果 <code>FAT卷</code> 不是从硬盘的第一个扇区开始的，那么 <code>FAT卷</code> 中的每个扇区对应的物理扇区为： <code>BPB_HiddSec + 逻辑扇区</code></p>\n</li>\n</ul>\n<h4 id=\"fsinfo信息扇区\"><a class=\"anchor\" href=\"#fsinfo信息扇区\">#</a> FSINFO 信息扇区</h4>\n<p><code>FAT32</code>  在保留区中增加了一个  <code>FSINFO</code>  扇区，用以记录文件系统中空闲簇的数量以及下一可用簇的簇号等信息，使得操作系统可以快速找到可用的簇而无需在每次使用时重新扫描整个 <code>FAT卷</code> 。 <code>FSINFO</code>  扇区的位置由 <code>BPB_FSInfo</code>  指定，通常是 <code>1</code> ，也就是 1 号扇区，紧邻着引导扇区，其结构如下：</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>偏移</th>\n<th>大小</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>FSI_LeadSig</code></td>\n<td>0</td>\n<td>4</td>\n<td>固定值 <code>0x41615252</code> ，引导签名，用于验证该扇区确实是一个 FSInfo 扇区。</td>\n</tr>\n<tr>\n<td><code>FSI_Reserved1</code></td>\n<td>4</td>\n<td>480</td>\n<td>保留字段。此字段应始终初始化为零。</td>\n</tr>\n<tr>\n<td><code>FSI_StrucSig</code></td>\n<td>484</td>\n<td>4</td>\n<td>固定值 <code>0x61417272</code> ，另一个签名，更加局部地标识了与该扇区中使用的字段相关的位置。</td>\n</tr>\n<tr>\n<td><code>FSI_Free_Count</code></td>\n<td>488</td>\n<td>4</td>\n<td>表示卷上最后一次更新后已知的空闲簇数。如果该值为  <code>0xFFFFFFFF</code> ，则表示空闲簇数未知。<br/>这不一定是正确的，因此  <code>FAT</code>  驱动程序需要确保该值对卷是有效的。</td>\n</tr>\n<tr>\n<td><code>FSI_Nxt_Free</code></td>\n<td>492</td>\n<td>4</td>\n<td>此字段为 FAT 驱动程序提供一个提示，指示驱动程序应从哪个簇开始查找空闲簇。 由于  <code>FAT32</code>  的  <code>FAT</code>  很大，如果开始查找时有很多已分配的簇，则从 FAT 卷的第一个簇开始查找空闲簇可能会非常耗时。 通常，此值设置为驱动程序上次分配的最后一个簇号。如果值为  <code>0xFFFFFFFF</code> ，则表示没有提示，驱动程序应从簇 2 开始查找。 此值可能不准确，因此 FAT 驱动程序需要确保它对卷是有效的。</td>\n</tr>\n<tr>\n<td><code>FSI_Reserved2</code></td>\n<td>496</td>\n<td>12</td>\n<td>保留字段。此字段应始终初始化为零。</td>\n</tr>\n<tr>\n<td><code>FSI_TrailSig</code></td>\n<td>508</td>\n<td>4</td>\n<td>固定值 <code>0xAA550000</code> ，结尾签名，用于验证该扇区确实是一个  <code>FSInfo</code>  扇区。</td>\n</tr>\n<tr>\n<td></td>\n<td>512</td>\n<td></td>\n<td>如果扇区大小大于 512 字节，则其余字节应初始化为零。</td>\n</tr>\n</tbody>\n</table>\n<p>一个详细的示例如下：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/29170.png\" alt=\"FSINFO Sector\" /></p>\n<ol>\n<li>FAT 卷最后一次更新后已知的空闲簇数为 <code>0x1817A8=1578920</code>  个。也即还有 82% 的空余。</li>\n<li>最靠前的一个空闲簇号为 <code>0x2BDB=11227</code>  号。</li>\n</ol>\n<h4 id=\"2号扇区\"><a class=\"anchor\" href=\"#2号扇区\">#</a> 2 号扇区</h4>\n<p>有关 2 号扇区的内容网络上的描述比较少，似乎 FAT 文件系统标准中并没有对 2 号扇区做太多规范，唯一的规范是，由于其仍属于引导扇区的一部分，所以该扇区结尾 4 个字节仍必须是引导扇区签名 <code>0xAA550000</code> 。然而在现在文件系统中，该扇区一般会存放一些 0 号扇区中放不下的引导加载程序的一些额外代码，该部分的代码会在 0 号扇区中通过 <code>jmp 400h</code>  的汇编指令直接跳转到达，该部分的代码也可以在 Intel 80386 实模式下的 16 位模式进行反汇编。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/d6152.png\" alt=\"second sector\" /></p>\n<h3 id=\"备份引导扇区\"><a class=\"anchor\" href=\"#备份引导扇区\">#</a> 备份引导扇区</h3>\n<p><code>FAT32</code>  中会将引导扇区的 3 个扇区都做一份备份用于冗余，当主引导扇区损坏时可以通过备份引导扇区恢复文件系统，备份引导扇区的位置由 0 号扇区中的 <code>BPB_BkBootSec</code>  字段指定，一般是 <code>6</code> ，也就是从 <code>6</code>  号扇区开始。 <code>6</code> 、 <code>8</code>  号扇区的内容是 <code>0</code> 、 <code>2</code>  号扇区的原样拷贝，然而第 <code>7</code>  号扇区，也就是 <code>FSINFO</code>  的备份扇区的内容与原扇区内容不太一样，是该扇区的未初始化版本，也就是说当操作系统使用备份扇区时需要重新搜索空间簇数量和位置，这也是非常合理的，当发生硬盘损坏时原本的空闲簇信息可能也不在可靠了，需要重新搜索。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/1406b.png\" alt=\"FSINFO Backup Sector\" /></p>\n<h3 id=\"保留扇区\"><a class=\"anchor\" href=\"#保留扇区\">#</a> 保留扇区</h3>\n<p>保留区的剩下扇区都时保留扇区，供使用者灵活使用。</p>\n<h2 id=\"fat32-fat-区\"><a class=\"anchor\" href=\"#fat32-fat-区\">#</a> FAT32 FAT 区</h2>\n<p>FAT 区位于保留区后，一般是两个完全相同的 FAT（File Allocation Table，文件分配表）表组成， FAT 文件系统的名字也是因此而来。</p>\n<p>FAT 文件系统之所以有 12，16，32 不同的版本之分，其根本在于 FAT 表项用来记录一簇空间所占用的二进制位数。以 <code>FAT16</code>  为例，每一簇在 FAT 表中占据 <code>16 bit</code> （2 字节）。所以，FAT16 最大可以表示的簇号为 <code>0xFFFF</code> （ <code>65535</code> ），如果以 <code>32K</code> （最多只支持 64 个扇区）为簇的大小的话， <code>FAT16</code>  可以管理的最大磁盘空间为： <code>32KB×65535=2048MB</code> ，这就是为什么 <code>FAT16</code>  不支持超过 <code>2GB</code>  分区的原因（DOS 下）。注意：</p>\n<ul>\n<li>对于文件系统来说，FAT 表有两个重要作用：描述簇的分配状态以及标明文件或目录的下一簇的簇号。</li>\n<li>通常情况下，一个 FAT 文件系统会有两个 FAT 表，但有时也允许只有一个 FAT 表，FAT 表的具体个数记录在引导扇区的 <code>BPB_NumFATs</code>  字段处。</li>\n<li><code>FAT32</code>  的 FAT 表由一系列大小相等的 FAT 表项组成，每个表项占 <code>32bit</code> （4 字节）。表项从 FAT 区的起始位置开始进行编号，FAT 区第一个扇区的头 4 个字节为 0 号地址，依次类推。0 号地址与 1 号地址被系统保留并存储特殊标志内容，从 2 号表项开始，每个地址对应一个数据区的簇号，FAT 表中的地址编号与数据区中的簇号相同。</li>\n</ul>\n<p>FAT 表的每个条目记录如下 5 种信息中的一种：</p>\n<ol>\n<li>文件下一个簇的地址</li>\n<li>一个特殊的<strong>簇链结束符</strong>（<strong>EOC</strong>，End Of Cluster-chain，或称 End Of Chain）符号指示文件的结束</li>\n<li>一个特殊的符号标示坏簇</li>\n<li>一个特殊的符号标示保留簇</li>\n<li>0 来表示空闲簇</li>\n</ol>\n<p>其条目值得具体规范如下：</p>\n<table>\n<thead>\n<tr>\n<th>FAT 32 表项值</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>0x?0000000</code></td>\n<td>空闲簇</td>\n</tr>\n<tr>\n<td><code>0x?0000001</code></td>\n<td>保留簇</td>\n</tr>\n<tr>\n<td><code>0x?0000002 - 0x?FFFFFEF</code></td>\n<td>被占用的簇；指向下一个簇</td>\n</tr>\n<tr>\n<td><code>0x?FFFFFF0 - 0x?FFFFFF6</code></td>\n<td>保留值</td>\n</tr>\n<tr>\n<td><code>0x?FFFFFF7</code></td>\n<td>簇中含有坏扇区，会将整个簇标记为坏簇</td>\n</tr>\n<tr>\n<td><code>0x?FFFFFF8 - 0x?FFFFFFF</code></td>\n<td>文件最后一个簇</td>\n</tr>\n</tbody>\n</table>\n<p>⚠️ 注意 <code>FAT32</code>  只使用 32 位中的 <code>28位</code> 。高 4 位通常是 <code>0</code> ，但它们是保留位，不要更改它们。在上面的表中它们用<strong>问号</strong>表示。</p>\n<p>一个具体的例子如下：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/491ba.png\" alt=\"FAT\" /></p>\n<ol>\n<li>0 号表项（标号 1）的值总是 <code>0x0FFFFFF8</code> 。</li>\n<li>1 号表项（标号 2）可能被用于记录脏标志，以说明文件系统没有被正常卸载或者磁盘表面存在错误。不过这个值并不重要。正常情况下 1 号表项的值为 <code>0xFFFFFFFF</code>  或 <code>0xFFFFFFF</code> 。</li>\n<li>如果某个簇<strong>未被分配使用</strong>，它所对应的表项值即用  <code>0</code>  进行填充，表示该 FAT 表 项所对应的簇未被分配。当某个簇<strong>已被分配使用</strong>时，则它对应的表项值是该文件的下一个存储位置的簇号。如果该文件结束于该簇，则在它的 FAT 表项中记录的是一个文件结束标记，对于 FAT32 而言，代表文件结束的 FAT 表项值为  <code>0x0FFFFFFF</code> 。这里的标志说明 2 号簇内的文件比较小，单独一个 2 号簇的空间就已经可以存储整个文件了。</li>\n<li>7 号簇的表项值说明该簇内存储的文件非常大，一个簇存储不下，存储不下的内容需要去 <code>0x8</code>  号簇去寻找，依次类推，直到找到一个簇的表项值为文件结束标志。</li>\n</ol>\n<p>当文件系统被创建，也就是进行格式化操作时，分配给 FAT 区域的空间将会被清空，然后在  <code>FAT1</code>  与  <code>FAT2</code>  的 0 号表项与 1 号表项写入上述特定值。由于创建文件系统的同时也会创建根目录，也就是为根目录分配了一个簇空间，通常为 2 号簇，所以 2 号簇所对应的 2 号 FAT 表项也会被写入一个结束标记。如果某个簇存在<strong>坏扇区</strong>，则整个簇会用 FAT 表项值  <code>0xFFFFFFF7</code>  标记为坏簇，不再使用，这个坏簇 标记就记录在它所对应的 FAT 表项中。</p>\n<div class=\"note primary no-icon\">\n<p><strong>新建文件 / 目录过程</strong></p>\n<ul>\n<li>在文件系统中<strong>新建文件</strong>时，如果新建的文件只占用一个簇，为其分配的簇对应的 FAT 表项将会写入结束标记。如果新建的文件不只占用一个簇，则在其所占用的每个簇对应的 FAT 表项中写入为其分配的下一簇的簇号，在最后一个簇对应的 FAT 表象中写入结束标记。</li>\n<li><strong>新建目录</strong>时，只为其分配一个簇的空间，对应的 FAT 表项中写入结束标记。当目录增大超出一个簇的大小时，将会在空闲空间中继续为其分配一个簇，并在 FAT 表中为其建立 FAT 表链以描述它所占用的簇情况。</li>\n</ul>\n<p>更加详细的过程可以看<a href=\"https://gality.cn/os/fs/FAT32/#fat32-%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B\"> FAT32 工作过程</a></p>\n</div>\n<h2 id=\"fat32-data区\"><a class=\"anchor\" href=\"#fat32-data区\">#</a> FAT32 DATA 区</h2>\n<p>数据区时真正用于存放用户数据的区域。数据区紧跟在 FAT2 之后，被划分成一个个的簇。所有的簇 从 2 开始进行编号。也就是说，2 号簇的起始位置就是数据区的起始位置。</p>\n<h3 id=\"目录表\"><a class=\"anchor\" href=\"#目录表\">#</a> 目录表</h3>\n<p><strong>目录表</strong>是一个表示目录的特殊类型文件（现今通常称为文件夹）。它里面保存的每个文件或目录使用表中的 <code>32字节</code> 条目表示。每个条目记录名字、扩展名、属性（档案、目录、隐藏、只读、系统和卷）、创建的日期和时间、文件／目录数据第一个簇的地址，最后是文件／目录的大小。在 <code>FAT32</code>  中所有目录表都存在数据区域（DATA 区）中。目录表项遵循以下格式：</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>偏移</th>\n<th>大小</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>DIR_Name</code></td>\n<td>0</td>\n<td>11</td>\n<td>短文件名（包括文件名和扩展名， <code>8-11</code>  位为文件扩展名，使用空格补齐）<br />第一个字节可以是下面的特殊数值：<br />- 0x00：这个条目未使用并且后面没有被占用条目（后面所有条目该项也为 0）<br />- 0x05：最初字符确实是 0xE5 时使用该值替代<br />- 0x2E：' 点 ' 条目；'.' 或者 '..'<br />- 0xE5：这个条目曾经被删除不再有用。取消删除文件工具作为取消删除的一步必须使用一个正常的字符取代它。</td>\n</tr>\n<tr>\n<td><code>DIR_Attr</code></td>\n<td>11（0B）</td>\n<td>1</td>\n<td>文件属性标志位（高 <code>2</code>  位是保留位且必须置为 0）<br />-  <code>0x01</code> ：只读<br />-  <code>0x02</code> ：隐藏<br />-  <code>0x04</code> ：系统<br />-  <code>0x08</code> ：卷标<br />-  <code>0x10</code> ：子目录<br />-  <code>0x20</code> ：档案（只要完成了写操作并已关闭，则该位置位 1）<br />-  <code>0x0F</code> : 长文件条目（Long File Name Entry，LFN Entry）</td>\n</tr>\n<tr>\n<td><code>DIR_NTRes</code></td>\n<td>12（0C）</td>\n<td>1</td>\n<td>NT 保留标志，指示短文件名 (SFN) 的大小写信息：<br />-  <code>0x08</code> : 名称主体中的所有字母均为小写。<br />-  <code>0x10</code> : 扩展名中的所有字母均为小写。</td>\n</tr>\n<tr>\n<td><code>DIR_CrtTimeTenth</code></td>\n<td>13（0D）</td>\n<td>1</td>\n<td>与  <code>DIR_CrtTime</code>  对应的子秒信息（可选）。 <code>DIR_CrtTime</code>  的时间分辨率为 2 秒，因此此字段以 10 毫秒为单位表示子秒计数，其有效值范围为 0 到 199。如果不支持，则将其设置为 0，并且之后不要更改。</td>\n</tr>\n<tr>\n<td><code>DIR_CrtTime</code></td>\n<td>14</td>\n<td>2</td>\n<td>文件创建时间（可选）。如果不支持，则将其设置为 0，并且之后不要更改。小时、分钟和秒根据后面的图示描述进行编码：<br />-  <code>15-11位</code> ：小时（0-23）<br />-  <code>10-5位</code> ：分钟（0-59）<br />-  <code>4-0位</code> ：秒 / 2 （0-29）</td>\n</tr>\n<tr>\n<td><code>DIR_CrtDate</code></td>\n<td>16</td>\n<td>2</td>\n<td>文件创建日期（可选）。如果不支持，则将其设置为 0，并且之后不要更改。年、月和日根据后面的图示编码：<br />-  <code>15-9位</code> ：年（0 = 1980, 127 = 2107）<br />-  <code>8-5位</code> ： 月（1 =1 月， 12 = 12 月）<br />-  <code>4-0位</code> ：日（1 - 31）</td>\n</tr>\n<tr>\n<td><code>DIR_LstAccDate</code></td>\n<td>18</td>\n<td>2</td>\n<td>文件最近访问日期（可选）。分辨率为 1 天。 如果不支持，则将其设置为 0，并且之后不要更改。</td>\n</tr>\n<tr>\n<td><code>DIR_FstClusHI</code></td>\n<td>20</td>\n<td>2</td>\n<td>簇号的高 16 位。在 FAT12/16 卷上始终为零。</td>\n</tr>\n<tr>\n<td><code>DIR_WrtTime</code></td>\n<td>22</td>\n<td>2</td>\n<td>文件的最后写入时间（通常在文件关闭时更新），编码格式与 <code>DIR_CrtTime</code>  相同。</td>\n</tr>\n<tr>\n<td><code>DIR_WrtDate</code></td>\n<td>24</td>\n<td>2</td>\n<td>文件的最后写入日期（通常在文件关闭时更新），编码格式与 <code>DIR_CrtDate</code>  相同。</td>\n</tr>\n<tr>\n<td><code>DIR_FstClusLO</code></td>\n<td>26</td>\n<td>2</td>\n<td>簇号的低 16 位。当文件大小为 0 时，不分配簇，此项必须为 0。 如果是目录，则此值始终为有效值。</td>\n</tr>\n<tr>\n<td><code>DIR_FileSize</code></td>\n<td>28</td>\n<td>4</td>\n<td>文件的大小，以字节为单位。如果是目录，此字段未使用，并且其值必须始终为 0。</td>\n</tr>\n</tbody>\n</table>\n<p>当 <code>DIR_Attr</code>  为 <code>0x0F</code>  时，该目录表的字段含义为：</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>偏移</th>\n<th>大小</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>LDIR_Ord</code></td>\n<td>0</td>\n<td>1</td>\n<td>序号 (1-20)，用于标识此条目在组成 LFN 的所有条目中的位置。 <code>0x01</code>  表示 LFN 的起始部分。任何带有 <strong>LAST_LONG_ENTRY</strong> 标志 ( <code>0x40</code> ) 的值表示 LFN 的最后一部分。</td>\n</tr>\n<tr>\n<td><code>LDIR_Name1</code></td>\n<td>1</td>\n<td>10</td>\n<td>文件名的第 1-5 个字符（UTF-16），未使用的部分先填充两个字节的 <code>0x00</code> ，然后用 <code>0xFF</code>  填充。</td>\n</tr>\n<tr>\n<td><code>LDIR_Attr</code></td>\n<td>11</td>\n<td>1</td>\n<td>LFN 目录属性标志 <code>0x0F</code></td>\n</tr>\n<tr>\n<td><code>LDIR_Type</code></td>\n<td>12</td>\n<td>1</td>\n<td>保留未使用</td>\n</tr>\n<tr>\n<td><code>LDIR_Chksum</code></td>\n<td>13</td>\n<td>1</td>\n<td>文件名校验和</td>\n</tr>\n<tr>\n<td><code>LDIR_Name2</code></td>\n<td>14</td>\n<td>12</td>\n<td>文件名的第 6-11 个字符（UTF-16），未使用的部分先填充两个字节的 <code>0x00</code> ，然后用 <code>0xFF</code>  填充。</td>\n</tr>\n<tr>\n<td><code>LDIR_FstClusLO</code></td>\n<td>26</td>\n<td>2</td>\n<td>保留</td>\n</tr>\n<tr>\n<td><code>LDIR_Name3</code></td>\n<td>28</td>\n<td>4</td>\n<td>文件名的第 12-13 个字符（UTF-16），未使用的部分先填充两个字节的 <code>0x00</code> ，然后用 <code>0xFF</code>  填充。</td>\n</tr>\n</tbody>\n</table>\n<p>一个实例如下：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/50a89.png\" alt=\"\" /></p>\n<ol>\n<li>\n<p>通过绿色的 <code>0x08</code>  标志确定第一个目录项类型为卷标，即该 FAT 卷标名为 <code>UBUNTU-SERV</code> ，实际情况也确实如此，该 U 盘为 Ubuntu-24.04 的系统盘。一般来说卷标名存储在 DATA 数据区的开头，我们也可以计算一下进行验证，DATA 区的地址应该为 <code>0x200 * (FAT区扇区数 * 2 + 保留区扇区数) = 0x1000000</code> ，与实际相符。同时我们也可以计算出该卷最后一次修改的时间与日期：</p>\n<p>时间： <code>0x9E55 = (10011)(110 010)(10101)</code>  即 <code>(19):(50):(21*2)</code> ，也就是 19:50:42。</p>\n<p>年份： <code>0x596B = (0101100)(1 011)(01011) </code> 即 <code>(44)(11)(11)</code> ，也就是 2024 年 11 月 11 日。</p>\n<p>注意：卷标目录项结构与普通短文件名目录项结构完全相同，但没有创建时间和访问时间，只有一个<strong>最后修改时间</strong>。另外，卷标目录项也没有簇号和大小值，这些字节位置全部这只为  <code>0</code> 。</p>\n</li>\n<li>\n<p>绿色标志位确定这两项都是 <code>LFN</code>  项，LFN 有一些特殊的规则：</p>\n<ul>\n<li>\n<p>如果一个文件的文件名超过了 8 个字符，则会将其名字截短后为其建立短文件名（Short File Name， SFN）。将短文件名存储在短文件名目录项中。长文件名则存放在长文件名目录项中。</p>\n</li>\n<li>\n<p>LFN 项中的文件名使用 UTF-16 编码，存储 13 个 Unicode 字符的文件名，每个字符占用两个字节，如果文件名长于 13 个字符，则继续为其分配 LFN 项，知道够用为止。</p>\n</li>\n<li>\n<p>一个文件的所有 LFN 项按倒序排列在它的 SFN 项前面，即文件名的第一部分距离 SFN 是最近的。</p>\n</li>\n<li>\n<p>LFN 项第一个字节为序号位，距离 SFN 最近的一个 LFN 项序号为 1， 如果后续还有 LFN 项，则依次向后递增为 2， 3，... 最后一个 LFN 块的序号需要异或上 <code>0x40</code> ，在上图中，由于第二个 LFN 项就是最后一个 LFN 项，所以其序号为  <code>0x42 = 0x40 | 0x02</code> 。</p>\n</li>\n<li>\n<p>每个 LFN 条目在  <code>LDIR_Chksum</code>  中都有一个校验和，同一个文件的所有 LFN 项的校验和都相同，此外，校验和还被用于确保 LFN 和 SFN 之间的相关性。校验和的生成算法如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">uint8_t</span> <span class=\"token function\">create_sum</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> DIR<span class=\"token operator\">*</span> entry<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">uint8_t</span> sum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">11</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">/* Calculate sum of DIR_Name[] field */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        sum <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sum <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>sum <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> entry<span class=\"token operator\">-></span>DIR_Name<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">return</span> sum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><details class=\"primary\"><summary>我们可以写一个简单的小程序来验证一下</summary><div>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdint.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token class-name\">uint8_t</span> sum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token class-name\">uint8_t</span> DIR_name<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">0x53</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x59</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x53</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x54</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x4D</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x7e</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x20</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">11</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        sum <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sum <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>sum <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> DIR_name<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sum = %#X\\n\"</span><span class=\"token punctuation\">,</span> sum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// Output: sum = 0X72</span></pre></td></tr></table></figure><p>与棕色标出的校验和一致。</p>\n</div></details>\n</li>\n<li>\n<p>当文件名没有占满一个 LFN 项时，需要先填充两个字节的 <code>0x00</code> ，也就是 <code>0x3E-0x3F</code>  位置的填充的内容，如果仍有空余空间，则应该在所有字符位填充 <code>0xFF</code> 。</p>\n</li>\n</ul>\n</li>\n<li>\n<p>对于短文件名（SFN）目录项来说，如果文件名不足 8 个字符，用 0x20 进行填充。当文件名超过 8 个字符时则会被截短，因为短文件名目录项中没有足够的空间记录超出的部分。截短的方法是取文件名的前 6 个字符加上 <code>~1 (0x7E 0x31)</code> （如果有同名文件，则会依次递增该数值），然后加上其扩展名。这里绿色标志位确定改项为一个子目录项，且具有两个属性：隐藏和系统。当目录项类型为子目录时，则将扩展名部分用 “0x20” 进行填充。</p>\n<p>可以看到该子目录所在簇号为 3 号，由于在该文件系统中一个簇包含 16 个扇区，所以在 <code>0x10020000</code>  偏移处就是 3 号簇，其中记录着 <code>System Volume Information</code>  目录内的内容。</p>\n</li>\n</ol>\n<p><strong>注意</strong>：从 windows95 开始，不管文件名的长度是否超过 8 个字符，都会<ins class=\"wavy\">同时为其创建 SFN 目录项和 LFN 目录项</ins> ，因为短文件名不区分大小写，而长文件名则是区分大小写的。这一点也可以在下列的 <code>[boot]</code>  子目录项的格式中得到验证。（之所以在 SFN 中 <code>[boot]</code>  被替换为 <code>_BOOT_</code> 是因为 <code>[]</code>  并不是合法的 DOS 文件名字符，所以发生了替换，合法的 DOS 字符包括：</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>0～9 A～Z ! # $ % &amp; ' ( ) - @ ^ _  \\` &#123; &#125; ~</pre></td></tr></table></figure><h1 id=\"fat32-工作过程\"><a class=\"anchor\" href=\"#fat32-工作过程\">#</a> FAT32 工作过程</h1>\n<h2 id=\"建立文件\"><a class=\"anchor\" href=\"#建立文件\">#</a> 建立文件</h2>\n<p>假设在跟目录下由一个子目录，名字为 <code>test</code> ，我们要在其下建立一个文件 <code>example.txt</code> 。使用 <code>FAT32</code>  文件系统，一个簇的大小为 <code>4096</code>  字节（一个簇 <code>8</code>  个扇区，每个扇区 <code>512</code>  字节），我们要建立的文件大小为 <code>5000</code>  字节。步骤如下：</p>\n<ol>\n<li>读取位于卷 0 号扇区的引导扇区，根据引导扇区中的信息定位 FAT 表、数据区和根目录的位置。</li>\n<li>查看根目录下的每个目录项，寻找名字为 <code>test</code>  且具有目录属性的目录项。找到后，查看它的起始簇号为 3。</li>\n<li>读取 3 号簇的内容，查找每个目录项，直到找到一个未分配的目录项（第一个字节为 <code>0x00</code> ）。</li>\n<li>找到可用项后写入文件名 “example.txt”，并将文件大小和当前时间写入相应的位置。</li>\n<li>为文件内容分配簇空间。转到 FAT 表，寻找空闲的位置。发现 4 号 FAT 表项未使用，这就说明 4 号簇是空闲的。将 4 号簇分配给文件，并在 4 号簇的 FAT 表项内写入结束标记。</li>\n<li>将簇号 4 写入 <code>example.txt</code>  文件目录项的起始簇号区域。将文件的前 4096 字节写入到 4 号簇中，还剩下  <code>904</code>  字节，所以还需要再为其分配一个簇。</li>\n<li>在 FAT 表中继续寻找未分配簇，找到 5 号簇为空闲未使用（ FAT 表项为 0）。</li>\n<li>将 <code>example.txt</code>  的第一个簇（即 4 号簇）的 FAT 表项值改写为 5，将文件的最后  <code>904</code>  字节写入 5 号簇。</li>\n<li>在 5 号簇的 FAT 表项内写入结束标记。</li>\n</ol>\n<h2 id=\"删除文件\"><a class=\"anchor\" href=\"#删除文件\">#</a> 删除文件</h2>\n<p>将我们之前创建的 <code>/test/example.txt</code>  文件删除。步骤如下：</p>\n<ol>\n<li>从卷 0 号扇区读取引导扇区，根据引导扇区中的信息定位 FAT 表、数据区和根目录的位置。</li>\n<li>在根目录下寻找名字为 <code>test</code>  且具有目录属性的目录项。</li>\n<li>：由 <code>test</code>  的目录项中获取它的起始簇号为 3，到 3 号簇查看 <code>test</code>  文件夹内的内容，从中找到文件 <code>example.txt</code>  的目录项，提取出它的起始簇号，为 4 号簇。</li>\n<li>到 FAT 表中找到该文件的簇链，确定他的存储位置为 4 号簇和 5 号簇。</li>\n<li>将 4 号簇和 5 号簇的 FAT 项设置为 0，表示这两个簇未被占用，可以被重新分配。</li>\n<li>将文件 <code>example.txt</code>  的目录项的第一个字节改为  <code>0xE5</code> 。</li>\n</ol>\n<h2 id=\"索引文件\"><a class=\"anchor\" href=\"#索引文件\">#</a> 索引文件</h2>\n<p>索引文件的过程其实就是删除文件的前 4 步，比较简单，就不赘述了。</p>\n",
            "tags": [
                "操作系统",
                "文件系统",
                "操作系统",
                "文件系统",
                "FAT32",
                "FAT"
            ]
        },
        {
            "id": "https://gality.cn/misc/trail-and-error/CLion-CMake/",
            "url": "https://gality.cn/misc/trail-and-error/CLion-CMake/",
            "title": "CLion构建远程CMake开发环境",
            "date_published": "2024-06-13T01:59:17.000Z",
            "content_html": "<div class=\"note info no-icon\">\n<p><strong>示例环境：</strong></p>\n<ul>\n<li>云主机（CLion client）：Ubuntu 20.04 LTS + CLion-241.14494.229 (CLion 2024.1 RC)</li>\n<li>本机（CLion host）： macOS Sonoma 14.5 + CLion Build #CL-241.17890.19 (CLion 2024.1.3)</li>\n</ul>\n</div>\n<div class=\"note primary no-icon\">\n<p><strong>Troubleshooting﻿：</strong></p>\n<ol>\n<li><a href=\"#1-%E8%BF%9C%E7%A8%8B%E7%8E%AF%E5%A2%83%E4%B8%8B%E8%BD%BDclion-client%E5%8D%A1%E4%BD%8F%E4%B8%8B%E8%BD%BD%E7%BC%93%E6%85%A2\">远程环境下载 CLion Client 卡住 / 下载缓慢</a></li>\n<li><a href=\"#%E9%85%8D%E7%BD%AEcmake\">远程环境无法识别 CMake 项目（在 CMakeLists.txt 上右键没有 Reload CMake Project 选项 ）</a></li>\n<li><a href=\"#3-cmake%E7%89%88%E6%9C%AC%E4%B8%8D%E5%8C%B9%E9%85%8D\">CMake 版本不匹配，需手动升级</a></li>\n<li><a href=\"#4-%E6%89%BE%E4%B8%8D%E5%88%B0llvm-12\">找不到 llvm-12</a></li>\n<li><a href=\"#5-%E8%B0%83%E8%AF%95%E6%97%B6%E6%97%A0%E6%95%88%E6%96%AD%E7%82%B9%E9%97%AE%E9%A2%98\">调试时无效断点问题</a></li>\n</ol>\n</div>\n<h1 id=\"远程环境构建\"><a class=\"anchor\" href=\"#远程环境构建\">#</a> 远程环境构建</h1>\n<p>本节将从一台没有任何开发环境的纯净 Ubuntu 开始配置开发远程开发 C/C++ 的开发环境，读者可以根据自己的实际情况自由选择从何处开始。</p>\n<h2 id=\"配置cc环境\"><a class=\"anchor\" href=\"#配置cc环境\">#</a> 配置 C/C++ 环境</h2>\n<p>首先更新系统，保证后续安装的软件都是最新的：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> upgrade</pre></td></tr></table></figure><p>然后就是安装开发 C/C++ 的必要工具：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> build-essential gdb cmake</pre></td></tr></table></figure><p>可以通过以下命令查看各个工具的版本：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>❯ gcc <span class=\"token parameter variable\">--version</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>gcc <span class=\"token punctuation\">(</span>Ubuntu <span class=\"token number\">9.4</span>.0-1ubuntu1~20.04.2<span class=\"token punctuation\">)</span> <span class=\"token number\">9.4</span>.0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Copyright <span class=\"token punctuation\">(</span>C<span class=\"token punctuation\">)</span> <span class=\"token number\">2019</span> Free Software Foundation, Inc.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>This is <span class=\"token function\">free</span> software<span class=\"token punctuation\">;</span> see the <span class=\"token builtin class-name\">source</span> <span class=\"token keyword\">for</span> copying conditions.  There is NO</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>warranty<span class=\"token punctuation\">;</span> not even <span class=\"token keyword\">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>❯ g++ <span class=\"token parameter variable\">--version</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>g++ <span class=\"token punctuation\">(</span>Ubuntu <span class=\"token number\">9.4</span>.0-1ubuntu1~20.04.2<span class=\"token punctuation\">)</span> <span class=\"token number\">9.4</span>.0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Copyright <span class=\"token punctuation\">(</span>C<span class=\"token punctuation\">)</span> <span class=\"token number\">2019</span> Free Software Foundation, Inc.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>This is <span class=\"token function\">free</span> software<span class=\"token punctuation\">;</span> see the <span class=\"token builtin class-name\">source</span> <span class=\"token keyword\">for</span> copying conditions.  There is NO</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>warranty<span class=\"token punctuation\">;</span> not even <span class=\"token keyword\">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>❯ <span class=\"token function\">make</span> <span class=\"token parameter variable\">--version</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>GNU Make <span class=\"token number\">4.2</span>.1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Built <span class=\"token keyword\">for</span> x86_64-pc-linux-gnu</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Copyright <span class=\"token punctuation\">(</span>C<span class=\"token punctuation\">)</span> <span class=\"token number\">1988</span>-2016 Free Software Foundation, Inc.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>License GPLv3+: GNU GPL version <span class=\"token number\">3</span> or later <span class=\"token operator\">&lt;</span>http://gnu.org/licenses/gpl.html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>This is <span class=\"token function\">free</span> software: you are <span class=\"token function\">free</span> to change and redistribute it.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>There is NO WARRANTY, to the extent permitted by law.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>❯ gdb <span class=\"token parameter variable\">--version</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>GNU gdb <span class=\"token punctuation\">(</span>Ubuntu <span class=\"token number\">9.2</span>-0ubuntu1~20.04.1<span class=\"token punctuation\">)</span> <span class=\"token number\">9.2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Copyright <span class=\"token punctuation\">(</span>C<span class=\"token punctuation\">)</span> <span class=\"token number\">2020</span> Free Software Foundation, Inc.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>License GPLv3+: GNU GPL version <span class=\"token number\">3</span> or later <span class=\"token operator\">&lt;</span>http://gnu.org/licenses/gpl.html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>This is <span class=\"token function\">free</span> software: you are <span class=\"token function\">free</span> to change and redistribute it.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>There is NO WARRANTY, to the extent permitted by law.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>❯ cmake <span class=\"token parameter variable\">--version</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>cmake version <span class=\"token number\">3.16</span>.3</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>CMake suite maintained and supported by Kitware <span class=\"token punctuation\">(</span>kitware.com/cmake<span class=\"token punctuation\">)</span>.</pre></td></tr></table></figure><p>如果想使用 <code>LLVM+Clang</code>  作为构建工具也可以（以 llvm-12 为例）：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> llvm-12 clang-12 lldb-12</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 默认使用 12 版本的 llvm</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sudo</span> update-alternatives <span class=\"token parameter variable\">--install</span> /usr/bin/llvm llvm /usr/bin/llvm-12 <span class=\"token number\">100</span> <span class=\"token comment\"># 这行可能会失败</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sudo</span> update-alternatives <span class=\"token parameter variable\">--install</span> /usr/bin/clang clang /usr/bin/clang-12 <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">sudo</span> update-alternatives <span class=\"token parameter variable\">--install</span> /usr/bin/clang++ clang++ /usr/bin/clang++-12 <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sudo</span> update-alternatives <span class=\"token parameter variable\">--install</span> /usr/bin/lldb lldb /usr/bin/lldb-12 <span class=\"token number\">100</span></pre></td></tr></table></figure><div class=\"note warning no-icon\">\n<p>如果 <code>sudo update-alternatives --install /usr/bin/llvm llvm /usr/bin/llvm-12 100</code>  失败，参考<a href=\"#4-%E6%89%BE%E4%B8%8D%E5%88%B0llvm-12\"> Troubleshooting-4</a>。</p>\n</div>\n<h2 id=\"配置clion-remote-client\"><a class=\"anchor\" href=\"#配置clion-remote-client\">#</a> 配置 CLion Remote Client</h2>\n<p>按如下步骤操作，如果在远程主机上的下载过程没有问题，那么在下载完成后 CLion 将自动打开在第四步中指定的目录，如果没有打开，也可以通过第一步的页面打开。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/bnln13.png\" alt=\"配置CLion远程环境\" /></p>\n<p>Jetbrains 的 EAP（抢先体验计划，Early Access Program）版本是一个可以免费使用且功能无阉割的抢先试用版本，可能会有些不稳定且需要每 30 天重装一次，有条件的话可以在第四步中选择 RC（Remote Client）版本安装。</p>\n<div class=\"note warning no-icon\">\n<p>如果在第四步后，远程主机的下载过程非常缓慢或下载失败，参考<a href=\"#1-%E8%BF%9C%E7%A8%8B%E7%8E%AF%E5%A2%83%E4%B8%8B%E8%BD%BDclion-client%E5%8D%A1%E4%BD%8F%E4%B8%8B%E8%BD%BD%E7%BC%93%E6%85%A2\"> Troubleshooting-1</a>。</p>\n</div>\n<h2 id=\"配置cmake\"><a class=\"anchor\" href=\"#配置cmake\">#</a> 配置 CMake</h2>\n<p>Settings -&gt; Build, Execution, Deployment -&gt; Toolchains</p>\n<p>先删掉默认配置，然后新增一个 <code>Remote Host</code>  的配置:</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/25wbsr.png\" alt=\"CMake配置\" /></p>\n<p>如果按照前面的步骤装好了 CMake 等工具，此处应该可以直接识别出各种工具的版本，如上图所示。然后配置 CMake 环境即可：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/g0y2no.png\" alt=\"cmake配置\" /></p>\n<p>重新打开远程环境，此时 CLion 就可以正确识别 CMake 项目并正常编译 &amp; 调试了</p>\n<h1 id=\"troubleshooting\"><a class=\"anchor\" href=\"#troubleshooting\">#</a> Troubleshooting</h1>\n<h2 id=\"1-远程环境下载clion-client卡住下载缓慢\"><a class=\"anchor\" href=\"#1-远程环境下载clion-client卡住下载缓慢\">#</a> 1. 远程环境下载 CLion Client 卡住 / 下载缓慢</h2>\n<p>由于下载站是 Jetbrains 官方站，国本部分时间网络环境可能不太好，导致下载进度缓慢或下载失败，可以按如下步骤操作：</p>\n<ol>\n<li>\n<p>登入远程主机，在用户家目录下 <code>cat wget-log</code></p>\n</li>\n<li>\n<p>在日志中找到实际的下载地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb3dubG9hZC5qZXRicmFpbnMuY29tL2NwcC9DTGlvbi0yNDEuMTQ0OTQuMjI5LnRhci5neg==\">https://download.jetbrains.com/cpp/CLion-241.14494.229.tar.gz</span></p>\n</li>\n<li>\n<p>本地下载后通过下面操作上传到云主机中：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/h6hawz.png\" alt=\"上传RC\" /></p>\n</li>\n</ol>\n<h2 id=\"2-无法识别cmake项目\"><a class=\"anchor\" href=\"#2-无法识别cmake项目\">#</a> 2. 无法识别 CMake 项目</h2>\n<p>未配置到 Toolchains 导致的，参考<a href=\"#%E9%85%8D%E7%BD%AEcmake\">配置 CMake</a></p>\n<h2 id=\"3-cmake版本不匹配\"><a class=\"anchor\" href=\"#3-cmake版本不匹配\">#</a> 3. CMake 版本不匹配</h2>\n<p>默认安装的 <code>CMake</code>  版本比较低，如果项目的 CMake 的最低版本要求比价高的话需要手动升级 CMake：</p>\n<ol>\n<li>在<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbWFrZS5vcmcvZmlsZXMv\">官网</span>下载所需版本的 CMake：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbWFrZS5vcmcvZmlsZXMvdjMuMjcvY21ha2UtMy4yNy42LWxpbnV4LXg4Nl82NC50YXIuZ3o=\">cmake-3.27.6-linux-x86_64.tar.gz</span></li>\n<li>上传到云主机中并解压： <code>tar zxvf cmake-3.27.6-linux-x86_64.tar.gz</code></li>\n<li><code>sudo mv cmake-3.27.6-linux-x86_64 /opt/cmake-3.27.6</code></li>\n<li><code>sudo ln -sf /opt/cmake-3.27.6/bin/* /usr/bin/</code></li>\n<li>使用 <code>cmake --version</code>  测试版本是否成功更新</li>\n</ol>\n<h2 id=\"4-找不到llvm-12\"><a class=\"anchor\" href=\"#4-找不到llvm-12\">#</a> 4. 找不到 llvm-12</h2>\n<p>如果 <code>sudo update-alternatives --install /usr/bin/llvm llvm /usr/bin/llvm-12 100</code>  失败，是因为这样下载的 ``llvm <code>没有提供一个统一的管理入口，各个</code>  llvm` 工具是分开安装的，可以通过下述命令列出所有工具：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ls</span> /usr/bin/llvm*12</pre></td></tr></table></figure><p>如果不需要用到 <code>llvm-as</code>  这类工具的话可以不用管他，如果需要用到的话，则需要单独为这些工具设置 <code>update-alternatives</code> ，例如：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> update-alternatives <span class=\"token parameter variable\">--install</span> /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-12 <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> update-alternatives <span class=\"token parameter variable\">--install</span> /usr/bin/llvm-ar llvm-ar /usr/bin/llvm-ar-12 <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 依此类推，添加所有你需要的工具</span></pre></td></tr></table></figure><h2 id=\"5-调试时无效断点问题\"><a class=\"anchor\" href=\"#5-调试时无效断点问题\">#</a> 5. 调试时无效断点问题</h2>\n<p>如果发现调试时断点无法断下来，可以尝试更换成 ToolChain：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/fagd7p.png\" alt=\"使用本地toolchain\" /></p>\n",
            "tags": [
                "杂项",
                "踩坑",
                "杂项",
                "踩坑",
                "CLion",
                "CMake"
            ]
        },
        {
            "id": "https://gality.cn/misc/c++/tips1/",
            "url": "https://gality.cn/misc/c++/tips1/",
            "title": "C++ ｜ 利用虚基类实现运行时多态",
            "date_published": "2024-05-30T06:52:11.000Z",
            "content_html": "<h1 id=\"类型擦除\"><a class=\"anchor\" href=\"#类型擦除\">#</a> 类型擦除</h1>\n<blockquote>\n<p>类型擦除是 C++ 中<strong>一种用于实现多态性的编程技术</strong>，它允许在不牺牲性能或引入不必要的运行时开销的情况下进行多态性操作。 通过隐藏对象的实际类型并提供统一的接口，类型擦除使得可以以多态的方式处理不同类型的对象，同时在运行时推迟对实际类型的确定。</p>\n</blockquote>\n<h2 id=\"类class\"><a class=\"anchor\" href=\"#类class\">#</a> 类 (Class)</h2>\n<p>首先来说类的类型擦除，来看一个例子：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span>  </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">fruit</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span> <span class=\"token comment\">// 确保访问修饰符是 public，以便派生类可以访问  </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">eat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 纯虚函数  </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">apple</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">fruit</span></span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">eat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"eat apple\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">watermelon</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">fruit</span></span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span>  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">eat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"eat watermelon\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">banana</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">fruit</span></span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span>  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">eat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"eat banana\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    apple a<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    banana b<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    watermelon w<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    fruit <span class=\"token operator\">*</span>p <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 类型擦除（apple 类型被转换成了 fruit 基类）  </span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    p<span class=\"token operator\">-></span><span class=\"token function\">eat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 运行 apple 的 eat ()  </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    p <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    p<span class=\"token operator\">-></span><span class=\"token function\">eat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 运行 banana 的 eat ()  </span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    p <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>w<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    p<span class=\"token operator\">-></span><span class=\"token function\">eat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 运行 watermelon 的 eat ()  </span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>运行结果：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>eat apple</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>eat banana</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>eat watermelon</pre></td></tr></table></figure><p>可以看到，通过这种方法，我们可以通过一个统一的入口 <code>fruit</code>  来动态的调用其实际子类的函数，这就是一种通过类型擦除来实现多态的方法。</p>\n<h2 id=\"类型type\"><a class=\"anchor\" href=\"#类型type\">#</a> 类型 (Type)</h2>\n<p>C++ 提供了 <code>std::any</code>  来表示任意类型的数据，并可以通过 <code>std::any_cast</code>  来在运行中动态的将 <code>std::any</code>  转换成正确的类型，结合上述类的类型擦除和模版，我们就可以做到一些很酷的事：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;any></span>  </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdexcept></span>  </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">any_convert_base</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>any val<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">any_convert</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">any_convert_base</span></span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>any val<span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      value <span class=\"token operator\">=</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token generic-function\"><span class=\"token function\">any_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>bad_any_cast<span class=\"token operator\">&amp;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token comment\">// 处理转换失败的情况</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token keyword\">throw</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">runtime_error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to cast std::any to type T\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  T value<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  any_convert_base<span class=\"token operator\">*</span> p<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>any i <span class=\"token operator\">=</span> <span class=\"token number\">123</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 类型擦除  </span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  any_convert<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> a<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  p <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 调用成员函数，接受任意类型的变量并尝试转换成需要的类型存储</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>⚠️ 注意，由于 <code>std::any</code>  在 <code>c++17</code>  中才引入，所以如果编译失败，可以尝试加上 <code>-std=c++17</code>  后再进行编译。</p>\n<p>通过上述代码，我们实现了给 <code>any_convert</code>  类的 <code>convert</code>  方法一个任意类型的参数， <code>convert</code>  可以自动将其转换成正确的类型。在此基础上，我们只需要再实现一个字符串到类型的注册机制，就可以在 <code>C++</code>  中实现 <code>Java</code>  的反射机制。</p>\n<p>总的来说，虽然类型擦除无法让 <code>c++</code>  像弱类型语言一样灵活，但确实可以赋予 <code>C++</code>  运行时多态的能力，在充分享受 <code>C++</code>  强类型的安全行 = 性、高效性的同时，提供更大的运行时灵活设计的空间，减轻了雷同代码逻辑的编写任务。</p>\n",
            "tags": [
                "杂项",
                "C++",
                "C++",
                "tips"
            ]
        },
        {
            "id": "https://gality.cn/misc/trail-and-error/ubuntu%E6%89%A9%E5%AE%B9/",
            "url": "https://gality.cn/misc/trail-and-error/ubuntu%E6%89%A9%E5%AE%B9/",
            "title": "Ubuntu虚拟机扩展磁盘 ｜ 命令行 ｜ LVM",
            "date_published": "2024-03-25T12:13:23.000Z",
            "content_html": "<div class=\"note primary no-icon\">\n<p>🎯 给虚拟机新增一个磁盘空间并挂载到根目录上</p>\n</div>\n<h1 id=\"分配空间\"><a class=\"anchor\" href=\"#分配空间\">#</a> 分配空间</h1>\n<p>首先需要在 VMware Fusion 中给虚拟机分配空间：</p>\n<ol>\n<li>删除所有快照并关闭虚拟机</li>\n<li>「设置」=&gt; 「硬盘」=&gt; 「磁盘大小」</li>\n<li>调整为合适的值（这里我调整为 80G，这个值是虚拟机所能使用的最大磁盘大小，而非是新增的大小）</li>\n</ol>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/ht0fvd.png\" alt=\"虚拟机设置\" /></p>\n<h1 id=\"ubuntu挂载空间\"><a class=\"anchor\" href=\"#ubuntu挂载空间\">#</a> Ubuntu 挂载空间</h1>\n<p>完成分配后，虚拟机 “看” 到的磁盘变大了，但由于还没有分配 &amp; 挂载，所以此时，Ubuntu 并不能直接使用这片空间，还需进行如下配置。</p>\n<h2 id=\"确认使用了lvm\"><a class=\"anchor\" href=\"#确认使用了lvm\">#</a> 确认使用了 LVM</h2>\n<p>Ubuntu Server 使用 <code>Logical Volume Management</code>  技术来管理磁盘分区，可以在不停止系统服务的前提下，就能动态增加硬盘空间。使用如下命令：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">df</span> <span class=\"token parameter variable\">-h</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Filesystem                         Size  Used Avail Use% Mounted on</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>udev                               <span class=\"token number\">2</span>.5G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.5G   <span class=\"token number\">0</span>% /dev</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>tmpfs                              590M  <span class=\"token number\">1</span>.6M  589M   <span class=\"token number\">1</span>% /run</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/dev/mapper/ubuntu--vg-ubuntu--lv   19G   14G  <span class=\"token number\">4</span>.6G  <span class=\"token number\">75</span>% /</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>tmpfs                              <span class=\"token number\">2</span>.9G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.9G   <span class=\"token number\">0</span>% /dev/shm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>tmpfs                              <span class=\"token number\">5</span>.0M     <span class=\"token number\">0</span>  <span class=\"token number\">5</span>.0M   <span class=\"token number\">0</span>% /run/lock</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>tmpfs                              <span class=\"token number\">2</span>.9G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.9G   <span class=\"token number\">0</span>% /sys/fs/cgroup</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/dev/sda2                          <span class=\"token number\">2</span>.0G  <span class=\"token number\">1</span>.1G  780M  <span class=\"token number\">58</span>% /boot</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/dev/loop0                          64M   64M     <span class=\"token number\">0</span> <span class=\"token number\">100</span>% /snap/core20/1828</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>/dev/loop2                          50M   50M     <span class=\"token number\">0</span> <span class=\"token number\">100</span>% /snap/snapd/18357</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>/dev/loop1                          92M   92M     <span class=\"token number\">0</span> <span class=\"token number\">100</span>% /snap/lxd/24061</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tmpfs                              590M     <span class=\"token number\">0</span>  590M   <span class=\"token number\">0</span>% /run/user/0</pre></td></tr></table></figure><p>看组名是 <code>ubuntu--vg-ubuntu--lv</code> ，确定使用了 LVM</p>\n<h2 id=\"创建新的物理卷\"><a class=\"anchor\" href=\"#创建新的物理卷\">#</a> 创建新的物理卷</h2>\n<p>创建个 sda4，把新增的空闲空间搞成一个分区好了</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$sudo</span> <span class=\"token function\">parted</span> /dev/sda</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>GNU Parted <span class=\"token number\">3.3</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Using /dev/sda</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Welcome to GNU Parted<span class=\"token operator\">!</span> Type <span class=\"token string\">'help'</span> to view a list of commands.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 打印磁盘使用情况，可以看到有 42.9GB 的空闲空间</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print <span class=\"token function\">free</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Model: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Disk /dev/sda: <span class=\"token number\">85</span>.9GB</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Sector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Partition Table: gpt</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Disk Flags:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Number  Start   End     Size    File system  Name  Flags</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token number\">17</span>.4kB  1049kB  1031kB  Free Space</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token number\">1</span>      1049kB  2097kB  1049kB                        bios_grub</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token number\">2</span>      2097kB  2150MB  2147MB  ext4</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token number\">3</span>      2150MB  <span class=\"token number\">42</span>.9GB  <span class=\"token number\">40</span>.8GB</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token number\">42</span>.9GB  <span class=\"token number\">85</span>.9GB  <span class=\"token number\">42</span>.9GB  Free Space</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 创建新分区        </span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> mkpart primary ext4 <span class=\"token number\">42</span>.9GB <span class=\"token number\">100</span>%</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print <span class=\"token function\">free</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Model: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Disk /dev/sda: <span class=\"token number\">85</span>.9GB</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Sector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Partition Table: gpt</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Disk Flags:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Number  Start   End     Size    File system  Name     Flags</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token number\">17</span>.4kB  1049kB  1031kB  Free Space</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token number\">1</span>      1049kB  2097kB  1049kB                        bios_grub</pre></td></tr><tr><td data-num=\"29\"></td><td><pre> <span class=\"token number\">2</span>      2097kB  2150MB  2147MB  ext4</pre></td></tr><tr><td data-num=\"30\"></td><td><pre> <span class=\"token number\">3</span>      2150MB  <span class=\"token number\">42</span>.9GB  <span class=\"token number\">40</span>.8GB</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token number\">4</span>      <span class=\"token number\">42</span>.9GB  <span class=\"token number\">85</span>.9GB  <span class=\"token number\">42</span>.9GB               primary</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token number\">85</span>.9GB  <span class=\"token number\">85</span>.9GB  1032kB  Free Space</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> quit</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\"># 创建了一个 ext4 类型主分区。设备路径是 /dev/sda4</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token variable\">$sudo</span> pvcreate /dev/sda4</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  Physical volume <span class=\"token string\">\"/dev/sda4\"</span> successfully created.</pre></td></tr></table></figure><h2 id=\"把ubuntu-vg组扩展到devsda4上\"><a class=\"anchor\" href=\"#把ubuntu-vg组扩展到devsda4上\">#</a> 把 ubuntu-vg 组扩展到 /dev/sda4 上</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$sudo</span> vgextend ubuntu-vg /dev/sda4</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  Volume group <span class=\"token string\">\"ubuntu-vg\"</span> successfully extended</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token variable\">$sudo</span> lvm lvextend <span class=\"token parameter variable\">-l</span> +100%FREE /dev/ubuntu-vg/ubuntu-lv</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  Size of logical volume ubuntu-vg/ubuntu-lv changed from <span class=\"token operator\">&lt;</span><span class=\"token number\">19.00</span> GiB <span class=\"token punctuation\">(</span><span class=\"token number\">4863</span> extents<span class=\"token punctuation\">)</span> to <span class=\"token number\">77</span> GiB <span class=\"token punctuation\">(</span><span class=\"token number\">19964</span> extents<span class=\"token punctuation\">)</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  Logical volume ubuntu-vg/ubuntu-lv successfully resized.</pre></td></tr></table></figure><h2 id=\"扩展文件系统\"><a class=\"anchor\" href=\"#扩展文件系统\">#</a> 扩展文件系统</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$sudo</span> resize2fs <span class=\"token parameter variable\">-p</span> /dev/mapper/ubuntu--vg-ubuntu--lv</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>resize2fs <span class=\"token number\">1.45</span>.5 <span class=\"token punctuation\">(</span>07-Jan-2020<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Filesystem at /dev/mapper/ubuntu--vg-ubuntu--lv is mounted on /<span class=\"token punctuation\">;</span> on-line resizing required</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>old_desc_blocks <span class=\"token operator\">=</span> <span class=\"token number\">3</span>, new_desc_blocks <span class=\"token operator\">=</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>The filesystem on /dev/mapper/ubuntu--vg-ubuntu--lv is now <span class=\"token number\">10221568</span> <span class=\"token punctuation\">(</span>4k<span class=\"token punctuation\">)</span> blocks long.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token variable\">$df</span> <span class=\"token parameter variable\">-h</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Filesystem                         Size  Used Avail Use% Mounted on</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>udev                               <span class=\"token number\">2</span>.5G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.5G   <span class=\"token number\">0</span>% /dev</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>tmpfs                              590M  <span class=\"token number\">1</span>.6M  589M   <span class=\"token number\">1</span>% /run</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/dev/mapper/ubuntu--vg-ubuntu--lv   77G   14G   63G  <span class=\"token number\">18</span>% /</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>tmpfs                              <span class=\"token number\">2</span>.9G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.9G   <span class=\"token number\">0</span>% /dev/shm</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>tmpfs                              <span class=\"token number\">5</span>.0M     <span class=\"token number\">0</span>  <span class=\"token number\">5</span>.0M   <span class=\"token number\">0</span>% /run/lock</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tmpfs                              <span class=\"token number\">2</span>.9G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.9G   <span class=\"token number\">0</span>% /sys/fs/cgroup</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>/dev/sda2                          <span class=\"token number\">2</span>.0G  <span class=\"token number\">1</span>.1G  780M  <span class=\"token number\">58</span>% /boot</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>/dev/loop0                          64M   64M     <span class=\"token number\">0</span> <span class=\"token number\">100</span>% /snap/core20/1828</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>/dev/loop2                          50M   50M     <span class=\"token number\">0</span> <span class=\"token number\">100</span>% /snap/snapd/18357</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>/dev/loop1                          92M   92M     <span class=\"token number\">0</span> <span class=\"token number\">100</span>% /snap/lxd/24061</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>tmpfs                              590M     <span class=\"token number\">0</span>  590M   <span class=\"token number\">0</span>% /run/user/0</pre></td></tr></table></figure><p>完成～</p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9vaS4wdzAuaW8vMjAyMi8wNC8yMC8lRTUlOUMlQTh2bXdhcmUlRTQlQjglOEIlRTYlODklQTklRTUlQjElOTUtdWJ1bnR1LTIwLTA0LSVFNyVBMyU4MSVFNyU5QiU5OCVFNSU4OCU4NiVFNSU4QyVCQSVFRiVCQyU4OC1kZXYtbWFwcGVyLXVidW50dS12Zy11YnVudHUtbHYlRUYlQkMlODkv\">https://oi.0w0.io/2022/04/20 / 在 vmware 下扩展 - ubuntu-20-04 - 磁盘分区（-dev-mapper-ubuntu-vg-ubuntu-lv）/</span></li>\n</ul>\n",
            "tags": [
                "杂项",
                "踩坑",
                "杂项",
                "踩坑",
                "Ubuntu"
            ]
        },
        {
            "id": "https://gality.cn/os/kernel/build-kernel/",
            "url": "https://gality.cn/os/kernel/build-kernel/",
            "title": "从0开始构建Linux内核",
            "date_published": "2024-03-25T10:23:22.000Z",
            "content_html": "<div class=\"note primary no-icon\">\n<p>⚙️ 以下是本篇文章所使用的环境：</p>\n<ul>\n<li>宿主机：MacOS Sonoma 14.4</li>\n<li>虚拟机：Ubuntu Server 20.04 LTS</li>\n<li>VMware Fusion 13.5.1</li>\n<li>Linux kernel 5.4.272</li>\n</ul>\n</div>\n<h1 id=\"环境准备\"><a class=\"anchor\" href=\"#环境准备\">#</a> 环境准备</h1>\n<h2 id=\"下载项\"><a class=\"anchor\" href=\"#下载项\">#</a> 下载项</h2>\n<h3 id=\"下载linux内核源码\"><a class=\"anchor\" href=\"#下载linux内核源码\">#</a> 下载 Linux 内核源码</h3>\n<p>从<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cua2VybmVsLm9yZy8=\">官方网站</span>下载 linux 内核源码</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/0egux9.png\" alt=\"linux kernel\" /></p>\n<p>点击 [tarball]，你会得到一个 <code>linux-5.4.272.tar.xz</code>  格式的打包文件，后续会用到。</p>\n<h3 id=\"下载ubuntu-server\"><a class=\"anchor\" href=\"#下载ubuntu-server\">#</a> 下载 Ubuntu Server</h3>\n<div class=\"note info no-icon\">\n<ol>\n<li>\n<p>选择 Ubuntu 的原因在于 Ubuntu 是目前市场占有率最高的 Linux 系统，这意味着他会有最好的支持和社区，便于查找 &amp; 解决各种 bug。</p>\n</li>\n<li>\n<p>选择 Server 版的原因在于 Server 版本舍弃了图形化界面，整体大小会小非常多，这意味着能给内核的编译 &amp; 后续操作留更多的空间。</p>\n</li>\n<li>\n<p>选择 20.04 版本的原因在于该版本默认使用 linux 5.4 的内核，减少我们后续自己编译的内核时可能出现的莫名 bug。</p>\n</li>\n</ol>\n</div>\n<p>从<span class=\"exturl\" data-url=\"aHR0cHM6Ly91YnVudHUuY29tL2Rvd25sb2FkL3NlcnZlcg==\">官方网站</span>下载 Ubuntu Server 的镜像文件</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/9oceyz.png\" alt=\"ubuntu server\" /></p>\n<h2 id=\"必要配置\"><a class=\"anchor\" href=\"#必要配置\">#</a> 必要配置</h2>\n<h3 id=\"虚拟机配置共享文件夹\"><a class=\"anchor\" href=\"#虚拟机配置共享文件夹\">#</a> 虚拟机配置共享文件夹</h3>\n<div class=\"note warning no-icon\">\n<p>⚠️ 本篇文章假定读者知道：如何使用虚拟机软件安装虚拟系统，如果不知道，请自行 Google～</p>\n<p>在假定读者已经知道如何安装虚拟机的基础上，<span class=\"red\">请注意</span>：</p>\n<ol>\n<li>安装虚拟机时请给虚拟机最好分配<strong> 70G</strong> 以上的存储空间，因为编译内核所需空间非常大，使用默认配置的 20G 空间会导致没有足够空间编译内核。</li>\n<li>最好分配<strong> 4 个</strong>以上 CPU 核心，核心数量直接影响内核的编译速度。</li>\n<li>最好分配<strong> 4G</strong> 以上内存</li>\n</ol>\n</div>\n<p>由于采用的是没有图形化界面的 Server 版本，所以我们最好配置一下<strong>共享文件夹</strong>来方便在宿主机和虚拟机之间共享文件，配置过程如下：</p>\n<ol>\n<li>\n<p>找到「设置」=&gt; 「共享」</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/i3o4xc.png\" alt=\"共享设置\" /></p>\n</li>\n<li>\n<p>创建一个文件夹用于共享，并将其权限改为「读与写」，点击「启用共享文件夹」（我这里共享文件夹命名为 <code>share</code> ）。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/bgjphy.png\" alt=\"共享文件夹\" /></p>\n</li>\n<li>\n<p>将刚刚下载的内核文件放入文件夹中，并在虚拟机中执行如下指令：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /mnt/hgfs/share</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ls</span></pre></td></tr></table></figure><p>如果一切顺利，你将会看到 <code>linux-5.4.272.tar.xz</code>  就在这里。「 所有共享文件夹会自动被挂载在 <code>/mnt/hgfs</code>  下，如果你的共享文件夹命名为其他的名字，请替换成自己的名字：) 」</p>\n<p>🙅 如果没有找到 <code>share</code>  文件夹，可以参考<span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC83MzE4MjM3NDkxOTA2NTQzNjQy\">这篇博客</span>。</p>\n</li>\n</ol>\n<details class=\"warning\"><summary>❗️linux虚拟机中无法写共享文件夹</summary><div>\n<p>笔者使用的是 MacOS，权限相对控制比较严格，共享文件夹的默认权限是只读，所以想让 linux 虚拟机可以向共享文件夹写入内容需要更改文件夹的权限，在 “share” 文件夹上点击「显示简介」，将本用户的权限改成「读与写」即可，如下图所示。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/xhhjub.png\" alt=\"共享文件夹权限修改\" /></p>\n</div></details>\n<h3 id=\"apt换源\"><a class=\"anchor\" href=\"#apt换源\">#</a> apt 换源</h3>\n<p>构建内核需要依赖大量工具，建议先更换一下 apt 源，方便下载。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 备份之前的 sources.list</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak</pre></td></tr></table></figure><p>然后替换 <code>/etc/apt/sources.list</code>  为以下内容并保存：</p>\n<pre><code>deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse\n</code></pre>\n<p>完成后使用 <code>sudo apt update</code>  来重新获取一下软件包缓存。</p>\n<h3 id=\"编译工具安装\"><a class=\"anchor\" href=\"#编译工具安装\">#</a> 编译工具安装</h3>\n<p>安装编译内核时所需的工具，这里假设你使用的是一个纯净的 ubuntu 系统。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> gcc g++ <span class=\"token function\">make</span> <span class=\"token function\">git</span> libncurses5-dev build-essential kernel-package libssl-dev libelf-dev dwarves flex bison</pre></td></tr></table></figure><h1 id=\"编译内核\"><a class=\"anchor\" href=\"#编译内核\">#</a> 编译内核</h1>\n<h2 id=\"解压linux内核\"><a class=\"anchor\" href=\"#解压linux内核\">#</a> 解压 Linux 内核</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 将 Linux 内核从共享文件夹中复制到家目录下</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> /mnt/hgfs/share/linux-5.4.272.tar.xz ~/ <span class=\"token operator\">|</span> <span class=\"token builtin class-name\">cd</span> ~ </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 解压</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>xz <span class=\"token parameter variable\">-d</span> linux-5.4.272.tar.xz</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvf</span> linux-5.4.272.tar</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">cd</span> linux-5.4.272</pre></td></tr></table></figure><h2 id=\"配置linux内核\"><a class=\"anchor\" href=\"#配置linux内核\">#</a> 配置 Linux 内核</h2>\n<p>Linux 内核的构建过程会查找  <code>.config</code>  文件，这是一个配置文件，用于指定 Linux 内核的所有可能的配置选项。这是必需的文件。</p>\n<p>获取 Linux 内核的  <code>.config</code>  文件有两种方式：</p>\n<ol>\n<li>使用你的 Linux 发行版的配置作为基础（<strong>推荐做法</strong>）</li>\n<li>使用默认的，通用的配置</li>\n</ol>\n<blockquote>\n<p>💡 也有第三种方法，也就是从零开始，手动配置每一个选项，但注意，这需要配置超过 12,000 个选项。并不推荐这种方式，因为手动配置所有选项将花费大量的时间，并且你还需要理解每个启用和禁用选项的含义。</p>\n</blockquote>\n<p>以下是第一种方式：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> linux-*/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 复制你的 Ubuntu 的配置文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> /boot/config-<span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">uname</span> <span class=\"token parameter variable\">-r</span><span class=\"token variable\">)</span></span>\"</span> .config</pre></td></tr></table></figure><h2 id=\"更新config配置\"><a class=\"anchor\" href=\"#更新config配置\">#</a> 更新 config 配置</h2>\n<p>由于我们使用的是 “旧的配置文件”（当前保存为  <code>.config</code> ，这是发行版配置的一个副本），所以需要检查从上一版本以来 Linux 代码库中新加的任何配置选项。如果找到任何「新的、未配置」 的选项，该选项的默认配置值会被使用，并会对  <code>.config</code>  文件进行更新。</p>\n<p>原来的  <code>.config</code>  文件将被重命名为  <code>.config.old</code>  进行备份，并将新的更改写入至  <code>.config</code>  文件。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">make</span> olddefconfig</pre></td></tr></table></figure><h2 id=\"添加必要配置\"><a class=\"anchor\" href=\"#添加必要配置\">#</a> 添加必要配置</h2>\n<p>构建内核时内核模块会使用一个签名证书，默认情况下，你的计算机并不包含这个证书。我们可以用以下命令告诉编译器，自行生成一个签名证书并在编译时使用。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./scripts/config <span class=\"token parameter variable\">--file</span> .config --set-str SYSTEM_TRUSTED_KEYS <span class=\"token string\">''</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>./scripts/config <span class=\"token parameter variable\">--file</span> .config --set-str SYSTEM_REVOCATION_KEYS <span class=\"token string\">''</span></pre></td></tr></table></figure><p>我们还可以为自定义内核构建添加一个标签。我使用字符串  <code>-gality</code>  作为标签。这样当运行  <code>uname -r</code>  命令时，就会显示 <code>5.4.272-gality</code>  了：)</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./scripts/config <span class=\"token parameter variable\">--file</span> .config --set-str LOCALVERSION <span class=\"token string\">\"-gality\"</span></pre></td></tr></table></figure><h2 id=\"编译\"><a class=\"anchor\" href=\"#编译\">#</a> 编译</h2>\n<p>实际的编译很简单，也很漫长（可能 1～3 小时，如果顺利的话～</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># -j 参数指定使用多个核心来加速编译过程</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">make</span> -j<span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span></pre></td></tr></table></figure><p>如果很不幸，你出现了 <code>No space left on device</code>  的错误，那么意味着你并没有好好阅读之前的内容，不过，你可以参考<a href=\"https://gality.cn/misc/trail-and-error/ubuntu%E6%89%A9%E5%AE%B9/\">这篇文章</a>来让解决问题。</p>\n<h1 id=\"安装内核\"><a class=\"anchor\" href=\"#安装内核\">#</a> 安装内核</h1>\n<h2 id=\"安装模块\"><a class=\"anchor\" href=\"#安装模块\">#</a> 安装模块</h2>\n<p>将已经编译好的模块安装到内核中</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">make</span> modules_install</pre></td></tr></table></figure><h2 id=\"安装-linux-内核头文件可选\"><a class=\"anchor\" href=\"#安装-linux-内核头文件可选\">#</a> 安装 Linux 内核头文件 (可选)</h2>\n<p>如果打算尝试自行编写模块，可能会需要 Linux 内核提供的头文件。可使用如下命令来安装头文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">make</span> headers_install</pre></td></tr></table></figure><p>这些头文件会被安装到  <code>/usr</code>  目录。同时还会在  <code>/usr</code>  目录内创建子目录  <code>include/linux</code> ，然后将头文件安装到  <code>/usr/include/linux</code>  内</p>\n<h2 id=\"安装内核-2\"><a class=\"anchor\" href=\"#安装内核-2\">#</a> 安装内核</h2>\n<p>安装内核，这个过程会更新 boot 和 grub</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">make</span> <span class=\"token function\">install</span></pre></td></tr></table></figure><p>此时，可以重启 <code>reboot</code>  来测试新内核是否成功安装：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">uname</span> <span class=\"token parameter variable\">-r</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">5.4</span>.272-gality <span class=\"token comment\"># Yeah~</span></pre></td></tr></table></figure><h3 id=\"安装失败报错\"><a class=\"anchor\" href=\"#安装失败报错\">#</a> 安装失败报错</h3>\n<p>如果在安装内核时出现类似如下报错：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>update-initramfs: Generating /boot/initrd.img-5.4.0.52-generic</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Error <span class=\"token number\">24</span> <span class=\"token builtin class-name\">:</span> Write error <span class=\"token builtin class-name\">:</span> cannot <span class=\"token function\">write</span> compressed block</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>E: mkinitramfs failure cpio <span class=\"token number\">141</span> lz4 <span class=\"token parameter variable\">-9</span> <span class=\"token parameter variable\">-I</span> <span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>update-initramfs: failed <span class=\"token keyword\">for</span> /boot/initrd.img-5.4.0-52-generic with <span class=\"token number\">1</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>代表写入 <code>/boot</code>  失败，可以按如下步骤确定原因：</p>\n<ol>\n<li>判断是否有 <code>/boot</code>  目录的权限（是否用 <code>sudo</code>  了？ <code>/boot</code>  和所有文件是否属于 <code>root</code> ？）</li>\n<li><code>/boot</code>  目录是否有足够剩余空间（ <code>/boot</code>  可能被过时的内核填满了）？</li>\n<li>是否是驱动的问题（能否在别的位置写入文件）？</li>\n</ol>\n<p>如果是全新的 ubuntu 系统用于安装内核，大概率不会出现问题，笔者本身遇到这个问题是因为之前手动编译安装过一次内核，第二次安装时出现这个问题，解决方法如下：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> list <span class=\"token parameter variable\">--installed</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> linux-image <span class=\"token comment\"># 列出所有安装过的内核</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> remove linux-image-5.4.0-54-generic <span class=\"token comment\"># 删除过时的内核</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> autoremove <span class=\"token comment\"># 自动删除过时内核的依赖</span></pre></td></tr></table></figure><p>重复上述操作，直到 <code>sudo apt list --installed | grep linux-image</code>  后没有出现任何版本内核。然后重新 <code>sudo make install</code>  即可成功安装内核。</p>\n",
            "tags": [
                "操作系统",
                "内核",
                "操作系统",
                "kernel",
                "linux"
            ]
        },
        {
            "id": "https://gality.cn/llvm/llvm-tutorial/",
            "url": "https://gality.cn/llvm/llvm-tutorial/",
            "title": "LLVM 简明教程",
            "date_published": "2024-03-11T02:35:28.000Z",
            "content_html": "<div class=\"note warning no-icon\">\n<p>⚠️ 笔者本人也是 LLVM 新手，所以本篇内容只是笔者在自己的理解上写出的笔记性质的 “教程”，如有错误，还请大佬们指正。写这篇文章的目的在于，笔者自己在入门 LLVM IR 及 API 时基本都是英文教程，国内的教程非常杂乱，LLVM IR 相关的内容还比较丰富，但对于 LLVM API 相关的资料就比较少了，笔者在学习过程中的很多问题都是在 Stack Overflow 上得到解答的，所以这里将各种踩坑记录下来，帮助其他同学。</p>\n</div>\n<h1 id=\"llvm-安装与环境配置\"><a class=\"anchor\" href=\"#llvm-安装与环境配置\">#</a> LLVM 安装与环境配置</h1>\n<div class=\"note primary no-icon\">\n<p>笔者的环境为：</p>\n<ul>\n<li>MacBook Pro 2019 Intel 芯片 macOS 14.2.1 Sonoma</li>\n<li>Homebrew 4.2.11</li>\n<li>CLion 233.14475.31, built on February 13, 2024</li>\n</ul>\n</div>\n<h2 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h2>\n<p>由于 xcode 自带的 LLVM 是经过阉割的版本，很多 llvm 的命令都没有，所以需要单独下载 llvm，推荐使用 <code>Homebrew</code>  来安装。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 搜索所有可用的 llvm 版本</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>brew search llvm</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 下载指定版本</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>brew <span class=\"token function\">install</span> llvm@11</pre></td></tr></table></figure><p>由于<strong> llvm 不同版本之间的 API 有些微不同</strong>，所以最好是根据需求安装指定版本的 LLVM，防止出现 <code>undefined symbol</code>  的问题。</p>\n<details class=\"info\"><summary>无法安装/安装出错</summary><div>\n<p>如果安装时出现报错： <code>Error: llvm@11 has been disabled because it is a versioned formula!</code> ，可以通过如下方式解决：</p>\n<ol>\n<li><code>brew tap --force homebrew/core</code></li>\n<li><code>brew edit llvm@11</code></li>\n<li>把  <code>disable! date: &quot;2024-02-22&quot;, because: :versioned_formula</code>  中的过期时间改为当前或以后，然后保存</li>\n<li><code>HOMEBREW_NO_INSTALL_FROM_API=1 brew install llvm@11</code></li>\n</ol>\n</div></details>\n<p>安装完成后需要将如下配置写入环境变量中，由于笔者使用的 <code>zsh</code> ，所以就是把如下内容写入到 <code>~/.zshrc</code>  中：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LDFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"-L/usr/local/opt/llvm@11/lib -Wl,-rpath,/usr/local/opt/llvm@11/lib\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"/usr/local/opt/llvm@11/bin:<span class=\"token environment constant\">$PATH</span>\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LDFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"-L/usr/local/opt/llvm@11/lib\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CPPFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"-I/usr/local/opt/llvm@11/include\"</span></pre></td></tr></table></figure><p>这是在当前版本下 <code>Homebrew</code>  的默认 LLVM 安装路径，如果你的路径不是这个，请改成自己的路径。</p>\n<h2 id=\"测试\"><a class=\"anchor\" href=\"#测试\">#</a> 测试</h2>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 重新加载一下环境变量</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">source</span> ~/.zshrc</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 测试 llvm 是否成功安装</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>llvm-config <span class=\"token parameter variable\">--version</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>╰▸ <span class=\"token number\">11.1</span>.0</pre></td></tr></table></figure><h2 id=\"环境配置\"><a class=\"anchor\" href=\"#环境配置\">#</a> 环境配置</h2>\n<div class=\"note info\">\n<p>笔者尝试了多种不同的 IDE，包括 VSCode、Xcode 和 CLion，最终成功在 CLion 上成功搭建了可调试的 LLVM 开发环境，所以推荐使用 CLion 作为 IDE。</p>\n</div>\n<ol>\n<li>\n<p>随便创建一个 <code>C++ Executable</code>  项目，语言标准任选。</p>\n</li>\n<li>\n<p>点击<span class=\"kbd\"> CLion</span> =&gt; <span class=\"kbd\">settings</span> =&gt; <span class=\"kbd blue\">Build, Execution, Deployment</span> =&gt; <span class=\"kbd red\">CMake options</span>，写入：<br />\n <code>-DLLVM_DIR:PATH=/usr/local/Cellar/llvm@11/11.1.0_4/lib/cmake/llvm</code></p>\n</li>\n<li>\n<p>CLion 应该会自动为当前项目创建一个 <code>CMakeLists.txt</code> 。如果没有，则在 CLion 左边的项目根目录中<span class=\"kbd\">右键</span> =&gt; <span class=\"kbd\">new</span> =&gt; <span class=\"kbd red\">CMakeLists.txt</span>。</p>\n</li>\n<li>\n<p>将如下内容写入 <code>CMakeLists.txt</code>  中（假设你的项目名为 llvm_test）：</p>\n<figure class=\"highlight cmake\"><figcaption data-lang=\"CMake\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">cmake_minimum_required</span><span class=\"token punctuation\">(</span><span class=\"token property\">VERSION</span> <span class=\"token number\">3.27</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">project</span><span class=\"token punctuation\">(</span>llvm_test<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 需改为你的项目名</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">find_package</span><span class=\"token punctuation\">(</span>LLVM REQUIRED CONFIG<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">message</span><span class=\"token punctuation\">(</span>STATUS <span class=\"token string\">\"Found LLVM <span class=\"token interpolation\"><span class=\"token punctuation\">$&#123;</span><span class=\"token variable\">LLVM_PACKAGE_VERSION</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">message</span><span class=\"token punctuation\">(</span>STATUS <span class=\"token string\">\"Using LLVMConfig.cmake in: <span class=\"token interpolation\"><span class=\"token punctuation\">$&#123;</span><span class=\"token variable\">LLVM_DIR</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># Set your project compile flags.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># E.g. if using the C++ header files</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># you will need to enable C++11 support</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># for your compiler.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">include_directories</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">$&#123;</span>LLVM_INCLUDE_DIRS<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">add_definitions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">$&#123;</span>LLVM_DEFINITIONS<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token variable\">CMAKE_CXX_STANDARD</span> <span class=\"token number\">17</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">add_executable</span><span class=\"token punctuation\">(</span>llvm_test main.cpp<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 需改为你的项目名 需要编译的 cpp 文件名</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token function\">llvm_map_components_to_libnames</span><span class=\"token punctuation\">(</span>llvm_libs irreader<span class=\"token punctuation\">)</span> <span class=\"token comment\">#根据需要填入 LLVM 组件</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># Link against LLVM libraries</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">target_link_libraries</span><span class=\"token punctuation\">(</span>llvm_test <span class=\"token punctuation\">$&#123;</span>llvm_libs<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure></li>\n<li>\n<p>保存后即可使用 CLion 愉快的开发 / Debug LLVM C++ API 代码了。</p>\n</li>\n</ol>\n<details class=\"info\"><summary>⚠️常见问题</summary><div>\n<ol>\n<li>如果在第 4 步出现错误：找不到 <code>LLVMConfig.cmake</code>  文件，代表你的 <code>Homebrew</code>  和笔者不同，请全局搜索 <code>LLVMConfig.cmake</code>  文件并在 <code>-DLLVM_DIR:PATH=</code>  后写入正确的位置）</li>\n<li>上述代码中 <code>llvm_map_components_to_libnames(llvm_libs irreader)</code>  是一种按需使用 LLVM 组件的方式， <code>irreader</code>  就是一个组件，对应着头文件 <code>&quot;llvm/IR/IRBuilder.h&quot;</code> ，如果你在引用头文件是出现 <code>&quot;xxx.h&quot; not found</code>  的错误，请检查是否在 <code>CMakeLists.txt</code>  中引入了对应的组件。</li>\n<li>可以通过 <code>llvm-config --components all</code>  列出 LLVM 的所有组件。</li>\n</ol>\n</div></details>\n<h1 id=\"llvm-基本知识\"><a class=\"anchor\" href=\"#llvm-基本知识\">#</a> LLVM 基本知识</h1>\n<h2 id=\"基本概念\"><a class=\"anchor\" href=\"#基本概念\">#</a> 基本概念</h2>\n<h3 id=\"引入\"><a class=\"anchor\" href=\"#引入\">#</a> 引入</h3>\n<p>随着计算机技术的不断发展以及各种领域需求的增多，近几年来，许多编程语言如雨后春笋般出现，他们大多为了解决某一些特定领域的需求，比如说为 JavaScript 增加静态类型检查的 TypeScript，为解决服务器端高并发的 Golang，为解决内存安全和线程安全的 Rust。</p>\n<p>让我们设身处地地想象一下，如果我们想开发一门新的编译型的编程语言，有什么需要解决的问题呢？</p>\n<ol>\n<li>\n<p>怎样让我的编程语言能在尽可能多的平台上运行</p>\n<p>​\t我想让我的编程语言能够在 Windows、macOS 和 Linux 上都可以运行；我想让我的编程语言能够在 Intel 芯片、ARM 芯片，乃至龙芯上都可以运行。</p>\n</li>\n<li>\n<p>怎样让我的编程语言可以使用前人先进的技术</p>\n<p>​\t在编程语言发展的过程中，有许许多多成熟的技术。从汇编指令层面来看，简单地想给一个变量值置 0，AMD64 架构下可以用 <code>xor %eax, %eax</code>  异或自身，AArch64 架构下可以用 <code>mov w0, wzr</code>  使用零寄存器；从算法层面来看，可以使用尾调用优化、CFI 等。如果我不想重复造轮子，该如何复用这些技术呢？</p>\n</li>\n<li>\n<p>怎样让我的编程语言在汇编层面实现「定制」</p>\n<p>​\t高级语言中的函数名，在汇编层面，我想让他换个名字；我想让 C 语言库能用它的调用约定来调用我的高级语言中的函数。</p>\n</li>\n</ol>\n<p>我们可以选择使用 C 语言来作为 “中间层”，当我们开发新编译语言时，提供该语言到 C 语言的转换，这样做是因为：</p>\n<ol>\n<li>绝大部分的操作系统都是由 C 和汇编语言写成，因此平台大多会提供一个 C 编译器可以使用，这样就解决了第一个问题</li>\n<li>C 语言历史久远，有非常多的优化器，程序翻译成 C 语言后就可以直接使用那些为 C 语言定制的优化器，从而方便的使用前人的成熟技术，这就解决了第二个问题。</li>\n<li>C 语言本身并没有笨重的运行时，代码很贴近底层，可以使用一定程度的定制，一定程度上解决了第三个问题。</li>\n</ol>\n<p>然而，C 语言毕竟是 “老古董” 了，相对于现在的各种编程语言来说还是太过僵硬死板。如果有这么一种语言，他<strong>可以在各个平台运行</strong>，且<strong>自带极高的代码优化能力</strong>，同时<strong>提供灵活操作系统底层的能力</strong>，那么当我们想开发一个新的编程语言时，岂不是只需要提供一个从新语言到这种语言的转换器就可以了。没错，这就是 LLVM！</p>\n<p>简单来说，当我们想开发一种新的编程语言时，只需提供将自己语言的源代码编译成 LLVM 的中间代码（LLVM IR）的能力，然后就可以交由 LLVM 对中间代码进行优化，并编译成所需运行平台的二进制程序。LLVM 的优点也正对应我们之前讲的三个问题：</p>\n<ul>\n<li>\n<p>LLVM 后端支持的平台很多，我们不需要担心 CPU、操作系统的问题</p>\n<p>有一点需要指出的是，操作系统 API 的调用还是得由编程语言开发者自己实现，LLVM 不负责这个。例如，编程语言的标准库中，打开一个文件，其底层实现在 Linux 中是否是 <code>open</code>  系统调用，在 Windows 中是否是 <code>CreateFile</code>  函数，这都得编程语言开发者自己实现。</p>\n</li>\n<li>\n<p>LLVM 后端的优化水平较高，我们只需要将代码编译成 LLVM IR，就可以由 LLVM 后端作相应的优化</p>\n<p>但我们需要知道一点，LLVM IR 毕竟是更为底层的语言，在高级语言中的许多细节，都会在 LLVM IR 中丢失。因此，高级语言中能做的优化，还是得趁早做，把一大堆未经优化的 LLVM IR 丢给 LLVM 后端去优化，会严重拖慢编译时间，降低生成的二进制程序的性能。</p>\n</li>\n<li>\n<p>LLVM IR 本身比较贴近汇编语言，同时也提供了许多 ABI 层面的定制化功能</p>\n</li>\n</ul>\n<h3 id=\"架构\"><a class=\"anchor\" href=\"#架构\">#</a> 架构</h3>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/lhykol.jpg\" alt=\"LLVM 架构\" /></p>\n<p>LLVM 整体架构如上图所示。在整个编译过程中，LLVM 的前端是为各种编程语言定制的，负责将对应编程语言的源代码转换成 LLVM 中间表示（IR，Intermediate Representation）；LLVM 的后端为各种不同的平台做了适配，负责将 LLVM IR 转换成在特定平台上可执行的二进制文件。如果在编译过程中涉及到优化的话，则由 LLVM 优化器来对 IR 文件进行优化，并将优化后的 IR 文件输出给 LLVM 后端去编译，因此 IR 的设计是 LLVM 的灵魂所在。</p>\n<h3 id=\"llvm-ir\"><a class=\"anchor\" href=\"#llvm-ir\">#</a> LLVM IR</h3>\n<div class=\"note info no-icon\">\n<p>🔔 有关 IR 的更多知识，将在「基本 IR 指令」章节中讲解</p>\n</div>\n<p>LLVM IR 的设计体现了<strong>权衡</strong>的计算思维。低级的 IR（即更接近目标代码的 IR）允许编译器更容易地生成针对特定硬件的优化代码，但不利于支持多目标代码的生成。高级的 IR 允许优化器更容易地提取源代码的意图，但不利于编译器根据不同的硬件特性进行代码优化。</p>\n<p>LLVM IR 的设计采用 <code>common IR</code>  和 <code>specific IR</code>  相结合的方式。 <code>common IR</code>  旨在不同的后端共享对源程序的相同理解，以将其转换为不同的目标代码。除此之外，也为多个后端之间共享一组与目标无关的优化提供了可能性。 <code>specific IR</code>  允许不同的后端在不同的较低级别优化目标代码。这样做，既可以支持多目标代码的生成，也兼顾了目标代码的执行效率。</p>\n<p>LLVM IR 有如下 3 种<strong>等价</strong>形式：</p>\n<ul>\n<li>内存表示\n<ul>\n<li>类 <code>llvm::Function</code> 、 <code>llvm::Instruction</code>  等用于表示 <code>common IR</code> 。</li>\n<li>类 <code>llvm::MachineFunction</code> 、 <code>llvm::MachineInstr</code>  等用于表示 <code>specific IR</code> 。</li>\n</ul>\n</li>\n<li><code>.bc</code>  格式（Bitcode Files，存储在磁盘中）</li>\n<li><code>.ll</code>  格式（存储在磁盘中，便于人类阅读）</li>\n</ul>\n<p>LLVM IR 的特点如下：</p>\n<ul>\n<li>采用静态单一赋值（Static Single Assignment，SSA），即每个值只有一个定义它的赋值操作</li>\n<li>代码被组织为三地址指令（Three-address Instructions）</li>\n<li>有无限多个寄存器</li>\n</ul>\n<h2 id=\"基本命令\"><a class=\"anchor\" href=\"#基本命令\">#</a> 基本命令</h2>\n<h3 id=\"c-to-irbitcode\"><a class=\"anchor\" href=\"#c-to-irbitcode\">#</a> C to IR/Bitcode</h3>\n<p>由  <code>test.c</code>  生成  <code>IR</code>  文件</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>clang -emit-llvm <span class=\"token parameter variable\">-S</span> test.c <span class=\"token parameter variable\">-o</span> test.ll</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>clang -emit-llvm <span class=\"token parameter variable\">-c</span> test.c <span class=\"token parameter variable\">-o</span> test.bc</pre></td></tr></table></figure><p>如果需要其他编译参数可以直接附加，只要保证有  <code>-emit-llvm -S</code>  参数即可生成 <code>IR/Bicode</code>  文件，例如：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>clang -emit-llvm <span class=\"token parameter variable\">-S</span> <span class=\"token parameter variable\">-g</span> <span class=\"token parameter variable\">-O3</span> -funroll-loops test.c <span class=\"token parameter variable\">-o</span> test.ll</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>clang -emit-llvm <span class=\"token parameter variable\">-c</span> <span class=\"token parameter variable\">-g</span> <span class=\"token parameter variable\">-O3</span> -funroll-loops test.c <span class=\"token parameter variable\">-o</span> test.bc</pre></td></tr></table></figure><h3 id=\"cpp-to-irbitcode\"><a class=\"anchor\" href=\"#cpp-to-irbitcode\">#</a> CPP to IR/Bitcode</h3>\n<p>由  <code>test.cpp</code>  生成  <code>IR</code>  文件</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>clang++ -emit-llvm <span class=\"token parameter variable\">-S</span> test.cpp <span class=\"token parameter variable\">-o</span> test.ll</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>clang++ -emit-llvm <span class=\"token parameter variable\">-c</span> test.cpp <span class=\"token parameter variable\">-o</span> test.bc</pre></td></tr></table></figure><h3 id=\"ccpp-to-execute\"><a class=\"anchor\" href=\"#ccpp-to-execute\">#</a> C/CPP to execute</h3>\n<p>使用方法与 <code>gcc</code>  类似</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>clang test.c <span class=\"token parameter variable\">-o</span> <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>clang++ test.cpp <span class=\"token parameter variable\">-o</span> <span class=\"token builtin class-name\">test</span></pre></td></tr></table></figure><h3 id=\"ir-to-bitcode\"><a class=\"anchor\" href=\"#ir-to-bitcode\">#</a> IR to Bitcode</h3>\n<p>对于 LLVM 来说， <code>.ll</code>  格式是给 “人” 看的格式， <code>.bc</code>  是给 “机器” 看的格式，将 “人” 看的代码转成 “机器码”，就类似于汇编的过程，所以用 <code>llvm-as</code>  命令。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>llvm-as test.ll <span class=\"token parameter variable\">-o</span> test.bc</pre></td></tr></table></figure><h3 id=\"bitcode-to-ir\"><a class=\"anchor\" href=\"#bitcode-to-ir\">#</a> Bitcode to IR</h3>\n<p>同理，将 <code>.bc</code>  格式转换为 <code>.ll</code>  格式的过程就类似于反汇编的过程，所以用 <code>llvm-dis</code>  命令。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>llvm-dis test.bc <span class=\"token parameter variable\">-o</span> test.bc.ll</pre></td></tr></table></figure><h3 id=\"irbicode-to-asm\"><a class=\"anchor\" href=\"#irbicode-to-asm\">#</a> IR/Bicode to asm</h3>\n<p>生成目标平台的汇编代码，输入文件可以是  <code>.bc</code>  类型的，也可以是  <code>.ll</code>  类型的。</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>llc test.bc <span class=\"token parameter variable\">-o</span> test.bc.s</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>llc test.ll <span class=\"token parameter variable\">-o</span> test.ll.s</pre></td></tr></table></figure><h3 id=\"irbicode-to-execute\"><a class=\"anchor\" href=\"#irbicode-to-execute\">#</a> IR/Bicode to execute</h3>\n<p>IR 和 Bitcode 格式都能直接运行</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>lli test.ll</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lli test.bc</pre></td></tr></table></figure><h2 id=\"基本ir语法\"><a class=\"anchor\" href=\"#基本ir语法\">#</a> 基本 IR 语法</h2>\n<h3 id=\"ir结构\"><a class=\"anchor\" href=\"#ir结构\">#</a> IR 结构</h3>\n<details class=\"primary\"><summary>LLVM IR的结构（可先往下看，自己总结）</summary><div>\n<ol>\n<li>模块（Module）：LLVM IR 的最顶层结构是模块，表示整个程序或库。一个模块由一组全局变量和函数组成。</li>\n<li>全局变量（Global Variables）：LLVM IR 允许声明全局变量，它们是在整个程序中可见的。全局变量由其类型、名称和可选的初始值组成。全局变量的声明以 <code>@</code> 符号开头，后面跟着变量名称和类型信息。例如， <code>@myGlobal = global i32 0</code>  表示一个名为 <code>myGlobal</code>  的 32 位整数全局变量，初始值为 0。</li>\n<li>函数（Functions）：LLVM IR 中的函数由函数类型、名称、参数列表和函数体组成。函数类型包括返回类型和参数类型。函数的声明以 <code>define</code>  关键字开头，后面是返回类型、函数名称、参数列表和函数体。函数体由基本块（Basic Block）组成，每个基本块由一组指令组成。函数体的最后一条指令通常是返回指令。</li>\n<li>基本块（Basic Blocks）：基本块是 LLVM IR 中的基本执行单元。它由一系列按顺序执行的指令组成，没有分支或跳转指令。基本块以标签（Label）开头，后面是一组指令。基本块可以包含控制流指令，如条件分支和无条件跳转，以便实现程序的控制流程。</li>\n<li>指令（Instructions）：LLVM IR 包括各种指令来表示程序的操作。指令由操作码和操作数组成，用于执行特定的操作。LLVM IR 支持常见的指令类型，如赋值指令、算术运算指令、逻辑运算指令、条件分支指令、内存访问指令等。指令可以使用变量、常量和表达式作为操作数。</li>\n</ol>\n</div></details>\n<p>首先来看看 IR 长什么样子</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_GNU_SOURCE</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello World!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>使用 <code>clang -emit-llvm -S main.c -o main.ll</code>  将上述代码编译成 IR 的 <code>.ll</code>  格式：</p>\n<figure class=\"highlight llvm\"><figcaption data-lang=\"LLVM IR\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">; ModuleID = 'main.c'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">source_filename</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"main.c\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">target</span> <span class=\"token keyword\">datalayout</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">target</span> <span class=\"token keyword\">triple</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"x86_64-apple-macosx14.0.0\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token variable\">@.str</span> <span class=\"token punctuation\">=</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">unnamed_addr</span> <span class=\"token keyword\">constant</span> <span class=\"token punctuation\">[</span><span class=\"token number\">14</span> <span class=\"token keyword\">x</span> <span class=\"token type class-name\">i8</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">c</span><span class=\"token string\">\"Hello World!\\0A\\00\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">align</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">; Function Attrs: noinline nounwind optnone ssp uwtable</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">define</span> <span class=\"token keyword\">dso_local</span> <span class=\"token type class-name\">i32</span> <span class=\"token variable\">@main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">#0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token variable\">%1</span> <span class=\"token punctuation\">=</span> <span class=\"token keyword\">alloca</span> <span class=\"token type class-name\">i32</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">align</span> <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">store</span> <span class=\"token type class-name\">i32</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token type class-name\">i32</span><span class=\"token punctuation\">*</span> <span class=\"token variable\">%1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">align</span> <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token variable\">%2</span> <span class=\"token punctuation\">=</span> <span class=\"token keyword\">call</span> <span class=\"token type class-name\">i32</span> <span class=\"token punctuation\">(</span><span class=\"token type class-name\">i8</span><span class=\"token punctuation\">*</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">@printf</span><span class=\"token punctuation\">(</span><span class=\"token type class-name\">i8</span><span class=\"token punctuation\">*</span> <span class=\"token keyword\">getelementptr</span> <span class=\"token keyword\">inbounds</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">14</span> <span class=\"token keyword\">x</span> <span class=\"token type class-name\">i8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">14</span> <span class=\"token keyword\">x</span> <span class=\"token type class-name\">i8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">*</span> <span class=\"token variable\">@.str</span><span class=\"token punctuation\">,</span> <span class=\"token type class-name\">i64</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token type class-name\">i64</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">ret</span> <span class=\"token type class-name\">i32</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">declare</span> <span class=\"token type class-name\">i32</span> <span class=\"token variable\">@printf</span><span class=\"token punctuation\">(</span><span class=\"token type class-name\">i8</span><span class=\"token punctuation\">*</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">#1</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">attributes</span> <span class=\"token variable\">#0</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">noinline</span> <span class=\"token keyword\">nounwind</span> <span class=\"token keyword\">optnone</span> <span class=\"token keyword\">ssp</span> <span class=\"token keyword\">uwtable</span> <span class=\"token string\">\"disable-tail-calls\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"frame-pointer\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"all\"</span> <span class=\"token string\">\"less-precise-fpmad\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"min-legal-vector-width\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token string\">\"no-infs-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-jump-tables\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-nans-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-signed-zeros-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-trapping-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token string\">\"stack-protector-buffer-size\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"8\"</span> <span class=\"token string\">\"target-cpu\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"penryn\"</span> <span class=\"token string\">\"target-features\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\"</span> <span class=\"token string\">\"tune-cpu\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"generic\"</span> <span class=\"token string\">\"unsafe-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"use-soft-float\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">attributes</span> <span class=\"token variable\">#1</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"disable-tail-calls\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"frame-pointer\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"all\"</span> <span class=\"token string\">\"less-precise-fpmad\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-infs-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-nans-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-signed-zeros-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-trapping-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token string\">\"stack-protector-buffer-size\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"8\"</span> <span class=\"token string\">\"target-cpu\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"penryn\"</span> <span class=\"token string\">\"target-features\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\"</span> <span class=\"token string\">\"tune-cpu\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"generic\"</span> <span class=\"token string\">\"unsafe-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"use-soft-float\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token variable\">!llvm.module.flags</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">!</span><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">!0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">!1</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token variable\">!llvm.ident</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">!</span><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">!2</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token variable\">!0</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">!</span><span class=\"token punctuation\">&#123;</span><span class=\"token type class-name\">i32</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">!</span><span class=\"token string\">\"wchar_size\"</span><span class=\"token punctuation\">,</span> <span class=\"token type class-name\">i32</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token variable\">!1</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">!</span><span class=\"token punctuation\">&#123;</span><span class=\"token type class-name\">i32</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">!</span><span class=\"token string\">\"PIC Level\"</span><span class=\"token punctuation\">,</span> <span class=\"token type class-name\">i32</span> <span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token variable\">!2</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">!</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">!</span><span class=\"token string\">\"Homebrew clang version 12.0.1\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>虽然只是一个简单的 <code>Hello world</code>  程序，但是也基本包含了 IR 文件的各个部分。“麻雀虽小，五脏俱全”，让我们从上往下依次来看：</p>\n<p><strong>第一部分（1～4 行）</strong></p>\n<ul>\n<li>\n<p><code>source_filename</code> ：描述了源文件的名称及其所在路径。</p>\n</li>\n<li>\n<p><code>target datalayout</code> ：描述了目标机器中数据的内存布局方式，包括：字节序、类型大小以及对齐方式「<span class=\"exturl\" data-url=\"aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xhbmdSZWYuaHRtbCNkYXRhLWxheW91dA==\">具体说明</span>」。</p>\n</li>\n<li>\n<p><code>target triple</code> ：描述了目标机器是什么，从而指示后端生成相应的目标代码。</p>\n</li>\n</ul>\n<p><strong>第二部分（6～19 行）</strong></p>\n<ul>\n<li>\n<p>标识符</p>\n<p>LLVM IR 中的标识符分为：全局标识符和局部标识符。全局标识符以 <code>@</code> 开头，比如：全局函数、全局变量。局部标识符以 <code>%</code>  开头，类似于汇编语言中的寄存器。</p>\n<p>标识符有如下 3 种形式：</p>\n<ul>\n<li>有名称的值（Named Value），表示为带有前缀（ <code>@</code> 或 <code>%</code> ）的字符串。比如：% val、@name。</li>\n<li>无名称的值（Unnamed Value），表示为带前缀（ <code>@</code> 或 <code>%</code> ）的无符号数值。比如：%0、%1、@2。</li>\n<li>常量。</li>\n</ul>\n</li>\n<li>\n<p><code>define</code> ：用于定义一个函数</p>\n<ul>\n<li>\n<p><code>define dso_local i32 @main() #0 &#123; ... &#125;</code> ，表示定义一个函数。其函数名称为 <code>main</code> ，返回值的数据类型为 <code>i32</code> （占用 4 字节的整型），没有参数。</p>\n</li>\n<li>\n<p><code>#0</code> ，用于修饰函数时表示一组函数属性「<span class=\"exturl\" data-url=\"aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xhbmdSZWYuaHRtbCNmdW5jdGlvbi1hdHRyaWJ1dGVz\">具体说明</span>」。这些属性定义在文件末尾。如下：</p>\n<figure class=\"highlight llvm\"><figcaption data-lang=\"LLVM IR\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">attributes</span> <span class=\"token variable\">#0</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">noinline</span> <span class=\"token keyword\">nounwind</span> <span class=\"token keyword\">optnone</span> <span class=\"token keyword\">ssp</span> <span class=\"token keyword\">uwtable</span> <span class=\"token string\">\"disable-tail-calls\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"frame-pointer\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"all\"</span> <span class=\"token string\">\"less-precise-fpmad\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"min-legal-vector-width\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token string\">\"no-infs-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-jump-tables\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-nans-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-signed-zeros-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"no-trapping-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token string\">\"stack-protector-buffer-size\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"8\"</span> <span class=\"token string\">\"target-cpu\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"penryn\"</span> <span class=\"token string\">\"target-features\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\"</span> <span class=\"token string\">\"tune-cpu\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"generic\"</span> <span class=\"token string\">\"unsafe-fp-math\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token string\">\"use-soft-float\"</span><span class=\"token punctuation\">=</span><span class=\"token string\">\"false\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p>LLVM IR 中，函数体是由<strong>基本块</strong>（Basic Blocks）构成的。基本块是由一系列顺序执行的语句构成的，并（可选地）以标签作为起始。不同的标签代表不同的基本块。</p>\n<p>基本块的特点如下：</p>\n<ul>\n<li>仅有一个入口，即基本块中的第一条指令。</li>\n<li>仅有一个出口，即基本块中的最后一条指令（被称为 <code>terminator instruction</code> ）。该指令要么跳转到其他基本块（不包括入口基本块），要么从函数返回。</li>\n<li>函数体中第一个出现的基本块，称为入口基本块（Entry Basic Block）。它是一个特殊的基本块，在进入函数时立即执行该基本块，并且不允许作为其他基本块的跳转目标（即不允许该基本块有前继节点）。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p><strong>第三部分（21～26 行）</strong></p>\n<ul>\n<li>\n<p><code>llvm.module.flags</code> ：命名元数据（Named Metadata）之一，用于描述模块级别的信息。</p>\n<p><code>llvm.module.flags</code>  是一个包含一系列元数据节点的集合。集合中的每个元数据节点都是一个形如 <code>&#123;&lt;behavior&gt;, &lt;key&gt;, &lt;value&gt;&#125;</code>  的三元组。其中， <code>&lt;behavior&gt;</code>  用于指定来自不同模块的 <code>&lt;key&gt;</code>  和 <code>&lt;value&gt;</code>  都相同的元数据合并时如何处理， <code>&lt;key&gt;</code>  表示元数据在本模块中的唯一标识符（仅在本模块内唯一，来自不同模块的元数据可能有相同的标识符）， <code>&lt;value&gt;</code>  表示元数据所携带信息的值。</p>\n<p>常见的 <code>&lt;behavior&gt;</code>  值为「1」，表示「如果两个值不一致，则发出错误，否则生成的值就是操作数的值」。</p>\n<figure class=\"highlight llvm\"><figcaption data-lang=\"LLVM IR\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">!llvm.module.flags</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">!</span><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">!0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">!1</span><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">; 指定了两个元数据！0 和！1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token variable\">!0</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">!</span><span class=\"token punctuation\">&#123;</span><span class=\"token type class-name\">i32</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">!</span><span class=\"token string\">\"wchar_size\"</span><span class=\"token punctuation\">,</span> <span class=\"token type class-name\">i32</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">; 表示标识符为 \"wchar_size\" 的元数据所携带信息的值在所有模块中都应该是 4，否则会报错</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token variable\">!1</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">!</span><span class=\"token punctuation\">&#123;</span><span class=\"token type class-name\">i32</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">!</span><span class=\"token string\">\"PIC Level\"</span><span class=\"token punctuation\">,</span> <span class=\"token type class-name\">i32</span> <span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">; 同理</span></pre></td></tr></table></figure></li>\n<li>\n<p><code>llvm.ident</code> ：用于表示 Clang 的版本信息。</p>\n</li>\n</ul>\n<h3 id=\"ir-指令\"><a class=\"anchor\" href=\"#ir-指令\">#</a> IR 指令</h3>\n<p>在 LLVM 的 IR 中，所有的数据类型都是基于 LLVM 类型系统定义的，这些数据类型包括整数、浮点数、指针、数组、结构体等等，每个数据类型都具有自己的属性，例如位宽、对齐方式等等。在 IR 中，每个值都有一个类型，这个类型可以被显式地指定，或者通过指令的操作数推导出来。</p>\n<p>LLVM 的 IR 指令非常丰富，包括算术、逻辑、比较、转换、控制流等等，它们可以被用来表达复杂的程序结构，同时 IR 指令还可以通过 LLVM 的优化器进行优化，以生成高效的目标代码。</p>\n<p>IR 指令类型比较多，以下是一些常见的指令类型：</p>\n<ol>\n<li>加减乘除指令：add, sub, mul, sdiv, udiv, fadd, fsub, fmul, fdiv 等</li>\n<li>位运算指令：and, or, xor, shl, lshr, ashr 等</li>\n<li>转换指令：trunc, zext, sext, fptrunc, fpext, fptoui, fptosi, uitofp, sitofp, ptrtoint, inttoptr, bitcast 等</li>\n<li>内存指令：alloca, load, store, getelementptr 等</li>\n<li>控制流指令：br, switch, ret, indirectbr, invoke, resume, unreachable 等</li>\n<li>其他指令：phi, select, call, va_arg, landingpad 等</li>\n</ol>\n<p>指令相关内容资料丰富，不再具体赘述了，可以参考：</p>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC83MjAyOTc2MTY3NTE1MDQ1OTQ2\">LLVM 的 IR 指令详解</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xhbmdSZWYuaHRtbA==\">LLVM 官方手册</span></li>\n</ul>\n<h1 id=\"llvm-c-api相关操作\"><a class=\"anchor\" href=\"#llvm-c-api相关操作\">#</a> LLVM C++ API 相关操作</h1>\n<div class=\"note primary no-icon\">\n<ul>\n<li>\n<p>本章使用的 C++ API 对应 <code>LLVM 17.0.6_1</code> ，同大版本下 API 基本不会发生太大变化，而如果是不同大版本，部分 API 的定义可能不同，需要自行查看 API 手册。</p>\n</li>\n<li>\n<p>查看 LLVM 版本： <code>llvm-config --version</code></p>\n</li>\n<li>\n<p>API 手册：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xhbmdSZWYuaHRtbA==\">https://llvm.org/docs/LangRef.html</span></p>\n</li>\n<li>\n<p>⚠️ 为了方便书写，给出的代码大多是片段的形式。在默认情况下，本章节代码具有连续性，即若代码片段中某个变量未定义但直接使用，可以往前找找看。</p>\n</li>\n</ul>\n</div>\n<h2 id=\"读写ir文件\"><a class=\"anchor\" href=\"#读写ir文件\">#</a> 读 / 写 IR 文件</h2>\n<p>读写 IR 文件是分析的基础，通过读入 IR 文件并进行解析，可以向源程序中插入我们自定义的操作，然后将更改后的 IR 写回文件，将结果保存下来。假设需要读入一个 <code>main.ll</code>  的 IR 文件并对其进行操作，操作完成后将 IR 保存成 <code>.bc</code>  的格式。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/LLVMContext.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/Module.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/IRBuilder.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/Instructions.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/Support/SourceMgr.h></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IRReader/IRReader.h></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/BasicBlock.h></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/Transforms/Utils/BasicBlockUtils.h></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"llvm/Support/raw_ostream.h\"</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"llvm/Bitcode/BitcodeWriter.h\"</span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> llvm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    LLVMContext ctx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    SMDiagnostic err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  \t<span class=\"token comment\">// 读入指定 IR 文件并解析，获取 LLVMContext</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>Module<span class=\"token operator\">></span> mod_ptr <span class=\"token operator\">=</span> <span class=\"token function\">parseIRFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main.ll\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mod_ptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Failed to read IR File\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    Module <span class=\"token operator\">*</span>mod <span class=\"token operator\">=</span> mod_ptr<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// 分析操作</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  \t<span class=\"token comment\">// 保存成文件</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>error_code EC<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    llvm<span class=\"token double-colon punctuation\">::</span>raw_fd_ostream <span class=\"token function\">OS</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main.bc\"</span><span class=\"token punctuation\">,</span> EC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>EC<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"failed to open output file\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    llvm<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">WriteBitcodeToFile</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>mod_ptr<span class=\"token punctuation\">,</span> OS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li>\n<p>保存成 <code>.ll</code>  格式：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>error_code EC<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>llvm<span class=\"token double-colon punctuation\">::</span>raw_fd_ostream <span class=\"token function\">OS</span><span class=\"token punctuation\">(</span>source_ll<span class=\"token punctuation\">,</span> EC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>EC<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"failed to open output file\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>mod<span class=\"token operator\">-></span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>OS<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure></li>\n<li>\n<p>在终端直接输出 <code>.ll</code>  格式</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mod<span class=\"token operator\">-></span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token function\">outs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"遍历ir文件\"><a class=\"anchor\" href=\"#遍历ir文件\">#</a> 遍历 IR 文件</h2>\n<p>这里给出遍历所有指令的代码</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/LLVMContext.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/Module.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/IRBuilder.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/Instructions.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/Support/SourceMgr.h></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IRReader/IRReader.h></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/BasicBlock.h></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/Transforms/Utils/BasicBlockUtils.h></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"llvm/Support/raw_ostream.h\"</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"llvm/Bitcode/BitcodeWriter.h\"</span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> llvm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    LLVMContext ctx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    SMDiagnostic err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>Module<span class=\"token operator\">></span> mod_ptr <span class=\"token operator\">=</span> <span class=\"token function\">parseIRFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main.ll\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mod_ptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Failed to read IR File\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    Module <span class=\"token operator\">*</span>mod <span class=\"token operator\">=</span> mod_ptr<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  \t<span class=\"token comment\">// 依次遍历 * 函数 *</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Function <span class=\"token operator\">&amp;</span>F <span class=\"token operator\">:</span> <span class=\"token operator\">*</span>mod<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      \t<span class=\"token comment\">// 依次遍历 * 基本块 *</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>BasicBlock <span class=\"token operator\">&amp;</span>BB <span class=\"token operator\">:</span> F<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          \t<span class=\"token comment\">// 依次遍历 * 指令 *</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Instruction <span class=\"token operator\">&amp;</span>I <span class=\"token operator\">:</span> BB<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token comment\">// 对指令进行操作</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\tmod<span class=\"token operator\">-></span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token function\">outs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><details class=\"info\"><summary>范围for「C++ 11引入」</summary><div>\n<p>C++ 11 中引入了<span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL3poLWNuL2NwcC9zdGFuZGFyZC1saWJyYXJ5L2l0ZXJhdG9yP3ZpZXc9bXN2Yy0xNzA=\">迭代器对象</span>，可通过使用成员和全局函数（如  <code>begin()</code>  和  <code>end()</code> ）以及运算符（如  <code>++</code>  和  <code>--</code> ）向前或向后移动，来显式使用迭代器。也可以通过范围 for 循环来隐式使用迭代器。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* 显示使用迭代器 */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 定义一个迭代器</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> vec<span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> it <span class=\"token operator\">=</span> <span class=\"token function\">begin</span><span class=\"token punctuation\">(</span>vec<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> it <span class=\"token operator\">!=</span> <span class=\"token function\">end</span><span class=\"token punctuation\">(</span>vec<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> it<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// Access element using dereference operator</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>it <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>上述代码等价于</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 推荐使用 auto 来自动获取类型</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> num <span class=\"token operator\">:</span> vec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// no dereference operator</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    cout <span class=\"token operator\">&lt;&lt;</span> num <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></div></details>\n<h2 id=\"创建函数基本块指令\"><a class=\"anchor\" href=\"#创建函数基本块指令\">#</a> 创建函数 / 基本块 / 指令</h2>\n<p>在创建函数 / 基本块 / 指令时需要先获取当前的上下文，并设置好 “插入点”，创建的基本块 / 指令会插入到 “插入点” 指定的位置。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/LLVMContext.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/Module.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/IRBuilder.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/Instructions.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/Support/SourceMgr.h></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IRReader/IRReader.h></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/IR/BasicBlock.h></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;llvm/Transforms/Utils/BasicBlockUtils.h></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"llvm/Support/raw_ostream.h\"</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"llvm/Bitcode/BitcodeWriter.h\"</span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> llvm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    LLVMContext ctx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    SMDiagnostic err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>Module<span class=\"token operator\">></span> mod_ptr <span class=\"token operator\">=</span> <span class=\"token function\">parseIRFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main.ll\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mod_ptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Failed to read IR File\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    Module <span class=\"token operator\">*</span>mod <span class=\"token operator\">=</span> mod_ptr<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    IRBuilder<span class=\"token operator\">&lt;</span><span class=\"token operator\">></span> <span class=\"token function\">builder</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  \t<span class=\"token comment\">// 先声明函数结构：这里声明了一个返回值为 double，参数为一个 double 类型的函数；false 表明该函数参数个数不可变</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    FunctionType <span class=\"token operator\">*</span>funcType <span class=\"token operator\">=</span> <span class=\"token class-name\">FunctionType</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Type</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDoubleTy</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span><span class=\"token class-name\">Type</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDoubleTy</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">// 创建一个函数，将函数命名为 check</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    Function <span class=\"token operator\">*</span>checkFunc <span class=\"token operator\">=</span> <span class=\"token class-name\">Function</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>funcType<span class=\"token punctuation\">,</span> Function<span class=\"token double-colon punctuation\">::</span>ExternalLinkage<span class=\"token punctuation\">,</span> <span class=\"token string\">\"check\"</span><span class=\"token punctuation\">,</span> mod<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">// 存储参数（获取参数的引用）</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    Function<span class=\"token double-colon punctuation\">::</span>arg_iterator argsIT <span class=\"token operator\">=</span> checkFunc<span class=\"token operator\">-></span><span class=\"token function\">arg_begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//Function 中的一个方法，获取参数的迭代器</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    Value <span class=\"token operator\">*</span>arg_n <span class=\"token operator\">=</span> argsIT<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 获取第一个参数</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  \t<span class=\"token comment\">// 在 \"check\" 函数中创建一个基本块</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    BasicBlock <span class=\"token operator\">*</span>entryBlock <span class=\"token operator\">=</span> <span class=\"token class-name\">BasicBlock</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> checkFunc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    builder<span class=\"token punctuation\">.</span><span class=\"token function\">SetInsertPoint</span><span class=\"token punctuation\">(</span>entryBlock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 设置插入点为上一行创建的基本块</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    Value <span class=\"token operator\">*</span>fRemResult <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">CreateFRem</span><span class=\"token punctuation\">(</span>arg_n<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ConstantFP</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token function\">APFloat</span><span class=\"token punctuation\">(</span><span class=\"token number\">100.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 创建 \"FRem\" 指令</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    builder<span class=\"token punctuation\">.</span><span class=\"token function\">CreateRet</span><span class=\"token punctuation\">(</span>fRemResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 创建 \"ret\" 指令， 返回值为 \"FRem\" 的结果</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Function <span class=\"token operator\">&amp;</span>F <span class=\"token operator\">:</span> <span class=\"token operator\">*</span>mod<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>BasicBlock <span class=\"token operator\">&amp;</span>BB <span class=\"token operator\">:</span> F<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Instruction <span class=\"token operator\">&amp;</span>I <span class=\"token operator\">:</span> BB<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    mod<span class=\"token operator\">-></span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token function\">outs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"创建跳转\"><a class=\"anchor\" href=\"#创建跳转\">#</a> 创建跳转</h2>\n<ol>\n<li>\n<p>通过函数调用进行跳转</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// BO 是 FAdd 指令指针，同时也是该指令的返回值</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">auto</span> <span class=\"token operator\">*</span>BO <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">dyn_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>BinaryOperator<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>I<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>BO<span class=\"token operator\">-></span><span class=\"token function\">getOpcode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> Instruction<span class=\"token double-colon punctuation\">::</span>FAdd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// 设置插入点为 BO 指令的下一条</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   builder<span class=\"token punctuation\">.</span><span class=\"token function\">SetInsertPoint</span><span class=\"token punctuation\">(</span>BO<span class=\"token operator\">-></span><span class=\"token function\">getNextNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// 创建 call 指令，call checkFunc 函数，参数为 BO</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   Value <span class=\"token operator\">*</span>checkResult <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">CreateCall</span><span class=\"token punctuation\">(</span>checkFunc<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>BO<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p>通过函数返回进行跳转</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 函数原型：ReturnInst *CreateRet (Value *RetVal, Instruction *InsertBefore = nullptr);</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 接受一个返回值 RetVal，将其作为函数的返回值返回。可选的 InsertBefore 参数允许指定插入该指令的位置，默认为 nullptr，表示在当前插入点处插入。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>builder<span class=\"token punctuation\">.</span><span class=\"token function\">CreateRet</span><span class=\"token punctuation\">(</span>fRemResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure></li>\n<li>\n<p>无条件跳转</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 在当前基本块的末尾创建一个无条件跳转指令，使控制流转移到 DestBB 指定的基本块</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>builder<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBr</span><span class=\"token punctuation\">(</span>DestBB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure></li>\n<li>\n<p>条件跳转</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 创建比较指令，比较 sum 和 100.0 的大小</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Value <span class=\"token operator\">*</span>cmp <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">CreateFCmpUGT</span><span class=\"token punctuation\">(</span>sum<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ConstantFP</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token function\">APFloat</span><span class=\"token punctuation\">(</span><span class=\"token number\">100.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 创建条件跳转，完整定义如下：</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// BranchInst *CreateCondBr(Value *Cond, BasicBlock *TrueBB, BasicBlock *FalseBB, Instruction *InsertBefore = nullptr);</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>builder<span class=\"token punctuation\">.</span><span class=\"token function\">CreateCondBr</span><span class=\"token punctuation\">(</span>cmp<span class=\"token punctuation\">,</span> TrueBB<span class=\"token punctuation\">,</span> FalseBB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"获取更改参数\"><a class=\"anchor\" href=\"#获取更改参数\">#</a> 获取 / 更改参数</h2>\n<p>加入我想通过 LLVM C++ API 获取一个 IR 指令的参数以便后续分析、或将其修改为指定值</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 创建一个加法指令</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Instruction <span class=\"token operator\">*</span>AddInst <span class=\"token operator\">=</span> <span class=\"token class-name\">BinaryOperator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">CreateAdd</span><span class=\"token punctuation\">(</span>Operand1<span class=\"token punctuation\">,</span> Operand2<span class=\"token punctuation\">,</span> <span class=\"token string\">\"sum\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Value <span class=\"token operator\">*</span>NewValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 定义一个新的操作数值 NewValue</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 函数原型：void Instruction::setOperand (unsigned index, Value *val);</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">//index 表示要设置的操作数的索引，从 0 开始，表示指令的第一个操作数；</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">//val 表示要设置的新的操作数值，类型为 Value，可以是常量、变量或其他指令的结果</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>AddInst<span class=\"token operator\">-></span><span class=\"token function\">setOperand</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> NewValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 将 Add 指令的第一个参数修改为 NewValue</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 获取第一个操作数 Operand1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// 注意：AddInst 同时也是一个 Value * 类型，表示 add 的计算结果</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>AddInst<span class=\"token operator\">-></span><span class=\"token function\">getOperand</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ldmlhbi16aGFuZy5naXRodWIuaW8vbGx2bS1pci10dXRvcmlhbC9pbmRleC5odG1s\">https://evian-zhang.github.io/llvm-ir-tutorial/index.html</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0xhbmdSZWYuaHRtbA==\">https://llvm.org/docs/LangRef.html</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sbHZtLm9yZy9kb2NzL0NvZGluZ1N0YW5kYXJkcy5odG1s\">https://llvm.org/docs/CodingStandards.html</span></li>\n</ul>\n",
            "tags": [
                "LLVM",
                "LLVM",
                "教程"
            ]
        },
        {
            "id": "https://gality.cn/ml/transformer/",
            "url": "https://gality.cn/ml/transformer/",
            "title": "Transformer 详解",
            "date_published": "2024-02-23T07:13:11.000Z",
            "content_html": "<div class=\"note primary no-icon\">\n<p>Transformer 是一种采用了 “自注意力机制” 的模型，主要应用于自然语言处理（NLP）和计算机（CV）视觉领域。Transformer 采用 “encoder+decoder” 的架构，输入和输出都可以是不定长的序列（seq2seq）。通过注意力机制，transformer 可以学习到输入序列中的上下文信息，从而表现出更强的学习能力。</p>\n<p><strong>Key words：seq2seq、Encoder、Decoder、Multi-headed Attention、Positional Encoding、Input Embedding</strong></p>\n</div>\n<h1 id=\"transformer-架构\"><a class=\"anchor\" href=\"#transformer-架构\">#</a> Transformer 架构</h1>\n<div class=\"note info no-icon\">\n<p>为了方便解释，下文都以<strong>文本翻译</strong>为例来解释 transformer。在这个例子中，transformer 的输入是一段英文，输出是一段不定长度的中文。</p>\n</div>\n<p>原始的 Transformer 采用<strong>编码器 - 解码器</strong>（Encoder–Decoder）架构，Encoder 和 Decoder 又由多层小 encoder 和 decoder 组成。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/767krk.jpg\" alt=\"Transformer架构\" height=\"300\" /></p>\n<h2 id=\"评估过程\"><a class=\"anchor\" href=\"#评估过程\">#</a> 评估过程</h2>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/64apze.jpg\" alt=\"评估过程\" height=\"370\" /></p>\n<p>原始输入信息在进入 Encoder 之后，首先需要进行<strong>词嵌入</strong>和<strong>位置信息编码</strong>转换为一组向量，然后将该组向量向量经过<strong>多层</strong>的抽取会被映射为一组<strong>抽象的连续表示</strong>，其中包含了原始输入的所有可学习信息（可以理解为一种总结概括，保留输入中对机器有用的信息，然后输出成一种机器能看懂的形式），然后将该组表示输入到 Decoder 中。每层小 decoder 利用输入的那些表示来生成输出信息，注意，小 decoder 生成的信息同样也会被输入到其他小 decoder 中参与后续的输出，即每一次小 decoder 的输入是<strong>其他小 decoder 之前的输出</strong>和<strong> Encoder 的输出</strong>。</p>\n<h2 id=\"训练过程\"><a class=\"anchor\" href=\"#训练过程\">#</a> 训练过程</h2>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/ew35a6.jpg\" alt=\"训练过程\" height=\"600\" /></p>\n<p>相比于评估阶段，在 transformer 的训练阶段，Decoder 的输入有所不同。在训练时，Decoder 的输入是<strong> Encoder 的输出</strong>和<strong>正确答案</strong>，目的是让 Decoder 能根据正确的答案计算交叉熵，这样才能进行参数更新。关于这部分的细节，我会在后文中详细讲解。</p>\n<h1 id=\"transormer-细节\"><a class=\"anchor\" href=\"#transormer-细节\">#</a> Transormer 细节</h1>\n<h2 id=\"词嵌入\"><a class=\"anchor\" href=\"#词嵌入\">#</a> 词嵌入</h2>\n<div class=\"note info no-icon\">\n<p>transformer 的输入通常是一段序列（可能是文本、像素等离散值），这些序列都是<strong>非结构化</strong>的数据，不可以被直接用于计算。因此，需要一种规则来将这些非结构化的数据转换成结构化的数据（向量、tensor 等），这个过程称为<strong>表示（Representation）</strong>。表示的好坏会直接影响机器学习结果，所以需要探索一种好的表示。而 ** 词嵌入（word embedding）** 就是一种比较好的表示方法，用于将单词转换成（嵌入到）向量。</p>\n</div>\n<blockquote>\n<p>一种最简单的表示方法是 <code>one-hot</code>  编码，这种编码方法会将每一个需要嵌入的单词转换成 <code>one-hot</code>  向量，例如，想表示三个单词：apple、orange、iphone，他的 <code>one-hot</code>  编码可以为：</p>\n<ul>\n<li>apple：[1, 0, 0]</li>\n<li>orange：[0, 1, 0]</li>\n<li>iphone：[0, 0, 1]</li>\n</ul>\n<p>这种一个向量中只有一个 <code>1</code> ，其余全是 <code>0</code>  向量称为 <code>one-hot</code>  向量，但这会带来两个问题：</p>\n<ol>\n<li>实际应用中往往需要表示几十万甚至百万个单词，用 <code>one-hot</code>  编码会形成一个几十万维的矩阵，且该矩阵极其稀疏，导致计算和存储的效率都非常低下。</li>\n<li>无法表达不同单词之间的关系。例如，直觉上，我们会认为 apple 和 orange 这两个单词语义更加相近（都是水果），而 iphone 和 orange 这两个词语义更远，但是， <code>one-hot</code>  编码无法体现出这层信息，对于 <code>one-hot</code>  编码来说，每一个词都是彼此独立的，不利于机器去理解词义。</li>\n</ol>\n</blockquote>\n<p>词嵌入也是一种表示方法，不过他解决了 <code>one-hot</code>  表示的问题，更加适用于大量单词的表示。</p>\n<p>词嵌入并不是某种特定的算法，而是一种表示方法的统称，指的是将一个单词嵌入到一个多维的<strong>特征矩阵</strong>中。为了方便理解词嵌入，我们首先引入 “特征” 的概念。以 apple 为例，它有一些特征，例如，属于水果、可以吃、圆的、甜的...。而每一个词都可以总结出来一些特征，只要我们总结出足够多的特征，就可以以特征为维度来表示单词，这种表示形成的矩阵就是特征矩阵。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/y7tfor.png\" alt=\"特征矩阵示意\" /></p>\n<p>上图就一个例子，例如我们总结出了 300 个特征，分别是 gender、royal、age、food...，用数值的大小来表示单词在该特征维度上的得分。那么 apple 和 orange 在 food 这一特征上就应该有比较大的数值，而在 gender、royal 等特征维度上数值很小，而 king 和 queen 这两个单词就应该在 royal 这个特征维度就应该有比较大的值。只要我们的特征选取的足够合适且丰富，就可以将任意单词 “嵌入” 到这个 300 维的特征矩阵中（用一组特征值来唯一对应某个单词，且能体现单词词意之间的关系），这就是词嵌入的原理。</p>\n<p>词嵌入有一个重要的特性，它可以帮助实现类比推理。例如在上面的例子中，通过不同向量之间的减法运算，可以发现不同词之间的类比关系，例如，man 和 woman 相减，可以发现这两个单词在 gender 维度上差别较大，而在其他维度上差别较小。这种特性非常有助于模型去发现词和词之间的关联，因此在 transformer 中 encoder 之前会先进行词嵌入来帮助模型学习。</p>\n<p>在实际情况中，通常是用机器学习去学习一组单词，生成一个特征矩阵，因此选取的特征可能并不能很简单的描述，同时，词嵌入的特征维度也根据任务的不同和不同，但是总的来说，都是基于上述原理来实现词嵌入的。</p>\n<h2 id=\"encoder-详解\"><a class=\"anchor\" href=\"#encoder-详解\">#</a> encoder 详解</h2>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MDY3MTExNjk=\">https://zhuanlan.zhihu.com/p/506711169</span></li>\n</ul>\n",
            "tags": [
                "机器学习",
                "机器学习",
                "tranformer"
            ]
        },
        {
            "id": "https://gality.cn/ml/CNN/",
            "url": "https://gality.cn/ml/CNN/",
            "title": "CNN ｜ Network Architecture Designed for Image",
            "date_published": "2024-02-05T03:12:37.000Z",
            "content_html": "<div class=\"note info no-icon\">\n<p>卷积神经网络（Convolutional Neural Network）是一种专为图像处理设计的神经网络结构。相比于全连接神经网络结构，卷积神经网络在面对图像相关任务时有突出的表现，这是因为这种特殊的网络结构的设计思路与图像本身的特征紧密相关，也正因为如此，如果想将 CNN 应用于其他模态任务中，应根据具体模态的特征对网络进行修改。「著名的 AlphaGo 就是基于 CNN 结构来进行学习的」</p>\n</div>\n<h1 id=\"问题引入\"><a class=\"anchor\" href=\"#问题引入\">#</a> 问题引入</h1>\n<p>假设我们希望用机器学习来实现一个图片分类任务，模型的输入是一张图片，模型的输出是其所属的分类。以一个 <code>100x100</code>  像素的图片为例（作为对比，我们常说的 4K 分辨率指 <code>3840x2160</code>  像素）。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/vldzu5.jpg\" alt=\"图片处理\" height=\"350\" /></p>\n<p>图片可以看作是一个 3 维的 tensor，三个维度分别为：长、宽、通道。对于彩色图片来说，有三个通道，对应着<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNjc4MjMzMTk=\"> RGB 三种颜色</span>（计算机存储图片的原理）。由于神经网络的输入只能是一个向量（2 维），所以为了让神经网络能读取一个图片，我们需要先将三维 tensor “平坦化”，将三维的 tensor 按通道维度排列成 2 维的向量，在这个例子中，向量的大小为 <code>300x100</code> 。</p>\n<p>我们先考虑用一个全连接神经网络来处理这个图片，假设第一层有 1000 个神经元，任意一个输入到任意一个神经元之间都应存在一个 “权重”。此时，第一层将有 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>100</mn><mo>×</mo><mn>300</mn><mo>×</mo><mn>1000</mn><mo>=</mo><mn>1</mn><msup><mn>0</mn><mn>7</mn></msup></mrow><annotation encoding=\"application/x-tex\">100 \\times 300 \\times 1000 = 10^7</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">3</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">7</span></span></span></span></span></span></span></span></span></span></span> 个 “权重”，这还是在不考虑 “偏置”，不考虑 “多层” 网络的情况下。</p>\n<p><span class=\"red\">事实上，想要更新如此海量的参数，对算力要求实在太过庞大，根本就 “train” 不起来。</span></p>\n<h1 id=\"简化基于局部特征来简化网络结构\"><a class=\"anchor\" href=\"#简化基于局部特征来简化网络结构\">#</a> 简化：基于局部特征来简化网络结构</h1>\n<p>人类在识别图片时，图片中的大部分的内容其实是无用的，人类其实是通过一些<strong>局部特征</strong>来识别物体的，例如下面的图片，第一眼看上去非常像一只乌鸦，因为我们首先看到了 “喙”，结合 “黑色” 的特征，我们很容易联想到乌鸦。但是再往下看，当我们看到了 “尾巴” 这个特征后，我们会反应过来，原来这是一个猫。但是无论我们怎么识别这个动物，周围的黄色地板别没有为我们提供任何有效信息，把它们去掉也并不影响我们识别出这个动物。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/fih9ra.png\" alt=\"“乌鸦”猫猫\" height=\"210\" /></p>\n<h2 id=\"让模型只关注局部细节\"><a class=\"anchor\" href=\"#让模型只关注局部细节\">#</a> 让模型只关注局部细节</h2>\n<p>受上面的观察启发，我们发现在进行图像处理时，神经网络其实并不需要整个图像来作为输入，只要神经网络能识别出图片中物体的某些特征就足够完成识别任务了。因此，我们可以考虑按一定的规则来将原图片划分成多个 “小图片”，给一个小图片分配<strong>一个或多个神经元</strong>来学习。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/wqu0cs.jpg\" alt=\"模型只看细节\" height=\"350\" /></p>\n<p>假设我们将图片划分成 <code>3x3</code>  像素（需要根据实际情况调整，能覆盖住特征即可，覆盖不完全也可以，后面会说）的小图片，并且令每 3 个神经元学习一个小图片，那么此时，对于一个神经元来说，所需更新的 “权重” 就从过去的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>4</mn></msup></mrow><annotation encoding=\"application/x-tex\">3 \\times 10^4</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">4</span></span></span></span></span></span></span></span></span></span></span> 个降低到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn><mo>×</mo><mn>3</mn><mo>=</mo><mn>9</mn></mrow><annotation encoding=\"application/x-tex\">3\\times3\\times3=9</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">9</span></span></span></span> 个，所需运算量就会大大减小了，这就是一种简化。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/7qunhq.png\" alt=\"感受野\" height=\"350\" /></p>\n<p>其中，每个神经元可感知的区域，就叫做<strong>感受野（receptive field）</strong>。</p>\n<h2 id=\"常见问题\"><a class=\"anchor\" href=\"#常见问题\">#</a> 常见问题</h2>\n<h3 id=\"感受野是否可以重叠为什么\"><a class=\"anchor\" href=\"#感受野是否可以重叠为什么\">#</a> 感受野是否可以重叠，为什么？</h3>\n<p>感受野可以重叠，也必须重叠，因为在划定感受野时我们并不能保证识别物体所需的特征就正好完整的落在感受野内，所以，最好逐像素的划定感受野，以保证特征可以完整的出现在某些神经元的感受野中。每个感受野相隔的距离称为<strong>步长（stride）</strong>。</p>\n<h3 id=\"感受野的设计是否有规范\"><a class=\"anchor\" href=\"#感受野的设计是否有规范\">#</a> 感受野的设计是否有规范？</h3>\n<p>感受野可以根据任务需要随意设计，例如感受野可以只看某个通道、或者感受野的形状也可以是长方形等等、或者也是可以设计不同大小的感受野，总之，一切根据任务需要来。</p>\n<h3 id=\"感受野越过图像边界怎么办\"><a class=\"anchor\" href=\"#感受野越过图像边界怎么办\">#</a> 感受野越过图像边界怎么办？</h3>\n<p>可以直接不填充，也可以根据需要对图像的边缘进行填充，同样，具体怎么填充也可以随意设计。</p>\n<h3 id=\"经典设计\"><a class=\"anchor\" href=\"#经典设计\">#</a> 经典设计</h3>\n<p>这里提供一种经典设计：每个感受野分配 64 个神经元，感受野大小 <code>3x3</code> ，步长为 2，边缘需要进行填充。</p>\n<h1 id=\"简化基于相似特征简化训练过程\"><a class=\"anchor\" href=\"#简化基于相似特征简化训练过程\">#</a> 简化：基于相似特征简化训练过程</h1>\n<p>人类在识别图片的过程中常常会忽略一点，那就是我们要识别的物体可以在图片中的任意位置，人类会自动忽略物体相对在图片中相对位置的区别，但是对于神经网络来说，由于是不同的神经元来感知不同的区域，所以可能存在某一特征换了个位置，另外一个神经元识别不出的情况。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/ge8iuo.jpg\" alt=\"同一特征出现在不同位置\" height=\"350\" /></p>\n<h2 id=\"让不同感受野的神经元共享参数\"><a class=\"anchor\" href=\"#让不同感受野的神经元共享参数\">#</a> 让不同感受野的神经元共享参数</h2>\n<p>神经网络学习的过程其实就是确定一组参数的过程，我们从单个神经元的角度来看，神经元对某特征的识别可以对应到该神经元的一组参数上，所以，如果我们让不同的神经元共享这一组参数，则可以实现让不同的神经元都可以识别同一特征。这里需要强调的的是，这里的不同的神经元必须是<strong>不同感受野</strong>的神经元，由于不同的感受野的神经元的输入不同，即使共享同一组参数，仍然会有不同的输出；而如果是同一感受野的神经元的话，共享同一组参数则会使不同神经元输出相同的结果，这并不是我们希望看到的。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/53hkro.jpg\" alt=\"不同感受野的神经元共享同一组参数\" height=\"350\" /></p>\n<p>进一步来说，其实就是将一组参数和一个特征绑定，记得上文中提到的要让多个神经元来感受同一个感受野吗？是的，让 64 个神经元感受一个感受野，其实就是在模型中预留了 64 个 “可更新” 的特征位，该模型最多可以从图片中提取 64 个不同的特征，且任意一个感受野的神经元都可以识别这种特征。感受同一个感受野的不同神经元我们以 <code>filter x</code>  来命名，第一个称为 <code>filter 1</code> ，以此类推。</p>\n<p>这样，我们就可以在训练过程中<strong>同步更新多个神经元</strong>，任意一个神经元学习到某种特征后，其他感受野的对应的 <code>filter</code>  也会自动的学会这种特征，从而大大简化训练的过程，同时提高模型的泛化能力。</p>\n<h1 id=\"从filter的角度看待训练过程\"><a class=\"anchor\" href=\"#从filter的角度看待训练过程\">#</a> 从 filter 的角度看待训练过程</h1>\n<p>前面说过，一个 <code>filter</code>  识别一种特征，这个说法可能稍微有些抽象，我们来给出一个具体的例子：输入是一个 <code>6x6</code>  像素的黑白图片（通道数为 1），感受野为 <code>3x3</code> ，每个感受野设置 64 个神经元去学习，步长为 1，在神经网络中我们仍只考虑 “权重”。</p>\n<h2 id=\"一个filter识别一种特征\"><a class=\"anchor\" href=\"#一个filter识别一种特征\">#</a> 一个 filter 识别一种特征</h2>\n<p>首先来说明为什么一个 <code>filter</code>  可以识别一种特征。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/lxcfqf.jpg\" alt=\"一个filter识别一种特征\" height=\"350\" /></p>\n<p>假设 <code>Filter 1</code>  就是一个主对角线全为 1，其他元素都为 - 1 的权重矩阵，那么当且仅当感受野中主对角线全为 1，其他元素全 0 时才能，该神经元的输出可以取得最大值 3，即 <code>Filter 1</code>  识别了特征：有一条从左上到右下的线。</p>\n<h2 id=\"从小图片到整个图片\"><a class=\"anchor\" href=\"#从小图片到整个图片\">#</a> 从小图片到整个图片</h2>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/5ftedn.jpg\" alt=\"多层CNN\" height=\"350\" /></p>\n<p>因为一个感受野设置了 64 个神经元，所以第一层卷积层处理后得到的是一个 64 通道，大小为 <code>4x4</code>  的特征 tensor，将该输出交给下一层卷积层，下一个卷积层设置的感受野仍为 <code>3x3</code> ，但是这时，由于 <code>3x3</code>  的感受野中的每一个 <code>Feature</code>  都是从原图片中 <code>3x3x1</code>  的小图片中提取的，即每一个 <code>Feature</code>  都包含了 <code>3x3x1</code>  的像素信息，那么第二层卷积层所能 “感受” 的范围其实是原图片中 <code>5x5x1</code>  大小的区域。</p>\n<p>随着卷积层的增多，后面的卷积层中的神经元 “感受” 的范围就会<strong>越来越大</strong>。</p>\n<h1 id=\"简化基于图片的压缩来简化计算量\"><a class=\"anchor\" href=\"#简化基于图片的压缩来简化计算量\">#</a> 简化：基于图片的压缩来简化计算量</h1>\n<p>一般来说，对图片进行降采样并不影响图片的识别，我们可以采用某种方法来将多个像素合成成一个像素，从而大幅减少图片中的总像素点数，这过程称为 <code>Pooling</code> 。以 <code>Max Pooling</code>  为例， <code>Max Pooling</code>  就是用一个区域内最大的值代替该区域的所有值，从而压缩图片大小。</p>\n<p>需要注意的是，无论怎样 <code>Pooling</code>  都一定会减少图片的特征。这种方法一般在过去算力紧张时使用，现在的 CNN 中已经在慢慢减少，甚至完全不使用 <code>Pooling</code>  技术了。</p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>卷积神经网络其实就是一种专为处理图像而设计的网络结构。全连接层可以处理任何任务，同样的，也意味着他并不擅长任何任务。在全连接的基础上加入 “感受野” 和 “参数共享”，就诞生了卷积卷积神经网络。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/gch9wd.png\" alt=\"Benefit of Convolutional Layer\" height=\"350\" /></p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMVRENHkxMzdtUD9wPTIw\">https://www.bilibili.com/video/BV1TD4y137mP?p=20</span></li>\n</ul>\n",
            "tags": [
                "机器学习",
                "机器学习",
                "CNN",
                "图像处理"
            ]
        },
        {
            "id": "https://gality.cn/scientific-research/thesis-reading/%20Blockchain%20Imitation%20Game/",
            "url": "https://gality.cn/scientific-research/thesis-reading/%20Blockchain%20Imitation%20Game/",
            "title": "论文阅读｜ The Blockchain Imitation Game",
            "date_published": "2024-01-08T06:21:22.000Z",
            "content_html": "<div class=\"note info\">\n<p>Qin K, Chaliasos S, Zhou L, et al. The blockchain imitation game[J]. arXiv preprint arXiv:2303.17877, 2023.</p>\n<p>链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudXNlbml4Lm9yZy9zeXN0ZW0vZmlsZXMvc2VjMjNmYWxsLXByZXB1Yi0zMzEtcWluLnBkZg==\">https://www.usenix.org/system/files/sec23fall-prepub-331-qin.pdf</span></p>\n</div>\n<details class=\"primary\"><summary>思考🤔</summary><div>\n<p>回顾整篇论文，安全问题产生于 “抢先” 运行，这种抢先运行是基于某些私密 “情报” 的，这种事情非常常见，影响也非常广泛，就像罗斯柴尔德借助拿破仑滑铁卢掌控了整个英国的经济一样，掌握 “情报” 的用户可以几乎 “确定的” 盈利。这一情况在区块链中的影响会更加的严重，因为在区块链中，矿工本身就可以进行交易，相当于可以不直接经过 “交易所” 就可以完成金钱的流动，这无疑更有利于那些能更快拥有 “情报” 的矿工。</p>\n<p>我认为，论文中提出的方法有几个关键点：</p>\n<ol>\n<li>根据动态控制流图的构建快速分析程序的流程</li>\n<li>通过污点分析程序自动化找到污点位置并生成对抗性智能合约</li>\n<li>本地快速验证以确保攻击收益</li>\n</ol>\n<p>从实验的结果来看，APE 在以太坊中成功攻击的交易占 0.0061%；在 BSC 中成功攻击的交易占 0.0022%，这个比例相比于 &quot;Naive Transaction Imitation Attack&quot; 来说虽然更小，但是产生的收益却翻了 3 倍左右。这意味着部分大额交易采用了的保密的智能合约来对抗 &quot;Naive Transaction Imitation Attack&quot;，这是合理的，但同时也暴露了交易所其实缺乏对于安全问题的深刻认知，总是尝试通过尽可能小的改变来对已知安全威胁进行防护，这可能会导致更大的安全隐患；另外一个暴露出来的问题是即使在安全威胁已知的前提下，大量的用户并没有关心可能存在的安全风险，在区块链这样的一个有海量节点及用户的应用中，攻击者更容易通过已知威胁来获取利益，从这点上来说，如果金融类区块链算法本身可以及时提供对安全威胁的更新并强制进行版本验证，可以最大程度上避免金融损失。</p>\n<p>从 APE 的实现角度来说，APE 中的程序流分析、污点分析、对抗性智能合约生成的底层实现都是基于对区块链程序的二进制分析，这种攻击手法需要对于二进制程序有极强的了解，同时，近年来由 Go 语言实现的区块链程序不断增多，Go 语言本身的代码设计又增加了逆向分析的难度，一定程度上提高了安全性。因此，虽然 APE 中的程序流分析无法对抗对程序流的混淆防护，但是却提供了一种更轻量化的安全攻击的思路，这种思路对于相对来说还未高度复杂化的区块链程序可能会更加好用。</p>\n<p>整体来看，APE 虽然实现了一种通用的模拟攻击的方法，但是本身其实仍然相对简单，能成功运行模拟攻击的交易数量仍然占比很小，我认为存在一些可以改进的点。</p>\n<ol>\n<li>在污点分析中，APE 仅仅是结合了部分确定的 EVN 操作码，这可能会导致部分事实上可处理的污点程序未被发现，这里可以结合 “fuzzing” 技术提前对所有的 EVN 操作码进行筛选，尽可能将所有可能造成污点的操作码找出，有利于扩大攻击面。</li>\n<li>在智能合约生成中，论文并没有详细的描述这里生成智能合约的具体方法，但是从论文来看主要 patch 的点在于对  <code>JUMPI</code>  的替换，这其实是一种简单的针对程序流的控制手段，对应的防护方法也非常多，很容易的导致模仿攻击失效。可以通过增加更多的 patch 模版，针对更多操作码进行改变来扩大攻击面。</li>\n</ol>\n</div></details>\n<h1 id=\"abstract\"><a class=\"anchor\" href=\"#abstract\">#</a> Abstract</h1>\n<p>使用区块链进行自动交易和对抗性交易已经司空见惯。然而，由于区块链的透明性，对手能够观察到任何<span class=\"red\">悬而未决、尚未挖掘的交易及其执行逻辑</span>。这种透明性进一步助长了新型对手的出现，他们会实时<span class=\"red\">复制并预先运行有利可图的待处理交易</span>，从而获得可观的经济收益。</p>\n<p>为了揭示这种 &quot;复制粘贴&quot; 的不良行为，本文介绍了区块链模仿游戏，并提出了一种名为 APE 的通用模仿攻击方法。APE 利用动态程序分析技术，支持对抗性智能合约的自动合成。在一年的时间内（2021 年 8 月 1 日至 2022 年 7 月 31 日），APE 可以在以太坊上产生 1.4896 亿美元的利润，在 BNB 智能链（BSC）上产生 4270 万美元的利润。</p>\n<p>不仅是恶意攻击，我们还进一步展示了<span class=\"red\">交易和合约模仿作为防御策略的潜力</span>。我们发现，APE 在一年内分别成功模仿了以太坊和 BSC 上 13 次和 22 次已知的去中心化金融（DeFi）攻击。我们的发现表明，区块链验证器可以实时模仿攻击，以防止 DeFi 中的入侵。</p>\n<h1 id=\"introduction\"><a class=\"anchor\" href=\"#introduction\">#</a> Introduction</h1>\n<p>建立在区块链基础上的去中心化金融（DeFi）已发展成为一个价值数十亿美元的产业。然而，区块链点对点（P2P）网络被描述为黑暗森林，交易者在其中进行竞争性交易，沉溺于对抗性的<strong>前置运行 (front-running)</strong>。</p>\n<blockquote>\n<p>Front-running：经纪人或投资者因为预先知道会影响资产价格的大型机密交易而加入交易，从而获得利益。</p>\n</blockquote>\n<p>由于交易创建和在区块链上提交之间存在固有的时间延迟，因此这种前置运行是可能发生的。这种时间延迟通常只持续几秒钟，这给前置运行者带来了计算上的挑战。为了获得经济收益，DeFi 交易者需要监控错综复杂的市场动态，并及时进行有利可图的交易，这通常需要专业的领域知识。相反，对抗性交易者也可能寻求 &quot;复制粘贴&quot; 和模仿攻击。我们将这种策略称为模仿攻击。一种极其简单的<strong>字符串替换模仿方法</strong>被证明可以在过去的区块链状态下每月产生数千美元的收益。</p>\n<blockquote>\n<p>KaihuaQin,LiyiZhou,andArthurGervais.Quantifyingblockchain extractable value: How dark is the forest? In <em>2022 IEEE Symposium on Security and Privacy (SP)</em>, pages 198–214. IEEE, 2022.</p>\n</blockquote>\n<p>开源社区迅速提出了防御措施，以应对这种简单的模仿方法。在撰写本文时，交易者通常会部署个性化的闭源智能合约，从而增加了利用的难度。已知的模仿算法不再适用，因为这些合约通常通过验证等方式加以保护。</p>\n<p>然而，人们还没有探索出一种通用的模仿攻击能使现有的保护机制失效。这项工作的目标是<span class=\"red\">研究、识别、实施和评估一种通用的模仿方法</span>。我们发现，要成功模仿交易，攻击者需要克服以下三个技术难题。</p>\n<ol>\n<li>前端运行时间窗口较短，可能无法应用强大的程序分析技术，如符号执行，因为符号执行不是为实时任务设计的。</li>\n<li>攻击者需要递归地识别阻碍模仿执行的受害合约，并用新合成的对抗合约替换它们。因此，有必要使用区块链虚拟机工具来确保这一识别过程的效率。</li>\n<li>攻击者必须保证合成的合约被正确调用和执行，而产生的财务收入则在模仿执行后被发送到恶意账户。据我们所知，现有的工作或现成的工具都无法自动复制和合成注入自定义逻辑的智能合约。</li>\n</ol>\n<p>在这项工作中，我们提出了一种自动且通用的模仿方法 APE（参见图 1）。抽象来说，APE 的目的是构建一个模仿交易，复制受害者交易的逻辑。必要时，APE 会合成并部署对抗性智能合约，以绕过验证机制等复制保护。为此，APE 利用动态污点分析、程序合成和高级工具来实现模仿生成。这种通用性源于这样一个事实，即对手不需要事先了解受害者，也不需要了解受害者的交易逻辑，更不需要事先了解交互的去中心化应用程序（DApp）。APE 适用于可替代、不可替代代币的交易活动以及利用交易等。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/apo7w0.png\" alt=\"图1 高级 APE 攻击机制是一种通用的模仿方法，可在事先不了解受害者的交易和合同的情况下合成对抗性合同。APE 会侵占由此产生的任何收入\" /></p>\n<p>尽管基于区块链的 DeFi 领域蓬勃发展，但它也受到数百万美元黑客攻击的困扰。如本作品所述，模仿攻击可为恶意攻击者带来巨大的经济利益。不过，根据深度防御方法，区块链模仿攻击本身也可以通过模仿攻击、挪用易受攻击的资金并将其返还给受害者来充当入侵防御系统。开源社区将这种善意活动称为 &quot;白帽黑客&quot;。</p>\n<p>我们将我们的贡献总结如下：</p>\n<ul>\n<li>我们引入了广义区块链模仿游戏，其中有一类新的对手试图在事先不了解受害者意图或应用逻辑的情况下，模仿受害者的交易和相关合约。我们为基于 EVM 的区块链设计了通用模仿工具 APE。我们首次展示了动态程序分析技术可以实现模仿攻击，从而对区块链用户构成实质性威胁。</li>\n<li>我们在以太坊和 BNB 智能链 (BSC) 上对 APE 进行了为期一年的评估。我们发现，APE 可以在以太坊上产生 1.4896 亿美元的利润，在 BSC 上产生 4270 万美元的利润。我们发现，7374 万美元源于 35 次已知的 DeFi 攻击，而 APE 可以将其消除。通过发现 5 个新漏洞，APE 的影响进一步显现，我们披露了这些新漏洞，因为如果被利用，它们可能会造成 3153 万美元的总损失。</li>\n<li>我们发现，APE 可在以太坊（13.3 秒的区块间时间）和 BSC（3 秒的区块间时间）上实时执行。模仿一次 APE 平均需要 0.07 ± 0.10 秒。由于 APE 的效率很高，在评估时间内，它在 35 次 DeFi 攻击中实现了实时的前置运行。执行 APE 的矿工最终可以选择实施攻击，也可以作为白帽黑客进行防御。</li>\n</ul>\n<h1 id=\"background\"><a class=\"anchor\" href=\"#background\">#</a> Background</h1>\n<p>在本节中，我们将概述所需的背景，并举例说明。</p>\n<h2 id=\"blockchain-and-smart-contract\"><a class=\"anchor\" href=\"#blockchain-and-smart-contract\">#</a> Blockchain and Smart Contract</h2>\n<p>区块链是分布在点对点网络上的区块链条。用户通过账户的公钥签名批准交易，矿工收集交易，并按照区块内的特定顺序进行挖掘。支持智能合约的区块链扩展了账户持有资产和代码的能力，可以执行任意计算。智能合约通过交易进行初始化和执行，一旦部署就不可更改。它们通常用高级语言（如 So-lidity）编写，编译成低级字节码，由区块链虚拟机（如以太坊虚拟机（EVM））执行。EVM 是基于堆栈的虚拟机，支持算术、控制流、加密和其他区块链特定指令（如访问当前区块编号）。每执行一条字节码指令都需要消耗 &quot;gas&quot;，由本地加密货币支付。请注意，所有代码和账户余额通常都是透明可见的。智能合约的应用二进制接口（ABI）定义了智能合约函数的调用方式（包括函数类型、名称、输入参数等）。如果智能合约不是开源的，ABI 很可能不可用。</p>\n<p>DeFi 是一个建立在智能合约区块链之上的新兴金融生态系统，在撰写本文时，其锁定的总价值已达到 3000 亿美元的峰值。DeFi 的核心是一个智能合约编码的金融生态系统，实现了 <strong>自动做市商 (automated market maker)</strong>、借贷平台和 <strong>稳定币 (Stablecoin)</strong> 等功能。用户可以通过向相应的合约发布交易来访问 DeFi 应用程序（DApp）。</p>\n<blockquote>\n<p>market maker：指在证券市场上，由具备一定实力和信誉的独立证券经营法人作为特许交易商，不断向公众投资者报出某些特定证券的买卖价格，并在该价位上接受公众投资者的买卖要求，以其自有资金和证券与投资者进行证券交易。买卖双方不需等待交易对方出现，只要有做市商出面承担交易对手方即可达成交易，做市商从双方赚取买卖价差而从中获利。</p>\n<p>Stablecoin：是加密货币 (Cryptocurrency) 的其中一种类型。稳定币的核心想法是要打造一种底层分散式账本，但维持货币稳定价值的机制。稳定币被有些人认为是中心化资产抵押发行的代币，稳定币价值是与被抵押资产价值直接连动。</p>\n</blockquote>\n<h2 id=\"blockchain-extractable-value\"><a class=\"anchor\" href=\"#blockchain-extractable-value\">#</a> Blockchain Extractable Value</h2>\n<p>众所周知，华尔街的交易员通过前置运行其他投资者的订单（即高频交易）来获利。同样，DeFi 中的交易顺序也对收益提取活动产生了致命影响。默认情况下，矿工按交易费从高到低的顺序排列交易。因此，DeFi 交易商可以通过提供有竞争力的交易费，对待处理（即尚未开采）的交易进行前置和后置操作。然而，矿工对下单交易拥有一手遮天般的特权，这使他们垄断了区块链价值的提取。这种特权引出了 ** 矿工可提取价值 (MEV)** 的概念。</p>\n<blockquote>\n<p>MEV：指 “在给定时间内，矿工可以从操纵交易中提取的 ETH 总量”。以以太坊为例，以太坊网络的运行是依靠矿工对交易进行打包，生成区块来运行的。矿工在打包交易的时候可以做到将某些交易进行排序干预等。通过这些操作，矿工可能获取除了交易费用和区块奖励之外的额外利润，这些多出来的价值就被称为 MEV。</p>\n</blockquote>\n<p>Qin 等人将 MEV 概括为区块链可提取价值（Blockchain Extractable Value，BEV），并表明在 32 个月内，以太坊上提取的 BEV 达 5.4054 亿美元，主要有三个来源：<strong>三明治攻击 [1]</strong>、<strong>清算 [2,3]<strong> 和</strong>套利 [4]</strong>。</p>\n<blockquote>\n<ol>\n<li>LiyiZhou,KaihuaQin,ChristofFerreiraTorres,DucVLe,andArthur Gervais. High-frequency trading on decentralized on-chain exchanges. In <em>2021 IEEE Symposium on Security and Privacy (SP)</em>, pages 428–445. IEEE, 2021.</li>\n<li>KaihuaQin,JensErnstberger,LiyiZhou,PhilippJovanovic,andArthur Gervais. Mitigating decentralized finance liquidations with reversible call options. In <em>International Conference on Financial Cryptography and Data Security</em>. Springer, 2023.</li>\n<li>KaihuaQin,LiyiZhou,PabloGamito,PhilippJovanovic,andArthur Gervais. An empirical study of defi liquidations: Incentives, risks, and instabilities. In <em>Proceedings of the 21st ACM Internet Measurement Conference</em>, page 336–350. ACM, 2021.</li>\n<li>LiyiZhou,KaihuaQin,AntoineCully,BenjaminLivshits,andArthur Gervais. On the just-in-time discovery of profit-generating transactions in defi protocols. In <em>2021 IEEE Symposium on Security and Privacy (SP)</em>, pages 919–936, 2021.</li>\n</ol>\n</blockquote>\n<p>需要注意的是，前台运行即服务（FaaS）（如 flashbots）通过在私有网络中与矿工勾结，降低了提取 BEV 的风险。与贿赂类似，BEV 被证明会威胁到区块链共识的安全性，因为矿工会被激励分叉区块链。关于 DeFi 攻击的 SoK 系统分析了四年来的攻击，确定了各种攻击的原因和影响。在本文中，我们对白帽攻击者和黑帽攻击者进行了区分，其中黑帽攻击者保留了攻击的经济收益，而白帽攻击者则将攻击收入退还给确定的受害者。</p>\n<h2 id=\"naive-transaction-imitation-attack\"><a class=\"anchor\" href=\"#naive-transaction-imitation-attack\">#</a> Naive Transaction Imitation Attack</h2>\n<p>提取实体的 BEV 可采用两种策略：一种是对 DeFi 应用程序进行细致分析（即针对特定应用程序的提取），另一种是采用天真的通用事务模仿攻击（即与应用程序无关的提取）。</p>\n<p>Qin 等人提出了一种天真但有效的事务模仿攻击。<strong>该算法将受害者交易作为输入，并在交易发送者和数据字段中简单地将交易的发送者地址替换为恶意地址</strong>。因此，这种模仿算法相当于字符串替换方法，并不试图合成对抗性智能合约。在对过去的区块链数据进行模拟时，结果表明这种天真的算法可以在 32 个月的时间内产生 3537 万美元。我们在附录 A 中提供了一个天真的模仿示例。但是，当交易者通过认证机制等方式保护自己的交易时，这种算法就会失效，我们将在下文概述。</p>\n<h2 id=\"motivating-examples\"><a class=\"anchor\" href=\"#motivating-examples\">#</a> Motivating Examples</h2>\n<p>DeFi 中的交易者通常使用定制的智能合约来执行金融行为，例如套利和清算。这些交易者尝试保护其交易免受仿冒攻击，例如只允许预定义账户调用其智能合约（参见图 2）。这种保护措施与认证机制相对应，是开源社区采用的一种常见做法。我们以现实世界中的身份验证为例进行说明。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/hxes5m.png\" alt=\"图 2：清算人通过向其定制合约发送交易触发清算。自定义合约包含一个验证（第 3 行）\" /></p>\n<p><em>身份验证保护示例</em>。在图 2 中，我们展示了「清算合约」如何尝试防止交易模仿攻击。图 2 中「清算合约」的实体代码没有开源，因此我们使用最先进的 EVM 合约去编译器对合约字节码进行反编译。要触发清算，清算人需要向增强合约发送交易以及「参数」（如闪贷规模和清算金额）。如果没有保护机制，对手可能通过调用带有相同参数的相同合约来运行清算器。然而，所提交的合约要求交易发送方匹配特定地址（第 3 行）。具体来说，清算函数 <code>printMoney()</code>  只能由硬编码地址调用。如果不满足这一条件，第 2.3 节中的天真模仿攻击就会失败。要规避身份验证保护，一种方法是合成一份恶意合约，复制清算者的定制合约。通过重构字节码，合成的合约既保留了清算逻辑，又绕过了身份验证。要执行攻击，攻击者无需了解清算交易的业务逻辑。对手不调用清算人的定制合约，而是调用合成合约，然后触发清算。</p>\n<p>在这项工作中，我们提出了一种自动化和通用化的模仿方法 APE，可以挫败此类保护。APE 不仅仅局限于身份验证，它还提供了一种全面的方法来克服天真模仿策略无法处理的各种形式的保护机制。再举个例子，我们考虑这样一个场景：交易者发布了一笔盈利交易，并将赚取的收入存入交易者控制的智能合约中。虽然对手可能会通过天真的策略成功执行模仿交易这个过程，但收入仍会留在 &quot;受害者&quot; 交易者的合约中，攻击者不会因此获得任何经济收益。与此相反，APE 通过合成一个作为收益接收者的对抗性合约来解决这一困境。我们将在第 5.3 节中进一步介绍这种情况的细节，并展示真实世界中的一笔交易。</p>\n<h1 id=\"ape-overview\"><a class=\"anchor\" href=\"#ape-overview\">#</a> APE Overview</h1>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/cdietk.png\" alt=\"论文中涉及的符号及含义\" /></p>\n<p>接下来，我们将概述系统和威胁模型。然后，我们将概述 APE 的关键组成部分。</p>\n<h2 id=\"preliminary-models\"><a class=\"anchor\" href=\"#preliminary-models\">#</a> Preliminary Models</h2>\n<ul>\n<li>\n<p><strong>系统模型</strong></p>\n<p>我们考虑采用智能合约的分布式账本和现有的 DeFi 生态系统。交易者通过其区块链账户执行金融操作，签署矿工挖掘的交易。同样，智能合约也由其各自的账户引用。区块链交易 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span></span></span></span> 代表状态转换函数，将账本状态从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> 转换为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></mrow><annotation encoding=\"application/x-tex\">S&#x27;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span>，即 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo>=</mo><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mo stretchy=\"false\">(</mo><mi>S</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">S&#x27; = \\mathrm{tx}(S)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mclose\">)</span></span></span></span> 。</p>\n<p>我们假设，在 DeFi 系统中，除了原生区块链加密货币 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span> 之外，还存在各种资产表示形式（如可替代代币）。在区块链状态 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> 下，账户 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi></mrow><annotation encoding=\"application/x-tex\">a</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">a</span></span></span></span> 持有的资产 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> 余额用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi><mi>a</mi><msubsup><mi>l</mi><mi>a</mi><mi>m</mi></msubsup><mo stretchy=\"false\">(</mo><mi>S</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">Bal^{m}_{a} (S)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-2.4530000000000003em;margin-left:-0.01968em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mclose\">)</span></span></span></span> Z 表示，而 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi mathvariant=\"normal\">Δ</mi><mi>a</mi><mi>m</mi></msubsup><mo stretchy=\"false\">(</mo><mi>S</mi><mo separator=\"true\">,</mo><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\Delta^{m}_{a}(S,\\mathrm{tx})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord\">Δ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"mclose\">)</span></span></span></span> 表示在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> 上执行交易 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span></span></span></span> 后的余额变化（参见公式 1）。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><msubsup><mi mathvariant=\"normal\">Δ</mi><mi>a</mi><mi>m</mi></msubsup><mo stretchy=\"false\">(</mo><mi>S</mi><mo separator=\"true\">,</mo><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mo stretchy=\"false\">)</mo><mo>=</mo><mi>B</mi><mi>a</mi><msubsup><mi>l</mi><mi>a</mi><mi>m</mi></msubsup><mo stretchy=\"false\">(</mo><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mo stretchy=\"false\">(</mo><mi>S</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo>−</mo><mi>B</mi><mi>a</mi><msubsup><mi>l</mi><mi>a</mi><mi>m</mi></msubsup><mo stretchy=\"false\">(</mo><mi>S</mi><mo stretchy=\"false\">)</mo></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(1)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\Delta^{m}_{a} (S, \\mathrm{tx}) = Bal^{m}_{a} (\\mathrm{tx}(S)) - Bal^{m}_{a}(S) \\tag{1}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord\">Δ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7143919999999999em;\"><span style=\"top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span></span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7143919999999999em;\"><span style=\"top:-2.4530000000000003em;margin-left:-0.01968em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span></span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mclose\">)</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7143919999999999em;\"><span style=\"top:-2.4530000000000003em;margin-left:-0.01968em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span></span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mclose\">)</span></span><span class=\"tag\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p>我们进一步假设存在链上交易所，这些交易所允许从任何资产 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> 到原生加密货币 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span> 的交易。</p>\n</li>\n<li>\n<p><strong>威胁模型</strong></p>\n<p>我们的考虑的最强的对抗模型为：一个矿工，它可以单枪匹马地在其开采的区块中进行交易。作为矿工， <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以访问每个待处理的交易和当前的区块链状态。 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 通过多个分布式节点和点对点连接，在 P2P 网络上主动列出数据。此外， <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 还可以充当或与 FaaS 提供商合作，私下接收待处理交易。由于  <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 是矿工，因此  <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以在任何待处理交易之前进行交易。我们假设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span>  在财务上是理性的，并试图最大化其资产价值。此外，我们假设  <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以获得足够的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span> 来执行 APE。</p>\n<p>APE 与应用无关，这意味着  <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 无需预先知道受害者交易 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的逻辑，也无需知道其目标智能合约。不过，我们假设即  <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 了解如何与资产代币互动，并且  <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以通过上链交换将代币 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> 交换给 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span>。</p>\n<p>我们将旨在复制和替换 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 行为的交易称为模仿交易 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 。<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 与一组合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">{</mo><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">\\{\\mathrm{sc}_{vi}\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">{</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">}</span></span></span></span> 交互，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可能需要替换这些合约的子集才能成功执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 。我们认为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以处理任何受害合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vi}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，以合成各自的对抗合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。</p>\n<p><strong>澄清</strong>   APE 无法形成新的攻击，因为 APE 事先不知道以前的区块链攻击，也不知道应用层逻辑。因此，APE 依赖于模板交易和编码攻击逻辑的相关合约。</p>\n</li>\n</ul>\n<h2 id=\"attack-overview\"><a class=\"anchor\" href=\"#attack-overview\">#</a> Attack Overview</h2>\n<p>给定一个有利可图的受害者交易 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，对手 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以尝试用简单的模仿交易来模仿其逻辑（参见第 3.3 节）。然而，由于现有的各种防御机制（如身份验证），这种天真的方法可能会失败（参见第 3.4 节）。由于缺乏关于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的先验知识，理解一个失败对 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 来说具有挑战性。此外，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的执行可能与多个被调用的合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">{</mo><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">\\{\\mathrm{sc}_{vi}\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">{</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">}</span></span></span></span> 交织在一起，从而使分析变得更加复杂。最后，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 必须实时攻击，因为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 被挖掘出来前的攻击窗口通常只持续几秒钟。</p>\n<p>APE 的目标是生成一个模仿交易 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，以及一组模仿 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 逻辑的合成合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">{</mo><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">\\{\\mathrm{sc}_{ai}\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">{</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">}</span></span></span></span>（和相关的受害者合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">{</mo><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">\\{\\mathrm{sc}_{vi}\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">{</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">}</span></span></span></span>），并具有以下属性：</p>\n<ul>\n<li><strong>事先不了解受害者情况</strong>：任何盈利交易都应被视为潜在受害者，与发行者无关。<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 不需要事先了解受害者的交易、意图或过去的区块链历史。</li>\n<li><strong>不推理受害者逻辑</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 不知道 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的应用逻辑，也不涉及 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vi}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。</li>\n<li><strong>额外复杂性带来更高回报</strong>：APE 引入了比天真的模仿方法更多的复杂性，因此应该能获得超过原模拟方法的收益。为了进行客观比较，我们在相同的区块链交易历史上对两种模仿方法进行了评估。</li>\n<li><strong>实时性</strong>：我们假设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 只攻击待处理的临时交易。因此，APE 必须快于区块间时间（例如，以太坊上约为 13.3 秒，BSC 上为 3 秒）。因此，必须优先考虑执行速度而不是攻击最优性。请注意，作为矿工的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以选择在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 上分叉区块链，从而获得更长的攻击时间窗口，这超出了本工作的范围。</li>\n</ul>\n<p>APE 的高层逻辑运算如下。给定一个潜在的受害者交易 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> ，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 首先尝试通过创建并执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 来作为一个天真模仿事务以模仿 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 。如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的执行出现回退，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 就会找出引发失败的执行轨迹。然后，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 合成 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，替换导致 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 回退的<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vi}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。为此，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 复制受害者的合约字节码，并修改阻止成功模仿执行的指令。最后，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 在本地验证 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 部署和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的可盈利性。根据 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以领先任何竞争对手的假设（参见第 4.1 节），APE 是无风险的。请注意，利用事务的可组合性，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以在单个事务中原子式地操作 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 部署和模仿执行（即 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span></span></span>）。</p>\n<p>APE （参见图 3）由六个关键部分组成：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/8sfecv.png\" alt=\"图 3：基于 EVM 的区块链交易实时模仿攻击 APE 概述\" /></p>\n<ol>\n<li>\n<p><strong>动态控制流图</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 在当前区块链状态下循环执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，并构建动态控制流图（DCFG）。DCFG 捕获<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(i)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">)</span></span></span></span> 在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 执行时 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vi}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的合约间调用，以及 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>i</mi><mi>i</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(ii)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">)</span></span></span></span> 调用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vi}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的合约字节码执行流。</p>\n</li>\n<li>\n<p><strong>盈利分析器</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 提取 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 触发的资产转移，观察受益账户。然后，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 尝试替换这些账户成为受益人。如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 没有成功成为受益人，则中止攻击。</p>\n</li>\n<li>\n<p><strong>动态污点分析</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 执行动态污点分析，并将分析结果与步骤 1 中构建的 DCFG 进行比较。如果比较结果显示没有差异，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 就继续进行天真交易仿真（参见第 2.3 节）。否则，根据动态污点分析和与 DCFG 的比较，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 识别出妨碍成功执行天真模仿的污点基本块。</p>\n</li>\n<li>\n<p><strong>补丁识别器</strong>：基于检测到的受益人账户和污点智能合约，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 开始识别所有需要替换的智能合约。</p>\n</li>\n<li>\n<p><strong>智能合约合成</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 通过复制 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的字节码合成 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vi}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可能需要修改 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的字节码，以确保 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 可以执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的逻辑并收取产生的财务收入。</p>\n</li>\n<li>\n<p><strong>验证</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 在本地部署 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 并执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，以验证攻击是否有利可图。如果有利可图，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 就在链上部署 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 并发布 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，前置运行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。</p>\n</li>\n</ol>\n<h1 id=\"ape-details\"><a class=\"anchor\" href=\"#ape-details\">#</a> APE Details</h1>\n<p>在本节中，我们将介绍 APE 的设计细节，并讨论其技术局限性。</p>\n<h2 id=\"step-1-dynamic-control-flow-graph\"><a class=\"anchor\" href=\"#step-1-dynamic-control-flow-graph\">#</a> Step 1 : Dynamic Control-Flow Graph</h2>\n<p>智能合约控制流图（CFG）是合约字节码的图形表示法。在 CFG 中，每个节点表示一个基本块，即指令的线性序列。节点由有向边连接，代表控制流中的代码跳转。对于 EVM 字节码， <code>JUMP</code>  和  <code>JUMPI</code>  这两个操作码控制着代码块的执行路径。 <code>JUMP</code>  是无条件跳转到堆栈中的目标，而  <code>JUMPI</code>  则是有条件跳转。CFG 只包含有关合约的静态信息，而 DCFG 是一种专门的 CFG，包含从给定执行中提取的动态信息。</p>\n<p><em>APE 中的动态控制流图构建</em>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 在本地执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，构建 DCFG，表示 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的执行细节。为了推理 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的控制流，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 记录了每个  <code>JUMPI</code>  的条件值，这是动态分析所必需的（第 3 步，参见第 5.3 节）。通过捕捉合约调用的操作码（即  <code>CALL</code> 、 <code>DELEGATECALL</code> 、 <code>STATICCALL</code>  和  <code>CALLCODE</code> ），<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以识别跨合约的调用。因此，构建的 DCFG 可以跟踪调用的所有智能合约。构建的 DCFG 反映了 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的具体执行，而不是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vi}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的完整表示。这对本工作很有帮助，因为未执行的基本区块与模仿受害者交易无关。因此，得到的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>（参见步骤 5，第 5.5 节）可能比 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vi}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 包含更少的操作码，从而降低攻击成本。</p>\n<h2 id=\"step-2-profitability-analyzer\"><a class=\"anchor\" href=\"#step-2-profitability-analyzer\">#</a> Step 2 : Profitability Analyzer</h2>\n<p>盈利能力分析器旨在过滤掉不可能盈利的受害者交易。直观地说，如果对抗收入（以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span> 度量）大于所需的交易费用，则 APE 尝试是有利可图的（参见定义 5.1）。</p>\n<p><mark><strong>定义 5.1</strong></mark>（盈利条件）。给定一个区块链状态 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span>，对 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 来说，如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi><mi>a</mi><msubsup><mi>l</mi><mi mathvariant=\"script\">A</mi><mi>E</mi></msubsup><mo stretchy=\"false\">(</mo><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo stretchy=\"false\">)</mo><mo>−</mo><mi>B</mi><mi>a</mi><msubsup><mi>l</mi><mi mathvariant=\"script\">A</mi><mi>E</mi></msubsup><mo stretchy=\"false\">(</mo><mi>S</mi><mo stretchy=\"false\">)</mo><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">Bal^{E}_{\\mathcal{A}}(S&#x27;) - Bal^{E}_{\\mathcal{A}}(S) &gt; 0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.1166619999999998em;vertical-align:-0.275331em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413309999999999em;\"><span style=\"top:-2.424669em;margin-left:-0.01968em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathcal mtight\">A</span></span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">E</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.275331em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1166619999999998em;vertical-align:-0.275331em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413309999999999em;\"><span style=\"top:-2.424669em;margin-left:-0.01968em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathcal mtight\">A</span></span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">E</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.275331em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span></span></span></span>（其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></mrow><annotation encoding=\"application/x-tex\">S&#x27;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span> 是攻击交易后的区块链状态），则 APE 攻击对 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 来说是有利可图的。</p>\n<p>在最简单的情况下，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以通过检查交易发送方的余额变化来推断模仿 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的盈利能力。然而，受害者可能会将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的收入转移到其控制的另一个智能合约，而不是转移到发送者账户。因此，只有当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 确定受益收款人时，模仿 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 才有利可图。因此，为了确定盈利能力，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 有必要确定参与执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的每个账户的利润。为此，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 可以从步骤 1 中构建的 DCFG 中提取资产转移。通过分析资产执行标准（如 <strong>ERC20</strong>）中定义的 EVM 日志，可以直接提取资产转移。我们继续定义 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 执行中的受益人账户（参见定义 5.2）。</p>\n<p><mark><strong>定义 5.2</strong></mark>（受益账户）。如果在执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的过程中，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi></mrow><annotation encoding=\"application/x-tex\">a</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">a</span></span></span></span> 收到的金额大于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi></mrow><annotation encoding=\"application/x-tex\">a</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">a</span></span></span></span> 支付的金额，则账户 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi></mrow><annotation encoding=\"application/x-tex\">a</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">a</span></span></span></span> 被视为受益人。</p>\n<p>我们仅以本地货币 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span> 来衡量盈利能力，以使金融价值比较正常化。这意味着 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 必须在模仿 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 之后将所有收到的资产原封不动地交换到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span>。</p>\n<p>如果在执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的过程中存在受益人账户，那么模仿 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 可能会产生利润。具体来说，有两种情况 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 不会放弃攻击：</p>\n<ol>\n<li>如果发件人是受益账户，则其他账户与盈利能力分析器无关。</li>\n<li>否则，如果发送人不是受益人账户，其他受益人账户的总利润减去发送人账户的潜在损失后必须保持正数。</li>\n</ol>\n<p>然后，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 将受益人账户导出到补丁识别器（步骤 4），以便进一步分析（参见第 5.4 节）。请注意，这种方法可能会带来误报，因为盈利能力分析器不考虑交易是否具有可操作性。例如，从钱包合约中向交易发送方提取资产的交易被归类为可盈利交易，因为发送方是受益人账户。但是，提取交易是无法模仿的。这种误报将在验证阶段（第 6 步）被清除。</p>\n<h2 id=\"step-3-dynamic-taint-analysis\"><a class=\"anchor\" href=\"#step-3-dynamic-taint-analysis\">#</a> Step 3 : Dynamic Taint Analysis</h2>\n<p>动态污点分析是一种程序分析方法，可在程序执行过程中跟踪来自污点源（如不受信任的输入）的信息流。动态污点分析通过污点策略明确确定：</p>\n<ol>\n<li>哪些指令会引入新的污点；</li>\n<li>如何对污点进行预处理；</li>\n<li>如何检查污点值。</li>\n</ol>\n<p><strong>APE 中的动态污点分析</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 开始执行从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 复制的模仿事务 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的执行相比，如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 包含不一致（例如不同的事务发送者），则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的执行可能会失败（参见第 3.4 节）。因此，在执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 时，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 会应用动态污点分析来跟踪 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 执行失败的位置和方式。<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 将可能触发不一致执行值的操作码视为污点源，并跟踪其污点传播。下面我们将概述 APE 的污点分析策略：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/iyhih8.jpg\" alt=\"表 2：污点引入规则。在执行 txc 时，ORIGIN 肯定会引入一个不一致的值，而其余操作码（灰色部分）可能会、也可能不会影响 txc 的执行\" /></p>\n<ul>\n<li><strong>污点介绍</strong>：我们检查了所有 EVM 操作码，并找出了那些可能带来不一致的操作码（参见表 2）。例如，`ORIGIN・（交易发送方操作码）肯定会产生不一致值，因为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 是由恶意地址而不是受害者地址发出的。其余操作码在执行过程中可能会、也可能不会产生不一致值。</li>\n<li><strong>污点传播</strong>：当至少有一个输入是污点时，污点会传播到算术 / 逻辑运算的输出。值得注意的是，如果一个存储变量是从一个污点槽中读取的，那么它就是污点。</li>\n<li><strong>污点检查</strong>：回顾一下，我们在建立 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的 DCFG 时，在步骤 1 中（参见第 5.1 节）记录了每个  <code>JUMPI</code>  条件的具体值。给定 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的污点执行轨迹后，我们比较每个污点  <code>JUMPI</code>  是否与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的记录值相同。通过这种具体的比较，我们可以确定 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 之间的不一致是如何中断 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的执行的。</li>\n</ul>\n<p>接下来，我们将定义污点基本区块（参见定义 5.3）和污点合约（参见定义 5.4）。</p>\n<p><mark><strong>定义 5.3</strong></mark>（污点基本区块）。如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(i)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">)</span></span></span></span> 基本程序块包含一个条件值为污点的  <code>JUMPI</code>  操作码，且 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>i</mi><mi>i</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(ii)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">)</span></span></span></span> 在执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 时条件值不同，则该基本程序块为污点程序块。</p>\n<p><mark><strong>定义 5.4</strong></mark>（污点合约）。如果智能合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 包含至少一个污点基本区块，则该合约为污点合约。</p>\n<p>如果没有污点基本区块，则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的执行过程完全相同。因此，APE 等同于天真模仿攻击（即 A 只需发出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 并省略步骤 4 , 5 即可模仿 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>）。但是，如果存在一个有污点的基本区块，则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的执行与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 不同。为了复制 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的执行，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 将污点合约替换为对抗合约，保留与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 相同的执行逻辑。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/focthg.png\" alt=\"图 4：示例中模仿事务的污点传播（参见图 2，第 3.4 节）。CALLER 引入一个污点值，并传播到 JUMPI 条件\" /></p>\n<p><strong>污点传播示例</strong>：在图 4 中，我们展示了动态污点分析如何在给定恶意地址 0xab...cd 的情况下，跟踪激励示例（参见图 2，第 3.4 节）中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的执行情况。执行后，污点从  <code>CALLER</code>  传播到  <code>JUMPI</code>  的条件值（参见 PC 0xb27，图 4）。此外，条件值为  <code>False</code> ，与执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 时不同。因此，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 知道定制的清算合约已被玷污，需要替换。</p>\n<h2 id=\"step-4-patch-identifier\"><a class=\"anchor\" href=\"#step-4-patch-identifier\">#</a> Step 4 : Patch Identifier</h2>\n<p>回想一下，污点基本区块可以避免 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 成功退出。因此，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 试图用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{ai}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span>  替换有污点的合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 。此外，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 还需要替换步骤 2 中识别出的受益人账户，以便收取 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 中产生的财务收入。修补标识符的目的是检测 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">{</mo><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">\\{\\mathrm{sc}_{vi}\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">{</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">}</span></span></span></span>  中所有需要修补和替换的合同，以便成功模仿 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。根据对 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 的调用是来自交易还是来自合约，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 需要区分以下两种情况。我们用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">‾</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\overline{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.78056em;vertical-align:-0.15em;\"></span><span class=\"mord overline\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.63056em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.55056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"overline-line\" style=\"border-bottom-width:0.04em;\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 表示必须修补和替换的合同。</p>\n<p><strong>从事务中调用</strong>：当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 调用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 时，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 应将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的  <code>to</code>  地址从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 修改为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 。</p>\n<p><strong>从合约调用</strong>：如果对受污染合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 的调用是硬编码（字节码或存储）在调用者合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>j</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vj}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9566680000000001em;vertical-align:-0.286108em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.67056em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span>  中的（参见图 5），则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 应同时替换 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vj}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> ，以修补硬编码语句。即使 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vj}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 没有被污染，这也是必要的。上述修补程序可反复应用于随后的硬编码合约调用。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/d3p0xv.png\" alt=\"图 5：对污点合约 scvi 的调用被硬编码到合约 scv j 中。要执行 APE，A 需要同时替换 scvi 和 scvj\" /></p>\n<h2 id=\"step-5-smart-contract-synthesis\"><a class=\"anchor\" href=\"#step-5-smart-contract-synthesis\">#</a> Step 5 : Smart Contract Synthesis</h2>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 开始合成对抗性合约，以替换补丁标识符检测到的每个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">‾</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\overline{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.78056em;vertical-align:-0.15em;\"></span><span class=\"mord overline\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.63056em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.55056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"overline-line\" style=\"border-bottom-width:0.04em;\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span>（参见第 5.4 节）。从顶层设计来说，为了合成 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 复制了 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">‾</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\overline{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.78056em;vertical-align:-0.15em;\"></span><span class=\"mord overline\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.63056em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.55056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"overline-line\" style=\"border-bottom-width:0.04em;\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 的字节码，并做了如下修改。</p>\n<p>对于有污点的合约 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 会修改每个有污点的基本代码块，以确保 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 遵循与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 相同的代码路径，尽管  <code>JUMPI</code>  条件可能不一致。具体来说，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}(i)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">)</span></span></span></span> 将  <code>JUMPI</code>  替换为  <code>JUMP</code> ，导致无条件跳转，或 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>i</mi><mi>i</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(ii)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">)</span></span></span></span> 删除  <code>JUMPI</code> ，导致不跳转。如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub><mo stretchy=\"true\">^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\widehat{\\mathrm{sc}_{vi}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82056em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6705599999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span class=\"svg-align\" style=\"top:-3.43056em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span style=\"height:0.24em;\"><svg width='100%' height='0.24em' viewBox='0 0 1062 239' preserveAspectRatio='none'><path d='M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22\nc-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 的调用被硬编码在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vj}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 中（参见图 5），则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 需要修改 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{a j}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span>，将合约调用从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{aj}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 重定向到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。此外，由于每个新部署的对抗性合约都有一个空存储空间，因此在执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 时，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 可能会从其存储空间中加载一个不一致的值。因此，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 会进一步修改 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 以恢复加载。</p>\n<p>上述修改可确保 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 具有相同的执行路径（代码块和合约），但不能保证 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 获得所产生的收益。例如，在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 中产生的收入可能会被发送到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vi}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 中硬编码的账户<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>a</mi><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">a_v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。合成的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 复制了 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>v</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{vi}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 中的字节码，并可能按照相同的方式传输（即发送到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>a</mi><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">a_v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，而不是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 控制的账户）。因此，为了获取所产生的收入，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 需要通过临时修改 EVM 内存和向 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 注入收入收集逻辑来重定向相关的资产转移。最终，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 会根据打补丁后的字节码大小变化更新跳转目的地。</p>\n<h2 id=\"step-6-validation\"><a class=\"anchor\" href=\"#step-6-validation\">#</a> Step 6 : Validation</h2>\n<p>最后，APE 会在交易挖矿前本地验证 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。APE 失败的原因有两个：</p>\n<ol>\n<li>执行可能失败</li>\n<li>财务收入无法弥补部署对抗性合约和执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的成本。</li>\n</ol>\n<p>为了对攻击进行具体验证，恶意矿工会部署每个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">c</mi></mrow><mrow><mi>a</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{sc}_{ai}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">c</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，并在本地的最新区块链状态上执行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 将收到的所有代币转换为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span>，以检查 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 是否产生利润。只有当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span> 中的收入涵盖所有交易费用（包括智能合约部署费用）时，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 才能产生利润。回想一下，对抗性合约的部署、模仿执行和资产交换可以在一次攻击交易中完成。如果验证成功，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 就会在下一个区块中包含攻击交易（前置运行 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>）。否则，攻击中止，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 无需承担任何费用，即 APE 无风险。</p>\n<h2 id=\"limitations\"><a class=\"anchor\" href=\"#limitations\">#</a> Limitations</h2>\n<p>APE 的设计和实施有许多限制条件。例如，我们假设对手拥有成功执行 APE 所需的足够数量的前期资产。鉴于闪存贷款的广泛使用，前期资本要求已迎刃而解。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/0df427.png\" alt=\"清单 1：任何提供由其私人密钥签名的 ECDSA 签名的账户都可以从 Vault 提取资产\" /></p>\n<p>当需要进行复杂的语义重组时，APE 就不适用了。我们在清单 1 中举例说明，合约 Vault 允许任何提供由其私钥签署的有效 ECDSA 签名 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>v</mi><mo separator=\"true\">,</mo><mi>r</mi><mo separator=\"true\">,</mo><mi>s</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(v, r, s)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mclose\">)</span></span></span></span> 的账户提取资产。由于这种 &quot;任何人都可以提取&quot; 的逻辑，Vault 的设计使得提取交易容易受到模仿攻击。然而，要让对手自动执行攻击，就需要自动进行语义理解和签名生成，而 APE 并不支持这一点。</p>\n<p>此外，APE 无法模仿非原子策略，即跨越多个独立区块链交易的策略。例如，给定一个资产交换受害者交易，三明治攻击者可能会创建两个对抗性交易，从受害者身上榨取利润。APE 的目标不是产生这种攻击。但是，如果三明治攻击的攻击者创建了一个包裹受害者交易所的原子夹心交易，APE 就能成功挑战该交易。</p>\n<p>在我们的工作中，我们假设受害者不知道 APE 对手，特别是 APE 攻击策略。如果受害者意识到了 APE，那么受害者可以重新设计其智能合约，使其交易更坚固，以抵御 APE 对手的攻击。正如我们在第 6 节中所展示的，本文介绍的攻击方法在实践中非常有效。我们将在第 8 节概述可能的反击策略。</p>\n<h1 id=\"ape-historical-evaluation\"><a class=\"anchor\" href=\"#ape-historical-evaluation\">#</a> APE Historical Evaluation</h1>\n<p><strong>实现</strong>：我们用 6582 行 Golang 代码实现了 APE。更多详情可参见附录 B。</p>\n<p>我们开始评估 APE 仿真攻击在以太坊和 BSC 上一年时间内（从 2021 年 8 月 1 日到 2022 年 7 月 31 日） 的表现，以太坊和 BSC 是本文撰写时市值最高的两个支持智能合约的区块链。我们分别对以太坊和 BSC 上的 431,416,565 笔和 2,366,970,381 笔过往交易进行了评估。</p>\n<h2 id=\"methodology-and-setup\"><a class=\"anchor\" href=\"#methodology-and-setup\">#</a> Methodology and Setup</h2>\n<p>我们将过去的每笔交易都视为潜在的受害交易，并对其应用 APE 管道。如果攻击成功，我们会保存相关的合成智能合约，以及产生的收益和执行成本（如合约部署和模仿交易的 'gas' 成本）。如果不需要替换合约，APE 会退回到天真的模仿攻击，我们将其作为基线单独列出。</p>\n<p>虽然完整存档节点可以提供任何过去区块的区块链状态，但它并不直接允许在任意过去区块链状态上执行任意交易。因此，我们通过对 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVt\">go-ethereum</span> 和 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2JuYi1jaGFpbi9ic2M=\">bsc</span> EVM 进行相应的定制，为以太坊和 BSC 实现了一个仿真器。模拟器从存档节点获取历史状态，并返回任何给定交易的执行结果。我们在 Ubuntu 20.04.3 LTS 上进行实验，该系统配备 AMD 3990X（64 核）、256GB 内存和 8TB NVMe SSD。</p>\n<h2 id=\"evaluation-results\"><a class=\"anchor\" href=\"#evaluation-results\">#</a> Evaluation Results</h2>\n<p>在以太坊上，从总计 431,416,565 个潜在的链上挖掘的受害交易中，我们发现了 43,979 个（0.0102%）容易受到天真模仿攻击的交易（参见表 3）。APE 成功攻击了 26,127 个（0.0061%）受害者交易，其中涉及替换 665 个独特的智能合约。</p>\n<p>从 2,366,970,381 个 BSC 交易中，我们发现天真模仿适用于 516,128 个（0.0218%）受害者交易，而 APE 则捕获了 52,799 个（0.0022%）额外的交易，涉及 1,193 个独特的合约。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/xkstkq.png\" alt=\"表 3：代表成功攻击交易和唯一受害者合同的总体攻击统计数据\" /></p>\n<p><strong>攻击收益</strong>：为了合理衡量攻击利润，我们需要考虑导线部署和模仿交易所需的交易费成本。因为区块空间是有限的（例如，受以太坊区块‘gas’限制），因此在执行 APE 攻击时，我们需要捕捉矿工在不包含受害者交易时放弃交易费的机会成本。因此，我们用 APE 受害交易的交易费来量化这种机会成本。利润以每笔受害者交易时的 ETH (BNB) 价格换算成美元。请注意，ETH (BNB) 是以太坊 (BSC) 上的原生加密货币。</p>\n<p>我们在图 6 中展示了 APE 的累积利润。在以太坊上，与天真模仿相比，APE 可以将模仿攻击的利润提高 973.6%。具体来说，我们发现 APE（包括天真模仿攻击）总共产生了 1.4896 亿美元的利润，而天真模仿攻击在相同时间段内的累计利润仅为 1387 万美元。通过量化模仿攻击所需的前期资金，我们发现 99.31% 的成功攻击所需的资金少于 5 ETH（包括交易费）。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/btxg6m.png\" alt=\"图 6：从 2021 年 8 月 1 日到 2022 年 7 月 31 日，以太坊上的模仿攻击总利润（包括 APE 和天真模仿）达到 1.4896 亿美元，而 APE 的累计利润为 1.3508 亿美元。在 BSC 上，APE 和天真模仿分别产生 2945 万美元和 1325 万美元\" /></p>\n<p>在 BSC 上，天真模仿攻击的利润累计为 1325 万美元，而 APE 则带来了 2 945 万美元的额外利润（+222.3%）。99.48% 的 BSC 模仿攻击所需的预付资金低于 5 BNB。</p>\n<p>我们注意到，与天真模仿相比，APE 获取的平均利润高出一个数量级（参见表 3）。为进一步了解易受 APE 影响的交易，我们将在第 6.3 节中进行分析。</p>\n<p><strong>Gas 消耗</strong>：APE 带来了额外的 'gas' 成本，因为对手可能需要部署对抗性合约。我们确定了两个与 'gas' 相关的约束条件，攻击受此约束。攻击的收入必须能够支付 'gas' 支出，而且用于部署和执行攻击交易的 'gas' 应保持在区块 'gas' 限额以下。</p>\n<p>在以太坊上，我们发现 APE 平均耗费 0.98M±0.74M 'gas'，而天真模仿耗费 0.45M±0.50M 'gas'（参见图 7）。作为参考，在撰写本文时，以太坊采用了动态区块耗气量限制，平均耗气量为 29.77M。在已识别的历史交易中，APE 的最大气体消耗量为 23.11M，低于以太坊的平均块 'gas' 限制。平均而言，对抗性合约部署占攻击气体消耗的 48.42%。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/0zsz8m.jpg\" alt=\"图 7：以太坊上的 APE 每次攻击平均消耗 0.98M±0.74M 瓦斯，而天真模仿攻击消耗 0.45M±0.50M 瓦斯。然而，对 BSC 的天真模仿攻击的平均耗气量（1.74M±4.44B）高于 APE 攻击（1.64M±0.64B）\" /></p>\n<p>平均而言，BSC 的区块 'gas' 限额高于（8 266 万）以太坊，这就为模拟提供了更大的空间。我们发现，APE（1.64M±0.64B）和天真模仿（1.74M±4.44B）在 BSC 上的平均耗气量都较高。对抗性合约部署在 BSC 上的平均耗气量是 APE 耗气量的 53.04%。与以太坊相反，BSC 上的天真模仿平均耗气量高于 APE。因此，我们分析了耗气量超过 3M 的 82192 笔天真的模仿交易。去除 80291 个异常值后，BSC 上天真的模仿交易的平均耗气量为 0.48M±0.55M 。</p>\n<p><strong>对抗性合约</strong>：平均而言，一次 APE 攻击需要在以太坊上替换 1.02 ± 0.15 个合约，在 BSC 上替换 1.05 ± 0.23 个合约。我们发现，与被替换的受害者合约相比，每个合成的对手合约平均小 60.95 ± 19.19%（以字节为单位）（参见表 4）。由于 APE 可能会用合成代码扩展受害方合约，我们还观察到了 - 295.56% 的负缩减，即最坏情况下增加了 295.56%。在 BSC 上，合约大小的平均缩减率为 57.59 ± 18.69%，最大缩减率为 613.33%。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/ctmgft.png\" alt=\"表 4：对抗性合约统计。APE 在以太坊和 BSC 上最多创建 3 个对抗性合约，平均值分别为 1.02 和 1.05\" /></p>\n<h2 id=\"historical-analysis\"><a class=\"anchor\" href=\"#historical-analysis\">#</a> Historical Analysis</h2>\n<p>为了从 APE 的成功中获得启示，我们对以太坊和 BSC 上收益最高的前 100 名 APE 受害者进行了人工投资，分别获得了 1.1343 亿美元（83.97%）和 2727 万美元（92.60%）的利润。表 5 列示了整体的跨行动和利润分配情况。接下来，我们将概述研究结果的细节</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/66ipl1.png\" alt=\"表 5：以太坊和 BSC 上收益最高的前 100 名 APE 受害者的交易和利润分布。我们未能对 31 个 BSC 受害者交易进行分类\" /></p>\n<p><strong>已知的 DeFi 攻击和漏洞</strong>：在以太坊上，APE 发现了与 13 个已知 DeFi 攻击相对应的 17 个黑帽交易和 12 个宣称的白帽交易，总共获利 7374 万美元。最易被 APE 攻击的交易 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ldGhlcnNjYW4uaW8vdHgvMHhjZDdkYWUxNDNhNGMwMjIzMzQ5YzE2MjM3Y2U0Y2Q3Njk2YjE2MzhkMTE2YTcyNzU1MjMxZWRlODcyYWI3MGZj\">0xcd7d...70fc</span> 是对 Popsicle Finance 智能合约的 DeFi 攻击，产生了 2,025 万美元的 APE 利润。请注意，该 APE 利润低于报告的攻击利润，因为我们将 APE 的收益转换为 ETH。交易所可能会产生过多的滑点，尤其是对于较高的金额。</p>\n<p>我们检测到两笔交易可能与已披露的两个合约漏洞有关。交易 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ldGhlcnNjYW4uaW8vdHgvMHgyZTdkN2U3YTZlYjE1N2I5ODk3NGM4Njg3ZmJkODQ4ZDAxNThkMzdlZGMxMzAyZWEwOGVlNWRkYjM3NmJlZmVh\">0x2e7d..efea</span> 和 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ldGhlcnNjYW4uaW8vdHgvMHhlMTJhZTAxNWM4MDIzYmJlNjQwNTY2MmEzZGRmNWU4ZTEwNmU3ZjYyNTVlOTA1YjczMTJkY2Y2NWIyN2Q3NTVj\">0xe12a..755c</span> 分别涉及 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmF1Y3R1cy5vcmcvYWN0aW9uLXJlcXVpcmVkLWNyaXRpY2FsLXZ1bG5lcmFiaWxpdHktM2Q0NDhkNGQwZGNi\">Auctus ACOWriter</span> 漏洞和 <span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2l0dGVyLmNvbS9wZWNrc2hpZWxkL3N0YXR1cy8xNTA5MDA5NzQ2NzQ0OTgzNTU2\">BMIZapper</span> 漏洞中报告的受害者合约。但是，我们无法找到披露这些交易公开信息的合同执行者。</p>\n<p>在 BSC 上，APE 共捕获了 22 次 DeFi 攻击，涉及 40 笔交易，共产生了 2239 万美元的仿冒利润。</p>\n<p>表 8 和表 9（附录 C）概述了已识别的 DeFi 攻击和漏洞的详情。请注意，对于每笔攻击交易，我们都会检查 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ldGhlcnNjYW4uaW8v\">etherscan.io</span> 是否观察到 P2P 网络上的攻击。如果 etherscan 无法监测到 P2P 网络上的攻击，那么攻击很可能是私下传播给矿工（如 FaaS）的。我们发现，在 12 次白帽攻击交易中，有 10 次（对应 6 次攻击）是私下传播给矿工的。白帽黑客可能出于两个目的而选择私人通信渠道：</p>\n<ol>\n<li>加快链上白帽交易的包含速度；</li>\n<li>减少模仿攻击的可能性。</li>\n</ol>\n<p><strong>新发现的漏洞</strong>：APE 发现了五个未关闭的漏洞。在这些漏洞中，最有利可图的漏洞名为  <code>massDeposit</code> ，在以太坊和 BSC 上分别产生了 2858 万美元和 759.54 万美元的总利润。下文将介绍  <code>massDeposit</code>  漏洞的案例研究，其他新发现漏洞的详情见附录 C。</p>\n<p><em>责任披露</em>：在撰写本报告时，所有已发现的漏洞都已没有可用资金。然而，尽管存在危险，新用户可能会在不知情的情况下与这些合同进行交互。因此，我们选择通过专门的区块链消息服务（<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jaGF0LmJsb2Nrc2Nhbi5jb20vc3RhcnQ=\">Blockscan Chat</span> by Etherscan）来联系有漏洞的智能合约。不幸的是，我们发现的所有易受攻击的合约都是匿名部署的，没有明显的方法可以识别这些合约背后的实体或个人。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/9arfvr.png\" alt=\"清单 2：APE 易受攻击的存款人合约，任何人都可以调用 massDeposit() 函数并提出一份金库合约。我们的评估结果表明，APE 可能会给该合约造成 2,858 万美元的潜在损失\" /></p>\n<p><em> <code>massDeposit</code>  案例研究</em>： <code>massDeposit</code>  漏洞的前身是以太坊上的一个  <code>Depositer</code>  合约（<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ldGhlcnNjYW4uaW8vYWRkcmVzcy8weGUyYzA3MWUxRTE5NTdBNjJmRERmMDE5OTAxOGUwNjFlYkZEM2FjMkM=\">0xe2c071e1E1957A62fDDf0199018e061ebFD3ac2C</span>）（参见清单 2）。我们发现，由于以下漏洞细节，存入的资金可能是通过 APE 攻击盗取的。存款人合约的  <code>massDeposit()</code>  函数以金库为参数，金库是接收存款人合约全部资金的合约（参见图 8a）。任何人都可以调用  <code>massDeposit()</code>  函数，并且提供一个任意的金库合约地址。然后，允许保险库从存款人账户中收取资产。最后，存款人调用金库的  <code>setOwner()</code>  函数，试图配置金库的所有权。当观察到这样的大量存款交易时，APE 的处理员 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">A</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{A}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\">A</span></span></span></span></span> 会将 vault 识别为受益人账户。然后，APE 会自动合成一份对抗合约，重新放置 vault 合约（参见图 8b）。回顾一下，在合成受益人合约时，APE 注入了在模仿交易结束前将所有收集的资产转移到对抗账户的逻辑。值得注意的是，即使没有 APE，攻击者也可以手动制作一份敌对金库合约，恶意提取存款人的资产。因此，我们将这一通道设计归类为漏洞。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/hb2t0v.png\" alt=\"图 8：MassDeposit 漏洞\" /></p>\n<h1 id=\"ape-real-time-evaluation\"><a class=\"anchor\" href=\"#ape-real-time-evaluation\">#</a> APE Real-time Evaluation</h1>\n<p>理想情况下，支持 APE 的矿工会尝试实时确定其开采区块的最佳交易顺序。因此，在给定一个未确认交易列表的情况下，矿工可以应用每一种交易组合来确定 APE 的最佳收益。然而，探索这些组合很快就会导致组合爆炸。</p>\n<p>因此，我们将为矿工的交易排序提出一个更现实、但也更尽力的解决方案。我们可以借鉴被广泛采用的假设，即在一个区块链区块中，交易通常按其费用金额排序。因此，在按费用排序的列表中，我们知道对于受害者交易 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">v_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，APE 交易也应该被放在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.65952em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span> 的位置。虽然 EVM 目前只支持交易的顺序执行，但投机并行执行的前景可观，可以加快区块验证以及 APE 中的受害者交易识别。不过，这种并行执行框架超出了本文的研究范围。</p>\n<h2 id=\"methodology-and-setup-2\"><a class=\"anchor\" href=\"#methodology-and-setup-2\">#</a> Methodology and Setup</h2>\n<p>为了评估实时性能，我们将 APE 逻辑注入一个以太坊（BSC）完整节点，称为 APE 节点。APE 节点监听以太坊（BSC）P2P 网络，并对每笔潜在的受害者交易进行 APE 操作，同时不公布生成的攻击交易。重复评估过程将当前区块链高度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">h</span></span></span></span> 和内存池 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">P</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{P}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\" style=\"margin-right:0.08222em;\">P</span></span></span></span></span> 作为输入（参见算法 1）。我们首先排除 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">P</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{P}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\" style=\"margin-right:0.08222em;\">P</span></span></span></span></span> 中的非法交易（例如，nonce 编号错误的交易），并按 'gas' 价格降序对产生的交易进行排序。然后，我们在当前区块链状态上依次应用排序后的交易。给定每一对中间状态 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">S_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>（应用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{i}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 后）和后续交易 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{i+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8234109999999999em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span>，APE 节点异步执行攻击函数 Ape (<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>S</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">S_i,\\mathrm{tx}_{i+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.891661em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span>)，并以非阻塞方式继续执行下一对 (<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>S</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator=\"true\">,</mo><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mrow><mi>i</mi><mo>+</mo><mn>2</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">S_{i+1},\\mathrm{tx}_{i+2}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.891661em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span>)。如果事务 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 是可攻击的，我们就用生成的攻击事务替换（即 &quot;前置运行&quot;）<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{v}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。该流水线对应于对抗式矿工：</p>\n<ol>\n<li>从内存池中选择并排序交易；</li>\n<li>按顺序应用每个交易以构建下一个区块</li>\n<li>在适用时执行 APE 攻击。APE 节点重复这一过程，并记录以下指标的性能。</li>\n</ol>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/6ma8ol.png\" alt=\"算法 1\" /></p>\n<p><mark>指标 1</mark>（单次交易性能）。在给定一个受害者交易和相应区块链状态的情况下，APE 生成攻击所需的时间（参见算法 1）。</p>\n<p><mark>指标 2</mark>（内存池性能）。考虑到实时交易的动态内存池，从 APE 攻击生成到下一个区块（即应包含 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">x</mi></mrow><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{tx}_{c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">t</span><span class=\"mord mathrm\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的目标区块）到达的时间（参见算法 1）。</p>\n<p>我们使用与第 6 节相同的硬件设置和 10 Gbps 的互联网连接进行实时评估。为了迅速捕获待处理交易，我们将 APE 节点的最大网络对等节点从默认的 50 个增加到 500 个，用于以太坊和 BSC。APE 节点会生成 150 个线程，异步执行 Ape 函数（参见算法 1）。</p>\n<p><strong>较弱的威胁模型</strong>：请注意，与第 4.1 节中的威胁模型相反，在本节中，我们不是矿工。此外，我们与 FaaS 没有私人对等协议，因此可能无法观察到只有启用了 FaaS 的矿工才会收到的受害者交易。与之前的威胁模型相比，我们的 APE 节点观察受害者交易的对抗能力较弱。因此，在实时评估中，我们选择关注 APE 在实际应用中的计算实时性能，而忽略 APE 节点在较弱的威胁模型下可能产生的潜在经济利润。我们预计较弱的威胁模型会获得较低的利润，因此将此类分析留待今后的工作中进行。</p>\n<h2 id=\"computational-real-time-performance\"><a class=\"anchor\" href=\"#computational-real-time-performance\">#</a> Computational Real-time Performance</h2>\n<p>我们的以太坊实时实验捕获了 26 天的数据。在实验期间，以太坊 APE 节点平均每秒重新接收 17.86 次独特交易。我们总共检测到 4,045 次模仿机会，其中包括 3,699 次容易受到 APE 攻击的交易。BSC 实时评估的时间跨度为 14 天。我们的 BSC APE 节点平均每秒接收 57.31 次独特交易。我们在 BSC 上识别出 489 个模仿机会和 784 个 APE 机会。</p>\n<p>表 6 列出了单笔交易性能（参见指标 1）和执行时间明细。平均而言，生成一次天真模仿攻击需要 0.01 ± 0.01 秒，而生成一次 APE 攻击需要 0.07 ± 0.10 秒。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/awztx8.png\" alt=\"表 6：原始攻击和 APE 模仿攻击的单笔交易性能（以太坊）。步骤 1、3 和 6 平均占 APE 执行时间的 96.35%。APE 在 BSC 上的单次交易性能相当\" /></p>\n<p>APE 最耗时的步骤是 DCFG（第 1 步）、动态污点分析（第 3 步）和验证（第 6 步），占整个执行时间的 96.35%。</p>\n<p>我们在图 9 中展示了 mempool 性能（参见指标 2）。在以太坊（BSC）上，99.68%（99.49%）的 APE 攻击是在我们的 APE 节点收到目标块之前生成的。从攻击产生到接收到目标块的时间平均为 12.56 ± 12.55 (2.24 ± 0.81) 秒。我们的评估结果表明，以太坊上的 APE（区块间隔为 13.3 秒）和 BSC（区块间隔为 3 秒）具有实时性。</p>\n<h1 id=\"ape-countermeasures\"><a class=\"anchor\" href=\"#ape-countermeasures\">#</a> APE Countermeasures</h1>\n<p>模仿攻击对 DeFi 生态系统及其用户构成了迫在眉睫的威胁。与 EVM 兼容的区块链依赖矿工来执行和验证每笔交易。因此，很难完全防止矿工检查和模仿受害者交易。我们认为以下对策有可能减轻 APE。</p>\n<p><strong>将模仿作为一种防御工具</strong>：一种可能直观但有效的替代方法是将模仿作为一种防御机制。例如，矿工可以通过简单地模仿攻击并将收益退还给受害者的方式，对 DeFi 攻击进行自动白帽黑客攻击。虽然矿工目前被信任来确保区块链共识的安全，但他们可以扩展这种能力到应用层。漏洞悬赏可以激励矿工的利他主义。不过，我们将精确的激励结构留待今后的工作中去探索。</p>\n<p><strong>打破原子性</strong>：打破有利可图的事务的原子性会阻碍 APE，也就是说，用户可以将其事务的逻辑分割成多个独立的事务。这样，APE 就无法捕捉到任何独立交易的全部逻辑，也就无法对其进行模仿。此外，这种防御可以通过一种工具来实现，它可以将单个事务作为输入，并自动将其拆分成具有相同程序逻辑的多个事务。这种方法的主要缺点是不适用于所有情况（如闪存贷款）。打破原子性还可能给用户带来额外风险（例如，部分套利执行导致财务损失）。</p>\n<p><strong>前置运行缓解</strong>：APE 要求攻击者必须能够前置运行受害者交易，因此缓解前置运行可以防止 APE 攻击。文献探讨了各种基于时间的交易排序公平性的前置运行缓解方案。虽然这些公平排序解决方案原则上可以将 APE 的威胁最小化，但它们需要对共识层或应用层进行根本性修改。特别是，[1] 需要对底层区块链进行修改，而 [2, 3] 则引入了一个负责交易排序的额外许可委员会，并需要重新设计 DeFi 应用程序。</p>\n<blockquote>\n<p>[1] Mahimna Kelkar, Fan Zhang, Steven Goldfeder, and Ari Juels. Order- fairness for byzantine consensus. In <em>Annual International Cryptology Conference</em>, pages 451–480. Springer, 2020.</p>\n<p>[2] MahimnaKelkar,SoubhikDeb,SishanLong,AriJuels,andSreeram Kannan. Themis: Fast, strong order-fairness in byzantine consensus. <em>Cryptology ePrint Archive</em>, 2021.</p>\n<p>[3] Yunhao Zhang, Srinath Setty, Qi Chen, Lidong Zhou, and Lorenzo Alvisi. Byzantine ordered consensus without byzantine oligarchy. In <em>14th USENIX Symposium on Operating Systems Design and Implemen- tation (OSDI 20)</em>, pages 633–649, 2020.</p>\n</blockquote>\n<p><strong>代码混淆</strong>：成熟的区块链和 DeFi 应用程序并不容易打补丁和重新设计。在以更系统的方式减少前置运行之前，需要轻量级的变通方法。因此，解决这一问题的一个可行办法是开发字节码级混淆技术。虽然代码混淆作为一种防御机制已经使用了几十年，但还没有人把它作为智能合约攻击和漏洞的对策来研究。可以采用控制流混淆方法，其目的是模糊程序流程，使动态分析难以推理代码。回想一下，为了复制执行路径，APE 会修改受污染的基本模块，并对代码跳转进行硬编码（参见第 5.5 节）。如果在一个受害者事务中同时访问了污点基本块的真分支和假分支，合成对抗性合约就会变得很困难，因为硬编码跳转只能访问一个分支。因此，可以设计一种针对 APE 的混淆方案，使硬编码的代码跳转导致无限循环。尽管混淆技术易于采用，并能提供针对 APE 的可靠保护，但它们仍有局限性。主要问题是，可以开发出复杂的去混淆技术来绕过这些防御。混淆防御也会导致合同更加复杂，增加执行和部署 'gas' 的成本。我们将完整的设计和评估工作留待今后进行。</p>\n<h1 id=\"related-work\"><a class=\"anchor\" href=\"#related-work\">#</a> Related Work</h1>\n<p><strong>漏洞利用工具系统化</strong>：我们在表 7 中对最接近的相关工作进行了系统化，重点关注自动漏洞利用生成工具。我们将它们区分为：</p>\n<ol>\n<li>旨在获取金融价值并捕捉该过程中漏洞的工具；</li>\n<li>检测智能合约中预定义漏洞模式的工具。</li>\n</ol>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/fpuznu.png\" alt=\"表 7：自动智能合约开发相关工作的系统化\" /></p>\n<p>对于基于奖励的漏洞利用工具，我们发现，由于字符串替换方法简单，天真模仿法在实时性能方面优于 APE。不过，在相同的评估时间范围内（参见第 6 节），APE 比天真的方法捕获了更高的经济收益和更多的 DeFi 攻击。 <code>DEFIPOSER</code>  利用 SMT 解算器来识别有利可图的策略，这些策略有可能揭示新的漏洞模式。然而， <code>DEFIPOSER</code>  的有效性依赖于区块链应用的精确建模，这需要大量的人工努力。值得注意的是， <code>DEFIPOSER</code>  的实时性能取决于底层 SMT 解算器以及数学模型的复杂性。</p>\n<p>在智能合约中检测预定义漏洞模式的工具将这些模式作为进行安全分析的输入。因此，这类工具可能不会发现不同的或新的漏洞模式。然而， <code>MAIAN</code>  和  <code>SOLAR</code>  的设计具有实时性。在 APE 之前， <code>SOLAR</code>  是我们所知的唯一能合成合约的工具。不过， <code>SOLAR</code>  需要访问智能合约的 ABI。回顾一下，闭源智能合约可能无法访问 ABI。据我们了解，SOLAR 专注于单个合约中的漏洞，因此不太可能捕捉到可组合（即跨合约）的 DeFi 攻击。</p>\n<p><strong>智能合约攻击与安全</strong>：Atzei 等人对智能合约攻击进行了调查。许多人都专注于通过检测漏洞和生成恶意输入来自动寻找针对脆弱智能合约的漏洞利用。Qin 等人探索了通过闪贷进行 DeFi 攻击。Wu 等人提出了一种独立于平台的方法来恢复高级 DeFi 语义，以检测价格操纵攻击。</p>\n<p><em>静态分析</em>：工具如  <code>Securify</code>  、 <code>Slither</code>  和  <code>Ethainter</code> ，可检测智能合约中的特定漏洞。这类工具通常能实现完整性，但也会报告误报。另一种检测智能合约漏洞的常见方法是采用符号执行。Mythril 和 Oyente 使用基于 SMT 的符号执行来检查 EVM 字节代码，并模拟虚拟机来探索执行路径。其他工具采用模糊技术检测各种漏洞。APE 不采用模糊技术，而是利用 EVM 来一次性动态分析智能合约。最近， <code>SMARTSHIELD</code>  和  <code>sGuard</code>  对用于修补智能合约的字节码重写进行了探索。 <code>EVMPATCH</code>  可以集成多种静态分析工具来检测漏洞，并自动完成部署和管理可升级合约的整个生命周期。</p>\n<h1 id=\"conclusion\"><a class=\"anchor\" href=\"#conclusion\">#</a> Conclusion</h1>\n<p>广义区块链模仿游戏是对智能合约区块链的一类新攻击。采用这种模仿既可能是为了自私的结果，例如，采用 APE 的矿工可以从 DeFi 攻击中获得价值数百万美元的收益；也可能是为了更好的结果，矿工可以作为白帽黑客帮助捍卫 DeFi 生态系统，方法是预先运行攻击，并可能将由此获得的收益退还给受害者。在这项工作中，我们证明了这种模仿游戏是切实可行的，并能在以太坊和 BSC 上产生巨大价值。</p>\n<div class=\"note warning no-icon\">\n<p>附录部分请参考原论文🙏</p>\n</div>\n",
            "tags": [
                "科研",
                "论文阅读",
                "区块链",
                "论文阅读"
            ]
        },
        {
            "id": "https://gality.cn/misc/trail-and-error/RTX4080-tensorflow2/",
            "url": "https://gality.cn/misc/trail-and-error/RTX4080-tensorflow2/",
            "title": "在 RTX 4080 上运行 tensorflow 2",
            "date_published": "2023-12-06T08:58:35.000Z",
            "content_html": "<div class=\"note info no-icon\">\n<ul>\n<li>\n<p><strong>bug 背景</strong>：原本项目使用的是 tensorflow 的 2.1 的版本，该项目在 RTX 1660 上可以正常运行，只是将显卡换到了 RTX 4080 上就运行失败了，所以肯定是显卡（环境）的原因。</p>\n</li>\n<li>\n<p><strong>实际原因</strong>：根据搜集到的资料和项目的报错提示来看，2.1 版本的 tf 还不知道有 4080 这种显卡的存在，所以才会无法识别，导致各种问题，因此，想解决这个问题，是<strong>一定要升级 tf 的版本</strong>的。</p>\n</li>\n<li>\n<p><strong>解决方案</strong>：这里给出一个可以在 4080 上运行的版本：</p>\n<ul>\n<li>python：3.6.x（任意小版本）</li>\n<li>tensorflow：2.6.0</li>\n<li>CUDA：11.2.2（win10 版本也可用于 win11 系统）</li>\n<li>cuDNN：8.1.1</li>\n<li>Keras：2.6（如果需要的话）</li>\n</ul>\n</li>\n</ul>\n</div>\n<h1 id=\"cuda\"><a class=\"anchor\" href=\"#cuda\">#</a> CUDA</h1>\n<p><strong>下载直链</strong>：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubnZpZGlhLmNvbS9jdWRhLXRvb2xraXQtYXJjaGl2ZQ==\">https://developer.nvidia.com/cuda-toolkit-archive</span></p>\n<p>安装过程没有太多好说的，教程也非常多，这里稍微说点不常见的：</p>\n<p><strong>最好安装在默认路径</strong></p>\n<p>原因在于会涉及到环境变量的配置，大多数教程给出的都是默认的环境变量地址，如果不熟悉的话，安装在默认位置会剩一点力气。</p>\n<p>安装完成后需要添加以下环境变量：</p>\n<pre><code class=\"language-bat\">- CUDA_BIN_PATH_v11.2 = %CUDA_PATH%\\bin\n- CUDA_LIB_PATH_v11.2 = %CUDA_PATH%\\lib\\x64\n- CUDA_SDK_PATH = C:\\ProgramData\\NVIDIA Corporation\\CUDA Samples\\v11.2\n- CUDA_SDK_BIN_PATH = %CUDA_SDK_PATH%\\bin\\win64\n- CUDA_SDK_LIB_PATH = %CUDA_SDK_PATH%\\common\\lib\\x64\n</code></pre>\n<ol>\n<li>\n<p>这里的 <code>CUDA_SDK_PATH</code>  后的环境变量其实就是默认安装地址，若不是默认地址，这里需要修改为实际的安装地址，其他不用变。</p>\n</li>\n<li>\n<p>如果运行时代码报错一堆 dll 找不到，可能就是环境变量没刷新的问题，重启下终端看能不能解决（实在不行就重启电脑，最保险～）</p>\n</li>\n</ol>\n<h1 id=\"cudnn\"><a class=\"anchor\" href=\"#cudnn\">#</a> cuDNN</h1>\n<p><strong>下载直链</strong>：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubnZpZGlhLmNvbS9yZHAvY3Vkbm4tYXJjaGl2ZQ==\">https://developer.nvidia.com/rdp/cudnn-archive</span></p>\n<p>下载：cuDNN v8.1.1 for CUDA 11.0,11.1 and 11.2 版本</p>\n<p>同样不多说了，教程很多。</p>\n<h1 id=\"tensorflow\"><a class=\"anchor\" href=\"#tensorflow\">#</a> Tensorflow</h1>\n<p>tensorflow 建议在 conda 那安装，可以用 anaconda，也可以是 miniconda，这个无所谓，这里假设你已经有了相关知识。</p>\n<pre><code class=\"language-bat\">conda create -n tensorflow2 python=3.6\nconda activate tensorflow2\n\npip install tensorflow-gpu==2.6.0 -i https://pypi.tuna.tsinghua.edu.cn/simple\n</code></pre>\n<p>可以通过以下方式来测试是否成功安装：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 在交互式 python 终端中输入：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> tensorflow <span class=\"token keyword\">as</span> tf</pre></td></tr></table></figure><p>加载可能比较慢，但若没有任何报错，那就是成功安装了。</p>\n<p>至此，就应该可以调用 4080 来跑 tensorflow 的代码了～</p>\n",
            "tags": [
                "杂项",
                "踩坑",
                "机器学习",
                "杂项",
                "踩坑",
                "tensorflow2"
            ]
        },
        {
            "id": "https://gality.cn/misc/course/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%8D%E4%B9%A0%E8%A6%81%E7%82%B9/",
            "url": "https://gality.cn/misc/course/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%8D%E4%B9%A0%E8%A6%81%E7%82%B9/",
            "title": "网络安全复习要点",
            "date_published": "2023-11-24T07:32:12.000Z",
            "content_html": "<h1 id=\"网络安全复习要点\"><a class=\"anchor\" href=\"#网络安全复习要点\">#</a> 网络安全复习要点</h1>\n<h2 id=\"第一章\"><a class=\"anchor\" href=\"#第一章\">#</a> 第一章</h2>\n<h3 id=\"掌握信息安全的四个目标\"><a class=\"anchor\" href=\"#掌握信息安全的四个目标\">#</a> 掌握信息安全的四个目标</h3>\n<ul>\n<li>保密性</li>\n<li>完整性</li>\n<li>可用性</li>\n<li>合法使用</li>\n</ul>\n<h3 id=\"信息系统中常见的威胁有哪些\"><a class=\"anchor\" href=\"#信息系统中常见的威胁有哪些\">#</a> 信息系统中常见的威胁有哪些？</h3>\n<ul>\n<li>\n<p>🌟<strong>基本威胁</strong>：信息泄露、完整性破坏、拒绝服务、非法使用</p>\n</li>\n<li>\n<p><strong>主要的可实现威胁</strong>：</p>\n<ul>\n<li>渗入威胁：假冒攻击、旁路控制、授权侵犯</li>\n<li>植入威胁：特洛伊木马、陷门</li>\n</ul>\n</li>\n<li>\n<p><strong>潜在威胁</strong>：网络窃听、流量分析、操作人员不慎导致信息泄漏、媒体废弃物导致信息泄漏</p>\n</li>\n</ul>\n<h3 id=\"什么是安全策略安全策略分几个等级\"><a class=\"anchor\" href=\"#什么是安全策略安全策略分几个等级\">#</a> 什么是安全策略？安全策略分几个等级？</h3>\n<ul>\n<li>\n<p><strong>安全策略</strong>：某个<strong>安全域</strong>内施加给所有与<strong>安全相关活动</strong>的一套<strong>规则</strong>。</p>\n</li>\n<li>\n<p><strong>安全域</strong>：属于某个组织机构的一系列处理进程和通信资源</p>\n</li>\n<li>\n<p><strong>安全策略等级</strong>：</p>\n<ul>\n<li><strong>安全策略目标</strong>：机构对所保护资源要达到的安全目标而进行的描述</li>\n<li><strong>机构安全策略</strong>：对机构的资源进行保护，以达到安全策略规定目标</li>\n<li><strong>系统安全策略</strong>：在信息系统工程实现时，要支持该机构的安全策略</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"什么是访问控制策略它分为哪两类有何不同\"><a class=\"anchor\" href=\"#什么是访问控制策略它分为哪两类有何不同\">#</a> 什么是访问控制策略？它分为哪两类？有何不同？</h3>\n<ul>\n<li>\n<p><strong>访问控制策略</strong>：访问控制策略隶属于<strong>系统级安全策略</strong>，它迫使计算机系统和网络<strong>自动地执行授权</strong>。</p>\n</li>\n<li>\n<p><strong>分类</strong>：</p>\n<ul>\n<li><strong>强制性访问控制策略</strong>：由操作<strong>系统内核强制</strong>实施<strong>授权</strong>规则，<strong>检查</strong>主体的安全属性，并决定是否可以<strong>访问</strong>。</li>\n<li><strong>自主性访问控制策略</strong>：由客体的<strong>属主</strong>对自己的客体进行管理，由属主决定是否将自己的<strong>客体访问权</strong>或<strong>部分访问权授予</strong>其他主体。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"安全攻击分几大类常见的攻击形式有哪些\"><a class=\"anchor\" href=\"#安全攻击分几大类常见的攻击形式有哪些\">#</a> 安全攻击分几大类？常见的攻击形式有哪些？</h3>\n<ul>\n<li><strong>安全攻击分两大类</strong>：\n<ul>\n<li><strong>被动攻击</strong>：窃听攻击、流量分析</li>\n<li><strong>主动攻击</strong>：伪装攻击、重放攻击、消息篡改、拒绝服务</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"熟记x800标准中的5类安全服务和8种特定安全机制并简述安全服务与安全机制之间的关系\"><a class=\"anchor\" href=\"#熟记x800标准中的5类安全服务和8种特定安全机制并简述安全服务与安全机制之间的关系\">#</a> 🌟熟记 X.800 标准中的 5 类安全服务和 8 种特定安全机制，并简述安全服务与安全机制之间的关系。</h3>\n<p><strong>五类安全服务</strong>：</p>\n<ul>\n<li>认证</li>\n<li>访问控制</li>\n<li>数据保密性</li>\n<li>数据完整性</li>\n<li>不可否认性</li>\n<li>（可用性服务）</li>\n</ul>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/6fwls5.png\" alt=\"安全服务与安全机制的关系\" /></p>\n<p>安全服务通过安全机制实现安全策略</p>\n<h3 id=\"能够理解并画出网络安全模型和网络访问模型\"><a class=\"anchor\" href=\"#能够理解并画出网络安全模型和网络访问模型\">#</a> 能够理解并画出网络安全模型和网络访问模型。</h3>\n<ul>\n<li>\n<p><strong>网络安全模型</strong></p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/x6779c.png\" alt=\"网络安全模型\" /></p>\n</li>\n<li>\n<p><strong>网络访问安全模型</strong></p>\n</li>\n</ul>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/x5wx3k.png\" alt=\"网络访问安全模型\" /></p>\n<h2 id=\"第二章\"><a class=\"anchor\" href=\"#第二章\">#</a> 第二章</h2>\n<h3 id=\"熟记osi的七层参考模型-tcpip的四层模型\"><a class=\"anchor\" href=\"#熟记osi的七层参考模型-tcpip的四层模型\">#</a> 熟记 OSI 的七层参考模型、TCP/IP 的四层模型</h3>\n<ul>\n<li>\n<p><strong>OSI 七层</strong>：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/v6uv8g.png\" alt=\"OSI体系结构参考模型\" /></p>\n</li>\n<li>\n<p><strong>TCP/IP 四层</strong>：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/po4p9x.png\" alt=\"TCP/IP体系结构参考模型\" /></p>\n</li>\n</ul>\n<h3 id=\"什么是面向连接的服务什么是无连接的服务\"><a class=\"anchor\" href=\"#什么是面向连接的服务什么是无连接的服务\">#</a> 什么是面向连接的服务？什么是无连接的服务？</h3>\n<ul>\n<li>\n<p><strong>面向连接的服务</strong>：</p>\n<p>面向连接的服务要求通信双方在<strong>传输数据之前首先建立连接</strong>。数据传输过程包括<strong>建立连接</strong>、<strong>传输数据</strong>和释放连接三个阶段。在 Internet 中，TCP 协议提供面向连接的服务， 为应用程序提供可靠的端到端字节流服务。为保证传输层服务的可靠性与稳定性，TCP 协议提供<strong>检错、重传、流量控制和拥塞控制</strong>等许多功能。</p>\n</li>\n<li>\n<p><strong>无连接的服务</strong>：</p>\n<p>无连接的服务不要求通信双方在传输数据之前建立连接，是 “<strong>尽力传递</strong>”（Best-effort Delivery）的服务。在 Internet 中，IP 协议和 UDP 协议提供的都是无连接的服务。IP 不提供差错检查或者追踪，它尽最大努力使传输数据到达目标，但是并不提供任何服务质量保证。同理，UDP 没有拥塞控制，也不提供可靠交付。无连接的服务也叫数据报服务， 因此通常将 IP 协议的协议数据单元称为 IP 数据报，将 UDP 协议的协议数据单元称为 UDP 数据报。</p>\n</li>\n</ul>\n<h3 id=\"必须知道ipv4及ipv6地址的格式及长度\"><a class=\"anchor\" href=\"#必须知道ipv4及ipv6地址的格式及长度\">#</a> 必须知道 IPv4 及 IPv6 地址的格式及长度</h3>\n<ul>\n<li><strong>IPv4</strong>：32 位； 192.168.1.1</li>\n<li><strong>IPv6</strong>：128 位； 1234:0000:0000:33ff:bbff:aaee:00aa:2233</li>\n</ul>\n<p>IPv6 将 128 位地址按每 16 位分割，每个段用 16 进制数字表示</p>\n<h3 id=\"必须知道mac地址的长度\"><a class=\"anchor\" href=\"#必须知道mac地址的长度\">#</a> 必须知道 MAC 地址的长度</h3>\n<ul>\n<li><strong>MAC</strong>：48 位</li>\n</ul>\n<h3 id=\"ip地址与mac地址转换靠哪个网络协议\"><a class=\"anchor\" href=\"#ip地址与mac地址转换靠哪个网络协议\">#</a> IP 地址与 MAC 地址转换靠哪个网络协议？</h3>\n<ul>\n<li><strong>ARP 协议</strong></li>\n</ul>\n<h3 id=\"ipv4的地址分哪几类给定一个ip地址要能够分析判断出该地址属于哪一类地址\"><a class=\"anchor\" href=\"#ipv4的地址分哪几类给定一个ip地址要能够分析判断出该地址属于哪一类地址\">#</a> IPv4 的地址分哪几类？给定一个 IP 地址，要能够分析判断出该地址属于哪一类地址</h3>\n<ul>\n<li>\n<p>IPv4 地址划分为<strong> 5</strong> 类：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/kbnj9j.png\" alt=\"IP地址的类型\" /></p>\n</li>\n<li>\n<p><strong>特殊地址</strong>：</p>\n<ul>\n<li>网络地址：<strong>主机号全 0</strong>，用来指明某个特定网络。</li>\n<li>直接广播地址：<strong>主机号全 1、网络号不为 0</strong>，表示一个物理网络上的所有主机。</li>\n<li>有限广播地址：<strong>32 位全 1</strong>，向主机所在网络广播，（系统启动时不知道网络号）</li>\n<li>本机地址：<strong>32 位全 0</strong>，拨号上网时暂代本机地址</li>\n</ul>\n</li>\n<li>\n<p><strong>判定 IP 地址类别</strong>（以 192.168.1.1 为例）：</p>\n<ol>\n<li>192 转换为二进制为 1100 0000</li>\n<li>查表知 110 开头为 C 类地址</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"给定一个ipv4地址和子网掩码要求能够计算出网络地址\"><a class=\"anchor\" href=\"#给定一个ipv4地址和子网掩码要求能够计算出网络地址\">#</a> 给定一个 IPv4 地址和子网掩码，要求能够计算出网络地址</h3>\n<p><strong>例题</strong>：已知 IP 地址 202.112.64.19，子网掩码 255.255.255.240，则 IP 地址 202.11264.19 的二进制形式为</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mn>11000010</mn><mspace width=\"1em\"/><mn>01110000</mn><mspace width=\"1em\"/><mn>01000000</mn><mspace width=\"1em\"/><mn>00010011</mn></mrow><annotation encoding=\"application/x-tex\">11000010 \\quad 01110000 \\quad 01000000 \\quad 00010011\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">1</span></span></span></span></span></p>\n<p>子网掩码 255.255.255.240 的二进制形式为</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mn>11111111</mn><mspace width=\"1em\"/><mn>11111111</mn><mspace width=\"1em\"/><mn>11111111</mn><mspace width=\"1em\"/><mn>11110000</mn></mrow><annotation encoding=\"application/x-tex\">11111111 \\quad 11111111 \\quad 11111111 \\quad 11110000\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span></p>\n<p>上面两式进行逐位 “与” 运算，得出网络地址为</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mn>11000010</mn><mspace width=\"1em\"/><mn>01110000</mn><mspace width=\"1em\"/><mn>01000000</mn><mspace width=\"1em\"/><mn>00010000</mn></mrow><annotation encoding=\"application/x-tex\">11000010 \\quad 01110000 \\quad 01000000 \\quad 00010000\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span></p>\n<p>换算回十进制，可得该网络地址的为</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mn>202.112.64.16</mn></mrow><annotation encoding=\"application/x-tex\">202.112.64.16\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">2</span><span class=\"mord\">.</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">2</span><span class=\"mord\">.</span><span class=\"mord\">6</span><span class=\"mord\">4</span><span class=\"mord\">.</span><span class=\"mord\">1</span><span class=\"mord\">6</span></span></span></span></span></p>\n<h3 id=\"熟悉cidr的表示方法如1281432020表示的地址块范围和子网掩码是什么\"><a class=\"anchor\" href=\"#熟悉cidr的表示方法如1281432020表示的地址块范围和子网掩码是什么\">#</a> 熟悉 CIDR 的表示方法，如：128.14.32.0/20 表示的地址块范围和子网掩码是什么？</h3>\n<p><span class=\"primary\">唯一的重点：地址块范围不包含 host-id 为全 0 和全 1 的两个地址</span></p>\n<ul>\n<li>\n<p><strong>CIDR 表示方法</strong>： <code>128.14.32.0/20</code> ，前面是 IP 地址，后面是网络号位数</p>\n</li>\n<li>\n<p>以 <code>128.14.32.0/20</code>  为例：</p>\n<ol>\n<li>\n<p><strong>子网掩码</strong>：20 即子网掩码前 20 位为 1，所以二进制为：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mn>11111111</mn><mspace width=\"1em\"/><mn>11111111</mn><mspace width=\"1em\"/><mn>11110000</mn><mspace width=\"1em\"/><mn>00000000</mn></mrow><annotation encoding=\"application/x-tex\">11111111 \\quad 11111111 \\quad 11110000 \\quad 00000000\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span></p>\n<p>对应十进制为：255.255.240.0</p>\n</li>\n<li>\n<p><strong>地址块范围</strong>：就是 IP 的主机位全 0 和全 1 的范围（<strong>其实是抛去全 0 和全 1</strong>，因为这两个是特殊地址），即：</p>\n<ul>\n<li>起始 IP 地址：</li>\n</ul>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mn>10000000</mn><mspace width=\"1em\"/><mn>00001110</mn><mspace width=\"1em\"/><mn>00100000</mn><mspace width=\"1em\"/><mn>00000001</mn></mrow><annotation encoding=\"application/x-tex\">10000000 \\quad 00001110 \\quad 00100000 \\quad 00000001\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span></span></span></span></span></p>\n<ul>\n<li>结束 IP 地址</li>\n</ul>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mn>10000000</mn><mspace width=\"1em\"/><mn>00001110</mn><mspace width=\"1em\"/><mn>00101111</mn><mspace width=\"1em\"/><mn>11111110</mn></mrow><annotation encoding=\"application/x-tex\">10000000 \\quad 00001110 \\quad 00101111 \\quad 11111110\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">0</span></span></span></span></span></p>\n<p>即地址块对应的十进制为：128.14.32.1 ～ 128.14.47.254</p>\n</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"什么是端口号端口号在网络通信中起什么作用\"><a class=\"anchor\" href=\"#什么是端口号端口号在网络通信中起什么作用\">#</a> 什么是 “端口号”？“端口号” 在网络通信中起什么作用？</h3>\n<ul>\n<li>\n<p>“<strong>端口号</strong>” 是按照应用进程的<strong>功能</strong>对应用进程实行的<strong>标识</strong>，主要作用是表示一台计算机中的特定进程所提供的服务，长度为 16 位。</p>\n</li>\n<li>\n<p>在通信过程中，<strong>端口号</strong>和<strong> IP 地址</strong>绑定使用，形成的<strong>标识</strong>称为<strong>插口</strong>，在网络中<strong>唯一</strong>对应某个主机的某个进程。</p>\n</li>\n</ul>\n<h2 id=\"第三章\"><a class=\"anchor\" href=\"#第三章\">#</a> 第三章</h2>\n<h3 id=\"熟记httpftptelnetpop3smtpimapsshdns等常用通信协议的功能及端口号\"><a class=\"anchor\" href=\"#熟记httpftptelnetpop3smtpimapsshdns等常用通信协议的功能及端口号\">#</a> 熟记 http/ftp/telnet/pop3/smtp/imap/ssh/dns 等常用通信协议的功能及端口号</h3>\n<ul>\n<li><strong>http</strong>（80）：超文本传输协议，是一个客户端和服务器端请求和应答的标准，是互联网上应用最广泛的一种网络协议。</li>\n<li><strong>ftp</strong>（传输 20 / 控制 21）：文件传输协议，Internet 文件传送的基础，是 TCP/IP 协议族的重要协议之一。</li>\n<li><strong>telnet</strong>（23）：远程登录协议，Internet 远程登录服务的标准协议和主要方式。</li>\n<li><strong>pop3</strong>（110）：邮局协议，邮件协议的第三个版本。</li>\n<li><strong>smtp</strong>（25）：简单邮件传输协议，是一组用于由源地址到目的地址传送邮件的规则，由它来控制信件的中转方式。</li>\n<li><strong>imap4</strong>（143，993）：邮件访问协议，采用 “挑战 / 响应” 实现用户认证，功能更强大。</li>\n<li><strong>ssh</strong>（22）：安全壳协议，一种在不安全的网络上建立安全的远程登录或其他安全网络服务的协议。</li>\n<li><strong>dns</strong>（UDP53）：域名系统是一个分布式数据库系统，用来实现域名和 IP 地址之间的映射。</li>\n</ul>\n<h3 id=\"网际层协议有哪些传输层协议有哪些应用层协议有哪些\"><a class=\"anchor\" href=\"#网际层协议有哪些传输层协议有哪些应用层协议有哪些\">#</a> 网际层协议有哪些？传输层协议有哪些？应用层协议有哪些？</h3>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/uytewn.png\" alt=\"TCP/IP协议族不同层次划分\" /></p>\n<ul>\n<li><strong>网际层</strong>：IP、ARP、ICMP 等</li>\n<li><strong>传输层</strong>：TCP、UDP 等</li>\n<li><strong>应用层</strong>：HTTP、SMTP、POP3、FTP 等</li>\n</ul>\n<h3 id=\"为什么要进行网络地址转换nat\"><a class=\"anchor\" href=\"#为什么要进行网络地址转换nat\">#</a> 为什么要进行网络地址转换（NAT）？</h3>\n<p>解决 IPv4 地址短缺问题。</p>\n<h3 id=\"arp协议的作用是什么\"><a class=\"anchor\" href=\"#arp协议的作用是什么\">#</a> ARP 协议的作用是什么？</h3>\n<p>将局域网中的 IP 地址转化为对应的物理地址（MAC 地址）。</p>\n<h3 id=\"为什么udp比tcp协议更加容易遭到攻击\"><a class=\"anchor\" href=\"#为什么udp比tcp协议更加容易遭到攻击\">#</a> 为什么 UDP 比 TCP 协议更加容易遭到攻击？</h3>\n<p>因为 UDP 没有交换握手信息和序号的过程。</p>\n<h3 id=\"imap协议与pop3协议相比它的安全性有哪些提升\"><a class=\"anchor\" href=\"#imap协议与pop3协议相比它的安全性有哪些提升\">#</a> IMAP 协议与 POP3 协议相比，它的安全性有哪些提升？</h3>\n<ul>\n<li>支持用户对服务器的远程加密访问</li>\n<li>采用 “挑战 / 响应” 机制实现用户认证</li>\n</ul>\n<h3 id=\"ssh协议与telnet协议相比它的安全性有哪些提升\"><a class=\"anchor\" href=\"#ssh协议与telnet协议相比它的安全性有哪些提升\">#</a> SSH 协议与 Telnet 协议相比，它的安全性有哪些提升？</h3>\n<ul>\n<li>提供多种身份认证和数据加密机制</li>\n<li>对所有传输数据进行加密处理</li>\n<li>采用 “挑战 / 响应” 机制替代传统的主机名和口令认证</li>\n</ul>\n<h3 id=\"什么是icmp重定向攻击如何防止此类攻击\"><a class=\"anchor\" href=\"#什么是icmp重定向攻击如何防止此类攻击\">#</a> 什么是 ICMP 重定向攻击？如何防止此类攻击？</h3>\n<ul>\n<li>\n<p><strong>重定向攻击</strong>：攻击者可以利用 ICMP 对消息进行重定向，使得目标机器按照攻击者的信息来<strong>修改路由表</strong>，遭受<strong>连接劫持</strong>和<strong>拒绝服务</strong>等攻击。</p>\n</li>\n<li>\n<p>防护：重定向消息应该仅由产生消息的主机或路由器执行，网管员不应使用 ICMP 创建通往目的地的新路由，应该<strong>禁用 ICMP 协议</strong>或<strong>配置防火墙</strong>的安全策略来预防攻击。</p>\n</li>\n</ul>\n<h3 id=\"在网络中为什么不能仅仅靠识别数据包的ip地址来判断一个数据包就是来自该-ip地址的主机\"><a class=\"anchor\" href=\"#在网络中为什么不能仅仅靠识别数据包的ip地址来判断一个数据包就是来自该-ip地址的主机\">#</a> 在网络中，为什么不能仅仅靠识别数据包的 IP 地址，来判断一个数据包就是来自该 IP 地址的主机？</h3>\n<p>IP 层不能保证 IP 数据报一定是从源地址发送的。攻击者可伪装成另一网络主机，发送含有<strong>伪造源地址</strong>的数据包欺骗接受者。此攻击称为<strong> IP 欺骗攻击</strong>。</p>\n<h2 id=\"第四章\"><a class=\"anchor\" href=\"#第四章\">#</a> 第四章</h2>\n<h3 id=\"按照对明文消息的处理方式不同单钥体制可分为哪两类\"><a class=\"anchor\" href=\"#按照对明文消息的处理方式不同单钥体制可分为哪两类\">#</a> 按照对明文消息的处理方式不同，单钥体制可分为哪两类？</h3>\n<ul>\n<li>分组密码</li>\n<li>流密码</li>\n</ul>\n<h3 id=\"古典密码中的两个常用的变换是什么\"><a class=\"anchor\" href=\"#古典密码中的两个常用的变换是什么\">#</a> 古典密码中的两个常用的变换是什么？</h3>\n<ul>\n<li>置换（扩散）</li>\n<li>代换（混淆）</li>\n</ul>\n<h3 id=\"什么是理论上安全什么是计算上安全理论上安全的密码算法有几个理论上安全的密码是什么密码\"><a class=\"anchor\" href=\"#什么是理论上安全什么是计算上安全理论上安全的密码算法有几个理论上安全的密码是什么密码\">#</a> 什么是理论上安全？什么是计算上安全？理论上安全的密码算法有几个？理论上安全的密码是什么密码？</h3>\n<ul>\n<li><strong>计算上安全</strong>：满足以下两条标准中任意一条就称为计算上安全\n<ul>\n<li>破译密码的代价超出密文信息的价值</li>\n<li>破译密码的时间超出密文信息的有效生命期</li>\n</ul>\n</li>\n<li><strong>理论上安全</strong>（无条件安全）：假定攻击者拥有无限的计算资源，无论有多少可使用的密文，都不足以唯一地确定密文所对应的明文</li>\n<li>只有<strong>一次一密</strong>是理论上安全的</li>\n</ul>\n<h3 id=\"什么是同步流密码-自同步流密码流密码的安全性取決于什么\"><a class=\"anchor\" href=\"#什么是同步流密码-自同步流密码流密码的安全性取決于什么\">#</a> 什么是同步流密码、自同步流密码？流密码的安全性取決于什么？</h3>\n<ul>\n<li><strong>同步流密码</strong>：密钥流独立于明文的流密码</li>\n<li><strong>自同步流密码</strong>：密钥流与明文有关的流密码</li>\n<li>流密码的安全性<strong>完全依赖于伪随机数的强度</strong></li>\n</ul>\n<h3 id=\"des分组长度-密钥长度-轮数是多少1轮加密包括哪些变换des中的非线性变换是什么变换\"><a class=\"anchor\" href=\"#des分组长度-密钥长度-轮数是多少1轮加密包括哪些变换des中的非线性变换是什么变换\">#</a> DES 分组长度、密钥长度、轮数是多少？1 轮加密包括哪些变换？DES 中的非线性变换是什么变换？</h3>\n<h3 id=\"aes分组长度-密钥长度-轮数是多少1轮加密包括哪些变换aes中包含的非线性变换是什么变换\"><a class=\"anchor\" href=\"#aes分组长度-密钥长度-轮数是多少1轮加密包括哪些变换aes中包含的非线性变换是什么变换\">#</a> AES 分组长度、密钥长度、轮数是多少？1 轮加密包括哪些变换？AES 中包含的非线性变换是什么变换？</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">加密算法</th>\n<th style=\"text-align:center\">分组长度</th>\n<th style=\"text-align:center\">密钥长度</th>\n<th style=\"text-align:center\">轮数</th>\n<th style=\"text-align:center\">一轮加密算法</th>\n<th style=\"text-align:center\">非线性变换</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">DES</td>\n<td style=\"text-align:center\">64</td>\n<td style=\"text-align:center\">56</td>\n<td style=\"text-align:center\">16</td>\n<td style=\"text-align:center\">E 盒置换 + 轮密钥加 + S 盒代换 + P 盒置换 + 左右分组交换</td>\n<td style=\"text-align:center\">S 盒置换</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">AES</td>\n<td style=\"text-align:center\">128</td>\n<td style=\"text-align:center\">128/192/256</td>\n<td style=\"text-align:center\">10/12/14</td>\n<td style=\"text-align:center\">字节代换、行移位、列混淆、轮密钥加</td>\n<td style=\"text-align:center\">字节代换 + 列混淆</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"加密轮数是否越多越好密钥是否越长越好将2个算法串联对数据加密是否一定更安全\"><a class=\"anchor\" href=\"#加密轮数是否越多越好密钥是否越长越好将2个算法串联对数据加密是否一定更安全\">#</a> 加密轮数是否越多越好？密钥是否越长越好？将 2 个算法串联对数据加密，是否一定更安全？</h3>\n<ul>\n<li>加密轮数<span class=\"primary\">不</span>是越多越好</li>\n<li>密钥<span class=\"primary\">不</span>是越长越好</li>\n<li>两个算法串联<span class=\"primary\">不</span>一定更安全</li>\n</ul>\n<h3 id=\"分组密码的5种工作模式是什么能画出5种工作模式的原理框图\"><a class=\"anchor\" href=\"#分组密码的5种工作模式是什么能画出5种工作模式的原理框图\">#</a> 🌟分组密码的 5 种工作模式是什么？能画出 5 种工作模式的原理框图。</h3>\n<ul>\n<li>\n<p>ECB</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/yeeu38.png\" alt=\"ECB\" /></p>\n</li>\n<li>\n<p>CBC</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/zoxgx5.png\" alt=\"CBC\" /></p>\n</li>\n<li>\n<p>CFB</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/3rcj5c.png\" alt=\"CFB\" /></p>\n</li>\n<li>\n<p>OFB</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/e1v87j.png\" alt=\"OFB\" /></p>\n</li>\n<li>\n<p>CTR<br />\n<img data-src=\"http://imgcdn.gality.cn/blog/ao17gm.png\" alt=\"CTR\" /></p>\n</li>\n</ul>\n<h3 id=\"分析5种加密模式中哪些加密模式没有误码扩展哪些有误码扩展如果有误码扩展-会影响多少个分组\"><a class=\"anchor\" href=\"#分析5种加密模式中哪些加密模式没有误码扩展哪些有误码扩展如果有误码扩展-会影响多少个分组\">#</a> 分析 5 种加密模式中，哪些加密模式没有误码扩展？哪些有误码扩展？如果有误码扩展， 会影响多少个分组？</h3>\n<ul>\n<li>误码扩展：密文中<strong> 1bit</strong> 错误会影响解密的明文中<strong>多 bit</strong> 错误</li>\n<li><strong>无误码扩展</strong>：OFB、CTR</li>\n<li><strong>有误码扩展</strong>：ECB、CBC、CFB</li>\n<li><strong>错误传播影</strong>响的分组：\n<ul>\n<li>ECB 影响 1 个分组，即当前分组。</li>\n<li>CBC 影响 2 个分组，即当前分组和下个分组（的 1bit）。</li>\n<li>CFB 影响 2 个分组，即当前分组（的 1bit）和下个分组。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"了解中国商用分组密码算法sm4知道它的分组长度-密钥长度和加密轮数\"><a class=\"anchor\" href=\"#了解中国商用分组密码算法sm4知道它的分组长度-密钥长度和加密轮数\">#</a> 了解中国商用分组密码算法 SM4，知道它的分组长度、密钥长度和加密轮数。</h3>\n<ul>\n<li><strong>分组长度</strong>：128 位</li>\n<li><strong>密钥长度</strong>：128 位</li>\n<li><strong>轮数</strong>：32 轮</li>\n</ul>\n<h2 id=\"第五章\"><a class=\"anchor\" href=\"#第五章\">#</a> 第五章</h2>\n<h3 id=\"双钥密码体制是基于数学难题构造的请列举出目前存在的数学难题\"><a class=\"anchor\" href=\"#双钥密码体制是基于数学难题构造的请列举出目前存在的数学难题\">#</a> 双钥密码体制是基于数学难题构造的，请列举出目前存在的数学难题</h3>\n<ul>\n<li>多项式求根</li>\n<li>离散对数</li>\n<li>大整数分解</li>\n<li>背包问题</li>\n<li>D-H 问题</li>\n<li>二次剩余问题</li>\n<li>模 n 的平方根问题</li>\n</ul>\n<h3 id=\"用双钥体制加密时采用谁的公钥解密时采用谁的私钥\"><a class=\"anchor\" href=\"#用双钥体制加密时采用谁的公钥解密时采用谁的私钥\">#</a> 用双钥体制加密时采用谁的公钥？解密时采用谁的私钥？</h3>\n<p>加密采用接收方的公钥，解密时采用接收方的私钥</p>\n<h3 id=\"rsa是基于何种数学难题构造的diffie-hellman是基于何种数学难题构造的\"><a class=\"anchor\" href=\"#rsa是基于何种数学难题构造的diffie-hellman是基于何种数学难题构造的\">#</a> RSA 是基于何种数学难题构造的？Diffie-Hellman 是基于何种数学难题构造的？</h3>\n<p><strong>RSA</strong>：基于大整数分解的困难性</p>\n<p><strong>Diffie-Hellman</strong>：基于 Diffie-Hellman 问题</p>\n<h3 id=\"请写出rsa加密和解密的数学表达式并指出什么是公钥什么是私钥并能做简单的加密和解密计算\"><a class=\"anchor\" href=\"#请写出rsa加密和解密的数学表达式并指出什么是公钥什么是私钥并能做简单的加密和解密计算\">#</a> 🌟请写出 RSA 加密和解密的数学表达式，并指出什么是公钥，什么是私钥？并能做简单的加密和解密计算</h3>\n<ul>\n<li><strong>公钥</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi><mo separator=\"true\">,</mo><mi>e</mi></mrow><annotation encoding=\"application/x-tex\">n, e</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">e</span></span></span></span></li>\n<li><strong>私钥</strong>： <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">d</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">d</span></span></span></span></li>\n<li><strong>加密</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mo>→</mo><mi>c</mi><mo>=</mo><msup><mi>m</mi><mi>e</mi></msup><mtext> </mtext><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">m \\rightarrow c = m^e \\space mod \\space n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">m</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">e</span></span></span></span></span></span></span></span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">n</span></span></span></span></li>\n<li><strong>解密</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mo>→</mo><mi>m</mi><mo>=</mo><msup><mi>c</mi><mi>d</mi></msup><mtext> </mtext><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">c \\rightarrow m = c^d \\space mod \\space n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.849108em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.849108em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">d</span></span></span></span></span></span></span></span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">n</span></span></span></span></li>\n</ul>\n<p><strong>简单的加解密计算</strong>：</p>\n<ul>\n<li></li>\n</ul>\n<h3 id=\"rsa在各种参数选择上有哪些原则和限制为什么\"><a class=\"anchor\" href=\"#rsa在各种参数选择上有哪些原则和限制为什么\">#</a> RSA 在各种参数选择上有哪些原则和限制？为什么？</h3>\n<ul>\n<li><strong>n 的选取</strong>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span> 、<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span> 必须是强素数，否则存在一种可以简单分解 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 的算法</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span> 、<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span> 之差要大，否则容易推测出<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span> 、<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span></li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">p-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7777700000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 、<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">q-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7777700000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 的最大公因子要小，否则唯密文攻击下容易算出明文</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span> 、<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span> 要足够大，来使暴力分解 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 在计算上不可行。</li>\n</ul>\n</li>\n<li><strong>e 的选取</strong>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi></mrow><annotation encoding=\"application/x-tex\">e</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">e</span></span></span></span> 不可过小，否则容易遭受低指数攻击</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi></mrow><annotation encoding=\"application/x-tex\">e</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">e</span></span></span></span> 要与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>φ</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\varphi (n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">φ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 互素，否则模 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>φ</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\varphi (n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">φ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 下 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi></mrow><annotation encoding=\"application/x-tex\">e</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">e</span></span></span></span> 的逆元不存在。</li>\n</ul>\n</li>\n<li><strong>d 的选取</strong>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">d</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">d</span></span></span></span> 要大于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>n</mi><mfrac><mn>1</mn><mn>4</mn></mfrac></msup></mrow><annotation encoding=\"application/x-tex\">n^{1\\over 4}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9540200000000001em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9540200000000001em;\"><span style=\"top:-3.363em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mopen nulldelimiter sizing reset-size3 size6\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8443142857142858em;\"><span style=\"top:-2.656em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">4</span></span></span></span><span style=\"top:-3.2255000000000003em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line mtight\" style=\"border-bottom-width:0.049em;\"></span></span><span style=\"top:-3.384em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.344em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter sizing reset-size3 size6\"></span></span></span></span></span></span></span></span></span></span></span></span></span>，否则容易由已知明文攻击</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"写出eigamal密码体制是基于何种数学难题请写出它的加密表达式和解密表达式\"><a class=\"anchor\" href=\"#写出eigamal密码体制是基于何种数学难题请写出它的加密表达式和解密表达式\">#</a> 写出 EIGamal 密码体制是基于何种数学难题？请写出它的加密表达式和解密表达式？</h3>\n<ul>\n<li>基于<strong>有限域上离散对数问题</strong></li>\n<li><strong>加密</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mo>→</mo><mo stretchy=\"false\">(</mo><msup><mi>g</mi><mi>k</mi></msup><mo separator=\"true\">,</mo><mi>m</mi><msup><mi>β</mi><mi>k</mi></msup><mo stretchy=\"false\">)</mo><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mi>p</mi><mo>=</mo><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo stretchy=\"false\">)</mo><mo>=</mo><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">m \\rightarrow (g^k,m\\beta^k)mod \\space p = (y_1,y_2) = c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.099108em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.849108em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">β</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.849108em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span></span></span></span></li>\n<li><strong>解密</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mo>=</mo><msub><mi>y</mi><mn>2</mn></msub><msubsup><mi>y</mi><mn>1</mn><mrow><mo>−</mo><mi>a</mi></mrow></msubsup><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">m = y_2 y_1^{-a}mod \\space p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0777700000000001em;vertical-align:-0.266308em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.811462em;\"><span style=\"top:-2.433692em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.1031310000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mathnormal mtight\">a</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.266308em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">p</span></span></span></span></li>\n</ul>\n<h3 id=\"ecc公钥密码基于何种数学难题写出ecc公钥密码体制的加密表达式和解密表达式\"><a class=\"anchor\" href=\"#ecc公钥密码基于何种数学难题写出ecc公钥密码体制的加密表达式和解密表达式\">#</a> 🌟ECC 公钥密码基于何种数学难题？写出 ECC 公钥密码体制的加密表达式和解密表达式</h3>\n<ul>\n<li>基于<strong>椭圆曲线离散对数问题</strong></li>\n<li kG,=\"\" m+kP_b=\"\" \\=\"\"><strong>加密</strong>：C = \\{C_1,C_2\\} = \\</li>\n<li><strong>解密</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mo>=</mo><mo stretchy=\"false\">(</mo><mi>m</mi><mo>+</mo><mi>k</mi><msub><mi>P</mi><mi>B</mi></msub><mo stretchy=\"false\">)</mo><mo>−</mo><msub><mi>n</mi><mi>b</mi></msub><mo stretchy=\"false\">(</mo><mi>k</mi><mi>G</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m = (m +kP_B)-n_b(kG) = m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">m</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">b</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\">G</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span></li>\n</ul>\n<h3 id=\"写出基于ecc的diffie-hellman密钥交换协议\"><a class=\"anchor\" href=\"#写出基于ecc的diffie-hellman密钥交换协议\">#</a> 写出基于 ECC 的 Diffie-Hellman 密钥交换协议。</h3>\n<ol>\n<li>A 选择一小于 n 的整数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>n</mi><mi>A</mi></msub></mrow><annotation encoding=\"application/x-tex\">n_A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">A</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 作为私钥， 由 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mi>A</mi></msub><mo>=</mo><msub><mi>n</mi><mi>A</mi></msub><mi>G</mi></mrow><annotation encoding=\"application/x-tex\">P_A = n_AG</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">A</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">A</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">G</span></span></span></span> 产生 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>E</mi><mi>p</mi></msub><mo stretchy=\"false\">(</mo><mi>a</mi><mo separator=\"true\">,</mo><mi>b</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">E_p(a,b)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">a</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mclose\">)</span></span></span></span> 上的一点作为公钥。</li>\n<li>B 选取自己的私钥 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>n</mi><mi>B</mi></msub></mrow><annotation encoding=\"application/x-tex\">n_B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> ， 并计算自己的公钥 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mi>B</mi></msub><mo>=</mo><msub><mi>n</mi><mi>B</mi></msub><mi>G</mi></mrow><annotation encoding=\"application/x-tex\">P_B = n_BG</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">G</span></span></span></span> 。</li>\n<li>A 可以获得 B 得公钥 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mi>B</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li>B 可以获得 A 的公钥 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mi>A</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">A</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li>A 计算：$ K = n_A \\times P_B = n_An_BG$</li>\n<li>B 计算：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi><mo>=</mo><msub><mi>n</mi><mi>B</mi></msub><mo>×</mo><msub><mi>P</mi><mi>A</mi></msub><mo>=</mo><msub><mi>n</mi><mi>A</mi></msub><msub><mi>n</mi><mi>B</mi></msub><mi>G</mi></mrow><annotation encoding=\"application/x-tex\">K = n_B \\times P_A = n_An_BG</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.73333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">A</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">A</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">G</span></span></span></span></li>\n</ol>\n<h3 id=\"rsa和ecc公钥密码算法在加密-解密速度上有何差异请查阅资料比较它们分别采用硬件和软件实现时的加密和解密速度\"><a class=\"anchor\" href=\"#rsa和ecc公钥密码算法在加密-解密速度上有何差异请查阅资料比较它们分别采用硬件和软件实现时的加密和解密速度\">#</a> RSA 和 ECC 公钥密码算法在加密、解密速度上有何差异？请查阅资料，比较它们分别采用硬件和软件实现时的加密和解密速度。</h3>\n<p>在达到同等安全性需求时，ECC 具有更短的密钥长度，虽然计算更复杂，但加密速度更快。</p>\n<p>无论硬件还是软件，ECC 都比 RSA 快！</p>\n<h3 id=\"对公钥密码的攻击有哪些常见的攻击方式它们各有什么特点\"><a class=\"anchor\" href=\"#对公钥密码的攻击有哪些常见的攻击方式它们各有什么特点\">#</a> 对公钥密码的攻击有哪些常见的攻击方式？它们各有什么特点？</h3>\n<ul>\n<li><strong>选择明文攻击（CPA）</strong>：攻击者选择明文并得到相应密文。</li>\n<li><strong>选择密文攻击（CCA）</strong>：攻击者选择密文并得到解密消息。</li>\n<li><strong>适应性选择密文攻击（CCA2）</strong>：攻击者在 CCA 的基础上，永远可以获得解密服务</li>\n</ul>\n<p><strong>注意</strong>：在 CCA 和 CCA2 中，攻击者<strong>不能</strong>直接解密<strong>目标密文</strong>。</p>\n<h3 id=\"了解中国的商用公钥密码算法sm2\"><a class=\"anchor\" href=\"#了解中国的商用公钥密码算法sm2\">#</a> 了解中国的商用公钥密码算法 SM2</h3>\n<ul>\n<li>一组基于<strong>椭圆曲线</strong>的公钥密码算法</li>\n<li>包含<strong>加解密算法、数字签名算法和密钥交换协议</strong></li>\n<li>采取了检错措施，提高了系统的数据完整性和可靠性<br />\n推荐使用<strong> 256 位</strong>素数域上的椭圆曲线<br />\n涉及<strong> 3 类</strong>辅助函数：杂凑函数、密钥派生函数、随机数发生器</li>\n</ul>\n<h2 id=\"第六章\"><a class=\"anchor\" href=\"#第六章\">#</a> 第六章</h2>\n<h3 id=\"请说明hash函数与加密函数有何不同\"><a class=\"anchor\" href=\"#请说明hash函数与加密函数有何不同\">#</a> 请说明 Hash 函数与加密函数有何不同？</h3>\n<ul>\n<li>hash 函数生成定长的消息摘要，加密函数生成的密文长度和明文长度有关</li>\n<li>hash 算法不可逆，加密函数可逆</li>\n</ul>\n<h3 id=\"杂凑函数具有哪些性质\"><a class=\"anchor\" href=\"#杂凑函数具有哪些性质\">#</a> 杂凑函数具有哪些性质？</h3>\n<ol>\n<li><strong>快速性</strong>：由 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 计算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>H</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">H(x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span> 容易</li>\n<li><strong>单向性</strong>：由 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>H</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">H(x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span> 计算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 困难</li>\n<li><strong>无碰撞</strong>：寻找 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo mathvariant=\"normal\">≠</mo><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">x_1 \\ne x_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\"><span class=\"mrel\"><span class=\"mord vbox\"><span class=\"thinbox\"><span class=\"rlap\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"inner\"><span class=\"mrel\"></span></span><span class=\"fix\"></span></span></span></span></span><span class=\"mrel\">=</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> ，使 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>H</mi><mo stretchy=\"false\">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy=\"false\">)</mo><mo>=</mo><mi>H</mi><mo stretchy=\"false\">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">H(x_1) = H(x_2)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 困难</li>\n</ol>\n<h3 id=\"什么是消息认证码mac如何构造\"><a class=\"anchor\" href=\"#什么是消息认证码mac如何构造\">#</a> 什么是消息认证码 MAC？如何构造？</h3>\n<ul>\n<li><strong>MAC</strong>：有密钥参与杂凑运算的算法</li>\n<li><strong>构造方法</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>M</mi><mi>A</mi><mi>C</mi><mo>=</mo><mi>H</mi><mo stretchy=\"false\">(</mo><mi>m</mi><mi mathvariant=\"normal\">∣</mi><mi mathvariant=\"normal\">∣</mi><mi>k</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">MAC = H(m||k)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">m</span><span class=\"mord\">∣</span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mclose\">)</span></span></span></span></li>\n</ul>\n<h3 id=\"在不知道密钥的情况下如何对mac算法成功实施攻击167页\"><a class=\"anchor\" href=\"#在不知道密钥的情况下如何对mac算法成功实施攻击167页\">#</a> 在不知道密钥的情况下，如何对 MAC 算法成功实施攻击？（167 页）</h3>\n<ul>\n<li>穷举</li>\n<li>构造</li>\n<li>碰撞</li>\n<li>差分分析</li>\n<li>密码分析</li>\n</ul>\n<h3 id=\"如何采用hash函数和分组加密算法构造mac\"><a class=\"anchor\" href=\"#如何采用hash函数和分组加密算法构造mac\">#</a> 如何采用 Hash 函数和分组加密算法构造 MAC？</h3>\n<ul>\n<li><strong>Hash 函数</strong>构造方法：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>M</mi><mi>A</mi><mi>C</mi><mo>=</mo><mi>H</mi><mo stretchy=\"false\">(</mo><mi>m</mi><mi mathvariant=\"normal\">∣</mi><mi mathvariant=\"normal\">∣</mi><mi>k</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">MAC = H(m||k)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">m</span><span class=\"mord\">∣</span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mclose\">)</span></span></span></span>。</li>\n<li><strong>分组加密算法</strong>构造方法：对消息 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> 进行分组并填充为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi></mrow><annotation encoding=\"application/x-tex\">l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span></span></span></span> 个组，设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>C</mi><mn>0</mn></msub><mo>=</mo><mi>I</mi><mi>V</mi></mrow><annotation encoding=\"application/x-tex\">C_0 = IV</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span></span></span></span> 为随机初始向量，发送者用 CBC 加密：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub><mo>←</mo><msub><mi>E</mi><mi>k</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>m</mi><mi>i</mi></msub><mo>⊕</mo><msub><mi>C</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">C_i \\leftarrow E_k(m_i \\oplus C_{i-1})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">m</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> ，数值对 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>I</mi><mi>V</mi><mo separator=\"true\">,</mo><msub><mi>C</mi><mi>l</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(IV, C_l)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 作为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> 的 MAC。</li>\n</ul>\n<h3 id=\"什么是消息检测码或消息摘要mdc简述mdc与mac的异同\"><a class=\"anchor\" href=\"#什么是消息检测码或消息摘要mdc简述mdc与mac的异同\">#</a> 什么是消息检测码（或消息摘要）MDC？简述 MDC 与 MAC 的异同。</h3>\n<ul>\n<li><strong>MDC</strong>：无密钥参与杂凑运算的算法</li>\n<li><strong>异同</strong>：\n<ul>\n<li>同：二者都可以检测消息的完整性</li>\n<li>异：MAC 带有身份认证，MDC 不带有身份认证</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"熟悉迭代杂凑函数的构造方法\"><a class=\"anchor\" href=\"#熟悉迭代杂凑函数的构造方法\">#</a> 熟悉迭代杂凑函数的构造方法</h3>\n<ul>\n<li><strong>Rabin 法</strong></li>\n<li><strong>CBC 法</strong></li>\n<li><strong>CFB 法</strong></li>\n<li><strong>修正 Daveis-Meyer 法</strong></li>\n<li><strong>组合明 / 密文链接法</strong></li>\n</ul>\n<h3 id=\"md5的明文输入分组长度-字长-输出长度是多少位\"><a class=\"anchor\" href=\"#md5的明文输入分组长度-字长-输出长度是多少位\">#</a> MD5 的明文输入分组长度、字长、输出长度是多少位？</h3>\n<ul>\n<li><strong>分组长度</strong>：512 位</li>\n<li><strong>字长</strong>：32 位</li>\n<li><strong>输出长度</strong>：128 位</li>\n</ul>\n<h3 id=\"sha-1的明文输入分组长度-字长-输出长度是多少位\"><a class=\"anchor\" href=\"#sha-1的明文输入分组长度-字长-输出长度是多少位\">#</a> SHA-1 的明文输入分组长度、字长、输出长度是多少位？</h3>\n<ul>\n<li><strong>分组长度</strong>：512 位</li>\n<li><strong>字长</strong>：32 位</li>\n<li><strong>输出长度</strong>：160 位</li>\n</ul>\n<h3 id=\"掌握应用杂凑函数的基本方式熟悉图6-1-6-2-6-5-6-6所能够提供的安全功能\"><a class=\"anchor\" href=\"#掌握应用杂凑函数的基本方式熟悉图6-1-6-2-6-5-6-6所能够提供的安全功能\">#</a> 掌握应用杂凑函数的基本方式，熟悉图 6-1、6-2、6-5、6-6 所能够提供的安全功能。</h3>\n<ul>\n<li>\n<p><strong>应用杂凑函数的基本方式</strong></p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/ovctrc.png\" alt=\"应用杂凑函数的基本方式\" /></p>\n</li>\n<li>\n<p><strong>消息加密的基本用途</strong></p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/qifhdg.png\" alt=\"消息加密的基本用途\" /></p>\n</li>\n<li>\n<p><strong>内部和外部错误控制</strong></p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/52u4jm.png\" alt=\"内部和外部错误控制\" /></p>\n</li>\n<li>\n<p><strong>MAC 的基本用途</strong></p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/7y2p9e.png\" alt=\"MAC的基本用途\" /></p>\n</li>\n</ul>\n<h3 id=\"熟悉中国商用杂凑函数sm3的构造\"><a class=\"anchor\" href=\"#熟悉中国商用杂凑函数sm3的构造\">#</a> 熟悉中国商用杂凑函数 SM3 的构造</h3>\n<ul>\n<li>SM3 采用<strong> Merkle-Damgard 结构</strong></li>\n<li><strong>分组长度</strong>：512 位</li>\n<li><strong>输出长度</strong>：256 位</li>\n</ul>\n<h2 id=\"第七章\"><a class=\"anchor\" href=\"#第七章\">#</a> 第七章</h2>\n<h3 id=\"数字签名应该具有哪些性质\"><a class=\"anchor\" href=\"#数字签名应该具有哪些性质\">#</a> 数字签名应该具有哪些性质？</h3>\n<ul>\n<li>收方能证实签名，但不能伪造（R1 - 条件）</li>\n<li>收方已收到后不能否认（收报认证）（R2 - 条件）</li>\n<li>发方不能否认签发的消息（S - 条件）</li>\n<li>第三方可以确认双方的消息发送，但不能伪造（T - 条件）</li>\n</ul>\n<h3 id=\"数字签名可以分为哪几类\"><a class=\"anchor\" href=\"#数字签名可以分为哪几类\">#</a> 数字签名可以分为哪几类？</h3>\n<ul>\n<li>按照<strong>消息是否被压缩</strong>分类\n<ul>\n<li>对<strong>整体消息</strong>签名</li>\n<li>对<strong>压缩的消息</strong>签名</li>\n</ul>\n</li>\n<li>🌟按照<strong>消息 / 签名的对应关系</strong>分类\n<ul>\n<li><strong>确定性</strong>签名</li>\n<li><strong>随即化</strong>签名</li>\n</ul>\n</li>\n<li>按照<strong>参与方式</strong>分类\n<ul>\n<li>直接签名</li>\n<li>仲裁签名</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"rsa签名是基于何种数学难题\"><a class=\"anchor\" href=\"#rsa签名是基于何种数学难题\">#</a> RSA 签名是基于何种数学难题？</h3>\n<p>大合数分解困难问题</p>\n<h3 id=\"eigamal签名是基于何种数学难题请写出eigamal的签名方程\"><a class=\"anchor\" href=\"#eigamal签名是基于何种数学难题请写出eigamal的签名方程\">#</a> EIGamal 签名是基于何种数学难题？请写出 EIGamal 的签名方程。</h3>\n<ul>\n<li>\n<p><strong>基于</strong>：离散对数问题</p>\n</li>\n<li>\n<p><strong>签名过程</strong>：</p>\n<ol>\n<li>给定消息 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> ，选择随机数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi><mo>∈</mo><msubsup><mi mathvariant=\"double-struck\">Z</mi><mi>p</mi><mo>∗</mo></msubsup></mrow><annotation encoding=\"application/x-tex\">k \\in \\mathbb{Z}^*_p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.73354em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.071998em;vertical-align:-0.383108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathbb\">Z</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.688696em;\"><span style=\"top:-2.4530000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">∗</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span></span></span></span>，使 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>k</mi><mo>≤</mo><mi>p</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1\\le k \\le p-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.78041em;vertical-align:-0.13597em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83041em;vertical-align:-0.13597em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7777700000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy=\"false\">(</mo><mi>k</mi><mo separator=\"true\">,</mo><mi>p</mi><mo>−</mo><mn>1</mn><mo stretchy=\"false\">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">gcd(k, p-1)=1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">d</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span></li>\n<li>计算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>H</mi><mo stretchy=\"false\">(</mo><mi>m</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">H(m)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">m</span><span class=\"mclose\">)</span></span></span></span></li>\n<li>计算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi><mo>≡</mo><msup><mi>g</mi><mi>k</mi></msup><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">r \\equiv g^k mod \\space p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.46375em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≡</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.043548em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.849108em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">p</span></span></span></span> ，计算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mo>≡</mo><mo stretchy=\"false\">[</mo><mi>H</mi><mo stretchy=\"false\">(</mo><mi>m</mi><mo stretchy=\"false\">)</mo><mo>−</mo><mi>x</mi><mo>⋅</mo><mi>r</mi><mo stretchy=\"false\">]</mo><mo>⋅</mo><msup><mi>k</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mo stretchy=\"false\">(</mo><mi>p</mi><mo>−</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">s \\equiv [H(m) - x\\cdot r]\\cdot k ^{-1} mod \\space (p-1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.46375em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≡</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">m</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.44445em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\"> </span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span></li>\n<li>签名为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi><mi>i</mi><msub><mi>g</mi><mrow><mi>s</mi><mi>k</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>m</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo separator=\"true\">,</mo><mi>s</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">Sig_{sk}(m)=(r,s)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\">i</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">m</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mclose\">)</span></span></span></span> ，将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>r</mi><mo separator=\"true\">,</mo><mi>s</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(r,s)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mclose\">)</span></span></span></span> 发送给接收方。</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"schnorr签名与eigamal签名有何不同请比较两者的异同\"><a class=\"anchor\" href=\"#schnorr签名与eigamal签名有何不同请比较两者的异同\">#</a> Schnorr 签名与 EIGamal 签名有何不同？请比较两者的异同。</h3>\n<ul>\n<li>在 EIGamal 体制中，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>g</mi></mrow><annotation encoding=\"application/x-tex\">g</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span></span></span></span> 为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi mathvariant=\"double-struck\">Z</mi><mi>p</mi><mo>∗</mo></msubsup></mrow><annotation encoding=\"application/x-tex\">\\mathbb{Z}^*_p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.071998em;vertical-align:-0.383108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathbb\">Z</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.688696em;\"><span style=\"top:-2.4530000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">∗</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span></span></span></span> 的本原元素；在 Schnorr 体制中，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>g</mi></mrow><annotation encoding=\"application/x-tex\">g</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span></span></span></span> 为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi mathvariant=\"double-struck\">Z</mi><mi>p</mi><mo>∗</mo></msubsup></mrow><annotation encoding=\"application/x-tex\">\\mathbb{Z}^*_p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.071998em;vertical-align:-0.383108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathbb\">Z</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.688696em;\"><span style=\"top:-2.4530000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">∗</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span></span></span></span> 中的子集 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi mathvariant=\"double-struck\">Z</mi><mi>q</mi><mo>∗</mo></msubsup></mrow><annotation encoding=\"application/x-tex\">\\mathbb{Z}^*_q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.071998em;vertical-align:-0.383108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathbb\">Z</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.688696em;\"><span style=\"top:-2.4530000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">q</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">∗</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span></span></span></span> 的本原元，它不是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi mathvariant=\"double-struck\">Z</mi><mi>p</mi><mo>∗</mo></msubsup></mrow><annotation encoding=\"application/x-tex\">\\mathbb{Z}^*_p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.071998em;vertical-align:-0.383108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathbb\">Z</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.688696em;\"><span style=\"top:-2.4530000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mbin mtight\">∗</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span></span></span></span> 的本原元；</li>\n<li><strong>Schnorr 的签名长度要比 EIGamal 短</strong>，由 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">∣</mi><mi>q</mi><mi mathvariant=\"normal\">∣</mi></mrow><annotation encoding=\"application/x-tex\">|q|</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mord\">∣</span></span></span></span> 以及 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>H</mi><mo stretchy=\"false\">(</mo><mi>m</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">H(m)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">m</span><span class=\"mclose\">)</span></span></span></span> 决定</li>\n<li>Schnorr 签名的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi><mo>=</mo><msup><mi>g</mi><mi>k</mi></msup><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">r= g^k mod \\space p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.043548em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.849108em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">p</span></span></span></span> 可以预先计算，签名只需 1 次乘法和 1 次加法，签名速度快， 适用于智能卡应用</li>\n<li>由于 Schnorr 签名较短， <strong>Schnor 体制安全性比 BIGamal 体制差</strong></li>\n</ul>\n<h3 id=\"请写出dss的签名方程并比较它与eigamal-schnorr的异同\"><a class=\"anchor\" href=\"#请写出dss的签名方程并比较它与eigamal-schnorr的异同\">#</a> 请写出 DSS 的签名方程，并比较它与 EIGamal、Schnorr 的异同</h3>\n<ul>\n<li><strong>签名过程</strong>：\n<ol>\n<li>给定消息 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mo>∈</mo><mi>M</mi></mrow><annotation encoding=\"application/x-tex\">m \\in M</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span></span></span></span> ，选择秘密随机数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> ，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mo>&lt;</mo><mi>k</mi><mo>&lt;</mo><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">0&lt;k&lt;q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68354em;vertical-align:-0.0391em;\"></span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.73354em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span>，计算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>H</mi><mo stretchy=\"false\">(</mo><mi>m</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">H(m)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">m</span><span class=\"mclose\">)</span></span></span></span></li>\n<li>计算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi><mo>≡</mo><mo stretchy=\"false\">(</mo><msup><mi>g</mi><mi>k</mi></msup><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mi>p</mi><mo stretchy=\"false\">)</mo><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">r \\equiv (g^k mod \\space p) mod \\space q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.46375em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≡</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.099108em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.849108em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">p</span><span class=\"mclose\">)</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span> ，计算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mo>≡</mo><mo stretchy=\"false\">[</mo><msup><mi>k</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>⋅</mo><mo stretchy=\"false\">(</mo><mi>H</mi><mo stretchy=\"false\">(</mo><mi>m</mi><mo stretchy=\"false\">)</mo><mo>+</mo><mi>x</mi><mi>r</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">s \\equiv [k^{-1} \\cdot (H(m) + xr)] mod \\space q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.46375em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≡</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">m</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mclose\">)</span><span class=\"mclose\">]</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span></li>\n<li>签名为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi><mi>i</mi><msub><mi>g</mi><mrow><mi>s</mi><mi>k</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>m</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mo stretchy=\"false\">(</mo><mi>r</mi><mo separator=\"true\">,</mo><mi>s</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">Sig_{sk}(m) = (r,s)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\">i</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">m</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mclose\">)</span></span></span></span>， 将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>r</mi><mo separator=\"true\">,</mo><mi>s</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(r,s)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mclose\">)</span></span></span></span> 发送给接收方</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"在以上三种签名方案中每次签名时用户都要选择一个随机数k-若将随机数k替换成为常数会出现什么安全问题请加以分析\"><a class=\"anchor\" href=\"#在以上三种签名方案中每次签名时用户都要选择一个随机数k-若将随机数k替换成为常数会出现什么安全问题请加以分析\">#</a> 在以上三种签名方案中，每次签名时，用户都要选择一个随机数 k。若将随机数 k 替换成为常数，会出现什么安全问题？请加以分析。</h3>\n<p>可以通过 2 个使用相同随机数的签名解密出私钥。</p>\n<h3 id=\"diffie-hellman能用来做数字签名吗\"><a class=\"anchor\" href=\"#diffie-hellman能用来做数字签名吗\">#</a> Diffie-Hellman 能用来做数字签名吗？</h3>\n<p>不能</p>\n<h3 id=\"单钥体制能用来做数字签名吗\"><a class=\"anchor\" href=\"#单钥体制能用来做数字签名吗\">#</a> 单钥体制能用来做数字签名吗？</h3>\n<p>不能</p>\n<h3 id=\"试比较数字签名在密钥的使用上与公钥加密算法存在的区别\"><a class=\"anchor\" href=\"#试比较数字签名在密钥的使用上与公钥加密算法存在的区别\">#</a> 试比较数字签名在密钥的使用上，与公钥加密算法存在的区别</h3>\n<p>数字签名是用签名者的私钥进行签名，用签名者的公钥进行验证，双钥加密为发送方用接受方的公钥进行消息的加密，接受方用自己的私钥进行解密</p>\n<h3 id=\"请列举具有特殊功能的数字签名体制有哪些它们各有什么用途\"><a class=\"anchor\" href=\"#请列举具有特殊功能的数字签名体制有哪些它们各有什么用途\">#</a> 请列举具有特殊功能的数字签名体制有哪些？它们各有什么用途？</h3>\n<ul>\n<li><strong>不可否认签名</strong>：签名者合作下才能验证签名（知识产权保护）</li>\n<li>防失败签名：防范有充足计算资源的攻击者，及时攻击者分析出私钥也难以伪造（一次性签名方案）</li>\n<li><strong>盲签名</strong>：文件所有者不想让签名者知道文件的内容（选举投票、电子商务等）</li>\n<li><strong>群签名</strong>：群众成员可签、外界不可知谁签、争议时群成员或可信赖三方可鉴别签名者（项目投标）</li>\n<li><strong>代理签名</strong>：委托人授权某个代理人签名，签名密钥无需交给代理人</li>\n<li><strong>指定证实人签名</strong>：一个机构中，指定一个人负责证实所有人签名（有助于防止签名失效）</li>\n<li><strong>一次性签名</strong>：每个签名采用一个新的公钥，优点是签名和验证速度非常快</li>\n</ul>\n<h3 id=\"了解中国商用数字签名算法sm2\"><a class=\"anchor\" href=\"#了解中国商用数字签名算法sm2\">#</a> 了解中国商用数字签名算法 SM2。</h3>\n<h2 id=\"第八章\"><a class=\"anchor\" href=\"#第八章\">#</a> 第八章</h2>\n<h3 id=\"构成协议的三个主要特征含义是什么\"><a class=\"anchor\" href=\"#构成协议的三个主要特征含义是什么\">#</a> 构成协议的三个主要特征（含义）是什么？</h3>\n<ul>\n<li>必须依次执行</li>\n<li>至少两个参与者</li>\n<li>必须能够完成某项任务</li>\n</ul>\n<h3 id=\"什么是仲裁协议什么是裁决协议什么是自执行协议\"><a class=\"anchor\" href=\"#什么是仲裁协议什么是裁决协议什么是自执行协议\">#</a> 什么是仲裁协议？什么是裁决协议？什么是自执行协议？</h3>\n<ul>\n<li>\n<p><strong>仲裁协议</strong>：可信赖第三方 Trent 参与协议。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/i5azx3.png\" alt=\"仲裁协议\" /></p>\n</li>\n<li>\n<p><strong>裁决协议</strong>：Trent 不直接参与协议，纠纷时裁决。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/uaowkw.png\" alt=\"裁决协议\" /></p>\n</li>\n<li>\n<p><strong>自执行协议</strong>：最好的协议，若一方试图欺骗另一方，那么另一方回立刻检测到该欺骗的发生并终止协议。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/jatgdg.png\" alt=\"自执行协议\" /></p>\n</li>\n</ul>\n<h3 id=\"如果按照密码协议的功能分类密码协议可以分为哪几类\"><a class=\"anchor\" href=\"#如果按照密码协议的功能分类密码协议可以分为哪几类\">#</a> 如果按照密码协议的功能分类，密码协议可以分为哪几类？</h3>\n<ul>\n<li><strong>认证协议</strong></li>\n<li><strong>密钥建立协议</strong></li>\n<li><strong>认证的密钥建立协议</strong></li>\n</ul>\n<h3 id=\"什么是中间人攻击如何对diffie-hellman协议进行中间人攻击请用画图分析对diffie-hellman协议进行中间人攻击的详细过程\"><a class=\"anchor\" href=\"#什么是中间人攻击如何对diffie-hellman协议进行中间人攻击请用画图分析对diffie-hellman协议进行中间人攻击的详细过程\">#</a> 什么是中间人攻击？如何对 Diffie-Hellman 协议进行中间人攻击？请用画图分析对 Diffie- Hellman 协议进行中间人攻击的详细过程。</h3>\n<ul>\n<li>\n<p><strong>中间人攻击</strong>参考</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/ax4nha.png\" alt=\"中间人攻击\" /></p>\n<p>当 B 与 A 会话时，M 可以冒充 B，当 A 与 B 会话时，M 可以冒充 A。</p>\n</li>\n</ul>\n<h3 id=\"dh协议不能抵抗中间人攻击的原因是什么如何改造dh协议可以使其抵抗中间人攻击\"><a class=\"anchor\" href=\"#dh协议不能抵抗中间人攻击的原因是什么如何改造dh协议可以使其抵抗中间人攻击\">#</a> DH 协议不能抵抗中间人攻击的原因是什么？如何改造 DH 协议可以使其抵抗中间人攻击？</h3>\n<ul>\n<li>DH 不抵抗中间人攻击的本质原因：通信双方没有进行<strong>实体认证</strong>。</li>\n<li>改造 DH：引入 CA，用公钥向 CA 请求证书，将证书发送给对方</li>\n</ul>\n<h3 id=\"掌握大嘴青蛙协议-yahalom-kerberos协议安全协议设计的思想\"><a class=\"anchor\" href=\"#掌握大嘴青蛙协议-yahalom-kerberos协议安全协议设计的思想\">#</a> 掌握大嘴青蛙协议、Yahalom、Kerberos 协议安全协议设计的思想。</h3>\n<ul>\n<li>\n<p><strong>大嘴青蛙协议</strong>：A 和 B 均与 T 共享一个密钥，只需要传两条消息，就可以将一个会话密钥发送给 B。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/n2uuvf.png\" alt=\"大嘴青蛙\" /></p>\n</li>\n<li>\n<p><strong>Yahalom</strong>：由 B 先向 T 接触，T 仅向 A 发送一条消息</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/j6ey3r.png\" alt=\"Yahalom\" /></p>\n</li>\n<li>\n<p><strong>Kerberos</strong>：A 和 B 均与 T 共享一个密钥，采用时戳。会话密钥由 A 生成。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/wyke2u.png\" alt=\"Kerberos\" /></p>\n</li>\n</ul>\n<h3 id=\"请画图分析第218页的skid协议为什么不能抵抗中间人攻击如何改造这个协议可以有效抵抗中间人攻击\"><a class=\"anchor\" href=\"#请画图分析第218页的skid协议为什么不能抵抗中间人攻击如何改造这个协议可以有效抵抗中间人攻击\">#</a> 请画图分析第 218 页的 SKID 协议为什么不能抵抗中间人攻击？如何改造这个协议，可以有效抵抗中间人攻击？</h3>\n<ul>\n<li>SKID 采用 MAC 来提供安全性，并假设 A 和 B 共享一个密钥 K</li>\n<li>SKID2 是单向身份识别协议（只有 1～3 步）</li>\n<li>SKID3 是双向身份识别协议，如下图</li>\n</ul>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/b9tzhp.png\" alt=\"SKID3\" /></p>\n<ul>\n<li>\n<p><strong>中间人攻击</strong>：采用预言者会话攻击</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/seury5.png\" alt=\"预言者会话攻击\" /></p>\n</li>\n<li>\n<p><strong>改造协议</strong>：在这个协议中，A 无法确定消息来源于 B，所以会导致中间人攻击，所以可以引入数字签名、数字证书来解决这个问题。</p>\n</li>\n</ul>\n<h3 id=\"对密码协议的攻击方法有哪些\"><a class=\"anchor\" href=\"#对密码协议的攻击方法有哪些\">#</a> 对密码协议的攻击方法有哪些？</h3>\n<ul>\n<li><strong>已知明文攻击</strong>：通过长期窃听获得一个加密表</li>\n<li><strong>选择密文攻击</strong>：可选择将明文转换为密文，可选择全 “0” 或全 “1” 的密文串来加速解密</li>\n<li><strong>预言者会话攻击</strong>：将一方当作另一方的预言者 “解密服务器”</li>\n<li><strong>并行会话攻击</strong>：曾经使用过的信息流在新的协议执行过程中被使用</li>\n</ul>\n<h3 id=\"密码协议的安全性分析的常用方法有哪些\"><a class=\"anchor\" href=\"#密码协议的安全性分析的常用方法有哪些\">#</a> 密码协议的安全性分析的常用方法有哪些？</h3>\n<ul>\n<li><strong>攻击检验法</strong></li>\n<li><strong>形式语言逻辑分析法</strong></li>\n<li><strong>可证明安全性分析法</strong></li>\n</ul>\n<h2 id=\"第九章\"><a class=\"anchor\" href=\"#第九章\">#</a> 第九章</h2>\n<h3 id=\"什么是pkipki由哪几部分组成每个组成部分的作用是什么\"><a class=\"anchor\" href=\"#什么是pkipki由哪几部分组成每个组成部分的作用是什么\">#</a> 什么是 PKI？PKI 由哪几部分组成？每个组成部分的作用是什么？</h3>\n<ul>\n<li><strong>PKI</strong>：公钥基础设施（Public Key Infrastructure），一种遵循<strong>标准</strong>的利用<strong>公钥</strong>理论和技术建立的提供<strong>安全服务</strong>的基础设施。</li>\n<li><strong>组成部分和功能</strong>：\n<ul>\n<li>证书机构 CA：发放和管理证书等。（生成和颁发数字证书）</li>\n<li>注册机构 RA：证书注册和审批。（接受与验证信息，为用户生成密钥，接受撤销请求）</li>\n<li>证书发布库：集中存放 CA 颁发的证书和撤销列表。</li>\n<li>密钥备份与恢复：备份和恢复用户的私钥（用于数据加密的私钥才会备份）。</li>\n<li>证书撤销：当证书作废时警告其他用户不要继续使用该证书。</li>\n<li>PKI 应用接口：使用户更方便的使用加密、数字签名等安全服务。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"什么是数字证书一个数字证书包含哪些内容\"><a class=\"anchor\" href=\"#什么是数字证书一个数字证书包含哪些内容\">#</a> 什么是数字证书？一个数字证书包含哪些内容？</h3>\n<ul>\n<li>\n<p><strong>数字证书</strong>：数字证书就是一个用户的<strong>身份</strong>与其所持有的<strong>公钥</strong>的结合，在结合之前由一个可信任的<strong>权威机构 CA</strong> 来证实用户的身份，然后由该机构对用户身份及对应公钥相结合的证书进行<strong>数字签名</strong>，以证明其证书的有效性。</p>\n</li>\n<li>\n<p><strong>包含</strong>：</p>\n<ul>\n<li>主体名</li>\n<li>公钥</li>\n<li>序号</li>\n<li>有效期</li>\n<li>签发者名</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"了解x509标准规定的数字证书的格式\"><a class=\"anchor\" href=\"#了解x509标准规定的数字证书的格式\">#</a> 了解 X.509 标准规定的数字证书的格式。</h3>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/lvyvyh.png\" alt=\"数字证书的格式\" /></p>\n<h3 id=\"实际中由谁来签发证书签发证书时是由谁的何种密钥私钥还是公钥进行签名验证证书时是用谁的何种密钥来验证\"><a class=\"anchor\" href=\"#实际中由谁来签发证书签发证书时是由谁的何种密钥私钥还是公钥进行签名验证证书时是用谁的何种密钥来验证\">#</a> 实际中，由谁来签发证书？签发证书时，是由谁的何种密钥（私钥还是公钥）进行签名？验证证书时，是用谁的何种密钥来验证？</h3>\n<p>实际中，由<strong> CA</strong> 签发证书。签发时采用<strong> CA 的私钥</strong>，验证时采用<strong> CA 的公钥</strong>。</p>\n<h3 id=\"数字证书的作用是什么它本质上是为解决网络安全中的何种问题\"><a class=\"anchor\" href=\"#数字证书的作用是什么它本质上是为解决网络安全中的何种问题\">#</a> 数字证书的作用是什么？它本质上是为解决网络安全中的何种问题？</h3>\n<p><strong>作用</strong>：证明网络实体在特定安全应用的相关信息。解决了公钥的可信性问题。</p>\n<h3 id=\"在实际应用中若采用层次化的ca架构如何实现两个位于不同子ca中的用户之间的数字证书验证\"><a class=\"anchor\" href=\"#在实际应用中若采用层次化的ca架构如何实现两个位于不同子ca中的用户之间的数字证书验证\">#</a> 在实际应用中，若采用层次化的 CA 架构，如何实现两个位于不同子 CA 中的用户之间的数字证书验证？</h3>\n<p>逐级往上，直到验证到根 CA</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/8muxvf.png\" alt=\"逐级验证\" /></p>\n<p>以 Alice 要验证 Bob 的证书为例：</p>\n<ol>\n<li>Bob 发送自己的证书</li>\n<li>Alice 请求 B11 的公钥</li>\n<li>Bob 发送 B11 的证书</li>\n<li>Alice 请求 A3 的公钥</li>\n<li>Bob 发送 A3 的证书</li>\n<li>Alice 用根 CA 证书验证 A3 的证书</li>\n</ol>\n<h3 id=\"什么是交叉证书\"><a class=\"anchor\" href=\"#什么是交叉证书\">#</a> 什么是交叉证书？</h3>\n<p>交叉证书可以让不同 PKI 域的根 CA 进行交叉认证，从而解决根 CA 不同的信任问题</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/ozoosm.png\" alt=\"交叉证书\" /></p>\n<h3 id=\"如何实现数字证书的撤销如何实现数字证书的在线查询\"><a class=\"anchor\" href=\"#如何实现数字证书的撤销如何实现数字证书的在线查询\">#</a> 如何实现数字证书的撤销？如何实现数字证书的在线查询？</h3>\n<ul>\n<li>\n<p>撤销检查：维护证书撤销列表（CRL）或是执行联机证书状态协议，对证书的撤销状态进行检查</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/mgvclr.png\" alt=\"数字证书的撤销\" /></p>\n</li>\n<li>\n<p><strong>在线查询</strong>：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/qpq32e.png\" alt=\"数字证书在线查询\" /></p>\n</li>\n</ul>\n<h3 id=\"什么是漫游证书简述其基本工作原理\"><a class=\"anchor\" href=\"#什么是漫游证书简述其基本工作原理\">#</a> 什么是漫游证书？简述其基本工作原理。</h3>\n<ul>\n<li><strong>漫游证书</strong>：通过第三方软件提供，在任何系统中，只需正确配置，该软件就可以允许用户访问自己的公 / 私钥对。</li>\n<li><strong>工作原理</strong>：\n<ul>\n<li>将数字证书和私钥存储于安全的中央服务器</li>\n<li>用户需要数字证书时，可向该服务器认证自己</li>\n<li>认证成功后，该服务器将证书和私钥发给用户</li>\n<li>当用户完成工作后，该软件自动删除证书和私钥</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"一个pkica数字证书系统由哪几部分构成\"><a class=\"anchor\" href=\"#一个pkica数字证书系统由哪几部分构成\">#</a> 一个 PKI/CA 数字证书系统由哪几部分构成？</h3>\n<p>证书机构、注册机构、密钥备份与恢复、证书发布库、证书撤销</p>\n<h2 id=\"第十章\"><a class=\"anchor\" href=\"#第十章\">#</a> 第十章</h2>\n<h3 id=\"什么是链路加密有什么优缺点\"><a class=\"anchor\" href=\"#什么是链路加密有什么优缺点\">#</a> 什么是链路加密？有什么优缺点？</h3>\n<ul>\n<li>\n<p><strong>链路加密</strong>：对网络中两个相邻节点之间传输的数据进行加密保护</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/dsh1yj.png\" alt=\"链路加密\" /></p>\n</li>\n<li>\n<p>优点：</p>\n<ul>\n<li>\n<p>加密对用户是透明的，通过链路发送的任何信息在发送前都先被加密。</p>\n</li>\n<li>\n<p>每个链路只需要一对密钥。</p>\n</li>\n<li>\n<p>提供了信号流安全机制。</p>\n</li>\n</ul>\n</li>\n<li>\n<p>缺点：</p>\n<ul>\n<li>数据在中间结点以明文形式出现，维护结点安全性的代价较高</li>\n<li>密钥分配困难</li>\n<li>节点增多后密码机需求量大</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"什么是节点加密有什么优缺点\"><a class=\"anchor\" href=\"#什么是节点加密有什么优缺点\">#</a> 什么是节点加密？有什么优缺点？</h3>\n<ul>\n<li>\n<p><strong>节点加密</strong>：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/wvu0tt.png\" alt=\"节点加密\" /></p>\n</li>\n<li>\n<p>优点：</p>\n<ul>\n<li>\n<p>消息的加、解密在安全模块中进行，这使消息内容不会被泄密。</p>\n</li>\n<li>\n<p>加密对用户透明。</p>\n</li>\n</ul>\n</li>\n<li>\n<p>缺点：</p>\n<ul>\n<li>\n<p>某些信息（如报头和路由信息）必须以明文形式传输，可能遭到流量分析攻击。</p>\n</li>\n<li>\n<p>因为所有节点都必须有密钥，密钥分发和管理变的困难。</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"什么是端到端加密有什么优缺点\"><a class=\"anchor\" href=\"#什么是端到端加密有什么优缺点\">#</a> 什么是端到端加密？有什么优缺点？</h3>\n<ul>\n<li>\n<p><strong>端到端加密</strong>：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/sedhyp.png\" alt=\"端到端加密\" /></p>\n</li>\n<li>\n<p>优点：</p>\n<ul>\n<li>\n<p>对两个终端之间的整个通信线路进行加密。</p>\n</li>\n<li>\n<p>只需要 2 台加密机，1 台在发端，1 台在收端。</p>\n</li>\n<li>\n<p>从发端到收端的传输过程中，报文始终以密文存在。</p>\n</li>\n<li>\n<p>比链路和节点加密更安全可靠，更容易设计和维护。</p>\n</li>\n</ul>\n</li>\n<li>\n<p>缺点：不能防止业务流分析攻击</p>\n</li>\n</ul>\n<h3 id=\"什么是混合加密有什么优缺点\"><a class=\"anchor\" href=\"#什么是混合加密有什么优缺点\">#</a> 什么是混合加密？有什么优缺点？</h3>\n<ul>\n<li>\n<p><strong>混合加密</strong>：链路加密 + 端到端加密</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/2cmzmh.png\" alt=\"混合加密\" /></p>\n</li>\n<li>\n<p>优点：报文被两次加密，保护了报头的敏感信息，不会被业务流分析攻击。</p>\n</li>\n<li>\n<p>缺点：信息的安全设计较复杂，成本高，系统开销大。</p>\n</li>\n</ul>\n<h3 id=\"什么是密钥管理它包括哪些方面的管理\"><a class=\"anchor\" href=\"#什么是密钥管理它包括哪些方面的管理\">#</a> 什么是密钥管理？它包括哪些方面的管理？</h3>\n<ul>\n<li><strong>密钥管理</strong>：处理密钥从产生到最终销毁的整个过程中的有关问题，包括系统的初始化及密钥的<strong>产生</strong>、<strong>存储</strong>、<strong>备份 / 恢复</strong>、<strong>装入</strong>、<strong>分配</strong>、<strong>保护</strong>、<strong>更新</strong>、<strong>控制</strong>、<strong>丢失</strong>、<strong>撤销</strong>和<strong>销毁</strong>等内容。</li>\n</ul>\n<h3 id=\"密钥有哪些种类它们各自有什么用途\"><a class=\"anchor\" href=\"#密钥有哪些种类它们各自有什么用途\">#</a> 密钥有哪些种类？它们各自有什么用途？</h3>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/3wsz9b.png\" alt=\"密钥的种类\" /></p>\n<h3 id=\"有哪些密钥分配的基本方法\"><a class=\"anchor\" href=\"#有哪些密钥分配的基本方法\">#</a> 有哪些密钥分配的基本方法？</h3>\n<ul>\n<li>\n<p><strong>利用安全信道</strong>实现密钥传递</p>\n</li>\n<li>\n<p><strong>利用双钥体制</strong>建立安全信道</p>\n</li>\n<li>\n<p><strong>利用量子技术</strong>实现密钥传递</p>\n</li>\n</ul>\n<h3 id=\"在用密钥枪注入密钥时如何验证密钥注入的正确性\"><a class=\"anchor\" href=\"#在用密钥枪注入密钥时如何验证密钥注入的正确性\">#</a> 在用密钥枪注入密钥时，如何验证密钥注入的正确性？</h3>\n<ol>\n<li>密钥枪将一随机数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mi>N</mi></msub></mrow><annotation encoding=\"application/x-tex\">R_N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 注入保密机</li>\n<li>保密机用主密钥 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>K</mi><mi>m</mi></msub></mrow><annotation encoding=\"application/x-tex\">K_m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 加密：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>E</mi><mrow><mi>K</mi><mi>m</mi></mrow></msub><mo stretchy=\"false\">(</mo><msub><mi>R</mi><mi>N</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">E_{Km}(R_N)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal mtight\">m</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></li>\n<li>保密机计算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>K</mi><mi>m</mi></msub></mrow><annotation encoding=\"application/x-tex\">K_m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的杂凑函数值：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>h</mi><mo stretchy=\"false\">(</mo><msub><mi>K</mi><mi>m</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">h(K_m)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">h</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></li>\n<li>保密机将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>E</mi><mrow><mi>K</mi><mi>m</mi></mrow></msub><mo stretchy=\"false\">(</mo><msub><mi>R</mi><mi>N</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">E_{Km}(R_N)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal mtight\">m</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>h</mi><mo stretchy=\"false\">(</mo><mo stretchy=\"false\">)</mo><msub><mi>k</mi><mi>m</mi></msub></mrow><annotation encoding=\"application/x-tex\">h()k_m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">h</span><span class=\"mopen\">(</span><span class=\"mclose\">)</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 回送到密钥枪</li>\n<li>密钥枪检验 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>h</mi><mo stretchy=\"false\">(</mo><msub><mi>K</mi><mi>m</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">h(K_m)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">h</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 值，并检验解密的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mi>N</mi></msub></mrow><annotation encoding=\"application/x-tex\">R_N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></li>\n</ol>\n<h3 id=\"密钥管理为什么要将密钥划分成不同的层次\"><a class=\"anchor\" href=\"#密钥管理为什么要将密钥划分成不同的层次\">#</a> 密钥管理为什么要将密钥划分成不同的层次？</h3>\n<p>利于<strong>分级管理</strong>。极少数密钥以明文形式存储在有严密物理保护的主机密码器件中，其余密钥则以密文形式存储在密码器之外。这样，密钥管理就可以大大简化，安全性也高。</p>\n<h3 id=\"一个密钥管理系统由哪几部分构成\"><a class=\"anchor\" href=\"#一个密钥管理系统由哪几部分构成\">#</a> 🌟一个密钥管理系统由哪几部分构成？</h3>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/l0cgkn.png\" alt=\"密钥管理系统\" /></p>\n<h3 id=\"密钥的生存期分哪四个阶段了解密钥管理的12个工作步骤\"><a class=\"anchor\" href=\"#密钥的生存期分哪四个阶段了解密钥管理的12个工作步骤\">#</a> 密钥的生存期分哪四个阶段？了解密钥管理的 12 个工作步骤。</h3>\n<ul>\n<li>\n<p><strong>四个阶段</strong>：</p>\n<ol>\n<li><strong>预运行阶段</strong>：此时密钥还不能用</li>\n<li><strong>运行阶段</strong>：正常使用</li>\n<li><strong>后运行阶段</strong>：不能正常使用，特殊目的下可以脱机下接入</li>\n<li><strong>报废阶段</strong>：将有关密钥从所有记录中删掉，不能使用</li>\n</ol>\n</li>\n<li>\n<p><strong>12 个工作步骤</strong>：</p>\n<ul>\n<li>用户注册</li>\n<li>用户初始化</li>\n<li>密钥生成</li>\n<li>密钥输入</li>\n<li>密钥注册</li>\n<li>正常使用</li>\n<li>密钥备份</li>\n<li>密钥更新</li>\n<li>密钥档案</li>\n<li>密钥注销与销毁</li>\n<li>密钥恢复</li>\n<li>密钥吊销</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"查找资料了解一个好的密钥应具备哪些数学特性\"><a class=\"anchor\" href=\"#查找资料了解一个好的密钥应具备哪些数学特性\">#</a> 查找资料，了解一个好的密钥应具备哪些数学特性？</h3>\n<ol>\n<li>真正随机、等概率。</li>\n<li>避免使用特定算法的弱密钥。</li>\n<li>双钥系统的密钥必须满足一定的数学关系。</li>\n<li>密钥一般会选伪随机数，循环周期应尽可能大。</li>\n<li>采用密钥揉搓或杂凑技术，将易记的长句子变换成伪随机串存放。</li>\n</ol>\n<h2 id=\"第十一章\"><a class=\"anchor\" href=\"#第十一章\">#</a> 第十一章</h2>\n<h3 id=\"无线网络面临哪些主要安全威胁要能识别哪些是主动攻击哪些是被动攻击\"><a class=\"anchor\" href=\"#无线网络面临哪些主要安全威胁要能识别哪些是主动攻击哪些是被动攻击\">#</a> 无线网络面临哪些主要安全威胁？要能识别哪些是主动攻击，哪些是被动攻击。</h3>\n<ul>\n<li><strong>被动攻击</strong>：\n<ol>\n<li>通话窃听</li>\n<li>服务区标志符泄露</li>\n</ol>\n</li>\n<li><strong>主动攻击</strong>：\n<ol>\n<li>数据注入与篡改</li>\n<li>中间人攻击</li>\n<li>通信阻断</li>\n<li>客户端假冒</li>\n<li>接入点伪装</li>\n<li>重放攻击</li>\n<li>匿名攻击</li>\n<li>端对端攻击</li>\n<li>隐匿无线信道</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"请画图分析gsm蜂窝系统保密与认证协议的工作过程指出三元组认证向量中的每个元素所发挥的安全性作用\"><a class=\"anchor\" href=\"#请画图分析gsm蜂窝系统保密与认证协议的工作过程指出三元组认证向量中的每个元素所发挥的安全性作用\">#</a> 请画图分析 GSM 蜂窝系统保密与认证协议的工作过程，指出三元组认证向量中的每个元素所发挥的安全性作用。</h3>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/npn3eg.png\" alt=\"GSM蜂窝系统保密与认证协议的工作过程\" /></p>\n<ul>\n<li><strong>三元组</strong>\n<ul>\n<li>RAND：随机数，用于用户认证和会话密钥的产生时的挑战值。</li>\n<li>SRES'：签名回应，即挑战的答案，用于比对用户是否成功响应。</li>\n<li>Kc：会话密钥，用于手机与 GSM 网络之间的通信数据加密的密钥。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"gsm系统有哪些主要安全缺陷\"><a class=\"anchor\" href=\"#gsm系统有哪些主要安全缺陷\">#</a> GSM 系统有哪些主要安全缺陷？</h3>\n<ol>\n<li><strong>首次开机时泄漏 IMSI 信息</strong>，可能导致用户身份泄漏。</li>\n<li><strong>用户无法验证基站</strong>，伪基站向用户发送欺诈信息。</li>\n<li><strong>骨干网数据传输无加密</strong>，中间节点可截获会话密钥。</li>\n<li><strong>无数据完整性验证机制</strong>，不能检测数据是否被篡改。</li>\n<li><strong>主密钥 K 直接参与认证与加密</strong>，存在泄漏主密钥的风险。</li>\n<li><strong>主密钥 K 存在 SIM 卡中</strong>，有复制 SIM 卡的风险。</li>\n</ol>\n<h3 id=\"请画图分析3g蜂窝系统保密与认证协议的工作过程指出五元组认证向量中的每个元素所发挥的安全性作用\"><a class=\"anchor\" href=\"#请画图分析3g蜂窝系统保密与认证协议的工作过程指出五元组认证向量中的每个元素所发挥的安全性作用\">#</a> 请画图分析 3G 蜂窝系统保密与认证协议的工作过程，指出五元组认证向量中的每个元素所发挥的安全性作用</h3>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/kybz27.png\" alt=\"3G蜂窝系统保密与认证协议的工作过程\" /></p>\n<ul>\n<li><strong>五元组</strong>：\n<ul>\n<li>RAND：随机数</li>\n<li>XRES：认证应答</li>\n<li>CK：保密性令牌</li>\n<li>IK：完整性令牌</li>\n<li>AUTH：网络认证令牌</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"3g系统有哪些安全功能有哪些主要安全缺陷与2g相比3g作出了哪些安全性改进\"><a class=\"anchor\" href=\"#3g系统有哪些安全功能有哪些主要安全缺陷与2g相比3g作出了哪些安全性改进\">#</a> 3G 系统有哪些安全功能？有哪些主要安全缺陷？与 2G 相比，3G 作出了哪些安全性改进？</h3>\n<ul>\n<li><strong>安全功能</strong>：\n<ul>\n<li>实现了用户和网络<strong>双向认证</strong></li>\n<li>增加了<strong>数据完整性验证</strong>功能</li>\n<li>建立了了用户与网络之间的<strong>会话密钥</strong></li>\n<li>保持了会话密钥的<strong>新鲜性</strong></li>\n</ul>\n</li>\n<li><strong>安全缺陷</strong>：\n<ul>\n<li><strong>首次开机时泄漏 IMSI 信息</strong>，可能导致用户身份泄漏。</li>\n<li><strong>骨干网上传输无加密</strong>：中间节点可截获会话密钥。</li>\n<li><strong>K 直接参与认证与加密</strong>：主密钥缺乏层次化保护。</li>\n<li><strong>CK 和 IK 直接传输</strong>，存在窃听风险。</li>\n<li><strong>主密钥 K 存在 SIM 卡中</strong>，有复制 SIM 卡的风险。</li>\n<li><strong>采用 10 种安全算法</strong>，算法过多存在被攻破风险。</li>\n</ul>\n</li>\n<li><strong>改进点</strong>：\n<ul>\n<li>双向认证</li>\n<li>数据完整性</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"4g系统有哪些安全功能有哪些主要安全缺陷与3g相比4g作出了哪些安全性改进\"><a class=\"anchor\" href=\"#4g系统有哪些安全功能有哪些主要安全缺陷与3g相比4g作出了哪些安全性改进\">#</a> 4G 系统有哪些安全功能？有哪些主要安全缺陷？与 3G 相比，4G 作出了哪些安全性改进？</h3>\n<ul>\n<li><strong>安全功能</strong>：\n<ul>\n<li>实现了用户与网络<strong>双向认证</strong></li>\n<li>建立了用户与网络的<strong>会话密钥</strong></li>\n<li>增加了数据的<strong>完整性校验</strong></li>\n<li>实现了<strong>层次化密钥管理</strong></li>\n<li><strong>隐藏</strong>了加密密钥 CK 和数据完整性验证密钥 IK</li>\n</ul>\n</li>\n<li>安全缺陷\n<ul>\n<li><strong>首次开机泄漏 IMSI</strong></li>\n<li><strong>骨干网无加密</strong></li>\n</ul>\n</li>\n<li>改进点：\n<ul>\n<li>层次化密钥管理</li>\n<li>隐藏 CK 和 IK</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"为何2g3g4g系统的挑战值rand是一个随机数而不能是常数如果挑战值rand为常数会产生何种安全问题请加以分析\"><a class=\"anchor\" href=\"#为何2g3g4g系统的挑战值rand是一个随机数而不能是常数如果挑战值rand为常数会产生何种安全问题请加以分析\">#</a> 为何 2G/3G/4G 系统的挑战值 RAND 是一个随机数而不能是常数？如果挑战值 RAND 为常数，会产生何种安全问题？请加以分析。</h3>\n<p><strong>可以防止强力攻击</strong>：以 2G 为例，一个 128 比特的随机数意味着 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3.4</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>38</mn></msup></mrow><annotation encoding=\"application/x-tex\">3.4×10^{38}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">3</span><span class=\"mord\">.</span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">3</span><span class=\"mord mtight\">8</span></span></span></span></span></span></span></span></span></span></span></span> 种可能的组合。因此即使黑客知道 A3 算法，也很难猜出正确的 RAND/SRES。</p>\n<p>若替换为常数值，即每一次 SRES 相同，一旦被截获，用户就有可能被攻击者冒充。</p>\n<h3 id=\"与2g3g4g相比5g在哪些方面提升了安全性\"><a class=\"anchor\" href=\"#与2g3g4g相比5g在哪些方面提升了安全性\">#</a> 与 2G/3G/4G 相比，5G 在哪些方面提升了安全性？</h3>\n<p>新增了<strong>身份标识隐私保护</strong></p>\n",
            "tags": [
                "杂项",
                "校内课程",
                "网络安全",
                "复习要点"
            ]
        },
        {
            "id": "https://gality.cn/misc/PNT/IRIG-B/",
            "url": "https://gality.cn/misc/PNT/IRIG-B/",
            "title": "IRIG-B编码",
            "date_published": "2023-10-27T09:00:02.000Z",
            "content_html": "<h1 id=\"irig-简介\"><a class=\"anchor\" href=\"#irig-简介\">#</a> IRIG 简介</h1>\n<p>IRIG 时间码原本是由美国军方为了靶场间的时间同步于 1960 年提出的，最新版本于 2004 年 9 月更新，名为：“IRIG Serial Time Code Formats”。</p>\n<p>IRIG 时间码有两大类：一类是并行时间码格式，这类码由于是并行格式，传输距离较近，且是二进制，因此远不如串行格式广泛；另一类是串行时间码，共有六种格式，即 A、B、D、E、G、H。它们的主要差别是时间码的帧速率不同。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">Format</th>\n<th style=\"text-align:left\">Pulse Rate（or Bit Rate）</th>\n<th style=\"text-align:left\">Index Count Interval</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">IRIG-A</td>\n<td style=\"text-align:left\">1000 PPS (pulse per second)</td>\n<td style=\"text-align:left\">1 ms</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">IRIG-B</td>\n<td style=\"text-align:left\">100 PPS</td>\n<td style=\"text-align:left\">10 ms</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">IRIG-D</td>\n<td style=\"text-align:left\">1 PPM</td>\n<td style=\"text-align:left\">1 minute</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">IRIG-E</td>\n<td style=\"text-align:left\">10 PPS</td>\n<td style=\"text-align:left\">100 ms</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">IRIG-G</td>\n<td style=\"text-align:left\">10000 PPS</td>\n<td style=\"text-align:left\">0.1 ms</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">IRIG-H</td>\n<td style=\"text-align:left\">1 PPS</td>\n<td style=\"text-align:left\">1 second</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"irig-b\"><a class=\"anchor\" href=\"#irig-b\">#</a> IRIG-B</h2>\n<p>IRIG-B 为 IRIG 中的 B 型码，是每秒一帧的时间码，最适合使用的习惯，而且传输也较容易，所以应用最为广泛；每帧可传递 100 位的信息。</p>\n<p>为了便于传递，可用标准正弦波载频进行幅度调制。标准正弦波载频的频率与码元速率严格相关。B 码的标准正弦波载频频率为 1KHz。同时，其正交过零点与所调制格式码元的前沿相符合，标准的调制比为 10 比 3。调制后的 B 码通常称 IRIG-B（AC）码，未经幅度调制的通常称 IRIG-B（DC）码。</p>\n<p>IRIG-B (DC) 码的接口通常采用 TTL 接口和 RS422（V.11）接口。IRIG-B (AC) 码的接口采用平衡接口。IRIG-B (DC) 码的同步精度可达几十纳秒量级，IRIG-B (AC) 码的同步精度一般为 10～20us (微秒)。</p>\n<h1 id=\"irig-b-格式\"><a class=\"anchor\" href=\"#irig-b-格式\">#</a> IRIG-B 格式</h1>\n<p>概念引入：</p>\n<ul>\n<li><strong>帧</strong>：B 码每秒<span class=\"red\"> 1 帧</span>。</li>\n<li><strong>脉宽码</strong>：用脉冲的宽度（脉宽，即持续时间）来表示数字信息。不同的数字或字符由不同宽度的脉冲表示。</li>\n<li><strong>码元</strong>：时间格式里的每个脉冲称为码元。码元的 “准时”（OnTime）参考点是其脉冲前沿。每个码元的宽度为<span class=\"red\"> 10 ms</span>。</li>\n<li><strong>码元速率</strong>：码元的传输速率称为码元速率。B 码的码元速率为<span class=\"red\"> 100 pps</span>，代表每秒有 100 个脉冲或码元传输。</li>\n<li><strong>索引计数</strong>：每个码元对应一个索引计数。两个相邻码元前沿之间的时间间隔为索引计数间隔，B 码的索引计数间隔（其实也就是码元宽度）为<span class=\"red\"> 10 ms</span>。索引计数在帧参考点处以 “0” 开始，以后每隔一个索引计数间隔增加 1，直至这帧结束。B 码每帧有 100 个码元，所以索引计数数字是 0～99。</li>\n<li><strong>位置识别标志（P 码）</strong>：位置识别标志的宽度是对应时码的索引计数间隔的 0.8，所以，B 码为<span class=\"red\"> 8 ms</span>。位置识别标志 P0 的前沿在帧参考点（PR）前一个索引计数间隔处，以后每十个码元有一个位置识别标志，分别为 P1、P2……，P9 位置识别标志的重复速率为码元速率的十分之一即位置标识的码元速率为 10 pps。</li>\n<li><strong>码字</strong>：所有的时间格式都是脉宽码。二进制 <code>1</code>  和 <code>0</code>  的脉宽分别为码宽度的 0.5 和 0.2。所以，B 码的二进制 <code>1</code>  和 <code>0</code>  的脉宽分别为<span class=\"red\"> 5 ms</span> 和<span class=\"red\"> 2 ms</span>（类似莫斯电码的思想，只不过只有两种类型）。</li>\n</ul>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/7gk5g9.png\" alt=\"脉宽\" /></p>\n<h1 id=\"时间编码\"><a class=\"anchor\" href=\"#时间编码\">#</a> 时间编码</h1>\n<p>B 码以两个连续的 P 码作为帧的分割标识，第一个 P 码是 P0，第二个 P 码是 PR，注意，从第二个 P 码（PR）作为帧起始标志，即第 0 个码元为 PR。</p>\n<p>在 B 码时间格式中含有天、时、分、秒，时序为秒 - 分 - 时 - 天，所占信息位为：</p>\n<ul>\n<li>秒：7 位。第 1，2，3，4，6，7，8 码元。</li>\n<li>分：7 位。第 10，11，12，13，15，16，17 码元。</li>\n<li>时：6 位。第 20，21，22，23，25，26 码元。</li>\n<li>天：10 位。第 30，31，32，33，35，36，37，38，40，41 码元。</li>\n</ul>\n<p>位置在 P0～P5 之间，P6～P0 包含其他控制信息。第 5，14，24 为索引标志，宽度为 2ms。时、分、秒均采用 BCD 码表示，低位在前，高位在后；个位在前，十位在后；个位和十位间有一个脉冲宽度为 2ms 的索引标志码元。</p>\n<blockquote>\n<p>BCD 码将每个十进制数字（0 到 9）表示为 4 位二进制数，每个十进制数的 4 位二进制编码之间通常使用特定的分隔符或标志码元分隔。</p>\n<p>例如，如果要表示十进制数 25，BCD 码会将其表示为两个 4 位二进制数，分别是 0010（十进制的 2）和 0101（十进制的 5）。</p>\n</blockquote>\n<p>从 P8 开始是 SBS 时间码，共 17 位二进制信号，每天重复。</p>\n<blockquote>\n<p>&quot;SBS 码&quot; 指的是 &quot;Second, Bits, and Status&quot;（秒、位和状态）编码。SBS 码是 IRIG-B 编码的一部分，用于传输与时间同步和时间标记相关的信息。</p>\n</blockquote>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/91kavc.png\" alt=\"IRIG-B结构\" /></p>\n<p>「图中的 <code>1,2,4,8 </code> 或 <code>10,20,40</code>  指的是如果该位置 <code>1</code> ，时间的大小」</p>\n<p>给出一张更详细的参考图：<br />\n<img data-src=\"http://imgcdn.gality.cn/blog/5y0rng.jpg\" alt=\"IRIG-B详细结构\" /></p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY3liZXItc2NpZW5jZXMuY29tL3dwLWNvbnRlbnQvdXBsb2Fkcy8yMDE5LzAxL1ROLTEwMl9JUklHLUIucGRm\">https://www.cyber-sciences.com/wp-content/uploads/2019/01/TN-102_IRIG-B.pdf</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2R5eDE5OTMvYXJ0aWNsZS9kZXRhaWxzLzExNDY1NTkyMg==\">https://blog.csdn.net/dyx1993/article/details/114655922</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS9JUklHLUIvMTU5ODYwOA==\">https://baike.baidu.com/item/IRIG-B/1598608</span></li>\n</ul>\n",
            "tags": [
                "杂项",
                "PNT",
                "授时",
                "学习笔记",
                "通信",
                "协议"
            ]
        },
        {
            "id": "https://gality.cn/ponder/Gresham-law/",
            "url": "https://gality.cn/ponder/Gresham-law/",
            "title": "劣币驱逐良币 ｜ 一次网购经历的反思",
            "date_published": "2023-10-26T11:12:26.000Z",
            "content_html": "<blockquote>\n<p>📖 <strong>Gresham’s law</strong>, observation in economics that “bad money drives out good.” More exactly, if coins containing metal of different value have the same value as legal tender, the coins composed of the cheaper metal will be used for payment, while those made of more expensive metal will be hoarded or exported and thus tend to disappear from circulation</p>\n</blockquote>\n<p><strong>劣币驱逐良币</strong>（<strong>Bad money drives out good</strong>），在经济学上也被称为<strong>葛兰辛法则</strong>、<strong>格勒善定律</strong>（<strong>Gresham's Law</strong>），是一种货币规律，指的是：如果有两种形式的商品货币流通，消费者会保留储存成色高（贵金属含量高）的货币，在市面使用成色低的货币进行市场交易，而使得在民间流通的大多为劣币，良币则较少见于世。</p>\n<h1 id=\"起源\"><a class=\"anchor\" href=\"#起源\">#</a> 起源</h1>\n<p>古罗马时代，货币价值还是由贵金属本身来锚定的（货币本身就是贵金属而非无价值的纸钞），这时的人们会私自从金银钱币上削下一小角，再将此种货币充当买卖媒介；因货币本身的贵金属含量减少，货币的价值也减小。久而久之，人们很快就觉察到市面上的贵金属货币越来越轻，就把未遭毁损的足值金银货币积存起来，只用那些不足值的货币进行买卖，而劣币则渐渐把良币从流通领域中排挤出去 [1]。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/izk3hd.png\" alt=\"西里克银币\" /></p>\n<h1 id=\"娱乐至死\"><a class=\"anchor\" href=\"#娱乐至死\">#</a> 娱乐至死</h1>\n<div class=\"note primary no-icon\">\n<p>❗️劣币驱逐良币的说法逐渐被广泛应用于非经济学的层面，人们用这一法则来泛指<strong>价值不高的东西会把价值较高的东西挤出流通领域</strong>，主要指假冒劣质产品在多种渠道向正牌商品挑战，并具有膨胀和蔓延的趋势。虽然这样的定义容易在学术讨论中引起争议，不过我并不准备进行严肃的学术讨论，so～</p>\n<p>关于劣币驱逐良币的讨论已经非常多了，这个词也已经被大众熟知且熟练使用了，所以不再过多赘述。引起我思考的是 “<strong>互联网时代</strong>” 的劣币驱逐良币。所以，请容我先介绍另外一个概念。</p>\n</div>\n<p>《<strong>娱乐至死</strong>》（Amusing Ourselves to Death）是尼尔・波兹曼 1985 年的著作。他指出，现实社会（书中主要以美国社会为例）的一切公众话语日渐以娱乐的方式出现，并成为一种文化精神。我们的政治、宗教、新闻、体育、教育和商业都心甘情愿的成为娱乐的附庸，其结果是我们成了一个娱乐至死的物种。它被认为是最重要的媒介生态学专著之一。</p>\n<p>但这里我不想讨论政治、宗教或新闻等，我只想借用书中的一点核心思想 “<strong>媒介即隐喻</strong>”，</p>\n<h2 id=\"媒介\"><a class=\"anchor\" href=\"#媒介\">#</a> 媒介</h2>\n<p>“媒介” 非常好理解，就是 “内容” 的载体，就像瓶子之于水一样，“瓶子” 就是媒介，而 “水” 则是内容。如果我们更加具体一点，聚焦到信息传播这个方面，那么报纸、电视、手机就是不同的媒介，这是一种浅显的理解；更深一层，博客、短视频也是不同的媒介，而” 内容 “就是信息本身。</p>\n<p>直觉一点来说，我们会认为媒介不影响内容，就像无论水用什么样的瓶子装着，水还是水，不会发生什么变化。但是我们再进一步，其实瓶子也是会影响水的，就像是拿铁桶装水，水中就会有更多的铁元素，这个过程并不明显，但是却在潜移默化的影响我们，而波兹曼强调的就是：媒介也会影响信息，甚至，媒介直接决定了信息。</p>\n<h2 id=\"隐喻\"><a class=\"anchor\" href=\"#隐喻\">#</a> 隐喻</h2>\n<p>从我们熟悉的 “比喻” 开始，我们从小学开始就在接收这样的训练：” 以下的句子中使用了那些修辞手法并简要分析 “，而” 比喻 “应该是我们最早学会的修辞手法了。这就像我们学数学会从加法学起一样，这是因为加法更加的通用和基础；最先学” 比喻 “的原因也是这样的，我们日常生活中也会经常使用。</p>\n<p>那么 “隐喻” 是什么呢？隐喻其实就是去掉了 “像” 的比喻，比如 “天空的乌云就像一只死了三个月的猫”，这就是比喻。 但如果用 “隐喻” 的方式来表达，就不会用 “像、似、如同” 这样的喻词来提醒你这是一种比喻，比如 “天空中有一只死了三个月的猫”，这就是 “隐喻”。</p>\n<p>乍一看 “隐喻” 和 “比喻” 也没什么区别，不过是去掉了喻词，我们还是能识别出隐喻也是在做比喻。但想想，如果我们平时说话的方式都是隐喻，如果每个人都是说 “天空中有一朵一只死了三个月的猫”，如果孩子从出生开始我们就告诉他乌云是死了三个月的猫，那慢慢的，我们就会忘记这是一种比喻，习惯于把 “乌云” 真的理解为 “死了三个月的猫”。</p>\n<p>进一步的，假设在 A 国，人们把乌云说成 “死了三个月的猫”，而在 B 国，人们把乌云说成 “一只生病的猫”，那么 A 国人的世界观可能就要比 B 国人更加现实和悲观。但人们却很难意识到这种世界观的差异来自于隐喻方式的差异 [2]，但是影响是客观存在的，这就是隐喻的力量。</p>\n<h2 id=\"媒介即隐喻\"><a class=\"anchor\" href=\"#媒介即隐喻\">#</a> 媒介即隐喻</h2>\n<p>“媒介即隐喻” 本身就是 “隐喻”，直白的说应该是 “媒介具有隐喻的特点”。<strong>媒介的特点就是帮助我们把客观事物看成虚构的符号（文字、图形）来理解客观事物，但在这个过程中，媒介本身却被忽视了。</strong></p>\n<p>举几个更加具体的例子，“书” 或者说是 “纸质” 作为一种信息传播媒介，其隐喻的结果就是 “理性、抽象、逻辑、严谨、全面...”。在过去，我们把写书称为 “著书立说”，只有某领域的 “大家” 才有资格去写书，如果某人没有能力，写出来的书也没有人看，这一点相信大家都能意识到。但是还有一点的事，书作为信息的媒介，除了其承载的内容在塑造读者，媒介本身也在塑造读者，“书” 这种媒介鼓励读者进行思辨、鼓励批判性，也正是如此，又反推得写书的人更加严谨、更加全面，这种双向的过程推动社会思维方式向 “理性” 的方向发展。</p>\n<p>对比来看 “短视频” 这种媒介，其隐喻的结果就是 “麻木、轻信、盲目...”。就拿我自身的观察来看，“搞笑的、滥俗的、擦边的” 主播涨粉非常快，只要你短视频足够搞笑，哪怕只是 “尴尬” 产生的节目效果，也会有非常多人乐意关注，对比来说，如果视频的内容是严肃的哲学思辨，那么甚至不会被平台的 “算法” 推流。同时，人一种很容易麻木的生物，之前喝一杯奶茶就可以满足，过一段时间就需要喝两杯才可以。久而久之，发视频的人越来越 “娱乐”，看视频的人也越来越 “娱乐”。手机这种媒介，本身就淘汰了过于严肃、艰涩的思辨，选择了夸张的音乐、配色、话语。</p>\n<h1 id=\"互联网时代的劣币\"><a class=\"anchor\" href=\"#互联网时代的劣币\">#</a> 互联网时代的劣币</h1>\n<p>劣币驱逐良币的过程往往伴随着 “信息差”：如果几天内所有人都知道 “良币” 需要收藏了，此时 “劣币” 还未来得及铺开，那么收藏的 “良币” 的价值就会下降。这里面蕴含的点在于，在过去，想主动靠 “劣币与良币” 的差异来获利是非常困难的：过长的共识统一时间、谨慎的交易态度、关注实际的思想、同类替代物的缺少等等都是阻碍。</p>\n<p>听起来是不是很熟悉，互联网时代完全解决了这些问题：物品种类的极大丰富、激进的交易态度、虚拟交易的接收...，最重要的是 “信息的高速传播”，在加之虚拟主体的出现于有限责任制度，用 “劣币驱逐良币” 的土壤也太肥沃了，以下商品运作方式完全是可行的：</p>\n<p>将融资的钱中的 10% 用于购买廉价低质原材料，30% 用于精致的包装设计和生产，余下 60% 用于各大平台的宣发，雇佣大量的水军和头部博主作宣传，然后将商品高价卖出。最终在获利开始减少的时候，注销该品牌和公司，然后再注册一家，开始新的赚钱轮回。</p>\n<p>这样的事相信大家一定都能举出一两个例子来，我们至少是我，一直是懂这个道理的，但是对于这个 “融资” 规模的认知还是不够的，在现在这个时代，其实并不需要很大的融资规模就可以达到这个效果，这代表” 劣币 “出现的成本非常下，同时也就意味着就在我们身边，非常常见。让我产生深刻认知的是我在购买某商品时观察到的真实现象：</p>\n<p>我在 “x 红书” 平台上搜索了某类商品的测评推荐，其中有两个品牌几乎被推荐，列为性价比最高、效果最好的那一批，但是很有意思的一点是，在推荐 A 商品的文章中，压根找不到 B 商品的影子，而在推荐 B 商品的文章中也根本找不到 A 商品。这件事是非常奇怪的，按理来说，如果某个商品非常推荐，那么即使在另外的文章中也至少应该被提到，但现实是完全没有！</p>\n<p>于是我开始在去需要这两个牌子的旗舰店，并去搜索其营业执照及相关资质，最终发现这两家都是非常新的品牌，其源头厂商在这类商品的生产商中也并不出众，理论来说没有足够的资质来生产顶级的产品，顺便提一下，按实际成分来算，A、B 商品的单位有效成分价格比头部厂商更贵，那么到此时，真相也就浮出水面了，幸好，我没有成为 2.3 万订单中的一个。</p>\n<p>互联网时代对于 “劣币” 真的是最好的时代，人类本身就是从众的，而互联网可以很方便的针对某一群体构建专属的” 信息茧房 “从而操控人的选择。同时，这种信息茧房可以让 “<strong>信息不包含信息</strong>”（第一个信息指 “消息”，第二个信息指 “用于决策的知识”）：当你看见推荐，你会怀疑是 “广”；当你看见差评，你会怀疑是其他品牌的 “踩”。人的选择本来是基于知识的，当人接触到的无数信息本身却不包含任何知识的时候，人该怎么做出正确的选择呢？</p>\n<h1 id=\"对策\"><a class=\"anchor\" href=\"#对策\">#</a> 对策</h1>\n<p>当然，这个可行方案并不完善，其最本质的基于的逻辑是 “楚门的世界无法<strong>完全</strong>模拟整个世界”，商家无法影响到生活的方方面面，那么就一定会有一些背离逻辑的地方。我认为可行的方法论如下：</p>\n<ul>\n<li>交叉对比多个文章中的共同项，对于所有差异项都持谨慎态度。</li>\n<li>对 “强推” 的东西提高警惕，特别是你感觉刷到的所有文章都在吹怎么怎么好。</li>\n<li>要认识到事物的延续性，凡事吹嘘立刻见效的东西，持谨慎态度。</li>\n<li>交叉对比不同信息渠道，这个不同是指不同严肃程度的信息渠道，“d 音” 和 “x 红书” 不是两个渠道，“z 乎” 和 “x 红书” 才基本算，如果有论文，就更好了。</li>\n</ul>\n<p>总的来说，就是持怀疑的态度做选择，用理性克制冲动，有交叉比对对抗信息茧房，主动破开他。</p>\n<h1 id=\"思考\"><a class=\"anchor\" href=\"#思考\">#</a> 思考</h1>\n<h2 id=\"真就无法可治吗\"><a class=\"anchor\" href=\"#真就无法可治吗\">#</a> 真就无法可治吗？</h2>\n<p>在我开始思考这个问题的时候，我觉得是监管不力、制度缺失、惩罚不够导致的 “劣币” 泛滥，但仔细想想，其实不是这样的，“劣币驱逐良币” 是一种根植于人类贪婪本性的原理，制度本身是为人服务的，也就自然会为 “劣币” 开绿灯。一个简单的例子是：国家层面可以对所有市场上的企业进行严苛的监管，每天都派专人检查核对；所有有欺骗行为的商家直接全部死刑。想想很解气是吧？但是谁会来当商家呢？如果商品总体的选择变少了，人们的生活是变好了还是变差了呢？</p>\n<p>我承认，现行制度、监管一定是有可以改进的地方，但是要认识到制度、监管在进步，而 “劣币” 也在进步，根植于人类深处的东西是不会被人类发明的东西打败的，所以，我得出的结论是：真的无法可治，我们只能 “自我救赎”。</p>\n<h2 id=\"可能的自我救赎\"><a class=\"anchor\" href=\"#可能的自我救赎\">#</a> 可能的自我救赎？</h2>\n<p>曾经有两大人类自由终结的预言：</p>\n<ul>\n<li>\n<p><em>“奥尔威的《1984》：人类受到外来的压迫失去自由”</em>。</p>\n</li>\n<li>\n<p><em>“赫胥黎的《美丽新世界》：人类爱上工业技术带来的娱乐和文化不再思考。”</em></p>\n</li>\n</ul>\n<p>但此时，我不禁在想，会不会有另外一种可能性，现代的人类经过各种广告的洗礼，从个人利益的角度出发，重新掌握批判性思维来捍卫自己的利益。互联网确实会让很多人上当受骗，但仔细想想，现在大家的反诈意识不也有所提高了嘛？我知道这样的认识确实很乐观，但乐观一点有何不好呢？</p>\n<h2 id=\"魔法对抗魔法\"><a class=\"anchor\" href=\"#魔法对抗魔法\">#</a> 魔法对抗魔法？</h2>\n<p>由于最近在学习网络内容安全和机器学习的知识，我不禁想，这件事应该是可以通过机器学习来解决的，如果说互联网时代的” 劣币 “传播的相似点是 “<strong>用海量的信息去瘫痪人的信息处理能力</strong> “，那为什么不让信息处理能力更强的 “机器” 去处理这些信息并分析出端倪呢？我认为这件事应该是可以做到的，但是，显而易见的利益原因可能使他的诞生困难重重，但是，“太阳一定会升起”。</p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<ul>\n<li>[1] <span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JThBJUEzJUU1JUI5JUEzJUU5JUE5JTg1JUU5JTgwJTkwJUU4JTg5JUFGJUU1JUI5JUEz\">https://zh.wikipedia.org/wiki/ 劣幣驅逐良幣</span></li>\n<li>[2] <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vcmV2aWV3LzEyMTE4OTQxLw==\">https://book.douban.com/review/12118941/</span></li>\n</ul>\n",
            "tags": [
                "思考与沉淀",
                "思考"
            ]
        },
        {
            "id": "https://gality.cn/misc/PNT/fiber-optic-and-WDM/",
            "url": "https://gality.cn/misc/PNT/fiber-optic-and-WDM/",
            "title": "光纤通信原理与技术",
            "date_published": "2023-10-25T08:19:46.000Z",
            "content_html": "<h1 id=\"光纤通信原理\"><a class=\"anchor\" href=\"#光纤通信原理\">#</a> 光纤通信原理</h1>\n<h2 id=\"理论前提\"><a class=\"anchor\" href=\"#理论前提\">#</a> 理论前提</h2>\n<p>“光纤” 这个词可以拆开来理解，“光” 是指信息的传输形式是依靠光的形式；“纤” 是指传输介质为玻璃纤维。让 “光” 来传输信息的前提是 **“全反射”** 现象的发现。</p>\n<blockquote>\n<p><strong>” 全反射 “</strong> 现象是指当光线从光密介质进入光疏介质，且入射角大于临界角时，折射光线完全消失，只留下反射光线的现象。</p>\n</blockquote>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/o2g0de.png\" alt=\"全反射\" /></p>\n<p>基于这个现象，我们可以设计出一种圆形的导线结构（其实就是光纤），只需要在更中心的位置选用合适的光密材料，外围选用合适的光疏材料，再结合一个合适的入射角，就可以使光在导线不断的反射，并不断向前传播。</p>\n<p>光纤的纤芯主要采用高纯度的二氧化硅 (SiO<sub>2</sub>)，并掺有少量的掺杂剂，提高纤芯的光折射率 n1；包层也是高纯度的二氧化 (SiO<sub>2</sub>)，也掺有一些的掺杂剂，以降低包层的光折射率 n2， 且 n1＞n2，发生全反射；涂覆层采用丙烯酸酯、硅橡胶、尼龙，增加机械强度和可弯曲性。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/puwff9.png\" alt=\"光纤示意图\" /></p>\n<p>这就是可以用光来传递信息的理论基础和材料基础，至此，用光来传输信息有了理论上的可行性。</p>\n<h2 id=\"光纤工作原理\"><a class=\"anchor\" href=\"#光纤工作原理\">#</a> 光纤工作原理</h2>\n<p>光纤只是光传输的通道，具体光的怎么传输的呢？</p>\n<p>首先，发射端把要传输的信息（如话音等）转换为电信号，然后通过激光器发射到激光束上，光的强度会随电信号的频率一起变化，并通过光纤发射出去；在接收端，检测器受到光信号后把它变成电信号，经过处理后恢复原信息。</p>\n<p>单一的光纤信道容量有限，于是我们考虑将多个光纤结合在一起来增大容量：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/gwq3av.jpg\" alt=\"光缆示意图\" /></p>\n<p>光纤内部用玻璃纤维制成的光导纤维，可以把光信号传输到几千公里外，将几百上千根光导纤维组合在一起，制成像电缆一样的光缆，这样既提高了光导纤维的强度，又大大增加了通讯容量。</p>\n<p>光信号就是在光纤内经过一次次的折射传输到终点的，光信号在一次次折射后会分散或者衰减，因此需要把光信号每 50 公里放大一次。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/y72w4r.png\" alt=\"光信号传输\" /></p>\n<h1 id=\"数据传输\"><a class=\"anchor\" href=\"#数据传输\">#</a> 数据传输</h1>\n<h2 id=\"信道容量\"><a class=\"anchor\" href=\"#信道容量\">#</a> 信道容量</h2>\n<p>光纤信道容量的大小受很多因素的影响，例如：调制技术、光纤质量、带宽、光源检测器、WDM 技术等等等，我们先来考虑单根光纤、单一光线且没有任何调制技术的情况，<strong>香农 - 哈特利定理</strong>给出了在存在噪声的情况下，信息可以通过给定带宽的通信信道中传输的最大速率（信道容量）：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>C</mi><mo>=</mo><mi>B</mi><mo>⋅</mo><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><mi>S</mi><mi>N</mi><mi>R</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">C = B \\cdot log_2(1+SNR)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p>其中：</p>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span> 代表信道的容量，单位为比特每秒或奈特每秒，为理论上的不包含纠错码的最大比特率。</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span> 代表信道的带宽，单位为赫兹（Hz）。</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi><mi>N</mi><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">SNR</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span> 代表信噪比，是信号功率与噪声功率之比，通常以线性比值来表示（<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi><mi mathvariant=\"normal\">/</mi><mi>o</mi><mi>v</mi><mi>e</mi><mi>r</mi><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">S /over N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord\">/</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span> ）。</li>\n</ul>\n<p>这个公式表明，信道容量与带宽和信噪比之间存在对数关系。增加带宽或提高信噪比都可以增加信道的容量。</p>\n<h2 id=\"传输速率\"><a class=\"anchor\" href=\"#传输速率\">#</a> 传输速率</h2>\n<p>需要注意的是，光在光纤中的传输速度并不是 “光速”（真空中，约为 299,792,458 米 / 秒），而是速度略慢，大约为真空中光速的 2/3 左右，这是由光纤材质的折射率来决定的，折射率的定义为：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>n</mi><mo>=</mo><mfrac><mi>c</mi><mi>v</mi></mfrac></mrow><annotation encoding=\"application/x-tex\">n = \\frac{c}{v}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.7935600000000003em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.10756em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p>其中：</p>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 是折射率（真空的折射率被定义为 1）。</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span></span></span></span> 真空中的光速。</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 是光在特定介质中的传播速度，通常以米 / 秒为单位。</li>\n</ul>\n<p>折射率是一个材料特性，材料制造完成后就已经确定了，代表了光在该材料中传播速度相对于真空中光速的比值。在光纤中，通常会选择具有高折射率的材料作为光纤内芯，而折射率越高，光速就越慢，因此光在光纤内芯中传播时速度较慢。</p>\n<h2 id=\"增大信道容量\"><a class=\"anchor\" href=\"#增大信道容量\">#</a> 增大信道容量</h2>\n<p>在实际应用中，我们会想要尽可能的增大信道的容量，使得光纤可以传输更多的信息，除了将多根光纤绑在一起形成光缆这样暴力的增加方式外，还可以考虑怎么提高单根光纤的信道容量。这时我们会联想到光的 “色散” 现象。</p>\n<h3 id=\"色散\"><a class=\"anchor\" href=\"#色散\">#</a> 色散</h3>\n<p>我们知道，光的频率和波长之间关系为：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>c</mi><mo>=</mo><mi>λ</mi><mo>⋅</mo><mi>f</mi></mrow><annotation encoding=\"application/x-tex\">c = \\lambda \\cdot f\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span></span></span></p>\n<p>其中：</p>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span></span></span></span> 是光速，指的是材料中的光速。</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi></mrow><annotation encoding=\"application/x-tex\">\\lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span></span></span></span> 是光的波长，通常以米为单位。</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi></mrow><annotation encoding=\"application/x-tex\">f</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span></span> 是光的频率，通常以赫兹（Hz）为单位。</li>\n</ul>\n<div class=\"note primary\">\n<p>严格意义上来说，公式中的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span></span></span></span> 应该是通过 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mo>=</mo><mfrac><msub><mi>c</mi><mn>0</mn></msub><mi>n</mi></mfrac></mrow><annotation encoding=\"application/x-tex\">c=\\frac{c_0}{n}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.056492em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7114919999999999em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.4101em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31731428571428577em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span> 计算得到的，其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>c</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">c_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 为真空中光速，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 为材料的折射率。在实际情况中通常情况下，对于一般工程和计算，不考虑材料的将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span></span></span></span> 当作真空光速也是可以的，对于大多数应用来说其误差可以忽略不计。</p>\n</div>\n<p>上面的公式告诉我们，不同颜色（频率）的光在光纤中传输速度是不一样的，这就是光的 “<strong>色散</strong>”，在光纤传输中，我们可以将不同颜色的光复合起来一起传播，接收端在接收时再将这些光分离出来就可以了，这就是 “<strong>波分复用（Wavelength Division Multiplexing，WDM）</strong>” 技术的思想。</p>\n<h3 id=\"波分复用技术\"><a class=\"anchor\" href=\"#波分复用技术\">#</a> 波分复用技术</h3>\n<p>波分复用（Wavelength Division Multiplexing，WDM）技术用于增大光通信系统的信道容量，是一种光通信中常用的多路复用技术。WDM 技术允许同时在光纤中传输多个不同波长（或频率）的光信号，每个波长光信号都可以携带独立的数据流，从而有效地增加了光纤通信系统的信道容量。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/8z24ob.png\" alt=\"波分复用示意图\" /></p>\n<p>WDM 技术的核心思想是利用<strong>光的不同波长来传输不同的信号</strong>，就像广播电视中使用不同频道来传输不同节目一样。通过将多个波长的光信号合并到同一根光纤中，使得多个独立的通信信道在相同的物理基础设施上共存，从而大幅提高了通信系统的容量</p>\n<p>对于采用 WDM 的系统来说，想让其正常运行，需要控制各个光信号的波长，如果波长间隔太短的话，很容易区分不开；而如果波长间隔过长，利用率又会降低。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/ufhx5g.png\" alt=\"WDM波长示意图\" /></p>\n<p>早期的时候，技术条件有限，波长间隔会控制在几十纳米，这种比较分散的 WDM 被称为 “<strong>稀疏波分复用（ Coarse WDM，CWDM）</strong>”。后来，技术越来越先进，波长间隔压得越来越短，到了几 纳米 的级别，就成了紧密的 WDM，叫做 “<strong>密集波分复用（Dense WDM，DWDM）</strong>”</p>\n<p>CWDM 的波长间隔 20nm，波长范围从 1270nm 到 1610nm，有 18 个波段。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/hefojm.png\" alt=\"CWDM中心波段\" /></p>\n<p>「因为 1270-1470nm 波段有明显的衰减增加，很多旧型光纤不能正常使用，所以 CWDM 一般优先使用 1470~1610nm 的 8 个波段。」</p>\n<p>DWDM 的波长间隔可以是 1.6nm、0.8nm、0.4nm、0.2nm，可以容纳 40、80、160 个波（最大可支持 192 波）。DWDM 的波长范围为 1525nm 至 1565nm（C 波段）和 1570nm 至 1610nm（L 波段）。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/0yra5z.png\" alt=\"DWDM波段\" /></p>\n<p>DWDM 常用 C 波段，波长间隔 0.4nm，通路频率间隔 50GHz。</p>\n<p>以上就是光纤通信最基本的原理和波分复用技术，在实际的传输过程中，在最基本的物理层之上为了实现不同的目的，还会对信号进行编码，我们会在下一篇文章中讨论。</p>\n",
            "tags": [
                "杂项",
                "PNT",
                "授时",
                "学习笔记",
                "通信",
                "PNT"
            ]
        },
        {
            "id": "https://gality.cn/ml/regularization/",
            "url": "https://gality.cn/ml/regularization/",
            "title": "ML Regularization",
            "date_published": "2023-10-24T11:39:12.000Z",
            "content_html": "<div class=\"note info no-icon\">\n<p>之前写大作业的时候涉及到了正则化的知识，但由于在实际训练过程中发现效果不是很好，就没有深入研究了，这里记录一下。</p>\n</div>\n<h1 id=\"问题引入\"><a class=\"anchor\" href=\"#问题引入\">#</a> 问题引入</h1>\n<p>我们假设这样一个问题：给出房屋大小和对应的房屋售价，寻找某一个函数来描述大小和售价的关系（具体数据是什么样的不重要，我们要看思想）。</p>\n<h2 id=\"一次方程\"><a class=\"anchor\" href=\"#一次方程\">#</a> 一次方程</h2>\n<p>首先，我们考虑用一个线性方程去拟合，例如：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>y</mi><mo>=</mo><mi>b</mi><mo>+</mo><mi>w</mi><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">y=b+wx\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">x</span></span></span></span></span></p>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span>：房屋售价</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span>：房屋面积</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi></mrow><annotation encoding=\"application/x-tex\">w</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span></span></span></span>：权重（weight）</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>b</mi></mrow><annotation encoding=\"application/x-tex\">b</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">b</span></span></span></span>：偏差（bias）</li>\n</ul>\n<p>此时，机器学习的目标就是去寻找到一组参数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mrow><mi>b</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mrow><mi>b</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(w_{best}, b_{best})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> ，使得 loss 最小，一个可能的函数图像为：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/onm4vf.png\" alt=\"线性方程\" height=\"210\" /></p>\n<p>可以看到，线性方程不太能描述房屋大小和售价的关系，这种情况我们称为 <strong>“欠拟合”</strong> 。</p>\n<h2 id=\"二次方程\"><a class=\"anchor\" href=\"#二次方程\">#</a> 二次方程</h2>\n<p>尝试用二次函数去描述二者关系，例如：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>y</mi><mo>=</mo><mi>b</mi><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><mi>x</mi><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msup><mi>x</mi><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">y = b + w_1x + w_2x^2\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.73333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0141079999999998em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>那么机器学习的目标就是找到一组参数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mrow><mn>1</mn><mi>b</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow></msub><mo separator=\"true\">,</mo><msub><mi>w</mi><mrow><mn>2</mn><mi>b</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow></msub><mo separator=\"true\">,</mo><mi>b</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(w_{1best}, w_{2best}, b)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mclose\">)</span></span></span></span> 使 loss 最小。可以看到，可学习的参数多了一个，模型的学习能力也会增强，理论来说，机器可以找到一个具有更强的描述能力的函数，此时，学习到的模型的函数图像可能为：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/9ratys.jpg\" alt=\"二次方程\" height=\"210\" /></p>\n<p>可以看到，描述效果更好了一些。那我们可以很容易的想到，只需要更高次的多项式，就可以达到更好的学习效果，为了对比明显一点，我们看看选用八次多项式作为模型时的效果。</p>\n<h2 id=\"八次多项式\"><a class=\"anchor\" href=\"#八次多项式\">#</a> 八次多项式</h2>\n<p>当利用八次多项式来描述二者关系时，机器可学习的参数就有 9 个，学习能力大大提升，八次多项式形如：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>y</mi><mo>=</mo><mi>b</mi><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><mi>x</mi><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo>+</mo><msub><mi>w</mi><mn>8</mn></msub><msup><mi>x</mi><mn>8</mn></msup></mrow><annotation encoding=\"application/x-tex\">y = b + w_1x+w_2x^2+...+w_8x^8\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.73333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0141079999999998em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0141079999999998em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">8</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">8</span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>此时，学习到的模型的函数图像可能为：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/gprobe.png\" alt=\"8次多项式\" height=\"210\" /></p>\n<p>由于我这里的数据点比较少，理论来说八次多项式已经可以近乎完美的拟合出样例的函数曲线了，事实也正是如此，但是我们发现了此时的曲线中，在部分面积下，售价甚至出现了负数的情况，这显然是不可能，这种情况我们称为 <strong>“过拟合”</strong>。</p>\n<h1 id=\"正则化\"><a class=\"anchor\" href=\"#正则化\">#</a> 正则化</h1>\n<p>正则化就是为了解决模型的过拟合问题而提出的，回顾我们的 loss 函数（用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\hat y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span></span></span></span> 代指 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 的实际值）：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>L</mi><mo>=</mo><mo>∑</mo><mo stretchy=\"false\">(</mo><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo>−</mo><mi>y</mi><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>=</mo><mo>∑</mo><mo stretchy=\"false\">(</mo><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo>−</mo><mo stretchy=\"false\">(</mo><mi>b</mi><mo>+</mo><mo>∑</mo><msub><mi>w</mi><mi>i</mi></msub><mi>x</mi><mo stretchy=\"false\">)</mo><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">L = \\sum (\\hat y - y)^2 = \\sum (\\hat y -(b + \\sum w_ix))^2\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.6000100000000002em;vertical-align:-0.55001em;\"></span><span class=\"mop op-symbol large-op\" style=\"position:relative;top:-0.000004999999999977245em;\">∑</span><span class=\"mopen\">(</span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1141079999999999em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.6000100000000002em;vertical-align:-0.55001em;\"></span><span class=\"mop op-symbol large-op\" style=\"position:relative;top:-0.000004999999999977245em;\">∑</span><span class=\"mopen\">(</span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">b</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.6000100000000002em;vertical-align:-0.55001em;\"></span><span class=\"mop op-symbol large-op\" style=\"position:relative;top:-0.000004999999999977245em;\">∑</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>此时我们可以引入一个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi><mo>∑</mo><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mi>i</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">\\lambda \\sum(w_i)^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.064118em;vertical-align:-0.25001em;\"></span><span class=\"mord mathnormal\">λ</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span> 项，此时公式变为：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>L</mi><mo>=</mo><mo>∑</mo><mo stretchy=\"false\">(</mo><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo>−</mo><mo stretchy=\"false\">(</mo><mi>b</mi><mo>+</mo><mo>∑</mo><msub><mi>w</mi><mi>i</mi></msub><mi>x</mi><mo stretchy=\"false\">)</mo><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mi>λ</mi><mo>∑</mo><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mi>i</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">L = \\sum (\\hat y -(b + \\sum w_ix))^2 + \\lambda \\sum(w_i)^2\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.6000100000000002em;vertical-align:-0.55001em;\"></span><span class=\"mop op-symbol large-op\" style=\"position:relative;top:-0.000004999999999977245em;\">∑</span><span class=\"mopen\">(</span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">b</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.6000100000000002em;vertical-align:-0.55001em;\"></span><span class=\"mop op-symbol large-op\" style=\"position:relative;top:-0.000004999999999977245em;\">∑</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.6000100000000002em;vertical-align:-0.55001em;\"></span><span class=\"mord mathnormal\">λ</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-symbol large-op\" style=\"position:relative;top:-0.000004999999999977245em;\">∑</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>引入的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi><mo>∑</mo><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mi>i</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">\\lambda \\sum(w_i)^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.064118em;vertical-align:-0.25001em;\"></span><span class=\"mord mathnormal\">λ</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span> 项（称为正则项），是用于限制了 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">w_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的大小的，我们希望 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">w_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 尽可能的小，来使得曲线相对更加平滑。我们看八次多项式的拟合曲线，某种意义上来说，就是因为曲线太陡峭，变化太过剧烈，才导致对显示情况的描述的失真，在实际中，变化一般都是相对平缓的，所以，更加平滑的曲线一般来说会更加贴近现实一些，防止过拟合。</p>\n<p>但是需要注意的是，我们追求的是曲线的 <strong>“相对”</strong> 平滑，而非 <strong>“绝对”</strong> 平滑，直线就是最平滑的曲线了，但并不能很好的描述现实。那么，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi></mrow><annotation encoding=\"application/x-tex\">\\lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span></span></span></span> 就是由于控制这个平滑程度的，称为 <strong>“正则化参数”</strong> 。如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi></mrow><annotation encoding=\"application/x-tex\">\\lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span></span></span></span> 非常下，模型相当于基本没有被修正；如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi></mrow><annotation encoding=\"application/x-tex\">\\lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span></span></span></span> 非常大，loss 想更小只能让 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub><mo>→</mo><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">w_i  \\rightarrow 0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span></span></span></span> ，此时寻找到的模型就会趋向于一条直线，所以，在实际情况下，我们需要选取合适的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi></mrow><annotation encoding=\"application/x-tex\">\\lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span></span></span></span> 值。</p>\n<p>以上就是正则化的基本思想，正则项其实限制了模型的复杂程度，引入正则化后，机器需要找到一个 <strong>选择经验风险</strong>（第一项）和 <strong>模型复杂度</strong>（正则项）同时较小的模型，从而降低了 “过拟合” 的风险。</p>\n<p>还有一点需要注意的是：正则项中无需包含参数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>b</mi></mrow><annotation encoding=\"application/x-tex\">b</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">b</span></span></span></span>，因为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>b</mi></mrow><annotation encoding=\"application/x-tex\">b</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">b</span></span></span></span> 的改变只会让曲线平移而已，对于曲线本身的形态不产生影响，所以正则项无需包含。</p>\n<p>常见的有正则项有 <strong>L1 正则</strong> 和 <strong>L2 正则</strong> ，其中 L2 正则 的控制过拟合的效果比 L1 正则 的好。这两个正则项在框架中都已经实现了，直接用就可以了，就不过多赘述了。当然，控制过拟合风险的方法还有 <strong>Dropout</strong>，我觉得会更好用一些。</p>\n<h1 id=\"画图所用网站\"><a class=\"anchor\" href=\"#画图所用网站\">#</a> 画图所用网站</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5xaW5tcy5jb20vd2ViYXBwL2N1cnZlZml0L2NmLmFzcHg=\">http://www.qinms.com/webapp/curvefit/cf.aspx</span></li>\n</ul>\n",
            "tags": [
                "机器学习",
                "机器学习",
                "深度学习",
                "正则化"
            ]
        },
        {
            "id": "https://gality.cn/misc/trail-and-error/Mac-Latex/",
            "url": "https://gality.cn/misc/trail-and-error/Mac-Latex/",
            "title": "Mac下Latex论文一条龙",
            "date_published": "2023-10-23T12:12:12.000Z",
            "content_html": "<div class=\"note info no-icon\">\n<p>先说最终结论：</p>\n<ul>\n<li>Visual Studio Code：LaTex 论文编写 IDE</li>\n<li>MacTex：LaTex 编译引擎</li>\n<li>Zotero：论文管理工具</li>\n<li>vscode 插件：\n<ul>\n<li>LaTex Workshop：使用 VSCode 编写 LaTex 的核心插件，必需</li>\n<li>LaTex Utilities：基于 LaTex Workshop 的增强插件，非必需</li>\n<li>Code Spell Checker：自动拼写检查插件，非必需</li>\n<li>Ultra Math Preview：数学公式自动预览插件，非必需</li>\n</ul>\n</li>\n</ul>\n</div>\n<div class=\"note primary no-icon\">\n<p>懒狗看这里：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cub3ZlcmxlYWYuY29tLw==\">在线 LaTex 编辑器</span></p>\n<p>开箱即用，包含了编辑 LaTex 所需要的一切，还是在线编译保存，如果不是像我一样就喜欢在本地编写的话可以选用这个。</p>\n</div>\n<h1 id=\"环境\"><a class=\"anchor\" href=\"#环境\">#</a> 环境</h1>\n<h2 id=\"visual-studio-code\"><a class=\"anchor\" href=\"#visual-studio-code\">#</a> Visual Studio Code</h2>\n<p>跨环境 IDE，自身非常轻量的同时，还可以通过丰富的扩展插件来支持各种语言，安装过程就是下载点击，非常简单，就不过多赘述了。</p>\n<h2 id=\"mactex\"><a class=\"anchor\" href=\"#mactex\">#</a> MacTex</h2>\n<p>Mac 环境下的 LaTex 编译引擎，将 LaTex 编译成 pdf 的必需核心。</p>\n<p>下载地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly90dWcub3JnL21hY3RleC9tYWN0ZXgtZG93bmxvYWQuaHRtbA==\">https://tug.org/mactex/mactex-download.html</span></p>\n<p>下载后同样是点击安装，但是安装程序本身没有自动添加环境变量，所以说，如果想跟 VSCode 联合使用的话，还需要自行添加环境变量。就 2023 年而言，默认安装地址为： <code>/usr/local/texlive/2023/</code> ，其应用的位置为： <code>./bin/universal-darwin</code> ，所以，我们可以用如下命令添加环境变量：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"export PATH=/usr/local/texlive/2023/bin/universal-darwin:<span class=\"token variable\">$&#123;<span class=\"token environment constant\">PATH</span>&#125;</span>\"</span> <span class=\"token operator\">>></span> ~/.zshrc</pre></td></tr></table></figure><h2 id=\"zotero\"><a class=\"anchor\" href=\"#zotero\">#</a> Zotero</h2>\n<p>Zotero 是一个免费、开源、易用的文献管理软件，可以高效的组织需要的文献，配合浏览器插件可以一键将 Web 中的论文保存到 Zotero 中，结合 Better BibTeX for Zotero 还可以便捷的将论文引用到文章中。</p>\n<p>下载地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuem90ZXJvLm9yZy9kb3dubG9hZC8=\">https://www.zotero.org/download/</span></p>\n<p>浏览器插件安装地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jaHJvbWUuZ29vZ2xlLmNvbS93ZWJzdG9yZS9kZXRhaWwvem90ZXJvLWNvbm5lY3Rvci9la2hhZ2tsY2piZHBhamdwamdtYmlvbm9obHBkYmpnYw==\">https://chrome.google.com/webstore/detail/zotero-connector/ekhagklcjbdpajgpjgmbionohlpdbjgc</span></p>\n<h2 id=\"vscode-插件\"><a class=\"anchor\" href=\"#vscode-插件\">#</a> VSCode 插件</h2>\n<p>VSCode 的插件都是在插件市场中点击安装的，所以安装过程就不细说了。</p>\n<h3 id=\"latex-workshop\"><a class=\"anchor\" href=\"#latex-workshop\">#</a> LaTex Workshop</h3>\n<p>网上很多教程都比较老了，说是需要配置一大堆东西，但其实现在的 LaTex Workshop 的默认配置已经很好了，我们只需要对配置文件的编译工具 <code>latex-workshop.latex.tools</code>  稍做修改即可：</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"latex-workshop.latex.tools\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>          <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"latexmk\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>          <span class=\"token property\">\"command\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"latexmk\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>          <span class=\"token property\">\"args\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token string\">\"-synctex=1\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token string\">\"-interaction=nonstopmode\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token string\">\"-file-line-error\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token string\">\"-xelatex\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token string\">\"-outdir=%OUTDIR%\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token string\">\"-cd\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token string\">\"%DOC%\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token property\">\"env\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token property\">\"latex-workshop.synctex.afterBuild.enabled\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>另外，配置编译完成后将 pdf 自动同步到代码中光标位置：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/tdeh1n.png\" alt=\"配置\" /></p>\n<p>很多教程中还使用到了外部的 pdf 浏览工具例如 skim 等，实际测试中内置 pdf 浏览器功能已经足够强大了，个人认为无需额外下载 pdf 工具并配置。</p>\n<h3 id=\"latex-utilities\"><a class=\"anchor\" href=\"#latex-utilities\">#</a> LaTex Utilities</h3>\n<p>对 LaTex Workshop 的功能进行增强，配合 Better BibTeX for Zotero 和 Zotero 可以便捷的进行论文引用。总之，安装就对了。</p>\n<h3 id=\"code-spell-checker\"><a class=\"anchor\" href=\"#code-spell-checker\">#</a> Code Spell Checker</h3>\n<p>英语单词拼写检查插件，个人觉得还是挺有用的，平时在打英文的时候偶尔脑子抽筋，打错了又不容易看出来，这个插件可以很好的帮助到我。</p>\n<h3 id=\"ultra-math-preview\"><a class=\"anchor\" href=\"#ultra-math-preview\">#</a> Ultra Math Preview</h3>\n<p>实时数学公式预览插件，插件说明中有详细的演示，对于我这种初学 LaTex 公式、根本对于自己打的是什么没太大概念的人很有帮助，无需等待编译看结果了，数学公式可以试试反馈。</p>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>我们以 IEEE 的模版为例来演示如何使用。</p>\n<p>官方模版下载地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuaWVlZS5vcmcvY29udGVudC9kYW0vaWVlZS1vcmcvaWVlZS93ZWIvb3JnL3B1YnMvY29uZmVyZW5jZS1sYXRleC10ZW1wbGF0ZV8xMC0xNy0xOS56aXA=\">https://www.ieee.org/content/dam/ieee-org/ieee/web/org/pubs/conference-latex-template_10-17-19.zip</span></p>\n<p>下载解压后，直接在 VSCode 中打开文件夹，当 VSCode 检测到 LaTex 相关文件后，会在右边显示出 <code>TEX</code>  的标签</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/48ni7f.jpg\" alt=\"界面图\" /></p>\n<p>在 <code>TEX</code>  页面有更多功能且带有说明，可根据说明自行探索：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/b1g359.jpg\" alt=\"Tex界面\" /></p>\n<h1 id=\"快捷键\"><a class=\"anchor\" href=\"#快捷键\">#</a> 快捷键</h1>\n<p>一些使用中的 Tips：</p>\n<ul>\n<li>正向定位：<span class=\"kbd\">⌘</span> + <span class=\"kbd red\">⌥</span> +  <span class=\"kbd purple\">J</span> 将 pdf 定位到代码中光标位置。</li>\n<li>反向定位：在内置 pdf 预览中使用 <span class=\"kbd\">⌘</span> + <span class=\"kbd red\">左键</span> 点击单词，实现反向定位 <code>.tex</code>  中代码位置。</li>\n<li>拼写纠错：光标移动到有问题的拼写上，使用 <span class=\"kbd\">⌘</span> + <span class=\"kbd red\">.</span> 显示纠正备选。</li>\n</ul>\n",
            "tags": [
                "杂项",
                "踩坑",
                "杂项",
                "踩坑",
                "Latex"
            ]
        },
        {
            "id": "https://gality.cn/ml/homework/HW-1/",
            "url": "https://gality.cn/ml/homework/HW-1/",
            "title": "李宏毅ML2022-Spring大作业01｜COVID-19 Cases Prediction (Regression)",
            "date_published": "2023-10-18T06:22:27.000Z",
            "content_html": "<div class=\"note info no-icon\">\n<p>李宏毅老师 2022 年春季学习机器中留的第一次大作业，需要根据各项疫情相关数据，自行实现网络结构并训练模型，最终实现一个可以精准预测疫情增长人数的深度学习模型。</p>\n</div>\n<h1 id=\"大作业内容\"><a class=\"anchor\" href=\"#大作业内容\">#</a> 大作业内容</h1>\n<p>根据人们填写的日常调查问卷，设计并实现一个深度学习模型用于 COVID-19 感染人数的预测。</p>\n<p>具体的作业手册请参考<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb2xhYi5yZXNlYXJjaC5nb29nbGUuY29tL2RyaXZlLzFGVGNHNkNFLUhJTG52Rnp0RUZLZGF1TWxQS2ZRdm01Wg==\">官方手册</span>。</p>\n<h2 id=\"详细描述\"><a class=\"anchor\" href=\"#详细描述\">#</a> 详细描述</h2>\n<ul>\n<li>目标：预测 COVID-19 感染人数</li>\n<li>数据来源：Delphi group @ CMU「A daily survey April 2020 via facebook」</li>\n<li>输入输出要求：提供美国某州过去 4 天的调查问卷结果，然后预测第 5 天的新增阳性病例的百分比。</li>\n</ul>\n<h2 id=\"数据格式\"><a class=\"anchor\" href=\"#数据格式\">#</a> 数据格式</h2>\n<ul>\n<li>州（37 个，用 one-hot 向量的方式编码）</li>\n<li>类似新冠的疾病\n<ul>\n<li>cli、ili ...</li>\n</ul>\n</li>\n<li>行为指标\n<ul>\n<li>wearing_mask、travel_out_state ...</li>\n</ul>\n</li>\n<li>精神健康指标\n<ul>\n<li>anxious、depressed ...</li>\n</ul>\n</li>\n<li>确诊阳性病例\n<ul>\n<li>Tested_positive（这个就是我们希望预测的指标）</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"评价指标\"><a class=\"anchor\" href=\"#评价指标\">#</a> 评价指标</h2>\n<p>采用均方误差（Mean Squared Error，MSE）来评价误差。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>M</mi><mi>S</mi><mi>E</mi><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><msub><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">MSE = {1 \\over N} \\sum_{i=1}^{N}(y_i- \\hat y_i)^2\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.106005em;vertical-align:-1.277669em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000002em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1141079999999999em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span></p>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>：模型预测值</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\hat y_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>：实际值</li>\n</ul>\n<h2 id=\"作业目的\"><a class=\"anchor\" href=\"#作业目的\">#</a> 作业目的</h2>\n<ul>\n<li>通过深度神经网络（deep neural networks，DNN）解决一个回归问题</li>\n<li>理解基本的 DNN 训练技巧\n<ul>\n<li>超参数调优、特征选择、正则化、...</li>\n</ul>\n</li>\n<li>熟悉 PyTorch</li>\n</ul>\n<hr />\n<h1 id=\"环境准备\"><a class=\"anchor\" href=\"#环境准备\">#</a> 环境准备</h1>\n<h2 id=\"conda\"><a class=\"anchor\" href=\"#conda\">#</a> Conda</h2>\n<p>本文不在赘述 Conda 的安装，参考另一篇<a href=\"https://gality.cn/misc/trail-and-error/conda-mamba/\">博客</a>。</p>\n<h2 id=\"数据集\"><a class=\"anchor\" href=\"#数据集\">#</a> 数据集</h2>\n<p><code>gdown</code>  是一个<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3drZW50YXJvL2dkb3du\"> github 项目</span>，是一个由 python 实现的从 Google Drive 下载大文件的工具（由于安全策略无法使用 wget/curl 进行下载）。如果之前从未用 <code>gdown</code>  下载过东西，需要现在 <code>conda</code>  的 <code>base</code>  环境安装 <code>gdown</code> 。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mamba <span class=\"token function\">install</span> gdown</pre></td></tr></table></figure><p>然后就可以直接用 gdown 下载文件了：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gdown <span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token builtin\">id</span> <span class=\"token string\">'1kLSW_-cW2Huj7bh84YTdimGBOJaODiOS'</span> <span class=\"token operator\">-</span><span class=\"token operator\">-</span>output covid<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">.</span>csv</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>down <span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token builtin\">id</span> <span class=\"token string\">'1iiI5qROrAhZn-o4FPqsE97bMzDEFvIdg'</span> <span class=\"token operator\">-</span><span class=\"token operator\">-</span>output covid<span class=\"token punctuation\">.</span>test<span class=\"token punctuation\">.</span>csv</pre></td></tr></table></figure><p>此时，就得到了训练数据集和测试数据集。</p>\n<h2 id=\"依赖库\"><a class=\"anchor\" href=\"#依赖库\">#</a> 依赖库</h2>\n<p>作业需要依赖一些库，提前安装一下，作业中给出了 <code>import</code>  部分的代码：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Numerical Operations</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> math</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># Reading/Writing Data</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> os</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> csv</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># For Progress Bar</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">from</span> tqdm <span class=\"token keyword\">import</span> tqdm</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># Pytorch</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">import</span> torch </pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn <span class=\"token keyword\">as</span> nn</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">from</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>data <span class=\"token keyword\">import</span> Dataset<span class=\"token punctuation\">,</span> DataLoader<span class=\"token punctuation\">,</span> random_split</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># For plotting learning curve</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">from</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>tensorboard <span class=\"token keyword\">import</span> SummaryWriter</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># For plot</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">import</span> seaborn <span class=\"token keyword\">as</span> sns</pre></td></tr></table></figure><p>因此，我们创建一个虚拟环境并安装对应的库：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mamba create <span class=\"token parameter variable\">-n</span> MLlearnEnv <span class=\"token assign-left variable\">python</span><span class=\"token operator\">=</span><span class=\"token number\">3.9</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conda activate MLlearnEnv</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>mamba <span class=\"token function\">install</span> pytorch::pytorch torchvision torchaudio <span class=\"token parameter variable\">-c</span> pytorch</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>mamba <span class=\"token function\">install</span> pandas tqdm packaging tensorboard matplotlib seaborn</pre></td></tr></table></figure><p>注意，由于电脑原因，这里安装 PyTorch 的命令是安装 CPU 版本的，对于初学者来说 CPU 的算力其实已经够了，如果安装 GPU 版本需要去对应安装 CUDA 驱动，所以具体安装命令请参考<span class=\"exturl\" data-url=\"aHR0cHM6Ly9weXRvcmNoLm9yZy8=\"> PyTorch 官网</span>。</p>\n<h1 id=\"知识准备\"><a class=\"anchor\" href=\"#知识准备\">#</a> 知识准备</h1>\n<p>这里仅对已给出的源代码进行解释，请自行进行成体系的工具学习。</p>\n<h2 id=\"可视化\"><a class=\"anchor\" href=\"#可视化\">#</a> 可视化</h2>\n<p>我们可以使用 <code>tensorboard</code>  来可视化训练过程，使用起来非常简单，只需要在作业目录下执行：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>tensorboard <span class=\"token parameter variable\">--logdir</span><span class=\"token operator\">=</span>runs</pre></td></tr></table></figure><p><code>logdir</code>  指向训练过程中生成的运行数据文件夹，默认为 <code>./runs</code> 。</p>\n<p>执行后会在本地监听 <code>6006</code>  端口，访问对应的 web 页面即可看到训练过程的图表。</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/70c9ny.png\" alt=\"tensorboard\" /></p>\n<h2 id=\"实用函数\"><a class=\"anchor\" href=\"#实用函数\">#</a> 实用函数</h2>\n<p>针对源代码给出的无需修改的工具函数，简单做一些解释。</p>\n<h3 id=\"设置随机数种子\"><a class=\"anchor\" href=\"#设置随机数种子\">#</a> 设置随机数种子</h3>\n<p>为了保证 reproducibility（可复现性），需要设置随机数生成种子，<span class=\"exturl\" data-url=\"aHR0cHM6Ly9weXRvcmNoLm9yZy9kb2NzL3N0YWJsZS9ub3Rlcy9yYW5kb21uZXNzLmh0bWw=\">官方文档</span>给出了详细解释，这里简单说明一下。</p>\n<div class=\"note info no-icon\">\n<p>由于机器学习中涉及到很多随机数和随机过程，那么这些随机数和随机过程就可能直接对结果产生影响，从实验的可复现性来讲，我们希望同一个代码的多次运行结果是一致的，我们分别讨论。</p>\n<ul>\n<li>\n<p><strong>随机数</strong>：计算机生成随机数的方法其实是根据一个随机数 “种子”，然后以某种确定性的算法来实现的，这个种子常常是一个变化的值（例如时间戳），以此来保证生成的随机序列不可预测。那么在当前环境下，我们就可以通过给定一个随机数种子的方式来尽可能的保证随机数序列相同，减少对可复现性的干扰。</p>\n<p>由于程序中可能涉及到多个库，而不同库又采用不同的随机数生成器，所以需要分别对所有涉及到的库设置随机数种子，如代码中就同时设置了 <code>PyTorch</code>  和 <code>numpy</code>  的种子。</p>\n</li>\n<li>\n<p><strong>随机过程</strong>：在使用 CUDA 对训练过程进行加速时，cuDNN 可能会通过基准测试来从多个卷积中选择最快的卷积，成为可能的不确定来源之一。</p>\n<p>另一方面，cuDNN 在训练过程中采用的某些算法本身可能就是不确定的，每次运算会产生不同的结果。这些都是我们需要避免的。</p>\n</li>\n</ul>\n<p>遗憾的是，即使我们选用相同的随机数种子，PyTorch 仍无法确保可复现性，设置同一随机数种子和确定过程仅能保证在同一平台、同一硬件、同一 PyTorch 版本的下，多次实验结果一致。</p>\n</div>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># seed: 自行设定的随机数种子</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">same_seed</span><span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Fixes random number generator seeds for reproducibility.\"\"\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    torch<span class=\"token punctuation\">.</span>backends<span class=\"token punctuation\">.</span>cudnn<span class=\"token punctuation\">.</span>deterministic <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span> <span class=\"token comment\"># 强制使用确定性算法</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    torch<span class=\"token punctuation\">.</span>backends<span class=\"token punctuation\">.</span>cudnn<span class=\"token punctuation\">.</span>benchmark <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span> <span class=\"token comment\"># 禁用 cuDNN 的卷积基准测试</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>seed<span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 设置 numpy 的随机数生成</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    torch<span class=\"token punctuation\">.</span>manual_seed<span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 设置 PyTorch 的随机数生成</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>is_available<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 可以不要，新版本 PyTorch 中 manual_seed 会同时设置 CPU 和 GPU 版本的随机数种子</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>manual_seed_all<span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"数据集分割\"><a class=\"anchor\" href=\"#数据集分割\">#</a> 数据集分割</h3>\n<p>由于需要计算损失函数来对模型参数进行动态的调整，我们需要将 <code>训练数据集</code> 分割成 <code>训练集</code> 和 <code>验证集</code> ，源代码中给出了一个通用的分割函数。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># data: 训练集（矩阵）</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># valid_ratio: 验证集的比例 (validation_size = train_size * valid_ratio)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># seed: 随机数种子</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">train_valid_split</span><span class=\"token punctuation\">(</span>data_set<span class=\"token punctuation\">,</span> valid_ratio<span class=\"token punctuation\">,</span> seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Split provided training data into training set and validation set\"\"\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    valid_set_size <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>valid_ratio <span class=\"token operator\">*</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data_set<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    train_set_size <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data_set<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> valid_set_size</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    train_set<span class=\"token punctuation\">,</span> valid_set <span class=\"token operator\">=</span> random_split<span class=\"token punctuation\">(</span>data_set<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>train_set_size<span class=\"token punctuation\">,</span> valid_set_size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> generator<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>Generator<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>manual_seed<span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 将一个数据集随机拆成两个无重叠的数据集，两个数据集的大小由第二个参数指定</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">return</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>train_set<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>valid_set<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"预测函数\"><a class=\"anchor\" href=\"#预测函数\">#</a> 预测函数</h3>\n<p>一个预测函数，当我们希望用我们之前训练的模型去预测未知数据时可以调用这个函数，其中：</p>\n<ul>\n<li><code>model.eval()</code>  将模型设置为 eval 模式，此时，模型中的某些层会不起作用，来保证预测的同时不会改变训练好的模型参数。</li>\n<li>tqdm 是一个<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RxZG0vdHFkbQ==\"> github 项目</span>，用于展示进度条。注意 <code>tqdm(test_loader)</code>  只会对进度计数，而不会改变迭代逻辑，即 <code>x</code>  是从 <code>test_loader</code>  中取出的 <code>tensor</code>  类型数据。</li>\n<li><code>model(x)</code> =  <code>model.forward(x)</code> ，在 PyTorch 中直接调用模型并传递输入数据时，会自动调用模型的 <code>forward</code>  方法。即这一行的代码的含义是：调用模型进行预测。</li>\n<li><code>Tensor.detach()</code>  从当前计算图中分离出新的 tensor，该 tensor 不具有梯度，也不会反向传播。由于在 PyTorch 中，变量不仅是数值和数据类型，还包含了该变量的计算过程，而通过 <code>detach()</code>  可以将计算过程剥离只剩下数值。</li>\n<li><code>.cpu()</code>  将变量放在 cpu 上。</li>\n<li><code>torch.cat()</code>  用于将两个 <code>tensor</code>  拼接在一起， <code>dim</code>  参数指定了是横着拼接还是竖着拼接（对于矩阵）</li>\n<li><code>.numpy()</code>  用于将 <code>Tensor</code>  类型转成 <code>Numpy</code>  类型。CUDA 只接受 <code>Tensor</code>  类型，不接受其他变量类型。</li>\n</ul>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">predict</span><span class=\"token punctuation\">(</span>test_loader<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    model<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># Set your model to evaluation mode.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    preds <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> tqdm<span class=\"token punctuation\">(</span>test_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># test_loader 是测试数据</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        x <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 将模型加载到 CPU 上                    </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 禁用梯度计算，节省时间               </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            pred <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 调用模型进行预测</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            preds<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">.</span>detach<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>cpu<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># pred 可直接当参数也不会报错，这里是标准化处理</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    preds <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>preds<span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>numpy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> preds</pre></td></tr></table></figure><h3 id=\"预测结果保存\"><a class=\"anchor\" href=\"#预测结果保存\">#</a> 预测结果保存</h3>\n<p>将模型预测的结果保存成 csv，这个其实是因为原本本作业的完成方式是上传保存的文件，我们也就保留下来了。由于只涉及 csv 的操作比较简单，就不过多解释了。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">save_pred</span><span class=\"token punctuation\">(</span>preds<span class=\"token punctuation\">,</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\" Save predictions to specified file \"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> fp<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        writer <span class=\"token operator\">=</span> csv<span class=\"token punctuation\">.</span>writer<span class=\"token punctuation\">(</span>fp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        writer<span class=\"token punctuation\">.</span>writerow<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'tested_positive'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 保存成 id, tested_positive 两列</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> p <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>preds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            writer<span class=\"token punctuation\">.</span>writerow<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"数据集-2\"><a class=\"anchor\" href=\"#数据集-2\">#</a> 数据集</h2>\n<h3 id=\"自定义数据集\"><a class=\"anchor\" href=\"#自定义数据集\">#</a> 自定义数据集</h3>\n<p>当我们不使用 PyTorch 官方整理好的数据集，而是使用自己的数据集时，就必须按照 PyTorch 的定义，自行实现一个继承 <code>torch.utils.data.Dataset</code>  这个抽象类的子类，PyTorch 才可以正确处理。</p>\n<p>自定义数据集必须继承 <code>Dataset</code>  并至少覆盖以下两个方法:</p>\n<ul>\n<li><code>__len__</code> ： 实现  <code>len(dataset)</code>  返还数据集的尺寸。</li>\n<li><code>__getitem__</code> ：用来获取索引数据，例如 <code>dataset[i]</code></li>\n</ul>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">COVID19Dataset</span><span class=\"token punctuation\">(</span>Dataset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    x: Features.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    y: Targets, if none, do prediction.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    \"\"\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 定义初始化方法</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span> y <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            self<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> y</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            self<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>FloatTensor<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 预测目标是浮点数</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        self<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>FloatTensor<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 特征也是浮点数</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__getitem__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 定义数据集索引方法</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>y <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__len__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 定义获取数据长度方法</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"dataloader\"><a class=\"anchor\" href=\"#dataloader\">#</a> Dataloader</h3>\n<ul>\n<li><code>pd.read_csv()</code> ：从指定位置读取 csv 表格，并转化为 <code>DataFrame</code>  的类型，可以通过 <code>.values</code>  取出 <code>DataFrame</code>  中的值并转换为多维列表。</li>\n<li><code>select_feat()</code> ：从数据集中提取特征，该函数的实现会在下面讲到。</li>\n</ul>\n<p>整体过程其实就是：</p>\n<ol>\n<li>读取 csv 表格中的数据</li>\n<li>提取数据中的特征</li>\n<li>将特征转化为数据集 <code>Dataset</code></li>\n<li>根据配置，将 <code>Dataset</code>  转化成 <code>DataLoader</code>  用于后续训练</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Set seed for reproducibility</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>same_seed<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'seed'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># train_data size: 2699 x 118 (id + 37 states + 16 features x 5 days) </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># test_data size: 1078 x 117 (without last day's positive rate)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>train_data<span class=\"token punctuation\">,</span> test_data <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">'./covid.train.csv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">,</span> pd<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">'./covid.test.csv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>values</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>train_data<span class=\"token punctuation\">,</span> valid_data <span class=\"token operator\">=</span> train_valid_split<span class=\"token punctuation\">(</span>train_data<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'valid_ratio'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'seed'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># Print out the data size.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"train_data size: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>train_data<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>valid_data size: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>valid_data<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>test_data size: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>test_data<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"\"\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># Select features</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>x_train<span class=\"token punctuation\">,</span> x_valid<span class=\"token punctuation\">,</span> x_test<span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">,</span> y_valid <span class=\"token operator\">=</span> select_feat<span class=\"token punctuation\">(</span>train_data<span class=\"token punctuation\">,</span> valid_data<span class=\"token punctuation\">,</span> test_data<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'select_all'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># Print out the number of features.</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'number of features: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>x_train<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># initialize datasets with the data</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>train_dataset<span class=\"token punctuation\">,</span> valid_dataset<span class=\"token punctuation\">,</span> test_dataset <span class=\"token operator\">=</span> COVID19Dataset<span class=\"token punctuation\">(</span>x_train<span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \\</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                                            COVID19Dataset<span class=\"token punctuation\">(</span>x_valid<span class=\"token punctuation\">,</span> y_valid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \\</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                                            COVID19Dataset<span class=\"token punctuation\">(</span>x_test<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># Pytorch data loader loads pytorch dataset into batches.</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>train_loader <span class=\"token operator\">=</span> DataLoader<span class=\"token punctuation\">(</span>train_dataset<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'batch_size'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> pin_memory<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>valid_loader <span class=\"token operator\">=</span> DataLoader<span class=\"token punctuation\">(</span>valid_dataset<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'batch_size'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> pin_memory<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>test_loader <span class=\"token operator\">=</span> DataLoader<span class=\"token punctuation\">(</span>test_dataset<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'batch_size'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> pin_memory<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"全局配置\"><a class=\"anchor\" href=\"#全局配置\">#</a> 全局配置</h1>\n<ul>\n<li><code>device</code> ：设置训练使用的硬件，优先 CUDA，如果没有的话就使用 CPU。</li>\n</ul>\n<p><code>config</code>  中的内容比较顾名思义了，稍微有点机器学习基础应该都能看懂。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>device <span class=\"token operator\">=</span> <span class=\"token string\">'cuda'</span> <span class=\"token keyword\">if</span> torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>is_available<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token string\">'cpu'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>config <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token string\">'seed'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5201314</span><span class=\"token punctuation\">,</span>      <span class=\"token comment\"># Your seed number, you can pick your lucky number. :)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token string\">'select_all'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\"># Whether to use all features.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token string\">'valid_ratio'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\"># validation_size = train_size * valid_ratio</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">'n_epochs'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\"># Number of epochs.            </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">'batch_size'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token string\">'learning_rate'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1e-5</span><span class=\"token punctuation\">,</span>              </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token string\">'early_stop'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">400</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\"># If model has not improved for this many consecutive epochs, stop training.     </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token string\">'save_path'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'./models/model.ckpt'</span>  <span class=\"token comment\"># Your model will be saved here.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"关键函数编写\"><a class=\"anchor\" href=\"#关键函数编写\">#</a> 关键函数编写</h1>\n<p>由于关键函数的编写也正是作业的内容，所以将该内容放在了最后，我们需要完成 3 个关键函数的编 / 改写，分别是：</p>\n<ol>\n<li>模型  <code>My_Model()</code></li>\n<li>特征提取算法  <code>select_feat()</code></li>\n<li>训练算法  <code>trainer()</code></li>\n</ol>\n<h2 id=\"my_model\"><a class=\"anchor\" href=\"#my_model\">#</a> My_Model()</h2>\n<p>基础模型如下：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">My_Model</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> input_dim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 定义模型初始化方法</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>My_Model<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 调用父类的__init__方法</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\"># TODO: modify model's structure, be aware of dimensions.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        self<span class=\"token punctuation\">.</span>layers <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span> <span class=\"token comment\"># Sequential 中前一层输出大小必须与下一层的输入大小一致</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>input_dim<span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 定义一个全连接层</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 使用 ReLU 作为激活函数</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 该层输入 tensor 为 16，输出 tensor 为 8</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 定义前向传播算法</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>layers<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 将 x 传递给 layers 的各层进行运算，默认写法。</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        x <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>squeeze<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># (B, 1) -> (B)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span> x</pre></td></tr></table></figure><p>使用该模型训练出的 loss 为：</p>\n<p><code>Epoch [1869/3000]: Train loss: 41.3380, Valid loss: 37.6867</code></p>\n<p>同时，使用此训练的模型去预测会发现预测出的 <code>tested_positive</code>  都会是同一个值，这显然是不对的，猜测可能是因为模型神经元数目太少，而特征又太多，导致模型无法学习到有效特征，loss 的下降其实也只是类似求一个最佳均值的过程，所以我们尝试通过增加层数的方法来优化他（称为优化 1）：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>self<span class=\"token punctuation\">.</span>layers <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>input_dim<span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>loss 有显著降低：</p>\n<p><code>Epoch [3000/3000]: Train loss: 1.5405, Valid loss: 1.5447</code></p>\n<p>为了防止过拟合问题，我们跑一下验证集试试，结果为</p>\n<p><code>Loss:  tensor(3.2558, dtype=torch.float64)</code></p>\n<h2 id=\"select_feat\"><a class=\"anchor\" href=\"#select_feat\">#</a> select_feat()</h2>\n<p>默认的特征提取函数默认情况下是使用全部特征（不提取特征）的，代码如下：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">select_feat</span><span class=\"token punctuation\">(</span>train_data<span class=\"token punctuation\">,</span> valid_data<span class=\"token punctuation\">,</span> test_data<span class=\"token punctuation\">,</span> select_all<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Selects useful features to perform regression\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    y_train<span class=\"token punctuation\">,</span> y_valid <span class=\"token operator\">=</span> train_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> valid_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    raw_x_train<span class=\"token punctuation\">,</span> raw_x_valid<span class=\"token punctuation\">,</span> raw_x_test <span class=\"token operator\">=</span> train_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> valid_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> test_data <span class=\"token comment\"># 分离 tested_positive 列和其他特征列</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> select_all<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        feat_idx <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>raw_x_train<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        feat_idx <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># TODO: Select suitable feature columns.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> raw_x_train<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> feat_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> raw_x_valid<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> feat_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> raw_x_test<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> feat_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">,</span> y_valid</pre></td></tr></table></figure><p>其中 <code>train_data</code>  和 <code>valid_data</code>  都是多维数组， <code>train_data[:, -1]</code>  是指将列表中的每一个子列表的最后一项提取出来组成一个新的列表：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mo stretchy=\"false\">[</mo><mo stretchy=\"false\">[</mo><mn>1</mn><mo separator=\"true\">,</mo><mn>2</mn><mo separator=\"true\">,</mo><mn>3</mn><mo stretchy=\"false\">]</mo><mo separator=\"true\">,</mo><mo stretchy=\"false\">[</mo><mn>4</mn><mo separator=\"true\">,</mo><mn>5</mn><mo separator=\"true\">,</mo><mn>6</mn><mo stretchy=\"false\">]</mo><mo separator=\"true\">,</mo><mo stretchy=\"false\">[</mo><mn>7</mn><mo separator=\"true\">,</mo><mn>8</mn><mo separator=\"true\">,</mo><mn>9</mn><mo stretchy=\"false\">]</mo><mo stretchy=\"false\">]</mo><mo>→</mo><mo stretchy=\"false\">[</mo><mn>3</mn><mo separator=\"true\">,</mo><mn>6</mn><mo separator=\"true\">,</mo><mn>9</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[[1,2,3],[4,5,6],[7,8,9]] \\rightarrow [3,6,9]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mopen\">[</span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">3</span><span class=\"mclose\">]</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">4</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">5</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">6</span><span class=\"mclose\">]</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">7</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">8</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">9</span><span class=\"mclose\">]</span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">3</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">6</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">9</span><span class=\"mclose\">]</span></span></span></span></span></p>\n<p>观察训练集可以发现，最后一列就是 <code>tested_positive</code>  列，即 <code>y_train</code>  为训练集的 <code>tested_positive</code>  列表， <code>y_valid</code>  为验证集的 <code>tested_positive</code>  列表；另外， <code>raw_x_train</code>  就是将 <code>tested_positive</code>  排除的其他数据特征， <code>raw_x_valid</code>  同理。</p>\n<p>若配置 <code>select_all=true</code>  时，会将其他特征全部返回，否则只会返回指定的特征列。考虑到原本数据集中的部分特征可能对我们想要的预测的内容没什么贡献，反倒可能会影响机器的学习，那么我们就可以考虑人为分析一下样本中的不同字段对结果的贡献从而优化机器学习的效果（称为优化 2）。</p>\n<p>先分析一下样本数据：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">样本列</th>\n<th style=\"text-align:center\">含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">AL、AK、AZ、AR、......</td>\n<td style=\"text-align:center\">美国不同州的缩写</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">cli、ili</td>\n<td style=\"text-align:center\">COVID-like illness、influenza-like illness</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">hh_cmnty_cli、nohh_cmnty_cli</td>\n<td style=\"text-align:center\">社区报告病例（包括 / 不包括家庭）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">wearing_mask</td>\n<td style=\"text-align:center\">戴口罩</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">travel_outside_state、work_outside_home</td>\n<td style=\"text-align:center\">外出旅行、非居家办公</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">shop、restaurant</td>\n<td style=\"text-align:center\">商场、餐厅</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">spent_time</td>\n<td style=\"text-align:center\">过去 24 小时内与当前不在身边的人在一起</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">large_event</td>\n<td style=\"text-align:center\">出席 10 人以上的活动</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">public_transit</td>\n<td style=\"text-align:center\">过去 24 小时使用公共交通</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">anxious、depressed、worried_finances</td>\n<td style=\"text-align:center\">焦虑、压力、担心财务状况</td>\n</tr>\n</tbody>\n</table>\n<p>如果纯靠人为经验来分析的话，可能会觉得都有关系，这个时候我们可以借助 Person 相关性分析方法，来分析各个变量与 <code>tested_positive</code>  的相关性，通过具体的数值来找到最相关的列。 <code>pandas</code>  库提供了封装好的 Person 相关性分析算法，直接使用即可：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>df <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">'./data/covid.train.csv'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">.</span>corr<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token string\">'tested_positive'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>sort_values<span class=\"token punctuation\">(</span>ascending<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 降序排列</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># ---- Output ----</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>tested_positive      <span class=\"token number\">1.000000</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>tested_positive<span class=\"token punctuation\">.</span><span class=\"token number\">1</span>    <span class=\"token number\">0.985053</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>tested_positive<span class=\"token punctuation\">.</span><span class=\"token number\">2</span>    <span class=\"token number\">0.969467</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>tested_positive<span class=\"token punctuation\">.</span><span class=\"token number\">3</span>    <span class=\"token number\">0.953463</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>tested_positive<span class=\"token punctuation\">.</span><span class=\"token number\">4</span>    <span class=\"token number\">0.935388</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                       <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>   </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>public_transit      <span class=\"token operator\">-</span><span class=\"token number\">0.411916</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>public_transit<span class=\"token punctuation\">.</span><span class=\"token number\">1</span>    <span class=\"token operator\">-</span><span class=\"token number\">0.415510</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>public_transit<span class=\"token punctuation\">.</span><span class=\"token number\">2</span>    <span class=\"token operator\">-</span><span class=\"token number\">0.418523</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>public_transit<span class=\"token punctuation\">.</span><span class=\"token number\">3</span>    <span class=\"token operator\">-</span><span class=\"token number\">0.421868</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>public_transit<span class=\"token punctuation\">.</span><span class=\"token number\">4</span>    <span class=\"token operator\">-</span><span class=\"token number\">0.424169</span></pre></td></tr></table></figure><p>我们把这些强相关的列作为特征在优化 1 的基础上去优化模型（称为优化 2）。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>feat_idx <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">38</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            <span class=\"token number\">53</span><span class=\"token punctuation\">,</span> <span class=\"token number\">69</span><span class=\"token punctuation\">,</span> <span class=\"token number\">85</span><span class=\"token punctuation\">,</span> <span class=\"token number\">101</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># tested_positive</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token number\">49</span><span class=\"token punctuation\">,</span> <span class=\"token number\">65</span><span class=\"token punctuation\">,</span> <span class=\"token number\">81</span><span class=\"token punctuation\">,</span> <span class=\"token number\">97</span><span class=\"token punctuation\">,</span> <span class=\"token number\">113</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># public_transit</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token number\">40</span><span class=\"token punctuation\">,</span> <span class=\"token number\">41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">56</span><span class=\"token punctuation\">,</span> <span class=\"token number\">57</span><span class=\"token punctuation\">,</span> <span class=\"token number\">72</span><span class=\"token punctuation\">,</span> <span class=\"token number\">73</span><span class=\"token punctuation\">,</span> <span class=\"token number\">88</span><span class=\"token punctuation\">,</span> <span class=\"token number\">89</span><span class=\"token punctuation\">,</span> <span class=\"token number\">104</span><span class=\"token punctuation\">,</span> <span class=\"token number\">105</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># hh_cmnty_cli &amp; nohh_cmnty_cli</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token number\">38</span><span class=\"token punctuation\">,</span> <span class=\"token number\">39</span><span class=\"token punctuation\">,</span> <span class=\"token number\">54</span><span class=\"token punctuation\">,</span> <span class=\"token number\">55</span><span class=\"token punctuation\">,</span> <span class=\"token number\">70</span><span class=\"token punctuation\">,</span> <span class=\"token number\">71</span><span class=\"token punctuation\">,</span> <span class=\"token number\">86</span><span class=\"token punctuation\">,</span> <span class=\"token number\">87</span><span class=\"token punctuation\">,</span> <span class=\"token number\">102</span><span class=\"token punctuation\">,</span> <span class=\"token number\">103</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># cli &amp; ili</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token number\">50</span><span class=\"token punctuation\">,</span> <span class=\"token number\">66</span><span class=\"token punctuation\">,</span> <span class=\"token number\">82</span><span class=\"token punctuation\">,</span> <span class=\"token number\">98</span><span class=\"token punctuation\">,</span> <span class=\"token number\">114</span> <span class=\"token comment\"># anxious</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">]</span>  <span class=\"token comment\"># TODO: Select suitable feature columns.</span></pre></td></tr></table></figure><p>此时，模型在训练集上的 loss 有所上升，但是在验证集上有所下降。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># --- 测试集 ---</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Epoch <span class=\"token punctuation\">[</span><span class=\"token number\">2547</span><span class=\"token operator\">/</span><span class=\"token number\">3000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> Train loss<span class=\"token punctuation\">:</span> <span class=\"token number\">1.8915</span><span class=\"token punctuation\">,</span> Valid loss<span class=\"token punctuation\">:</span> <span class=\"token number\">1.6332</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># --- 验证集 ---</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Loss<span class=\"token punctuation\">:</span>  tensor<span class=\"token punctuation\">(</span><span class=\"token number\">3.1981</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>float64<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"trainer\"><a class=\"anchor\" href=\"#trainer\">#</a> trainer()</h2>\n<p>源码中给出基本的 <code>trainer()</code>  函数，注释已经非常清楚了，代码如下：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">trainer</span><span class=\"token punctuation\">(</span>train_loader<span class=\"token punctuation\">,</span> valid_loader<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    criterion <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>MSELoss<span class=\"token punctuation\">(</span>reduction<span class=\"token operator\">=</span><span class=\"token string\">'mean'</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Define your loss function, do not modify this.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\"># Define your optimization algorithm.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\"># TODO: Please check https://pytorch.org/docs/stable/optim.html to get more available algorithms.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\"># TODO: L2 regularization (optimizer(weight decay...) or implement by your self).</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    optimizer <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>optim<span class=\"token punctuation\">.</span>SGD<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lr<span class=\"token operator\">=</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'learning_rate'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> momentum<span class=\"token operator\">=</span><span class=\"token number\">0.9</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    writer <span class=\"token operator\">=</span> SummaryWriter<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Writer of tensoboard.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>isdir<span class=\"token punctuation\">(</span><span class=\"token string\">'./models'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        os<span class=\"token punctuation\">.</span>mkdir<span class=\"token punctuation\">(</span><span class=\"token string\">'./models'</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Create directory of saving models.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    n_epochs<span class=\"token punctuation\">,</span> best_loss<span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">,</span> early_stop_count <span class=\"token operator\">=</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'n_epochs'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> math<span class=\"token punctuation\">.</span>inf<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token comment\"># initialize some variables</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">for</span> epoch <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n_epochs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        model<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Set your model to train mode.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        loss_record <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\"># tqdm is a package to visualize your training progress.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        train_pbar <span class=\"token operator\">=</span> tqdm<span class=\"token punctuation\">(</span>train_loader<span class=\"token punctuation\">,</span> position<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> leave<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">for</span> x<span class=\"token punctuation\">,</span> y <span class=\"token keyword\">in</span> train_pbar<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            optimizer<span class=\"token punctuation\">.</span>zero_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Set gradient to zero.</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Move your data to device.</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            pred <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            loss <span class=\"token operator\">=</span> criterion<span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            loss<span class=\"token punctuation\">.</span>backward<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Compute gradient(backpropagation).</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            optimizer<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Update parameters.</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            step <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            loss_record<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>loss<span class=\"token punctuation\">.</span>detach<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token comment\"># Display current epoch number and loss on tqdm progress bar.</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            train_pbar<span class=\"token punctuation\">.</span>set_description<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Epoch [</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>epoch <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>n_epochs<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">]'</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            train_pbar<span class=\"token punctuation\">.</span>set_postfix<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'loss'</span><span class=\"token punctuation\">:</span> loss<span class=\"token punctuation\">.</span>detach<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        mean_train_loss <span class=\"token operator\">=</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>loss_record<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>loss_record<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        writer<span class=\"token punctuation\">.</span>add_scalar<span class=\"token punctuation\">(</span><span class=\"token string\">'Loss/train'</span><span class=\"token punctuation\">,</span> mean_train_loss<span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        model<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Set your model to evaluation mode.</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        loss_record <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token keyword\">for</span> x<span class=\"token punctuation\">,</span> y <span class=\"token keyword\">in</span> valid_loader<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                pred <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                loss <span class=\"token operator\">=</span> criterion<span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            loss_record<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>loss<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        mean_valid_loss <span class=\"token operator\">=</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>loss_record<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>loss_record<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        tqdm<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Epoch [</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>epoch <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>n_epochs<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">]: Train loss: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>mean_train_loss<span class=\"token punctuation\">:</span><span class=\"token format-spec\">.4f</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">, Valid loss: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>mean_valid_loss<span class=\"token punctuation\">:</span><span class=\"token format-spec\">.4f</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        writer<span class=\"token punctuation\">.</span>add_scalar<span class=\"token punctuation\">(</span><span class=\"token string\">'Loss/valid'</span><span class=\"token punctuation\">,</span> mean_valid_loss<span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 向 tensoboard 添加图表</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token keyword\">if</span> mean_valid_loss <span class=\"token operator\">&lt;</span> best_loss<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            best_loss <span class=\"token operator\">=</span> mean_valid_loss</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            torch<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'save_path'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Save your best model</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            tqdm<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'Saving model with loss &#123;:.3f&#125;...'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>best_loss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            early_stop_count <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            early_stop_count <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token keyword\">if</span> early_stop_count <span class=\"token operator\">>=</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'early_stop'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            tqdm<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'\\nModel is not improving, so we halt the training session.'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token keyword\">return</span></pre></td></tr></table></figure><p>提示中给出了两个优化方向，引入 L2 正则化和寻找更好的 <code>optimizer</code> ，经过实际测试，如果不引入 L2 正则化就直接换用别的 <code>optimizer</code>  会导致过拟合的问题，所以我们先引入 L2 正则化。</p>\n<h3 id=\"l2-regularization-dropout\"><a class=\"anchor\" href=\"#l2-regularization-dropout\">#</a> L2 regularization &amp; Dropout</h3>\n<p>简单来说，L2 正则化可以直观理解为它<strong>对于大数值的权重向量进行严厉惩罚</strong>，倾向于更加分散的权重向量。由于输入和权重之间的乘法操作，这样就有了一个优良的<strong>特性</strong>：<strong>使网络更倾向于使用所有输入特征，而不是严重依赖输入特征中某些小部分特征</strong>。 L2 惩罚倾向于更小更分散的权重向量，这就会鼓励分类器最终将所有维度上的特征都用起来，而不是强烈依赖其中少数几个维度。这样做可以提高模型的泛化能力，<strong>降低过拟合的风险</strong>。</p>\n<p>与 L2 正则化类似的是 L1 正则化，也是引入惩罚措施来降低过拟合的风险，一般情况下，L2 正则化模型效果会更好一些。</p>\n<p>👆理论来说是这样的，但是在实际测试中，引入 L2 正则化之后仍然会有过拟合的问题，效果不是很好，我们可以使用 <code>Dropout</code>  的方法来缓解过拟合问题。</p>\n<p><code>Dropout</code>  的思想是在训练过程中随机让部分神经元 “失活”，通过这种方式丢失部分特征，限制模型的学习能力，通过这种方法，可以使神经网络更加关注于 “通用的” 特征，而不是训练集中的特化特征。使用 <code>Dropout</code>  需要对模型做出变化：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">My_Model</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> input_dim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>My_Model<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\"># TODO: modify model's structure, be aware of dimensions.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        self<span class=\"token punctuation\">.</span>layers <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>input_dim<span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>LeakyReLU<span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Dropout<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 添加 Dropout，指定丢弃概率</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>LeakyReLU<span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>LeakyReLU<span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>在实际测试中，将激活函数从 <code>ReLU</code>  替换成了 <code>LeakyReLU</code>  并增加模型神经元数，取得了更好的效果（关于激活函数后面单独拿一章讲）。</p>\n<h3 id=\"optimizer\"><a class=\"anchor\" href=\"#optimizer\">#</a> optimizer</h3>\n<p>经过测试，选用 <code>Adam</code>  作为 <code>optimizer</code>  会有更好的效果， <code>Adam</code>  是一个自适应的梯度下降算法，自动的调整 <code>learning-rate</code> ，我们知道，设置合适的超参数 <code>learning-rate</code>  是非常困难的，若 <code>lr</code>  过大，会导致 loss 在最低点出震荡；若 <code>lr</code>  过小，则会导致训练速度过慢。直接使用 <code>Adam</code>  可以帮助我们解决这个烦恼，我们只需要在学习的开始设置一个较大的 <code>lr</code> ， <code>Adam</code>  会自动随着计算调整合适的 <code>lr</code> ，代码如下：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>optimizer <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>optim<span class=\"token punctuation\">.</span>Adam<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lr<span class=\"token operator\">=</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'learning_rate'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 调整 超参数</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>config <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token string\">'seed'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">194343431</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">'select_all'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">'valid_ratio'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token string\">'n_epochs'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token string\">'batch_size'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token string\">'learning_rate'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1e-3</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 这里从 1e-5 改成了 1e-3</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token string\">'early_stop'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">400</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token string\">'save_path'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'./models/model.ckpt'</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这样的优化（称为优化 3）的结果为：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># --- 测试集 ---</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Epoch <span class=\"token punctuation\">[</span><span class=\"token number\">498</span><span class=\"token operator\">/</span><span class=\"token number\">15000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> Train loss<span class=\"token punctuation\">:</span> <span class=\"token number\">1.3171</span><span class=\"token punctuation\">,</span> Valid loss<span class=\"token punctuation\">:</span> <span class=\"token number\">5.3677</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># --- 验证集 ---</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Loss<span class=\"token punctuation\">:</span>  tensor<span class=\"token punctuation\">(</span><span class=\"token number\">2.2407</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>float64<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>通过选取合适的特征，loss 可以进一步下降：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 修改 feat 选取</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>feat_idx <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">38</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token number\">53</span><span class=\"token punctuation\">,</span> <span class=\"token number\">69</span><span class=\"token punctuation\">,</span> <span class=\"token number\">85</span><span class=\"token punctuation\">,</span> <span class=\"token number\">101</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># tested_positive</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token number\">49</span><span class=\"token punctuation\">,</span> <span class=\"token number\">65</span><span class=\"token punctuation\">,</span> <span class=\"token number\">81</span><span class=\"token punctuation\">,</span> <span class=\"token number\">97</span><span class=\"token punctuation\">,</span> <span class=\"token number\">113</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># public_transit</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">]</span>  <span class=\"token comment\"># TODO: Select suitable feature columns.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># --- 测试集 ---</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Epoch <span class=\"token punctuation\">[</span><span class=\"token number\">447</span><span class=\"token operator\">/</span><span class=\"token number\">3000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> Train loss<span class=\"token punctuation\">:</span> <span class=\"token number\">1.6422</span><span class=\"token punctuation\">,</span> Valid loss<span class=\"token punctuation\">:</span> <span class=\"token number\">2.8130</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># --- 验证集 ---</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Loss<span class=\"token punctuation\">:</span>  tensor<span class=\"token punctuation\">(</span><span class=\"token number\">1.4970</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>float64<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><div class=\"note warning\">\n<p>在实际测试中，如果不加上州的特征（前 38 个）的话，Loss 会比较高，加上之后，在测试集上的 loss 会低一些。理论来说，州的特征与 <code>tested_positive</code>  的相关性并不高，如果只是解释为过拟合的话我觉得不是很合理，所以这里的特征选择就没有什么理论指导了，纯粹是试出来的，如果有大佬能解释为什么求求解释一下 Orz</p>\n</div>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/jvocmh.png\" alt=\"拟合函数\" /></p>\n<p>可以看到随着预测的准确率提升，预测结果和实际结果的拟合是越来越好的。整个项目至此先告一段落了，来来回回测试了不下 100 多种优化的组合，感觉继续胡乱尝试没有什么意义，通过这个作业熟悉 PyTorch、学习神经网络知识的目标也已经达到了，接下来将会继续往后学习，进一步提高能力才是王道。</p>\n<h2 id=\"整体代码\"><a class=\"anchor\" href=\"#整体代码\">#</a> 整体代码</h2>\n<details class=\"primary\"><summary>main.py</summary><div>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Numerical Operations</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> math</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># Reading/Writing Data</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> os</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> csv</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># For Progress Bar</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">from</span> tqdm <span class=\"token keyword\">import</span> tqdm</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># Pytorch</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">import</span> torch</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn <span class=\"token keyword\">as</span> nn</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">from</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>data <span class=\"token keyword\">import</span> Dataset<span class=\"token punctuation\">,</span> DataLoader<span class=\"token punctuation\">,</span> random_split</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># For plotting learning curve</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">from</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>tensorboard <span class=\"token keyword\">import</span> SummaryWriter</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># For plot</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">import</span> seaborn <span class=\"token keyword\">as</span> sns</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>device <span class=\"token operator\">=</span> <span class=\"token string\">'cuda'</span> <span class=\"token keyword\">if</span> torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>is_available<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token string\">'cpu'</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>config <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token string\">'seed'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">7777777</span><span class=\"token punctuation\">,</span>      <span class=\"token comment\"># Your seed number, you can pick your lucky number. :)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token string\">'select_all'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\"># Whether to use all features.</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token string\">'valid_ratio'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\"># validation_size = train_size * valid_ratio</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token string\">'n_epochs'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\"># Number of epochs.</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token string\">'batch_size'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token string\">'learning_rate'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1e-3</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token string\">'early_stop'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">400</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\"># If model has not improved for this many consecutive epochs, stop training.</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token string\">'save_path'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'./models/model.ckpt'</span>  <span class=\"token comment\"># Your model will be saved here.</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">same_seed</span><span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Fixes random number generator seeds for reproducibility.\"\"\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    torch<span class=\"token punctuation\">.</span>backends<span class=\"token punctuation\">.</span>cudnn<span class=\"token punctuation\">.</span>deterministic <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    torch<span class=\"token punctuation\">.</span>backends<span class=\"token punctuation\">.</span>cudnn<span class=\"token punctuation\">.</span>benchmark <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>seed<span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    torch<span class=\"token punctuation\">.</span>manual_seed<span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">if</span> torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>is_available<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>manual_seed_all<span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\"># Set seed for reproducibility</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>same_seed<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'seed'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">train_valid_split</span><span class=\"token punctuation\">(</span>data_set<span class=\"token punctuation\">,</span> valid_ratio<span class=\"token punctuation\">,</span> seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Split provided training data into training set and validation set\"\"\"</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    valid_set_size <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>valid_ratio <span class=\"token operator\">*</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data_set<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    train_set_size <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data_set<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> valid_set_size</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    train_set<span class=\"token punctuation\">,</span> valid_set <span class=\"token operator\">=</span> random_split<span class=\"token punctuation\">(</span>data_set<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>train_set_size<span class=\"token punctuation\">,</span> valid_set_size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                                        generator<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>Generator<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>manual_seed<span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token keyword\">return</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>train_set<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>valid_set<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">predict</span><span class=\"token punctuation\">(</span>test_loader<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    model<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Set your model to evaluation mode.</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    preds <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> tqdm<span class=\"token punctuation\">(</span>test_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        x <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            pred <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            preds<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">.</span>detach<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>cpu<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    preds <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>preds<span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>numpy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token keyword\">return</span> preds</pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">save_pred</span><span class=\"token punctuation\">(</span>preds<span class=\"token punctuation\">,</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\" Save predictions to specified file \"\"\"</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> fp<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        writer <span class=\"token operator\">=</span> csv<span class=\"token punctuation\">.</span>writer<span class=\"token punctuation\">(</span>fp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        writer<span class=\"token punctuation\">.</span>writerow<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'tested_positive'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> p <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>preds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>            writer<span class=\"token punctuation\">.</span>writerow<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">COVID19Dataset</span><span class=\"token punctuation\">(</span>Dataset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    x: Features.</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    y: Targets, if none, do prediction.</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    \"\"\"</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token keyword\">if</span> y <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            self<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> y</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            self<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>FloatTensor<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        self<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>FloatTensor<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__getitem__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>y <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>            <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__len__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">My_Model</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> input_dim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>My_Model<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token comment\"># TODO: modify model's structure, be aware of dimensions.</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        self<span class=\"token punctuation\">.</span>layers <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>input_dim<span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>LeakyReLU<span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Dropout<span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 添加 Dropout，指定丢弃概率</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>LeakyReLU<span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>LeakyReLU<span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>layers<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        x <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>squeeze<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># (B, 1) -> (B)</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        <span class=\"token keyword\">return</span> x</pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre></pre></td></tr><tr><td data-num=\"126\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">select_feat</span><span class=\"token punctuation\">(</span>train_data<span class=\"token punctuation\">,</span> valid_data<span class=\"token punctuation\">,</span> test_data<span class=\"token punctuation\">,</span> select_all<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Selects useful features to perform regression\"\"\"</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    y_train<span class=\"token punctuation\">,</span> y_valid <span class=\"token operator\">=</span> train_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> valid_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    raw_x_train<span class=\"token punctuation\">,</span> raw_x_valid<span class=\"token punctuation\">,</span> raw_x_test <span class=\"token operator\">=</span> train_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> valid_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> test_data</pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token keyword\">if</span> select_all<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        feat_idx <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>raw_x_train<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        feat_idx <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">38</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token number\">53</span><span class=\"token punctuation\">,</span> <span class=\"token number\">69</span><span class=\"token punctuation\">,</span> <span class=\"token number\">85</span><span class=\"token punctuation\">,</span> <span class=\"token number\">101</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># tested_positive</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>            <span class=\"token number\">49</span><span class=\"token punctuation\">,</span> <span class=\"token number\">65</span><span class=\"token punctuation\">,</span> <span class=\"token number\">81</span><span class=\"token punctuation\">,</span> <span class=\"token number\">97</span><span class=\"token punctuation\">,</span> <span class=\"token number\">113</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># public_transit</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">]</span>  <span class=\"token comment\"># TODO: Select suitable feature columns.</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    <span class=\"token keyword\">return</span> raw_x_train<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> feat_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> raw_x_valid<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> feat_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> raw_x_test<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> feat_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">,</span> y_valid</pre></td></tr><tr><td data-num=\"140\"></td><td><pre></pre></td></tr><tr><td data-num=\"141\"></td><td><pre></pre></td></tr><tr><td data-num=\"142\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">trainer</span><span class=\"token punctuation\">(</span>train_loader<span class=\"token punctuation\">,</span> valid_loader<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>    criterion <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>MSELoss<span class=\"token punctuation\">(</span>reduction<span class=\"token operator\">=</span><span class=\"token string\">'mean'</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Define your loss function, do not modify this.</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    <span class=\"token comment\"># Define your optimization algorithm.</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    <span class=\"token comment\"># TODO: Please check https://pytorch.org/docs/stable/optim.html to get more available algorithms.</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    <span class=\"token comment\"># TODO: L2 regularization (optimizer(weight decay...) or implement by your self).</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    optimizer <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>optim<span class=\"token punctuation\">.</span>Adam<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lr<span class=\"token operator\">=</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'learning_rate'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>    writer <span class=\"token operator\">=</span> SummaryWriter<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Writer of tensoboard.</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>isdir<span class=\"token punctuation\">(</span><span class=\"token string\">'./models'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        os<span class=\"token punctuation\">.</span>mkdir<span class=\"token punctuation\">(</span><span class=\"token string\">'./models'</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Create directory of saving models.</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    n_epochs<span class=\"token punctuation\">,</span> best_loss<span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">,</span> early_stop_count <span class=\"token operator\">=</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'n_epochs'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> math<span class=\"token punctuation\">.</span>inf<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>    <span class=\"token keyword\">for</span> epoch <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n_epochs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>        model<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Set your model to train mode.</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        loss_record <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        <span class=\"token comment\"># tqdm is a package to visualize your training progress.</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>        train_pbar <span class=\"token operator\">=</span> tqdm<span class=\"token punctuation\">(</span>train_loader<span class=\"token punctuation\">,</span> position<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> leave<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>        <span class=\"token keyword\">for</span> x<span class=\"token punctuation\">,</span> y <span class=\"token keyword\">in</span> train_pbar<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>            optimizer<span class=\"token punctuation\">.</span>zero_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Set gradient to zero.</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>            x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Move your data to device.</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>            pred <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>            loss <span class=\"token operator\">=</span> criterion<span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>            loss<span class=\"token punctuation\">.</span>backward<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Compute gradient(backpropagation).</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>            optimizer<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Update parameters.</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>            step <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>            loss_record<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>loss<span class=\"token punctuation\">.</span>detach<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>            <span class=\"token comment\"># Display current epoch number and loss on tqdm progress bar.</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>            train_pbar<span class=\"token punctuation\">.</span>set_description<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Epoch [</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>epoch <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>n_epochs<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">]'</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>            train_pbar<span class=\"token punctuation\">.</span>set_postfix<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'loss'</span><span class=\"token punctuation\">:</span> loss<span class=\"token punctuation\">.</span>detach<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>        mean_train_loss <span class=\"token operator\">=</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>loss_record<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>loss_record<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>        writer<span class=\"token punctuation\">.</span>add_scalar<span class=\"token punctuation\">(</span><span class=\"token string\">'Loss/train'</span><span class=\"token punctuation\">,</span> mean_train_loss<span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>        <span class=\"token comment\"># 在验证集上进行模型准确率的分析验证。</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>        model<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Set your model to evaluation mode.</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>        loss_record <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        <span class=\"token keyword\">for</span> x<span class=\"token punctuation\">,</span> y <span class=\"token keyword\">in</span> valid_loader<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>            x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>            <span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>                pred <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>                loss <span class=\"token operator\">=</span> criterion<span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>            loss_record<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>loss<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>        mean_valid_loss <span class=\"token operator\">=</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>loss_record<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>loss_record<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>        tqdm<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Epoch [</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>epoch <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>n_epochs<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">]: Train loss: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>mean_train_loss<span class=\"token punctuation\">:</span><span class=\"token format-spec\">.4f</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">, '</span></span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>                   <span class=\"token string-interpolation\"><span class=\"token string\">f'Valid loss: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>mean_valid_loss<span class=\"token punctuation\">:</span><span class=\"token format-spec\">.4f</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>        writer<span class=\"token punctuation\">.</span>add_scalar<span class=\"token punctuation\">(</span><span class=\"token string\">'Loss/valid'</span><span class=\"token punctuation\">,</span> mean_valid_loss<span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>        <span class=\"token keyword\">if</span> mean_valid_loss <span class=\"token operator\">&lt;</span> best_loss<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 如果当前 loss 低于过去最低的 loss，则记录 loss，并保存当前最好的模型。</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>            best_loss <span class=\"token operator\">=</span> mean_valid_loss</pre></td></tr><tr><td data-num=\"199\"></td><td><pre>            torch<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'save_path'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Save your best model</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>            tqdm<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'Saving model with loss &#123;:.3f&#125;...'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>best_loss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>            early_stop_count <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>            early_stop_count <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>        <span class=\"token keyword\">if</span> early_stop_count <span class=\"token operator\">>=</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'early_stop'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>            tqdm<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'\\nModel is not improving, so we halt the training session.'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>            <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre></pre></td></tr><tr><td data-num=\"209\"></td><td><pre></pre></td></tr><tr><td data-num=\"210\"></td><td><pre><span class=\"token comment\"># train_data size: 2699 x 118 (id + 37 states + 16 features x 5 days)</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre><span class=\"token comment\"># test_data size: 1078 x 117 (without last day's positive rate)</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>train_data<span class=\"token punctuation\">,</span> test_data <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">'./data/covid.train.csv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">,</span> pd<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">'./data/covid.test.csv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>values</pre></td></tr><tr><td data-num=\"213\"></td><td><pre>train_data<span class=\"token punctuation\">,</span> valid_data <span class=\"token operator\">=</span> train_valid_split<span class=\"token punctuation\">(</span>train_data<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'valid_ratio'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'seed'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre></pre></td></tr><tr><td data-num=\"215\"></td><td><pre><span class=\"token comment\"># Print out the data size.</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>tqdm<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"</pre></td></tr><tr><td data-num=\"217\"></td><td><pre>train_data size: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>train_data<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> </pre></td></tr><tr><td data-num=\"218\"></td><td><pre>valid_data size: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>valid_data<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> </pre></td></tr><tr><td data-num=\"219\"></td><td><pre>test_data size: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>test_data<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"\"\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre></pre></td></tr><tr><td data-num=\"221\"></td><td><pre><span class=\"token comment\"># Select features</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>x_train<span class=\"token punctuation\">,</span> x_valid<span class=\"token punctuation\">,</span> x_test<span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">,</span> y_valid <span class=\"token operator\">=</span> select_feat<span class=\"token punctuation\">(</span>train_data<span class=\"token punctuation\">,</span> valid_data<span class=\"token punctuation\">,</span> test_data<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">'select_all'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre></pre></td></tr><tr><td data-num=\"224\"></td><td><pre><span class=\"token comment\"># Print out the number of features.</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>tqdm<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'number of features: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>x_train<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>train_dataset<span class=\"token punctuation\">,</span> valid_dataset<span class=\"token punctuation\">,</span> test_dataset <span class=\"token operator\">=</span> COVID19Dataset<span class=\"token punctuation\">(</span>x_train<span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \\</pre></td></tr><tr><td data-num=\"228\"></td><td><pre>                                            COVID19Dataset<span class=\"token punctuation\">(</span>x_valid<span class=\"token punctuation\">,</span> y_valid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \\</pre></td></tr><tr><td data-num=\"229\"></td><td><pre>                                            COVID19Dataset<span class=\"token punctuation\">(</span>x_test<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre></pre></td></tr><tr><td data-num=\"231\"></td><td><pre><span class=\"token comment\"># Pytorch data loader loads pytorch dataset into batches.</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>train_loader <span class=\"token operator\">=</span> DataLoader<span class=\"token punctuation\">(</span>train_dataset<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'batch_size'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> pin_memory<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>valid_loader <span class=\"token operator\">=</span> DataLoader<span class=\"token punctuation\">(</span>valid_dataset<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'batch_size'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> pin_memory<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>test_loader <span class=\"token operator\">=</span> DataLoader<span class=\"token punctuation\">(</span>test_dataset<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'batch_size'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> pin_memory<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>model <span class=\"token operator\">=</span> My_Model<span class=\"token punctuation\">(</span>input_dim<span class=\"token operator\">=</span>x_train<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># put your model and data on the same computation device.</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre><span class=\"token comment\"># 开始训练模型</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>trainer<span class=\"token punctuation\">(</span>train_loader<span class=\"token punctuation\">,</span> valid_loader<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre></pre></td></tr><tr><td data-num=\"240\"></td><td><pre><span class=\"token comment\"># 使用进行模型预测</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre><span class=\"token comment\"># model.load_state_dict(torch.load(config['save_path']))</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre><span class=\"token comment\"># preds = predict(test_loader, model, device)</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre><span class=\"token comment\"># save_pred(preds, 'pred.csv')</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre><span class=\"token comment\"># predict_data, real_data = pd.read_csv('./pred.csv'), pd.read_csv('./data/covid.test.csv')</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre><span class=\"token comment\"># # 计算预测值和实际值的 MSE</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre><span class=\"token comment\"># loss = nn.MSELoss()</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre><span class=\"token comment\"># out = loss(torch.tensor(predict_data['tested_positive'].values), torch.tensor(real_data['tested_positive'].values))</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre><span class=\"token comment\"># print('Loss: ', out)</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre><span class=\"token comment\"># df = pd.concat ([predict_data ['tested_positive'], real_data ['tested_positive']], axis=1)  # 拼接两个 Series</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre><span class=\"token comment\"># df.columns = ['predicted', 'ground truth']  # 重命名列名</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre><span class=\"token comment\"># sns.lmplot (x='predicted', y='ground truth', data=df)  # 绘制拟合线性回归图</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre><span class=\"token comment\"># plt.show()</span></pre></td></tr></table></figure></div></details>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zcGVlY2guZWUubnR1LmVkdS50dy9+aHlsZWUvbWwvbWwyMDIyLWNvdXJzZS1kYXRhL0hXMDEucGRm\">https://speech.ee.ntu.edu.tw/~hylee/ml/ml2022-course-data/HW01.pdf</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMW0zNDExcDd3RD9wPTE=\">https://www.bilibili.com/video/BV1m3411p7wD?p=1</span></li>\n</ul>\n",
            "tags": [
                "机器学习",
                "作业",
                "机器学习",
                "深度学习",
                "神经网络",
                "大作业"
            ]
        },
        {
            "id": "https://gality.cn/misc/trail-and-error/conda-mamba/",
            "url": "https://gality.cn/misc/trail-and-error/conda-mamba/",
            "title": "机器学习-环境搭建踩坑-conda&mamba",
            "date_published": "2023-10-16T12:26:41.000Z",
            "content_html": "<h1 id=\"conda\"><a class=\"anchor\" href=\"#conda\">#</a> Conda</h1>\n<p>由于机器学习会依赖大量不同环境，环境之间可能有冲突，所以推荐用 Miniconda 或 Anaconda 这种的 python <code>库+虚拟环境</code> 管理器来对 python 进行统一管理。 <code>conda</code>  其实是 Miniconda 或 Anaconda 中的主程序，用于执行各种命令。</p>\n<h2 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h2>\n<p>Miniconda 是 Anaconda 的轻量化版本，只包含 <code>conda</code>  和 <code>python</code> ，而 Anaconda 则默认包含更多的库，所以 Miniconda 只有几十 M 的大小，而 Anaconda 则有几百 M 的大小。二者在使用中几乎没有差别，可以根据空间自行选取。</p>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5hY29uZGEuY29tL2Rvd25sb2Fk\">Anaconda Download</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmNvbmRhLmlvL3Byb2plY3RzL21pbmljb25kYS9lbi9sYXRlc3QvaW5kZXguaHRtbA==\">Miniconda Download</span></li>\n</ul>\n<p>无论安装 Anaconda 还是 Miniconda，在安装完成后，应该会默认在当前命令行工具的配置文件中写好环境变量，可以直接用 <code>source ~/.zshrc</code> （zsh）来读取一下环境变量。</p>\n<p>推荐在安装完成后，<strong>立刻</strong>对 <code>conda</code>  进行更新，可以减少出现未知问题的概率...</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda update <span class=\"token parameter variable\">-n</span> base conda</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conda update <span class=\"token parameter variable\">--all</span></pre></td></tr></table></figure><h1 id=\"mamba\"><a class=\"anchor\" href=\"#mamba\">#</a> Mamba</h1>\n<p><code>mamba</code>  相比 <code>conda</code>  的优势如下：</p>\n<ul>\n<li>用 C 重新实现了依赖解析器，大幅提高依赖解析速度。</li>\n<li>并行下载所需要的包</li>\n<li>在解析依赖时给出步骤提醒，不像 conda 仅仅是一直 <code>solving</code></li>\n</ul>\n<p>同时， <code>mamba</code>  基本实现了所有 conda 的功能，使用起来仅需把上述所有命令中的 <code>conda</code>  替换成 <code>mamba</code>  即可。 <code>mamba</code>  需要通过 <code>conda</code>  来进行安装：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda <span class=\"token function\">install</span> <span class=\"token parameter variable\">-n</span> base <span class=\"token parameter variable\">-c</span> conda-forge mamba</pre></td></tr></table></figure><p>综合来说，可以一定程度解决 <code>conda</code>  过长的 <code>Solving environment</code>  的时间，推荐安装并替换 <code>conda</code>  使用。</p>\n<h1 id=\"bug-解决\"><a class=\"anchor\" href=\"#bug-解决\">#</a> bug 解决</h1>\n<h2 id=\"frozen-solve问题\"><a class=\"anchor\" href=\"#frozen-solve问题\">#</a> frozen solve 问题</h2>\n<p>在用 <code>conda install</code>  包时出现报错：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Solving environment: unsuccessful initial attempt using frozen solve. Retrying with flexible solve.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Solving environment: unsuccessful attempt using repodata from current_repodata.json, retrying with next repodata source.</pre></td></tr></table></figure><p>请按步骤进行排查：</p>\n<ol>\n<li>\n<p>添加 <code>conda-forge</code>  频道</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加频道</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conda config <span class=\"token parameter variable\">--add</span> channels conda-forge</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 查看已添加的频道</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>conda config --show-sources</pre></td></tr></table></figure></li>\n<li>\n<p>更新 conda 到最新版本</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda update <span class=\"token parameter variable\">-n</span> base conda</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conda update <span class=\"token parameter variable\">--all</span></pre></td></tr></table></figure></li>\n<li>\n<p>重新安装，若解决，到此结束</p>\n</li>\n<li>\n<p>若未解决：新建一个虚拟环境</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建虚拟环境</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conda create <span class=\"token parameter variable\">-n</span> <span class=\"token operator\">&lt;</span>EnvName<span class=\"token operator\">></span> <span class=\"token assign-left variable\">python</span><span class=\"token operator\">=</span><span class=\"token number\">3.11</span></pre></td></tr></table></figure></li>\n<li>\n<p>再次安装即可解决</p>\n</li>\n</ol>\n<h1 id=\"卸载\"><a class=\"anchor\" href=\"#卸载\">#</a> 卸载</h1>\n<p>如果在安装过程中莫名问题（正常操作却出现各种 error），然后通过各种教程仍无法修复，建议卸载重装，可能可以解决问题（博主就是这么解决的）</p>\n<ol>\n<li>\n<p>清除环境变量：清除 <code>~/.zshrc</code>  或 <code>~/.bashrc</code>  中的类似下列的内容：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># >>> conda initialize >>></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># !! Contents within this block are managed by 'conda init' !!</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">__conda_setup</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>'/Your/Conda/Path/bin/conda<span class=\"token string\">' '</span>shell.zsh<span class=\"token string\">' '</span>hook' <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span> /dev/null<span class=\"token variable\">)</span></span>\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token builtin class-name\">eval</span> <span class=\"token string\">\"<span class=\"token variable\">$__conda_setup</span>\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-f</span> <span class=\"token string\">\"Your/Conda/Path/etc/profile.d/conda.sh\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token builtin class-name\">.</span> <span class=\"token string\">\"Your/Conda/Path/etc/profile.d/conda.sh\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"/Your/Conda/Path/miniconda3/bin:<span class=\"token environment constant\">$PATH</span>\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token builtin class-name\">unset</span> __conda_setup</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># &lt;&lt;&lt; conda initialize &lt;&lt;&lt;</span></pre></td></tr></table></figure></li>\n<li>\n<p>删除文件夹： <code>rm -rf &lt;Your/Conda/Path&gt;</code></p>\n</li>\n</ol>\n<h1 id=\"conda-常用命令\"><a class=\"anchor\" href=\"#conda-常用命令\">#</a> Conda 常用命令</h1>\n<h2 id=\"环境\"><a class=\"anchor\" href=\"#环境\">#</a> 环境</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 新建虚拟环境</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conda create <span class=\"token parameter variable\">-n</span> <span class=\"token operator\">&lt;</span>EnvName<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>conda create <span class=\"token parameter variable\">-n</span> <span class=\"token operator\">&lt;</span>EnvName<span class=\"token operator\">></span> <span class=\"token assign-left variable\">python</span><span class=\"token operator\">=</span><span class=\"token number\">3.9</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 列出所有虚拟环境</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>conda info <span class=\"token parameter variable\">-e</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 进入虚拟环境</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>conda activate <span class=\"token operator\">&lt;</span>EnvName<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 退出虚拟环境</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>conda deactivate</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 删除虚拟环境</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>conda remove <span class=\"token parameter variable\">-n</span> <span class=\"token operator\">&lt;</span>EnvName<span class=\"token operator\">></span> <span class=\"token parameter variable\">--all</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 复制虚拟环境</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>conda create <span class=\"token parameter variable\">--name</span> <span class=\"token operator\">&lt;</span>NewEnvName<span class=\"token operator\">></span> <span class=\"token parameter variable\">--clone</span> <span class=\"token operator\">&lt;</span>OldEnvName<span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"更新\"><a class=\"anchor\" href=\"#更新\">#</a> 更新</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看版本</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conda <span class=\"token parameter variable\">-V</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 更新 conda 环境</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>conda update <span class=\"token parameter variable\">-n</span> base conda</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 更新 conda 的所有包</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>conda update <span class=\"token parameter variable\">--all</span></pre></td></tr></table></figure><h2 id=\"频道\"><a class=\"anchor\" href=\"#频道\">#</a> 频道</h2>\n<p>conda 频道是存储 <code>包</code> 的位置，安装包时 conda 会搜索现有的频道集合，并选取其中一个频道来安装包，一般用 <code>conda-forge</code>  这个免费频道</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加新频道</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conda config <span class=\"token parameter variable\">--add</span> channels <span class=\"token operator\">&lt;</span>channel-name<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 查看所有频道</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>conda config --show-sources</pre></td></tr></table></figure><h1 id=\"\"><a class=\"anchor\" href=\"#\">#</a> </h1>\n",
            "tags": [
                "杂项",
                "踩坑",
                "机器学习",
                "杂项",
                "踩坑",
                "conda",
                "mamba"
            ]
        },
        {
            "id": "https://gality.cn/misc/course/Monte-Carlo-method/",
            "url": "https://gality.cn/misc/course/Monte-Carlo-method/",
            "title": "数理统计大作业 ｜ Monte Carlo方法",
            "date_published": "2023-10-11T09:23:31.000Z",
            "content_html": "<div class=\"note info no-icon\">\n<p>菜狗完成数理统计第一次大作业的记录，记录了在完成的过程中对已学习的数理统计知识进行的回顾和总结，其实就是怕忘了 QwQ，有问题的话及时喷我，谢谢各位大佬 Orz</p>\n</div>\n<h1 id=\"大作业内容\"><a class=\"anchor\" href=\"#大作业内容\">#</a> 大作业内容</h1>\n<p><strong>用 Monte Carlo 方法进行统计量分布和分位数计算</strong></p>\n<h2 id=\"题目\"><a class=\"anchor\" href=\"#题目\">#</a> 题目</h2>\n<p>已知统计量 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi><mrow><mo stretchy=\"false\">(</mo><msub><mi mathvariant=\"normal\">z</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">z</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">z</mi><mi mathvariant=\"normal\">n</mi></msub><mo stretchy=\"false\">)</mo></mrow><mo>=</mo><mstyle displaystyle=\"true\" scriptlevel=\"0\"><mfrac><mroot><mrow><mfrac><mn>1</mn><mi>n</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><mo stretchy=\"false\">(</mo><msub><mi>z</mi><mi>i</mi></msub><mo>−</mo><mover accent=\"true\"><mi>z</mi><mo>ˉ</mo></mover><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><mrow></mrow></mroot><mrow><mover accent=\"true\"><mi>z</mi><mo>ˉ</mo></mover><mo>−</mo><msub><mi>z</mi><mrow><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow></msub></mrow></mfrac></mstyle></mrow><annotation encoding=\"application/x-tex\">T \\mathrm{(z_1,z_2,...,z_n)}=\\dfrac{\\sqrt[]{ {1\\over n } \\sum\\nolimits_{i=1}^{n}(z_i-\\bar{z})^2 } }{\\bar z -{z_{(1)} } }</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord\"><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathrm\">.</span><span class=\"mord mathrm\">.</span><span class=\"mord mathrm\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.2712em;vertical-align:-1.0412em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.23em;\"><span style=\"top:-2.549054em;\"><span class=\"pstrut\" style=\"height:3.235054em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.56778em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">ˉ</span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.34480000000000005em;\"><span style=\"top:-2.5198em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mtight\">1</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3551999999999999em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.465054em;\"><span class=\"pstrut\" style=\"height:3.235054em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-4.23em;\"><span class=\"pstrut\" style=\"height:3.235054em;\"></span><span class=\"mord\"><span class=\"mord sqrt\"><span class=\"root\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.37806480000000003em;\"><span style=\"top:-2.3780648em;\"><span class=\"pstrut\" style=\"height:2em;\"></span><span class=\"sizing reset-size6 size1 mtight\"><span class=\"mord mtight\"></span></span></span></span></span></span></span><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.235054em;\"><span class=\"svg-align\" style=\"top:-3.8em;\"><span class=\"pstrut\" style=\"height:3.8em;\"></span><span class=\"mord\" style=\"padding-left:1em;\"><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.804292em;\"><span style=\"top:-2.40029em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.2029em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.29971000000000003em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.56778em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">ˉ</span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.195054em;\"><span class=\"pstrut\" style=\"height:3.8em;\"></span><span class=\"hide-tail\" style=\"min-width:1.02em;height:1.8800000000000001em;\"><svg width='400em' height='1.8800000000000001em' viewBox='0 0 400000 1944' preserveAspectRatio='xMinYMin slice'><path d='M983 90\nl0 -0\nc4,-6.7,10,-10,18,-10 H400000v40\nH1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7\ns-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744\nc-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30\nc26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722\nc56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5\nc53.7,-170.3,84.5,-266.8,92.5,-289.5z\nM1001 80h400000v40h-400000z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.604946em;\"><span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0412em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，其中<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"normal\">z</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">z</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">z</mi><mi mathvariant=\"normal\">n</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{z_1,z_2,...,z_n}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathrm\">.</span><span class=\"mord mathrm\">.</span><span class=\"mord mathrm\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span> 独立同分布，均服从<br />\n（a）标准正态分布<br />\n（b）参数为 1 的指数分布</p>\n<p>请在 (a)，(b) 两种条件下分别计算：</p>\n<ol>\n<li>画出概率分布 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">{</mo><mi>T</mi><mrow><mo stretchy=\"false\">(</mo><msub><mi mathvariant=\"normal\">z</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">z</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">z</mi><mi mathvariant=\"normal\">n</mi></msub><mo stretchy=\"false\">)</mo></mrow><mo>&lt;</mo><mi>t</mi><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">P\\{T\\mathrm{(z_1,z_2,...,z_n)} &lt; t\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">{</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord\"><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathrm\">.</span><span class=\"mord mathrm\">.</span><span class=\"mord mathrm\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">}</span></span></span></span> 的近似分布曲线</li>\n<li>对给定的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>α</mi><mo>=</mo><mn>0.01</mn><mo separator=\"true\">,</mo><mn>0.05</mn><mo separator=\"true\">,</mo><mn>0.1</mn></mrow><annotation encoding=\"application/x-tex\">\\alpha=0.01, 0.05, 0.1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">α</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8388800000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">1</span></span></span></span>，计算满足 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">{</mo><mi>T</mi><mrow><mo stretchy=\"false\">(</mo><msub><mi mathvariant=\"normal\">z</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">z</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">z</mi><mi mathvariant=\"normal\">n</mi></msub><mo stretchy=\"false\">)</mo></mrow><mo>&lt;</mo><msub><mi>t</mi><mi>α</mi></msub><mo stretchy=\"false\">}</mo><mo>=</mo><mi>α</mi></mrow><annotation encoding=\"application/x-tex\">P\\{T\\mathrm{(z_1,z_2,...,z_n)} &lt; t_\\alpha\\}=\\alpha</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">{</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord\"><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathrm\">.</span><span class=\"mord mathrm\">.</span><span class=\"mord mathrm\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.0037em;\">α</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">}</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">α</span></span></span></span> 的分位数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mi>α</mi></msub></mrow><annotation encoding=\"application/x-tex\">t_\\alpha</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.0037em;\">α</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。</li>\n</ol>\n<h2 id=\"目的\"><a class=\"anchor\" href=\"#目的\">#</a> 目的</h2>\n<p>提升统计软件的使用能力（本题目可以使用任意软件），熟练使用 Monte Carlo 方法进行概率计算，并能把其用于科学研究。</p>\n<h2 id=\"基本要求\"><a class=\"anchor\" href=\"#基本要求\">#</a> 基本要求</h2>\n<ol>\n<li>用 Monte Carlo 方法给出计算方法过程，输出计算结果。</li>\n<li>讨论 Monte Carlo 方法计算结果随着样本容量变化时计算误差的变化，并进行总结。</li>\n<li>作业书写图文并茂，具有较强的可读性与可视性。</li>\n</ol>\n<p>注：除完成基本要求外，可以增加自己感兴趣的研究内容。</p>\n<hr />\n<h1 id=\"算法引入\"><a class=\"anchor\" href=\"#算法引入\">#</a> 算法引入</h1>\n<p>考虑这么一种情况：我们在一张纸上画了一个圆圈，此时我们想求圆圈的面积。如果圆圈时正圆形的话，面试非常好求，但如果不是一个正圆，该怎么求面积呢？</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/5a84t1.png\" alt=\"Mentor Carlo问题引入\" height=\"176\" width=\"406\" /></p>\n<p>此时我们可以考虑这么一种情况：抓一把绿豆，随机的撒在整个纸上，然后去计算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><msub><mi>N</mi><mrow><mi>c</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi></mrow></msub><msub><mi>N</mi><mrow><mi>p</mi><mi>a</mi><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub></mfrac><mo>×</mo><msub><mi>S</mi><mrow><mi>p</mi><mi>a</mi><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\frac{N_{circle} }{N_{paper} } \\times S_{paper}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.4365109999999999em;vertical-align:-0.5423199999999999em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.894191em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.16454285714285716em;\"><span style=\"top:-2.357em;margin-left:-0.10903em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2818857142857143em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.41586em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3487714285714287em;margin-left:-0.10903em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">e</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15122857142857138em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5423199999999999em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 即可计算出圆的面积。显然的是，绿豆的个数越多，算出的圆的面积就会越接近实际答案，这其实就是 <strong>蒙特卡洛（Mento Carlo）</strong> 算法的基本思想。</p>\n<p>从上述可以看出，Monte-Carlo 算法区别于确定性算法，它的解不一定是准确或正确的，其准确性或正确性依赖于概率和统计，但在某些问题上，当重复实验次数足够大时，可以从很大概率上（这个概率是可以在数学上证明的，但依赖于具体问题）确保解的准确或正确性，所以，我们可以根据具体的概率分析，设定实验的次数，从而将误差或错误率降到一个可容忍的程度。</p>\n<p>下面给出严格的证明：</p>\n<details class=\"primary\"><summary>证明</summary><div>\n<p>为不失一般性，可以设纸的面积为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span>，不规则图形面积为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></mrow><annotation encoding=\"application/x-tex\">S&#x27;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span> ，设事件 A：随机投掷一粒绿豆，绿豆落在圆内。</p>\n<p>显然，投掷落点符合二维均匀分布，所以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi><mo stretchy=\"false\">(</mo><mi>A</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>S</mi></mfrac></mrow><annotation encoding=\"application/x-tex\">p(A)=\\frac{S&#x27;}{S}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">A</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.31848em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.97348em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8278285714285715em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>。</p>\n<p>设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 次投掷中，都在不规则圆形的次数，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ε</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">\\varepsilon&gt;0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\">ε</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span></span></span></span> 为任意正数，根据伯努利大数定律：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>n</mi><mo>→</mo><mi mathvariant=\"normal\">∞</mi></mrow></munder><mi>P</mi><mrow><mo fence=\"true\">{</mo><mrow><mo fence=\"true\">∣</mo><mfrac><mi>k</mi><mi>n</mi></mfrac><mo>−</mo><mi>p</mi><mo stretchy=\"false\">(</mo><mi>A</mi><mo stretchy=\"false\">)</mo><mo fence=\"true\">∣</mo></mrow><mo>&lt;</mo><mi>ε</mi><mo fence=\"true\">}</mo></mrow><mo>=</mo><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>n</mi><mo>→</mo><mi mathvariant=\"normal\">∞</mi></mrow></munder><mi>P</mi><mrow><mo fence=\"true\">{</mo><mrow><mo fence=\"true\">∣</mo><mfrac><mi>k</mi><mi>n</mi></mfrac><mo>−</mo><mfrac><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>S</mi></mfrac><mo>&lt;</mo><mi>ε</mi><mo fence=\"true\">∣</mo></mrow><mo fence=\"true\">}</mo></mrow><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">\\lim_{n \\to \\infty} P\\left \\{  \\left | \\frac{k}{n} - p(A) \\right |&lt;  \\varepsilon \\right \\} = \\lim_{n \\to \\infty} P \\left \\{ \\left | \\frac{k}{n} - \\frac{S&#x27;}{S} &lt; \\varepsilon \\right | \\right \\} = 1\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.43em;vertical-align:-0.95003em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-2.4em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mrel mtight\">→</span><span class=\"mord mtight\">∞</span></span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span><span class=\"mop\">lim</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">{</span></span><span class=\"minner\"><span class=\"mopen\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4799700000000002em;\"><span style=\"top:-1.65598em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.25698em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.85798em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.87897em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-3.47997em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9500199999999999em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.37144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">A</span><span class=\"mclose\">)</span><span class=\"mclose\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4799700000000002em;\"><span style=\"top:-1.65598em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.25698em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.85798em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.87897em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-3.47997em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9500199999999999em;\"><span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mord mathnormal\">ε</span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">}</span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.43em;vertical-align:-0.95003em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-2.4em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mrel mtight\">→</span><span class=\"mord mtight\">∞</span></span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span><span class=\"mop\">lim</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">{</span></span><span class=\"minner\"><span class=\"mopen\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4799700000000002em;\"><span style=\"top:-1.65598em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.25698em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.85798em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.87897em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-3.47997em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9500199999999999em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.37144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.428892em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mord mathnormal\">ε</span><span class=\"mclose\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4799700000000002em;\"><span style=\"top:-1.65598em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.25698em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.85798em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-2.87897em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span><span style=\"top:-3.47997em;\"><span class=\"pstrut\" style=\"height:2.606em;\"></span><span class=\"delimsizinginner delim-size1\"><span>∣</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9500199999999999em;\"><span></span></span></span></span></span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">}</span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span></span></p>\n<p>这就证明了，当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi><mo>→</mo><mi mathvariant=\"normal\">∞</mi></mrow><annotation encoding=\"application/x-tex\">n \\rightarrow \\infty</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord\">∞</span></span></span></span> 时，频率 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mi>k</mi><mi>n</mi></mfrac></mrow><annotation encoding=\"application/x-tex\">k\\over n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2251079999999999em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8801079999999999em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span> 依概率收敛于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>S</mi></mfrac></mrow><annotation encoding=\"application/x-tex\">S&#x27;\\over S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.31848em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.97348em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8278285714285715em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>, 由于纸的面积是很好算的，也就可以轻松算出不规则圆的面积了。</p>\n</div></details>\n<p>上述证明从数学上说明用频率估计不规则图形面积的合理性，进一步可以给出误差分析，从而选择合适的实验次数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span>，来将误差控制在可以容忍的范围内，Monte-Carlo 算法虽然不能保证解一定是准确和正确，但并不是 “撞大运”，其正确性和准确性依赖概率论，有严格的数学基础，也因此 Mento Carlo 算法也称统计模拟法、统计实验法。</p>\n<h1 id=\"解题流程\"><a class=\"anchor\" href=\"#解题流程\">#</a> 解题流程</h1>\n<h2 id=\"画出概率分布近似分布曲线\"><a class=\"anchor\" href=\"#画出概率分布近似分布曲线\">#</a> 画出概率分布近似分布曲线</h2>\n<p>由于是使用 Monte Carlo 算法来近似的求解问题，那么我们首先需要生成足够多的满足题目要求的随机数据，这里以 “标准正态分布” 数据为例进行说明：</p>\n<p>首先我们要生成足够多的数据去 “撒绿豆”，先随机生成一组样本容量为 2000 的标准正态分布样本数据，并画出他的概率密度曲线：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> seaborn <span class=\"token keyword\">as</span> sns</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>num_arr <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>normal<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>sns<span class=\"token punctuation\">.</span>histplot<span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">,</span> kde<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>plt<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"http://imgcdn.gality.cn/blog/nwslof.png\" alt=\"标准正态分布图\" /></p>\n<p>根据 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi><mrow><mo stretchy=\"false\">(</mo><msub><mi mathvariant=\"normal\">z</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">z</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">z</mi><mi mathvariant=\"normal\">n</mi></msub><mo stretchy=\"false\">)</mo></mrow></mrow><annotation encoding=\"application/x-tex\">T \\mathrm{(z_1,z_2,...,z_n)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord\"><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathrm\">.</span><span class=\"mord mathrm\">.</span><span class=\"mord mathrm\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathrm mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span> 的公式算出一个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span>，并将其加入到：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>t_arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>z_a <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>z_1 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>n <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>tmp <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  tmp <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-</span>z_a<span class=\"token punctuation\">)</span><span class=\"token operator\">**</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>t <span class=\"token operator\">=</span> math<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>tmp<span class=\"token operator\">/</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>z_a <span class=\"token operator\">-</span> z_1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>t_arr<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>此时，只需要重复这个算法，算出多个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span> 值去估计概率分布即可。但是还有一个需要注意的点，由于 <code>seaborn</code>  库函数的原因，如果想画出概率密度的话，必须将生成的数组格式，使用 <code>pandas</code>  库转换成 <code>DataFrame</code>  格式才可以正确处理。</p>\n<p>最终代码如下：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> math</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> seaborn <span class=\"token keyword\">as</span> sns</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>sns<span class=\"token punctuation\">.</span>set_style<span class=\"token punctuation\">(</span><span class=\"token string\">\"whitegrid\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>t_arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>loop <span class=\"token operator\">=</span> <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>loop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    num_arr <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>normal<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    z_a <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 样本平均值</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    z_1 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 样本最小值</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    n <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 样本容量</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    tmp <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        tmp <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-</span>z_a<span class=\"token punctuation\">)</span><span class=\"token operator\">**</span><span class=\"token number\">2</span> <span class=\"token comment\"># 中心二阶距</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    t <span class=\"token operator\">=</span> math<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>tmp<span class=\"token operator\">/</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>z_a <span class=\"token operator\">-</span> z_1<span class=\"token punctuation\">)</span> <span class=\"token comment\"># t 值</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    t_arr<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>t_arr<span class=\"token punctuation\">.</span>sort<span class=\"token punctuation\">(</span>reverse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 对 t 进行排序，方便计算概率分布</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>t_arr_final <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">for</span> k <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>loop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 格式化列表， 为生成 DataFrame 做准备</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> k <span class=\"token operator\">&lt;</span> <span class=\"token punctuation\">(</span>loop <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> t_arr<span class=\"token punctuation\">[</span>k<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        t_arr_final<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>loop<span class=\"token operator\">-</span>k<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>loop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">(</span> k <span class=\"token operator\">==</span> loop <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        t_arr_final<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">(</span>t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> t_arr<span class=\"token punctuation\">[</span>k<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>data <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>DataFrame<span class=\"token punctuation\">(</span>data<span class=\"token operator\">=</span>t_arr_final<span class=\"token punctuation\">,</span> columns<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'probability'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>sns<span class=\"token punctuation\">.</span>scatterplot<span class=\"token punctuation\">(</span>x<span class=\"token operator\">=</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span>data<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 绘制散点图</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>sns<span class=\"token punctuation\">.</span>lineplot<span class=\"token punctuation\">(</span>data<span class=\"token operator\">=</span>data<span class=\"token punctuation\">,</span> x<span class=\"token operator\">=</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">,</span>estimator<span class=\"token operator\">=</span><span class=\"token string\">'max'</span><span class=\"token punctuation\">,</span> color<span class=\"token operator\">=</span><span class=\"token string\">'red'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 绘制分布曲线</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>plt<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 展示</span></pre></td></tr></table></figure><p><img data-src=\"http://imgcdn.gality.cn/blog/hcs6xb.png\" alt=\"函数概率分布\" /></p>\n<p>当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>z</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>z</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><msub><mi>z</mi><mi>n</mi></msub></mrow><annotation encoding=\"application/x-tex\">z_1, z_2, ..., z_n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 服从参数为 1 的指数分布时，整体代码不变，只需要将随机值生成时用到的函数改变一下，使生成的随机值满足指数分布即可，代码只需要变动一行：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> math</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> seaborn <span class=\"token keyword\">as</span> sns</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>sns<span class=\"token punctuation\">.</span>set_style<span class=\"token punctuation\">(</span><span class=\"token string\">\"whitegrid\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>t_arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>loop <span class=\"token operator\">=</span> <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>loop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\"># num_arr = np.random.normal(0,1,1000)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    num_arr <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>exponential<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 使随机值服从指数分布</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    z_a <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 样本平均值</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    z_1 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 样本最小值</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    n <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 样本容量</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    tmp <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        tmp <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-</span>z_a<span class=\"token punctuation\">)</span><span class=\"token operator\">**</span><span class=\"token number\">2</span> <span class=\"token comment\"># 中心二阶距</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    t <span class=\"token operator\">=</span> math<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>tmp<span class=\"token operator\">/</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>z_a <span class=\"token operator\">-</span> z_1<span class=\"token punctuation\">)</span> <span class=\"token comment\"># t 值</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    t_arr<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>t_arr<span class=\"token punctuation\">.</span>sort<span class=\"token punctuation\">(</span>reverse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 对 t 进行排序，方便计算概率分布</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>t_arr_final <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">for</span> k <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>loop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 格式化列表， 为生成 DataFrame 做准备</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> k <span class=\"token operator\">&lt;</span> <span class=\"token punctuation\">(</span>loop <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> t_arr<span class=\"token punctuation\">[</span>k<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        t_arr_final<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>loop<span class=\"token operator\">-</span>k<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>loop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">(</span> k <span class=\"token operator\">==</span> loop <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        t_arr_final<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">(</span>t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> t_arr<span class=\"token punctuation\">[</span>k<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>data <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>DataFrame<span class=\"token punctuation\">(</span>data<span class=\"token operator\">=</span>t_arr_final<span class=\"token punctuation\">,</span> columns<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'probability'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>sns<span class=\"token punctuation\">.</span>scatterplot<span class=\"token punctuation\">(</span>x<span class=\"token operator\">=</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span>data<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 绘制散点图</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>sns<span class=\"token punctuation\">.</span>lineplot<span class=\"token punctuation\">(</span>data<span class=\"token operator\">=</span>data<span class=\"token punctuation\">,</span> x<span class=\"token operator\">=</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">,</span>estimator<span class=\"token operator\">=</span><span class=\"token string\">'max'</span><span class=\"token punctuation\">,</span> color<span class=\"token operator\">=</span><span class=\"token string\">'red'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 绘制分布曲线</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>plt<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 展示</span></pre></td></tr></table></figure><p>其概率分布如下：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/af4s0h.png\" alt=\"指数分布的概率分布\" /></p>\n<h2 id=\"求分位数\"><a class=\"anchor\" href=\"#求分位数\">#</a> 求分位数</h2>\n<p>根据分位数的定义：</p>\n<details class=\"primary\"><summary>分位数定义</summary><div>\n<p>设随机变量 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>X</mi></mrow><annotation encoding=\"application/x-tex\">X</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span></span></span></span> 的分布函数为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>F</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">F(x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span>，对任意给定的实数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi><mo stretchy=\"false\">(</mo><mn>0</mn><mo>&lt;</mo><mi>p</mi><mo>&lt;</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">p(0&lt;p&lt;1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mopen\">(</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7335400000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span>，若存在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mi>p</mi></msub></mrow><annotation encoding=\"application/x-tex\">x_p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 使得</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>X</mi><mo>⩽</mo><msub><mi>x</mi><mi>p</mi></msub><mo stretchy=\"false\">)</mo><mo>=</mo><mi>F</mi><mo stretchy=\"false\">(</mo><msub><mi>x</mi><mi>p</mi></msub><mo stretchy=\"false\">)</mo><mo>=</mo><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">P(X \\leqslant x_p ) = F(x_p) = p\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel amsrm\">⩽</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span></span></p>\n<p>则称 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mi>p</mi></msub></mrow><annotation encoding=\"application/x-tex\">x_p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 为此概率分布的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span> 分位数。</p>\n</div></details>\n<p>所以其实本质上就是在分布函数上求某一个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span>，使得 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>F</mi><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><msub><mi>t</mi><mi>α</mi></msub></mrow><annotation encoding=\"application/x-tex\">F(t)=t_\\alpha</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.0037em;\">α</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，而这一步我们在完成列表向 <code>DataFrame</code>  转化的时候就已经完成了，我们只需要把他找出来就可以了。</p>\n<p>代码如下：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 计算分位数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>a_1 <span class=\"token operator\">=</span>  data<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>isin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>a_2 <span class=\"token operator\">=</span>  data<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>isin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0.05</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>a_3 <span class=\"token operator\">=</span>  data<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>isin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0.01</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a = 0.1 的分位数为：'</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>a_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a = 0.05 的分位数为：'</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>a_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a = 0.01 的分位数为：'</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>a_3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"http://imgcdn.gality.cn/blog/9vm1ew.png\" alt=\"样本为标准正态分布时的分位数\" /></p>\n<p>同样的代码，也可以求出样本服从指数分布时的分位数：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/4gd3s5.png\" alt=\"样本为指数分布时的分位数\" /></p>\n<h1 id=\"思考题\"><a class=\"anchor\" href=\"#思考题\">#</a> 思考题</h1>\n<p>Monte Carlo 方法计算结果随着样本容量变化时计算误差的变化</p>\n<p>我们分别给出模拟次数为 100、200、1000、10000 次时的概率分布函数曲线：</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/e197si.png\" alt=\"不同次数的蒙特卡洛对比图\" /></p>\n<p>我们可以明显看到随着模拟次数的增多，概率分布曲线越来越光滑，意味着其准确度和正确性都有较大提升，这一点也是非常直观的，我们可以考虑更极端一点的，如果只有 10 次模拟次数呢？</p>\n<p><img data-src=\"http://imgcdn.gality.cn/blog/ndkfo2.png\" alt=\"10模拟次数情况下的概率分布曲线\" /></p>\n<p>可以看到，每次的近似概率分布曲线差别非常大，这是符合我们的预期的，当模拟次数较少时，得到的结果的准确度和正确性都有较大误差，无法真实反应统计情况。</p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>在深入了解 Monte Carlo 算法后，我有种深深的感触：Monte Carlo 算法简直就是为计算机而生的。计算机解决问题时具有天然的计算优势，对于人类来说，解决问题的过程是拆解问题的过程。通过将复杂问题拆解成一个一个的简单问题，将不能 “计算” 的问题转化成能 “计算” 的问题，也因此，在这种过程中，人类会尽量寻找简单的模型去描述事物，哪怕与实际有些 “失真”，也是可以接受的。计算机则恰恰相反，计算机强在计算能力，强在运算速度，这时，如果还用人类解决问题的方法来让计算机解决问题，那其实就无法发挥出计算机的优势。</p>\n<p>Monte Carlo 算法就从根本上改变了这个问题，就以求面积问题来说，我们无需输入复杂的公式，构造复杂的循环、判断逻辑来计算面积的确切值，只需要使用足够多次的模拟值，就可以以极大把握接受算出的结果，就从这次大作业来看，模拟 1 万次操作也只需 2 秒左右的时间，可谓是找到了计算机解决问题的正确逻辑。</p>\n<p>在学习 “机器学习” 的内容时，了解到机器学习的底层逻辑是基于概率的，那时我还非常不理解为什么依赖是 “概率”，现在想来，统计与概率才是计算机的底层 “基因”，这才是计算机最擅长的东西，感谢这次大作业，感谢 Monte Carlo 算法。</p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veHVtYW9qdW4vcC84NTQxNjM3Lmh0bWw=\">https://www.cnblogs.com/xumaojun/p/8541637.html</span></li>\n<li>孙海燕，周梦等 著，应用数理统计。北京航空航天大学出版社，2008.8</li>\n</ul>\n<h1 id=\"附录\"><a class=\"anchor\" href=\"#附录\">#</a> 附录</h1>\n<p>大作业整体代码如下：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> math</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> seaborn <span class=\"token keyword\">as</span> sns</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>sns<span class=\"token punctuation\">.</span>set_style<span class=\"token punctuation\">(</span><span class=\"token string\">\"whitegrid\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>t_arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>loop <span class=\"token operator\">=</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>loop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    num_arr <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>normal<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\"># num_arr = np.random.exponential (1, 1000) # 使随机值服从指数分布</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    z_a <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 样本平均值</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    z_1 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 样本最小值</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    n <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 样本容量</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    tmp <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        tmp <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>num_arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-</span>z_a<span class=\"token punctuation\">)</span><span class=\"token operator\">**</span><span class=\"token number\">2</span> <span class=\"token comment\"># 中心二阶距</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    t <span class=\"token operator\">=</span> math<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>tmp<span class=\"token operator\">/</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>z_a <span class=\"token operator\">-</span> z_1<span class=\"token punctuation\">)</span> <span class=\"token comment\"># t 值</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    t_arr<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>t_arr<span class=\"token punctuation\">.</span>sort<span class=\"token punctuation\">(</span>reverse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 对 t 进行排序，方便计算概率分布</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>t_arr_final <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">for</span> k <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>loop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 格式化列表， 为生成 DataFrame 做准备</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> k <span class=\"token operator\">&lt;</span> <span class=\"token punctuation\">(</span>loop <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> t_arr<span class=\"token punctuation\">[</span>k<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        t_arr_final<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>loop<span class=\"token operator\">-</span>k<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>loop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">(</span> k <span class=\"token operator\">==</span> loop <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        t_arr_final<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">(</span>t_arr<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> t_arr<span class=\"token punctuation\">[</span>k<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>data <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>DataFrame<span class=\"token punctuation\">(</span>data<span class=\"token operator\">=</span>t_arr_final<span class=\"token punctuation\">,</span> columns<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'probability'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>sns<span class=\"token punctuation\">.</span>scatterplot<span class=\"token punctuation\">(</span>x<span class=\"token operator\">=</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span>data<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 绘制散点图</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>sns<span class=\"token punctuation\">.</span>lineplot<span class=\"token punctuation\">(</span>data<span class=\"token operator\">=</span>data<span class=\"token punctuation\">,</span> x<span class=\"token operator\">=</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">,</span>estimator<span class=\"token operator\">=</span><span class=\"token string\">'max'</span><span class=\"token punctuation\">,</span> color<span class=\"token operator\">=</span><span class=\"token string\">'red'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 绘制分布曲线</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>plt<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 展示</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\"># 计算分位数</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>a_1 <span class=\"token operator\">=</span>  data<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>isin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>a_2 <span class=\"token operator\">=</span>  data<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>isin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0.05</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>a_3 <span class=\"token operator\">=</span>  data<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">'probability'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>isin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0.01</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a = 0.1 的分位数为：'</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>a_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a = 0.05 的分位数为：'</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>a_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a = 0.01 的分位数为：'</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>a_3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": [
                "杂项",
                "校内课程",
                "大作业",
                "数理统计",
                "蒙特卡洛法"
            ]
        }
    ]
}